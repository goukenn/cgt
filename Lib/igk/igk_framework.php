<?php
//-----------------------------------------------------------------------------------
//
//License: read licence.txt
//
//STATIC METHOD START WITH CAPITAL LETTER.
//INSTANCE METHOD START WITH LOWER LETTER
//
//file: igk_framework.php
//author: C.A.D BONDJE DOUE
//
//-----------------------------------------------------------------------------------


//-----------------------------------------------------------------------------------
//define global constants
//-----------------------------------------------------------------------------------
define("IGK_WEBFRAMEWORK", "8.30");
define("IGK_BALAFON_JS_VERSION", "3.3");
define("IGK_FRAMEWORK","IGKDEV-WFM");
define("IGK_AUTHOR", "C.A.D. BONDJE DOUE");
define("IGK_PLATEFORM_NAME", "BALAFON");
define("IGK_VERSION", IGK_WEBFRAMEWORK.".2.0326");
define("IGK_RELEASE_DATE", "26/03/18");
define("IGK_START_DATE", "01/01/13");
define("IGK_COPYRIGHT", "IGKDEV &copy; 2011-".date('Y')." all rights reserved");
define("IGK_WEB_SITE", "http://www.igkdev.com");
define("IGK_SCHEMA_NS", "http://schemas.igkdev.com/html/components");
define("IGK_AUTHOR_CONTACT", "bondje.doue@igkdev.com");
define("IGK_DOMAIN", "igkdev.com"); //base domain
define("IGK_LIB_DIR", dirname(__FILE__)); //lib dir
define("IGK_LIB_CGI_BIN_DIR", IGK_LIB_DIR."/cgi-bin");//cgi lib dir
define("IGK_COMPANY", "igkdev"); // company
define("IGK_CODE_NAME", "BALAFON"); // plateform code name
define("IGK_BALAFON_JS", "balafonjs");
define("IGK_BALAFON_JS_CORE_FILE", IGK_LIB_DIR."/Scripts/igk.js");
define("IGK_LIB_FILE", __FILE__);
define("IGK_LIB_RUNFILE", IGK_LIB_DIR."/igk_run_script.php");
define("IGK_LIB_MODS_DIR", IGK_LIB_DIR."/Modules");
// define("IGK_NO_JAVASCRIPT", 1);
// require_once("igk_authorization.php");



require_once(IGK_LIB_DIR."/igk_config.php");
require_once(IGK_LIB_DIR."/igk_gd.phtml");
define("IGK_PDF_LIB",IGK_LIB_DIR."/../Fpdf/fpdf.php");

//---------------------------------------
// init igk environement global variables
//---------------------------------------
$IGK_ENV = array();


 //require_once(dirname(__FILE__)."/../Fpdf/fpdf.php");
//define("IGK_LOG_FILE", igk_io_dir(IGK_LIB_DIR."/Data/logs/balafon.log"));
///---------------------------------------------------------------------------------
///GLOBAL FUNCTION DEFINITION
///---------------------------------------------------------------------------------
///<summary> return the application in the current session </summary>
function igk_app(){
	return IGKApp::getInstance();
}
///<summary>enable display error</summary>
function igk_display_error($a){
	if ($a){
		ini_set("display_errors", "1");		
		error_reporting( E_ALL | E_STRICT | E_NOTICE);
		ini_set('error_reporting', E_ALL | E_STRICT);		
	}else{
		ini_set("display_errors", "0");
	}
}

function igk_stop_timeout(){
	ini_set("max_execution_time", 0);
}
///<summary>store start time</summary>
function igk_start_time($name=null){
	$t = microtime(true);
	igk_set_env("sys://env/starttime".($name?"/{$name}":""), $t );
	return $t;
}
///<summary>calculate execution time</summary>
function igk_execute_time($name=null, $time=null){
	$t = igk_get_env("sys://env/starttime".($name?"/{$name}":""), 0);
	return (float) ($time ?? microtime(true)) -  (float)$t;
}
function igk_app_version(){
	return IGK_PLATEFORM_NAME. " ".IGK_VERSION;
}


function igk_app_destroy(){
	return IGKApp::Destroy();
}


function igk_header_status($code){
	return igk_getv(igk_get_env("sys://header/statuscode", function(){
		$t = array(
		301=>"301 Move Permanently",
		302=>"302 Found",
		404=>"404 Page Not found"
		);
		
		return $t;
	}), $code);
}




function igk_detect_closure($obj, & $closures){


$tq = array(array("v"=>$obj, "path"=>"."));

//get property for parent
// $cp = new ReflectionProperty("IGKHtmlItemBase", "m_fs");
// igk_wln($cp);
 // $cp->setAccessible(true);
 // igk_wln(array_keys($cp->getValue($body)));
 // igk_wln("kjd");
 // // igk_wln(serialize($body));
 // igk_exit();
 
 
//igk_wln(igk_app()->Doc->body->{"\0IGKHtmlItemBase\0m_fs"});
// exit;
$found = false;
$where = null;
$path = ".";
$obj_found = array();
$idx = 0;
$depth =0;
$closures = array();
$first = 0;
$debug = 0;
while($cq = array_pop($tq)){
	$q = $cq["v"];
	$path = $cq["path"];

	$depth++;
	if (igk_is_closure($q)){
		//igk_wln("founnnnnnnnnnnd: ".$path . " depth: ".$depth. " ::: ".get_class($q));
		$found = 1;
		$closures[] = $path;
		if ($first)
			break;
		continue;
	}
	// igk_wln("Check for : ----- ". $path);
	
	if (is_object($q)){
		
		$hash = spl_object_hash($q);
		
		if (isset($obj_found[$hash])){						
			$obj_found[$hash]->ref++;
			continue;
		}		
	
		
		$obj_found[$hash] = (object) array("idx"=>$idx,"ref"=>1, "path"=>$path);
		$idx++;
	
	
	
	$r = new ReflectionClass($q);
	$tab = $r->getProperties(ReflectionProperty::IS_PRIVATE);
	$gr = $r;
	while($parent = $gr->getParentClass()){						
		$pc = $parent->getName();
		$gr = new ReflectionClass($pc);
		$cpt = $gr->getProperties(ReflectionProperty::IS_PRIVATE| ReflectionProperty::IS_PUBLIC);
		$tab = array_merge($tab, $cpt);					
	}

		$treated = array();
	foreach($tab as $k=>$v){
		//igk_wln($v);
		$prop = $v;//new ReflectionProperty($q, $v->name);
		$ns = "\0".$v->class."\0".$v->name;
		if ($prop->isStatic() || isset($treated[$ns]) || isset($treated[$v->name]))
			continue;
		
		if ($prop->isPublic()){
			$treated[$v->name]=1;
		}
		$treated[$ns]=1;
		
		//igk_wln("private : ".$v->name);
		 $prop->setAccessible(true);
		 $gvb = $prop->getValue($q);
		 
		 if ($gvb === null)
			 continue;
		 
		 if (igk_is_closure($gvb)){
			 $found = true;
			 //igk_wln("private found callback ".$path."/".$v->name . " depth: ".$depth. " ::: ".get_class($q));
			 $closures[] = $path."/{$v->name}";
			 if ($first)
				break 2;
			continue;
		 }
		 if (is_array($gvb)){
			// igk_wln("array found ".$v->name);
			 foreach($gvb as $kk=>$vv){
				 array_unshift($tq,array("v"=>$vv, "path"=>$path."/{$v->name}/{$kk}"));
			 }
		 }
		 else if (is_object($gvb)){
			 // igk_wln("object found::::::::::::::::::::::::::::::: ".$path."/{$v->name}");
			 array_unshift($tq, array("v"=>$gvb, "path"=>$path."/{$v->name}"));
			 
		 }					
	}
		
		
		foreach($q as $c=>$m){
			
			if (($m ===null) || isset($treated[$c] ))
				continue;
			
			if (igk_is_closure($m)){
				// igk_wln("found publick ".$path."/{$c} ");
				$found=1;
				$closures[] = $path."/{$c}";
				if ($first)
					break 2;
			} else if (is_object($m)){
				// igk_wln("pObject ".$path."/".$c);
				array_push($tq,array("v"=>$m, "path"=>$path."/{$c}"));
			}else if (is_array($m)){
				foreach($m as $kk=>$cc){
					array_push($tq,array("v"=>$cc, "path"=>$path."/{$c}/{$kk}"));	
				}
			}
		}
		
	}else if (is_array($q)){
		 foreach($q as $kk=>$vv){
				 array_unshift($tq,array("v"=>$vv, "path"=>$path."/{$kk}"));
		 }
	}
	// else{
		// igk_wln("kkk" .$q);
	// }
}


// igk_wln("found ... ?".$found);
// igk_wln($closures);

return $found;
}
			
			

//------------------------------------------------------------------------------
//command line handler
//------------------------------------------------------------------------------
//<summary>command line handler</summary>
function igk_handle_cmd_line(){
	$tab = array_slice(igk_getv($_SERVER,"argv"), 1);
	
	$n = igk_getv($tab,0);
	if ($n && ($g  = igk_getv(igk_get_env("sys://cmd/args"), $n))){
		// igk_wln("call ....".$n);
		// igk_wln($g);
		call_user_func_array($g->callback, array_slice($tab, 1));
		return true;
	}
	
	return false;
}
///<summary>register command line</summary>
function igk_reg_cmd_args($name, $desc, $callback){
	$t = igk_get_env("sys://cmd/args", array());
	$t[$name] = (object)[
	"callback"=>$callback,
	"desc"=>$desc,
	"category"=>"system"
	];	
	igk_set_env("sys://cmd/args", $t);
}


function igk_data_get_cron_file(){
	return igk_io_baseDir()."/".IGK_DATA_FOLDER."/.crons.json";
}
///<summary>add control control</summary>
function igk_data_addcron($ctrl){
	$n = "";
	if (is_string($ctrl) && IGKValidator::IsUri($ctrl)){
		$n = $ctrl;
	}else if (is_object($ctrl) && igk_is_controller($ctrl)){
		$n = $ctrl->Name;
	}else{
		igk_die("can't add ".$ctrl);
	}

	$f = igk_data_get_cron_file();
	$t = (array)igk_get_env("sys://con/settings") ?? igk_json_parse(igk_io_read_allfile($f));
	$b = igk_getctrl(IGK_SESSION_CTRL)->getUri("RunCron&ctrl=".$n);
	$t[$b] = 1;
	igk_set_env("sys://con/settings", $t);
	//save cron
	igk_io_save_file_as_utf8_wbom($f, igk_json_encode($t),true);

}
///<summary>destroy all stored session</summary>
///<note>administrative function</note>
function igk_kill_all_sessions($exclude=null){
	//$tab = ini_get_all();
	
	$d = ini_get("session.save_path");
	$i=0;
	if(is_dir($d))
	{

		//session_destroy();
		//close current session
		session_write_close();
		$_SESSION = array();
		$_COOKIE= array();
		$f = IGKIO::GetFiles($d, "/^(.)+$/i",false);
		if ($f) {
			foreach($f as $k=>$v)
			{
				//igk_ilog($v. " vs ".$exclude);
				if ($exclude && (preg_match("#".$exclude."$#i",basename($v)))){					
					continue;
				}
				unlink($v);
				$i++;
			}
		}
	}
	return $i;
}
///<summary>check if session file exists
function igk_session_exists($id, & $filesize=null){
	$d = ini_get("session.save_path");
	// igk_wln(ini_get_all());
	$f = igk_io_dir($d."/sess_".$id);
	// igk_wln($f);
	if (file_exists($f)){
		// return true;
		$filesize = filesize($f);
		return true;
	}
	return false;
}

///<summary>force reset session handle to default behaviour.</summary>
function igk_session_reset_handler(){
	ini_set("session.save_handler","files");
	// igk_wln(ini_get("session.save_handler"));	
	// session_set_save_handler(
	// null,//open
	// null,//close
	// null,//read
	// null,//write
	// null,//destroy
	// null,//gc
	// null,//createid
	// null,//validatesid
	// null//update timespan
	// );
	
	register_shutdown_function('session_write_close');
	// igk_wln('reset');
	session_reset();
	
}

///<summary>determine if session is active or not</summary>
function igk_session_is_active(){
	//for version 7.0+
	return session_status() === PHP_SESSION_ACTIVE;
}

///<summary>call it at end to update the session</summary>
function igk_session_update($id, $callback, $close=1){
	
	if (!igk_session_exists($id))
		return;
	if (session_id()==$id ){
		return;
	}
	//igk_wln("Status : ".session_status());
	igk_session_reset_handler();
	session_name('PHPSESSID');
	session_id($id);		
	@session_start();
	
	$callback($id, igk_app());
	if ($close)
		session_write_close();
	
}

function igk_get_configs_menu_settings(){
	return igk_get_env("sys://configs/menu");
}

///<summary>retrieve an array of session id</summary>
function igk_get_all_sessions(){
	$d = ini_get("session.save_path");
	$dt = null;
	if(is_dir($d))
	{
		$dt = array();
	}
	return $dt;
}
///<summary>convert to identifier</summary>
function igk_get_identifier($n){
	return preg_replace("/([^0-9a-z])/i", "_", $n);///str_replace(" ", "_", str_replace("=","_", $n));
}


function igk_get_defaultview_content(){
	$date = date("Y/m/d - H:i:s");
	return <<<EOF
<?php 
//
//author: 
//view file : {$date}
\$t->clearChilds();
?>
EOF;
}

function igk_sys_render_default_uri($uri=null, $ctrl=null, $ownctrl=1){
	$uri = $uri ??  "/".igk_io_baseRequestUri();
	$defctrl = $ctrl ?? igk_get_defaultwebpagectrl();
	if ($defctrl && ($ownctrl ||igk_own_view_ctrl( $defctrl) ) && method_exists($defctrl, "is_handle_uri") && $defctrl->is_handle_uri($uri)){
		$defctrl->handle_redirection_uri($uri);
		igk_ilog("/!\\ bad - not handling {$uri} correctly :". $defctrl);
		igk_exit();
	}
}



///<summary>return an array of server session id</summary>
function igk_sys_get_all_openedsessionid(){
	$tab= array();
	$d = ini_get("session.save_path");
	if(is_dir($d)){
		$f = IGKIO::GetFiles($d, "/^(.)+$/i",false);
		if ($f) {
			foreach($f as $k=>$v)
			{
				if (filesize($v)=="0")
					continue;
				$n=igk_str_rm_start(basename($v), IGK_SESSION_FILE_PREFIX);
				$tab[$n] = ["id"=>$n, "file"=>$v];
			}
		}
	}
	return $tab;
}

///<summary>register uri callback</summary>
///<exemple>igk_sys_reg_uri('R/Scripts/balafon.js')</exemple>
function igk_sys_reg_uri($u, $callback){	
	
	igk_set_env_keys("sys://reg/systemuri", $u, $callback);
	
	// $b = igk_get_env("sys://reg/systemuri", array());
	// $b[$u] = $callback;
	// igk_set_env("sys://reg/systemuri",$b);
}
///<summary>handle uri callback</summary>
function igk_sys_handle_uri($u=null){
	$u = $u ?? "/".igk_io_baseRequestUri();
	
	$uri_key = "sys://reg/systemuri";	
	$b = igk_get_env($uri_key);
	
	if (isset($b[$u])){
		$fc = $b[$u];
		ob_clean();
		$fc();
	}else{
		
		// try to match uri pattern
		foreach($b as $k=>$v){
			// igk_wln($k);
			$p =null;
			if (preg_match("/\[%q%]/i", $k)){
				//allow extra query
				$sk = str_replace("[%q%]","(\?(:query))?", $k);
				$p = igk_sys_ac_create_pattern(null, null, $sk);
		
		

				if ($p->matche($u)){					
				
					$request = explode("?", $u)[0];
					if (!isset($b[$request])){
						$b[$request]= $v;
						igk_set_env($uri_key, $b);
					}
					ob_clean();
					
					//igk_wln("call");
					call_user_func_array($v, $p->getParams());
					break;
				}			
			}
		}
		
	}	
	igk_sys_handle_ctrl_request_uri($u);
}

function igk_io_collapse_path($str){
	$str = str_replace(IGK_LIB_DIR,"%lib%", $str);
	if (defined('IGK_APP_DIR'))
		$str = str_replace(IGK_APP_DIR,"%app%", $str);
	return $str;
}
function igk_io_expand_path($str){
	$str = str_replace("%lib%", IGK_LIB_DIR, $str);
	if (defined('IGK_APP_DIR'))
	$str = str_replace("%app%", IGK_APP_DIR, $str);
	
	return $str;
}
function igk_io_arg_from($f){
	$arg = null;
	if (strstr($f, "/"))
	{
		$a = explode("/", $f);
		$f = $a[0];
		$b = array_slice($a, 1);
		if (igk_count($b) == 1)
		{
			$arg = $b[0];
		}
		else
			$arg = $b;
	}
	return $arg;
}

///<summary>handle base controller request uri</summary>
function igk_sys_handle_ctrl_request_uri($u=null, $defaultBehaviour=1){
	
	$c = igk_getr("c");
	$f = igk_getr("f");
	$app = igk_app();
    if ($c && $f){
		$f =str_replace("-","_", $f);
		$arg = array();
		$args = igk_getquery_args($u);
		$arg = igk_io_arg_from($f);
		
		// igk_wln($u.": handle base redirection uri dddd . ".igk_env_count(__FUNCTION__));
		// if  (igk_env_count_get(__FUNCTION__)>2){
			// igk_wln("value : ".igk_env_count_get(__FUNCTION__));
			// igk_wln(igk_show_trace());
			// igk_exit();
		// }	
		
		$ctrl  = igk_getctrl($c, false) ?? igk_template_create_ctrl($c);
		if (!$ctrl){
			return null;
		}
			//igk_set_env("sys://ctrl/current__invoke_ctrl", null);


			if (!method_exists(get_class($ctrl), $f))
			{
				header("Status: 404");
				//igk_wln();
				igk_show_error_doc(null, 4046, null, "method not exists [".get_class($ctrl)."::".$f."]");
				igk_exit();
				return false;
			}

			//setup the base current uri
			if ($f == IGK_EVALUATE_URI_FUNC ){
				igk_app()->setBaseCurrentCtrl($ctrl);
			}
			//method exists
			if (($f == IGK_EVALUATE_URI_FUNC ) || $ctrl->IsFunctionExposed($f)){

				$v_isajx = igk_is_ajx_demand() || IGKString::EndWith($f, IGK_AJX_METHOD_SUFFIX) || (igk_getr("ajx") == 1);
				$ctrl->App->Session->URI_AJX_CONTEXT = $v_isajx;
				$fd=null;
				if (($fd = $ctrl->getConstantFile()) && file_exists($fd)) include_once($fd);
				if (($fd = $ctrl->getDbConstantFile()) && file_exists($fd)) include_once($fd);
				unset($fd);
				igk_set_env(IGK_ENV_REQUEST_METHOD, strtolower(get_class($ctrl)."::".$f));
				igk_set_env(IGK_ENV_INVOKE_ARGS, $args);
				if (is_array($arg))
					call_user_func_array(array($ctrl, $f), $arg);
				else{
					if ($arg)
						$ctrl->$f($arg);
					else{
						$ctrl->$f();
					}
				}
				igk_set_env(IGK_ENV_INVOKE_ARGS, null);
				igk_set_env(IGK_ENV_REQUEST_METHOD, null);
				
				if($defaultBehaviour && $v_isajx)
				{
					igk_exit();
				}
				$ctrl->App->Session->URI_AJX_CONTEXT = 0;
				//reset query 
				unset($_REQUEST["c"]);
				unset($_REQUEST["f"]);
			}
			else{
				$msg = "InvokeUri failed for [".$c."::".$f."] you don't have access to this method.";
				igk_notifyctrl()->addWarning($msg);
				if (!igk_sys_env_production())
				igk_ilog("no access to method ".get_class($ctrl)."::".$f. " . you must have authorisation");
			}
			
	}
}

///<summary>evalute constant and get the value</summary>
///<return>null if constant not defined</return>
function igk_const($n){
	if (defined($n)){
		return constant($n);
	}
	return null;
}
///<summary>check if a constant match the defvalue</summary>
function igk_const_defined($ctname, $defvalue=1){

	if (defined($ctname))
		return constant($ctname) == $defvalue;
	return false;
}

///<summary>check if a constant is present on tubestr</summary>
function igk_is_const_defined($tubestr){
	$r = explode("|", $tubestr);
	foreach($r as $k=>$v){
		if (defined(trim($v)))
			return 1;
	}
	return false;
}



///<summary>return the base uri name of a file</summary>
///<exemple>/var/www/html/igkdev/com/info/li.txt will return com.info.li_txt as return
function igk_base_uri_name($f, $basedir=null){	
	$s = $basedir ?? igk_io_basedir();	
	$k = igk_io_dir($f);	
	$k =  str_replace($s, "", $k);
	$k = str_replace(".","_",$k);
	$k = str_replace(DIRECTORY_SEPARATOR,".",$k);
	if ((strlen($k)>0)&& ($k[0]=="."))
		$k = substr($k,1);
	return $k;
}



///<summary>check if apache module is present</summary>
function igk_apache_module($n){
	if (function_exists("apache_get_modules")){
		return in_array($n, apache_get_modules());
	}
	else{
		ob_start();
		phpinfo();
		$s = ob_get_contents();
		ob_end_clean();
		return strpos($s, $n) !== false;
	}
}

//----------------------------------------------------------------------------------------------
//balafon module management
//----------------------------------------------------------------------------------------------
function igk_get_module_dir(){
	return  IGK_APP_DIR . "/Apps/Modules/";
}
///<summary>represent require module</summary>
function igk_require_module($modulename){
	$v_k = "sys://require_mods";
	$g = igk_get_env($v_k, array());

	if (isset($g[$modulename]))
		return 1;

	$dir = igk_get_module_dir()."{$modulename}";
	if (file_exists($dir)){
		//load file

		//TODO : LOAD FILE DIR
		$f = igk_io_getfiles($dir, "/(.)*\.php$/");
		sort($f);//sort because of unix system
		foreach($f as $k){
			include_once($k);
		}
		
		if (igk_count($f)>0){
			$g[$modulename] = 1;
			$g["::files"][$modulename] = $f;
		}
		igk_set_env($v_k, $g);		
		return igk_init_module($modulename);
	}else{
		igk_die(__FUNCTION__." :: module <b>{$modulename}</b> required not present");
	}
}

function igk_install_module($zipfile){

}
function igk_uninstall_module($path){

}

function igk_create_module($path){
	$v_k = "sys://require_mods";
	$g = igk_get_env($v_k, array());

	if (isset($g[$path]))
		return 0;

	$dir = IGK_LIB_DIR . "/Modules/{$path}";
	igk_wln($dir);
	if (file_exists($dir)){
		return 0;
	}

	if (!IGKIO::CreateDir($dir))
		return 0;
	
	//module construction
	igk_io_save_file_as_utf8_wbom($dir."/.module.pinc",igk_io_read_allfile(IGK_LIB_DIR."/Model/module.php"));

	return 1;
}
function igk_delete_module($path){
	$dir = IGK_LIB_DIR . "/Modules/{$path}";

	if (!file_exists($dir)){
		return 0;

	}
	$r= 1;
	IGKIO::RmDir($dir, true);

	return $r;
}
//utility function
///<summary>return function location</summary>
function igk_get_func_location($func){
	if (function_exists($func)){
		$fc = new ReflectionFunction($func);
		return (object)array("file"=>$fc->getFileName(), "line"=>$fc->getStartLine());
	}
	return null;
}
function igk_get_func_location_str($func){
	return ($g = igk_get_func_location($func))? $g->file: null;
}
function igk_get_class_method_location($ob, $name){
	
	
	$cl = get_class($ob);
	if (empty($cl))
		return null;
	$c = new ReflectionMethod($cl, $name);
	return (object)array(
	"file"=>$c->getFileName(),
	"line"=>$c->getStartLine()
	);	
}
function igk_get_class_location($classname=null){
	$c = new ReflectionClass($classname);
	return (object)array(
	"file"=>$c->getFileName(),
	"line"=>$c->getStartLine()
	);	
}

///<summary>retrieve the active installed module</summary>
function igk_get_modules(){
	$d = igk_io_baseDir()."/".IGK_DATA_FOLDER."/.modules.json";
	if (!file_exists($d))
		return null;
	return  igk_json_parse(igk_io_read_allfile($d));
}

function igk_save_module($path){
	$t = igk_get_modules();
	$tab = $t->modules;
	$d = igk_io_baseDir()."/".IGK_DATA_FOLDER."/.modules.json";

}

function igk_init_module($path){
	$k = "sys://modules/".strtolower(str_replace("/",".", igk_html_uri($path)));
	$b = igk_get_env("sys://modules", array());
	if (isset($b[$k]))
		return $b[$k];

	$dir = igk_io_dir(igk_io_baseDir(). "/Apps/Modules/{$path}");
	if (!file_exists($dir))
		return null;
	
	include_once(IGK_LIB_DIR."/igk_app_module.php");
	$ob =new IGKAppModule($dir);
	$b[$k] = $ob;
	//update modules list 
	igk_set_env("sys://modules", $b);
	return $ob;
}
function igk_get_module($id){
	return igk_init_module($id);
}


///<summary>get if framework is in atomic mode</summary>
function igk_is_atomic(){
	return defined("IGK_FRAMEWORK_ATOMIC");
}
///<summary>check if this is presently on design mode</summary>
function igk_is_design_mode(){
	return igk_get_env("sys://designmode")==1;
}

function igk_is_class_incomplete($n){
	return get_class($n) === '__PHP_Incomplete_Class';
}

///<summary>check for module presence</summary>
function igk_is_module_present($modulename){
	$v_k = "sys://require_mods";
	$g = igk_get_env($v_k, array());

	if (isset($g[$modulename]))
		return 1;
	return 0;
}
///<summary> used to get traceable array</summary>
function igk_get_trace_array($Ex, $level=0){
	$t = array();
	$i = 0;
	foreach($Ex->getTrace() as $k=>$v)
	{
		if($i>=$level){
			if (isset($v["file"])){
				$t[] = array($v["file"]=>$v["line"]);
			}
		}
		$i++;
	}
	return $t;
}

///<summary>invoke a function in the session id context</summary>
///<remark>the current session must be write first</summary>
function igk_invoke_in_session($sid, $callback){
	session_id($sid);
	session_start();
	$o = $callback(igk_app());
	session_write_close();
	return $o;

}

///<summary>get run script</summary>
function igk_get_run_script_path(){
	return igk_getv(igk_app()->Configs, "php_run_script",
		($os =  strtolower(PHP_OS))=="linux"? "/usr/bin/php7.0":
		igk_io_dir('D:\wamp3\bin\php\php7.0.0\php.exe')
	);
}

///<summary>run script on background</summary>
function igk_run_bg_script($f){
	$v_rp = igk_get_run_script_path();

	 if (file_exists($v_rp)){
	$offscreen = "";//
	if (igk_server_is_linux())
		$offscreen = " 2>/dev/null > /dev/null  & ";
	else{
		$offscreen = " >NUL 2>NUL";
		$v_rp = "start /B /Min {$v_rp} ";
		$cmd = $v_rp." ".igk_io_dir(IGK_LIB_RUNFILE)." ".$f.$offscreen;
		pclose(popen($cmd,"r"));
		return 1;
	}
		$cmd = $v_rp." ".igk_io_dir(IGK_LIB_RUNFILE)." ".$f.$offscreen;
				 // igk_wln(PHP_OS);
				 //igk_wln($cmd);
		return shell_exec($cmd);
	 }
	 return false;
}
///<summary> arguments or files lists</summary>
function igk_run_scripts($files){
	$files = is_array($files)? implode(" ", $files) : $files;
	$v_rp = igk_get_run_script_path();
	$cmd = $v_rp." ".igk_io_dir(IGK_LIB_RUNFILE)." ".$files;
	$out=0;
	exec($cmd, $out, $ret);

	if ($ret==0){

	}else{
		igk_ilog("failed to run > ".$cmd);
	}
	return implode("\n",$out);

}
///<summary>get controller session event handler</summary>
function igk_get_session_event_handler(){
	
	$evtlist_controller = igk_get_env("sys://event/ctrl/handler");
	if ($evtlist_controller == null){
		$evtlist_controller = array();
		$ctrls = igk_app()->getControllerManager()->getControllers();
		foreach($ctrls as $k){
			if (method_exists($k, "onHandleSystemEvent")){
				$evtlist_controller[] = $k;
			}
		}
		igk_set_env("sys://event/ctrl/handler", $evtlist_controller);
	}
	return $evtlist_controller;	
}

///<summary>invoke session registrated event</summary>
function igk_invoke_session_event($name, $param){
	$key ="sys://global_events";
	$primary = igk_get_env($key, array());
	$ctx = igk_current_context();
	$p = igk_get_session_event($name);
	
	// igk_wln("raise event ".$name);
	
	$evtlist_controller = igk_get_session_event_handler();
	
	$data = array_merge(array($name), $param);
	foreach($evtlist_controller as $k){
		call_user_func_array(array($k, 'onHandleSystemEvent'), $data);
	}
	
	
	
	if ($p){
		igk_push_env(__FUNCTION__, $name);
		foreach($p as $k){
			
			if (igk_is_closure($k)){
				$k($param[0], igk_getv($param, 1));
			}else{
				$ss = (igk_getv($k, 1) ?? igk_getv($k,0 ));
				call_user_func_array($k, $param);
			}
		}
		igk_pop_env(__FUNCTION__);
	}else{
		igk_debug_wln("/!\\ No session event found ".$name);
	}
}


///<summary>register global tempary event. only one callback </summary>
function igk_reg_session_event($name, $callback){
	igk_debug_wln(__FUNCTION__. " ".$name);
	$ctx = igk_current_context();
	$e = strpos("running|starting", $ctx)!==false;
	$key ="sys://global_events";
	$primary = igk_get_env($key, array());
	$t=null;
	
	switch($ctx){
		case "initialize":
			$primary[$name][] = $callback;
			igk_set_env($key, $primary);
			return 1;
		break;
	}
	
	
	

	if ($e){				
		$t = igk_app()->Session->Events ?? array();	
	}else{
		igk_die("context not supported ".$ctx);
	}
	if (!isset($t[$name])){
		$t[$name] = array();		
	}
	$t[$name][] = $callback;
	igk_app()->Session->Events = $t;
	
	return 3;
}
///<summary>get session event by name </summary>
///<param name="name">the key of the name session to get</param>
function igk_get_session_event($name){		
	$ctx = igk_current_context();
	$key ="sys://global_events";
	$e = strpos("running|starting", $ctx)!==false; //found runnin or starting
	$empty = array();
	$primary = igk_get_env($key, array());
	
	if ($e){
		$c = array_merge_recursive($primary, igk_app()->Session->Events ?? array());		
		$s =  igk_getv($c, $name);
		return $s;
	}
	else{
		return igk_getv($primary, $name);
	}
}

function igk_cmp_array_value($v, $c){
	if (is_array($v) && is_array($c)){
		
		$dc = igk_count($v);
		$hc = igk_count($c);
		// igk_wln($dc. " vs ".$hc);
		
		if ($dc == $hc){
			for($i=0; $i< $dc;$i++){
				if ($v[$i]!==$c[$i]){
					return false;
				}
			}
			return true;			
		}
	}
	return false;
}
///<summary>unreg session event by name</summary>
///<param name="name">the key of the name session event</param>
///<param name="callback">callback to register</param>
function igk_unreg_session_event($name, $callback){
	
	$e = igk_get_session_event($name);
	$ctx = igk_current_context();
	$key ="sys://global_events";
	$rne = strpos("running|starting", $ctx)!==false;
	switch($ctx){
	case "initialize":
		//get only primary
		$e = igk_getv(igk_get_env($key, array()),$name);
	break;
	default:
		$e = igk_getv(igk_app()->Session->Events, $name);
	break;
	}
	if ($e){
		$t = array();
		$found = 0;
		foreach($e as $k=>$v){
			// igk_wln("check ");
			if (($v === $callback) || igk_cmp_array_value($v, $callback)){
				// igk_wln("found ....");
				$found=1;
				continue;
			}
			$t[]=$v;
		}
		//store on event
		// igk_wln("check ".$found. " ".$name);
		if ($found){
			switch($ctx){
				case "initialize":
					$h = igk_get_env($key);
					$h[$name]=$t;
					igk_set_env($key, $h);
					break;
				default: 
					$h = igk_app()->Session->Events;
					$h[$name] = $t;
					igk_app()->Session->Events = $h;
					break;
			}
			return 1;
		}
	}
	if (!igk_sys_env_production())
		igk_die("unreg session event failed ".$name);
	return 0;
	
}



///<summary>register widget</summary>
function igk_reg_widget($name, $callback=null, $priority=10){

	$g = igk_get_env(IGK_ENV_WIDGETS_KEY);
	if (!is_array($g)){
		$g = array();
	}
	$g[$name]=(object)array("name"=>strtolower($name),
	"callback"=>$callback);
	igk_set_env(IGK_ENV_WIDGETS_KEY, $g);
}

function igk_get_widgets(){
	return igk_get_env(IGK_ENV_WIDGETS_KEY);
}



function igk_get_path_exec($ext){
	$t = igk_get_env("sys://env//path_exec");
	return igk_getv($t, $ext);
}
function igk_reg_path_exec($ext, $p){
	$t = igk_get_env("sys://env//path_exec");
	if ($t ==null)
		$t = array();
	$t[$ext] = $p;
	igk_set_env("sys://env//path_exec", $t);
}

function igk_invoke_script($f, $args=null){
	$f = igk_io_dir($f);
	if(file_exists($f)){
		$o = igk_get_path_exec(igk_io_path_ext($f))." ".$f;
		if ($args)
			$o.=" ".$args;
		// igk_wln($o);
		$c= shell_exec($o);//igk_get_path_exec(igk_io_path_ext($f))." ".$f, $out, $ret);
		// igk_wln("out : ".$out);
		// igk_wln($out);
		// igk_wln("ret : ".$ret);
		// igk_wln("c : ".$c);
		return $c;
	}
	return -1;
}


function igk_get_component_info($cmpname){
	$t = array();
	return igk_get_env(IGK_ENV_HTML_COMPONENTS);

	$g = igk_createNode($cmpname);
	if ($g){
		$t["node"] = $g;

	}else{
		$t["error"]=1;
		$t["desc"] = "component {$cmpname} not found";
	}
	return $t;
}

function igk_create_html_component($name, $args=null, $initcallback=null, $class=IGK_HTML_ITEMBASE_CLASS, $context=IGKHtmlContext::Html){	
	
		$c = null;
		$f = IGKString::Format(IGK_HTML_CLASS_NODE_FORMAT, $name);
		if(class_exists($f) && !igk_reflection_class_isabstract($f) && igk_reflection_class_extends($f,  $class) )
		{
			$p = new ReflectionClass($f);
			$tb = array();
			if (is_array($args))
				$tb = $args;
			$o = call_user_func_array(array($p, "newInstance"), $tb);
			if ($o )
				$c =  $o;
			else {
				$c = new $f();
			}

		}
		else{
			if (function_exists(IGK_FUNC_NODE_PREFIX.$name)){
				$fc = IGK_FUNC_NODE_PREFIX.$name;
				$tb = is_array($args) ? $args : array();

				$s = new ReflectionFunction($fc);
				
				$v_pcount = igk_count($tb);//passed params
				$v_rp = $s->getNumberOfRequiredParameters();//request params
				if ($v_pcount>= $v_rp ){
				
					$c = call_user_func_array($fc, $tb);

					if ($c){
						if ($initcallback)
							$initcallback($c, array("type"=>IGK_COMPONENT_TYPE_FUNCTION, "name"=>$fc));
					}
					else{
						igk_wln("item not created ::: ".$fc. " method not returning a valid data node");
						// igk_exit();
					}
				}else{
					igk_die("{$name} : number of require parameters expected do not match. expected {$v_rp} but ".$v_pcount ." passed" );
				}


			}else {
				if ($context==IGKHtmlContext::Html){
					$c = new IGKHtmlItem($name);
				}else{
					$c = new IGKXmlNode($name);
				}
			}
		}
		return $c;


}



///<summary>reset all session global variable</summary>
function igk_reset_globalvars(){
	igk_app()->Session->setParam(IGK_KEY_GLOBALVARS, array());
}
///<summary>used to set session global variable</summary>
function igk_set_globalvars($n, $d){
	$s = igk_app()->Session->getParam(IGK_KEY_GLOBALVARS);
	if ($s ==null)
		$s = array();
	if ($d == null){
		if (isset($s[$n]))
			unset($s[$n]);
	}
	else{
		$s[$n] = $d;
	}
	igk_app()->Session->setParam(IGK_KEY_GLOBALVARS, $s);
}
function igk_close_session(){
	@session_write_close();
}
///<summary>start app session</summary>
function igk_start_session($reset=0){
	
	//edge make some diagnostic before start the session on local host. to avoid remove it
	$ie_diagnonstic = igk_getv($_SERVER, "HTTP_REFERER") == "diagnostics://5/";
	
	
	
	// if ($ie_diagnonstic ){
		//because of it , can't start session correctly and can't trace
		//initial script was for balafon.css.php
		//igk_ilog(igk_show_trace());
		//igk_ilog($_SERVER);
		//	igk_exit();
	// }
		
	
	if (defined("IGK_NO_SESSION") || $ie_diagnonstic)
		return;
	
	if ($reset){
		igk_env_count_reset(__FUNCTION__);
	}
	$f = igk_env_count(__FUNCTION__);
	$is_no_start = empty(session_id());
	if (($f>1) || (!$is_no_start)){
		igk_wln("@session already started: {$f}");
		return;
	}
	$id = trim(igk_getr("PHPSESSID"));
	if (!empty($id)){
		session_id($id);
	}
	//Start SESSION
	$b = @session_start();
}
function igk_globalvars_isset($n){
	$s = igk_app()->Session->getParam(IGK_KEY_GLOBALVARS);
	if (($s == null) || !isset($s[$n]))
		return false;
	return true;
}
function igk_globalvars($n){
	$s = igk_app()->Session->getParam(IGK_KEY_GLOBALVARS);
	return igk_getv($s, $n);
}
///<summary>Bind node to document and render it utility function</summary>
function igk_render_node($node, $doc, $render=1){
	if ($doc === null){
		igk_die("[".__FUNCTION__."] document can't be null");
	}
	$bbox = $doc->Body->addBodyBox();
	if (!igk_get_env("sys://doc/no_clear")){
		//
		//remove and dispose all current childs
		//
		$bbox->ClearChilds();
	}
	$bbox->add($node);
	if ($render)
		$doc->RenderAJX();
}
function igk_render_xml_error($code, $message, $data=null){

	$rp = igk_createXmlNode("response");
	$rp->add("status")->Content = $code;
	$rp->add("message")->Content = $message;
	if ($data)
	$rp->addObData($data);
	return $rp;

}

function igk_get_viewparam($param){
	if (is_string($param)){
		return array($param);
	}
	return $param;
}
function igk_get_instance_key($classname){
	$r = igk_get_env(strtolower(trim("sys://instance/key/".$classname)));
	$g =  $r  ?? strtolower("sys://".$classname."::ise");
	return $g;
}

function igk_reg_class_instance_key($classname, $v){	
	igk_set_env(strtolower("sys://instance/key/".$classname), $v);
}






///<summary>get event keys</summary>
function igk_get_event_key($ctrl, $name){
	return strtolower("sys://".$ctrl->Name."/event/".$name);
}
///<summary>get app environment key</summary>
function igk_app_env_key($app, $key){
	 return "app://".$app->Name."/".$key;
}



///<summary> dump array</summary>
function igk_dump_array($tab){
	$n = igk_createNode('div');
	$n["class"]="dumparray igk-row";
	foreach($tab as $k=>$v){
		$r = $n->addDiv();
		$r->addSpan()->setClass("k")->Content = $k;
		$r->addSpan()->setClass("v")->Content = is_string($v)? $v: (is_object($v)?get_class($v): $v);
	}
	$n->RenderAJX();
}
function igk_get_image_uri($options, $src){
		$lnk = $src;
		//igk_log_write_i("SRC",  ":".$lnk);
		$m = igk_xml_is_options_mail($options);
		if ($m)	{
			$uri = new IGKHtmlUri();
			$uri->setValue($lnk);
			$r = new IGKHtmlItem("img");
			$r->setAttributes($this->Attributes);
			if($options->Attachement){
				$d = null;
				if (!empty($this->m_lnk) && file_exists($lnk))
				{
					$d = $options->Attachement->attachFile(realpath($lnk), "images/pictures",null);
				}
				else{
					$q = igk_post_uri($this->m_lnk);
					if (!empty($q)){
						$d = $options->Attachement->attachContent($q, "images/pictures",null);
					}
				}
				if ($d)
				// $r["src"]
					$s ="cid:".$d->CID;
			}
			else{
				//$r["src"]
				$s = $uri->getValue($options);
			}
			return $s ; //,$r->Render($options);
		}
		//treat lnk
		if (strstr($lnk, ".."))
		{
			$lnk = str_replace("../",IGK_STR_EMPTY,  $lnk);
		}
		$s = IGK_STR_EMPTY;
		$k = igk_html_uri($lnk);
		$rf = null;//real filename
		if (!empty($k))
		{
			if (IGKValidator::IsUri($k) ||
				(preg_match("#^file://#i", $k)) ||
				(preg_match("#^\{(.)*\}$#i", $k)) //expression must not be evaluated.
			 )
			{
				$s = $k;
			}
			else{
				$f = igk_getv(explode("?", $lnk), 0);
				if (file_exists($f))
				{
					$rf = realpath($f);
					if (igk_is_ajx_demand())
					{
						$s = igk_io_baseUri()."/".igk_html_uri(igk_io_basePath($rf));
					}
					else {
						$s = igk_io_fullpath2Uri($rf, true);
					}
				}
				else {

					$s = "";// igk_html_uri(igk_io_currentRelativePath($f));
					$bf = igk_html_uri(igk_io_currentRelativePath($f));
					if (!file_exists($bf))
					{
						//adding info
						$bf =null; //$this->m_img["class"] = "+igk-img-not-found";
						// $this->m_img["exists"] = file_exists($bf);
						// $this->m_img["ruri"] = $f;
					}
					$s = $bf;
				}

			}
		}
		else
			$s = $k;

		if (($s!=null) &&  (($kc =  strpos($lnk, "?")) !== false)){
			$s .= "?".substr($lnk, $kc+1);
		}
		return $s;


}


///<summary>register node fonction to parameter list</summary>
function igk_node_reg_function($node, $name, $callback){
	$key = IGK_COMPONENT_REG_FUNC_KEY ;
	$d = $node->getParam($key);
	if ($d == null)
		$d = array();
	$d[$name] = $callback;
	$node->setParam($key, $d);
}

///<summary>create an attribute to render value by calling callback</summary>
///<param name="n" > name or array callback </param>
function igk_create_attr_callback($n, $attrs){
	$s=null;
	if (is_callable($n)){
		$s = (object)array(
			IGK_OBJ_TYPE=>"callable",
			"name"=>$n,
			"attrs"=>$attrs
			);
		return $s;
	}
	return $s;
}

///<summary>get node component uri</summary>
///<param name="c" > node to get uri</summary>
///<param name="u" > the local uri of the component</summary>
function igk_node_get_uri($c, $u){

	if (!$c)
		return null;
	return "?!/".$c->getParam("system://component/id")."/".$u;
}

///<summary> used to handle a view command with function list</summary>
function igk_handle_view_cmd($params, $fclist){
	include(IGK_LIB_DIR."/Inc/.igk.fc.call.inc");
	return $fc_result;
}
///<summary>handle component uri</summary>
function igk_handle_component_uri(){
	$uri = trim(igk_getv( explode('?', igk_io_request_uri()), 1));
	if (!empty($uri) && ($uri[0]=="!")){
		//igk_wln("handle component uri");
		//
		//>/id/function/param1/param2/.....
		//
		//

		//expression
		$k = "^!/:id(/|(/:function(/|/:params+)?)?)";

		//$k  = "^/sampleid";
		$s  = igk_pattern_matcher_get_pattern($k);
		if (preg_match($s , $uri)){
			//igk_wln("component match ok ");

			$keys = igk_str_get_pattern_keys($k);
			// $tab = array();
			// preg_match_all($s, $uri, $tab);
			//igk_wln($tab);

			$s = igk_pattern_get_matches($s, $uri, $keys);
			//igk_wln($s);
			extract($s);

			$doc = igk_get_last_rendered_document();
			$comp = $doc->getComponent($id);
			$c = igk_getv($comp->getParam(IGK_COMPONENT_REG_FUNC_KEY),$function);
			if(is_callable($c))
			{
				$t = array($comp);
				if (is_string($params) && (strlen($params=trim($params))>0))
					$params = array($params);
				if ($params)
					$t = array_merge($t, $params);
					//is the same
				if (is_array($c))
					call_user_func_array($c, $t);
				else
					call_user_func_array($c,  $t);
			}
			return true;
		}




		// $s = igk_str_get_pattern_keys($k);
		// igk_wln($s);

		// $actionctrl = igk_getctrl(IGK_SYSACTION_CTRL);
		// $actionctrl->View();
		// igk_wln($actionctrl->TargetNode);
		// $ul = igk_createNode();
			// foreach($actionctrl->getActions() as $k=>$v)
				// {
					// $li = $ul->addLi()->setClass("igk-row");
					// $li->add("label", array("class"=>"igk-col-xl-12 no-overflow igk-text-ellipis"))->Content = $k;
					// $li->add("label", array("class"=>"igk-col-xl-3"))->Content = $v;
				// }
			// $ul->RenderAJX();
		// igk_exit();

	}
	//$uri = igk_getv($_SERVER, "QUERY_STRING");
	// igk_exit();
	// igk_wln($_SERVER);
	// igk_wln("uri : ".$uri);
	return false;

}
function igk_sql_data_type($t){
	switch(strtolower($t)){
		case "int":
		case "integer":
			return "Int";
		case "varchar":
			return "VARCHAR";
		case "text":
		case "string":
			return "TEXT";
	}
	return strtoupper($t);
}

//CACHE DATA
function igk_set_cached($n, $data, $duration=600){
	$igk = igk_app();
	$c = $igk->Session->getParam("sys://cache");

	if ($c == null){
		$c = array();
	}
	$c[$n] = (object)array("data"=>$data, "date"=>igk_date_now(), "duration"=>$duration);
	$igk->Session->setParam("sys://cache", $c);
}
function igk_get_cached($n, $def=null){
	$igk = igk_app();
	$c = $igk->Session->getParam("sys://cache");

	if ($c == null){
		$c = array();
		$igk->Session->setParam("sys://cache", $c);
	}
	if (isset($c[$n]) && !igk_cache_expired($c[$n]))
		return $c[$n]->data;
	return $def;
}



function igk_get_cookie_domain(){
	
	$p = igk_getv($_SERVER, "HTTP_HOST");
	if (IGKValidator::IsIPAddress($p)){
		return "localhost";
	}
	return $p;
}

///COOKIE FUNCTION
function igk_get_cookie_name($n){
	return str_replace('.','_',$n);
}
function igk_get_cookie_path($b=null){
	return $b ? "/".$b : "/";
}
function igk_get_cookie($n){
	$n =igk_get_cookie_name( igk_sys_domain_name()."/".$n);
	if (!isset($_COOKIE)){
		if (!igk_sys_env_production()){
			igk_die("cookie variable not found. ".$n);
		}
		return null;

	}
	return igk_getv($_COOKIE, $n);
}
function igk_set_global_cookie($n, $v=null, $override=1, $tm=null){
	
	$rs = igk_getv($_COOKIE, $n);

	if (!isset($_COOKIE[$n]) || $override){
		// igk_wln ($n.' set the cookie {$v}:'.$tm . " ".igk_get_cookie_path());
		setcookie($n, $v,$tm ??  time() + (86400 * 7), igk_get_cookie_path());
		//make it global
		$_COOKIE[$n] = $v;
		return $v;
	}
	return $rs;
}
function igk_set_cookie($n, $v=null, $override=1, $tm=null){
	$n =igk_get_cookie_name( igk_sys_domain_name()."/".$n);
	igk_set_global_cookie($n,$v, $override, $tm);
}
function igk_clear_cookie($n){
	$m =igk_get_cookie_name( igk_sys_domain_name()."/".$n);
	$rs = igk_getv($_COOKIE, $m);
	igk_set_cookie($n, "", 1, time()-(7 *24 *60));
	if ($rs)
	unset($_COOKIE[$m]);
}
function igk_clearall_cookie(){
	$tab = $_COOKIE;
	
	foreach($tab as $k=>$v){
		igk_set_global_cookie($k, "", 1, time()-(7 *24 *60));
		unset($_COOKIE[$k]);
	}
}
function igk_cache_expired($o){
	$n = igk_date_now();
	$d1 = igk_time_span(IGK_DATETIME_FORMAT,  $n);
	$d2 = igk_time_span(IGK_DATETIME_FORMAT,  $o->date);
	$b = ($d1 - $d2);
	return $b > $o->duration;
}

///<summary>get last rendered document</summary>
function igk_get_last_rendered_document(){
	return IGKHtmlDoc::LastRenderedDocument();
}

function igk_get_rendering_node(){
	return igk_get_env("sys://igk_html_rendered_node/node");
}
function igk_set_rendering_node($n){
	igk_set_env("sys://igk_html_rendered_node/node", $n);
}
///<summary>set the favicon to this document</summary>
///<param name="doc">IGKHtmlDocument </param>
///<param name="f">relative or fullpath to the favicon file </param>
function igk_doc_set_favicon($doc, $f){
	//shortcut
	//$doc->setFavicon(igk_html_uri("http://local.com/".$dir));// new IGKHtmlRelativeUriValueAttribute($dir));
	//$doc->setFavicon( new IGKHtmlRelativeUriValueAttribute(igk_html_uri($dir)));
	//usage in controller: 		igk_doc_set_favicon($doc, $this->getDataDir()."/R/favicon.ico");
	if ($doc && file_exists($f)){
		$p = igk_html_uri(igk_io_baseRelativePath(realpath($f)));
		$doc->Favicon = new IGKHtmlRelativeUriValueAttribute($p);
	}
}
function igk_doc_enable_mobile_app($doc){
	$meta =  igk_createNode("meta");
	$meta["name"] = "mobile-web-app-capable";
	$meta["content"]="yes";
	$doc->Metas->addMeta("mobile-web-app-capable", $meta);
}

///<summry>use this to add tempory script to document</summary>
function igk_doc_add_tempscript($doc, $script, $onlyonce=1,$attr=null){
	if (igk_is_ajx_demand()){
		$k = "sys://js/tempscripts/";
		$c = igk_get_env($k, array());
		if (isset($c[$script]))
			return $c[$script];

		$js = igk_createNode("NoTagNode");
		if (file_exists($script)){
			$o = $js->addScript()->setContent(igk_io_read_allfile($script));
			$o->deactivate("defer");
		}else{
			$o = $js->addScript($script); //->setContent(igk_io_read_allfile($script));
		}
		if ($attr){
			$o->setAttributes($attr);
		}
		$js->RenderAJX();

		$c[$script]=$js;
		igk_set_env($k, $c);
		return $o;

	}
	else
		return $doc->addTempScript($script, $onlyonce);

}
///<summary>shortcut :  set meta do document</summary>
function igk_doc_set_meta($doc, $name, $content){
	$sm = $doc->Metas;

	$meta = $sm->getMetaById($name);
	if ($meta==null){
		$meta =  igk_createNode("meta");
		$doc->Metas->addMeta($name, $meta);

	}

	if ($content == null){
		//remove the meta
		$doc->Metas->rmMeta($name);
	}else {
	//igk_wln("write meta");
	//if (is_object($meta)){
		$meta["name"]=$name;
		$meta["content"]=$content;
	// }
	}
}

function igk_doc_is_global($doc){
	return igk_app()->Doc === $doc;
}

function igk_createAdditionalConfigInfo($tab){
	$o = new StdClass();
	$o->clType = igk_getv($tab, "clType");
	$o->clDefaultValue = igk_getv($tab, "clDefaultValue");
	$o->clRequire = igk_getv($tab, "clRequire");
	return $o;

}
///<summary>return pattern match from uri key regex get from action in IGK_ACTION_CTRL</summary>
///<param name="k">the pattern key </param>
///<param name="buri">the base uri</param>
function igk_pattern_get_uri_from_key($k, $buri=null){
	$buri = igk_str_rm_last( $buri?$buri:igk_io_baseUri(),'/');
	while(preg_match("/^\^/i", $k))
	{
		$k = substr($k,1);
	}
	//igk_wln("init: ".$k);
	$e = IGK_REG_ACTION_METH;
	while(igk_str_endwith($k, $e)){
		$k = substr($k, 0, strlen($k)-strlen($e));
	}
	while(igk_str_endwith($k, "$")){
		$k = substr($k, 0,strlen($k)-1 );
		break;
	}
	$k = preg_replace_callback("/\([^\)]+\)(\?)?/i", function($m){
		return "";
	}, $k);
	return $buri.$k;
}

function igk_pattern_get_matches($pattern, $uri, $keys){
$c = preg_match_all($pattern, $uri, $tab);
			$t = array();
			if (($c>0) && ($keys)){
			foreach($keys as $k=>$v)
			{
				$s = $tab[$v][0];
				if (strstr($s, "/"))
					$s = explode("/", $s);
				if (!isset($t[$v]))
					$t[$v] = $s;
				else{
					if (is_array($t[$v]))
						$t[$v][] = $s;
					else{
						$t[$v] = array($t[$v], $s);
					}
				}
			}
	}
	return $t;
}
function igk_pattern_matcher_matchcallback($m){
	$n = $m["name"];
	if (substr($m[0],-1) == "+")
	{
		$tm =  "(?P<".$n.">([^/]+/?)+)";
	}
	else{
		$tm =  "(?P<".$n.">[^/]+)";
	}
	return $tm;
}
function igk_pattern_matcher_get_pattern($s){
	$s = preg_replace_callback(
			"#:(?P<name>([a-z0-9]+))\+?#i",
			"igk_pattern_matcher_matchcallback",
			$s
	);
	//remove last dollar sign at the end
	$s = preg_replace_callback("/\\$\$/i", function(){return "";},$s);
	//$s= str_replace("$","", $s);
	//igk_wln($s);
	return "/".str_replace("/","\/", $s)."$/i";
}
function igk_datatypes_getinfo($n){
	$c = igk_getctrl(IGK_DATA_TYPE_CTRL);
	return $c->getInfo($n);
}
function igk_test_assert($condition, $target, $message){
	if ($condition)
		$target->add("message")->Content = $message;
}

function igk_reg_subdomain($n, $ctrl){
	return IGKSubDomainManager::getInstance()->reg_domain($n,$ctrl);
}

///<summary>register global balafon settings</summary>
function igk_reg_global_setting($n, $d, $desc=null){
	$k = IGK_ENV_GLOBAL_SETTING;
	$tab = igk_get_env($k, array());

	if (isset($tab[$n]))
		return 0;
	$obj = igk_createObj();
	$obj->clName = $n;
	$obj->clData = $d;
	$obj->clDesc = $desc;
	$tab[$n]  = $obj;

	igk_set_env($k, $tab);
	return 1;

}

//-----------------------------------------------------------------------------
//AJX : UTITILY FUNCTIONS
//-----------------------------------------------------------------------------

///<summary>Replace controller view</summary>
///<note> it call view replace controller view.</note>
///<param name="ctrl"> controller to use in replacement strategie.</param>
///<param name="view"> demand to call the current view.</param>
function igk_ajx_replace_ctrl_view($ctrl, $view=1){

	if (!$ctrl)
		return;
	if($view){
		// igk_wln("main view ".$ctrl->MainView);
		$ctrl->setCurrentView($ctrl->MainView);
	}
	$c = new IGKHtmlAJXCtrlReplacementNode();
	$c->addCtrl($ctrl);
	$c->RenderAJX();

	//reset sytem var
	$ctrl->regSystemVars(null);
}

///<summary>close a visible notify dialog</summary>
function igk_ajx_close_dialog(){
	$s = igk_createNode("BalafonJS");
	$s->Content = "igk.balafonjs.utils.closeNotify(1);";
	$s->RenderAJX();
}
///<summary> shortcut to notify dialog</summary>
function igk_ajx_notify_dialog($title, $content, $type="default", $render=true){
	$notbox = new IGKHtmlNotifyDialogBoxItem();
	$notbox->setClass("igk-".$type);
	$c = $notbox->show($title, $content);
;
	if ($render){
		$c->RenderAJX();
	}
	return $notbox;
}

function igk_ajx_notify_dialog_callback($title, $uri, $callbacks, $method="POST"){	
	if(igk_qr_confirm()){
		$type = igk_getr("dialog-type","confirm");				
		($fc = igk_getv($callbacks, $type)) &&  
			$fc();
		return;
	}
	$fc = igk_getv($callbacks, "form") ?? igk_die(array("code"=>"no form callback specified"));	
	$dv = igk_createNode("form");
	$dv["action"]=$uri;
	$dv["method"]=$method;
	$dv->addObData(function()use($fc, $dv){
		$fc($dv);
	});	
	igk_html_add_confirm($dv);
	igk_ajx_notify_dialog($title, $dv);	
	igk_exit();
}



function igk_ajx_toast($msg, $classtype=null){
	$ajx = igk_createNode("toast");
	if ($classtype!=null)
		$ajx["class"] = "+".$classtype;
	$ajx->Content = $msg;
	$ajx->RenderAJX();
}

///<summary>render a replacement node</summary>
function igk_ajx_replace_node($n,$target=null, $hash=null){
	$c = new IGKHtmlAJXReplacementNode();
	$c["target"] = $target;
	$c["hash"] = $hash;
	$c->addNode($n);
	$c->RenderAJX();
}
function igk_ajx_render_response($tab, $tagname="response", $type="text/plain"){
	$r = igk_createNode($tagname);
	if (is_array($tab)){
		foreach($tab as $k=>$v){
			$r->addNode($k)->Content = $v;
		}
	}
	if ($type!=="text/plain"){
		header("Content-Type:".$type);
	}
	$r->RenderAJX();
}
function igk_ajx_notify_close_dialog(){

	$n = igk_createNode();
	$n->addScript()->Content = <<<EOF
ns_igk.winui.notify.close();
EOF;
	$n->RenderAJX();
}

//<summary> register Namespace </summary>
function &igk_reg_ns($n=null, $uri=null)
{
	static $nsmanager;
	if (!isset($nsmanager)){
		$nsmanager = new StdClass;
		$nsmanager->ns = array();
	}
	if ($n!=null)
		$nsmanager->ns[$n] = $uri;
	return $nsmanager;
}
function &igk_get_ns(){
	$s = igk_reg_ns();
	return $s;
}

function igk_print_stack_depth()
{
	$callers=debug_backtrace();
	for ( $i = 0 ; $i < count($callers) ;$i++)
	{
		$f = igk_getv($callers[$i], "function");
		$fl = igk_getv($callers[$i], "file");
		$c = igk_getv($callers[$i], "class");
		//$rd->addLabel()->setClass("fs-i fcl-#aaa")->Content = igk_getv($callers[$i], "file");
		echo "<div>";
		echo "<span>".$i."</span>";
		echo "<span style='color:#fd3333; text-align:right; width: 90px; display:inline-block;'>".igk_getv($callers[$i], "line")	.":</span><span>";

		echo $f."</span><span>";
		echo $c."</span><span>";
		echo $fl."</span>";
		echo "</div>";
	}
}

function igk_get_amount($v=0, $currency='EUR'){
	return R::ngets("lb.amount_2", $v, igk_get_currency_symbol($currency));
}
function igk_get_currency_symbol($curr='EUR'){
	$t = array("EUR"=>"€", "USD"=>"$");

	return igk_getv($t, $curr);

}
///<summary>convert string argument to array list. in context</summary>
///<param name="s">parameter to convert</param>
///<param name="context">context object that will parameter to convert</param>
function igk_engine_get_attr_arg($s, $context=null){

//to express argument to be replace
// [[:@ctrl]]	
	$tb = igk_str_split_string(",", $s);
	if(($s == null) || !is_object($context)){
		return $tb;
	}
	$m=null;
	if ($context && (is_object($context) || is_array($context))){
		
        $__g_context = (array)$context;//clone context
		extract($__g_context);
        unset($__g_context);

        $cs = array_keys((array)$context);
		$m = igk_str_join_tab(array_values($cs), '|',false);
		$rgx ="#^\[\[:@(?P<name>((".$m.")))(?P<data>(.)+)?\]\]$#i";
		$paramvar_rgx = "#@(?P<name>((".$m.")))#i";
		$callback = function($m,$n){
			return "\$".$m["name"];
		};
		//igk_wln($rgx);
		for($k = 0; $k<igk_count($tb);$k++){
			$mk = trim($tb[$k]);
			// igk_wln("for ".$mk);
			if (preg_match_all($rgx, $mk, $stt)){
				$n=$stt['name'][0];
				$d= $stt['data'][0];
				$d = preg_replace_callback($paramvar_rgx, $callback, $d);
				
				if (!empty($d)){
					$s = "\$context->".$n.$d;
					$m = "return {$s};";
					igk_set_env(IGK_LAST_EVAL_KEY, $m);
					// igk_wln("eval ".$m);
					$tb[$k] = eval($m);
				}else{
					$tb[$k] = $context->$n;
				}
			}
		}
	}
	// igk_wln("ouput");
// igk_wln(array_keys((array)$tb));
// igk_exit();
	return $tb;
}


///<summary> encapsulate exit function. used for debugging purpose</summary>
function igk_exit($close=1){
	
	//
	//log exit call
	//-
	// echo "call exit";
	// igk_ilog("call exit: ".igk_io_request_uri());
	//ob_clean();
    // igk_wln(igk_show_trace());
	
	  // exit;
	// igk_io_a2file("d:\\temp\\trace.html", igk_show_trace()."\n");
	// igk_io_a2file("d:\\temp\\trace.html", igk_ob_get($_SERVER)."\n");
	//-
	// igk_sys_handle_action("sys://events/exit", igk_app());
	igk_raise_event("sys://event/onbeforeexit", array(igk_app(), null));
	//force closing the session
	if ($close && !empty(session_id())){
		session_write_close();
		unset($_SESSION);
	}
	exit;
}

///<summary>get font name</summary>
function igk_getfn($f){
	return str_replace(" ", "-",$f);
}
//-----------------------------------------------------------------
//Flushing data functions utility
//-----------------------------------------------------------------
///<summary>write data</summary>
function igk_flush_write($data){
	igk_wl('data: ' . $data. "\n\n");
}
///<summary>flush data.  </summary>
///<note>flush data cause the header to be send.  </summary>
function igk_flush_data(){
	@ob_flush();
	flush();
}
///<summary>begin flushing data </summary>
function igk_flush_start()
{
	while(ob_get_level())
	{
		ob_end_flush();
	}
	ob_start();
}
///<summary>utility that combine flush_write and flush_data</summary>
function igk_flush_write_data($data){
	igk_flush_write($data);
	igk_flush_data();
}
///<summary>used to call a ajx function to render content offscreen</summary>
function igk_ob_get_func($callback, $args=array())
{
	IGKOb::Start();
	call_user_func_array($callback, $args);
	$c = IGKOb::Content();
	IGKOb::Clear();
	return $c;
}
///<summary>get content</summary>
function igk_ob_get($d){
	IGKOb::Start();
	igk_wln($d);
	$o = IGKOb::Content();
	IGKOb::Clear();
	return $o;
}
function igk_xml_header($v="1.0", $e="utf-8"){
	return "<?xml version=\"$v\" encoding=\"$e\" ?>";
}
function igk_xml_is_options_mail($options){
	if ($options && !isset($options->Context)){
		igk_die("You send options without <b>Context</b> property");
	}
	return $options && ($options->Context == "mail");
}
function igk_xml_create_render_option(){
	$o = igk_createObj(array(
	"Indent"=>0,
	"Document"=>null,
	"Context"=>IGK_WEB_CONTEXT,
	"BodyOnly"=>0,
	"Attachement"=>0,
	"StandAlone"=>0,
	"Cache"=>igk_sys_cache_require(),
	"CacheUri"=>0,
	"CacheUriLevel"=>0,
	"Depth"=>0,
	"Stop"=>0 //stop rendering
	));
	if ($o->Cache){
		$o->CacheUri = base64_decode(igk_sys_cache_uri());
		$o->CacheUriLevel = explode("/", $o->CacheUri);
	}
	return $o;
}

///<summary>convert an igk balafon xml node presentation to stdClass object</summary>
function igk_xml_to_obj($n, $arraycallback=null){
	$obj = igk_createObj();
	$nobj = function(){
		//c: current node object
		//obj: object list;
		return (object)array("c"=>null,'obj'=>null);
	};
	if ($n && igk_reflection_class_extends($n, IGK_HTML_ITEMBASE_CLASS)){

	$h = $nobj();
	$h->c = $n;
	$h->obj = $obj;
	$_vlist = array($h);
	$_clist = array(); //childs list key
	while(igk_count($_vlist)>0){
		$h = array_shift($_vlist);

		$n = $h->c;
		$cobj = $h->obj;

		//load attributes
		foreach($n->Attributes as $k=>$v){
			$cobj->$k = $v;
		}

		if ($n->HasChilds){
			$_clist = array();

			foreach($n->Childs as $k){
				$v_n = $k->TagName;
				if (empty($v_n))
				continue;
				$j = igk_createobj();
				if ($k->HasChilds){

					//$obj->$v_n
				// if(isset($_clist[$v_n])){
					// for mutiple entries on the same tag
				// }

					if (isset($cobj->$v_n )){
						//old php code
						$r = $cobj->$v_n;
						if (!is_array($r))
							$r = array($r);
						$cobj->$v_n = $r;
						//php7 code
						// if(!is_array($cobj->$v_n ))
							// $cobj->$v_n = array($cobj->$v_n);
						// $cobj->$v_n[] = $j;
					}
					else
						$cobj->$v_n = $j;
					$g = $nobj();
					$g->c = $k;
					$g->obj = $j;
					array_push($_vlist,$g);
					// igk_wln("push [".$v_n."]");
				}else{
					$g = $nobj();
					$g->c = $k;
					$g->obj = $j;
					array_push($_vlist,$g);

					if (!isset($cobj->$v_n)){
						$cobj->$v_n = $j;//$k->Content." - ";
					}
					else{
						$vh = $cobj->$v_n;
						if ($arraycallback){
							$vh = $arraycallback($v_n, $vh, $k->Content);
						}else{
							if (!is_array($vh)){
								$vh = array($vh);
							}
							$vh[] = $j;//k->Content;

							//for old
							// $vh = $cobj->$v_n;
							// $vh[] = $k->Content;
							// $cboj->$v_n = $vj;

							//php 7 writing code
							//$cobj->$v_n[] = $k->Content;

							//php 5 does not allow for reading $cobj->$v_n error . so for backward compatility

						}
						$cobj->$v_n = $vh;
					}
				}
			}
		}else {
			//igk_die("/!\\ have not child ", __FUNCTION__);
		}

	}

	}
	return $obj;
}
function igk_is_xmlNode($n){
	return is_object($n) && igk_reflection_class_extends($n, IGK_HTML_ITEMBASE_CLASS);
}

function igk_xml_create_to_node_setting(){
	return (object)array(
		"storeAttribAsNode"=>0,
		"handleArray"=>function($k,$v, $n, $setting=null){
			foreach($v as $sk=>$v){
				$nv = $n->addXmlNode($k);
				//$nv["xmlns:balafon"] = "http://child".igk_env_count("t");//"http://data/inc";
				igk_xml_to_node($v,$nv,$setting);
			}
			return 1;
		}
	);
}
///<summary>convert a object stdClass object to xml node</summary>
function igk_xml_to_node($obj, $name='objResult', $setting=null){
	$dobj = function (){
		return (object)array("obj"=>null,"node"=>null);
	};
	$tn = igk_is_xmlNode($name) ?$name: igk_createXmlNode($name);
	// $tn->Attributes->Set("xmlns",new IGKNSValue($tn, "http://www.igkdev.com"));//$ns); "http://www.igkdev.com");
	// $tn->Attributes->Set("xmlns:igk", "http://schemas.igkdev.com/xmlnode");
	$cobj = $dobj();
	$cobj->node = $tn;
	$cobj->obj = $obj;
	$tab = array($cobj);
	$setting = $setting ?? igk_xml_create_to_node_setting();
	$handleArray = $setting->handleArray;

	while(igk_count($tab)>0){
		$tobj = array_shift($tab);
		$obj = $tobj->obj;
		$n = $tobj->node;
		foreach($obj as $k=>$v){
			$a = is_array($v);
			if ($a || is_object($v)){
				if ($a && $handleArray($k, $v, $n,$setting))
					continue;

				$cobj = $dobj();
				$cobj->node = $n->addXmlNode($k);
				$cobj->obj= $v;
				array_push($tab, $cobj);
				// igk_wln("push object [". $k."]");
			}else{
				if ($setting->storeAttribAsNode)
					$n->addNode($k)->Content = $v;
				else
					$n[$k] = $v;
				//igk_wln("write ".$k);
			}
		}
	}
	return $tn;
}

///<summary></summary>
function igk_wln_ob_get($obj){
	
	IGKOb::Start();
	igk_wl($obj);
	$c = IGKOb::Content();
	IGKOb::Clear();
	return $c;
}
//------------------------------------------------------------------------
//global system functions
//------------------------------------------------------------------------
///<summary>get the system version. alias function of constant IGK_VERSION</summary>
function igk_sys_version(){return IGK_VERSION; }

function igk_sys_db_constant_cache(){
	return igk_io_baseDir(IGK_CACHE_FOLDER."/db/.db.constants.cache");
}

function igk_sys_create_app_setting(){
	$d = igk_createObj();
	$d->domainfileNotMaintain = 0;
	return $d;

}

function igk_sys_mod_rewrite_available(){

	$r  = igk_apache_module("mod_rewrite") || isset($_SERVER["IGK_REWRITE_MOD"]);
	if ($r)
		return true;
	//post uri to check

	// $f = igk_io_baseUri()."/sys_api/check_mod_rewrite";
	// $f = igk_io_baseDomainUri()."/sys_api/check_mod_rewrite";
	$f = igk_io_currentBaseDomainUri()."/sys_api/check_mod_rewrite";
	
	@session_write_close();
	
	$b = igk_curl_post_uri($f);

// igk_wln("check for mod rewrite : ".$b);
	if ($b){
		return 1;
	}
	// igk_wln("check for mod rewrite : ".$b);//. strlen(trim($b)));
	return 0;


}
///<summary>get the system author. alias function of constant IGK_AUTHOR</summary>
function igk_sys_author(){ return IGK_AUTHOR; }

///<summary>get if the system is on production mode</summary>
function igk_sys_env_production(){
	return defined('IGK_ENV_PRODUCTION') || (igk_getv($_SERVER, 'ENVIRONMENT') == "production");
}
///<summary>force enable production mode
function igk_sys_env_enable_production_mode(){
	$_SERVER["ENVIRONMENT"] = "production";
	igk_app()->Session->setParam("sys://env/production",1);
}
///<summary>get system configuration value</summary>
function igk_sys_getconfig($name, $defaultvalue=null){ //get system configs by name
	return igk_getv(igk_app()->getConfigs(),$name, $defaultvalue);
}

function igk_sys_srv_domain_name(){
	$psrv = igk_getv($_SERVER, "SERVER_NAME") ;
	$tab = null;
	if (preg_match_all("/(www\.)?(?<domain>(.)+)$/i", $psrv, $tab))
		return $tab["domain"][0];
	return null;
}
function igk_sys_srv_is_secure(){
	return isset($_SERVER["SSL_PROTOCOL"]) || igk_getv($_SERVER, "SERVER_PORT")==443;
}
function igk_sys_srv_uri_scheme($scheme='http'){
	$r = igk_getv($_SERVER, "REQUEST_SCHEME");
	if ($r)
		return $r;
	if (preg_match_all("/^(?<scheme>(.)+):\/\//i", igk_getv($_SERVER, "SCRIPT_URI"), $tab))
		return $tab["scheme"][0];
	return $scheme;

}
///<summary>shortcut to referer</summary>
function igk_sys_srv_referer(){
	return igk_getv($_SERVER, "HTTP_REFERER");
}

///<summar>check for no cache request</summary>
function igk_sys_srv_nocache_request(){
	///TODO: CHECK FOR NO CACHE REQUEST - firefox favicon view
	//
	//firefox caching request for the base Image favicon preview
	//
	// $is_firefox = strstr($_SERVER["HTTP_USER_AGENT"], "Firefox");
	// if ($is_firefox){
		// $g = (igk_getv($_SERVER, "HTTP_PRAGMA") == "no-cache") ||
				// (igk_getv($_SERVER, "HTTP_CACHE_CONTROL") == "no-cache");
			// return $g;

	// }
	return 0;
}




function igk_show_error_doc($doc=null, $code=404,$redirect=null, $message=null){


	if($redirect==null)
		$redirect = igk_getv($_SERVER, "REDIRECT_URL");
$error_ctrl = igk_getctrl(igk_sys_getconfig("error_ctrl"), false);
if ($error_ctrl && method_exists(get_class($error_ctrl) , "ViewError"))
{
	$error_ctrl->ViewError($code, $redirect);
	return;
}

$key = IGK_DOC_ERROR_ID;
$doc = igk_createNode("div");
$doc->setParam("id", $key);// IGKApp::getInstance()->Session->getParam($key);
$doc->addDiv()->addSectionTitle()->setClass("igk-danger")->Content = "/!\ ERROR";

$container = $doc->addDiv()->addContainer();


$t= $container->addRow()->addCol()->addDiv();
$t["class"] = "igk-notifybox igk-notifybox-danger";
$b = $t->add("blockquote");
$b["cite"]=igk_io_baseUri();
$b->addDiv()->Content = R::ngets("msg.error.requestedpagenotfount_1", $code  ." : " .$redirect. "");


// if (igk_is_debug()){
	// igk_render_trace();
// }

if (!empty($message)){
	$t= $container->addRow()->addCol()->addDiv();
	$t->Content = "Message : ".$message;
}
$container->addRow()->addCol()->addDiv()->addA(igk_io_baseUri())->Content = IGK_HOME_PAGEFOLDER;

// igk_render_trace();


//$t->add("div")->Content = $c;
// $doc->Title = R::ngets("title.error_1", igk_sys_getconfig("website_title"));
$opt = igk_xml_create_render_option();
$opt->Context = "mail";
$doc->RenderAJX($opt);
}

function igk_sys_show_error_doc($code, $defctrl=null, $callback=null){
// igk_die("d");
		$defctrl = $defctrl ? $defctrl : igk_get_defaultwebpagectrl();
		if ($defctrl){
			//if default ontroller manage system errorr
			$f = $defctrl->getViewFile("error_".$code);
			if (file_exists($f)){
				$defctrl->setCurrentView($f, true);
				igk_render_doc();
				$defctrl->setCurrentView(null, false);
				return;
			}
			else {
				$f = $defctrl->getViewFile("error");
				if (file_exists($f)){
					$defctrl->regSystemVars($code);
					$defctrl->setCurrentView("error", true);
					igk_render_doc();
					$defctrl->setCurrentView(null, false);
					return;
				}
			}
		}

		$doc =  igk_get_document("error_".$code, true);
		$doc->body["class"]  = "igk-error-body";
		switch($code){
			case 403: // system forbiden
			case 503: // redirection forbiden
			header("Status: 403");
			$doc->Title = "Forbiden - ".igk_getv($_SERVER, "REDIRECT_STATUS", igk_getr("code"))." ";
			$bbox = $doc->body->addBodyBox()->ClearChilds();
			$bbox->setClass("err-".$code);
			get_class($bbox->addHeaderBar("Forbiden"));
			$bbox->addDiv()->addSectionTitle()->setClass("igk-danger")->Content = "/!\\ Forbiden";
			//$bbox->addDiv()->addObData($_SERVER);
			$bbox->addDiv()->addNode("i")->Content = "You don't have permission to access ".igk_io_fullpath2fulluri($_SERVER["DOCUMENT_ROOT"].igk_io_request_uri());

			break;
			case 404:
			break;
			case 5404:
			igk_set_env("sys://error", $code);
			$doc->Title = "/!\\ Domain error - 5404 ";
			//$app->Doc->body->ClearChilds();
			$bbox = $doc->body->addBodyBox();
			$bbox->setClass("err-".$code);

			$bbox->addHeaderBar("SubDomainError",  igk_io_currentBaseDomainUri());
			//clear both floating for mail context
			$bbox->addDiv()->addDiv()->setStyle("clear:both");
			$bbox->addDiv()->addSectionTitle()->setClass("igk-danger")->Content =R::ngets("err.page.{$code}");
			//$bbox->addDiv()->addObData($_SERVER);
			$options[5404] = igk_io_subdomain_uri_name();
			$bbox->addDiv()->addNode("i")->Content = R::ngets("msg.page.{$code}_1", $options[$code]);
			$bbox->addDiv()->addObData(function(){
				$srv = "<div style='font-size:1.6em; padding:10px; background-color:#fefefe; border:1px solid :#ddd; color:#444;' >Server Info</div>";
				
				$srv.="<table>";
				foreach($_SERVER as $k=>$v){
					$srv.="<tr>";
					$srv.="<td>".$k;
					$srv.="</td>";
					$srv.="<td>".$v;
					$srv.="</td>";
					$srv.="</tr>";					
				}
				$srv.="</table>";
				
				igk_wln($srv);
			});
			break;
			case 504:
			break;
			case 901:
			header("Status: 403");
			$uri = $_SERVER["REQUEST_URI"];
			igk_elog("Failed to access a resources : {$uri}");
			if (igk_sys_env_production()){
				igk_navto_home(null);
			}
			igk_exit();
			break;
		}
		if ($callback)
			$callback($doc);
		$opt = igk_xml_create_render_option();
		$opt->Context = "html";
		$doc->RenderAJX($opt);
}


///<summary>include file in system configuration</summary>
function igk_sys_include($name){
	return include(igk_io_currentRelativePath($name));
}
///<summary>shortcut to get user ctrl</summary>
function igk_sys_get_user_ctrl(){
	return igk_getctrl(IGK_USER_CTRL);
}
function igk_sys_root_user($u){
	return igk_sys_get_user_ctrl()->getRootUser($u);
}
///<summary>require file in syst1m configuration</summary>
function igk_sys_require($name){
	require(igk_io_currentRelativePath($name));
}
///<summary>ignore lib folder
function igk_sys_lib_ignore($dir){
	$d = igk_get_env("sys://lib/ignoredir");
	if (!$d){
		$d = array();
	}
	$d[igk_io_dir($dir)]=1;
	igk_set_env("sys://lib/ignoredir",$d);
}

///<summary>cache library file</summary>
function igk_sys_cache_lib_files(){
	
	IGKControllerManagerObject::ClearCache();
	IGKApp::$LibFiles = array();
	$dirname = igk_io_baseDir();
	//reload controller
	$t_files = igk_load_env_files($dirname);
	igk_reglib($t_files);
	IGKApp::CacheLibFiles(true);
}

///<summary>get system directory presentation</summary>
function igk_io_dir($dir){
	$d = DIRECTORY_SEPARATOR;
	$r = '/';
	$out = IGK_STR_EMPTY;

	if (ord($d) == 92)
	{
		$out =preg_replace("/\//", '\\', $dir);
		$out = str_replace("\\\\", "\\", $out);
	}
	else{
		$out =preg_replace('/[\\\]/', '/', $dir);
		$out = str_replace("//", "/", $out);
	}
	return $out;
}
///<summary>shortcut to create new IGKHtmlRelativeUriValueAttribute</summary>
function igk_io_html_link($file){
	return new IGKHtmlRelativeUriValueAttribute($file);
}


///<summary>protect the full request uri</summary>
function igk_io_protect_request($uri){
	//force : request do base uri / if failed
	//$suri = igk_io_baseUri()."/Configs/";
	// igk_wln(igk_io_fullrequesturi());
	// igk_wln($suri);
	//e_xit;
	$uri = igk_str_rm_last($uri,"/");
	$buri = igk_str_rm_last(igk_io_fullrequesturi(),"/");
	if ($buri!==$uri){
		igk_navto($uri);
		igk_exit();
	}
}

///
function igk_io_protect_request_ajx($uri){
	if(igk_is_ajx_demand()){
			igk_createNode("script")->setContent(
		"window.location.href='{$uri}';"
		)->RenderAJX();
		igk_exit();
	}
}

///<summary>copy stream function</summary>
function igk_io_copy_stream($in, $out, $buffer=4096, $close=0){
	$size=0;	
	while(!feof($in)){		
		$size+= fwrite($out,fread($in, $buffer));
	}
	if ($close)
	{
		fclose($in);
		fclose($out);
	}
	return $size;
}

///<summary>store ajx uploaded data to folder</summary>
function igk_io_store_ajx_uploaded_data($folder, $fname=null){


	$tab = igk_get_allheaders();
	if ((igk_getv($tab, "IGK_UPLOADFILE", false) ==false) || !IGKIO::CreateDir($folder))
	{
		return false;
	}
	$fsize = igk_getv($tab, "IGK_UP_FILE_SIZE");
	$type = igk_getv($tab, "IGK_UP_FILE_TYPE","text/html");
	$fname = $fname ===null? igk_getv($tab, "IGK_FILE_NAME", "file.data") : $fname;
	$bfname = igk_io_basenamewithoutext($fname);
	$of = igk_io_dir( $folder."/".$fname);
	$v_gh = fopen("php://input","r");
	$v_wh = fopen($of,"w");
	if ($v_wh){
		// igk_ilog("copy stream | ".$v_gh . "  |  ".$v_wh);
		igk_io_copy_stream( $v_gh, $v_wh, 8192, 1);
		if(filesize($of)==$fsize){
			return $of;
		}
		unlink($of);
		return null;
	}else{
		// igk_ilog("failed to open :".$of);
		@fclose($v_gh);
	}
	return null;
}
///<summary>convert file to uri offline presentation </summary>
function igk_io_to_uri($f, $exist=1){
	if (file_exists($f) || !$exist){
		return "file:////".igk_html_uri(realpath($f));

	}
	return 0;
}

///<summary>get a list of include files that have a BOM header. testing functions</summary>
function igk_io_get_wbom_files(){
$i = 0;
$t = array();
foreach(get_included_files() as $k=>$v){
	if (filesize($v)<3)
		continue;
	//igk_wln($v);
	$txt = igk_io_read_allfile($v);//ff($v);

	if ((ord($txt[0]) === 239)&&
	(ord($txt[1]) === 187)&&
	(ord($txt[2]) === 191)
	)
	{
		$i++;
		$t[] = $v;
		igk_wln($v);
	}
}
return $t;
}
///<summary>get the full document uri</summary>
function igk_io_doc_root_request_uri(){
	return str_replace("//", "/",igk_html_uri($_SERVER["DOCUMENT_ROOT"].igk_io_request_uri()));
	//igk_html_uri(igk_getv($_SERVER, "DOCUMENT_ROOT").igk_getv($_SERVER, "REQUEST_URI"));
}

///<summary>get the fully request root request uri base on Document</summary>
function igk_io_rootRequestUri(){
	$o = "";
	if (igk_io_baseDirIsRoot()){
		$o= igk_io_baseUri().igk_io_request_uri();
	}else{
		// $navto = igk_io_doc_root_request_uri();
		// $navto .= "| ".igk_io_baseDir();
		$k = substr(igk_io_doc_root_request_uri(),strlen(igk_io_baseDir()));
		$o =igk_io_baseUri().$k;
	}
	return $o;
}

///<summary>return the current request uri according to IGK_APP_DIR</summary>
function igk_io_current_request_uri(){
	return substr(igk_io_doc_root_request_uri(), strlen(igk_io_baseDir()));
}
///<summary>alias to system SERVER : REQUEST_URI</summary>
function igk_io_request_uri(){
	return  igk_getv($_SERVER, "REQUEST_URI");
}
///<summary>get request uri entry according to base dir</summary>
///sample: request_uri /local.com/data/sample/param
///sample: script_name = /local.com/index.php
///output: /data/sample/
function igk_io_request_entry(){
	$b = igk_io_request_uri();
	$t = dirname(igk_getv($_SERVER, "SCRIPT_NAME") ?? igk_getv($_SERVER, "PHP_SELF"));
	$s = $b;
	if (strstr($b, $t)){
		$s = substr($b, strlen($t));
	}
	return $s;
	
}

///<summary>get application entry request uri</summary>
function igk_io_get_entry_uri($ctrl, $uri){
	
	$s = "";
	$appuri = $ctrl->getAppUri();
	$baseuri = igk_io_baseUri();
	$s = substr($appuri, strlen($baseuri));
	return $s;
}

///<summary>get request uri attached to base dir</summary>
function igk_io_base_request_uri(){
	$root = igk_getv($_SERVER, 'DOCUMENT_ROOT');
	$s = igk_html_uri($root.igk_io_request_uri());
	$bdir = igk_html_uri(igk_io_baseDir());
	$ln = strlen($bdir);
	while(($ln>0) && ($bdir[$ln-1]=="/")){
		$ln--;
	}
	$brequest = substr($s, $ln);
	return $brequest;
}

function igk_io_request_uri_path(){
	return igk_getv(parse_url(igk_io_request_uri()), "path");
}
///<summary>get current domain from uri</summary>
function igk_io_domain_uri_name($uri=null){
		$domain = $uri==null? igk_io_baseUri() : $uri;
		$domain = preg_replace_callback("#((http(s)?://)?(www\.)?){0,1}#i", function($tmatch){
			return "";
		}, $domain);
		return igk_getv(explode("/", $domain), 0);
}
///<summary> get the current subdomain from uri</summary>
///<remark> The subdomain name is independant of configured domain uri</remark>
function igk_io_subdomain_uri_name($uri=null){
	$domain = igk_io_domain_uri_name($uri);
	$bdom = IGKSubDomainManager::GetBaseDomain(); //as configured
	// igk_wln("domain : ".$domain . " ".IGKValidator::IsIpAddress($domain));
	//igk_wln("domain : ".$domain);
	if (($domain === $bdom) || IGKValidator::IsIpAddress($domain) || ($domain=="localhost"))
		return "";
	$tab = array();
	if (preg_match_all(IGK_SUBDOMAIN_URI_NAME_REGEX,  trim($domain), $tab))
		return igk_getv($tab["name"],0);
	return "";
}
function igk_io_is_subdomain_uri($uri=null){
	$s = igk_io_subdomain_uri_name($uri);
	return !empty($s);
}
///<summary>check if there is a controller that override uri pattern</summary>
function igk_io_is_ctrl_uri($uri=null, $file=1, & $data =null){
	$uri = $uri ?? "/".igk_io_baseRequestUri();
	if ($file && igk_io_is_file(igk_io_baseDir().$uri)){
		return 1;
	}
	$actionctrl = igk_getctrl(IGK_SYSACTION_CTRL);
	return (($data=$actionctrl->matche($uri))!==null);
}
function igk_io_is_file($f){
	return file_exists($f) && !is_dir($f);
}

///<summary> get if the current rendering system is on subdomain context.</summary>
function igk_sys_is_subdomain(){
	return IGKSubDomainManager::IsSubDomain();
}
///<summary> get the subdomain name</summary>
function igk_sys_subdomain_name(){
	return IGKSubDomainManager::GetSubDomainName();
}
///<summary>get current domain name according to configuration</summary>
function igk_sys_current_domain_name(){
	if (igk_sys_is_subdomain()){
		return igk_sys_subdomain_name().".".igk_sys_domain_name();
	}
	else{
		return igk_sys_domain_name();
	}
}
///<summary>get configured base domain</summary>
function igk_sys_domain_name(){
	return IGKSubDomainManager::GetBaseDomain();
}
///<summary>check if a controler is a domain controller and return the controller or false</summary>
function igk_sys_domain_control($ctrl){
	$h = IGKSubDomainManager::GetSubDomainName();
	if (!empty($h))
	{
		return IGKSubDomainManager::IsControl($h, $ctrl);
	}
	return false;
}
///<summary>shortcut to get subdomain ctrl</summary>
function igk_sys_get_subdomain_ctrl($uri){
	return IGKSubDomainManager::getInstance()->checkDomain($uri);
}
///<summary>include file: with params</summary>
///<param name='file'>full path </param>
function igk_include($file, $param=null){
	is_array($param)? extract($param) : null;
	if (file_exists($file)){
		include($file);
	}
}

function igk_init_include(){
	$functions = get_defined_functions()["user"];
	$classes = get_declared_classes();
	$source = igk_count($functions);
	$clcount = igk_count($classes);
	
	$t = array(
		"funcs"=>$source,
		"classes"=>$clcount
	);
	igk_set_env("sys://include/init", $t);
	return $t;
}
function igk_reset_include(){
	igk_set_env("sys://include/init", null);
}
function igk_update_include($f){
	$f = igk_io_dir($f);
	$t = igk_get_env("sys://include/init");
	$source = $t["funcs"];
	$clcount = $t["classes"];
	
	$functions2 = get_defined_functions();
	$classes2 = get_declared_classes();
	
	if (count($functions2["user"])> $source){			
		$ktab = array_slice($functions2["user"], $source);			
		igk_reg_func_files($f, $ktab);			
		$source+=igk_count($ktab);
	}		
	if (count($classes2)> $clcount){			
		$ktab = array_slice($classes2, $clcount);						
		igk_reg_class_file($f, $ktab);			
		$clcount+=igk_count($ktab);
	}
}
///<summary>include script in plugin lib</summary>
///<param name="file">mixed file or array </param>
///<param name="extra">preload script content </param>
///<param name="namespace">namespace to define</param>
function igk_include_script($file, $namespace=null, $extra=null){
	if (is_string($file) && !file_exists($file))
		return;
	$n ="";	
	$l = igk_get_env("sys://include/init") ?? igk_init_include();	
	$tab = $file;
	if (!is_array($file)){
		$tab = array($tab);
	}
	
	while($file =array_pop($tab)){	
	if ($namespace)
		$n = "namespace ".$namespace."; {$extra} ?>".igk_io_read_allfile($file);
	else
		$n="?>"."<?php return include(realpath('{$file}')); ?>";
	$o= eval($n);	
	igk_update_include($file);	
	}
	return $o;
}

///<summary>used to include a file base on the current file directory</summary>
function igk_sys_include_once($f){
	$d = igk_trace_function(2);
	$f = dirname($d->file)."/".basename($f);
	if (file_exists($f))
		include_once($f);
}



///<summary>get system debug zone controller</summary>
///<remark>only one at time</sumary>
function igk_sys_debugzone_ctrl()
{
	return igk_getctrl(igk_getv(igk_app()->getConfigs(), "debugHostCtrl", null), false);
}
function igk_sys_errorzone_ctrl(){
	return igk_getctrl(igk_getv(igk_app()->getConfigs(), "errorHostCtrl", null), false);
}

function igk_sys_shutdown_function($evt=null){
	// igk_ilog("base sys shutdown ".session_status(). " ".igk_io_request_uri());
	
	// igk_wln("shut down one" .igk_io_request_uri());
	// igk_wln("?check : ".igk_env_count_reset("igk_start_session"));
	//igk_set_env('igk_start_session', null);
	if (igk_get_env("sys://noshowlast_error")){
		return;
	}

	//ob_clean();
	$last = error_get_last();
	if (!$last){
		return;
	}

	$split_message = function($a) use($last){
		$t = explode("\n", $a);
		$n  = "<div>";
		$i=0;		
		foreach($t as $r){
			if (($i==0) && (strpos($r, "eval()") !== false)){
				//igk_wln("kjd");				
				//$n  .= "<div>". $r."</div>";
				//exit;
			}
			$n  .= "<div>". $r."</div>";
		
			$i=1;
		}
		$n  .= "</div>";
		return $n;
	};	
	// ob_end_clean();
	// exit;
	switch(igk_getv($last, 'type')){
			case E_PARSE:
			ob_end_clean();
			igk_header_no_cache();
			header("Status: 404 Error OnPage");
			$lastexp = igk_get_env(IGK_LAST_EVAL_KEY);
			if ($lastexp && igk_server_is_local()){
				$lastexp = "eval function failed to evaluate : <div><code>".htmlentities($lastexp)."</code></div>";
			}
			$title = "ParseError";
			$const = "constant";
			$lc = igk_get_env("sys://eval/lastscript");
			$min_css = igk_io_read_allfile(IGK_LIB_DIR."/Styles/min.error.css");
			$ast = igk_ob_get($last);
				$s = <<<EOF
<html>
	<head>
		<title>{$title} - {$const('IGK_PLATEFORM_NAME')}</title>
		<style type="text/css">{$min_css}</style>
	</head>
	<body>
		<div style="color: #eee; background-color:#C8503B; padding:25px 8px;">[{$const('IGK_PLATEFORM_NAME')}] : PARSE ERROR</div>
		<div >script try to evaluate an expression that is not recognized</div>
		<div ><quote>{$lastexp}</quote></div>
		<div>
		{$ast}
		</div>
		<div>the script : </div>
		<code> 
		{$lc}
		<code>
	</body>
</html>
EOF;
	echo $s;
				break;
			case E_ERROR:
				if (igk_is_cmd()){
					igk_wln("[".__FUNCTION__."] -- ERROR APPEND -- is cmd command ".igk_io_request_uri());
					@session_destroy();
					igk_wln(igk_show_trace());
				}else{
					if (ob_get_length()>0)
						@ob_clean();
					
					header("Status: 404 Error OnPage");
					header("Content-Type: text/html");
					$dv = "<body style='margin:0px;'><div>";
					$dv.= "<div style='font-size:2.1em; color:#fe8e5e; background-color:#C8503B; padding:10px 5px;' >/!\\ Error /!\\</div>";
					$dv.= "<div>";
					$dv.= igk_show_trace();
					$dv.="</div>";
					
					
					
					
					// $dv->addDiv()->addObData($last);
					$dv .="<div>";
					$cls = array("#ea9", "adf");
					$cli = 0;
					$cl ="";
					foreach($last as $k=>$v){
						if ($cli==0){
							$cli = 1;
						}else
							$cli = 0;
						$cl = $cls[$cli];
						$dv.= "<div style='font-size:0.8em'>";
						$dv.= "<div style='display:inline-block; color: #445884; float:left; width:20%;'>{$k}</div>";
						$dv.= "<div style='display:inline-block; float:left; width:70%; background-color:{$cl};' >";
						$dv.= ($k=="message"? $split_message($v) : $v);
						$dv.= "</div>";
						$dv.="<div style='clear:both;' ></div>";
						$dv.= "</div>";
					}
					$dv .="</div>";					
					if (igk_sys_env_production()){
						igk_mail_admin_send($dv);
					}else
						echo $dv;
				}


				break;
		default:
		break;
	}
	if (!defined("IGK_NODESTROY_ON_FATAL")){
		session_destroy();
	}
	//igk_exit();
}




///<summary>handle global error</summary>
function igk_sys_g_handle_error($severity, $message, $filename, $lineno){

	$logmsg = "severity:".$severity. " ".$message . " ".$filename.":".$lineno;
	if (!igk_sys_env_production()){
			if (strpos("mysqli::ping", $message)!== false){
				igk_wln($logmsg);
			}
		}else{
			igk_ilog($logmsg);
		}


		if ($severity != 2)
		{
			if (($severity==8) && igk_getv($_SERVER, "REQUEST_URI")=="/R/Styles/balafon.css.php"){
				return;
			}
			$s  =("/!\\");
			$s .=("severity :{$severity}").IGK_LF;
			$s .=("message :{$message}").IGK_LF;
			$s .=("filename :{$filename}").IGK_LF;
			$s .=("line :{$lineno}").IGK_LF;
			$s .=("request_uri :".igk_getv($_SERVER, "REQUEST_URI")."").IGK_LF;
			$s .=("query_string :".igk_getv($_SERVER, "QUERY_STRING")."").IGK_LF;
			if (strstr($filename, "eval()'d")){
				$s.="EvaluatedCode::[{$lineno}]:" .igk_get_env(IGK_LAST_EVAL_KEY). "";
				igk_get_env(IGK_LAST_EVAL_KEY);
			}
			if ($severity==4096)
				$s .=("EvalScript :".igk_get_env("sys://eval/lastscript")).IGK_LF;
			if (!igk_sys_env_production()){
				igk_ilog($s,  __FUNCTION__);			
			}
		}
		else{
			if (($severity > 2)&&( !igk_sys_env_production())){
				$o = "";
				$o .= "<div>";
				$o .= "<div>severity:".$severity."</div>";
				$o .= "<div>{$message}</div>";
				$o .= "<div><i>{$filename}</i>:{$lineno}</div>";
				$o .= "</div>";
				igk_wl($o);
			}
		}


}



//+fc: #register balafon shutdown function
register_shutdown_function("igk_sys_shutdown_function");
//#register balafon shutdown function
$g = set_error_handler('igk_sys_g_handle_error');
if (igk_const_defined("IGK_LOCAL_DEBUGGING")==1)
	igk_display_error(1);
unset($g); //disable g from global polution



///<summary>get that the current request is redirecting</summary>
function igk_sys_isredirecting(){
	return ((basename(igk_getv($_SERVER, "SCRIPT_NAME")) == "igk_redirection.php")
	&&
	(igk_getv($_SERVER, "REDIRECT_STATUS") == 200));
}


///<summary>used to get only available functions list</summary>
function igk_sys_getfunclist($ctrl, $news=false, $funcrequest=null){

	if ($ctrl==null || !igk_reflection_class_extends($ctrl, IGK_CTRL_BASE))
		return null;
		$func = array();
		$f = $ctrl->getDataDir()."/.funclist.xml";
		$cl = get_class($ctrl);
		$rlist = array();
		if (file_exists($f) && ($s = IGKHtmlReader::LoadFile($f)))
		{
			$r = igk_getv($s->getElementsByTagName("func-list"), 0);
			if ($r){
				foreach($r->Childs as $k=>$v){
					$n = $v["name"];
					if (empty($n) || !method_exists($cl, $n))
						continue;
					$rlist[$n] = $v;
					if ($v["available"]){
						$func[] = $n;
					}
				}
			}
			if ((($funcrequest!=null) && !isset($rlist[$funcrequest])) || $news && igk_is_conf_connected()){
				//$ctrl->_loadclass_method($cl, $func, $r, $rlist);
				igk_sys_load_class_method($cl, $func, $r, $rlist);
				igk_io_save_file_as_utf8($f, $s->Render());
			}
		}
		else{
			$d = new IGKXmlNode("func-list");
			//$ctrl->_loadclass_method($cl, $func, $d, $rlist);
			igk_sys_load_class_method($cl, $func, $d, $rlist);
			igk_io_save_file_as_utf8($f, $d->Render());
		}
		return $func;
}

function igk_sys_getall_funclist($ctrl)
{
	$funcs = array();
	if (!igk_is_conf_connected())
		return $funcs;


	$f = $ctrl->getDataDir()."/.funclist.xml";
	$cl = get_class($ctrl);
	$rlist = array();
	if (file_exists($f) && ($s = IGKHtmlReader::LoadFile($f)))
	{
		$r = igk_getv($s->getElementsByTagName("func-list"), 0);
		if ($r){
			foreach($r->Childs as $k=>$v){
				$n = $v["name"];
				if (empty($n) || !method_exists($cl, $n))
					continue;
					$o = array(IGK_FD_NAME=>$n, "clAvailable"=>0);
				if ($v["available"]){
					$o["clAvailable"] =1;
				}
				$funcs[$n] = (object)$o;
			}
		}
		// if ((($funcrequest!=null) && !isset($rlist[$funcrequest])) || $news && ){
			// $ctrl->_loadclass_method($cl, $func, $r, $rlist);
			// igk_sys_load_class_method($cl, $func, $r, $rlist);
			// igk_io_save_file_as_utf8($f, $s->Render());
		// }
	}
	return $funcs;
}

function igk_sys_gen_sitemap($ctrl, $domain="", $render=1){
	if (method_exists($ctrl, IGK_SITEMAP_FUNC)){
		$g = IGK_SITEMAP_FUNC;
		return $this->$g($domain, $render);
	}
	$n = igk_html_node_IGKSiteMap();
	$base = IGKValidator::IsUri($domain)? $domain."/" : igk_sys_srv_uri_scheme()."://".$domain."/";
	foreach(igk_io_getfiles($ctrl->getViewDir(), "/\.phtml$/i") as $k=>$v){
		$nn = igk_io_basenamewithoutext(basename($v));
		if (preg_match("/^([a-z0-9]+)$/i", $nn)){
			// igk_ilog($base.$nn);
			$n->lUri($base.$nn);
		}
	}
	$u = igk_io_baseUri(realpath(igk_io_basedir(IGK_LIB_DIR."/../sitemap/xml-sitemap.xsl")));
	// igk_wl("<?xml version=\"1.0\" standalone=\"0\" ? >");
	igk_wl("<?xml-stylesheet type='text/css' href='{$u}' ?>");
	$n->RenderXML();
}


function igk_sys_load_class_method($classname, & $func, $listnode, $rlist)
{
	$h = new ReflectionClass ($classname);
	$sf = $h->getFileName();
	foreach(get_class_methods($classname) as $k=>$v)
		{
			$refmethod = new ReflectionMethod($classname, $v);
			$n = $refmethod->getName();
			switch($n)
			{
				case "__construct":
					continue;
				default:
				$fname = $refmethod->getFileName();
				if (isset($rlist[$n]))
					continue;
				if ($refmethod->isPublic() && !$refmethod->isStatic() &&
					(($fname == $sf) ||
					IGKString::EndWith($refmethod->getName(), "_contract" )))
				{
					$func[] = $refmethod->getName();
					//$b->addDiv()->setContent($refmethod->getFileName());
					$listnode->add("function")
					->setAttribute("name",$refmethod->getName())
					->setAttribute("available", 1);//default active is 1
				}
				break;
			}
		}
}

///<summary>register a tool to a system engine</summary>
function igk_tool_reg($name, $prop){
	$r = igk_get_env(IGK_KEY_TOOLS);
	if ($r==null)
		$r = array();
	if (isset($r[$name])){

	}
	$r[$name] = $prop;

	igk_set_env(IGK_KEY_TOOLS, $r);
}
///<summary>call a tool action</summary>
function igk_tool_call($name, $args=null){
	if (empty($name))
		return false;
	$r = igk_get_env(IGK_KEY_TOOLS);
	if ($r==null)
	{
		igk_notifyctrl()->addWarningr("msg.noactionregister_1", $name);
		return false;
	}
	$p = (object)igk_getv($r, $name);
// igk_wln($p);
	if ($p && is_callable($p->Action)){
		$f = $p->Action;
		if ($args==null)
			return $f();
		else
			return call_user_func_array($f, is_array($args)? $args : array($args));
	}
	return false;
}
function igk_createloading_context($ctrl, $row=null){
	$t = array();
	if ($ctrl)
		$t["ctrl"] = $ctrl;
	if ($row)
		$t["row"] = $row;
	if (count($t)>0)
		return (object)$t;
	return null;
}


///<summary>create a dynamic object with the array data</summary>
function igk_create_dynamic($data){
	$m = new IGKDynamicObject();
	$m->initProperties($data);
	return $m;
}

function igk_get_defined_ns($node, & $s, $options){
	$attr = $node->Attributes;
	$g = $attr ? $attr->getNS() : null;
	if ($g){
		$b = 0;
		foreach($g as $k=>$v){
			if ($b)
				$s.=" ";
			if ($k=="@global")
				$s.= "xmlns";
			else
				$s.="xmlns:".$k;
			$b =1;
			$s.="=\"".$v."\"";
		}
	}
}

///<summary>extract root domain from uri</summary>
function igk_get_domain_name($n){
	//if (preg_match_all("/(\.)?(?P<domain>([^\. ]+)\.([^\. ]+))$/i", $n, $v)){
	if (preg_match_all("/((http(s)?:\/\/)?|(\.)?)?(?P<domain>([^\. \/]+)\.([^\. \/]+))(\/(.)+)?$/i", $n, $v)){
		return $v["domain"][0];
	}
	return IGK_STR_EMPTY;
}
function igk_get_domain($n){

	if (preg_match_all("/^((http(s)?:\/\/)|(\.))?(?P<domain>([^ \/]+)\.([^\. \/]+))(\/(.)+)?$/i", $n, $v)){
		return $v["domain"][0];
	}
	return IGK_STR_EMPTY;
}
function igk_is_domain_name($n){
	return (strtolower($n) == "localhost") ||  (igk_get_domain_name($n) === $n);
}

///<summary>get if the current request is a thumnail request</summary>
function igk_is_thumbnail_request(){
	return !isset($_SERVER["HTTP_COOKIE"]) && (igk_getv($_SERVER, "HTTP_CACHE_CONTROL")=="no-cache")
	&& (igk_getv($_SERVER, "HTTP_PRAGMA") == "no-cache");
}


///<summary>shorcut to create a balafon web node</summary>
function igk_createNode($tag="div", $attributes=null, $index=null){
	return IGKHtmlItem::CreateWebNode($tag, $attributes, $index);
}
///<summary>shorcut to create xml data</summary>
function igk_createXMLCData(){
	return new IGKXmlCDATA();
}

function igk_rm_balafonscriptfile_callback($n, $doc){
	$g = $doc->getParam("sys://igk/tempbalafonjs");
	unset($g[$n]);
	$doc->setParam("sys://igk/tempbalafonjs", $g);
}


//------------------------------------------------------------------------
// html utility functions
//------------------------------------------------------------------------

function igk_html_form_tokenid(){
	$cref  = igk_app()->Session->getCRef();
	return md5($cref);
}
function igk_html_form_is_valid_token($token){
	return igk_html_form_tokenid() == $token;
}
function igk_html_strip_comment($c){
	while(($t = strpos($c, "<!--")) !== false){
		$end = strpos($c, "-->");
		if ($end===false){
			$c = substr($c, 0, $t);
		}else{
			$c = substr($c, 0, $t).substr($c, $end+3);		
		}
	}
	return $c;
	
}

///<summary>push targetnode. in inclusion scenario required</summary>
function igk_html_pusht(& $t){
	igk_push_env("sys://push/targetnode", $t);
	return $t;
}
///<summary>used to pop the target node data</summary>
function igk_html_popt(& $t){
	$s = igk_pop_env("sys://push/targetnode");
	if ($s)
		$t = $s;
}
function igk_html_inlinedata($type, $content){
	return 'data:'.$type.";base64,".base64_encode($content);
}

function igk_html_hearachi($n, $level=-1, $mode="t", $callback=null){

	$q = array((object)array("node"=>$n,"level"=>0));
	$so = "";
	while($s = array_pop($q)){
		if (($level>0) && $s->level>$level)
			continue;

		// igk_wln("t : ".$s->node->TagName);

		$so .= str_repeat("\t",$s->level);
		$so .= get_class($s->node).":".($s->node->TagName ?? get_class($s->node));

		if ($callback){
			$callback($s->node, $so);
		}


		$so .="\n";
		//$s->node->Childs
		$ch = $s->node->Childs;
		$tab = $ch ? $ch->ToArray(): array();
		for($c = count($tab)-1 ; $c>=0; $c--){
			array_push($q, (object)array("node"=>$tab[$c],"level"=>$s->level+1));
		}
	}
	return $so;
}

function igk_html_query_parse($s){
	$ln = strlen($s);
	$pos = 0;
	$o = "";
	while( $ln>$pos){
		$ch = $s[$pos];
		switch($ch){

			case '`':
				$h = igk_str_read_brank($s, $pos, '`','`');
				$o .="<font color='#67009D'>".$h."</font>";
			break;
			case "'":
				$h = igk_str_read_brank($s, $pos, '\'','\'');
				$o .="<font color='#A90A07'>".$h."</font>";
				break;
			default:
				$o .= $ch;
			break;
		}


		$pos++;
	}
	return $o;
}

function igk_html_add_doc_script($doc, $file, $temp=0){
	$g = $doc->getParam("sys://igk/tempbalafonjs", array());
	$host = $doc->getParam("sys://igk/tempbalafonjs/node", function() use($doc){
		$b = igk_createNode("NoTagNode");
		$doc->head->add($b);
		$doc->setParam("sys://igk/tempbalafonjs/node", $b);
		return $b;
	}
	);
	$b = null;
	if (isset($g[$file])){
		$b = $g[$file];
	}
	else if (file_exists($file)){
		$b = igk_createNode("script");
		if ($temp){
			$host->add(new IGKHtmlSingleNodeViewer($b, igk_create_func_callback("igk_rm_balafonscriptfile_callback", array("file"=>$file, "doc"=>$doc))));
		}
		else{
			$host->add($b);
		}
		$g[$file] = $b;
	}

	if ($b){
		$b->Content = igk_io_read_allfile($file);//update
	}
	$doc->setParam("sys://igk/tempbalafonjs", $g);
}

function igk_html_add_balafonjsscriptfile($doc, $file, $temp=0){
	$g = $doc->getParam("sys://igk/tempbalafonjs", array());
	$host = $doc->getParam("sys://igk/tempbalafonjs/node", function() use($doc){
		$b = igk_createNode("NoTagNode");
		$doc->add($b);
		$doc->setParam("sys://igk/tempbalafonjs/node", $b);
		return $b;
	}
	);
	$b = null;
	// igk_ilog($file);
	if (isset($g[$file])){
		$b = $g[$file];
	}
	else if (file_exists($file)){
		$b = igk_createNode("balafonJS");
		if ($temp){
			$host->add(new IGKHtmlSingleNodeViewer($b, igk_create_func_callback("igk_rm_balafonscriptfile_callback", array("file"=>$file, "doc"=>$doc))));
		}
		else{
			$host->add($b);
		}
		$g[$file] = $b;
	}

	if ($b){
		$b->Content = igk_io_read_allfile($file);//update
	}
	$doc->setParam("sys://igk/tempbalafonjs", $g);
}



///<summary>create text node</summary>
function igk_html_node_text($txt=null){
	$n = new IGKHtmlText($txt);
	return $n;
}
///<summary>convert string litteral to string html text presentation<summary>
function igk_html_from_string($str,$block="p"){
	$tstr = explode("\n", $str);
	$t= igk_createNode("div");
	foreach($tstr as $k=>$v){
		$g = trim($v);
		if (empty($g)){
			$t->addBr();
		}else
		$t->add($block)->setContent(trim($v));
	}
	return $t->Render();

}

///<summary>get the base of the creation node</summary>
function igk_html_parent_node(){
	$p = igk_get_env(IGK_XML_CREATOR_PARENT_KEY);
	if (($c = igk_count($p))>0){
		return $p[$c-1];
	}
	return null;
}
///<summary>store the creator node parent</summary>
function igk_html_push_node_parent($n){
	$p = igk_get_env(IGK_XML_CREATOR_PARENT_KEY);
	if ($p==null){
		$p = array();
	}
	array_push($p, $n);
	igk_set_env(IGK_XML_CREATOR_PARENT_KEY, $p);
}
function igk_html_pop_node_parent(){
	$p = igk_get_env(IGK_XML_CREATOR_PARENT_KEY);
	if ($p!=null){
	array_pop($p);
	igk_set_env(IGK_XML_CREATOR_PARENT_KEY, $p);
	}
}


function igk_html_node_ConfigSubMenu($menuList, $selected){

	$ul = igk_createNode("ul")->setClass("igk-cnf-content_submenu");
	foreach($menuList as $k=>$v)
	{
		$li = $ul->addLi();
		$li->add("a", array("href"=>$v))->Content = R::ngets("cl".$k);
		if ($selected == $k)
		{
			$li["class"] = "+igk-cnf-content_submenu_selected";
		}
		else{
			$li["class"] = "-igk-cnf-content_submenu_selected";
		}
	}
	return $ul;
}

///<summary>return the sub created documents attached to system</summary>
function igk_get_documents(){
	return igk_app()->Session->getParam(IGK_KEY_DOCUMENTS);
}
function igk_free_document($k){
	$v = igk_app()->Session->getParam(IGK_KEY_DOCUMENTS);

	if (is_object($k)){
		$k->Dispose();
		$k = $k->getParam(IGK_DOC_ID_PARAM);
	}
	if ($v){
		$doc = igk_getv($v, $k);
		if ($doc){
			unset($v[$k]);
			$app->Session->setParam(IGK_KEY_DOCUMENTS, $v);
		}
	}
}
///<summary>get the document</summary>
///<param name="key">key to register document </param>
function igk_get_document($key, $clear=false, $init=false){
	if (!IGKApp::IsInit() || (is_string($key) && empty($key)) || ($key==null) )
		return null;
	$k = $key;
	$_obj = is_object($k);
	$doc=null;
	if ($_obj )
		$k = $k->getName();
	$app = igk_app();

	$v = $app->Session->getParam(IGK_KEY_DOCUMENTS);
	$doc= igk_getv($v, $k);
	if ($doc === null){
		//create  a new document
		$doc = new IGKHtmlDoc($app, __FUNCTION__);
		$doc->setParam(IGK_DOC_ID_PARAM, $key);//IGKCONTROLLER::app_test
		if ($v === null){
			$v = array($k=>$doc);
		}
		else{
			$v[$k] = $doc;
			if ($doc=== $app->getDoc()){
				igk_ilog("2. your new document is equal to global document some error behaviour");
				igk_die("strange behaviour . not valid");
			}
		}

		$app->Session->setParam(IGK_KEY_DOCUMENTS, $v);
	}
	if ($doc && $clear){
		$doc->Body->BodyBox->ClearChilds();
	}
	//init document
	if ($_obj && $init && method_exists($key , 'initDocument')){
		$key->initDocument($doc);
	}
	return $doc;
}


///<summary>unset document</summary>
function igk_unset_document($doc){
	//unset document
	$tab = igk_app()->Session->getParam(IGK_KEY_DOCUMENTS);
	$key = $doc->getParam(IGK_DOC_ID_PARAM);
	if (isset($tab[$key])){
		unset($tab[$key]);
		igk_app()->Session->setParam(IGK_KEY_DOCUMENTS, $tab);
	}
	$doc->Dispose();
}

// function igk_createDocument($name){
	// igk_wln(__FUNCTION__.":::not implements");
	// igk_die(__FUNCTION__." not implements");
	// igk_exit();
	// $app = igk_app();
	// $v = $app->Session->getParam(IGK_KEY_DOCUMENTS);
	// $doc=  igk_getv($v, $name);
	// if ($doc ==null){
		// $doc = new IGKHtmlDoc($app, true);
		// if ($v ==null){
			// $v = array($name=>$doc);
		// }
		// else{
			// $v[$name] = $doc;
		// }
		// $app->Session->setParam(IGK_KEY_DOCUMENTS, $v);
	// }else{
		// //dispose and create new one
		// $doc->Dispose();
		// $doc = new IGKHtmlDoc($app, true);
		// $v[$name] = $doc;
		// $app->Session->setParam(IGK_KEY_DOCUMENTS, $v);
	// }
	// $doc->setParam(IGK_DOC_ID_PARAM, $name);
	// return $doc;

// }

///<summary>create an article node</summary>
function igk_createArticleNode($ctrl, $article, $row){
	$n = igk_createNode("div");
	igk_add_article($ctrl, $article, $n);
	return $n;
}

function igk_createFormInput($name, $attributes=null, $index=null){
	$d = igk_createNode();
	$d["class"]="igk-form-group";
	$f = $d->addSLabelInput($name, 'text');
	if ($attributes)
		$f->input->setAttributes($attributes);
	return $d;
}
function igk_createSelectInput($name, $options, $selected=null, $callback=null){
	$d = igk_createNode();
	$d["class"]="igk-form-group";
	$f = $d->addLabel($name);//addSLabelInput($name, 'text');
	$sl = $d->add("select");
	$sl["class"]="igk-form-control";
	if ($options){
		foreach($options as $k=>$v){
			$opt = $sl->add("option");
			$opt["value"] = $k;
			$opt->Content = $callback? $callback($v) : $v;
			if ($k==$selected){
				$opt["selected"] = "true";
			}
		}
	}
	return $d;
}

///<summary> shortcut to IGKOwnViewCtrl::Contains </summary>
function igk_own_view_ctrl($ctrl){
	return IGKOwnViewCtrl::Contains($ctrl);
}
///<summary> return an array of controller that possessed this rendering</summary>
function igk_own_view_list(){
	return IGKOwnViewCtrl::GetList();
}

///<summary>create a new system user</summary>
function igk_sys_create_user($userdata,
 $usertable=IGK_TB_USERS,//table from
 $authtable=IGK_TB_AUTHORISATIONS, //authorization list table
 $grouptable=IGK_TB_GROUPS, //groups list
 $groupauth=IGK_TB_GROUPAUTHS,//group association table,
 $usergrouptable=IGK_TB_USERGROUPS
 )
{
	$b = new IGKUserInfo();
	$bkey = $b->getDbInfoKey();//"sys://db/info";
	$b->loadData($userdata);
	$b->$bkey = (object)array();
	$b->$bkey->authtable = $authtable;
	$b->$bkey->grouptable = $grouptable;
	$b->$bkey->groupauthtable = $groupauth;
	$b->$bkey->usertable = $usertable;
	$b->$bkey->usergrouptable = $usergrouptable;
	return $b;
}
///<summary>get if present user have the right to do an "authname" </summary>
function igk_sys_isuser_authorize($u, $authname, $authCtrl=null,$adapter=  IGK_MYSQL_DATAADAPTER){
	// igk_wln("is auth to ....".$u->clLogin);
	if (method_exists($u, "IsAuthorize")){

		return $u->IsAuthorize($authname, $authCtrl,$adapter);
	}
	$v_uinfo = igk_sys_create_user($u);
	return IGKUserInfo::GetIsAuthorize($v_uinfo,$authname, $authCtrl, $adapter);
}
///<summary>system shortcut to current user authorisation</summary>
function igk_sys_authorize($authname, $authCtrl=null){
	if (igk_is_conf_connected())
		return true;
	$u = igk_app()->Session->User;
	if ($u){
		return igk_sys_isuser_authorize($u,$authname, $authCtrl);
	}
	return false;
}


function igk_sys_register_user($u, $gooduri=null, $baduri=null, $listener=null){
	$uc = igk_getctrl(IGK_USER_CTRL);
	$tb = IGK_TB_USERS;
	$r = igk_db_create_row($tb, $u);

	if (empty($r->clLogin)){
		igk_set_error(__FUNCTION__, "login is empty");
		return 0;
	}
	if (!igk_user_pwd_required($u->clPwd, $u->clRePwd)){
		igk_set_error(__FUNCTION__, "passwd not match balafon requirement");
		return 0;
	}

	$i = igk_db_insert_if_not_exists($uc, $tb, $r);

	if ($i){
		$usr = igk_get_user_bylogin($r->clLogin);
		$info = "u=".$usr->clLogin."&d=".date("y-m-d")."$gooduri=".$gooduri;
		$info .= "&redirect=".$gooduri."&baduri=".$baduri;
		if ($listener){
			$listener($usr, igk_io_baseUri()."/".$uc->getUri("us_activate&q=".base64_encode($info)));
			return 1;
		}
	}
	igk_ilog("failed to register");
	igk_set_error(__FUNCTION__, "failed to register user to database");
	igk_notifyctrl()->addErrorr("e.registrationnotpossible");
	return $i;

}

///<summary>get uri action pattern info</summary>
function igk_sys_ac_getpatterninfo(){//get current uri action pattern info
	return igk_getctrl(IGK_SYSACTION_CTRL)->getPatternInfo();
}
function igk_sys_ac_getpattern($basePatternUri){
	return igk_pattern_matcher_get_pattern($basePatternUri);
}
///<summary>use to register action</summary>
function igk_sys_ac_register($uriPattern, $uri){
	igk_getctrl(IGK_SYSACTION_CTRL)->sys_ac_register($uriPattern, $uri);
}
///<summary>use to unregister uri action</summary>
function igk_sys_ac_unregister($uriPattern){
	igk_getctrl(IGK_SYSACTION_CTRL)->sys_ac_unregister($uriPattern);
}
///<summary>create uri system pattern info</summary>
function igk_sys_ac_create_pattern($ctrl, $uri, $methodpattern=IGK_REG_ACTION_METH){
		$k = $methodpattern ;
		$pattern = igk_sys_ac_getpattern($k);
		$keys = igk_str_get_pattern_keys($k);
		$page = $uri;
		$e = new IGKSystemUriActionPatternInfo( array(
				"action"=>$k,//global action uri method function:param
				"value"=>$uri,//$ctrl->getRegInvokeUri(),
				"pattern"=>$pattern, //match pattern
				"uri"=> $page, //default uri
				"keys"=> $keys, //uri keys
				"ctrl"=>$ctrl,//the controller for this request
				"requestparams"=>null //no request param
				));
		return $e;
}

///<summary> get a new powerd node block to add to body</summary>
function igk_sys_powered_node(){
	$d =  igk_createNode("div");
	$d["class"]="igk-powered";
	$s = igk_app()->Configs->powered_message;
	$d->Content = !empty($s) ? $s : "Powered by <a href=\"".IGK_WEB_SITE."\" >IGKDEV</a> ";
	//$d->addScript()->Content = "if (window.igk)window.igk.initpowered();";
	return $d;
}

///<summary>register a display setting</summary>
///<param name="expression">callback expression</summary>
function igk_sys_reg_display($keyTab, $expression){
	igk_set_env("sys://tabdisplay/".$keyTab, $expression);
}
///<summary>call this func to render a display object. other way for toString class method</summary>
function igk_display($obj, $keyTab=null){
	if ($keyTab){
		$c = igk_get_env("sys://tabdisplay/".$keyTab);
		if ($c){
			if (is_callable($c)){
				return $c($obj);
			}
			else{
				igk_wln("no display bind");
			}
		}
	}
	if (isset($obj->clName) )
		return $obj->clName;
	if (isset($obj->clId) )
	return $obj->clId;

}
//------------------------------------------------------------------------
//global utility functions
//------------------------------------------------------------------------

///<summary>append log to file</summary>
function igk_log_append($file, $msg, $tag=null){
	$s = date("h:i:s") ;
	if (!is_string($msg)){
		$msg = igk_ob_get($msg);
	}

	if ($tag){
		$s .= " - [{$tag}] - ";
	}
	else
		$s .= " - [ SYSLOG ] - ";
	$s.= $msg."\r\n";

	if (!file_exists($file))
	{
		igk_io_save_file_as_utf8_wbom($file, $s, true);
	}
	else {
		$r = fopen($file, "a+");
		fwrite($r, $s);
		fclose($r);
	}
}
function igk_log_enabled(){
	return igk_const_defined("IGK_WRITE_LOG") || IGKServerInfo::IsLocal();
}
//log function
function igk_log_write($msg)
{
	if (!igk_log_enabled())
		return;
	$s = igk_getctrl(IGK_LOG_CTRL);
	if ($s){
		$s->write($msg);
	}
}
function igk_log_write_i_data($tag, $data)
{
	if (!igk_log_enabled())
		return;
	$s = igk_getctrl(IGK_LOG_CTRL);
	if ($s){
		$s->write_i_data($tag, $data);
	}
	else{
		IGKLog::getInstance()->write_i_data($tag, $data);
	}

}
function igk_log_write_i($tag, $msg)
{
	if (!igk_log_enabled())
		return;
	$s = igk_getctrl(IGK_LOG_CTRL);
	if ($s){
		$s->write_i($tag, $msg);
	}
	else{
		IGKLog::getInstance()->write_i($tag, $msg);
	}
}

///<summary>shurtcut to igk_log_append</summary>
function igk_log($msg, $file, $tag=null){
	igk_log_append($file, $msg,$tag);
}
function igk_ilog_file(){

	$f = "";
	if (defined("IGK_LOG_FILE"))
		$f = IGK_LOG_FILE;
	else
		$f = igk_io_dir(IGK_LIB_DIR."/../../Data/Logs/.global.log");
	return $f;
}
function igk_ilog_clear(){
	$logfile = igk_ilog_file();
	igk_io_w2file($logfile, "", true);
}
///<summary>write log to IGK_LOG_FILE</summary>
function igk_ilog($msg,$tag=null){

	if (is_array($msg)){
		$msg = igk_ob_get($msg);
	}
	$f = "";
	if (defined("IGK_LOG_FILE"))
		$f = IGK_LOG_FILE;
	else
		$f = igk_io_dir(IGK_LIB_DIR."/../../Data/Logs/.global.log");

	igk_log_append($f, $msg, $tag);
}
function igk_ilog_assert($cond, $msg, $tag=null){
	if ($cond){
		igk_ilog($msg, $tag);
	}
}

///<summary>write error log</summary>
function igk_elog($msg, $tag=null){
	$f = "";
	if (defined("IGK_LOG_ERROR_FILE"))
		$f = IGK_LOG_ERROR_FILE;
	else
		$f = igk_io_baseDir()."/Data/Logs/.error.log";
	igk_log($msg, $f, $tag);
}

///<summary>used to bind attribuyte to type</summary>
///<exemple>bind attribute</exemple>
function igk_bind_attribute($type, $name, $attribute, $allowmultiple=true, $inherits=false){
	switch($type)
	{
		case "class":
			IGKAttribute::Register($name, $attribute,$allowmultiple, $inherits);
			break;
		case "method":
			break;
	}
}




//-------------------------------------------------------------------------------------------------
//User Global functions
//-------------------------------------------------------------------------------------------------
///<summary>user fonctions . get fullname </summary>
function igk_user_fullname($u)
{
	return igk_getv($u, "clFirstName")." ".igk_getv($u, "clLastName");
}
function igk_user(){
	return igk_app()->Session->User;
}
///<summary>check if password require ok</summary>
function igk_user_pwd_required($pwd, $repwd){
	if (!$pwd || !$repwd || ($pwd!= $repwd)){
		return false;
	}

	//match system pwdwd confirm
	return IGKValidator::IsValidPwd($pwd);
}

function igk_user_store_tokenid($u){
	$id = igk_create_cref();
	setcookie(igk_get_cookie_name(igk_sys_domain_name()."/uid"), $u->clId.":".$id, time() + (86400 * 7), igk_get_cookie_path());
	igk_user_set_info("TOKENID", $id, 1,1);
	$u->clTokenStored = 1;
}
function igk_get_user($uid){
	$db=  igk_getctrl(IGK_USER_CTRL)->Db;
	$db->connect();
	$t = $db->select(IGK_TB_USERS, array("clId"=>$uid))->getRowAtIndex(0);
	$db->close();
	return $t;
}
function igk_get_user_bylogin($login){
	$db = igk_getctrl(IGK_USER_CTRL)->Db;
	if (!$db->connect())return null;
	$u = igk_getctrl(IGK_USER_CTRL)->Db->select(IGK_TB_USERS, array("clLogin"=>$login))->getRowAtIndex(0);
	$db->close();
	return $u;
}
function  igk_get_system_user(){
	return igk_get_user_bylogin("igk.system@igkdev.com") ?? igk_die("no system user found");
}
function igk_user_connectAs($login){
	$u = igk_get_user_bylogin($login);
	if ($u){
		igk_getctrl(IGK_USER_CTRL)->setGlobalUser($u);
		return 1;
	}
	return 0;
}
///<summary>set environment param to users</summary>
function igk_user_set_env_param($u, $pn, $obj){
	if ($u===null)
		return 0;
	$k =  IGK_ENV_PARAM_KEY;
	$tab = igk_getv($u, $k);
	if ($tab == null)
		$tab = array();
	$tab[$pn] = $obj;
	$u->$k = $tab;
	return 1;
}

function igk_user_get_env_param($u){
	$k =  IGK_ENV_PARAM_KEY;
	return igk_getv($u, $k);

}
function igk_user_add_info_type($name, $datatype, $cardinality, $type){
	$ctrl = igk_getctrl(IGK_SYSDB_CTRL);
	$v_ktt = array(IGK_FD_NAME=>$name,
	"clDataType"=>$datatype,
	"clCardinality"=>$cardinality,
	"clType"=>$type);
	return igk_db_insert_if_not_exists($ctrl, IGK_TB_USER_INFO_TYPES, $v_ktt);
}
///<summary> get user information</summary>
///<param name="cardinality"> 0 for infinite value, or more than 0</param>
///<param name="type"> 1 for regex, 2 for data type</param>
///<param name="expression"> regex or data type</param>
///<return> single value or array of values if found</return>
///<remark> in case of new data to insert cardinality type and expression must be setup . system must init user setting info to register data</remark>
function igk_user_set_info($inf,  $data, $uid=null, $cardinality=0, $type=1, $expression="(.)+"){
	$u = $uid==null? igk_app()->Session->User : igk_get_user($uid);
	$ei = igk_get_env("sys://db_init"); //enviroment init
	// igk_wln("ini ::: ".$ei);
	if(!$ei && ($u == null)){
		return null;
	}

	//check and insert new value type
	$ctrl = igk_getctrl(IGK_SYSDB_CTRL);
	$v = igk_db_table_select_where(IGK_TB_USER_INFO_TYPES, array(IGK_FD_NAME=>$inf), $ctrl);
	$r = null;
	if (($v==null)||($v->RowCount==0))
	{
		if ($ei==1){
			$tab = $ctrl->getInfoDataEntry($inf, $cardinality, $type, $expression);
			if (igk_db_insert($ctrl, IGK_TB_USER_INFO_TYPES, $tab)){

				$v = igk_db_table_select_where(IGK_TB_USER_INFO_TYPES, array(IGK_FD_NAME=>$inf), $ctrl);
				$r = $v->getRowAtIndex(0);
			}

		}
	}
	else{
		$r = $v->getRowAtIndex(0);
	}

	if ($u==null)
		return null;
	$insert = true;
	if ($r == null)
		return null;
		$v_n = $r->clCardinality;
		$v_kkt=array("clUserInfoType_Id"=>$r->clId, "clUser_Id"=>$u->clId);
		$v_q = igk_db_table_select_where(IGK_TB_USER_INFOS, $v_kkt);
		$v_kkt["clValue"]= $data;
		// igk_wln("cardinality .".$v_n);
		// igk_wln($r);

		switch($r->clType)
		{
			case 1:
			//igk_wln("try match expression");
			//validate the data
			if (!empty($r->clDataType))
			{
				if (!preg_match("/".$r->clDataType."/i", $data)){
					igk_log_write_i(__FUNCTION__,"Data not match ".$data);
					return false;
				}
			}
			break;
			case 0: //data base
				if (!is_numeric($data)
				|| empty($r->clDataType) //data is empty can't select row
				||
					//select data from table name
					(igk_db_table_select_where($r->clDataType, array(IGK_FD_ID=>$data) , $ctrl)->RowCount == 0))
					{
					igk_wln(__FUNCTION__.": Not valid data [{$r->clDataType}] : $data");
					igk_wln($r);
					return false;
					}
					else{
						igk_debug_wln("valid data");
					}

			break;
		}

		switch($v_n)
		{
			case 0:
				//return a array of data
				break;
			case 1:
				if ($v_q->RowCount > 0){
					if ($v_q->RowCount==1){
						$r = $v_q->getRowAtIndex(0);
						$r->clValue = $data;
						igk_db_update($ctrl, IGK_TB_USER_INFOS, $r);
						return true;
					}
					else
						igk_log_write_i(__FUNCTION__,"DataBaseStructure Error : data will not be inserted");
					return false;
				}
				break;
			break;
			default:
				if ($v_n < 0){
					igk_die("error on data cardinality ".$n);
				}
				if (!($v_n< $v_q->RowCount)){
					return false;
				}
			break;
		}

	if ($insert)
	{
		return igk_db_insert_if_not_exists($ctrl, IGK_TB_USER_INFOS, $v_kkt, $v_kkt);
	}
	return false;
}
function igk_user_info($inf ,$uid=null){
$u = $uid==null? igk_app()->Session->User : igk_get_user($uid);

	if($u == null)
		return null;
	$ctrl = igk_getctrl(IGK_SYSDB_CTRL);
	$v = igk_db_table_select_where(IGK_TB_USER_INFO_TYPES, array(IGK_FD_NAME=>$inf), $ctrl);

	$r = null;
	if ($v!=null){
		$r = $v->getRowAtIndex(0);
	if ($r == null)
		return null;

		$v_n = $r->clCardinality;
		$v_q = igk_db_table_select_where(IGK_TB_USER_INFOS, array("clUserInfoType_Id"=>$r->clId, "clUser_Id"=>$u->clId), $ctrl);
		switch($v_n)
		{
			case 0:
			//return a array of data
				$tab = array();
				foreach($v_q->Rows as $k=>$v){
					$tab[] = igk_user_build_info($r, $inf, $v,$ctrl);
				}
				return $tab;
			break;
			case 1:
				if ($v_q->RowCount > 0){
					$v = $v_q->getRowAtIndex(0);
					return  igk_user_build_info($r, $inf, $v,$ctrl);
				}
				return null;
			break;
			default:
				if ($v_n < 0){
					igk_die("error on data cardinality ".$n);
				}
				$v_tk = min($v_n, $v_q->RowCount);
				$tab = array();
				foreach($v_q->Rows as $k=>$v){
					$tab[] = igk_user_build_info($r, $inf, $v,$ctrl);
					$v_tk--;
					if ($v_tk<=0)
						break;
				}
				return $tab;
			break;
		}
	}
	return "no";
}
function igk_user_build_info($r, $inf, $v, $ctrl){

return  (object)array(
		"clName"=>$inf,
		"clDescription"=>$v->clDescription,
		"clValue"=>	($r->clType == 0)?	igk_db_table_select_where($r->clDataType, array(IGK_FD_ID=>$v->clValue), $ctrl)->getRowAtIndex(0) :
			$v->clValue
		);

}

///<summary>get the current uri </summary>
function igk_uri_rquery(){
	return igk_getv($_SERVER, 'REQUEST_QUERY');
}
function igk_uri_add_args($u, $args=null){
	$u = parse_url($u);
	$q = $args?  http_build_query($args) : null;
	$o = $u["path"];
	if (isset($u["query"]))
		$o .= "?".$u["query"].($q?"&".$q:null);
	else if (!empty($q)){
		$o.= "?".$q;
	}
	return $o;


}
///<summary>check is uri match by ignoring the case</summary>
function igk_uri_is_match($u1, $u2){
	return strtolower($u1) == strtolower($u2);
}
function igk_uri_invokeCurrent($qparam=null){
	$curi =igk_io_baseUri( igk_io_get_relative_currenturi()).$qparam;
	$f = igk_post_uri($curi, null);
	return $f;

}
function igk_web_prefix(){//used to get the web page config website_prefix
	return igk_app()->Configs->website_prefix;
}
function igk_web_defaultpage(){
	return igk_getv(igk_app()->Configs, "menu_defaultPage", "default");
}
///<summary>shortcut to platform config</summary>
function igk_web_get_config($name, $default=null){//get the plateform config
	return igk_getv(igk_app()->Configs, $name, $default);
}



function igk_new_response()
{
	return new IGKHtmlResponse();
}
///<summary>show an alert to document information </summary>
///<remark>document must be fully loaded. can be uses at the InitComplete </remark>
function igk_alert($mgs)
{
	$frame = igk_add_new_frame(igk_getctrl(IGK_FRAME_CTRL), "alert_frame");
	$frame->Title = R::ngets("title.alert");
	$frame->BoxContent->ClearChilds();
	$frm = $frame->BoxContent->addForm();
	$frm->addDiv()->Content = $msg;
}

function igk_can_set_ctrlparent($ctrl, $parentName){//detect if a ctrl can be a child of $parentName
	$p = igk_getctrl($parentName ,false);
	while($p)
	{
		if (($p == $ctrl) || (!$p->CanAddChild))
			return false;
		$p = $p->getWebParentCtrl();
	}
	return true;
}

///<summary>get registrated display key</summay>
function igk_r_getdisplay($key, $param=null){
	return R::ngets($key, $param)->getValue();
}


//get regex from pattern
function igk_regex_get($pattern , $key, $value, $index = 0)
{
	$t = array();
	$c = preg_match_all($pattern, $value,$t);

	if ($c>0)
	{
		if ($c==1){
		return $t[$key][0];
		}
		else{
			return $t[$index][$key];
		}
	}
	return null;
}
///<summary>
///used to parse string value to compatible xml value.
///</summary>
function igk_parsexmlvalue($value, $isvalue=false, $isandroidres=false)
{

	$value =  preg_replace_callback("/(?<value>('|([&]((quot);)*)))/i", function($tmatch) use ($isvalue, $isandroidres){
		switch($tmatch["value"])
		{
			case "&":
				return "&amp;";
				break;
			case "&quot;":
				return "\"";
			case "'":
				if ($isandroidres)
					return "\\'";
				break;

		}
		return $tmatch[0];
	}, $value);
	;
	return $value;
}

///<summary>utility function used to split string</summary>
function igk_mail_split_str($s, $ln=75, $sep="\n"){

	$n = "";
	while(!empty($s)){
		if (!empty($n))
			$n.= $sep;
		$h = substr($s, 0, $ln);
		$s = substr($s, strlen($h));
		$n .= $h;
	}
	return $n;
}

///<summary>send mail to from</summary>
function igk_mail_sendmail($to, $from, $title, $message, $replyto=null, $attachement=null, $type="text/html")
{
	$mail_ctrl = igk_getctrl(IGK_MAIL_CTRL);
	if ($mail_ctrl)
		return $mail_ctrl->sendmail($from, $to, $title, $message, $replyto, $attachement,$type);
	return false;
}
function igk_mail_admin_send($msg, $title="admin mail"){
	$app = igk_app();
	$mail = $app->Configs->mail_admin;
	$domain= $app->App->Configs->website_domain;
	igk_mail_sendmail($mail, "no-reply@".$domain, $title, $msg, null);
}

///<summary>get mail style sheet</summary>
function igk_mail_stylesheet(){
	$s = IGKHtmlItem::CreateWebNode("style");
	$s["type"]="text/css";
	$f = igk_io_currentRelativePath(igk_sys_getconfig("mail_style_sheet", igk_io_basePath(igk_io_dir(dirname(__FILE__)."/Default/Styles/mail.css"))));
	if (file_exists($f))
	{
		$v_s = igk_str_remove_lines(IGKIO::ReadAllText($f));
		$v_s = igk_css_treat(igk_app()->getDoc()->getTheme(), $v_s);
		$s->setContent($v_s);
	}
	else{
		igk_debug_wln(getcwd());
		igk_debug_wln("file not exists ".$f);
	}
	return $s->Render();
}

///<summary> check if the name if a valid identifier</summary>
function igk_is_identifier($name)
{
	return preg_match(IGK_ISIDENTIFIER_REGEX, $name);
}

//----------------------------------------------------
//VALIDATOR functions
//----------------------------------------------------
function igk_val_init()
{
	IGKValidator::Init();
}
function igk_val_cbcss($e, $name)
{
	if ($e && isset($e[$name]))
		return "err_c";//error cibling
}
function igk_val_regParam($ctrl, $name)
{

	$ctrl->setParam($name.":error", igk_val_node());
	$ctrl->setParam($name.":errorcibling", igk_val_cibling());
}
function igk_val_unregParam($ctrl, $name)
{
	$ctrl->setParam($name.":error", null);
	$ctrl->setParam($name.":errorcibling",null);
}
function igk_val_cibling(){
	return IGKValidator::Cibling();
}
function igk_val_node(){
return IGKValidator::Error();
}
function igk_val_haserror(){
	return IGKValidator::Error()->HasChilds;
}
function igk_val_isStrNullOrEmpty($tname, $msg){
		if (IGKValidator::IsStringNullOrEmpty($tname)){ IGKValidator::Error()->addLi()->Content = $mg; }
}
function igk_val_ispic($type, $msg){
		if (!igk_io_fileIsPicture($type)){ IGKValidator::Error()->addLi()->Content = $msg; }
}
function igk_val_add_error($msg, $cibling=null)
{
	$li = igk_val_node()->addLi();
	$li->Content = $msg;
	IGKValidator::AddCibling($cibling);
	$li->cibling = $cibling;
	return $li;
}
function igk_val_check($callback, $object, $name, $msg)
{

	if (is_bool($callback))
	{
		if ($callback)
		{
			igk_val_add_error($msg, $name);
		}
		return;
	}
	$v = call_user_func_array(array("IGKValidator",$callback), array($object->$name));
	if ($v)
	{
		igk_val_add_error($msg, $name);
	}
}

function igk_verbose_wln($msg){

if (defined("IGK_VERBOSE")){
	igk_wln($msg);
	igk_flush_data();
}

}


function igk_sort_byNodeIndex($a,$b)
{
	if ($a->TargetNode && $b->TargetNode)
	{
		$i = $a->TargetNode->Index;
		$j = $b->TargetNode->Index;
		return ($i == $j)? 0: (($i<$j) ? -1 : 1);
	}
	return strcmp($a->Name, $b->Name);
}

function igk_add_loading_frame($t)
{
	$uri = R::GetImgUri("waitcursor");
	if ($uri)
	$t->addDiv(array("class"=>"dispib"))->addBalafonJS()->Content = "igk.media.webplayer.init(this.parentNode,'{$uri}');";
}
//Comparaison func
function igk_cmp_refobj($o,$i)
{
	if (($o==null) && ($i==null))
		return true;
	if ((($o==null) && ($i!=null)) || (($o!=null) && ($i==null)) )
		return false;
	$cmp = igk_new_id();
	igk_debug_wln($cmp);
	$o->$cmp = true;
	igk_debug_wln(" : ". $o->$cmp);
	igk_debug_wln(" : ". $i->$cmp);
	$r = (!empty($i->$cmp));
	//clean up
	unset($o->$cmp);
	return $r;
}
function igk_sys_ctrl(){
	return igk_getctrl(IGK_SYS_CTRL);
}
// get the controller types
function igk_sys_ctrl_type($ctrl)
{
	$s = get_class($ctrl);
	if (igk_reflection_class_extends($s, "IGKCtrlTypeBase"))
	{
		$t = class_parents($s);
		$ht = IGKCtrlTypeManager::GetControllerTypes();
		$ht = igk_array_key_value_toggle($ht);

		foreach($t as $k=>$v)
		{
			if (isset($ht[$v]))
				return $ht[$v];
		}
	}
	return "unknow";
}

function igk_sys_buildconfirm_ajx($ctrl, $id,  $uri, $callback, $message, $hiddenEntries=null)
{
	if (igk_qr_confirm())
	{
		$ctrl->call($callback);
	}
	else{
		$frame = igk_frame_add_confirm($ctrl,$id, $uri);
		$frame->Form->Div->Content = $message;
		if ($hiddenEntries)
		{
			foreach($hiddenEntries as $k=>$v)
			{
				$frame->Form->addInput($k, "hidden",$v);
			}
		}
		igk_wl($frame->Render());
	}
}

function igk_sys_ispagesupported($key)
{
	$m = igk_getctrl(IGK_MENU_CTRL);
	if ($m)
	{
		$tab = $m->getPageList();
		$tab = igk_array_tokeys($tab);
		return isset($tab[$key]);
	}
	return false;
}
function igk_sys_islanguagesupported($key)
{
 	$tab = igk_getctrl(IGK_CSVLANGUAGE_CTRL)->Languages;
	$tab = igk_array_tokeys($tab);
	return isset($tab[$key]);
}

//------------------------------------------------------------------------------------------------------------------------------
//javascript utility functions
//------------------------------------------------------------------------------------------------------------------------------
///<summary>bind script  to document</summary>
function igk_js_init_doc($doc){
	igk_js_load_script($doc, IGK_LIB_DIR."/".IGK_SCRIPT_FOLDER,'igk');
	igk_js_load_script($doc, igk_io_dir(IGK_APP_DIR."/".IGK_SCRIPT_FOLDER),'sys');
	//load script from extendsions dir
	igk_js_load_found_script($doc, igk_io_dir(dirname(__FILE__)."/Ext"),'ext');

}
function igk_js_production_minify_content_callback($a){
	$s = $a->Content;
	if (igk_sys_env_production()){
		return igk_js_minify($s);
	}
	return $s;
}

function igk_css_include_cache($file, & $tab){
	include($file);
}
function igk_css_type($b){
	$tab = ["igk-default", "igk-success", "igk-warning", "igk-info", "igk-danger"];
	return igk_getv($tab, $b, "igk-default");
}
function igk_css_minify($s){
	return igk_js_minify($s, 0, " :\{\}()");
}

function igk_str_read_args($s){
	$count = strlen($s);
	$i = 0;
	$tab = array();
	$v = "";
	while( $i< $count){
		
		$ch = $s[$i];
		$i++;
		
		switch($ch){
			case " ":
			if (!empty($v))
			{
				$tab[] = $v;
				$v = null;
			}
			break;
			case '"':
				//read branket
				if (empty($v)){//start reading string args
					$i--;
					$rgx = igk_str_read_brank($s, $i, $ch, $ch, null, 1);
					$v.=$rgx;
					$m=4;
					$i++;
					
					$tab[] = $v;
					$v=null;
				}else{
					$v.=$ch;
				}
			break;
			default:
				$v.=$ch;
			break;
		}
		
	}
	if (!empty($v)){
		$tab[] = $v;
	}
	return $tab;
}

///<summary>min javascript source</summary>
///<param name="compact">No compact char</param>
///<param name="nocompactchar">No compact char</param>
function igk_js_minify($s, $compact=1, $nocompactchar=' '){
	//@compact: compact the output by removing the space after symbol
	//$s="else\n\t\tigk"; //testing case
	// $s="script_src_lnk = 'https://local.com/Lib/igk/Scripts/igk.js';"; //space checking
	 // $s="else{ return;"; //space checking
	 // $s="function igk_select_exp(p) { var m_items"; //space checking
	// $s="for(var i=0; i < tab.length; i++){"; //space checking
	// igk_wl("source : ".$s."\n");

	$count = strlen($s);
	$i = 0;
	$o = "";
	$m = 0;
	$stop=0;
	$symbolspace ="=;()\{\}+-*:<>[]|, ";
	$symbols = "+-<>=\{\}(),|[]*%";
	while( $i< $count){
		$ch = $s[$i];
		$i++;
		// igk_wln($m. " ");

		if ($m==2){
			if ($ch == $stop){
				$m = 0;
			}
			continue;
		}
		// igk_wl("mode : ".$m . " = ".$ch. " |");

		if ($m==1){
			if ($ch=="/"){
				$m=2;
				$stop ="\n";
				continue;
			}
			//not a valid comment
			if ($ch == "*"){
				//it is multi line
				$e = 0;
				$cm = "";
				while($i < $count){
					//$i++;
					$ch = $s[$i];
					if ($ch=="/"){
						if ($s[$i-1]=="*"){
							$e=1;
							$cm = substr($cm,0,strlen($cm)-1);
							break;
						}
					}
					$cm.=$ch;
					$i++;
				}
				//$o .= "<span style='color:#070;'>/*{$cm}*/</span>";
				if ($e) $i++;
			}else{
				//detect regular express
				//ch is a regular expression if base string end with special caracter or empty
				//
				if (!preg_match_all("#(\||&|!|:|\+|=|-|\()\s*$#i",$o ,$ctab)){
					//igk_ilog("not expression ? ".$ch);
					// igk_wln($o."|");
					//igk_ilog($ctab);
					$m = 0;
					$o.= "/".$ch;
					//e_xit;
					continue;
				}
				//igk_ilog("expression detect");
				$i--;
				$rgx = "/".igk_str_read_brank($s, $i, "/","/" , null, 1);
				$i++;
				while(($i<$count ) && (preg_match("/(g|i|m|u|y)/",$s[$i]))){
					$rgx.= $s[$i];
					$i++;
				}
				$o.= $rgx;
				// igk_wln($o);
				//e_xit;
				//$i++;
			}
			$ch = "";
		}

		switch($ch){
			case "/":
				if (($m %5) ==0){//if mode is 0 or 5
					$m=1;
				}else if ($m==1){
					//valid comment
					$m=2;
					$stop ="\n";
				}
			break;
			case "\"":
			case "'":
			if (($m % 5) ==0){ // if mode is 0 or 5
				$i--;
				$rgx = igk_str_read_brank($s, $i, $ch, $ch, null, 1);
				$o.=$rgx;
				$m=4;
				$i++;
				$ch="";
				// igk_wln($rgx);
				//e_xit;
			}
			break;
			case "\t":
			case "\n":
			case "\r":
					// if ($m!=50){
					if ($m!=5){
						//$o.="";
						$m=5; //consider it as space . ignore space
						//igk_wln("hg:".$m);
					}
				break;
			case " ":
				if (($m% 5) ==0){
					$lni= strlen($o);
					$_last = $lni>0?$o[$lni-1]:'';

					if (($lni>0) && (!$compact && (strpos($nocompactchar, $_last)===false)) || (strpos($symbolspace, $_last)===false))
						$o.=$ch;
					else
						igk_ilog_assert(igk_is_debug(),  "::: ignore space '".$_last."'");
					$m=5;
				}

				break;
			default:
				if ($m==5){
					if ((($lni= strlen($o))>0) && (strpos($symbolspace, $o[$lni-1])===false))
						$o.=" ";
					else if ($compact && ($lni > 0)&& ($o[$lni-1]==' ') && (strpos($symbols, $ch) !==false)){
						$o = substr($o,0, $lni-1);
						// igk_ilog("remove last space ");
					}
					// else{
						// igk_wl("no match\n");
					// }
				}
				 // igk_wl("ch is : {$ch} : {$m} \n");
				//reset mode
				$m=0;
				break;
		}
		if ($m==0)
			$o .= $ch;
		if ($m==4)
			$m=0;
	}
	if ($m==1)
		$o.="/";

	return $o;
}
///<summary>init document to load</summary>
function igk_js_init(){
	// igk_die("why");//, array("func"=>__FUNCTION__));
	$c = igk_createNode("script");
	$c->Content = "ns_igk.init_document();";
	$c->RenderAJX();
}
function igk_js_reg_global_script($u){
	if (file_exists($u))
	{
		$tab = igk_get_env("igk://globalScripts", array());
		$tab[realpath($u)] = 1;
		igk_set_env("igk://globalScripts",$tab);
		return true;
	}else{
		igk_wln("file not exists [$u]");
	}
	return false;
}


function igk_ajx_include_script($script){
	if (igk_is_ajx_demand()){

		$b = igk_createNode("balafonJS");
		$b->Content = "igk.js.load('{$script}');";
		$b->RenderAJX();
	}
}

//<summary>used to post frame to uri. used in href of <a></a> element </summary>
///<remark>if frame need to be shown used ajax mecanism</remark>
//uri: to post
//ctrl: controller to where response must be send in ajax syntax
function igk_js_ctrl_posturi($ctrl, $uri)
{
	$q = IGK_STR_EMPTY;
	if ($ctrl!=null)
	{
		$q = ",'".$ctrl->TargetNode["id"]."'";
	}
	else
		$q = ",null";
	return "javascript:window.igk.ctrl.frames.postframe(this, '".$ctrl->getUri($uri)."&ajx=1'".$q.");";
}

function igk_js_notify_danger($m)
{
	$d = igk_createNode($m);
	$d->setClass("igk-notify igk-notify-danger");
	$d->Content =$m;
	$d->RenderAJX();
}

///<summary>used to get javascript uri component to post frame on the javascript context</summary>
///<param name="uri">string uri or object(Listener)</param>
function igk_js_post_frame($uri, $ctrlid=null,$global=true)
{
	if (is_string($uri))
		return "javascript:".igk_js_post_frame_cmd($uri, $ctrlid, $global);
	else {
		return  new IGKJSPostFrameCmd($uri,$ctrlid,$global);
	}
}
//post form data and render a frame
function igk_js_ajx_postform_frame($uri){
	return "javascript:  \$ns_igk.ajx.postform(\$igk(this).getForm(), '".
	$uri.
	"' , function(xhr){ if (this.isReady()){ \$ns_igk.ctrl.frames.appendFrameResponseToBody(xhr.responseText);  }});  return false;";
}
///<summary>get the post frame javascript command</summary>
function igk_js_post_frame_cmd($uri, $ctrl =null, $global=true)
{
	$q = IGK_STR_EMPTY;
	if ($ctrl!=null)
	{
		if (is_string($ctrl)){
			$q = ",'".$ctrl."'";
		}
		else
			$q = ",'".$ctrl->TargetNode["id"]."'";
	}
	else
		$q = ",null";
	if ($global)
		$q .=",true";
	else
		$q .=",false";
	return "ns_igk.ctrl.frames.postframe(this, '".$uri."&ajx=1'".$q.");";
}
//<summary>used to post uri from link</summary>
//<param name="uri"> uri to post</param>
//<param name="method"> method response. for view</param>
function igk_js_ajx_post_auri($uri, $method=null)
{
	return "javascript: window.igk.web.a_posturi(this,'".$uri."', ".(($method==null)?'null': $method).");";
}
///<summary>post a link uri</summary>
function igk_js_ajx_post_luri($parentTag){
	return "javascript: return window.igk.ajx.a_postResponse(this, '".$parentTag."');";
}
///<summary>get a link javascript a posturi</summary>
function igk_js_ajx_aposturi($uri, $targetNodeId){//used in list demand to post uri script
	return "javascript: window.igk.ajx.aposturi('".$uri."', '".$targetNodeId."');";
}
function igk_js_ajx_post_body_uri($uri){//used in list demand to post uri script

	$funcd = "function(xhr){ if (this.isReady()){ this.replaceBody();}} ";
	return "javascript: \$ns_igk.ajx.post('".$uri."', null,  ".$funcd."); return false; ";
}
///<summary> get a javascript link uri contain in a form </summary>
function igk_js_a_postform($uri){
	return "javascript: return (function(q){var f = window.igk.getParentByTagName(q, 'form');  if (f){f.action ='".$uri."'; f.submit();return false;}})(this);";
}
///<summary> render script node content</script>
function igk_js_render_script($script){
	$s =  igk_createNode("script");
	$s->setContent($script);
	$s->RenderAJX();
}
function igk_js_ajx_view_ctrl($ctrl)
{
	$id = $ctrl->TargetNode["igk-type-id"];
	igk_js_render_script("ns_igk.ajx.fn.getfortarget('".$ctrl->getUri("ViewAJX")."', ns_igk.ctrl.getCtrlById('".$id."'));");
}
///<summary> get a javascript src that will post uri to server</summary>
function igk_js_post_uri($uri, $jsfunc=null){
	$jsfunc = $jsfunc ? $jsfunc : "null";
	return "javascript: window.igk.ajx.post('".$uri."', null, {$jsfunc});";
}
///<summary>get a javascript expression to from parent form variable to uri expression</summary>
///<args name="uri" >uri where to post form</args>
///<args name="jsfunc" >javascript function expression to pass</args>
function igk_js_post_form_uri($uri, $jsfunc=null){
	$c = IGK_STR_EMPTY;
	if ($jsfunc)
		$c .= ",".$jsfunc;
	return "javascript: window.igk.ajx.postform(this.form, '".$uri."' ".$c."); ";
}

///<summary>request for Firefox thumbnails demand</summary>
///<note>controler can adapt their view to match that requirement</note>
function igk_io_request_for_firefox_thumbnails(){

	$b = false;
	if (strstr(igk_getv($_SERVER, "HTTP_USER_AGENT"), "Firefox")){
		$b = igk_getv($_SERVER, "HTTP_CACHE_CONTROL")==='no-cache' &&
			 igk_getv($_SERVER, "HTTP_PRAGMA")=='no-cache';
	}
	return $b;

}

function igk_io_append_to_file($file, $data){
$r = @fopen($file, file_exists($file)?"a+":"w+");
if ($r){
fwrite($r, $data);
fclose($r);
}else{
	igk_log_write_i("func:".__FUNCTION__, "file ".$file." can't be writed ");
}
}
function igk_io_save_posted_file($id, $folder, $callback){
		$f = igk_getv($_FILES, $id);
		$n = igk_getr(IGK_FD_NAME);
		if (($f["error"] == 0) && igk_qr_confirm() ){
			if (IGKIO::CreateDir($folder))
			{
				$destination = igk_io_dir($folder."/".$f["name"]);

				if (!file_exists($destination))
				{
					if (!igk_io_move_uploaded_file($f["tmp_name"],$destination))
					{
						igk_notifyctrl()->addError("move upload file failed");
					}
					else{
						$d = igk_html_uri(igk_io_basePath($destination));
						igk_notifyctrl()->addMsgr("msg.FileAdded_1", $d);
						$callback($n,$d);
					}
				}
				else{
					igk_notifyctrl()->addWarningr("warn.FileAlreadyExists");
					$d = igk_io_basePath($destination);
					$callback($n,$d);
					return 0;
				}
			}
			else{
				igk_notifyctrl()->addError("can't create a directory");
						return 0;
			}
		}
		else{
				igk_notifyctrl()->addErrorr("err.NotFileToAdd_1". $f["error"] );
				return 0;
		}
		return 1;

}
function igk_io_store_uploaded_file($file){
	if (!IGKIO::CreateDir(dirname($file)))
		return 0;
	$fin = fopen("php://input", "r");
	if (!$fin)
		return 0;

	$fo = fopen($file, "w+");
	$buffsize = 4096;
	while( ($c = fread($fin, $buffsize))){
		fwrite($fo, $c, strlen($c));
	}

	fclose($fo);
	fclose($fin);
	return 1;
}
function igk_io_get_uploaded_data(){
	$fin = fopen("php://input", "r");
	if (!$fin)
		return 0;
	$buffsize = 4096;
	$s= "";
	while( ($c = fread($fin, $buffsize))){
		$s.=$c;
	}
	fclose($fin);
	return $s;
}
function igk_io_read_allfile($f){
	if (file_exists($f))
		return IGKIO::ReadAllText($f);
	return IGK_STR_EMPTY;
}
function igk_io_createdir($dirname, $mode=0755){
		if (empty($dirname))
			return false;
		if (is_dir($dirname) === true)
			return true;



		//recursive dir creation
		if (empty($dirname))
			return false;
		if (is_dir($dirname) === true)
			return true;
		//try to create the directory
		if (@mkdir($dirname, $mode)){
			//try to chane chmod dir to creation mask
			@chmod($dirname, IGK_DEFAULT_FOLDER_MASK);
			return true;
		}
		else{
			$d = dirname($dirname);
			if (is_dir($d)){
				//parent create can't create on directory
				return false;
			}
			else{
				if (igk_io_createdir($d, $mode)){
					//create the current directory
					if (@mkdir($dirname, $mode))
					{
						//try to chane chmod dir to creation mask
						@chmod($dirname, IGK_DEFAULT_FOLDER_MASK);
						return true;
					}
				}
			}
		}
		//too bad if you rich here perhaps no access to folder
		igk_notifyctrl()->addError( R::ngets("ERR.CANTCREATEDIR",$dirname));
		igk_die("error when creating directory:CreateDir failed : \"".$dirname."\"");
		igk_exit();
}
//------------------------------------------------------------------------------------------------------------------------------
//ZIP Utility functions
//------------------------------------------------------------------------------------------------------------------------------



function igk_zip_module($outf){	
	$dir=  igk_io_baseDir()."/Mods";
	return igk_zip_dir_exclude(igk_io_baseDir()."/Mods", $outf, "/\.(avi|(mp|(3|4))|gkds|zip|rar)/i");
}

function igk_zip_dir_exclude($dir, $outf, $exclude_pattern){
	$files = igk_io_getfiles($dir);//, "/*$/i", true);//,"/(.)*\.(.)+$/");
	$zip = new ZipArchive();
	if (file_exists($outf))
		unlink($outf);
	$count = 0;
	if ($hzi = $zip->open($outf, ZIPARCHIVE::CREATE))
	{
		
		//igk_zip_dir($dir, $zip);
		$ln = strlen($dir)+1;
		$tdir = array();
		
		foreach($files as $k=>$v){
		
			if ( !file_exists($v) || preg_match($exclude_pattern, $v)){				
				continue;
			}
			$count++;
			$bf = substr($v, $ln);
			$ddir = dirname($bf);
			if (!isset($tdir[$ddir])){
				$zip->addEmptyDir($ddir);
				$tdir[$ddir] = 1;
			}
			if (!is_dir($v))
				$zip->addFile($v, $bf);
		}
		$zip->close();
	}
	return array("count"=>$count, "files"=>$files);
}



function igk_zip_delete($file, $entry, $close =1){
	if (!file_exists($file))
		return 0;
	$zip = new ZipArchive();
	if (!$zip->open($file, ZIPARCHIVE::CREATE)){
		$zip->close();
		return 0;
	}
	$r = $zip->deleteName($entry);
	if ($close)
	$zip->close();
	return $r;
}
function igk_zip_entry_isdir($e)
{
	return ( (zip_entry_filesize($e) == 0) &&  ((zip_entry_compressionmethod($e) == "stored") && igk_str_endwith(zip_entry_name($e),"/")));
}
function igk_zip_create_dir($outdir, $name)
{
	$t = explode('/',$name);

	if (is_dir($outdir))
	{
		$d = $outdir;
		foreach($t as $k)
		{
			if (empty($k))continue;
			$d = $d.DIRECTORY_SEPARATOR.$k;
			if (!is_dir($d))
				@mkdir($d);
		}
	}
}
///zip extract outdir
function igk_zip_extract($outdir,$hzip, $e)
{
	if (!is_dir($outdir))
		return;

	$d = igk_io_dir($outdir.DIRECTORY_SEPARATOR.zip_entry_name($e));

	if (IGKIO::CreateDir(dirname($d)))
	{
		$content = zip_entry_read($e,zip_entry_filesize($e));
		igk_io_save_file_as_utf8_wbom($d, $content,true);
	}
}

function igk_zip_unzip($file, $outdir){
	if (!is_dir($outdir))
		return;
	$hzip = zip_open($file);
	if (!$hzip || !is_resource($hzip) )
		return;


	while( ($e = zip_read($hzip)))
	{
		$n = zip_entry_name($e);

		//extract zip
		if (igk_zip_entry_isdir($e))
		{
			igk_zip_create_dir($outdir, $n);
		}
		else{
			if (!(strpos($n, "/")===FALSE))
				igk_zip_extract($outdir, $hzip , $e);
		}
	}
	zip_close($hzip);
}
function igk_zip_unzip_to($file, $outdir, $zipentry=null){
	if ($zipentry==null){
		igk_zip_unzip($file, $outdir);
	}
	if (!is_dir($outdir))
		return 0 ;
	$hzip = zip_open($file);
	if (!$hzip || !is_resource($hzip) )
		return 0 ;


	while( ($e = zip_read($hzip)))
	{
		$n = zip_entry_name($e);
		if ($n == $zipentry)
			if (igk_zip_entry_isdir($e))
			continue;
		else{
			//extract file to out folder:if (IGKIO::CreateDir(dirname($d)))
			$content = zip_entry_read($e,zip_entry_filesize($e));
			igk_io_save_file_as_utf8_wbom($outdir."/".basename($n), $content,true);
			break;

		}
	if (preg_match("#^".$zipentry."#i",$n)){

			$d = igk_io_dir($outdir.DIRECTORY_SEPARATOR. substr(zip_entry_name($e), strlen($zipentry)));

			if (IGKIO::CreateDir(dirname($d)))
			{
				$content = zip_entry_read($e,zip_entry_filesize($e));
				igk_io_save_file_as_utf8_wbom($d, $content,true);
			}
		}
	}
	zip_close($hzip);
}
function igk_zip_unzip_callback($zipfile, $callback){
	$hzip = zip_open($zipfile);
	if (!$hzip || !is_resource($hzip) )
		return;
	$name = strtolower($name);
	//$c = "";
	while( ($e = zip_read($hzip)))
	{
		$n = zip_entry_name($e);
		// if (strtolower($n) == $name)
		// {
		//extract zip
			if (!igk_zip_entry_isdir($e))
			{
				$callback($hzip, $n, $e);
				// if (strpos($n, "/")===FALSE)
				// {
					// $c = zip_entry_read($e, zip_entry_filesize($e));
				// }
			}
			// break;
		// }
	}
	zip_close($hzip);
	// return $c;
}

///<summary>read zip content</summary>
function igk_zip_unzip_file_content($zipfile, $name)
{
	$hzip = zip_open($zipfile);
	if (!$hzip || !is_resource($hzip) )
		return;
	$name = strtolower($name);
	$c = "";
	while( ($e = zip_read($hzip)))
	{
		$n = zip_entry_name($e);

		if (strtolower($n) == $name)
		{
		//extract zip
			if (!igk_zip_entry_isdir($e))
			{
				// if (strpos($n, "/")===FALSE)
				// {
					$c = zip_entry_read($e, zip_entry_filesize($e));
				// }
			}
			break;
		}
	}
	zip_close($hzip);
	return $c;
}
function igk_zip_unzip_entry($f, $entry){
	$c = "zip://".$f."#".$entry;
	$h = fopen($c,'r');
	if (!$h){
		// igk_debug_die("can't unzip file entry {$f}");
		return null;
	}
	$c = "";
	while (!feof($h)) {
		$c .= fread($h, 4096);
	}

	fclose($h);
	return $c;
}


function igk_zip_content($file, $name,  $content, $closearchive=1)
{
	// if (!IGKIO::CreateDir(dirname($file)))
		// igk_die("can't create directory file");

	$zip = new ZipArchive();
	if (!$zip->open($file, ZIPARCHIVE::CREATE)){
		$zip->close();
		return 0;
	}
	$zip->addFromString($name, $content);
	if ($closearchive){
		$zip->close();
		return null;
	}
	return $zip;
}
function igk_zip_folder($outfile, $dir, $folder=null, $regex = null)
{
	if (is_dir($dir) == false)
		return false;
	$zip = new ZipArchive();
	if ($zip->open($outfile, ZIPARCHIVE::CREATE))
	{
		igk_zip_dir($dir, $zip, $folder, $regex);
		$zip->close();
		return true;
	}
	return false;
}
///<summary>use to zip a directory </summary>
function igk_zip_dir($dir, $zip, $folder=null, $regex = null)
{
		if (!$zip)
			return;
		
		$q =0;
		$tab = array($dir);
		while( $q = array_pop($tab)){
			
			$hdir = opendir($q);
			if (is_resource($hdir))
			{

				while( $d  = readdir($hdir))
				{

					if (($d==".") || ($d=="..") || (($regex!==null) && preg_match($regex, $d)))
					{
						continue;
					}
					$f = $q."/".$d;
					$hd =substr($f, strlen($dir)+1);
					$hd = (!empty($folder) ? $folder."/":null).$hd;
					if (is_dir($f))
					{
						$zip->addEmptyDir($hd);//folder==null ? $d : $folder."/".$d);
						array_push($tab, $f);
					}
					else if (is_file($f))
					{
						$zip->addFile($f, $hd);
					}
				}
				closedir($hdir);
			}
		}
}

function igk_zip_create_file($file, $dir, $folder=null, $regex=null)
{
	if (!is_dir($dir))
		return false;
	$zip = new ZipArchive();
	$zip->open($file, ZIPARCHIVE::CREATE);
	if ($zip){
		igk_zip_dir($dir, $zip, $folder, $regex);
		$zip->close();
	}
	return true;
}

function igk_time_max_info($d, $from=null){
	// igk_wln("d ".$d);
	// igk_wln("from ".$from);

	// igk_wln(date_parse_from_format('H:i:s', date('H:i:s', $d)));
	// igk_wln(date_parse_from_format('H:i:s',date('H:i:s', $from)));
	$c = $from ?? time();
	// igk_wln("from ".$c);
	$d = $d - $c;
	// igk_wln($d);
	//e_xit;
	if ($d<=0)
		return array($d,'n');
	// igk_wln("first : ".$d);
	if ($d<60){
		return array($d, 's');
	}
	$d = round($d/60);
	// igk_wln("min ".$d);
	if ($d < 60)
		return array($d, 'm');
	$d =round( $d/60);
	// igk_wln("h ".$d);
	if ($d <= 24)
		return array($d, 'h');
	$d = round($d/24);
	if ($d < 365)
		return array($d, 'd');
	$d = round($d / 365);
	return array($d, "y");
}

///<summary> get the time span</summary>
///<usage> igk_time_span('Ymd', '20150518')</usage>
function igk_time_span($format, $value){
	$b = date_parse_from_format($format, $value);
	$s = mktime($b["hour"], $b["minute"], $b["second"], $b["month"], $b["day"], $b["year"]);
	return $s;
}
function igk_format_date($v, $in, $out){
	$span = igk_time_span($in , $v);
	///$b = date_parse_from_format($in, $v);
	return date($out, $span);
}
//get the number of items
function igk_count($item)
{
	if (is_string($item))
		return strlen($item);
	if (is_array($item))
		return count($item);
	if (is_object ($item) )
	{
		if (method_exists(get_class($item), "getCount"))
			return $item->getCount();
		if (method_exists(get_class($item), "getRowCount"))
			return $item->RowCount();
	}
	return 0;
}
///<summary>shortcut to render global document</summary>
function igk_render_doc($doc=null){//render the global default document
	IGKApp::RenderDocument($doc);
}
///<summary>return constants within the class</summary>
function igk_get_class_constants($classname){
	$r = new ReflectionClass($classname);
	return $r->getConstants();
}
///<summary>return class instance for atomic design pattern</summary>
function igk_get_class_instance($classname, $callback){

	$k = igk_get_instance_key($classname);
	$s = igk_app()->Session;
	$keyid = IGKSession::IGK_INSTANCES_SESS_PARAM;
	$tab = $s->getParam($keyid, array());

	$o = igk_getv($tab, $k);
	if (!$o){
		//bind to class
		if (method_exists($callback, "bindTo"))
			$callback->bindTo(null, $classname);
		$o = $callback();
		$tab[$k] = $o;
		$s->setParam($keyid, $tab);
	}
	return $o;
}

///<summary>bind my how header</summary>
function igk_get_allheaders(){
	$tab= array();
	if (function_exists("getallheaders"))
	{
		$t =  getallheaders();
		foreach($t as $k=>$v)
		{
			$k = strtoupper(str_replace('-','_', $k));
			$tab[$k] = $v;
		}
	}
	foreach ($_SERVER as $name => $value)
	{
	   if (substr($name, 0, 5) == 'HTTP_')
	   {
		   //$name = str_replace(' ', '-', ucwords(strtolower(str_replace('_', ' ', substr($name, 5)))));
		   $name = str_replace(' ', '-',  substr($name, 5));
		   $tab[$name] = $value;
	   } else if ($name == "CONTENT_TYPE") {
		   $tab["Content-Type"] = $value;
	   } else if ($name == "CONTENT_LENGTH") {
		   $tab["Content-Length"] = $value;
	   }
	}
	return $tab;
}
function igk_get_default_style(){

return <<<EOF
<?php
//
// Balafon theme files for
// Private custom theme
// in context variable
//

// \$ctrl : controller that init the style
// \$file : current file
// \$xsm_screen =  igk_app()->Doc->Theme->get_media(IGKHtmlDocThemeMediaType::XSM_MEDIA);
// \$sm_screen = igk_app()->Doc->Theme->get_media( IGKHtmlDocThemeMediaType::SM_MEDIA);
// \$lgm_screen = igk_app()->Doc->Theme->get_media( IGKHtmlDocThemeMediaType::LG_MEDIA);
// \$xlgm_screen = igk_app()->Doc->Theme->get_media( IGKHtmlDocThemeMediaType::XLG_MEDIA);
// \$xxlgm_screen = igk_app()->Doc->Theme->get_media( IGKHtmlDocThemeMediaType::XXLG_MEDIA);
// \$PTR = igk_app()->Doc->Theme->getPrintMedia();
// \$def : global definition
//-----------------------------------------------------------------------------------------------------------------
//variables
//-----------------------------------------------------------------------------------------------------------------
//\$css_m : main css class of this controller
//\$def : init global definition

//add your custom theme to definitions



//-----------------------------------------------------------------------------------------------------------------
//register your font package
//-----------------------------------------------------------------------------------------------------------------
//type of  WOFF, TrueTypeFont are supported
//igk_css_reg_font_package("packagename" , "[basedir_path_to_fontfile]", "[type]");
//-----------------------------------------------------------------------------------------------------------------
//register used color
//-----------------------------------------------------------------------------------------------------------------
//type of  WOFF, TrueTypeFont are supported
//igk_css_regcolor(colorname , colorvalue);
//exemple: igk_css_regcolor('mydata-color', '#fff');

?>
EOF;
}
///return the base index.php content
function igk_getbaseindex_src()
{

//ini_set("display_errors", "1");
//error_reporting(E_ALL);

$showError = "";
// <<<EOF
// //Display ERRORS

// ini_set("display_errors", "1");
// error_reporting( E_ALL | E_STRICT);// | E_NOTICE);
// ini_set('error_reporting', E_ALL | E_STRICT);

// EOF;
$inf = igk_createObj();
$inf->date = igk_date_now();
$inf->lib = __FILE__;
$inf->comment =<<<EOF
this file is generate by balafon service. please do not modify until you know what you are doing.
EOF;

return <<<EOF
<?php
//-------------------------------
// date : {$inf->date}
// {$inf->comment}
// author : C.A.D. BONDJE DOUE
// mail: bondje.doue@igkdev.com
//-------------------------------
{$showError}
//
//require framework
//
define('IGK_APP_DIR',dirname(__FILE__));
@require_once('{$inf->lib}');
igk_sys_render_index(__FILE__);
?>
EOF;
}
///<summary>get the cache request file</summary>
function igk_sys_cache_request(){
	// igk_ilog("demand for ".igk_getv($_SERVER,"REQUEST_URI"));
	//igk_ilog(igk_ob_get($_SERVER));
	$g = "";
	$f = IGK_APP_DIR."/Caches/uri.cache";
	$dom = igk_getv($_SERVER, 'HTTP_HOST');
	// igk_wln("check {$dom} ".preg_match('/^(([^\.])+\.)+(([^\.])+\.)([^\.]+)$/i',$dom));
	//e_xit;
	if (!IGKValidator::IsIPAddress($dom) && preg_match('/^(([^\.])+\.)+(([^\.])+\.)([^\.]+)$/i',$dom)){
		//igk_ilog("cache for subdomain ".$dom . " not implement ");
		return null;
	}else{
		$g = igk_io_current_request_uri();//igk_getv($_SERVER,"REQUEST_URI");
	}
	if ($g == "/")
		return $g."index.php";


	if (strstr($g, "/?")){
		$g = "/index.php".substr($g, 1);
	}
	$g = igk_str_rm_last($g, "/");
	if (file_exists($f)){

		$t = array();
		include($f);
		if(isset($t[$g])){
			list($uri,$time) = explode("|", $t[$g]);
			return $uri;//$t[$g];
		}
	}
	return $g;
}

function igk_sys_store_uri_cache($t){
	$f = IGK_APP_DIR."/Caches/uri.cache";
	$s = "<?php\n";
	foreach($t as $k=>$v){
		$s .= "\$t[\"{$k}\"]=\"{$v}\";\n";
	}
	$s .= "?>";
	igk_io_save_file_as_utf8_wbom($f, $s, true);
}
///<summary>store document as cache</summary>
///<return>the document rendering output</return>
function igk_sys_store_doc_cache($doc, $file, $uri=null){
	$f = igk_io_dir( IGK_APP_DIR."/Caches/html".$file);
	$opt = igk_xml_create_render_option();
	$opt->Cache = 1;
	$o = $doc->Render($opt);
	igk_io_save_file_as_utf8_wbom($f, $o, true);
	if ($uri){
		//store uri cache
		igk_sys_add_cache_uri($uri);
		// $f = IGK_APP_DIR."/Caches/uri.cache";
		// $t = array();
		// if (file_exists($f)){
			// include($f);
		// }
		// $t[$uri] = $file."|".igk_date_now(); //append setting
		// igk_sys_store_uri_cache($t);

	}
	return $o;
}

///<summary>determining if xml options is caching require
function igk_xml_is_caching_require($options=null){
	 return $options && ($options->Context == IGK_WEB_CONTEXT) && $options->Cache;
}
///<summary>get if request require cache</summary>
function  igk_sys_cache_require(){
	return defined("IGK_CACHE_REQUIRE") || igk_getv(igk_get_allheaders(), "IGK_CACHE_REQUIRE", 0);
}
function igk_sys_cache_uri(){
	return igk_getv(igk_get_allheaders(), "IGK_CACHE_URI");
}
function igk_sys_html_cache_dir(){
	return IGK_APP_DIR."/".IGK_CACHE_FOLDER."/html";
}
function igk_sys_store_str_cache($src, $name, $uri=null){
	$fn = preg_replace("/(\+|=|\?)/i","_",  $name);

	$cdir =  igk_sys_html_cache_dir();
	$f = igk_io_dir($cdir.$fn);
	//igk_ilog("try to out file :".$f);
	$dir = dirname($f);
	$sub = strlen($cdir);
	// igk_ilog("dir : ".$dir);
	// igk_ilog("sub : ".substr($f, $sub));
	//e_xit;
	if (IGKIO::CreateDir($dir)){

		if (igk_io_save_file_as_utf8_wbom($f, $src, true)){
		if ($uri){
			igk_sys_add_cache_uri($name, substr($f, $sub));
		}
		return $f;
		}
	}
	return null;

}
///<summary>if muri is array ignore file
function igk_sys_add_cache_uri($muri, $file=null){
	// igk_ilog("add ".$file);
		$f = IGK_APP_DIR."/Caches/uri.cache";
		$t = array();
		if (file_exists($f)){
			include($f);
		}
		$d = igk_date_now();
		if (is_array($muri)){

			foreach($muri as $k=>$v){
				$t[$k] = $v."|".$d;
			}
		}else{
			$t[$muri] = $file."|".$d; //append setting
		}
		igk_sys_store_uri_cache($t);
}

function igk_sys_is_html_caching(){
	$dir = igk_io_dir( IGK_APP_DIR."/Caches/");
	return file_exists($dir."/".IGK_CACHE_HTML);
}
function igk_sys_handle_cache(){
	if (defined("IGK_NO_WEB") || igk_sys_cache_require())
		return;

	$dir = igk_io_dir( IGK_APP_DIR."/Caches/");
	if (!file_exists($dir."/".IGK_CACHE_HTML))
		return;
	$rq = igk_sys_cache_request();


	// igk_ilog("cache : ".$rq);
	// igk_ilog("igk_io_baseUri : ".igk_io_baseUri());
	// igk_ilog("igk_io_baseDir : ".igk_io_baseDir());
	// igk_ilog("igk_io_basePath : ".igk_io_basePath(""));
	// igk_ilog("igk_io_request_uri :".igk_io_request_uri());
	// igk_ilog(igk_ob_get($_SERVER));
	if (empty($rq))
		return;

	$f = igk_io_dir( IGK_APP_DIR."/Caches/html".$rq);//igk_getv($_SERVER,"REQUEST_URI", 'index.php'));
	// igk_wln("handle cache : ".$rq . "  ".$f . " ? ".file_exists($f) ." === ".is_file($f) );
	if (file_exists($f) && is_file($f) ){

		igk_set_header('200', "Content-Type: text/html; charset=utf-8");
		//render caching document
		igk_wl(igk_io_read_allfile($f));
		//igk_wl(IGKIO::ReadAllText($f));
		igk_exit();
	}
	//	igk_wln("handle cache : done ".$f);
}
function igk_sys_enable_html_caching(){
	$dir = igk_io_dir( IGK_APP_DIR."/Caches/");
	$d = igk_date_now();
	igk_io_save_file_as_utf8_wbom($dir."/".IGK_CACHE_HTML,<<<EOF
#active the html caching "{$d}
#delete me to deactivate the html cache
EOF
,true);
}
function igk_sys_disable_html_caching(){
	@unlink(igk_io_dir( IGK_APP_DIR."/Caches/".IGK_CACHE_HTML));
}
function igk_sys_render_index($file){
	//igk_start_time(__FUNCTION__);	
	if(!defined('IGK_APP_DIR')){
		define("IGK_APP_DIR", dirname($file));
	}
	
	try{
		
	igk_sys_handle_cache();
	//------------------------------------------------------------------------------------------
	//call init environment method before start the session to load and create all required file
	//------------------------------------------------------------------------------------------
	
	igk_initenv(IGK_APP_DIR);
	
	//Start SESSION$
	igk_start_session();
	//SET DEFAULT HEADER
	igk_set_header('200', "Content-Type: text/html; charset=utf-8");
	//start Application. file is require to check if is included
	igk_set_session_redirection(null,1);
	IGKApp::Init($file);
	}
	catch (Exception $ex)
	{
		igk_wl("<div>IGK - some exception raised</div>");
		igk_wl("<quote>{$ex->getMessage()}</quote>");
		igk_wl(igk_show_exception($ex));
		igk_exit();
	}
	//igk_utest_wln(__FUNCTION__." ".igk_execute_time(__FUNCTION__)."s");	
}
function igk_tracing(){
	$f = igk_io_baseDir()."/Data/.trace";
	if(file_exists($f))
		return true;
	return false;
}
function igk_trace_function($level=1){
	$c = IGKException::GetCallingFunction($level);
	return $c;
}


function igk_kill_trace(){
$file = igk_io_baseDir()."/Data/.trace";
	if(file_exists($file))
		unlink($file);
}
///<summary>return the tracing information info</summary>
function igk_show_trace($depth=1)
{


	if(igk_get_env("sys://TRACING")){
		return ".tracing.....";
	}
	$def =defined("IGK_TRACE_CLEAN");

	if ($def){
		ob_clean();
	}

	// IGKIO::WriteToFile($file, "",true);
	$callers=debug_backtrace();
	igk_set_env("sys://TRACING", 1);
	$d = igk_createNode("div");
	$tb = $d->addDiv();
	$tb->add('span')->Content  =" FROM ";
	$tb->addObData($callers[0]);
	$dv = $d->addTable();
//	return;
	$rd = $dv->addTr()->setStyle("color:#aeaeae");
	$rd->addTh()->addspan()->Content = R::ngets("lb.line");
	$rd->addTh()->addLabel()->Content = R::ngets("lb.file");
	$rd->addTh()->addLabel()->Content = R::ngets("lb.function");
	$rd->addTh()->addspan()->Content = "Class";
	for ( $i = $depth ; $i < count($callers) ;$i++)
	{
		$f = igk_getv($callers[$i], "function");
		$c = igk_getv($callers[$i], "class", "__global");
		$rd = $dv->addTr();
		$rd->addTd()->addspan()->Content = igk_getv($callers[$i], "line")	;
		$rd->addTd()->addLabel()->Content = igk_getv($callers[$i], "file");
		$rd->addTd()->addLabel()->setStyle("color:blue;")->Content = $f;
		$rd->addTd()->addspan()->setStyle("color:green;")->Content = $c;
	}
	$p = $d->Render();
	igk_set_env("sys://TRACING", null);
	return $p;
}


///<summary>render trace </summary>
function igk_render_trace(){
	igk_wln(igk_show_trace(1));		
}


///<summary>include on global context</summary>
///<param name="f">file to include</param>
///<param name="g">global argument</param>
function igk_include_on_global($f, $g=null){
if ($g){	
	foreach($g as $k){
		global $$k; //= $GLOBALS[$k];// null;
	}
}
extract($GLOBALS);
include($f);
}


///------------------------------------------------------------------------------
///reflection functions
///------------------------------------------------------------------------------
function igk_reflection_get_member($cl, $exclude_empty=1){
	$c = get_class($cl);
	$t = array();
	$pc = $c;
	
	$exclude_func = function($prop, $cl)use($exclude_empty){
		if ($exclude_empty){
			$prop->setAccessible(true);
			$obj = $prop->getValue($cl);
			$prop->setAccessible(false);
			if (($obj == null) || empty($obj) || ( is_object($obj) && method_exists($obj, "IsEmpty") && $obj->IsEmpty() ))
			{
				return true;					
			}
		}
		return false;	
	};
	
	while($pc){
		$r = new ReflectionClass($pc);
		$tab = $r->getProperties(ReflectionProperty::IS_PRIVATE);
		foreach($tab as $k=>$v){
			$prop = new ReflectionProperty($pc, $v->name);
			if ($prop->isStatic() || $exclude_func($prop, $cl))
				continue;			
			$t["\0".$v->class."\0".$v->name] = $v->name;
		}
		//get public item
		$tab = $r->getProperties(ReflectionProperty::IS_PUBLIC);
		foreach($tab as $k=>$v){
			$prop = new ReflectionProperty($pc, $v->name);
			if ($prop->isStatic() || ($v->name[0]=="@") ||  $exclude_func($prop, $cl))
				continue;//remove storage of private or static property
			
			
			$t[$v->name] = $v->name;
		}
		
		
		$r = $r->getParentClass();
		if ($r)
		$pc = $r->getName();
	else
		$pc =null;
	}
	return $t;
}

///</summary>get function arguments </summary>
function igk_reflection_func_get_args($args){
$callers=debug_backtrace();
$f = igk_getv($callers[1], "function");
$c = igk_getv($callers[1], "class");
$tc = array ();
if ($c){
	$m = new ReflectionMethod($c, $f);
	$i = 0;
	foreach($m->getParameters() as $p){
		$tc[$p->name] = igk_getv($args, $i);
		$i++;
	}
}
return $tc;
}


function igk_reflection_getdeclared_filename($class){
		$h = new ReflectionClass ($class);
		return $h->getFileName();
}
//return -1 not a class
function igk_reflection_class_isabstract($name)
{
	if (class_exists($name))
	{
		$v_rc = new ReflectionClass($name);
		return $v_rc->isAbstract();
	}
	return -1;
}
function igk_reflection_getclass_var($obj)
{
	if (is_object($obj))
		return get_class_vars( get_class( $obj));
	if (is_string($obj))
	{
		if (class_exists($obj))
		{
			return get_class_vars($obj);
		}
	}
	return null;
}

//return the name of the class if exist or throw a exception
function igk_reflection_class_exists($name){
	if (!class_exists($name))
		igk_die("class [{$name}] doesn't exists");
	return $name;
}
function igk_reflection_interface_exists($name){
	if (!interface_exists($name))
		igk_die("class $name doesn't exists");
	return $name;
}
function igk_reflection_class_implement($objOrClassName, $name){
	igk_reflection_interface_exists($name);
	if ($objOrClassName){
		$n = $objOrClassName;
		if (is_object($objOrClassName))
		{
			$n = get_class($objOrClassName);
		}
		$tab = class_implements($n);
		if (isset($tab[$name]))
			return true;
	}
	return false;
}
///<summary>get if object or classname is type of $name or extends it</summary>
function igk_reflection_class_extends($objOrClassName, $name){
	igk_reflection_class_exists($name);
	if ($objOrClassName){
		$n = $objOrClassName;
		if (is_object($objOrClassName))
		{
			$n = get_class($objOrClassName);
		}
		if ((strtolower($n) == strtolower($name)) ||  is_subclass_of($n, $name))
			return true;
	}
	return false;
}

function igk_reflection_get_constants($cl){
	$r = new ReflectionClass($cl);
	return $r->getConstants();
}

//sort array
function igk_usort(& $item, $params)
{
	if (is_array($item))
		usort($item, $params);
	else{
		$item->Sort($params);
	}
}

//return the global page list
function igk_sys_pagelist(){
	return igk_getctrl(IGK_MENU_CTRL)->getPageList();
}
//get if this page is a system registrated page
function igk_sys_is_page($page)
{
	$tb = igk_sys_pagelist();
	$p = strtolower($page);
	foreach($tb as $k)
	{
		if ($k == $p)
		return true;
	}
	return false;
}

///<summary>mark a controller as a system controller</summary>
function igk_sys_regSysController($className){//classname of the controller to mark
	if (class_exists($className)){
		IGKControllerBase::RegSysController($className);
	}
}
///<summary>registrer controller</summary>
function igk_sys_reg_controller($n, $classname){
	igk_set_env_keys("sys://app/controllers", $n, $classname);
}
///<summary>return the controller registrated class</summary>
function igk_sys_get_controller($n){
	$b = igk_get_env("sys://app/controllers");
	if ($b)
		return igk_getv($b, $n);
	return null;
}


function igk_sys_viewctrl($name)
{
	$ctrl = igk_getctrl($name);
	if ($ctrl!=null){
		$ctrl->View();
	}
}
function igk_sys_force_view(){
	igk_getctrl(IGK_SESSION_CTRL)->forceview();
}

function igk_preg_match($pattern, $value, $key, $index=0)
{
	$tab = array();
	$c = preg_match_all($pattern , $value, $tab);
	if ($c>0)
	{
		return igk_getv($tab[$key], $index);
	}
	return null;
}
//-------------------------------------------------------------------
//system's function
//-------------------------------------------------------------------

///<summay>shortcut to check if a class is a component</summary>
function igk_sys_class_is_component($classname)
{
	return IGKHtmlItemBase::IsComponent($classname);
}

///<summary> register a html component</summary>
///<param name="ns">namespace</param>
///<param name="name">name of the component</param>
///<param name="callback">callable to create the component</param>
function igk_sys_reg_html_component($ns, $name, $callback){

	$nk = IGK_ENV_HTML_COMPONENTS;
	$cp = igk_get_env($nk);

	if ($cp == null){
		$cp = array();
	}
	$h = igk_getv($cp, $ns, array());
	$file = "";

	$h[strtolower($name)] = array("key"=>$name,
	"callback"=>$callback,
	"from"=>$file
	);
	$cp[$ns] = $h;
	igk_set_env($nk, $cp);
}
///<summary> register namespace prefix</summary>
function igk_sys_reg_html_ns_prefix($ns, $name){
	$nk = IGK_ENV_HTML_NS_PREFIX;
	$cp = igk_get_env($nk);
	if ($cp == null){
		$cp = (object)array("prefix"=>array(),"ns"=>array());
	}
	$key = strtolower($name);
	if (isset($h->prefix[$key])){
		$h->prefix[$key] = $ns;
		$h->ns[$ns] = $key;
	}
	igk_set_env($nk, $cp);
}
///<summary> get prefix</summary>
function igk_sys_get_html_ns_prefix($ns){
	$nk = IGK_ENV_HTML_NS_PREFIX;
	$cp = igk_get_env($nk);
	if (!$cp){
		return null;
	}
	return igk_getv($cp->ns, $ns);
}

function igk_create_component_callback($classname, $callback){
	$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, true);

	$t = $ctrl->getParam("sys://class_component",array());
	if (!isset($t[$classname])){
		$t[$classname] = $callback();
		$ctrl->setParam("sys://class_component",$t);
	}
	return $t[$classname];

}
function igk_free_component($classname){
	$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, true);
	$t = $ctrl->getParam("sys://class_component");
	if ($t){
		unset($t[$classname]);
	}

}
///<summary>register a node as a component uri</summary>
///<param name="node">the item that will host function callback</param>
///<param name="func">the fonction name registrated to a node</param>
///<return>the component registrated uri</param>
///<exemple> igk_get_component_uri($div, 'getIsVisible')<exemple>
function igk_get_component_uri($node, $func){
	$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, true);
	$u = null;
	if ($ctrl->Exists($node)){
		$u  = $ctrl->getUri($func, $node);
	}else{
		if ($ctrl ->Register($node, false)){
			$node->setParam(IGK_COMPONENT_ID_KEY, new IGKHtmlComponentIdValue($node));
			$u  = $ctrl->getUri($func, $node);
		}
	}
	//igk_log_write_i("test " , "$u for ".$node["igk-component-id"] . " " .$node->TagName. " : ".get_class($node));
	return $u;
}
///<summary>register and get the component id</summary>
function igk_get_component_id($n){
	$id= $n->getParam(IGK_COMPONENT_ID_KEY)->getValue();
	$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, true);
	if ($id && $ctrl->Exists($n)){
		return $id;
	}else{
		if ($ctrl ->Register($n, false)){
			$n->setParam(IGK_COMPONENT_ID_KEY, new IGKHtmlComponentIdValue($node));
			return $n->getParam(IGK_COMPONENT_ID_KEY)->getValue();
		}
	}
	return $u;
}
///<summary>get component by id</summary>
function igk_get_component_by_id($id){
	$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, true);
	if ($ctrl){
		//igk_wln(array_keys($ctrl->Components));

		return $ctrl->getComponentById($id);
	}
	return null;
}

function igk_reg_component_ajx($n,$attr, $callback){
	$n->setCallback($attr, $callback);
	$n["onclick"]="javascript:ns_igk.stop_event(event); ns_igk.ajx.post('".igk_get_component_uri($n, "$attr")."');  return false;";
	return $n;
}

function igk_reg_component($id, $s){
	$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL);
	$ctrl->setParam("sys://globalcomponent/{$id}",$s);
}
function igk_get_component($id){
	$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL);
	return $ctrl->getParam("sys://globalcomponent/{$id}");
}
///
///winui function
//
function igk_winui_createmenu($name, $uri){
	return (object)array(
		"clId"=>igk_new_id(),
		"clName"=>$name,
		"clUri"=>$uri
	);
}


///
///sys function
//

///<summary>shortcut to check if a class is a html element</summary>
function igk_sys_class_is_html_element($classname)
{
	return IGKHtmlItemBase::IsElement($classname);
}

//to manage changement
function igk_sys_regchange($key, & $state)
{
	$c = igk_getctrl(IGK_CHANGE_MAN_CTRL, false);
	if ($c)
		return $c->registerChange($key, $state);	
	return null;
}
function igk_sys_ischanged($key, & $state)
{	$c = igk_getctrl(IGK_CHANGE_MAN_CTRL, false);
	if ($c)
		return $c->isChanged($key, $state);
	return false;
}
///register a method for view call back
function igk_sys_regview($ctrlname, $ctrl, $callback)
{
	$c = igk_getctrl($ctrlname , false);
	if (($c == null) || ($ctrl == null) && ($c!== $ctrl))
		return;
	$c->regView($ctrl, $callback);
}
function igk_sys_unregview($ctrlname, $ctrl)
{
	$ctrl = igk_getctrl($ctrlname , false);
	if (($ctrl == null) || ($ctrl == null) )return;
	$ctrl->unregView($ctrl);
}


function igk_sys_regpagefolderChanged($name, $ctrl , $method){
	igk_app()->registerPageFolderChangedMethod($name, array($ctrl, $method));
}
function igk_sys_unregpagefolderChanged($name)
{
	igk_app()->unregisterPageFolderChangedMethod($name);
}
///<summary>get all controllers</summary>
function igk_sys_getall_ctrl(){//return all controller instanciated on the api domain
	return igk_app()->getControllerManager()->getControllers();
}
function igk_sys_getuserctrls(){
	return  igk_app()->getControllerManager()->getUserControllers();
}

function igk_sys_meth_info($func){
	$v = array();
	$tab = explode("/", $func);

	$v["Name"] = $tab[0];
	$v["Args"] = array_slice($tab, 1);

	return (object)$v;
}
///return system cgi folder
function igk_sys_cgi_folder(){
	return IGK_LIB_CGI_BIN_DIR;
}
function igk_sys_getdefaultCtrlConf(){//return the default configuration options
	return array(
			"clTargetNodeIndex"=>0, //target index
			"clDisplayName"=>null,  //the visible name of this controller
			"clRegisterName"=>null, //name for registration
			"clDataAdapterName"=>"CSV", //data adapter name. default is CSV
			"clParentCtrl"=>null, //the parent of this controller
			"clVisiblePages"=>"*",//visible for all page
			"clDescription"=>null, //description of this controller
			"clDataSchema"=>false, //support data schema
			);
}


function igk_get_value($obj, $path){
	$c = explode("/", $path);
	$o = null;
	while($obj && (igk_count($c)>0)){
		$g =null;
		$n = array_shift($c);
		if (is_object($obj)){
			$g = $obj->$n;
		}else if (is_array($obj)){
			if (!isset($obj[$n])){
				igk_die("faile to ge value ".$n);
			}
			$g = $obj[$n];
		}
		$obj=$g;
		$o = $g;
	}

	return $obj;
}

//test function
// $a = (object)array("cla"=>(object)array("Attributes"=>"Data"));
// igk_wln(
// igk_get_value($a, "cla/Attributes"));

// exit;

//CONFIG FUNCTION
function igk_conf_canconfigure()
{
	return igk_getcltrl(IGK_CONF_CTRL)->getCanConfigure();
}

///<sumary>store config value to node</summary>
function igk_conf_store_value($d, $k,$v){
	
	$bindv = function ($c, $v){
		$tab = array();
		array_push($tab, (object)array('n'=>$c, 'v'=>$v));

		while($q = array_pop($tab)){
			$m = $q;
			foreach($m->v as $s=>$t){
				
				if ($s[0]=="@"){//store as attribute
					$m->n[substr($s,1)]= $t;
					continue;
				}
				if (is_string($t)){ //treat expression if necessairy
					//store a value content						
					$m->n->add($s)->Content = $t;
					//store as attribute content
					//$m->n[$s]=$t;
				}else{
					if (is_array($t)){
						
						array_push($tab,(object)array(
						'_from:table'=>1,
						'n'=>$m->n,
						'v'=>$t,
						'a'=>$s) );
					}else{
						if (isset($m->{'_from:table'}))
						{
							$a = $m->a;
							igk_assert_die(!$a, "object not found. ".$s);
							array_push($tab,(object)array('n'=>$m->n->add($a), 'v'=>$t) );
						}else{
							array_push($tab,(object)array('n'=>$m->n->add($s), 'v'=>$t) );
						}

					}
				}
			}
		}
		
	};
	
	if (is_string($v)){
		$d->add($k)->Content = $v;
		return;
	}
	else{
		if (is_object($v)){
			$c = $d->add($k);
			$bindv($c, $v);
			
			// $tab = array();
			// array_push($tab, (object)array('n'=>$c, 'v'=>$v));

			// while($q = array_pop($tab)){
				// $m = $q;
				// foreach($m->v as $s=>$t){
					// igk_debug_wln("data : ".$s);
					// if ($s[0]=="@"){//store as attribute
						// $m->n[substr($s,1)]= $t;
						// continue;
					// }
					// if (is_string($t)){ //treat expression if necessairy
						// //store a value content						
						// $m->n->add($s)->Content = $t;
						// //store as attribute content
						// //$m->n[$s]=$t;
					// }else{
						// if (is_array($t)){
							// igk_debug_wln(__FUNCTION__." is array ".$s);
							// array_push($tab,(object)array(
							// '_from:table'=>1,
							// 'n'=>$m->n,
							// 'v'=>$t,
							// 'a'=>$s) );
						// }else{
							// if (isset($m->{'_from:table'}))
							// {
								// $a = $m->a;
								// igk_assert_die(!$a, "object not found. ".$s);
								// array_push($tab,(object)array('n'=>$m->n->add($a), 'v'=>$t) );
							// }else{
								// array_push($tab,(object)array('n'=>$m->n->add($s), 'v'=>$t) );
							// }

						// }
					// }
				// }
			// }
		}
		else if (is_array($v)){
			//igk_debug_wln("value is array ".$k);
			$name=$k;
			foreach($v as $k=>$v){
				$n = $d->add($name);
				$bindv($n, $v);
			}
		}
	}
}
function igk_conf_get_expression($s){
	$tab = array();
	$ln = strlen($s);
	$i = 0;
	$m = 0;
	$n = "";
	$q = 0;


	while($i< $ln){
		$ch = $s[$i];
		switch($ch){
			case "="://equal
			case "|"://or
			case "$"://end
			case "^"://start
				if ($m==0){
					$q = (object)array("op"=>$ch, "v"=>"");
					$tab[$n] = $q;
					$m=1;//read value
				}
				$n = "";
				break;
			case ",":
				if (($m==1 ) && (!empty($n))){
					$q->v=$n;
				}
				$m=0;
				$n="";
				break;
			default:
				$n.=$ch;
				break;
		}
		$i++;
	}
	if (($m==1 ) && (!empty($n))){
		$q->v=$n;
	}

	return (object)$tab;
}


///<summary>get if configuration match the request
function igk_conf_match($t, $n , $op){
	if (isset($t->$n)){
		switch($op->op){
			case "=":
				return $t->$n == $op->v;
			break;
			case "$":
				return igk_str_endwith($t->$n, $op->v);
				break;
			case "^":
				return igk_str_startwith($t->$n, $op->v);
			case "~":
				return strstr($t->$n, $op->v)!==null;
		}
	}
	return 0;
}

///<summary>get object with igkXpath selection model</summary>
function igk_conf_get($conf, $path, $default=null, $strict=0){
	// $g = explode("/", $path);
	// $q = $conf;
	$tab=null;
	$tobj = array();
	array_push($tobj, array('o'=>$conf, 'path'=>$path));
	$tout = null;
	$q = null;
	while($cq = array_pop($tobj)){
		$g = explode("/", $cq['path']);
		$q = $cq["o"];
		$count = 0;
		
		
		foreach($g as $k){
			$count++;
		if (preg_match_all("/^\[(?P<exp>(.)+)\]$/i", trim($k), $tab)>0){//is expression
			//igk_wln($tab);
			$o = igk_conf_get_expression($tab["exp"][0]);
			$m=null;
			
			// igk_wln($k. "+++".is_array($q));
			if (is_array($q)){				
				foreach($q as $s){
					$p = 1;
					foreach($o as $qt=>$qs){
						$p = $p && igk_conf_match($s , $qt,$qs);
						if (!$p)break;
					}
					if ($p){
						
						if ($m==null)
						$m = $s; //first item found
						// break;
						else {
							if (!is_array($m)){
								$m = array($m);
							}
							$m[] = $s;	
						}						
					}
				}
				// igk_debug_wln("matching....");
				// igk_debug_wln($m);
				// igk_assert_die(igk_is_debug(), "Done");
				// igk_debug_wln("");
				
				if ($m){
					
					// igk_debug_wln("found ...".igk_count($m) . " ".$count . " ".igk_count($g));
					// igk_assert_die(igk_is_debug(), "found ok");
					if ($count < igk_count($g)){
						$cpath = implode("/", array_slice($g, $count));
						if (is_array($m)){
							foreach($m as $mk=>$mv){
								array_push($tobj, array("o"=>$mv, "path"=>$cpath));
							}
						}else{
								array_push($tobj, array("o"=>$m, "path"=>$cpath));
						}
						$m = null;
						$q = null;
						break;
						//array_push($tobj, array('o'=>$conf, 'path'=>$path));
						// igk_die(__FUNCTION__. " Case not yet treated : ".$cpath);
					}					
					$q = $m;
					continue;
				}else{
					if ($strict){
						return $default;
					}
				}
				//continue with the first
				// igk_wln("continue with the first item found ".$k);
				$q = igk_getv($q,0);
				continue;

			}else{//not an array
				$p = 1;
				foreach($o as $qt=>$qs){
					$p = $p && igk_conf_match($q , $qt,$qs);
					if (!$p)break;
				}
				// igk_wln("matching .... ".$p. " m ".$m);
				if ($p)
					$m = $q;
				else{
					if ($strict)
						return $default;
					//continue with the first itemp found
					$m = $q;
				}
			}
			if ($m){
				$q = $m;
				continue;
			}
			return $default;
		}

		$q = igk_getv($q, $k);
		if ($q==null)
			return $default;
	}
	
		
		if ($q){//if q is set
			if ($tout === null){
				$tout = $q;
			}
			else if (!is_array($tout)){
				$tout = array($tout);
				$tout[] = $q;
			}
		}
	}
	return $tout;
}


///<summary>set object at igkXpath selection model</summary>
function igk_conf_set(& $obj, $data, $path){

	$c = explode("/", $path);
	$s = $obj;
	while( $q = array_shift($c)){
		$set = igk_count($c)==0;
		if ($set){
			$s->$q = $data;
			break;
		}
		if (!isset($s->$q))
			$s->$q = igk_createObj();
		$s = $s->$q;
	}
}
///<summary>unset all object found in igkXpath selection model</summary>
function igk_conf_unset(& $obj, $path){
	throw new IGKException("Not Implement ".__FUNCTION__);
}

///<summary>used to load configuration file.</summary>
///<doc>configuration file are xml file that store primary </doc>
function igk_conf_load_file($file, $tag="config"){
	$s = igk_io_read_allfile($file);
	return igk_conf_load_content($s, $tag);
}

function igk_conf_load_attribs(& $t, $d){
	if ($d->HasAttributes){
		foreach($d->Attributes as $k=>$s){
			$t[$k]=$s;
		}
	}
}
function igk_conf_load_content($s, $tag="configs", $deftext="text"){//load content as configuration

	$div =  igk_createXmlNode("dummy");
	$div->Load($s);
	$h = ($div->getElementsByTagName($tag));

	$d = igk_getv($div->getElementsByTagName($tag), 0);
	if ($d)
	{
		$t= array();
		igk_conf_load_attribs($t, $d);

		foreach($d->Childs as $k)
		{

			if ($k->Type == "HtmlText")
				continue;
			$n = $k->TagName;
			$o=null;

			if ($k->ChildCount<=0){
				$sk = $k->innerHTML;
				if ($k->HasAttributes){
					$o = igk_createObj();
					igk_conf_load($o, $k);
				}
				if (isset($t[$n])){
					if (!is_array($t[$n])){
						$t[$n] = array($t[$n]);
					}
					$t[$n][] = $o;
				}
				else{
				if ($o){

					if (!empty($sk))
						$o->{$deftext} = $k;
					$t[$n] = $o;
				}
				else if (!empty($sk))
					$t[$n] = $sk;
				}
			}else{
				$v_ob = igk_createObj();
				igk_conf_load($v_ob, $k);
				if (isset($t[$k->TagName])){
					if (!is_array($t[$k->TagName])){
						$t[$k->TagName] = array($t[$k->TagName]);
					}
					$t[$k->TagName][] = $v_ob;
				}else
					$t[$k->TagName] = $v_ob;
			}
		}
		return (object)$t;
	}
	return null;
}







///<summary>used to load configuration settings</summary>
///<param name="obj">output object</param>
///<param name="n">igk html node to load</param>
function igk_conf_load($obj, $n){
	if (!isset($n))
		return null;
	$tab = array();
	array_push($tab, (object)array("t"=>$obj, "n"=>$n));

	while($q = array_pop($tab)){
		if ($q->n->HasAttributes){
			foreach($q->n->Attributes as $m=>$mc){
				$q->t->{$m} = $mc;
			}
		}
		if ($q->n->ChildCount==1){
			if ($q->n->Childs[0]->TagName == "!CDATA"){
				$h = $q->n->TagName;
				$q->p->$h = $q->n->Childs[0]->Content;
				continue;
			}
		}
		//igk_debug_wln("for === ".$q->n->TagName);
		if ($attr = $q->n->Childs)
		foreach($attr as $k=>$v){
			//igk_debug_wln("for ".$v->TagName. " ". $v->ChildCount );
			if (($v->ChildCount <=0) && !$v->HasAttributes){
				$q->t->{$v->TagName} = $v->innerHtml;
			}else{
				$cb = igk_createObj();
				array_push( $tab, (object)array("t"=>$cb, "n"=>$v, "p"=>$q->t));

				if (isset($q->t->{$v->TagName}))
				{
					if (!is_array($q->t->{$v->TagName})){
						$q->t->{$v->TagName} = array($q->t->{$v->TagName});
					}
					$q->t->{$v->TagName}[] = $cb;
				}else
					$q->t->{$v->TagName} = $cb;
			}
		}
	}
}




//----------------------------------------------------------------------------------------------------------------
//STRING : FUNCTION UTILITY
//----------------------------------------------------------------------------------------------------------------
///<summary>shortcut to IGKString::IndexOf</summary>
function igk_str_index_of($str, $pattern, $offset=0){
	return IGKString::IndexOf($str, $pattern, $offset);
}

///<summary>glue data. to avoid implode function</summary>
function igk_str_glue($mix=","){
	$tab = array_slice(func_get_args(), 1);
	if (igk_count($tab)<=0)
		return null;
	$s = "";
	$fc = 0;
	if (is_string($mix))
		$fc = function($v, & $s=null){ return $v; };

	else if (is_callable($mix)){
		$fc = $mix;
		$mix="";
	}
	else
		return null;

	foreach($tab as $k=>$v){
		if (empty($v))continue;
		$h = $fc($v, $s);
		if (empty($s)){
			$s = $h;
		}else
			$s .=$mix.$h;
	}
	return $s;
}
function igk_str_endwith($chaine, $pattern){
		$chaine=trim($chaine);
		$c = strlen($chaine);
		$p = strlen($pattern);
		$i = strripos($chaine, $pattern);
		if ($i === false)
		{
			return false;
		}
		if (($i != -1) && ( ($i+$p)=== $c))
			return true;
		return false;
}

function igk_str_join($str1, $str2, $pattern)
{
	return $str1.$pattern.$str2;
}
function igk_str_join_tab($tab, $separator=',', $key=true){
	return IGKString::Join($tab, $separator, $key);
}
function igk_str_expr($str){
	$str = str_replace(".","\.", $str);
	return $str;
}
function igk_str_explode($array, $str)
{ //TODO : avoid recursion ovoid
	$t = array();
	if(count($array)>0)
	{
		$k = explode($array[0], $str);
		$array = array_slice($array, 1);
		foreach($k as $kt){
			$t = array_merge($t, igk_str_explode($array, $kt));
		}
	}
	else{
		$t[] = $str;
	}
	return $t;
}

function igk_str_array_rm_empty($tab){
	$o = array();
	foreach($tab as $k){
		if (empty($k))continue;
		$o[] = $k;
	}
	return $o;
}

function igk_str_summary($content, $length=150)
{
	if (strlen($content)>$length)
	{
		$content = substr($content,0, $length)."...";
	}
	return $content;
}
///<summary>used to retrieve pattern keys from path pattern expression</summary>
///<code>used in IGKUri</code>
function igk_str_get_pattern_keys($s){
	$tab = array();
	$t = array();
	$s = preg_match_all(
		"#:(?P<name>([a-z0-9]+))\+?#i",
		$s,
		$t
	);
	for($i=0; $i<$s; $i++)
	{
		$tab[] = $t["name"][$i];
	}
	return $tab;
}

function igk_str_split_lines($str){
	return preg_split("/(\r\n)|(\n)/i", $str);
}

///<summary>remove all line empty line</summary>
function igk_str_remove_empty_line($str){
	$t = preg_split("/(\r\n)|(\n)/i", $str);
	//$t = explode(IGK_CLF, $str);
	$o = IGK_STR_EMPTY;
	$i = 0;
	foreach($t as $k=>$v)
	{
		if (($v==null) || empty($v) || (strlen(trim($v)) == 0))
			continue;
		if ($i==1)
			$o .=IGK_CLF;
		$o .= $v;
		$i= 1;
	}
	return $o;
}
///<summary>remove line</summary>
function igk_str_remove_lines($str){
	$t = preg_split("/(\r\n)|(\n)|(\t)/i", $str);
	//$t = explode(IGK_CLF, $str);
	$o = IGK_STR_EMPTY;
	$i = 0;
	foreach($t as $k=>$v)
	{
		if (($v==null) || empty($v) || (strlen(trim($v)) == 0))
			continue;
		$o .= $v;
	}
	return trim($o);
}
///<summary>remove magic cote from message</summary>
function igk_str_quotes($content){

	if (ini_get("magic_quotes_gpc") && is_string($content))
	{
		 $content = stripcslashes($content);
	}
	return $content;
}
///<summary>remove all parttern</summary>
function igk_str_rm_last($str, $pattern)
{
	$c = strlen($pattern);
	while(IGKString::EndWith($str,$pattern))
	{
		$str = substr($str, 0, strlen($str)- $c);
	}
	return $str;
}

function igk_str_explode_upperCase($v){
		$o = array();
		$v = preg_replace_callback("/([a-z0-9]*)([A-Z])/", function($m) use (&$o){
			$c = count($o);
			if ( $c == 0)
			{
				$o[] = substr($m[0], 0, -1);
				$o[] = $m[2];
			}
			else {
				$o[$c-1] .= substr($m[0], 0, -1);
				$o[] = $m[2];
			}


			return "";
		}, $v);
		if (!empty($v)){
			$o[count($o)-1] .= $v;
		}
		return $o;
}
function igk_str_rm_start($str, $pattern)
{
	if ($pattern!=null)
	{
	$c = strlen($pattern);
	while( ($c >0) && IGKString::StartWith($str,$pattern))
	{
		$str = substr($str, $c);
	}
	}
	return $str;
}

///<summary>read value in branket</summary>
///<param name="s">search string</param>
///<param name="start">start branket in expression</param>
///<param name="end">end branket in expression</param>
function igk_str_read_in_brancket($s, $start, $end, & $tc_c=null)
{
	if (empty($s))
		return null;
    $g = array();
	//non recursive in brancket
	$xs = 0;
	$expr = array($s);

	while(count($expr)>0){
		$q = array_shift($expr);
		$i = strpos($q, $start);
	if (($i !== false) && ($i != -1))
	{
		//get depth outer string
		//next
		$r = IGKString::IndexOf( $q , $start, $i + 1);
		$rg =IGKString::IndexOf( $q, $end, $i + 1);

		if ($r == -1)
		{ //no more start breaked found
			$ln = $rg - $i - 1;
			if ($ln > 0)
				$g[] = substr($q , $i + 1, $ln);
		}
		else
		{
			//get end matching brancket
			$depth = 1;
			$kindex = $r;
			$mark = false;
			$offsets = array(); //(object)array("X"=>0,"Y"=>0);
			$bsegment = 0;
			for ($xs = $i + 1; $xs < strlen($s); $xs++)
			{
				if ($q[$xs] == $start)
				{
					$depth++;
					$offsets[] = (object)array("X"=>$xs,"Y"=>0); //.Add(new Vector2i(xs, 0));
					$bsegment = count($offsets);
					continue;
				}
				if ($s[$xs] == $end)
				{

					$depth--;
					if ($depth == 0)
					{
						$kindex = $xs;
						$mark = true;
						break;
					}
					$bsegment--;
					$tg = $offsets[$bsegment];
					$tg->Y = $xs;
					$offsets[$bsegment] = $tg;
				}
			}
			if ($mark)
			{
				$g[] = substr($s, $i + 1, $kindex - $i - 1);
				foreach ($offsets as $k=> $item)
				{
					$expr[] = substr($s, $item->X, $item->Y - $item->X + 1);
				}
			}
		}
	}


	}
	if ($tc_c!==null)
	$tc_c += $xs;	
	return $g;
}

///<summary>used to read in brank</summary>
///<param name="exp">expression</param>
///<param name="c">position offset </param>
///<param name="end">char end</param>
///<param name="start">char start </param>
///<param name="start">ln size to read</param>
///<param name="escaped">if end char must consider escape</param>
function igk_str_read_brank($exp,& $c, $end="]", $start="[", $ln=null, $escaped=0){
	// igk_ilog(__FUNCTION__);
	$iv = "";
	$ln = $ln ?? strlen($exp);
	$deep= -1;
	$litteral = $end==$start;
	if ($litteral){
		if ($exp[$c]==$start){
			$c++;
			$iv=$start;
		}

	}else{
		$escaped = 0;
	}

	//igk_debug_wln("dk");
	$g = 0;
	$eh = 0;
	while($ln>$c){
		$ch=$exp[$c];

		if (!$eh && !( ($ch !=$end) ||($deep>0)  ||($g = $eh)))//(($escaped && ($c>0) && ($exp[$c-1]=="\\"))))))
		{
			// igk_wln("fis ".$iv." d");
			break;
		}
		if ($eh){
			$eh=0;
		}else
			$eh = ($escaped) && $ch=="\\";

		$iv .= $ch;
		$c++;

		if (!$litteral && !$g){
			if ($ch==$start){
				$deep++;
			}else if ($ch == $end)
				$deep--;
		}
		$g=0;
	}

	// igk_wln("deepth : ".$deep);
	if (!empty($iv))
		$iv.=$end;
	return $iv;
}


///<summary> create and generate new id</summary>
function igk_new_id(){
	 return date('Hmi').md5(uniqid(rand()));
}
//MENU FUNCTION
/// retrive menu by name
function igk_menu_getmenu($name)
{
	return igk_getctrl(IGK_MENU_CTRL)->getMenu($name);
}
function igk_menu_option_i($tab, $level=1){
	$o = new StdClass();
	if (is_array($tab)){
		$o->key = igk_getv($tab, "key");
		$o->level = igk_getv($tab,"level");
	}
	else{
		$o->key = $tab;
		$o->level = $level;
	}
	return $o;
}
/// get the root menu of this item
function igk_menu_getRootMenu($name){
	return igk_getctrl(IGK_MENU_CTRL)->getRootMenu($name);
}
//retruve alla roots menus for special purpose
function igk_menu_getRoots(){
	return igk_getctrl(IGK_MENU_CTRL)->getRoots();
}




///-------------------------------------------------------------------------------------------------
///Reflexion utility function to trace eval error callback.
///-------------------------------------------------------------------------------------------------
function igk_reg_func_files($file, $tab){
	return igk_reg_file("sys://reflection/funcs", $file, $tab);
	// $fkey="sys://files";
	// $tkey="sys://functable";
	// $g = igk_get_env($key, function(){return array("sys://files"=>null); });
	// if (!isset($g[$fkey][$file])){
		// $idx = igk_count($g[$fkey]);
		// $g[$fkey][]= $file;
		// $gb = igk_getv($g,$tkey);
		// if (is_array($gb))
			// $g[$tkey] = array_merge($gb, igk_array_createkeyarray($tab, $idx));
		// else 
			// $g[$tkey] = igk_array_createkeyarray($tab, $idx);
		
		// // igk_wln($g);
		// igk_set_env($key, $g);	
		// return $idx;
	// }	
	// return -1;	
}
function igk_get_reg_func_file($functionname){
	return igk_get_reg_file("sys://reflection/funcs", $functionname);
	
	// $tkey="sys://functable";
	// $fkey="sys://files";
	// $g = igk_get_env($key);
	
	// if ($g && isset($g[$tkey][$functionname])){
		// return $g[$fkey][$g[$tkey][$functionname]];
	// }
	// return null;	
}



function igk_get_reg_class_file($className){
	return igk_get_reg_file("sys://reflection/class", $className);
}
function igk_reg_class_file($filename, $tab){
	return igk_reg_file("sys://reflection/class", $filename, $tab);
}

function igk_get_reg_file($key, $name){	
	$tkey="sys://functable";
	$fkey="sys://files";
	$g = igk_get_env($key);
	
	if ($g && isset($g[$tkey][$name])){
		return $g[$fkey][$g[$tkey][$name]];
	}
	return null;	
}
function igk_reg_file($key, $file, $tab){		
	$fkey="sys://files";
	$tkey="sys://functable";
	$g = igk_get_env($key, function(){return array("sys://files"=>null); });
	if (!isset($g[$fkey][$file])){
		$idx = igk_count($g[$fkey]);
		$g[$fkey][]= $file;
		$gb = igk_getv($g,$tkey);
		if (is_array($gb))
			$g[$tkey] = array_merge($gb, igk_array_createkeyarray($tab, $idx));
		else 
			$g[$tkey] = igk_array_createkeyarray($tab, $idx);			
		igk_set_env($key, $g);	
		return $idx;
	}	
	return -1;	
}


function igk_get_exception_eval($Ex, $traces=null){
	$content ="";	
	$traces = $traces  ?? $Ex->getTrace();
	if (strpos($Ex->getFile() , "eval()") !== false){
		if ($traces && ($tr = igk_getv($traces, 0))){
			
			$s = "";
			$c = igk_getv($tr,"class");
			if ($c){
				$s = "_class_:: ". igk_get_reg_class_file($c);
			}else{
				$s = igk_get_reg_func_file(strtolower($tr["function"]));
			}
			if ($s){
				$content .= "<li><b>Eval on file</b>: " .$s . ":".$Ex->getLine()."</li>";
			}
		}	
	}
	return $content;
}
function igk_show_exception($Ex, $file=null, $line=null)
{
	if (!$Ex)
		return;
	//ob_clean();
	// igk_wln("ajx demand ::: ?  ".igk_is_ajx_demand());
	// igk_wln(igk_get_allheaders());//,"IGK_X_REQUESTED_WITH")
	//e_xit;

	$content ="";
	$Ex->asource = "DATA is the base";
	
	
	$traces = $Ex->getTrace();
	
	// $content.="the file :".igk_get_env("evalfile");
	$content.= ("<h1>/!\\ IGK-Error</h1>");
	$content.= ("<div>");
	$content.= ("<i>".$Ex->getMessage()."</i><br/>");
	$content.= ("File : ".(($file !=null) ?$file: $Ex->getFile())."<br />");
	$content.= ("Line : ".(($line !=null) ? $line :  $Ex->getLine())."<br />");	
	$content.= igk_get_exception_eval($Ex, $traces);

	
	$content.= ("</div>");

	$content.= ("<div id=\"tracelist\" class=\"igk-tracelist\" style=\"overflow:hidden\" >");
	$content.= ("<h2 id=\"hd\">Trace :</h2>");
	$content.= ("<div style=\"overflow-x:auto; width:100%;\" >");
	$content.= ("<table style=\"min-width:450px;\" >");

	foreach($traces as $k=>$v)
	{
		if (isset($v["file"])){
			$content.=("<tr><td>File :</td><td> ".$v["file"] . "</td><td>".$v["line"]."</td><td>".igk_getv($v,"function")."</td></tr>");
		}else{
			$content.=("<tr><td>File :</td><td> &amp;</td><td>".igk_getv($v,"line","__INLINE__")."</td><td>".igk_getv($v,"function")."</td></tr>");
		}
	}
	$content .="</table>";
	$content .="</div>";
	$content .="</div>";

	$content .= ("<a href=\"?c=".IGK_SESSION_CTRL."&f=ClearS\" class=\"igk-btn\" style=\"padding:4px; display:inline-block; text-decoration:none; background-color:#ccc; color:#777;\">Clear session</a>");
	// show some errors
	$tab = array();
	$tab["fr"]["title.fatalError"]="Erreur fatale - BALAFON - IGKDEV";
	$r = function ($s)use($tab){
		return $tab["fr"][$s];//R::ngets($s);
	};
	$trace_css = igk_io_read_allfile(IGK_LIB_DIR."/Styles/trace.css");
	$balafon_js = igk_io_baseUri()."/Lib/igk/Scripts/igk.js";
	$doc = 0;
	$scripts = <<<EOF
	<script language="javascript" type="text/javascript" src="{$balafon_js}"></script>
<script language="javascript" type="text/javascript">
(function(){
	window.igk_init=function(){

		var q = document.getElementById("tracelist");
		//alert(q);
		var h = \$igk(q).select('#hd').getItemAt(0).o;
		h.onclick = function(){
			if (!/igk-active/.test(q.className)){
				\$igk(q).addClass("igk-active");
			}
			else{
				//remove
				\$igk(q).rmClass("igk-active");
			}
		};
	};
})();
</script>
EOF;

	if (igk_is_ajx_demand()){
		$doc=<<<EOF
{$scripts}
<style type="text/css">
{$trace_css}
</style>
<div class='error_view' style="padding-bottom:164px;" >
{$content}
</div>
<script language="javascript" type="text/javascript">window.igk_init(); </script>
EOF;
	}else{


	$doc = <<<EOF
<html>
<title>{$r('title.fatalError')}</title>
	{$scripts}
<style>
html, body{
	padding:0px;
	margin:0px;
	height:100%;
	width:100%;
}
body{
	background-color:#fefefe;
	overflow-y:auto;
}
table{
	background-color:#fefefe;
}
{$trace_css}
</style>
<body onload="javascript:window.igk_init(); return false;">
{$content}
</body>
</html>
EOF;


	}
	igk_set_header("404 not found");
	header("Content-Type: text/html");
	header("Cache-Control: no-cache");
	igk_wl($doc);
	igk_exit();
}
function igk_typeof($b)
{
	if ($b === null)
		return "null";
	if (is_string($b))
		return "string";
	if (is_object($b))
	{
		return get_class($b);
	}
	if (is_array($b))
		return "array";
	return "unknow";
}
function igk_throw_exception($file, $line)
{
	try{
		igk_die("custom_exception", $file, $line);
	}
	catch(Exception $Ex){
		igk_show_exception($Ex);
		igk_exit();
	}
}

function igk_support_noextension_script()
{
//write this in a htaccess files so that server will excecute file
//without extension as php script
//NOTE: server must support allow override property
$o = <<<EOF
AddHandler server-parsed .php
SetHandler Application/x-httpd-php
AddHandler Application/x-httpd-php .php
EOF;

$o .= <<<EOF
   <FilesMatch "[^\.]+|(\.ph(p3?|tml)$)">
        SetHandler Application/x-httpd-php
    </FilesMatch>
EOF;
return $o;

}

function igk_sys_is_root_doc($document){
	return $document && (igk_app()->Doc === $document);
}
///<summary>register to system </summary>
function  igk_css_reg_doc($ctrl){
	igk_app()->regCssController($ctrl);
}


///<summary>style function to bind file</summary>
function igk_bind_host_css_style_file($file, $doc, $host){
	$bvtheme = new IGKHtmlDocTheme($doc->Parent,"temp://files");
	$out ="";
	$sys = $doc->SysTheme;
	igkOb::Start();
	igk_css_bind_file($host, $file, $bvtheme );
	$m = igk_css_treat($sys, igkOb::Content());
	igkOb::Clear();
	if (!empty($m)){
		$out.=$m;
	}
	$o = "";
	if (!empty($out)){
		$o .= $out;
	}
	$o .= $bvtheme->get_css_def(false,false);
	return $o;
}
function igk_bind_host_css_style($doc){


	//load temporaty file theme
	$bvtheme = new IGKHtmlDocTheme($doc->Parent,"temp://files");

	//TODO: bind css and get invocation file
	$out = "";
	$g = $doc->Theme->getParam("css://temp/rendering"); //single temporary file

	if ($g){
		//include on
		$sys = $doc->SysTheme;

		foreach($g as $k=>$v){
			// igk_wln("the file  ".$k);
			igkOb::Start();
			igk_css_bind_file($v->host, $k, $bvtheme );
			$m = igk_css_treat($sys, igkOb::Content());
			igkOb::Clear();
			if (!empty($m)){
				$out.=$m;
			}
		}

		if (defined("IGK_FORCSS") && IGK_FORCSS){
			$doc->setParam("css://temp/rendering",null);
		}
	}
	$o = "";
	if (!empty($out)){
		$o .= $out;
	}
	$o .= $bvtheme->get_css_def(false,false);

	if (!empty($o)){

	$s = igk_createNode("style");
	$s["id"] = "tempsp";
	$s->Content = $o;
	return $s->Render();
	}
	return null;

}
///<summary>render default style</summary>
///<param name="tab">array of theme file</param>
///<param name="doc">document to render </param>
function igk_css_render_style($tab, $doc=null){
	igk_wln("render style ...");
	
	if (defined("IGK_FORCSS"))
		return "";
	$doc = $doc ?? igk_app()->Doc ?? igk_die("can't render css style");	
	$systh = $doc->SysTheme;
	$th = $doc->Theme;
	
	igk_css_bind_sys_global_files();
	igk_css_bind_theme_files($th);
	$o = "";
	
	foreach($tab as $k=>$v){
		$o.="{$k}{ ".igk_css_treat($th, $v, true)." }";
	}
	$th->resetAll();
	$systh->resetAll();
	return $o;
}

function igk_css_getdefaultstyle()
{
	$v = <<<ETF
*{ margin : 0px; padding: 0px; }
ETF;
return $v;
}

///<summary>convert string to igk css class name</summary>
function igk_css_str2class_name($s){
	$s = preg_replace_callback("/[^0-9a-z_]/i", function($m){
		return "_";
	},$s);
	$s = str_replace(" ", "_", $s);
	$s = str_replace(".", "-", $s);
	return $s;

}


///<summary>bind css file</summary>
///<param name="ctrl">the global controller used to bind the css theme file</param>
///<param name="f">access to file name</param>
///<param name="theme">for binding</param>
function igk_css_bind_file($ctrl, $f, $theme=null){
	if (defined("IGK_FORCSS"))
	//init parameter
	if ($theme==null){
		$key = "sys://css/IncludedFiled";
		$files = igk_get_env($key, array());

		$theme =igk_app()->Doc->Theme;
		$i = igk_env_count(__FUNCTION__);
		if ($i==1){	//first call on function must reset the Doc Theme
			$theme->resetAll();
			$files[$f]="root";
		}
		else{
			if (isset($files[$f]))
				return;
			$files[$f]="sub";
		}
		igk_set_env($key, $files);

	}
	//define media type
	//append custom theme
	$xsm_screen = $theme->get_media(IGKHtmlDocThemeMediaType::XSM_MEDIA);
	$sm_screen =  $theme->get_media( IGKHtmlDocThemeMediaType::SM_MEDIA);
	$lg_screen =  $theme->get_media( IGKHtmlDocThemeMediaType::LG_MEDIA);
	$xlg_screen =  $theme->get_media( IGKHtmlDocThemeMediaType::XLG_MEDIA);
	$xxlg_screen =  $theme->get_media( IGKHtmlDocThemeMediaType::XXLG_MEDIA);
	$PTR =  $theme->getPrintMedia();
	
	$css_m="";
	if ($ctrl){
		$n  = "";
		if (is_object($ctrl)){
			$n =  $ctrl->Name;
		}else 
			$n = $ctrl;
		//igk_ilog("found for : ".$n);
		$css_m = $n? ".".strtolower(igk_css_str2class_name($n)):'';		
		unset($n);
	}
	$def = $theme->def;
	// igk_wln("/*".$f."*/");
	include($f);
	// igk_wln($xsm_screen);
	//igk_exit();
}
function igk_css_set_from($n){
	// igk_ilog("set from : ".$n);
	igk_set_env("sys://css/from", $n);
}
function igk_css_get_from(){
	return igk_get_env("sys://css/from");
}
///<summary>bind css inline file</summary>
///<param name="f">real path to access to file name</param>
function igk_css_ob_get_tempfile($f, & $from=null){

	$vtemp = new IGKHtmlDocTheme(igk_app(), "theme://inline/tempfiles");

	igk_set_env(IGK_CSS_TEMP_FILES_KEY,1);
	IGKOb::Start();
	igk_css_bind_file(null,$f,$vtemp);
	$m = IGKOb::Content();
	$out ="";
	IGKOb::Clear();

	if (!empty($m)){
		$out.=$m;
	}
	$h = $vtemp->get_css_def(false, false);
	$out.=$h;
	igk_set_env(IGK_CSS_TEMP_FILES_KEY,null);
	$from = igk_css_get_from();//$vtemp->def->From;
	igk_css_set_from(null);
	//igk_ilog("form :::: ".$from);

	unset($vtemp);
	return $out;
}
///<summary>bind .pcss file for ajx content</summary>
function igk_css_ajx_bind_file($f){	

	$b = igk_get_env(IGK_AJX_BINDSTYLES, function(){
		return array();
	});
	
	//bind systheme flow
	if (!igk_get_env(__FUNCTION__)){
		//igk_ilog("bind system workflow");
		$vsystheme = igk_app()->Doc->getSysTheme();
		igk_css_bind_sys_global_files($vsystheme);
		igk_css_load_theme($vsystheme);	
		igk_set_env(__FUNCTION__, 1);
	}
	
	if (!isset($b[$f])){
		$o = igk_css_ob_get_tempfile($f, $from);
		igk_createNode("style")
		->setAttribute("type","text/css")
		->setAttribute("igk:from",$from)
		->setContent($o)->renderAJX();
		$b[$f]=1;
		igk_set_env(IGK_AJX_BINDSTYLES, $b);
	}
	
}
///<summary>bind extra style to document</summary>
function igk_css_bind_wuistyle($document, $ctrl, $type){
	$f = realpath($ctrl->getStyleDir().'/'.$type.'.pcss');
	if (!file_exists($f))
		return 0;
	igk_css_bind_wuistyle_file($document, $f);
	return 1;
}
function igk_css_bind_wuistyle_file($doc, $f){	
	if (igk_is_ajx_demand()){		
		igk_css_ajx_bind_file($f);
	}else{
		if($doc)
		$doc->Theme->addTemporaryFile($f);
	}
	return 1;
}


function igk_css_get_map_selector(){
	$igk = igk_app();
	$selector = array();

	foreach($igk->Doc->SysTheme->def->Attributes as $k=>$v){

		$tab = explode(',', $k);
		if (empty($v))
			continue;
		foreach($tab as $s=>$t)
		{

			if (!empty($t))
			{
				$selector[trim($t)] = $v;
			}
		}
	}

	foreach($igk->Doc->Theme->def->Attributes as $k=>$v){

		$tab = explode(',', $k);
		if (empty($v))
			continue;
		foreach($tab as $s=>$t)
		{

			if (!empty($t))
			{
				$selector[trim($t)] = $v;
			}
		}
	}
	return $selector;
}
function igk_css_get_style_from_map($node, & $options=null, $style=null){
	$s = null;
	if ($options)
	{
		if (isset($options->MapCssSelector))
		{
			$s =$options->MapCssSelector;
			igk_debug_wln("create used created map ");
		}
		else {

		 $options->MapCssSelector = igk_css_get_map_selector();
		 $s = $options->MapCssSelector;
		 igk_debug_wln("create map ");
		}
	}
	if ($s){

		$map = igk_get_selector_map($node);
		//igk_wln($map);
		// return null;
	//igk_debug( ($node->TagName=="a") && ($node["class"]->getValue() == "igk-btn") ); //($k == ".igk-mail .igk-btn") || ($k == ".igk-btn") );

		$style = $style==null? new IGKCssStyle() : $style;
		$level = count($map);
		foreach($s as $k=>$v)
		{
			$tlevel =igk_count(explode(" ", $k));
			if ($tlevel >$level)
				continue;

			// if (strstr($map[0],"igk-btn"))
			// {
				// igk_wln("map content btn ".$map[0]);
			// }

			// igk_wln("?match ".$k);
			if (preg_match($map[0],$k))
			{

				// igk_debug_wln("match .... ".$k. " ".$tlevel);
				// igk_debug_wln($map);

				$tab = array();
				$c = preg_match_all($map[igk_count($map)-1],$k, $tab);
				if ($c>0)
				{
					$st = $tab[0][0];
					//igk_debug_wln("good:".$st);

					if ($st == $k)
					{
						//igk_debug_wln("good: dd ".$st. " ".$v);
						$style->Load($v, $tlevel, $k);
					}

				}

				// if ($tlevel == 1){
					// $style->Load($v, $tlevel, $k);
				// }
				// else {
					// $ff=true;
					// for($kr=1; $kr<$level;$kr++)
					// {

						// if (!preg_match($map[$kr],$k)){
							// $ff = false;
							// break;
						// }
						// else {
						//	// $tab = array();
						//	// preg_match_all($map[$kr],$k, $tab);
						//	// igk_debug_wln("found match ... ".$kr);
						//	// igk_debug_wln($tab);
						// // }
					// }
					// igk_debug_wln("out match ... ".$kr);
					// if ($ff || (($kr<$level) && ($kr>1) && preg_match($map[$kr-1],$k)) ){
						//igk_debug_wln("load jjjj ".$k. " " .$v);
						// if ($k == ".igk-cnf-page .igk-cnf-menu li > a")
						// {
						//	igk_debug_wln(" data: ".$k. " pp maplevel ".$level. " | krlevel=".$kr . " ".$ff . " mapping:".$map[$kr-1]." ".preg_match($map[$kr-1],$k));
							//igk_wln($map);
						// }

						// $style->Load($v, $kr, $k);
					// }

				// }
			}
		}
		return $style->Render();
	}
	return null;
}
//css helper function in platform
function igk_css_getbg_size($v){//some definition : background size
		$o = IGK_STR_EMPTY;
		$o .="-webkit-background-size: ".$v.";";
		$o .="-o-background-size: ".$v.";";
		$o .="-moz-background-size: ".$v.";";
		$o .="background-size: ".$v.";";
		return $o;
	}

///<summary>get font definition utility</summary>
function igk_css_get_fontdef($name, $definition, $lineseparator=IGK_STR_EMPTY)
{
	$out = IGK_STR_EMPTY;
	$v = $definition;
	if (is_string($v))
	{
		$fdd = file_exists($v) ?igk_io_cwdRelativePath(realpath($v)) :  igk_io_cwdRelativePath(igk_io_syspath($v));
		if (file_exists($fdd))
		{
		$format = "truetype";
		$f = "@font-face{";
		// igk_io_basenamewithoutext(basename($fdd))
		$f .= "font-family: \"".$name."\"; ";
		$f .= "src: url('".igk_io_baseUri()."/".igk_html_uri($v)."') format(\"$format\")";
		$f .= "}";
		$out.= $f.$lineseparator;
		}
		else{
			igk_wl(IGK_START_COMMENT."/!\\ Font file not found.[".$fdd . IGK_END_COMMENT."]".$lineseparator);
		}
	}
	else{
		//font package
			$f = "@font-face{";
			$f .= "font-family: \"{$v->Name}\"; ";
			$tab = $v->Fonts;
			if (is_array($tab)){
				foreach($tab as $s=>$t){

					if (IGKValidator::IsUri($t->File)){
						$f .= "src: url('".$t->File."') format(\"{$t->format}\");";
						continue;
					}
					$ok = 0;
					$fdd="";
					if (file_exists($t->File)){
						$ok = 1;
						$fdd = igk_io_basePath($t->File);
					}else{
						$fdd = ($ok = file_exists(igk_io_syspath($t->File)))? $t->File : null;
// igk_wln($t->File);
// igk_wln($fdd);
// igk_wln(igk_io_cwdRelativePath($fdd));


						// $ok = file_exists(igk_io_cwdRelativePath($fdd)) && ($fdd=igk_io_basePath($fdd));
						// igk_wln($ok ."::".$fdd);
						//e_xit;
					}
					// igk_ilog($fdd);

					if ($ok)
					{
						$f .= "src: url('".igk_io_baseUri()."/".igk_html_uri($fdd)."') format(\"{$t->format}\");";
					}
					else{
						$f.="/* file {$fdd} not exists*/";
					}
				}
			}
			$f .= "}";
			$out.= $f.$lineseparator;
	}
	return $out;
}
//register default css class value
function igk_css_regclass($classname, $defaultvalue, $override=true)
{
	$igk = igk_app();
	if (($igk===null) || !IGKApp::IsInit())
		return;
	igk_css_reg_mediaclass($igk->Doc->Theme, $classname, $defaultvalue, $override);
}
///<summary>get system running context</summary>
function igk_current_context(){
	return igk_get_env(IGK_ENV_APP_CONTEXT, "initialize");
}
///<summary>register temporary global files</file>
function igk_css_reg_global_style_file($fname, $theme=null, $ctrl=null){
	$s = realpath($fname);
	$app = $ctrl!==null? "|".$ctrl->Name:"";
	// igk_ilog("is started ".igk_current_context(). " ".$fname);
	if (igk_current_context() !="initialize"){
		$doc = igk_app()->getDoc();
		if ($doc){
			$theme = $theme ??  $doc->getSysTheme();
			$f = igk_io_expand_path($theme->def->getFiles());
			$s.=$app;		
			if (empty($f) || (IGKString::IndexOf($f, $s) ===-1)){
				if(!empty($f))
					$s = ";".$s;				
				$theme->def->setFiles($f.$s);
			}
			return;
		}
	}
	if (file_exists($s)){
		if (igk_io_path_ext($s) == "pgcss"){
			$tab = igk_get_env("sys://css/file/global_files", array());
			$tab[$s] = 1;
			igk_set_env("sys://css/file/global_files",$tab);		
		}
	}
}
function igk_css_getmedia($id)
{
	$igk = igk_app();
	return $igk->Doc->Theme->get_media($id);
}
function igk_css_reg_mediaclass($th, $classname, $defaultvalue, $override=true)
{
	$igk = igk_app();
	if (($igk===null) || !$th || !IGKApp::IsInit())
		return;
	$s = $th[$classname];
	 if (empty($s))
	 {
		$th[$classname] = $defaultvalue;
	 }
	 else{
		if ($override){
			$th[$classname] = $defaultvalue;
		}
		else
		{
			$th[$classname] = $s.$defaultvalue;
		}
	}
}
///<summary>register font package</summary>
///<param name="fontname">the css name font-familly</param>
///<param name="file">basedir font path to existing font</param>
///<param name="document">the document that will bound the font. null if used global document</param>
///<param name="format">default format . TrueType</param>
function igk_css_reg_font_package($fontname, $file ,$document=null,  $format="TrueType"){
	if (empty($file))
	{
		return;
	}
	$igk = igk_app();
	$doc = $document == null? $igk->Doc : $document;
	$ft = $doc->Theme->Font;
	$r = igk_getv($ft, $fontname);
	if (($r == null) || !is_object($r))
	{
		$r = (object)array(
			"Name"=>$fontname,
			"Fonts"=>array()
		);
		$ft[$fontname] = $r;
	}
	$r->Fonts[$file] = (object)array("File"=> $file, "format"=>$format);
	$doc->Theme->def[".".$fontname] = "font-family: '".$fontname."';";
}
///<summary>unregister font package</summary>
function igk_css_unreg_font_package($fontname){
	$igk = igk_app();
	$ft = $igk->Doc->Theme->Font;
	$r = igk_getv($ft, $fontname);
	if ($r !== null){
		$ft[$fontname] = null;
	}
	$igk->Doc->Theme->def[".".$fontname] = null;//"font-family: '".$fontname."';";
}
///<summary>register color to current theme</summary>
function igk_css_regcolor($clname, $value, $global=0, $override=true)
{
	$igk = igk_app();
	if ($igk===null){
		return;
	}

	if ($global || (igk_get_env("sys://globalcolor")==1)){
		//igk_ilog("reg color ".igk_io_request_uri());
		// igk_set_env_keys("sys://css/themes/sys/colors", $clname, $value);
		$cl = & $igk->Doc->SysTheme->def->getCl();
		$cl[$clname] = $value;
		if (!$global)
			IGKGlobalColor::getInstance()->setGlobalColor($clname,$value);
	}else{
		// igk_set_env_keys("sys://css/themes/colors", $clname, $value);
		$cl = & $igk->Doc->Theme->def->getCl();
		if (!isset($cl[$clname]) ||($override)){
				$cl[$clname] = $value;
		}
	}
}
function igk_css_regpic($picname, $link)
{
	igk_getctrl(IGK_PIC_RES_CTRL)->regPicture($picname, $link);
}
function igk_css_get_style($classname){
	$igk = igk_app();
	if ($igk===null)
		return;
	  $b = $igk->Doc->Theme[$classname];
	if($b == null)
	{
		igk_debug_wln("/!\\ not found found in theme definition ".$classname);
		$b = $igk->Doc->SysTheme[$classname];
		if ($b)
		{
			$o = igk_css_treat($igk->Doc->SysTheme, $b);
			return $o;
		}
	}
	else{
			$o = igk_css_treat($igk->Doc->Theme, $b);
			return $o;
	}
	return IGK_STR_EMPTY;
}

function igk_css_get_color_value($clname, & $tab=null){
	$colors = & $tab;
	if ($tab ==null){
		$doc = null;
		if (defined("IGK_FORCSS"))
		{
			$doc = igk_get_last_rendered_document(); 			
		}
		
		$theme = ($doc ?? igk_app()->Doc)->Theme;
		$colors = & $theme->def->getCl(); //cl->Attributes->ToArray();
	}
	return igk_css_treatcolor( $colors, $clname);
}
function igk_css_get_color($clname, $defaultvalue=null){//get or register a color to global themes

	$t= igk_css_get_color_value($clname) ;
	if ($t)
		return $t;
	return $defaultvalue;
}
///<summary>used to register a media query to the default document</summary>
function igk_css_regmedia($mediaExpression){//
	$igk = igk_app();
	if ($igk===null)
		return;
	return $igk->Doc->Theme->reg_media($mediaExpression);
}
///<summary>shortcut to get system media</summary>
function igk_css_get_sys_media($id){
		$igk = igk_app();
	if ($igk===null)
		return;
	return $igk->Doc->SysTheme->get_media($id);
}

///<summary>shortcut to get theme media</summary>
function igk_css_get_media($id){
		$igk = igk_app();
	if ($igk===null)
		return;
	return $igk->Doc->Theme->get_media($id);
}
// // /<summary>get or know if this element is a know color or not </summary>
// function igk_css_is_know_color($cl) {
	// $igk = igk_app();
	// if ($igk===null)
		// return false;
	// return isset($igk->Doc->Theme->cl[$cl]);
// }
//@@ set or replace Append theme
function igk_css_append($name, $value)
{
	$igk = igk_app();
	if ($igk===null)return;
	$igk->Doc->Theme->Append[$name] = $value;
}

function igk_css_add_tempfont($doc, $name, $file,$format="TrueType"){

	$f = $doc->getTempTheme();
	//$f->resetAll();
	$ft = $f->Font;
	$r = igk_getv($ft, $name);
	if (($r == null) || !is_object($r))
	{
		$r = (object)array(
			"Name"=>$name,
			"Fonts"=>array(),
			"Def"=>"arial, sans-serif"
		);
		$ft[$name] = $r;
	}
	$r->Fonts[$file] = (object)array("File"=> $file, "format"=>$format);

	//$f->def[".".$name] = "font-family: '".$name."';";
	// $f->def["body"]="background-color:indigo !important;";

	// $p =  $f->get_css_def(0, 0);
	// igk_wln($p);
	// $f->RenderAJX();
	//e_xit;
}
//<summary>used to resolv color value</summary>
function igk_css_treatcolor(& $colors , $value, $defined=false){
	if (is_object($value)){
		igk_die("/!\\ object not allowed to be treated as color ");		
	}
	if (empty($value)){
		return $value;
	}
	$tabpush = array();
	$q = $value;
	$v = "";
	$reg2 = '/{\s*(?P<name>[\w_-]+)\s*\}/i';


	while($q){
		if (isset($tabpush[$q])){
			igk_ilog("admin: recursion detected for ".$value . " in [{$q}] please set a color for that value");			
			return "";
		}
		$tabpush[$q]=1;
		if (isset($colors[$q])){
			$q = $colors[$q];

		}else{
			//pattern {window_text_color} = will be replaced by it real color
			if ( ($c = preg_match_all($reg2,$q, $match)))
			{
				for($i = 0; $i<$c ; $i++)
				{
					$v_m = $match[0][$i];
					$type = $match['name'][$i];
					for($i = 0; $i<$c ; $i++)
					{
						$v_m = $match[0][$i];
						$v_n = trim($match["name"][$i]);
						$q = $v_n;
						//$value = str_replace($v_m, igk_css_treatcolor($colors, $colors[$v_n], true), $value);
					}
				}
			}else{
				// igk_wln("found ".$q);
				break;
			}
		}
	}
	return $q;

}


function igk_css_treatstyle($value){
	$igk = igk_app();
	if (empty($value) || !$igk  || ($igk->Doc==null))
		return $value;
	return igk_css_treat($igk->Doc->Theme, $value);
}

function igk_css_is_webknowncolor($cl, $theme=null){
	if (preg_match("/#([0-9a-f]{3}|[0-9a-f]{6})$/i", $cl)){
		return 1;
	}
	$tcl = $theme==null? igk_app()->Doc->SysTheme->cl: $theme;
	if (igk_css_get_color_value($cl,  $tcl)!=$cl)
		return 1;

	if (igk_get_env("igk_css_render_balafon_style")){

		$tab = igk_get_env(IGK_SESS_UNKCOLOR_KEY,array());
		$tab[$cl]=$cl;
		igk_set_env(IGK_SESS_UNKCOLOR_KEY,$tab);
	}
	// igk_wln($tcl->Render());
	//e_xit;
	// igk_wln($tcl[$cl]);
	return 0;

}

///<summary>treate a css theme. evaluate the expression</summary>
///<arg name="$theme">system theme reference expression</arg>
///<arg name="$v">style expression</arg>
function igk_css_treat($theme, $v, $themeexport=false)
{
	$_app = igk_app();
	if ($_app ==null)
		return;
	if (is_object($v)){
		return null;
	}
	
	//\s*(\w+)\s*:\s*([a-zA-Z0-9_]+)\s*\
	//regex for : [def:value]
	$reg = IGK_CSS_TREAT_REGEX;
	//regex for getting : {sys:properties, ...}
	$reg2 = IGK_CSS_TREAT_REGEX_2 ; //'/\{\s*(?P<name>[\w:\-_,\s]+)\s*\}\s*(;)* /i';
	//regex for link style heirarchie : (:style)  "/^\s*\(:(?P<name>([a-z0-9_\-])+)\)\s*$/i"
	$reg3 = IGK_CSS_CHILD_EXPRESSION_REGEX;
	$match = array();
	$systheme = $_app->Doc->getSysTheme();
	$gtheme = $_app->Doc->Theme;
	$d = & $systheme->def->getCl();//, "cl/Attributes");
	$gcl = ($d) ? $d : array();

	$c = 0;
	//child expression
	if ($c = preg_match_all($reg3, $v, $match))
	{
		for($i = 0; $i<$c ; $i++)
		{
			$n = $match[0][$i];
			//remove parent expression
			$v = str_replace($n, IGK_STR_EMPTY, $v);
		}
	}


	if ( ($c = preg_match_all($reg,$v, $match)))
	{
		for($i = 0; $i<$c ; $i++)
		{
		$v_m = $match[0][$i];

		$type = $match['name'][$i];
		$value = $match['value'][$i];
		$a ="";
		if (strstr($v_m,";"))
			$a =";";

		switch(strtolower($type))
		{
			case "fit":
				if (preg_match("/^(fill|contain|cover|none|scale-down)/i",$value)){
					$v = str_replace($v_m, "-webkit-object-fit: {$value};-ms-object-fit:{$value}; -moz-object-fit:{$value}; -o-object-fit: {$value}; object-fit: {$value};",$v);
				}else{
					$v = str_replace($v_m, "",$v);
				}
				break;
			case "trans": //for transition
				$v = str_replace($v_m, "-webkit-transition: {$value};-ms-transition:{$value}; -moz-transition:{$value}; -o-transition: {$value}; transition: {$value};",$v);
				break;
			case "lingrad": //for linear gradient ::: [direction , ] colors_stop1,colors_stop2 [,colors_stopX]
				$v_stand = $value;
				if (preg_match("/^(left|top|right|bottom)/i", trim($v_stand))){
					$v_stand = "to ".$v_stand;
				}
				$v = str_replace($v_m, "background: -webkit-linear-gradient({$value}); background:-ms-linear-gradient({$value}); background:-moz-linear-gradient({$value});background:-o-linear-gradient({$value}); background:linear-gradient({$v_stand});",$v);
				break;
			case "trans-prop": //for transition propertie
				$v = str_replace($v_m, "-webkit-transition-property: {$value};-ms-transition-property:{$value}; -moz-transition-property:{$value}; -o-transition-property: {$value}; transition-property: {$value};",$v);
				break;
			case "transform":
				$v = str_replace($v_m, "-webkit-transform: {$value};-ms-transition:{$value}; -moz-transition:{$value}; -o-transform: {$value}; transform: {$value};",$v);
				break;
			case "anim":
				$v = str_replace($v_m, "-webkit-animation: {$value};-ms-animation:{$value}; -moz-animation:{$value}; -o-animation: {$value}; animation: {$value};", $v);
				break;
			case "filter":
				$v = str_replace($v_m, "-webkit-filter: {$value};-ms-filter:{$value}; -moz-filter:{$value}; -o-filter: {$value}; filter: {$value};", $v);
				break;
			case "res"://inlude ressource picture file to css output
				if (is_file($value)){
						$v = str_replace($v_m,
						"background-image: url('".igk_io_baseUri($value)."');"
						,$v);
				}else{

				$vimg = R::GetImgResUri($value);
				$v = str_replace($v_m,
				( !empty($vimg) && !$themeexport? "background-image: url('".$vimg."');" : "")
				,$v);
				}
				// igk_wln(igk_io_baseUri(). " kkk: ".$vimg." ".$v ." ".$value);
				// $tv = igk_getctrl(IGK_PIC_RES_CTRL);
				// if ($tv)
				// {
					// igk_wln($tv->getImgUri($value, true));
				// }
				// else
					// igk_wln("pics controller is null");


			break;
			case "bgres":
					$v = str_replace($v_m,
					(!$themeexport?
				"background-image: url('".igk_io_baseUri()."/".igk_html_uri($value)."');" : ""),$v);
				break;
			case "uri":
			$v = str_replace($v_m,
			(!$themeexport?
				"url('".igk_io_baseUri()."/".igk_html_uri($value)."')": ""),$v);
				break;
			//---------------------------------------------------------------------------------------------------
			//---------------------------------------COLOR DEFINITION -------------------------------------------
			//---------------------------------------------------------------------------------------------------
			//system color
			case "sysbgcl":
				$ncl = igk_css_get_color_value($value, $gcl);
				$b =  ($ncl!=$value) || (($ncl==$value) && igk_css_is_webknowncolor($ncl)) ?igk_css_getbgcl($ncl) : "";
				$v = str_replace($v_m, $b, $v);
				break;
			case "sysfcl":
				// $v = str_replace($v_m,
				// igk_css_getfcl(igk_getv($theme->cl, $value,$value)), $v);
				$ncl = igk_css_get_color_value($value, $gcl);
				$b =  ($ncl!=$value) || (($ncl==$value) && igk_css_is_webknowncolor($ncl)) ?igk_css_getfcl($ncl) : "";
				$v = str_replace($v_m, $b, $v);
				break;
			case "sysbcl":
				// $ncl = igk_css_get_color_value($value, $gcl);
				// $v = str_replace($v_m,
				// igk_css_getbordercl($ncl),
				// $v);
				$ncl = igk_css_get_color_value($value, $gcl);
				$b =  ($ncl!=$value) || (($ncl==$value) && igk_css_is_webknowncolor($ncl)) ?igk_css_getbordercl($ncl) : "";
				$v = str_replace($v_m, $b, $v);
				break;
			case "syscl":
				//"/*{$value}*/initial"
				$ncl = igk_css_get_color_value($value, $gcl);
				if (($ncl == $value) &&!igk_css_is_webknowncolor($ncl) ){
					if (igk_sys_env_production()){
						$ncl='initial';
					}
					$cl = & $systheme ->def->getCl();
					$cl[$ncl]=$ncl;
				}
				//$v = str_replace($v_m, igk_getv($theme->cl, $value, "initial").$a, $v);
				$v = str_replace($v_m, $ncl.$a, $v);
				break;
			//global theme color
			case "fcl":
				$v = str_replace($v_m,
				igk_css_getfcl(igk_css_get_color($value)), $v);
			break;
			case "bgcl": //return background-color color
				$v = str_replace($v_m,   igk_css_getbgcl( igk_css_get_color_value($value)), $v);
			break;
			case "bcl": //return border-color
				$v = str_replace($v_m, igk_css_getbordercl(igk_css_get_color_value($value)), $v);
			break;
			case "cl"://get color from current theme
				$rp = igk_str_rm_last($v_m,';'); //str_replace(';','', $v_m);			
				$t = igk_css_get_color($value);
				$v = str_replace($rp, $t.' ', $v);
				break;
			//------------------------------------------------------------------------------------
			//----------------------------------------------font definition
			//------------------------------------------------------------------------------------
			case "ft"://return font-family if define in theme
				// if ( $theme->ft[$value]){
					// igk_wln("is theme ? ".($theme === $gtheme) . " | ". $systheme->ft[$value]);
					// igk_wln($systheme->ft);
					 // igk_wln($gtheme->ft);
					// igk_wln($theme->ft);
					// $fonts = $gtheme->getFont();
					// igk_wln($fonts);
					// igk_exit();
				// }
				$v = str_replace($v_m, ($theme !== $gtheme)  && $theme->ft[$value]?igk_css_getfont($value):null, $v);
			break;
			case "ftn"://return only the font name
				$h  = $theme->ft[$value]?$theme->ft[$value]: null;
				if ($h)
					$v = str_replace($v_m, "\"".$h."\"", $v);
				else
					$v = str_replace($v_m, IGK_STR_EMPTY, $v);
				break;
			case "pr"://get properties definitions
				$v = str_replace($v_m, $theme->properties[$value].";", $v);
				break;
			//------------------------------------------------------------------------------------
			//----------------------------------------------from custom palette color definition
			//------------------------------------------------------------------------------------
			case "palcl":
				$r = igk_get_palette();
				$v = str_replace($v_m, $r? igk_getv($r,$value):null,$v);
			break;
			case "palbgcl":
				$r = igk_get_palette();
				if ($r){
				$s = $r[$value];
				if (!empty($s))
					$v = str_replace($v_m, "background-color: ".$s.";", $v);
				else
					$v = str_replace($v_m, IGK_STR_EMPTY, $v);
				}
				else{
					$v = str_replace($v_m, IGK_STR_EMPTY, $v);
				 }

				break;
			case "palfcl":
				$r = igk_get_palette();
				$s = igk_getv($r,$value);
				if (!empty($s))
					$v = str_replace($v_m, "color: ".$s.";", $v);
				else
					$v = str_replace($v_m, IGK_STR_EMPTY, $v);
				break;

			default:
				$v = str_replace($v_m, IGK_STR_EMPTY, $v);
			break;
		}
		}

	}

	if ( ($c = preg_match_all($reg2,$v, $match)))
	{
		for($i = 0; $i<$c ; $i++)
		{
			$v_m = $match[0][$i];
			$type = $match['name'][$i];
			for($i = 0; $i<$c ; $i++)
			{
				$v_m = $match[0][$i];
				$v_n = trim($match["name"][$i]);
				if (isset($theme[$v_n])){
					//for single item
					$v = str_replace($v_m, igk_css_treat($theme, $theme[$v_n]), $v);
				}
				else{
					$rtab = explode(':', $v_n);

					if (count($rtab) == 2)
					{
						$v_from = strtolower(trim($rtab[0]));

						switch($v_from){
							case "sys":
								//retrieve sys params
								//comma separator expected
								$v_nn  = explode(',',trim($rtab[1]));
								$sk = IGK_STR_EMPTY;
								foreach($v_nn as $r){
									//replace with value
									$sk .= $systheme->def[".".trim($r)];
								}
								$sk = igk_css_treat($systheme, $sk);
								$v = str_replace($v_m, $sk, $v);
								break;
							default:
								//make null
								$v = str_replace($v_m, null, $v);
								break;
						}
					}
					else {
						//no definition
						//for default item
							$v_nn  = explode(',',trim($v_n));
							$sk = IGK_STR_EMPTY;
							$rv = IGK_STR_EMPTY;
							foreach($v_nn as $r)
							{
								$mk = trim($r);
								$sk .= $gtheme->def[$mk];
								$rv .= igk_css_treat($theme, $gtheme->def[$mk], IGK_STR_EMPTY);
							}
						$v = str_replace($v_m, $rv, $v);
					}
				}
			}
		}
	}
	return $v;
}



function igk_css_getbgcl($v){
	if (empty($v))
		return null;
	$theme = igk_app()->Doc->Theme;
	$h = igk_css_treat($theme, $v);
	if ($h==null)
		return null;
	return "background-color: ".$v.";";
}
function igk_css_getbordercl($v){
	if (empty($v))
		return null;
	return "border-color: ".$v.";";
}
function igk_css_getfcl($v)
{
	if (empty($v))
		return null;
	$theme = igk_app()->Doc->Theme;
	$h = igk_css_treat($theme, $v);
	if ($h){
		return "color: ".$h.";";
	}
	else{
		return "color: ".$v.";";
	}
}
function igk_css_getfont($v)
{
	if (empty($v))
		return null;
	return "font-family: \"".$v."\";";
}



///<return> the value of the key if found in the current theme</return>
function igk_css_get_cl($key){
	$theme = igk_app()->Doc->SysTheme;
	return igk_getv($theme->cl, $key);
}

function igk_css_reg_reset(){
	$igk = igk_app();
	$def = $igk->Doc->SysTheme->def;
	$def->resetParams();
}
//register for symbols file
function igk_css_reg_svg_symbol_files($file){
	if (!file_exists($file))
		return;
	$igk = igk_app();
	$s = $igk->Doc->SysTheme->def->getParam("::igk-svg-symbols");
	if ($s == null)
		$s = array();
	$s[$file] = $file;
	$igk->Doc->SysTheme->def->setParam("::igk-svg-symbols",$s);

}



///<summary>get css document style definition</summary>
function igk_css_get_doc_style_def($doc, $minfile, $themeexport){

$o = IGK_STR_EMPTY;

if ($doc === null)
{
	$o .= IGK_START_COMMENT."balafon.css document theme not found ? is init ".IGKApp::IsInit()." ".session_id()." ".IGK_END_COMMENT;
	return $o;
}
$theme = $doc->Theme;
//eval script files
if($theme->files){
	igk_css_bind_theme_file($theme, $theme->files);
}
$el = $minfile ? IGK_STR_EMPTY: "\n";
$v_name = $doc->getParam(IGK_DOC_ID_PARAM);
if (!$minfile)
$o .= IGK_START_COMMENT." THEME For Document [".$v_name."] ".IGK_END_COMMENT.$el;
//render define theme
$o .= $theme->get_css_def($minfile,$themeexport);
return $o;
}

function igk_css_init_style_def_workflow($doc){
	//in process workflow 
	$theme = $doc->Theme;	
	$v_name = $doc->getParam(IGK_DOC_ID_PARAM);
	
	
	if($theme && ($file = $theme->def->getFiles())){
		igk_css_bind_theme_file($theme, $file);
		$theme->def->clearFiles();
	}		
	return array("name"=>$v_name, "theme"=>$theme);
}

function igk_css_bind_theme_file($th , $files){
	$f = igk_io_expand_path($files);
	$lfile = explode(";", $f);
	$v_lfiles = array(); //protection to load file once.
	
	
	foreach($lfile as $d){
		list($file, $ctrl) = explode('|', $d);		
		if (!isset($v_lfiles[$file]) &&  !empty($d) && file_exists($file)){		
			igk_css_bind_file(igk_getctrl($ctrl) ?? $ctrl, $file, $th);
			$v_lfiles[$file]=1;
		}
	}

}
///
///<summary>return all css-style definition</summary>
///
// function igk_css_getbasedef($minfile=false, $themeexport=false)
// {
// $igk = igk_app();
// $o = IGK_STR_EMPTY;
// $doc = $igk->Doc;
// $el = $minfile ? IGK_STR_EMPTY: "\n";

// //global theme
// // $o .= "/* global ::::  doc is null ".($doc ===null)."*/";
// $o .= $doc !==null?
// $doc->SysTheme->get_css_def($minfile,$themeexport) .$el.
// igk_css_get_doc_style_def($doc, $minfile, $themeexport): null;

// $o .= IGK_START_COMMENT." TEMPORARY STYLES ".IGK_END_COMMENT.$el;
// $o .= $doc->getTemporaryCssDef($minfile, $themeexport,0); //get temporary for global document


// //load temporaty file theme
// $bvtheme = new IGKHtmlDocTheme($igk,"temp://files");

// // igk_ilog("load in ".$doc->theme->Id);


// foreach($doc->theme->Files as $k=>$v){

	// $f = $v["file"];
	// $host = $v["host"];//controller that will be host
	// // igk_ilog("beffr bind host file : {$f} ?? ".file_exists($f) );
	// if (file_exists($f) && $host){
		// // igk_ilog("bind host file : {$f}");
		// //ob_clean();
		// igkOb::Start();
		// igk_css_bind_file($host, $f, $bvtheme);
		// //include($f);
		// $m = igk_css_treat($doc->SysTheme, igkOb::Content());
		// igkOb::Clear();
		// if (!empty($m)){
			// $m.=$el;
		// if (!$minfile){
			// $o .= IGK_START_COMMENT." CUSTOM THEME FROM  {$f} ".IGK_END_COMMENT.$el;
		// }
		// $o.=$m;
		// }
		// //$o .= $theme->get_css_def($minfile,$themeexport);
	// }
// }
// $o.= $bvtheme->get_css_def($minfile,$themeexport) .$el;



// $c = igk_getctrl(IGK_THEME_CTRL);
// if ($c)
// {
	// $h = $c->themeGetCss();
	// if ($h)
	// {
		// if (!$minfile)
			// $o .= IGK_START_COMMENT." APPICATION THEME STYLES ".IGK_END_COMMENT.$el;
		// $o .= $h;
	// }
	// else{
	// if (!$minfile)
		// $o .= IGK_START_COMMENT." THEME FOR IGK_THEME_CTRL->themeGetCss() is empty ".IGK_END_COMMENT.$el;
	// }
// }
// else{
	// if (!$minfile)
		// $o .= IGK_START_COMMENT." NO THEME CTRL ".IGK_END_COMMENT.$el;
// }

// $rdoc = igk_get_last_rendered_document();
// if ($rdoc && !igk_doc_is_global($rdoc)){

	// $o.= igk_css_get_doc_style_def($rdoc, $minfile, $themeexport);
	// // $o .= "/*temporary*/";
	// $o .= $rdoc->getTemporaryCssDef($minfile, $themeexport); //temporary for current document
// }
// return $o;

// }

///change css process workflow : 08/02/2018
function igk_css_getbasedef($minfile=false, $themeexport=false)
{
	
	$igk = igk_app();
	$o = IGK_STR_EMPTY;	
	$srh = array();
	$doc = $igk->Doc;
	$el = $minfile ? IGK_STR_EMPTY: "\n";
	$data = array();
	
	$s= array("name"=>"systheme","theme"=>$doc->SysTheme);
	//push system theme
	$data[]=$s;
	//int doc workflow
	$s = igk_css_init_style_def_workflow($doc);
	$data[] = $s;
	
	
	
	//1. bind files
	$rdoc = igk_get_last_rendered_document();
	if ($rdoc && !igk_doc_is_global($rdoc)){

		$s = igk_css_init_style_def_workflow($rdoc);
		$data[] = $s;		
		// $vo = igk_css_get_doc_style_def($rdoc, $minfile, $themeexport);
		// //temporary
		// $vo .= $rdoc->getTemporaryCssDef($minfile, $themeexport); //temporary for current document
		// $srh[] = $vo;
	}
	
	foreach($data as $k=>$v){		
		$theme = $v["theme"];
		$name = $v["name"];
		$o = "";
		if (!$minfile)
			$o .= IGK_START_COMMENT." CSS. For Document - [".$name."] ".IGK_END_COMMENT.$el;
		//render define theme
		$o .= $theme->get_css_def($minfile,$themeexport).$el;


		$srh[] = $o;
		if (isset($v["doc"])){
			$srh[] = $v["doc"]->getTemporaryCssDef($minfile, $themeexport).$el;
		}
		
	}	
	$o = implode("", $srh);
	
	
		
	//load temporaty file theme
	$bvtheme = new IGKHtmlDocTheme($igk,"temp://files");

	// igk_ilog("load in ".$doc->theme->Id);

	foreach($doc->theme->Files as $k=>$v){

		$f = $v["file"];
		$host = $v["host"];//controller that will be host
		// igk_ilog("beffr bind host file : {$f} ?? ".file_exists($f) );
		if (file_exists($f) && $host){
			// igk_ilog("bind host file : {$f}");
			//ob_clean();
			igkOb::Start();
			igk_css_bind_file($host, $f, $bvtheme);
			//include($f);
			$m = igk_css_treat($doc->SysTheme, igkOb::Content());
			igkOb::Clear();
			if (!empty($m)){
				$m.=$el;
			if (!$minfile){
				$o .= IGK_START_COMMENT." CUSTOM THEME FROM  {$f} ".IGK_END_COMMENT.$el;
			}
			$o.=$m;
			}
			//$o .= $theme->get_css_def($minfile,$themeexport);
		}
	}
	$o.= $bvtheme->get_css_def($minfile,$themeexport) .$el;
	$c = igk_getctrl(IGK_THEME_CTRL);
	if ($c)
	{
		$h = $c->themeGetCss();
		if ($h)
		{
			if (!$minfile)
				$o .= IGK_START_COMMENT." APPICATION THEME STYLES ".IGK_END_COMMENT.$el;
			$o .= $h;
		}
		else{
		if (!$minfile)
			$o .= IGK_START_COMMENT." THEME FOR IGK_THEME_CTRL->themeGetCss() is empty ".IGK_END_COMMENT.$el;
		}
	}
	else{
		if (!$minfile)
			$o .= IGK_START_COMMENT." NO THEME CTRL ".IGK_END_COMMENT.$el;
	}
	return $o;
	
}



///<summary>store no color def </summary>
function igk_css_store_no_colordef($f){

$tab = igk_get_env("sys://not_get_colors");
if (igk_count($tab)>0){
$o="";
foreach($tab as $k=>$v){
	if (!empty($o))
		$o.="\n";
	$o.= "igk_css_regcolor(\"{$v}\", \"transparent\");";
}
igk_io_save_file_as_utf8_wbom($f, $o, true);
}
}

function igk_css_header_comment(){
	$const = "constant";
$o = <<<EOF
Author: {$const('IGK_AUTHOR')}
Contact : {$const('IGK_AUTHOR_CONTACT')}
Copyright: {$const('IGK_COPYRIGHT')}
EOF;
return $o;
}
///<summary> register global font to current document</summary>
function igk_css_regfont($doc, $name, $path){
	$doc->Theme->addFont($name, $path);
}
function igk_css_regglobalfont($doc){
	igk_css_regfont($doc, "global", igk_io_basePath( IGK_LIB_DIR."/Default/R/Fonts/global.ttf"));
}

function igk_get_palette($palname="default")
{
	$cp = igk_getctrl(IGK_PALETTE_CTRL);
	if ($cp == null)
	{
		return null;
	}
	$p = $palname=="default"? igk_getv(igk_app()->Configs, "CurrentPaletteName", "default") : $palname;
	return igk_getv( $cp->Palettes, $p, null);
}

///<summary>get GET value</summary>
function igk_getg($key, $value=null){
	return igk_getrequest($_GET, $key, $value);
}

///<summary>get session param value</summary>
function igk_gets($key, $value=null){
	return igk_getrequest($_SESSION, $key, $value);
}
///<summary> get request value</value>
function igk_getr($key, $value=null){
	return igk_getrequest($_REQUEST, $key, $value);
}
///<summary>get a check POST value</summary>
function igk_getp($key, $value=null){
	return igk_getrequest($_POST, $key, $value);
}
function igk_getrequest($tab, $key, $value=null)
{
	if (is_object($key))
		return $value;
	if (isset($tab[$key]))
	{
		$t = $tab[$key];
		if (!is_array($t))
			return igk_str_quotes($t);
		return $t;
	}
	return $value;
}

function igk_getr_k($tab, $inTab=null){
	$o = array();
	$inTab = $inTab ?? $_REQUEST;
	foreach($tab as $k){
		$o[$k] = igk_getv($inTab, $k);
	}
	return (object)$o;

}
///get request object value
function igk_getru($key, $value=null)
{
	if (is_object($key))
		return $value;
	if (isset($_REQUEST[$key]))
			return str_replace("-","_", igk_str_quotes($_REQUEST[$key] ));
	return $value;
}
//get default value
function igk_getdv($v, $default=null)
{
	if (isset($v))
		return $v;
	return $default;
}
///<summary>retreive requested object as object</summary>
///<param name="callbackfilter">callable that will filter the request available key</param>
function igk_get_robj($callbackfilter=null, $replace=0)
{
	//object that name will start with cl
	//if string and $replace=1 then we must relace the
	$t = array();
	if ($callbackfilter === null){
		$callbackfilter = function(& $k, $rp){
			$rgx = "/^cl/i";
			$p= preg_match($rgx,$k);
			if($p && $rp)
				$k = preg_replace($rgx, "", $k);
			return $p;
		};
	}else{
		if (is_string($callbackfilter)){
			$m = $callbackfilter;
			$callbackfilter = function(& $k, $rp)use($m){
				//$k="cl___info__".$k;
				$rgx = "/".$m."/i";
				$p= preg_match($rgx,$k);
				if($p && $rp){
					// $tab =array();
					// preg_match_all($rgx,  $k, $tab);
					// igk_wln($tab);
					// igk_exit();
					$k = preg_replace($rgx, "", $k);
				}
				return $p;

			};
		}
	}
	foreach($_REQUEST as $k=>$v)
	{
		if ($callbackfilter($k, $replace))//IGKString::StartWith($k,"cl"))
		{
			$t[$k] = igk_str_quotes($v);
		}
	}
	return (object)$t;
}

///<summary>get controller parameter shorcut</summary>
function igk_get_cp($ctrl, $name, $reset=1){
	($n = $ctrl->getParam($name)) && $reset && $ctrl->setParam($name, null);
	//sample:
	//($inf = $this->getParam("taskinfo")) &&  $this->setParam("taskinfo", null);
	
	return $n;
}

//reset request
function igk_resetr()
{
	$_REQUEST = array();
}
//load request uri
function igk_loadr($uri)
{
	if (count($uri) == 0)
		return;
	//uri
	$tab = array();
	$t = parse_url($uri);
	$q  = $t["query"];
	parse_str($q, $tab);
	$_REQUEST = $tab;
}
/// get request array
function igk_getrs(){
	return $_REQUEST;
}
function igk_qr_confirm()
{
	return (igk_getr("confirm", 0) == 1);
}

///<summary>used to save request</summary>
function igk_qr_save($tab){
	$v = igk_get_env("sys://store/request", array());
	array_push($v, $_REQUEST);
	igk_set_env("sys://store/request", $v);
	$_REQUEST = $tab;
	return $v;
}
///<summary>used to restore request</tab>
function igk_qr_restore(){
	$v = igk_get_env("sys://store/request");
	if ($v && (igk_count($v)>0)){
		igk_wln($v);
		igk_wln("op");

		$_REQUEST = array_pop($v);
	}
	return $_REQUEST;
}
/// get object property value
function igk_getprop($obj, $prop)
{
	if ($obj == null)
		return;
	return $obj->$prop;
}
/// set a request key=>$value
function igk_setr($key,$value)
{
	$_REQUEST[$key] = $value;
}




function igk_ansi2utf8($text)
{
$text = str_replace("¡","\xc2\xa1",$text);
$text = str_replace("¢","\xc2\xa2",$text);
$text = str_replace("£","\xc2\xa3",$text);
$text = str_replace("¤","\xc2\xa4",$text);
$text = str_replace("¥","\xc2\xa5",$text);
$text = str_replace("¦","\xc2\xa6",$text);
$text = str_replace("§","\xc2\xa7",$text);
$text = str_replace("¨","\xc2\xa8",$text);
$text = str_replace("©","\xc2\xa9",$text);
$text = str_replace("ª","\xc2\xaa",$text);
$text = str_replace("«","\xc2\xab",$text);
$text = str_replace("¬","\xc2\xac",$text);
$text = str_replace("­","\xc2\xad",$text);
$text = str_replace("®","\xc2\xae",$text);
$text = str_replace("¯","\xc2\xaf",$text);
$text = str_replace("°","\xc2\xb0",$text);
$text = str_replace("±","\xc2\xb1",$text);
$text = str_replace("²","\xc2\xb2",$text);
$text = str_replace("³","\xc2\xb3",$text);
$text = str_replace("´","\xc2\xb4",$text);
$text = str_replace("µ","\xc2\xb5",$text);
$text = str_replace("¶","\xc2\xb6",$text);
$text = str_replace("·","\xc2\xb7",$text);
$text = str_replace("¸","\xc2\xb8",$text);
$text = str_replace("¹","\xc2\xb9",$text);
$text = str_replace("º","\xc2\xba",$text);
$text = str_replace("»","\xc2\xbb",$text);
$text = str_replace("¼","\xc2\xbc",$text);
$text = str_replace("½","\xc2\xbd",$text);
$text = str_replace("¾","\xc2\xbe",$text);
$text = str_replace("¿","\xc2\xbf",$text);
$text = str_replace("À","\xc3\x80",$text);
$text = str_replace("Á","\xc3\x81",$text);
$text = str_replace("Â","\xc3\x82",$text);
$text = str_replace("Ã","\xc3\x83",$text);
$text = str_replace("Ä","\xc3\x84",$text);
$text = str_replace("Å","\xc3\x85",$text);
$text = str_replace("Æ","\xc3\x86",$text);
$text = str_replace("Ç","\xc3\x87",$text);
$text = str_replace("È","\xc3\x88",$text);
$text = str_replace("É","\xc3\x89",$text);
$text = str_replace("Ê","\xc3\x8a",$text);
$text = str_replace("Ë","\xc3\x8b",$text);
$text = str_replace("Ì","\xc3\x8c",$text);
$text = str_replace("Í","\xc3\x8d",$text);
$text = str_replace("Î","\xc3\x8e",$text);
$text = str_replace("Ï","\xc3\x8f",$text);
$text = str_replace("Ð","\xc3\x90",$text);
$text = str_replace("Ñ","\xc3\x91",$text);
$text = str_replace("Ò","\xc3\x92",$text);
$text = str_replace("Ó","\xc3\x93",$text);
$text = str_replace("Ô","\xc3\x94",$text);
$text = str_replace("Õ","\xc3\x95",$text);
$text = str_replace("Ö","\xc3\x96",$text);
$text = str_replace("×","\xc3\x97",$text);
$text = str_replace("Ø","\xc3\x98",$text);
$text = str_replace("Ù","\xc3\x99",$text);
$text = str_replace("Ú","\xc3\x9a",$text);
$text = str_replace("Û","\xc3\x9b",$text);
$text = str_replace("Ü","\xc3\x9c",$text);
$text = str_replace("Ý","\xc3\x9d",$text);
$text = str_replace("Þ","\xc3\x9e",$text);
$text = str_replace("ß","\xc3\x9f",$text);
$text = str_replace("à","\xc3\xa0",$text);
$text = str_replace("ý","\xc3\xbd",$text);
$text = str_replace("þ","\xc3\xbe",$text);
$text = str_replace("ÿ","\xc3\xbf",$text);
$text = str_replace("ä","\xc3\xa4",$text);
$text = str_replace("å","\xc3\xa5",$text);
$text = str_replace("æ","\xc3\xa6",$text);
$text = str_replace("ç","\xc3\xa7",$text);
$text = str_replace("è","\xc3\xa8",$text);
$text = str_replace("é","\xc3\xa9",$text);
$text = str_replace("ê","\xc3\xaa",$text);
$text = str_replace("ë","\xc3\xab",$text);
$text = str_replace("ì","\xc3\xac",$text);
$text = str_replace("í","\xc3\xad",$text);
$text = str_replace("î","\xc3\xae",$text);
$text = str_replace("ï","\xc3\xaf",$text);
$text = str_replace("ð","\xc3\xb0",$text);
$text = str_replace("ñ","\xc3\xb1",$text);
$text = str_replace("ò","\xc3\xb2",$text);
$text = str_replace("ó","\xc3\xb3",$text);
$text = str_replace("ô","\xc3\xb4",$text);
$text = str_replace("õ","\xc3\xb5",$text);
$text = str_replace("ö","\xc3\xb6",$text);
$text = str_replace("÷","\xc3\xb7",$text);
$text = str_replace("ø","\xc3\xb8",$text);
$text = str_replace("ù","\xc3\xb9",$text);
$text = str_replace("ú","\xc3\xba",$text);
$text = str_replace("û","\xc3\xbb",$text);
$text = str_replace("ü","\xc3\xbc",$text);
return $text;
}


///<summary>Retrieve all default page controller</summary>
function igk_get_all_default_pagectrl()
{
	$igk = igk_app();
	if ($igk==null)return;
	$t = array();
	foreach($igk->getControllerManager()->getControllers() as $k)
	{
		//get controllers
		$cl = get_class($k);
		$v_rc = new ReflectionClass($cl);
		if ($v_rc->isAbstract() || !igk_reflection_class_extends($cl, IGK_CTRLWEBPAGEBASECLASS ) )
			continue;
		$t[] = $k;
	}
	return $t;
}
///<summary>Retrieve all user uri page controller</summary>
function igk_get_all_uri_page_ctrl(){
	$t = array(
	"@base"=>
	igk_app()->getControllerManager()->getUserControllers(function($v){
		return igk_reflection_class_implement($v,"IIGKUriActionRegistrableController");
	}),
	"@templates"=>igk_template_get_ctrls()
	);
	return $t;
}

function igk_get_all_user_page_ctrl(){
	return igk_app()->getControllerManager()->getUserControllers();
}

function igk_csv_sep()
{
	$s = igk_get_uvar(IGK_CSV_SEPARATOR,",", true);
	if (!empty($s))
		return $s;
	return ",";

}
///<summary>return a csv entry for a value data</summary>
function igk_csv_getvalue($v){
	return IGKCSVDataAdapter::GetValue($v);
}
function igk_csv_get_value_array($tab){
	$o = "";
	$i=0;
	foreach($tab as $k=>$v){
		if ($i){
			$o .= igk_csv_sep();
		}else $i=1;
		$o.= igk_csv_getvalue($v);
	}
	return $o;
}
///<summary>create a formatted string data object by retreive the {index} with args</summary>
function igk_get_string_format($str)
{
	$n = null;
	$tab = func_get_args();
	if (defined("__NAMESPACE__"))
		$n =  __NAMESPACE__ .'IGKFormatString::Create';
	else
		$n = 'IGKFormatString::Create';

	return call_user_func_array($n, $tab) ;

}
function igk_get_string_propvalue($obj, $property)
{
	return IGKFormatGetValueString::Create($obj, $property);
}
//<summary>get user variables</summary>
function igk_get_uvar($name, $default=null, $reg=false, $comment=null)
{
	if (empty($name))
		return $default;
	$ctrl = igk_getctrl(IGK_USERVARS_CTRL);
	if ($ctrl == null)
		return $default;
	$t = igk_getv($ctrl->Vars, $name);
	if ($t)
		return $t["value"];
	if ($reg && $ctrl)
	{
		$ctrl->regVars($name,$default,$comment);
		$ctrl->__storeVars();
	}
	return $default;
}

function igk_notify_error($msg)
{
	$ctrl = igk_notifyctrl();
	if ($ctrl!= null)
	{
		$ctrl->addError($msg);
	}
	else{
		igk_wln("<div class=\"igk-notify-box igk-notify-box-error\" >".$msg."</div>");
	}
}
///<summary>used to render directory an message for box notification </summary>
function igk_notifybox_ajx($msg)
{
	igk_wln("<div class=\"igk-notify-box\" >".$msg."</div>");
}

function igk_notifybox(){
	return igk_getctrl(IGK_SHARED_CONTENT_CTRL)->getEntity("notifybox");
}


///<summary> get value in array</summary>
///<param name="default"> mixed, default value or callback expression </param>
function igk_getv( $array, $key, $default= null)
{
if ($array===null)
	return $default;
if ($key===null){
	igk_die(__FUNCTION__." key not defined");
}
	$r = null;
	$def = $default;
	if (is_object($array) && isset($array->$key))
			return $array->$key;
	if (is_array($array))
	{
		if (isset($array[$key]))
			return $array[$key];
		if (($def!=null) && igk_is_callable($def)){ // updated to avoid igk_is_callable call nested
			$m = call_user_func_array($def, array());
			$array[$key] = $m;
			return $m;
		}
	}
	else if (is_object($array))
	{
		$cl = get_class($array);
		$t = class_implements($cl); //get class implementations
		if (isset($t["ArrayAccess"]))
		{
			$r = $array[$key];
			return $r?$r:$def;
		}
		else
		{
			$t =get_class_vars($cl);
			if (method_exists($cl, "__get"))
			{

				$s = $array->__get($key);
				return $s? $s : $def;
			}
			if (isset($array->$key))
				return $array->$key;
		}
	}
	return $default;
}
function  igk_setv($obj, $k, $v){
	if (is_object($obj))
		$obj->$k = $v;
	else
		$obj[$k] = $v;
}

///<summary>get the setted-value</summary>
function igk_getsv($value, $default=null)
{
	if (isset($value))
	{
		return $value;
	}
	return $default;
}
///<summary>get conditional value. is condition return $value or null</summary>
function igk_getcv($condition, $value){
	if ($condition)
		return $value;
	return null;
}

///<summary>get the value between value and default. if $value is empty or null default</summary>
function igk_gettv($value, $default)
{
	if (($value==null) || empty($value))
		return $default;
	return $value;
}
///<summary>get the value between value and default. if $value is empty or null default. default can be a callable expression</summary>
function igk_getev($value, $default)
{
	if (($value==null) || empty($value))
	{
		if (is_callable($default))
			return $default();
		return $default;
	}
	return $value;
}
/// Clear config session and restart Application
function igk_Clear_config_session()
{
	$ctrl = igk_getconfigwebpagectrl();
	$uri = $ctrl->getUri("startconfig&q=".base64_encode(
	'?'.http_build_query(array(
	"u"=>$ctrl->User->clLogin,
	"pwd"=>$ctrl->User->clPwd,
	"selectedCtrl"=>$ctrl->getSelectedConfigCtrl()->getName(),
	"selectPage"=>$ctrl->getSelectedMenuName()
	)
	)));
	igk_getctrl(IGK_SESSION_CTRL)->ClearS(false);
}

function igk_file_chmod($dirorfile, $mode, $recursif=false)
{
	$out = true;
	if ($recursif && is_dir($dirorfile))
	{

		$hdir = @opendir($dirorfile);
		if ($hdir)
		{

			while($r=readdir($hdir))
			{
				if (($r==".") || ($r==".."))
					continue;
				$f = igk_io_dir( $dirorfile."/".$r);

				// igk_wln($dirorfile ."=== ". is_file($f));
				if (is_dir($f))
				{
					// igk_wln($f. " : Dir file : ".$out);
					$out = igk_file_chmod($f, $mode, $recursif) && $out;
				}
				else if (file_exists($f))
				{
					// igk_wln($f. " : ".$out);
					if (!@chmod($f, $mode))
						$out = false;
					// else{
						// igk_wln($f. " : Change mode : ".$out);
					// }
				}
				// igk_wln($f. " : ".$out);
			}
			closedir($hdir);
		}
	}
	$out = @chmod ($dirorfile , $mode) && $out;
	return $out;
}

//<summary> parse bool to str string</summary>
function igk_parsebool($bool)
{
	if (is_bool($bool))
		return ($bool)?"true": "false";
	return igk_parsebool(igk_getbool($bool));
}
function igk_parsebools($b)
{
	return R::ngets("V.".igk_parsebool($b));
}
function igk_getbool($v)//get boolean value
{
	if (is_bool($v))
		return $v;
	if (is_string($v))
	{
		switch(strtolower($v))
		{
			case "true":
			case "1":
				return true;
		}
		return false;
	}
	if ($v)
		return true;
	return false;
}
//<summary>parse numéric number to string</summary>
function igk_parse_num($num)
{
	if (is_numeric($num))
	{
		if ($num == 0)
			return "0";
		return trim($num).IGK_STR_EMPTY;
	}
	return "0";
}
function igk_getquery_args($uri)
{
	$q = parse_url($uri);
	if (isset($q["query"]))
	{
		$tab  = array();
		parse_str($q["query"], $tab);
		return $tab;
	}
	else{
		$tab  = array();
		parse_str($uri, $tab);
		return $tab;
	}
	return null;
}
//<summary>get primary the article extension.according to lang</summary>
function igk_get_article_ext($lang=null){
	if ($lang)
	{
		return strtolower(".".$lang.".phtml");
	}
	return strtolower(".".R::GetCurrentLang().".phtml");
}
//get the article of a controller
function igk_get_article($ctrl, $name){
	return $ctrl->getArticle($name);
}
function igk_view_article($ctrl, $name){
	$f = $name;
	if (!file_exists($f))
		$f = $ctrl->getArticle($f);
	$n = igk_html_node_notagNode();
	igk_add_article($ctrl, $f, $n);
	return $n->Render();

}

function igk_get_frame_ext(){
	return strtolower(".frame.phtml");
}

function igk_get_current_base_uri($dir=null, $secured = false)
{
	$igk = igk_app();
	if ($igk->CurrentPageFolder!=IGK_HOME_PAGEFOLDER)
		$out = igk_io_baseUri($igk->CurrentPageFolder,$secured);
	else
		$out = igk_io_baseUri(null,$secured );
	if ($dir)
		$out .= "/".$dir;
	return $out;
}

function igk_php_check_and_savescript($file, $content, & $error, & $code)
{
		$f = $file;
		$v_c = $content;
		$v_old = null;
		if (file_exists($f))
		{
			$v_old = IGKIO::ReadAllText($f);
		}
		igk_io_save_file_as_utf8($f, $v_c, true);
		$code =10;
		$error=array();

		$uri = igk_html_resolv_img_uri(igk_io_dir(dirname(__FILE__)."/igk_checkfile.php"));
		$r = igk_post_uri($uri, array(
			"file"=>$f
		));
		if ($r != 'ok')
		{
			igk_wln($error);
			unlink($f);
			//write old value
			igk_io_save_file_as_utf8($f, $v_old,true);
			return false;
		}
		return true;
}
function igk_debuggerview()
{
	if (IGKApp::IsInit())
		return igk_getctrl(IGK_DEBUG_CTRL)->getDebuggerView();
	return null;
}

///<summary>set if APP DEBUG activity</summary>
function igk_debug($d){
	IGKApp::$DEBUG = $d;
}
///<summary>get if APP allow debugging</summary>
function igk_is_debuging()
{
	$App = igk_app();
	return (IGKServerInfo::IsLocal() && ($App->Configs->allow_debugging ?$App->Configs->allow_debugging : false));
}
///<summary>get if APP DEBUG is active</summary>
function igk_is_debug(){
	return IGKApp::$DEBUG;
}

function igk_debug_show_dump_info()
{
	igk_show_prev($_REQUEST);
}
//write debug message. to debug node
function igk_debug_show( $msg ){
	if (!IGKApp::IsInit())
		return;
	if (IGKServerInfo::IsLocal())
	{
		$tab = explode(':', $msg);
		$ctrl = igk_getctrl("igkdebugctrl" ,false);
		if ($ctrl == null)
			return;
		$lb =  igk_createNode("div");

		if (count($tab) > 1)
		{
			$args  = array();
			preg_match_all('/((?P<name>([^:]+)):(?P<value>(.)*))$/i', $msg, $args);
			$n = strtolower(trim($args["name"][0]));
			switch($n)
			{
				case "warning":
				case "error":
				case "notice":
				case "info":
					$lb["class"]="igk-debug-".$n;
					$lb->Content = $args["value"][0];
					$ctrl->addMessage($lb);
					break;
				default:
					$lb["class"]="igk-debug-msg";
					$lb->Content = $msg;
					$ctrl->addMessage($lb);
					break;
			}
		}
		else{
			$lb["class"]="igk-debug-msg";
			$lb->Content = $msg;
			$ctrl->addMessage($lb);
		}

	}
}
function igk_debug_wln_i($tag, $msg){
	igk_debug_wln("[$tag] - $msg");
}
function igk_debug_wln_a_i($condition, $tag, $msg){
	if ($condition){
		igk_debug_wln_i($tag, $msg);
	}
}
function igk_debug_wln($msg)
{
	if (IGKApp::$DEBUG)
	{
		igk_wln($msg);
	}
}
function igk_debug_flush_data(){

	if (IGKApp::$DEBUG)
	{
		igk_flush_data($msg);
	}
}
function igk_debug_wl($msg)
{
	if (IGKApp::$DEBUG){
		igk_wln($msg);
	}
}

//-------------------------------------------------------------------------------------------------------------------------
//SERVER UTILITY FUNCTIONS
//-------------------------------------------------------------------------------------------------------------------------
///<summary>shortcut to IGKServerInfo::IsLocal()</summary>
function igk_server_is_local(){
	return IGKServerInfo::IsLocal();
}
function igk_server_is_linux(){
	return strtolower(PHP_OS)=="linux";
}
function igk_server_is_window(){
	return preg_match("/(winnt)/i",strtolower(PHP_OS));
}
///<summary>check if request in on local server</summary>
function igk_server_request_onlocal_server(){
	return igk_getv($_SERVER, "REMOTE_ADDR") === igk_getv($_SERVER, "SERVER_ADDR");
}
function igk_server_is_refreshing()
{
	return igk_getctrl("igkpagectrl",false)->isRefreshing;
}
function igk_server_is_redirecting(){
	$f = igk_getv($_SERVER, "SCRIPT_NAME");
	return (igk_getv($_SERVER, "REDIRECT_URL")!=null) &&  (basename($f) == "igk_redirection.php");
}

///<summary>grant access to any platform server</summary>
function igk_server_request_from_balafon(){
	return igk_getv(igk_get_allheaders(), "IGK_SERVER")== IGK_PLATEFORM_NAME;
}
///<summary>determine that the request is coming from this local server</summary>
function igk_is_srv_request(){
	$tab= igk_get_allheaders();
	$s = 
		(igk_getv($_SERVER, "HTTP_HOST") == igk_getv($_SERVER, "SERVER_NAME") || die("server not match"))
		&& ((igk_getv($tab, "IGK_SERVER") == IGK_PLATEFORM_NAME) || die("server "))
	    && ((igk_getv($tab, "IGK_CREF")==igk_app()->Session->getCref()) || die("cref"));
	return $s;
}


//-------------------------------------------------------------------------------------------------------------------------
//CURRENCY FUNCTIONS
//-------------------------------------------------------------------------------------------------------------------------
function igk_currency_getamount($amout)
{
		$c = $amout.IGK_STR_EMPTY;
		if (!strstr($c,"."))
			$amout = $c.".00";
	return $amout;
}
///ask to download file
function igk_download_file($name , $filename, $encoding="binary", $exit=1)
{
	if (file_exists($filename))
	{
		$size = @filesize($filename);
		ob_clean();
		igk_download_content($name, $size,  IGKIO::ReadAllText($filename), $encoding, $exit);
	}
}

///<summary>compare two version</summary>
function igk_cmp_version($v1, $v2)
{


	while( ($tb1 =explode(".", trim($v1))) && count($tb1)<4){
			$v1.=".0";
	}

	while( ($tb2 =explode(".", trim($v2))) && count($tb2)<4){
			$v2.=".0";
	}
	$c = igk_count($tb1);
	if ($c  == igk_count($tb2))
	{
		$i = 0;
		while( ($i<$c) &&  ($tb1[$i] === $tb2[$i]))
		{
			$i++;
		}
		if ($i<$c)
		{

			if ($tb1[$i] < $tb2[$i]){
				return -1;
			}
			return 1;
		}
	}
	return strcmp($v1, $v2);
}

function igk_str_get_version($v){

	$tb = explode(".", $v);
	if (igk_count($tb) < 4)
	{
		$c = igk_count($tb)-4;
		while($c>0)
		{
			$tb[]=0;
			$c--;
		}
	}
	else{
		$tb = array_shift($tb, 4);
	}
	return igk_str_join_tab($tb,'.',false);

}

///<summary>@@@used to download content</summary>
function igk_download_content($name, $size,  $content, $encoding="binary", $exit=true){//download the content
	header("Content-Type: Application/force-download; name=\"" . $name . "\"");
	header("Content-Transfer-Encoding: ".$encoding);
	header("Content-Length: $size");
	header("Content-Disposition: attachment; filename=\"" . $name . "\"");
	header("Expires: 0");
	header("Cache-Control: no-cache, must-revalidate");
	header("Pragma: no-cache");
	igk_set_env(IGK_ENV_NO_TRACE_KEY, 1);
	ob_clean();
	igk_wl($content);
	if ($exit)
	igk_exit();
}

function igk_get_cached_manifest(){
	header("Content-Type: text/cache-manifest");
	igk_wl(igk_get_manifest_content());
}
function igk_get_manifest_content()
{
$info = "igkapp_manifest";
	$out = <<<EOF
CACHE MANIFEST
#{$info} - manifest
EOF;
}

function igk_header_no_cache(){
	//past date
	$t = "Thu, 04 Aug 1983 21:00:00 GMT";
	header("Expires: Thu, 04 Aug 1983 21:00:00 GMT");
	//header("Expires: ".gmdate("D, 04 M Y H:i:s")." GMT");
    // header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT");
    header("Last-Modified: " . $t);
    header("Cache-Control: no-store, no-cache, must-revalidate, max-age=0");
    header("Cache-Control: post-check=0, pre-check=0", false);
    header("Pragma: no-cache");
    header("Connection: close");
}

///<summary>specifu cache output</summary>
function igk_header_cache_output($second=3600){
	$ts = gmdate("D, d M Y H:i:s", time() + $second) . " GMT";
	header("Expires: {$ts}");
	header("Pragma: cache");
	header("Cache-Control: max-age={$second}, public");
	// header("age:{$second}");
}
function igk_set_header($code){
	$t = array(
		404=>"HTTP/1.0 404 Not Found"
	);
	header("Status: {$code}");
	header(igk_getv($t, $code, "HTTP/1.0 200 No Error"));
	header("IGKDEV-WFM: ".IGK_CODE_NAME." - ".IGK_VERSION);
}

// function igk_set_header($status=200, $info=null){

	// header("Status: ".$status. "");
	// // header("Status: 404 Not Found");
	// header("IGKDEV-WFM: BALAFON ".IGK_VERSION);
	// if ($info){
		// header($info);
	// }
// }

function igk_header_content_file($file){
	$mime = array(
	"svg"=>"image/svg+xml",
	"xml"=>"application/xml",
	"png"=>"image/png",
	"jpeg"=>"image/jpeg",
	"jpg"=>"image/jpeg",
	"html"=>"text/html",
	"txt"=>"text/plain",
	"js"=>"text/javascript",
	"css"=>"text/css"
	);
	header("Content-Type: ".igk_getv($mime, strtolower(igk_io_path_ext($file)), "text/plain"));
}
//---------------------------------------------------------------------
//DATE UTILS FUNCTION
//---------------------------------------------------------------------
//
//return: 	-2 on error
//			1 if date1 > date2
//			0 if equal
//			-1 if date1 < date2
//---------------------------------------------------------------------
function igk_date_now($format =null)
{
	if ($format)
		return date($format);
	return date(IGK_DATETIME_FORMAT);
}
function igk_date_compare($date1, $date2){
//TODO: date comparaison
	try{
		$d1 = new DateTime($date1);
		$d2 = new DateTime($date2);
		if ($date1 > $date2)
			return 1;
		if ($date1 < $date2)
			return -1;
		return 0;
		}
		catch(Exception $ex){
			return -2;
		}
}
///<summary>return the higher date according to format</summary>
function igk_date_last_date($date1, $date2, $v_format="Y-m-d"){

		//compare mysql date
		// igk_wln("compare");
		// igk_wln("$v_format");

		$s1 = igk_time_span($v_format, $date1);
		$s2 = igk_time_span($v_format, $date2);
		// igk_wln("$s1 ::: $s2");
		return $s1<=$s2 ? $date2: $date1;
}
function igk_html_build_select_model($ctrl, $target, $name, $option){
	igk_html_binddata($ctrl, $target, $name, $option);
}

function igk_html_indent_line($option=null){
	// igk_debug_wln("check indent\n".$option->Indent."\n");
		//$v_indent = igk_getv($option, "Indent", false);
	if (($option==null) || (!isset($option->Indent) || (!$option->Indent)))
		return null;
	return "\n";
}

function igk_html_get_depth_indent($src, & $options =null){
		if (($options==null) || (isset($options->Indent) &&  (!$options->Indent)) )
			return null;
		$c = igk_getv($options, "Depth", 0);

		$q = $src;
		$s = IGK_STR_EMPTY;
		while($c>0){
			$s .= "\t";
			$c--;
		}
		return $s;
}
///<summary>check if sytem request a full uri</summary>
function igk_html_is_fullurirequest($options=null){
	return igk_is_ajx_demand() || preg_match("#^\/!@#i", igk_io_request_uri()) ||
	($options && (igk_xml_is_options_mail($options) || $options->StandAlone ));
}
///<summary>get system uri for link</summary>
function igk_html_get_system_uri($link, $option=null){
	if ($option && !isset($option->StandAlone)){
		igk_die("failed ....no StandAlone in options query" );
	}
		$src = "";
		if (!empty($link))
		{

			//igk_debug_wln("is ok ? ".$link);
			if (IGKValidator::IsUri($link))
			{	//no validation
				$src= $link;
			}else{
				//	igk_debug_wln("is not uri ".$link);
				$s = "";
				$k = explode("?", $link);
				if (file_exists($k[0]))
				{
					$s = igk_io_basePath($k[0]);
					if (count($k)>1)
						$s .= "?".implode("?",array_slice($k,1));
				}
				else{
					$s = $link;
				}
				//in cache setting
				if ($option && ($option->Context ==IGK_WEB_CONTEXT) && $option->Cache){
					$src = $s;
					return igk_html_uri($s);
				}

				if ( $option && ($option->StandAlone)){// || $option->Cache)){// igk_html_is_fullurirequest($option))//igk_is_ajx_demand() || igk_xml_is_options_mail($option) || preg_match("#^\/!@#i", igk_io_request_uri())){
					$src = igk_html_uri(igk_io_baseUri()."/".$s);
				}else{
						if ($s == $link) //not evaluated
						{
							//igk_wln("not eval relative");
							// $src = igk_html_uri(igk_io_currentRelativePath($s));
							$src = igk_html_uri(IGKIO::GetCurrentRelativeUri($s));
							// igk_wln($src);
							// igk_wln(IGKIO::GetCurrentRelativeUri($s));
							// igk_wln(IGKIO::GetCurrentRelativeUri($link));
						}
						else{
							//igk_wln("relative");
							$src = igk_io_currentRelativeUri($s);
						}

				}
			}
		}
		else{
			$src =  igk_io_currentRelativeUri();
		}
		// $uri = "";
		// if (IGKValidator::IsUri($link))
		// {	//no validation
			// $uri= $link;
		// }
		// else{
			// to base relative according to requested path

			// if (igk_is_ajx_demand()){
				// if in ajx demand context return full uri to link. simple method
				// $uri = igk_html_uri(igk_io_baseUri()."/".$this->link);
			// }
			// else{
				// $s = IGKIO::GetCurrentRelativeUri($link);
				// $uri = igk_html_uri($s);
			// }
		// }
// igk_die("file is ".$src ."\n uri is ".$uri);
	return $src;
}

function igk_to_array($obj, $emptyarray=1){
	if (is_array($obj))
		return $obj;
	if (is_object($obj))
	{
		if (method_exists($obj,"toArray"))
			return $obj->toArray();
	}
	return $obj==null ? (($emptyarray)? array():null): array($obj);
}
function igk_get_stack_depth(){
	return igk_count(debug_backtrace()) - 1;
}
///<summary> render only visible text node
function igk_html_render_text_node($n){
	$t = null;
	$s = null;
	return igk_html_render_node($n,$s, $t, true);
}
function igk_html_render_all($n){//render all by disable displaying chain
	$t = null;
	$s = null;
	return igk_html_render_node($n,$s, $t, false, 0);
}


function igk_xml_initialize($option, $tab){
	foreach($tab as $k=>$v){
		if (!isset($option->$k)){
			$option->$k = $v;
		}
	}
}
///<summary>render node in chain hierachie</summary>
function igk_html_render_node($n,& $options , $tab=null, $textonly=false, $chain=1){
	$p = null; //store parent
	$q = null; //store current
	$s = ""; //output
	$d = null; //store the marked data
	$ct = 0; //number of rendering element
	$ri = 0;
	if ($tab ==null)
		$tab = array();
	if (igk_count($tab) == 0)
	{
		array_push($tab, $n);
	}
	else
		$tab = array_reverse($tab);

	

	$q = array_pop($tab);//$info;
	
	$overridingkey  = "sys://html/overriding_render";
	
	if (igk_peek_env($overridingkey) === $q){
		igk_die(__FUNCTION__." : Possible recursion detected. Operation not allowed.");
	}

	//$tpmarker = array();
	$depth = 0;
	$g = 0;
	$ns = array();
	$rdinfo = null;
	$v_iline = igk_html_indent_line($options);
	$inner = "";
	
	if ($options){
		if (isset($options->Depth))
			$options->Depth++;
		else
			$options->Depth= 1;
		//setup options configuration
		igk_xml_initialize($options, array("Stop"=>0, "Intent"=>0));
	}
	else {
		$options = igk_xml_create_render_option();
	}
	//calculate depth
	$depth = $options->Indent ? str_repeat("\t",$options->Depth-1) : null;
	//store data
	$gg = null;
	
	// igk_wln("depth ::: " . strlen($depth) ." = ". $options->Depth);
	
	while($q && !$options->Stop){
		$closep = false;
		if ($p  && ($p === $q))
		{
			$inner = $s;
			$s = $rdinfo->text;
			if ($rdinfo->pinfo)
				$p = $rdinfo->pinfo->parent;
			else
				$p = null;
			
			//update depth info if mod depth
			if ($rdinfo->udateddepth)
				$options->Depth--;
			
			$rdinfo = $rdinfo->pinfo;
			$closep = true;		
			$depth = $options->Indent ? str_repeat("\t",$options->Depth-1) : null;			
		}
		else{
			if ($chain && !$q->AcceptRender($options)){
				$q = array_pop($tab);
				continue;
			}
			$ct++;

			if (igk_is_html_node_overriding_view($q))
			{
				// override node notify
				igk_push_env("sys://html/overriding_render", $q);
				$s .= $q->Render($options).$v_iline;
				igk_pop_env("sys://html/overriding_render");
				$q->RenderComplete($options);
				$v = array_pop($tab);

				if ($v === $q){
					igk_die("Save value not allowed: ".get_class($q));
					break;
				}
				$q = $v;
				continue;
			}
		}


		if (!$closep){
			$updatedepth = 1;
			if (!$textonly && $q->getIsRenderTagName())
			{
				// $s.="@:".$rdinfo->childs;
				if(!empty($rdinfo->content)){
					$s .= $v_iline.$depth;
					$rdinfo->content=null; // reset content flags. 
// <title>
// sample ....
		// <div>marjor</div>
		// <div>lazor</div>
// </title>				
					
				}else 
					$s.= $depth;	
				$s.="<".$q->tagName;

				$k = $q->getAttributeString($options);
				if (isset($options->ns)){
					array_push($ns,$options->ns);
				}
				if (!empty($k)){
					$s.= " ".$k;
				}
			}
			else
				$updatedepth = 0;
			
			//if ($q["class"]->getValue() == "igk-connect-form")
				// igk_wl("before: ".$inner."\n");
				// igk_wl("befores: ".$s."\n");
			$inner = IGK_STR_EMPTY;
			//$c = $q->Content;
			$c_childs = $q->GetRenderingChildren($options);
			$c_tchild = igk_count($c_childs);

			$c = IGKHtmlUtils::GetContentValue($q, $options);
			$inner .= $c;
			if ($c_tchild > 0)
			{
				//igk_wln("child ".$c_tchild);
				
				if ($updatedepth){
					$options->Depth++;
					$depth.= $options->Indent? "\t" : null;
				}
				$rdinfo = (object)array("pinfo"=>$rdinfo, "parent"=>$q, "text"=>$s , "content"=>$c, "childs"=>$c_tchild ,  "udateddepth"=>$updatedepth);
				$tab[] =$q;
				$tab = array_merge($tab, array_reverse($c_childs));
				//echo igk_count($tab)."---\n";
				$p = $q;
				$q = array_pop($tab);
				//continue with the current inner
				$s = $inner;
				continue;
			}
		}
		if (!$textonly && $q->getIsRenderTagName())
		{
			if ( igk_html_emptynode($q) || ( !is_numeric($inner) && empty($inner) && !$q->closeWithCloseTag($options,$q->tagName)))
			{
				$s .=" />".$v_iline;
			}
			else {
				$s .= ">";
					//no trim data
				$sk = trim($inner);
				$ri = 0;
				if ($closep)				
					$s .= $v_iline."";
				
				if (is_numeric($sk) || !empty($sk))
				{
					$sk = $inner;
					$ri=1;
				}
				
				if (!empty($sk)){
					$s.= $sk;			
				}
				
				// igk_wln("sk : ".$sk);
				if ($closep && $ri)	
					$s .= $depth;
				$s .= "</".$q->TagName.">";
				if (count($tab)>0){
					$s.=$v_iline;
				}

			}
			//$options->Depth--;
			// igk_wln(" depth ".$options->Depth);
		}
		else{
				$sk = trim($inner);
				if (is_numeric($sk) || !empty($sk))
				{
					$s .= $inner;
				}
		}
		$q->RenderComplete($options);
		$q = array_pop($tab);
		$options->ns = array_pop($ns);
	}
	// header("Content-Type: text/css");
	// igk_wl("response : $ct : \n".$s);
	return $s;
}
///<summary>check if the node is html item</summary>
function igk_is_html($n){
	return is_object($n) && is_subclass_of(get_class($n), IGK_HTML_ITEMBASE_CLASS);
}
function igk_is_html_node_overriding_view($n){
	if (get_class($n)=="IGKXmlNode")//primary
		return false;



	$t =  method_exists($n, 'Render');
	if ($t && !$n->NoOverride){
		$v_cln = get_class($n);
		$v_minfo = new ReflectionMethod($v_cln, 'Render');
		return ($v_minfo->class == $v_cln);
	}
	return false;
}


function igk_html_load_menu_array($target, $tab, $item="li", $subnode="ul", $user=null, $ctrl=null, $callback=null){
	//$target["class"] = "+igk-hmenu";

	$mi = null;
	$sfc = function($tab){ //callback to build  roots
		$o = array();
		$c = 0;
		$levels = array();
		$roots  =0;
		foreach($tab as $k=>$v){
			$st = igk_io_basenamewithoutext($k);
			$v_isr = $st === $k;
			$c = 0;
			if ($v_isr){
				//roots
				$c = $roots;
				$roots++;
			}else{
				if (isset($level[$st]))
					$c = $level[$st];
			}
			$obj = (object)array("key"=>$k, "index"=>null, "level"=>$v_isr ? 0: igk_count(explode(".", $st)));
			if (is_array($v)){
				$kk = igk_getv($v,"index");
				$obj->index = ($kk ? $kk : $c++);
			}
			else{
				$obj->index = $c;
				$c++;
			}
			$o[]=$obj;
			if (!$v_isr)
			 $level[$st] = $c;
		}
		return $o;
	};
	//get root menu level

	$h = $sfc($tab);
    //sort menu
	usort($h, function($a, $b){
			if($a->level == $b->level){
				if($a->index == $b->index)
					return strcmp(strtolower($a->key), strtolower($b->key));
				return $a->index < $b->index ? -1: 1;
			}
			return $a->level < $b->level ? -1: 1;
	});

	// igk_wln($h);
	// igk_wln(array_keys($tab));
	$root = array();//store root menu
	$sd = array(); //store create menu


	foreach($h as $obj){
		$s = $tab[$obj->key];
		$k = strtolower($obj->key);
		$pname = igk_io_basenamewithoutext($k);
		$mi= $target;
		$ii=null;
		// igk_wln("1 :". $k);
		if (!isset($root[$k]))
		{
			if (isset($sd[$pname])){
				$ii=$sd[$pname];
				if ($ii->ul == null){
					$ii->ul = $ii->li->add($subnode);
				}
				$mi = $ii->ul;
			}else{
				if ((empty($pname) || !isset($root[$pname]))){
					//must creat a root item
					// igk_wln("6: create root item ".$k);
					$root[$k] = (object)array("li"=>null, "ul"=>null,'level'=>$obj->level);
					$sd[$k]=$root[$k];
				}else{
					// igk_wln("8: register sub menu :".$pname);
					$ii = $root[$pname];
					$mi = $ii->li->add($subnode);
				}
			}

			if ($mi!==$target)
			{
				$mi["class"] = "sub s".$obj->level; //subitem level
					if ($callback)
							$callback($_ul, "subi", $pname);
			}

		}else{

			igk_die("10: already define ");

		// if(	$pname !== $k){
			// //key not equal to pname that means its a ch;ild menu isn't igk_wln("for : ".$pname);
			// if (!isset($sd[$pname])){
				// //create a root level menu
				// igk_wln("2:new foor ".$k);
				// $sd[$k] = (object)array("li"=>igk_createNode($item), "ul"=>null,'level'=>$obj->level);
				// $roots[$pname]= $sd[$k];
				// // igk_wln($sd[$pname]);
			// }

			// //create a submenu
			// if (isset($sd[$pname])){
				// if ($sd[$pname]->ul == null){
					 // igk_wln("3:for :".$pname);
					 // // igk_wln($sd[$pname]);
					 // // igk_exit();
					// $_ul =  $sd[$pname]->li->add($subnode);
					// // igk_wln($s);
					// $_ul["class"] = "sub s".$obj->level; //subitem level
					// $sd[$pname]->ul =$_ul ;
					// if ($callback)
						// $callback($_ul, "subi", $pname);
					// }
					// $mi = $sd[$pname]->ul;
					// $mi->add("li")->Content = "test";
					// igk_wln("4: ".$mi);
			// }
			// //igk_wln($mi->Render());
			// // not root menu
			// // if (!isset($sd[$pname])){
				// // $sd[$pname] = (object)array("ul"=>igk_createNode($subnode));
			// // }
			// // else{
				// // $sd[$pname] = (object)array("ul"=>$sd[$pname]->add($subnode));
			// // }
			// // $mi = $sd[$pname]->ul;
			// // igk_wln("li ".$mi);
			// // continue;

		// }
		// igk_wln("create ".$k);
		//$mi = igk_getv($sd, $k, $target);//if (isset($sd[$k]))
		}
		if (is_array($s)){
			$u = igk_getv($s, "uri");
			if ($ctrl){
				$u = $ctrl->getAppUri($u);
			}
			$auth= igk_getv($s, "auth");
			$ajx = igk_getv($s, "ajx");
			$lkey= igk_getv($s, "lkey","menu.".$k);

			if (!empty($auth) && !igk_sys_isuser_authorize($user, $auth)){
				continue;
			}
			$hi = $mi->add($item);
			if ($ajx){
				$hi->addAJXA($u)->Content = R::ngets($lkey);
			}
			else
				$hi->addA($u)->Content = R::ngets($lkey);


		}else {
			if ($mi==null){
				$mi = $target;
			}
			$hi = $mi->add($item);

			if ($ctrl){
				$s = igk_str_rm_start($s, "/");
				$s = $ctrl->getAppUri($s);
			}
			$hi->addA($s)->Content = R::ngets("menu.".$k);
			// igk_wln("5: add :".$k);
			$sd[$k]->li = $hi;
		}
		// //set root menu
		// if (!isset($sd[$k])){
			// //register item
			// igk_wln("register menu ".$k);
			// $sd[$k] = (object)array("li"=>$hi, "ul"=>null, "level"=>$obj->level);
		// }
		// if (!isset($sd[$k])){
			// igk_wln("7: register menu item to root : ".$k);
			// $sd[$k]->li = $hi;
		// }


	}//end foreach
	$target->roots = $root;
}
///<summary>utility function to create tab selection</summary>
function igk_html_create_db_tab_select($tag, $ctrl, $id, $table){
$sl = igk_createNode($tag);
$sl->addLabel($id);
$sl->addCtrlSelect()
->setId($id)
->setCtrl($ctrl)->setTable($table)->loadingComplete();
return $sl;
}

function igk_html_init_node_page($t)
{
	$t->setClass("fit igk-parentscroll igk-powered-viewer overflow-y-a");
}

function igk_html_store_doc_form_mailtransport($doc, $file){
	$opt = igk_xml_create_render_option();
	$opt->Context = "mail";
	igk_io_save_file_as_utf8_wbom($file, $doc->Render($opt), true);

}

function igk_html_save_doc_formail($doc, $file){
	$opt = igk_xml_create_render_option();
	$opt->Context = "mail";
	$maildoc = IGKHtmlMailDoc::CreateFromDocument($doc);
	igk_io_save_file_as_utf8_wbom($file,  $maildoc->Render($opt), true);
}
///<summary>remove base uri</summary>
function igk_html_rm_base_uri($v){
	$s = igk_io_baseUri();
	$rg = "/((".str_replace("/","\\/", $s)."(\/)?)+)/i";
	if (preg_match($rg, $v)){
		//remove domain name
		$v = preg_replace($rg, IGK_STR_EMPTY, $v);
	}
	return $v;
}

function igk_html_newNode($tag)
{
	return new IGKHtmlItem($tag);
}

///<summary>validate fied object</summary>
function igk_html_validate($o)
{
	return true;
}
function igk_html_validate_error(){
	return null;
}

///<summary>used to register a component demonstration</summary>
///<remark>in case you don't what to populate the framework with {igk_html_demo_[compenentNanem]} function convention</remark>
///<param name="ns">the full namespace to  component</param>
///<param name="callback">the callback that will be called by system to initialize a demonstration view</param>
function igk_html_reg_component_demo($ns, $callback){
	igk_set_env_keys("sys://html/components/demos", $ns, $callback);
}
///<summary>used to get the component demo keys</summary>
function igk_html_get_component_demo(){
	return igk_get_env("sys://html/components/demos");
}



function igk_html_render_xml($item){
	if (!$item)
		return null;
	IGKOb::Start();
	igk_wl(igk_xml_header()."\n");
	igk_wl($item->Render(new IGKXmlRenderOptions()));
	$s = IGKOb::Content();
	IGKOb::Clear();
	return $s;

}
//<summary>resolv the image uri. this method return a full uri to image if image exists</summary>
//pass the fullpath to file and return a http uri access to file
//usefool for URL
function igk_html_resolv_img_uri($path){
	$f = igk_io_currentRelativePath($path);
	if (!empty($f) && file_exists($f))
	{
		$r = realpath($f);
		$s = igk_io_basePath($f);
		if ($s == $r)
		{//not resolved
			$m = igk_html_uri(igk_io_baseUri()."/".$f);
			return $m;
		}
		$v_uri = igk_html_uri(igk_io_baseUri()."/".$s);
		return $v_uri;
	}
	return null;
}

function igk_html_mustclosetag($tagname)
{
	if (IGKString::StartWith(strtolower($tagname),"igk-"))
		return true;
	return isset(IGKHtmlOptions::$closeWithCloseTags[$tagname]);
}
///<summary>detect that a tag must be an empty tag</summary>
function igk_html_emptytag($tagname){
	return isset(IGKHtmlOptions::$EmptyTag[strtolower($tagname)]);
}
///<summary>detect that a node must be an empty node</summary>
function igk_html_emptynode($n){
	if (get_class($n)== "IGKXmlNode"){
		return 0;
	}
	return igk_html_emptytag($n->TagName);
}
function igk_html_treatinput($node)
{
	if ($node==null)
		return;
	$d = $node->getElementsByTagName("input");
	if ($d && (igk_count($d)>0))
	{
		foreach($d as $k)
		{
			if (($k["class"] == null )&&($k["type"]!=null))
			{
				$k["class"] = "cl".strtolower($k["type"]);
			}
		}
	}
}

function igk_html_build_select_setting(){//get a selection setting object
	return (object)array(
		"allowEmpty"=>false,
		"keysupport"=>false,
		"valuekey"=>null,
		"displaykey"=>null,
		"resolvtext"=>null
	);
}
///
/// @attributes array of  [allowEmpty, valuekey, displaykey]
/// @attr is html attributes
function igk_html_build_select($target, $name, $tab, $selectattributes=null, $selectedvalue=null, $attr=null){//build a select node
	$sel = $target->add("select");
	$sel["id"]=$sel["name"] = $name;
	if ($selectedvalue == null)
	{
		$selectedvalue = igk_getr($name,null);
	}
	igk_html_build_select_option($sel, $tab, $selectattributes, $selectedvalue);
	$sel->AppendAttributes($attr);
	return $sel;
}
///<summary>build select options</summary>
///<param name="target">select node</param>
function igk_html_build_select_option($target, $tab, $selectattributes=null, $selectedvalue=null){
	if (igk_getv($selectattributes,"allowEmpty"))
		$target->add("option", array("value"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;
	$kv = igk_getsv(igk_getv($selectattributes,"valuekey"));
	$dv = igk_getsv(igk_getv($selectattributes,"displaykey"));
	$ksu = igk_getv($selectattributes, "keysupport");
	$resolvtext = igk_getv($selectattributes, "resolvtext");
	$idxk = igk_getv($selectattributes, "useArrayIndex");
	if (is_array($tab))
	{
		foreach($tab as $k=>$v)
		{
			$opt = $target->add("option");
			$s = $ksu? igk_getv($v, $kv) : $v;
			$opt["value"] = $idxk? $k: $s;//ksu? igk_getv($v, $kv): $v;

			if ($resolvtext )
				$opt->Content = R::ngets("enum.".($ksu? igk_getv($v, $dv) : $v));
			else
				$opt->Content =  $ksu? igk_getv($v, $dv) : $v;
			if ($s == $selectedvalue){
				$opt["selected"] = true;
			}
		}
	}
}

function igk_html_build_table($table, $queryresult){
		$r = $queryresult;
		if (!$r)
			return;
		if ($r->ResultTypeIsBoolean()){
			$tr = $table->addTr();
			$tr->addTd()->Content = "Result";
			$tr = $table->addTr();
			$xr = ((object)$r->getRowAtIndex(0));
			$tr->addTd()->Content = isset($xr->clResult) &&  igk_parsebool($xr->clResult);
			return;
		}
		$tr = $table->addTr();
		foreach($r->Columns as $k=>$v){

			$tr->add("th")->Content = $v->name;
		}
		foreach($r->Rows as $k=>$v){
			$tr = $table->addTr();
			foreach($v as $m=>$mm){
				$tr->addTd()->Content = $mm;
			}
		}
}
function igk_html_build_query_result_table($queryresult){
	$table = igk_createNode("table");
	if ($queryresult)
		igk_html_build_table($table, $queryresult);
	return $table;
}

function igk_html_getAllchilds($node)
{
	$tab = array();
	if ($node->HasChilds)
	{
		foreach($node->Childs as $k)
		{
			$tab[] = $k;
			$c = igk_html_getAllChilds($k);
			if (igk_count($c) > 0)
				$tab = array_merge($tab, $c);
		}
	}
	return $tab;
}
function igk_html_unsetbindingprop($node)
{
	//unset template properties
	$node["igk-data-binding"] = null;
	$node["igk-data-binding-visible-row"] = null;
	$node["igk-data-full-row-binding"] = null;
	$node["igk-data-full-row-binding-tag"] = null;
	$node["igk-data-row-checkexpression"]=null;
	$node["igk-data-row-binding"] = null;
	$node["igk-data-row-data"] = null;
}
///<summary>return array of data binding node info</summary>
function igk_html_bindinginfo($node)
{
	$tab = igk_html_getAllchilds($node);
	$c = array();


	foreach($node->Childs as $k)
	{

	// foreach($tab as $k)
	// {

		if ( ($h = igk_getv($k, "igk-data-binding")) !=null)
		{
			$c[] = (object)array(
				"node"=>$k,
				"binding"=>$h,
				"type"=>"igk-data-binding",
				"visiblerow"=>igk_getv($k, "igk-data-binding-visible-row", igk_getv(igk_app()->Configs, "app_visible_row", 50))
				);
		}
		else if( igk_getbool(($h = igk_getv($k, "igk-data-row-binding"))) == true)
		{
			$p = $k->getParentNode();
			$c[] = (object)array(
				"node"=>$k,
				"parent"=>$p,
				"Index"=>$k->Index,// ? $k->Index $p? igk_html_index_of($k): null,
				"binding"=>$h,
				"data"=>igk_getv($k, "igk-data-row-data", null),
				"type"=>"igk-data-row-binding",
				"visiblerow"=>igk_getv($k, "igk-data-binding-visible-row", igk_getv(igk_app()->Configs, "app_visible_row", 50)),
				"rowcheckExpression"=>igk_getv($k, "igk-data-row-checkexpression", null)
				);
// igk_wln("d :".$k->Index);
			igk_html_unsetbindingprop($k);
			//remove the rows
			igk_html_rm($k);
			return $c;
		}
		else if( igk_getbool(($h = igk_getv($k, "igk-data-full-row-binding"))) == true)
		{
				$c[] = (object)array(
				"node"=>$k,
				"parent"=>$k->getParentNode(),
				"binding"=>$h,
				"type"=>"igk-data-full-row-binding",
				"tag"=>igk_getv($k , "igk-data-full-row-binding-tag"),
				"visiblerow"=>igk_getv($k, "igk-data-binding-visible-row", igk_getv(igk_app()->Configs, "app_visible_row", 50))
				);
			igk_html_rm($k);
		}
		igk_html_unsetbindingprop($k);
		if ($k->HasChilds)
		{
			//go deth
			$c = array_merge(igk_html_bindinginfo($k));
		}
	}
	return $c;
}

function igk_html_index_of($node)
{
	$p = $node->getParentNode();
	if ($p==null)
		return null;
	$i=0;
	// $sindex = $node->Index;
	foreach($p->Childs as $k=>$v)
	{
		if ($v === $node)
			return $i;
		$i++;
	}
	return $i;
}

//-------------------------------------------------------------------------------------------
//BALAFON BASE EVALUATION ENGINE
//-------------------------------------------------------------------------------------------

///<summary>Evaluate data by applying current row entries</summary>
///<remark>used to evaluate $value by replacing the current row data expression column</remark>
///<param name="value">expression to evaluate</param>
///<param name="row">current cibling row</param>
///<param name="ctrl">passed controller</param>
///<param name="ctx">context  if IGK_HTML_BINDING_EVAL_CONTEXT or null</param>
function igk_html_treatbinding_evaldata($value, $row, $ctrl=null, $ctx=null){

	$m = igk_html_databinding_treatresponse($value, $ctrl, $row, $ctx);
	//IGK_HTML_BINDING_EVAL_CONTEXT
	if (IGK_HTML_BINDING_EVAL_CONTEXT == $ctx){
		return $m;
	}
	$tab = array();	
	$c = preg_match_all("/(?P<name>(\\$(?P<value>([0-9a-z_]+))))/i", $m,  $tab);
	$vars = null;
// igk_wln("c is ".$c);
	if($ctrl){
		//extract treated params
		$v_bindingobj = $ctrl->getParam(IGK_DATABINDING_RESPONSE_NAME);
		if ($v_bindingobj){
			$vars = array_keys($v_bindingobj->args);
		}
	}

	$not_var = array();
	
	if ($c>0)
	{
		$h = null;
		// $vars = get_defined_vars();
		// $vars = igk_array_tokeys(array_keys($vars));
		for($i = 0; $i<$c;$i++)
		{
			
			$n = $tab["name"][$i];
			$key = $tab["value"][$i];

			if (!isset($vars[$key]))
			{
				if ($key == "igk")
				{
					$m = str_replace($n, "__IGK_tbea__", $m);
				}
				else {
					$m = str_replace($n,"'not_defined_".$key."'", $m);
					$not_var["'not_defined_".$key."'"] = $key;
				}

			}
		}
	}
	$s =IGK_STR_EMPTY;
	try{
		//expression in brank because of evaluation
		$m = igk_html_beginbinding($m);
		//bind expression before evaluate the contents
		$h = $m;
		//check expression value before @ remove notice
		$context = array("ctrl"=>$ctrl, "row"=>$row);
		$r = igk_eval_script_in_context($context, $h);

		//restore key from context
		foreach($not_var as $k=>$v){
			$r = str_replace($k,'$'.$v,$r);
		}
		$r = igk_html_endbinding($r);
		return $r;
	}
	catch(Exception $ex){
		$s =  "evaluation failed ".$ex;

	}
	return 	$s;
}
///<summary>evaluation script in context</summary>
///<remark>script must be free of " symbol</remark>
function igk_eval_script_in_context($context, $script)
{
	if ($context)
		extract($context);
	//diseable the unset variable
	unset($context);
	$script = <<<EOF
return "{$script}";
EOF;
	igk_eval_last_script($script);
	$r = @eval($script);
	igk_eval_last_script(null);
	igk_sys_handle_error($script);
	// igk_debug_wln("okkkk ".igk_is_debug() . " {$r} ===<br /> <textarea> {$script}</textarea>");

	return $r;
}

function igk_sys_handle_error($msg=null, $content=null){
	$c = error_get_last();
	if (igk_count($c)==0)
	{
		return;
	}

	switch(igk_getv($c, 'type')){
			case E_PARSE:
				igk_wln("<div class=\"igk-error\" style=\"".igk_css_get_style(".igk-error")."\">Parse Error </div>");
				igk_wl("<code>".$msg."</code>");
				igk_exit();
			case E_NOTICE:
				igk_wl("<div class=\"igk-notice\" style=\"".igk_css_get_style(".igk-notice")."\">Notice </div>\n");
				igk_wl("<code>".$msg."</code>");
				igk_wln($c);
				break;
		default:
		break;
	}
}

function igk_sys_error($error){
	header("Status: 404");
	header("HTTP/1.0 404 Not Found");
	$r = new IGKXmlNode("result");
	$r->add("error")->Content = $error;
	$r->add("msg")->Content = R::ngets(igk_get_error_key($error));
	$r->RenderXML();
}
///<summary>get if this is a valid tag name</summary>
function igk_html_is_tagname($v)
{
	return preg_match("/^".IGK_TAGNAME_CHAR_REGEX."+$/i", $v);
}

///<summary>check if this node is in ns</summary>
///<retrurn >true if empty ns or parent ns is on the same ns. true to render xmlns or false</retrurn>
function igk_html_is_ns_child($n){
	$q = $n;
	$g = $n->getParam(IGK_NS_PARAM_KEY);
	if (empty($g))
		return true;

		$q = $q->getParentNode();
		if ($q){
		$ns = $q->getParam(IGK_NS_PARAM_KEY);
		if ($ns !== $g)
			return true;
		return false;
	}
	return true;

}

function igk_html_treatbinding($info, $row, $ctrl=null,$artcontext=null)
{
	if ($info->visiblerow <=0)
	{
		return;
	}
	$output = array();
	$info->visiblerow--;
	$ctx = array("ctrl"=>$ctrl, "row"=>$row);
	if ($ctrl){
		$ctx = array_merge($ctrl->getSystemVars(), $ctx);
	}
		switch(strtolower($info->type))
		{
			case "igk-data-binding":
			if (preg_match_all("/^(?P<tagname>(".IGK_TAGNAME_CHAR_REGEX.")+)\s*:(?P<value>(.)+)$/i", $info->binding, $output))
			{
				$s = $output["tagname"];
				$r = $info->node->add($output["tagname"][0]);
				{
					$s = igk_html_treatbinding_evaldata($output['value'][0], $row,$ctrl, $artcontext);

					$r->Load($s);
				}
			}
			else{
				$rtab = explode(":",$info->binding);
				$c = igk_count($rtab);
				switch($c)
				{
					case 1:
						$info->node->Content = igk_html_treatbinding_evaldata($rtab[0], $row, $ctrl, $artcontext);
					break;
					case 2:	//add child to info node
						if (igk_html_is_tagname($rtab[0]))
						{
							$r = $info->node->add($rtab[0]);
							{
								$s= igk_html_treatbinding_evaldata($rtab[1], $row, $ctrl, $artcontext);
								$r->Content = $s;
							}
						}
						else{
							return false;
						}
					break;
					default:
						return false;
				}
			}
			break;
			case "igk-data-row-binding":
				if (isset($info->rowcheckExpression)){
					// igk_wln("checking row expression");
					$o = igk_html_eval_value_in_context("return ".$info->rowcheckExpression.";", $ctx);
					if ($o==false)
						continue;
				}

					$r =  igk_createNode($info->node->TagName);
					$r->copyAttributes($info->node);
					$m = "";
					$m = igk_html_get_inner_heararchi($info->node, "expression");					
					$r->LoadExpression($m);

				if (isset($info->data))
				{

					//there is data to bind in this current data / so event data

					$g = igk_html_eval_value_in_context($info->data, $ctx);
					if ($g){
					//
						$it = 0;
						foreach($g as $k=>$v)
						{
							$tt = $info->parent->add($info->node->TagName);
							$tt->copyAttributes($info->node);

							igk_html_bind_node($ctrl, $r, $tt, $v);//->Content = "init ::: ".$it . " ".$v->clTitle;
							$it++;
							$tt->Index = $info->Index +$it;
						}
					}
				}
				else{
					$bindchild =false;
					$k = $info->parent->add($info->node->TagName, null, $info->Index);
					$k->copyAttributes($info->node);
					$key = "sys://html-data";
					$row->$key= $info;
					igk_html_bind_node($ctrl, $r, $k , $row, false,  $bindchild);
					$k->Index = $info->Index;
					$info->Index++;

					//$info->parent->addDiv()->Content = "AddItem ".$info->Index++;

					// foreach($info->parent->Childs as $k=>$v){
						// igk_wln($v->Index);
						// $v->RenderAJX();
					// }
					//e_xit;
					// igk_wln("load data ;;...index : ".$info->Index);
				// return;
					if ($bindchild){
						$m = igk_html_get_inner_heararchi($k, "expression");
						$k->ClearChilds();

						$m = str_replace("\"", "__''__", $m);
						$m = igk_html_treatbinding_evaldata($m, $row, $ctrl, $artcontext);
						$m = str_replace("__''__","\"", $m);
						$k->Load($m, igk_createloading_context($ctrl, $row));
						//$info->parent->add($r);
					}
					//$info->parent->add($r);
				}

			break;
			case "igk-data-full-row-binding":
				$m = $info->node->getinnerHTML();
				$tag = $info->tag;
				if ($tag)
				{
					$r =  igk_createNode($info->node->TagName);
					foreach($row as $k){
						$r->add($tag)->Content = $k;
					}
					$s = $info->parent->add($r);
				}
				else{
					foreach($row as $k){
							$r =  igk_createNode($info->node->TagName);
							$r->copyAttributes($info->node);
							$r->Content = $k;
							$s = $info->parent->add($r);
					}
				}
			break;
		}
		return true;
	}
///<summary>used to add data to value</summary>
function igk_str_append_to(& $s, $v, $sep=','){
	if (empty($v)){
		return;
	}
	if (empty($s))
		$s .= $v;
	else
		$s = $sep.$v;
}

///<summary>transform [n] to conform balafon uri specification </summary>
function igk_str_view_uri($n){
	return str_replace("_", "/", $n);
}
function igk_str_repeat($p,$c){
	$o="";
	while($c>0)
	{
		$o.=$p;
		$c--;
	}
	return $o;
}
///<summary>used to capitalize string</summary>
function igk_str_capitalize($s){
	return strtoupper($s[0]).strtolower(substr($s,1));
}


///<summary>convert header string to associative array</summary>
function igk_header_str2array($s){
	$tab = array();
	$ot = array();
	$n = "";
	$tab = explode("\r\n", $s);
	foreach($tab as $line){
		if (empty(trim($line)))
			continue;
		$ton = explode(":", $line);
		$on = trim($ton[0]);
		if (!empty($on) && preg_match("/^[a-z-]+$/i", trim($on))){
			$n = $on;
			$v = trim(substr($line, strpos($line, ":")+1));
		}
		else{
			$v = $ot[$n]."\r\n".$line;
		}
		$ot[$n] = $v;
	}
	return $ot;
}

function igk_get_node_attr_value($attr, $value)
{
	if ($value==null)
		return null;
	if (is_string($value))
		return IGKHtmlItem::GetStringAttribute($value,null);
	switch($attr)
	{
		case "Ctrl":
			return IGKHtmlItem::GetStringAttribute($value->getName(), null);
		break;
	}
	return IGKHtmlItem::GetStringAttribute($value,null);
}
///<summary> used to retrieve node expression. inverse selection</summary>
function igk_get_node_expression($node, $dp=0)
{
		$d = get_class($node);
	// igk_wln(__FUNCTION__."\n");
	// igk_wln($node."\n");
	// igk_wln($d ."\n");
	// igk_wln($node->tagName ."\n");
	// igk_wln($node->getContent() ."\n");


	if ($node->tagName =="igk:text"){
		return $node->Content;
	}

	$o = "";
	$tag = $node->tagName;
	$n = "";
	if (preg_match(IGK_HTML_NODE_REGEX, $d))
	{
		$n = igk_preg_match(IGK_HTML_NODE_REGEX, $d, 'name');
		$tag = "igk:".$n;
	}

	$o .= "<".$tag;

	if ($n){
		$attr = $node->getExpressionAttributes();
		if ($attr!=null){
			foreach($attr as $v=>$t)
			{
				$o .= " igk:".$v."=". igk_get_node_attr_value($v, $t);
			}
		}
	}

		if ($node->HasAttributes)
		{
			$s = trim($node->getAttributeString(null));
			if (!empty($s))
				$o.= " ".$s;
		}

		// if ($node->HasAttributes)
		// {
			// $s = trim($node->getAttributeString(null));
			// if (!empty($s))
				// $o.= " ".$s;
		// }
		$c  = IGKHtmlUtils::GetContentValue($node);
		$cc = trim($c);

		if (!$node->hasChilds &&  empty($cc))
		{
			$o .="/>";
		}
		else{
			$o .= ">";
			$t = $node->Childs;
			$o.=$cc;
			if ($t){
					foreach($t as $k=>$v){
						$o .= igk_get_node_expression($v, $dp);
					}
			}
			$o .="</".$tag.">";
		}
	return $o;
}
function igk_html_get_inner_heararchi($node, $type="text", $depth=0)
{
	$o = "";
	if ($node && $node->HasChilds)
	{
		foreach($node->Childs as $k=>$v)
		{
			$o.= igk_html_get_heararchi($v, $type, $depth);
		}
	}
	return $o;
}
function igk_html_get_heararchi($node, $type="text", $depth=0)
{
	$o = "";
	$dp ="";

	switch($type){
		case "text":
			$o .= $dp.get_class($node)."\n";
			$depth++;
			if ($depth>0){
				$dp = igk_str_repeat("\t", $depth);
			}
			foreach($node->Childs as $k)
			{
				$o.= $dp.igk_html_get_heararchi($k, $type, $depth);
			}
			break;
		case "expression":
			$o .= $dp.igk_get_node_expression($node, $depth)."\n";

			break;
	}

	return $o;
}
///<summary>html bind data to target node</summary>
///<param name="ctrl">the controller</param>
///<param name="targetnode">cibling node</param>
///<param name="templateArticleName">template or article for bindding</param>
///<param name="entries">data entries</param>
///<args name="entries">mixed , query result or object </entries>
function igk_html_binddata($ctrl, $targetnode, $templateArticleName, $entries=null, $rendertarget=true, $createIfNoExists= true, $showAdminOption=1)
{
	//create a dummy div;
	$d =  igk_createNode("div");
	//$s = igk_add_article($ctrl, $templateArticleName, $d, null, false, false, false);
	if (!file_exists($templateArticleName))
	{
		if ($ctrl)
			$templateArticleName = $ctrl->getArticle($templateArticleName);

		//still not exists
		if (!file_exists($templateArticleName))
		{

			if (!$createIfNoExists)
			return;
			IGKIO::WriteToFileAsUTF8WBOM($templateArticleName, "", true);
		}
	}
	
	$d->LoadExpression(igk_html_init_bind_expression(IGKIO::ReadAllText($templateArticleName)),null);
	$n = igk_html_bind_node($ctrl, $d, $targetnode, $entries, $rendertarget);
	//bind article config node
	if ($showAdminOption)
		$s = igk_add_article_options($ctrl, $targetnode, $templateArticleName);
	return $n;
}
///<summary>bind node to data model</summary>
///<param name="ctrl">the controller<param>
///<param name="rendertarget">call rendertarget on item complete<param>
function igk_html_bind_node($ctrl, $model, $targetnode, $entries=null, $rendertarget=true, & $bindchild=false){
	$o = array();
	if ($model && $model->HasChilds)
	{
		//has child
		$c = $model; //igk_html_clonenode($model);//->copy();//the model
		if ($c==null)
			return;

		$tabinfo = 0;
		$v_info_count =0;
		$tabinfo = igk_html_bindinginfo($c);
		$v_info_count = igk_count($tabinfo);
		if (($v_info_count>0) && $entries)
		{
			//
			//bind entrie in all info
			//
			igk_html_bindentry($ctrl, $entries, $tabinfo, $o, $c);
			$bindchild = true;
		}
		else{
			//get model inner HTML
			$i = $c->innerHTML;
			if (is_array($entries))
			{
				igk_set_env("sys://html/bindentries",1);
				foreach($entries as $k=>$v)
				{
					igk_set_env("sys://html/bindkey",$k);
					$o[] = 	(object)array("src"=>igk_html_eval_script($i, $ctrl, $v),"row"=>$v);
				}
				igk_set_env("sys://html/bindentries",null);
				igk_set_env("sys://html/bindkey",null);
			}
			else
			{
				$o[] = (object)array("src"=>igk_html_eval_script($i, $ctrl, $entries), "row"=>null);
			}
		}
	}
	if ($targetnode == null)
		$targetnode =$c;
	//load all items in global context
	$ctx = igk_createObj(array(
		"ctrl"=>$ctrl,
		"entries"=>$entries,
		"parent"=>$targetnode,
		"row"=>null
	));
	// igk_wln("rbase ".igk_env_count(__FUNCTION__));
	// igk_wln($o);
	foreach($o as $k=>$v){
		if (!is_object($v)){
			$b = $targetnode->Load($v, $ctx);
			continue;
		}
		$ctx->row = $v->row;
		$b = $targetnode->Load($v->src, $ctx);
	}
	if ($rendertarget)
		return $targetnode->Render();
	return IGK_STR_EMPTY;
}
function igk_html_bindsetup($ctrl, $tabinfo, $row)
{
	//tread info
	foreach($tabinfo as $info)
	{
		//treat row
		igk_html_treatbinding($info, $row, $ctrl);
	}

}
function igk_html_bindentry($ctrl, $entries, $tabinfo, & $o, & $c){
	$r = igk_getv($entries, "Rows");//for table entries
	if ($r!=null)
	{//check if contains Rows properties
		foreach($entries->Rows as $k)
		{
			igk_html_bindsetup($ctrl, $tabinfo, $k);
		}
	}
	else{
		if (is_array($entries))
		{
			foreach($entries as $k)
			{
				//tread info
				igk_html_bindsetup($ctrl, $tabinfo, $k);
			}

		}
		else{
			igk_html_bindsetup($ctrl, $tabinfo, $entries);
		}
	}
	//important load data binding
	$s = $c->getinnerHTML(null);
	$o[] =$s;
	$c->ClearChilds();
}

function igk_html_bind_target($ctrl, $targetnode, $textcontent, $entries=null)
{
	//create a dummy div and load the content
	$d =  igk_createNode("div");
	$d->LoadExpression($textcontent);
	return igk_html_bind_node($ctrl, $d,$targetnode, $entries);
}



///<summary>bind controller
/// data controller</summary>
///<remark></remark>
///$ctrl controller source of binding
///$content content of binding
function igk_html_bind_content($ctrl, $content, $row=null){//bind content a return a value.
	$t =  igk_createNode("div");
	igk_html_bind_target($ctrl, $t, $content, $row);
	return $t->innerHTML;
}

///<summary>used to evaluate expression script</summary>
function igk_html_eval_script($htmlscript, $ctrl, $row, $artcontext=null)
{
	if (empty($htmlscript))
		return $htmlscript;
	$m = $htmlscript;
	//:begin binding
	$m = igk_html_beginbinding($m);
	//:eval data on current row
	$m = igk_html_treatbinding_evaldata($m, $row, $ctrl, $artcontext);
	//:end binding
	$m = igk_html_endbinding($m);
	return $m;
}
function igk_html_beginbinding($value){
	$value = str_replace("\"", "__''__", $value);
	return $value;
}
function igk_html_endbinding($value){//used to end binding expression
	$v = str_replace("__''__","\"", $value);
	$v = str_replace("__IGK_tbea__","\$igk", $v);
	return $v;
}
//clear binding information for the controller
function igk_html_clearbindinfo($ctrl){
	$obj = $ctrl->getParam(IGK_DATABINDING_RESPONSE_NAME);
	if ($obj!=null){
		unset($obj);
		$ctrl->setParam(IGK_DATABINDING_RESPONSE_NAME, null);
	}
}


function & igk_html_databinding_getobjForScripting($ctrl, $name)
{
	$obj=null;
	if ($ctrl==null)
		return $obj;
	$obj = $ctrl->getParam($name);
	if ($obj == null)
	{
		$obj = new IGKDataBindingScript();
		$ctrl->setParam($name, $obj);
	}
	return $obj;
}

///<summary>php eval data binding</summary>
///<param name="obj"> object that will contains data calculated in script. in args. (note : obj, ctrl , row, expression, trimExpression, and script are reserved )</param>
function igk_html_php_eval($obj, $ctrl, $row, $expression)
{
	if (($expression==null)|| empty($expression) )
		return null;
	if ($obj!=null)
	extract($obj->args);
	try{
		$trimExpression = trim($expression);
		if (!IGKString::StartWith($trimExpression, "return ")){
			$trimExpression = "return ".$trimExpression;
			if (!IGKString::EndWith($trimExpression, ";"))
				$trimExpression.=";";
		}
		$script = <<<EOF
{$trimExpression}
EOF;
		IGKOb::Start();
		igk_eval_last_script($script);
		$m = @eval($script);
		igk_eval_last_script(null);
		$c = IGKOb::Content();
		IGKOb::Clear();
		igk_sys_handle_error($script, $c);


	}catch(Exception $ex){
		igk_notifyctrl()->addError(igk_getv($ex, "Message"));
		igk_show_prev("ERROR: ".htmlentities( $ex));
		igk_exit();
	}
	return $m;
}

function igk_eval_last_script($c){
	igk_set_env("sys://eval/lastscript", $c);
}

function igk_html_eval_value_in_context($script, $context)
{
    $__g_context = (array)$context;
    extract($__g_context);
    unset($$__g_context);
	$vars = get_defined_vars();
	$m = trim($script);
	if (IGKString::EndWith($m, ";") ==false)
		$m.=";";

	//------------------------------------------
	//security risk
	//------------------------------------------
	//check script in context

	$c = preg_match_all("/(?P<name>(\\$(?P<value>([0-9a-z_]+))))/i", $m,  $tab);
	if ($c>0){
		for($i = 0; $i<$c;$i++)
		{
			$n = $tab["name"][$i];
			$key = $tab["value"][$i];

			if (!isset($vars[$key]))
			{

				return "[eval:".$script."]";//cant evaluate expression : $key not found in context: ".$script;// "[eval:".$script."]";
			}
		}
	}
	//IGKOb::Start();
	$d = eval(<<<EOF
{$m}
EOF
);
	if (!empty($s)){
		igk_wl("Error on execution ".$m."<br />".$s);
	}
	return $d;

}

///<summary>treat string data binding response before eval</summary>
///<param name="rep">reponse</param>
///<param name="$ctrl">controller</param>
function igk_html_databinding_treatresponse($rep, $ctrl, $row, $ctx=null)
{
	
	// igk_wln("treat response : ". igk_env_count(__FUNCTION__));
	// igk_wln(":::".$rep);
	// $tb = igk_get_env('sys://html/bindresponse', array());
	
	// if (!isset($tb[$rep])){
		// $tb[$rep] = array("treated"=>1);
		
		 // igk_set_env('sys://html/bindresponse', $tb);
	// }
	// else 
		// return;
	
	
	// igk_ilog($rep);
	// igk_exit();
	//\s*(\w+)\s*:\s*([a-zA-Z0-9_]+)\s*\
	//regex for : [def:value]
	//$reg = '/\[\s*(?P<name>\w+)\s*:(?P<value>([^\]])+)\]/i';
	$reg = '/(\[{0,1})(?P<exp>\[\s*(?P<name>\w+)\s*:(?P<value>([^\]])+)\])(\]{0,1})/i';
	$regexpression = '/(\{\{(?P<expression>([^\}])+)\}\})/'; 
	
	//|(\[{0,1})(?P<exp>\[\s*(?P<name>\w+)\s*:(?P<value>([^\]])+)\])(\]{0,1}))/i';
	$reg_comment = '/(?P<comment>(\<\!--(?P<value>(.)+)--\>))/i';
	$comment  = array();
	//replace comment
	if (preg_match($reg_comment, $rep)){
		if ( ($c = preg_match_all($reg_comment, $rep, $match))){
			for($i = 0; $i<$c ; $i++)
			{
				$value = $match['comment'][$i];

				$rep = str_replace($value, "__COMMENT__".$i."__",$rep);
				$comment["__COMMENT__".$i."__"] = $value;
		    }
		}
	}

	//evaluate comment expression
	$tmatch = array();
	$match = array();
	$c = 0;
	$v = $rep;
	
	
	$c = preg_match_all($reg, $rep, $match);
	if ($c)
		$tmatch[] = $match;
	$c = preg_match_all($regexpression, $rep, $match);
	if ($c){
		$tmatch[] = $match;
	}
		
	foreach($tmatch as $match){
	{
		$c = igk_count($match[0]);
		if (isset($match["expression"])){
			//treat expression {{ }}
			for($i = 0; $i<$c ; $i++)
			{
				$v_m = $match[0][$i];
				$value = $match['expression'][$i];
				
				$rm = igk_html_eval_script($value, $ctrl, $row, IGK_HTML_BINDING_EVAL_CONTEXT);
				$obj = igk_html_databinding_getobjForScripting($ctrl,IGK_DATABINDING_RESPONSE_NAME);
				$m = igk_html_php_eval($obj, $ctrl, $row, $rm);
				$v = str_replace($v_m, $m, $v);				
			}
		}
		else{
			$c = igk_count($match[0]);
			for($i = 0; $i<$c ; $i++)
			{
				$v_m = $match[0][$i];
				$type = strtolower($match['name'][$i]);
				$value = $match['value'][$i];
				$exp = $match["exp"][$i];


				if(strstr("return", $v))
				{
					igk_die("/!\ a return found ");
				}

				if (($match[1][$i]) == '[' && ($match[6][$i]==']'))
				{
					$v = str_replace($v_m, $exp, $v);
					continue;
				}
// igk_wln("type : ".$type);
	
				switch($type)
				{
					case "curi": //replace  with controller base uri
						if ($ctrl)
						{
							$v = str_replace($v_m,
								igk_io_baseUri()."/".$ctrl->getUri($value),$v);
						}
						else
						$v = str_replace($v_m,
							igk_io_baseUri()."/".igk_html_uri($value),$v);
						break;

					case "uri"://replace with global uri
					$v = str_replace($v_m,
						igk_io_baseUri()."/".igk_html_uri($value),$v);
						break;
					case "guri": //get uri
					$uri = igk_io_baseUri()."/".igk_html_uri($value);
					$result = igk_io_baseUri()."/".igk_getctrl(IGK_SYSACTION_CTRL)->getUri($value);
					$v = str_replace($v_m, $result,$v);
					break;
					case "lang"://do language replacement
						$value = trim($value);
						if (!empty($value))
						{
							$v = str_replace($v_m, R::ngets($value)->getValue(), $v);
						}
						else
							$v = str_replace($v_m, $value, $v);
						break;
					case "conf": //do configuration zone replacement"
						$v = str_replace($v_m, igk_sys_getconfig($value), $v);
						break;
					case "func":
						// func: evaluate on global system presentation
						// syntax : [func: expression]					
						$rm = igk_html_eval_script($value, $ctrl, $row, IGK_HTML_BINDING_EVAL_CONTEXT);
						$obj = igk_html_databinding_getobjForScripting($ctrl,IGK_DATABINDING_RESPONSE_NAME);
						$m = igk_html_php_eval($obj, $ctrl, $row, $rm);
						$v = str_replace($v_m, $m, $v);
					break;
					case "funcv":
						$rm = igk_html_eval_script($value, $ctrl, $row, IGK_HTML_BINDING_EVAL_CONTEXT );
						$m = eval("return ".$rm.";");
						$obj = igk_html_databinding_getobjForScripting($ctrl,IGK_DATABINDING_RESPONSE_NAME);
						$obj->args["param1"] = $m;
						$v = str_replace($v_m, "\$param1", $v);
						break;
					// case "funcn":
					case "funce"://define variable . name=value,....
						$tab = explode("=", trim($value));
					
						if (igk_count($tab)>1)
						{//detect value
							$obj = igk_html_databinding_getobjForScripting($ctrl,IGK_DATABINDING_RESPONSE_NAME);
							
							//read litteral
							igk_html_databinding_read_obj_litteral($obj, $value, $ctrl, $row);

							// $name = $tab[0];
							// $value = substr($value, IGKString::IndexOf($value, ":")+1);
							// if (!isset($obj->args[$name]))
							// {
								// $obj->args[$name] = null;
							// }

														// igk_wln($v);
							
							// igk_wln($tab);
								// igk_wln($obj->args);
							
								foreach($obj->args as $k=>$tv){
									$rm = igk_html_eval_script($tv, $ctrl, $row, IGK_HTML_BINDING_EVAL_CONTEXT);
									$obj->args[$k] = igk_html_php_eval($obj, $ctrl, $row, $rm);
									
									// if ($type=="funcn")
										// $v = str_replace($v_m, "\${$k}", $v);
									// else{
										$v = str_replace($v_m, IGK_STR_EMPTY, $v);
										$v = preg_replace("/^(\\s)+$/i", "", $v);
									// }
								
								}
				
							
					
							// if (!empty($value))
							// {
								// $rm = igk_html_eval_script($value, $ctrl, $row, IGK_HTML_BINDING_EVAL_CONTEXT);

								// //evaludation
								// $obj->args[$name] = igk_html_php_eval($obj, $ctrl, $row, $rm);

								// if ($type=="funcn")
									// $v = str_replace($v_m, "\${$name}", $v);
								// else{
									// $v = str_replace($v_m, IGK_STR_EMPTY, $v);
									// $v = preg_replace("/^(\\s)+$/i", "", $v);
								// }
							// }
							// else{//remove value
								// $v = str_replace($v_m, IGK_STR_EMPTY, $v);
							// }

						}
						else 
							$v = str_replace($v_m, IGK_STR_EMPTY, $v);
						break;
					case "exp":
						//evaluate expression
						//usage: [exp:variable_name:expression]
						$tab = explode(":", $value);
						if (igk_count($tab)>1)
						{
							$rm = substr($value, strpos($tab[0], $value)+ strlen($tab[0])+1);
							$obj = igk_html_databinding_getobjForScripting($ctrl,IGK_DATABINDING_RESPONSE_NAME);

							$rm = igk_html_endbinding($rm);
							$obj->args[$tab[0]] = $rm;
							$v = str_replace($v_m, IGK_STR_EMPTY, $v);
						}
						break;
					case "eval":
						$v = str_replace($v_m, str_replace("$", "\\$", $v_m), $v);
						break;
					default:
						
						//no action
					break;
				}
			}
		}
	
	}
	}
	// if ($ctx==null){
	//detect presence of [[:@row]] 	and transform it  to [[:@entrie[$row->clId]]]
	if (($ctx==null) && (igk_get_env("sys://html/bindentries") === 1)){
	//if (preg_match_all("#\[\[:@row]]#i", $v, $tab)){
		$e = igk_get_env("sys://html/bindkey");

		$v = preg_replace("#\[\[:@row]]#i", "[[:@entries[".$e ."]]]", $v);

	}
	//:restore comment
	foreach($comment as $k=>$s)
	{
		$v = str_replace($k, $s, $v);
	}
	// igk_wln($rep);
	// igk_wln($v);
	// igk_exit();
	return $v;
}

function igk_html_databinding_read_obj_litteral(&$obj, $value, $ctrl, $row ){
	$pos = 0;
	$obj->args = array();//reset arguments
	$ln = strlen($value);
	$tab = array();
	$_NS = "_abcdefghijklmnopqrstuvwxyz123456789";
	//readname,
	//readvalue
	$_mode = 0;
	$_v = "";
	$_n = "";
	
	//igk_wln("value : ".$value);
	//TODO: Read Litteral expression name=value[,name=>value]+  
	//regular expression coast a lot. 
	while($pos<$ln){
		$ch = $value[$pos];
		$pos++;
		if ($_mode==0){
			if (strpos($_NS, strtolower($ch))===false){
				$_v = trim($_v);
				if (!empty($_v)){
					if ($_mode==0){
						$tab[$_v]="";
						$_mode =1;
						$_n = $_v;
					}else{
						$_mode =0;
						$tab[$_n]=$_v;
					}
					$_v = "";
				}
				continue;
			}
		}else{
			//read expression
			$depth = array();
			$dp = 0;
			$pos--;
			while($pos<$ln){
				
				$ch = $value[$pos];
				$r = 0;
				switch($ch){
					case '{':
					case '(':
					case '[':
						isset($depth[$ch]) ? $depth[$ch]++ : $depth[$ch]=1;
						$dp++;
						break;
					case '}': $depth['{']--; $dp--; break;
					case ')': $depth['(']--; $dp--; break;
					case ']': $depth['[']--; $dp--; break;
					case "'":
					case "\"":
						//$pos--;
						$g  = igk_str_read_brank($value, $pos, $ch, $ch);
						$_v .=$g;
						$pos++;
						$r =1;
				//		igk_wln($g);
						//continue;
						break;
					case ',':
					if ($dp<=0){
						$tab[$_n]=$_v;
						$_v="";
						$_mode=0;
						$pos++;
						break 2;
					}
					break;
				}
				if (!$r){
					$_v .= $ch;
				}
				$pos++;
			}
			$pos++;
			continue;
			//break;
			// igk_wln("value ");
			// igk_wln($tab);
			// igk_wln($_v);
			// igk_wln($dp);
			// igk_exit();
			
			// if (empty($_v) && $ch=="'"){
				// //read brank
				// $pos--;
				// $g  = igk_str_read_brank($value, $pos, "'", "'");
				// $pos++;
				// $tab[$_n]=$g;
				// $_mode = 0;
				
				// continue;
			// }else if ($ch==','){
				// $tab[$_n]=$_v;
				// $_mode = 0;
				// $_v="";
				// continue;
			// }
		}		
		$_v .= $ch;
		
		
	}
	if (!empty($_v)){
		$tab[$_n]=$_v;
	}
	foreach($tab as $k=>$v){
		$obj->args[$k]=$v;
	}
	// igk_wln($tab);
	// igk_wln($obj->args);
	// igk_exit();

}


function igk_plain_text($txt, $exit=1){
	header("Content-Type:text/plain");
	echo $txt;
	if ($exit)
		igk_exit();
}

function igk_html_init_bind_expression($text){
	//remove comment
	$text = preg_replace("/<!--\\s*(.)+\\s*-->/i", "", $text);

	return $text;

}
///<ummary>utility to build form data</summary>
///<exemple>igk_html_buildform($dv, array(
/// "clName"=>array("require"=>1),
/// "clDisplayName"=>array("require"=>1),
/// "clVersion"=>array("require"=>1, "attribs"=>array("value"=>"1.0"))
/// ), "div");
///</exemple>
function igk_html_buildform($t, $data, $defaultTarget="li"){
	foreach($data as $id=>$k)
	{
		$type = strtolower(igk_getv($k,"type", "text"));
		$required = igk_getv($k,"require",0);
		$args = igk_getv($k,"attribs", null);
		$title = igk_getv($k,"title", null);

		$li = $t->add($defaultTarget);
		$a = null;
		if ($type!=="hidden"){
			$lb = $li->add("label", array("for"=>$id));
			$lb->Content = $title ?? R::ngets("lb.".$id)->getValue() ;
			if ($required){
				$lb->setClass("clrequired");
			}
		}
		switch($type)
		{
			case "select":
					$d  = igk_getv($args, "options");
					if (!is_array($d)){
						igk_die("<b>options </b> argument is required for select input. attribs=&gt;options");
					}
					$sl = $li->addSelect($id);
					$selected =  igk_getv($args, "options-selected");
					$selectattrib = igk_getv($args, "options-select-attribs");
					unset($args["options"]);
					unset($args["options-selected"]);
					unset($args["options-select-attribs"]);

					//load select
					$sl["class"]="+cltext";
					igk_html_build_select_option($sl, $d, $selectattrib ,$selected);

				break;
			case "textarea":
				$a = $li->addTextArea($id);
				$a->Content = $args;
				break;
			case "radio":
			case "checkbox":
				$a = $li->addInput($id, $type);
				if (igk_getr($id)){
				$a["checked"] = "true";
				}
				if ($args){
					$a->AppendAttributes($args);
				}
				break;
			case "hidden":
			case "text":
			case "password":
			default:
				$a = $li->addInput($id, $type);
				$a["type"]=strtolower($type);
				// $a["value"] = $args? igk_getv($args, "value", igk_getr($id)) :  igk_getr($id, is_array($k)? null: $k);
				// if($type=="text"){
					// $a["placeholder"] = igk_getv($args, "placeholder");
				// }
				if ($args){
					$a->AppendAttributes($args);
				}
				break;
		}
		$a["id"]=$a["name"] = $id;
		$args = igk_getv($k,3);
		if ($args !=null)
		{
			$a->AppendAttributes($args);
		}

	}
}

///<summary>build entry</summary>
function igk_html_build_form_entry($name, $type, $n, $value=null){
	$pwd = $name == IGK_FD_PASSWORD;
	switch(strtolower($type))
	{
		case "text":
		case "string":
		case "varchar":
			$n->addSLabelInput($name, $pwd ? "password" : "text", $pwd? "" : $value);
			break;
		case "blob":
			$t = $n->addSLabelTextarea($name, "lb.".$name, array("class"=>"-cltextarea"));
			$t->textarea->Content =$pwd? "" : $value;
			break;
		default:
			$n->addSLabelInput($name, "text",  $value);
			break;
	}

}

///<summary>build menu array for ul</summary>
///<param name='tab'> must be array of {key,'uri'}</param>
///<param name='ul'>the uri tab list</param>
function igk_html_buildmenu_ul($tab, $ul, $selected=null){

	foreach($tab as $k=>$v){
		$a = $ul->add('li')->add('a')->setClass("menui");
		if (strtolower($k)==$selected){
			$a["class"]="+igk-active";
		}
		$a->setAttribute('href', $v)->Content = R::ngets("menu.{$k}");
	}
}

///<summary>utility used to build a form</summary>
///<exemple>
///</exemple>
function igk_html_array_buildform($ul, $param, $targettagname="li")
{
	foreach($param as $k)
	{
		$id = $k[0];
		$type = strtolower($k[1]);
		$required = igk_getv($k,2);
		$args = igk_getv($k,3);

		$li = $ul->add($targettagname);
		$a = null;
		$lb = $li->add("label", array("for"=>$id));
		$lb->Content = R::ngets("lb.".$id)->getValue() ;
		if ($required){
			$lb->setClass("clrequired");
		}

		switch($type)
		{
			case "textarea":
				$a = $li->addTextArea($id);
				$a->Content = $args;
				break;
			case "radio":
			case "checkbox":
				$a = $li->addInput($id, $type);
				if (igk_getr($id)){
				$a["checked"] = "true";
				}
				break;
			case "hidden":
			case "text":
			case "password":
			default:
				$a = $li->addInput($id, $type);
				$a["type"]=strtolower($type);
				$a["value"] = $args? igk_getv($args, "value", igk_getr($id)) :  igk_getr($id);
				break;
		}
		$a["id"]=$a["name"] = $id;
		$args = igk_getv($k,3);
		if ($args !=null)
		{
			$a->AppendAttributes($args);
		}

	}
}

///<summary>html utility . get attributes string presentation</summary>
function igk_html_array_attrs($tab){
	$s = "";	
	foreach($tab as $k=>$v){
		$kv = IGKHtmlItem::GetStringAttribute($v, null);
		if ($kv){
			$s.=" ".$k."=".$kv."";
		}		
	}	
	return $s;
}

///<summary>used to initalize a form with data object</summary>
function igk_html_initform($form, $obj, $formtab){
	$s = array();
	foreach($obj as $k=>$v){
		if ($formtab && array_key_exists($k, $formtab))
		{
			$s[$k] = $formtab[$k];
		}
		else{
			$d = igk_createNode();
			if (is_array($v)){
				$d->addSLabelInput($k, igk_getv($v, "type", "text"),  igk_getv($v, "value"));
			}
			else{
				if (igk_reflection_class_extends($v , IGK_HTML_ITEMBASE_CLASS))
					$d->add($v);
				else
					$d->addSLabelInput($k, "text",  $v);
			}
			$s[$k] = $d;
		}
	}
	foreach($s as $i=>$v){
		if ($v==null)
		continue;
		$form->add($v);
	}
}
///<summary>convert system path to uri scheme</summary>
function igk_html_uri($uri)
{
	if (is_object($uri)){
		igk_die(__FUNCTION__." passing object is not allowed;");
	}
	return str_replace("\\", "/",$uri);
}
//unscape text area content
function igk_html_unscape($out)
{
	$reg = "/(?P<name>([\\\][\"\'\\\]))/i";
	$c = preg_match_all($reg,$out, $t);

	for($i = 0; $i< $c;$i++)
	{
		switch($t["name"][$i])
		{
			case '\\"':
					$out = str_replace('\\"','"', $out);
					break;
			case "\\'":
					$out = str_replace("\\'",'\'', $out);
					break;
			case '\\':
					$out = str_replace('\\',"\\", $out);
					break;
		}
	}
	return $out;
}
///<summary>used to select in node expression</summary>
function igk_html_select($node, $expression){
	$r = array();
	$q = $node;
	$list = array();
	$searchmode = 1;
	while($q){
		switch($searchmode){
			case 1:
			default:
				//search by tag name
				if (strtolower($q->TagName)==$expression){
					$r[] = $q;
				}
			break;
		}
		if ($q->HasChilds){
			///push child into the list
			foreach($q->Childs as $k){
				array_push($list, $k);
			}
		}
		$q=array_pop($list);
	}
	return $r;
}


function igk_html_toggle_class($target, $childtag="tr", $startindex=1,  $class1="table_darkrow", $class2="table_lightrow")
{
	IGKHtmlUtils::ToggleTableClassColor($target, $childtag, $startindex, $class1, $class2);
}
//add item to target
function igk_html_add($item, $target, $index = null)
{
	IGKHtmlUtils::AddItem($item, $target, $index);
}
//add a link items
function igk_html_a_link($target, $hrefuri, $clickuri=null)
{
	$a = $target->add("a");
	if ($a)
	{
		$a["href"] = $hrefuri;
		if ($clickuri)
		$a["onclick"] = "javascript:".$clickuri." return false;";
	}
	return $a;
}
//remove item
function igk_html_rm($item, $dispose=false){
	return IGKHtmlUtils::RemoveItem($item);
}
function igk_html_new($node, $attributes = null)
{
	return igk_createNode($node, $attributes);
}
function igk_html_clonenode($node)
{
	$g = IGKHtmlReader::Load($node->Render());
	return $g  ? igk_getv($g->Childs, 0):null;

}

///<summary>get plateform header info</summary>
function igk_get_header_obj(){
	$obj = igk_createObj();
	$m = "/^IGK_/i";
	foreach(igk_get_allheaders() as $k=>$v){
		if  (!preg_match($m, $k))continue;
		$s = substr($k,4);
		$obj->$s =$v;
	}
	return $obj;
}


///<summary>get if is ajx demand</summary>
function igk_is_ajx_demand(){
	$t = !(igk_get_env(IGK_ENV_NO_AJX_TEST)==1) && (igk_getv(igk_get_allheaders(),"IGK_X_REQUESTED_WITH"));
	return $t;
}
// //return that requrest in on ajx context. to enable ajx context function name must end with "_ajx" or the requested uri must add a ajx=1 variable
// function igk_is_ajx_demand(){
	// return igk_app()->Session->URI_AJX_CONTEXT || igk_is_ajx_demand();
// }

///<summary>check if $uri command came from an uri request</summary>
function igk_is_uri_demand($uri){
	return igk_uri_is_match(igk_io_currentUri(),$uri);
}
function igk_is_conf_connected(){
	return igk_getconfigwebpagectrl()->IsConnected;
}
function igk_is_confpagefolder()
{
	return igk_getconfigwebpagectrl()->CurrentPageFolder == IGK_CONFIG_PAGEFOLDER;
}

function igk_is_empty($t, $default=''){
	if (empty($t)){
		return $default;
	}
	return $t;
}
//----------------------------------------------------------------------------------------
//igk javascript utiliy
//----------------------------------------------------------------------------------------

///</summary>used to enable tinymce on element with thext area</summary>
function igk_js_enable_tinymce($target, $elements=null, $op=null)
{
$element_txt = 'null';
if ($elements)
{
	if (is_array($elements)){
		$element_txt = "{elements: \"".implode(',', $elements)."\"}";
	}
	else
		$element_txt = "{elements: \"".$elements."\"}";
}
if ($op){
	//$element_txt .= ", ".$op;
}
$script = <<<EOF
if (ns_igk.tinyMCE){
	ns_igk.tinyMCE.runOn({$element_txt});
	// setTimeout(function(){//work around tiny on ajx context demand
		// ns_igk.tinyMCE.init({$element_txt});
	// }, 0);
}
else
	console.debug('failed init tiny not present');
EOF;
$sc = $target->add("script");
$sc->Content = $script;

return $sc;
}

//JAVASCRIPT FUNCTION
function igk_js_get_posturi($target, $uri, $func =null, $saveState=false){

$func = ($func==null)?"function(xhr){ if (this.isReady()){ this.setResponseTo(self);}}":$func;
$out = "javascript: (function(a){ var self = a; var q = igk.getParentById(self, '".$target["id"]."'); igk.ajx.post('".$uri."', null, ".$func.", ".igk_parsebool($saveState)."); })(this); ";
return $out;
}
function igk_js_lnk_confirm($text){
	return "igk.form.confirmLink(this, '$text'); return false;";
}
//-----------------------------------------
//igk utility function
//-----------------------------------------
function igk_loadcontroller($dirname)
{
	$files = igk_loadlib($dirname, "php");
	return $files;
}
function igk_wln_assert($cond, $msg){
	if ($cond){
		igk_wln($msg);
	}
}
function igk_wln_flush_data($msg){
	igk_wln($msg);
	igk_flush_data();
}
function igk_html_wln_log($key, $msg){
	$s = igk_wln_ob_get($msg);
	$d = igk_createNode();
	$d->setStyle("font-size:0.94em");
	$d->addDiv()->Content = $key;
	$d->addDiv()
	->setStyle("color: #ddd; background-color: #444")
	->addQuote()->Content = $s;
	$d->RenderAJX();
}

///<summary>dump value</summary>
function igk_dump($v){
	//calling file expression
	$callers=debug_backtrace();
	$from = igk_getv($callers,0);
	$d = igk_createNode('div');
	$d["class"]="igk-dump";
	$l = $d->add('span');
	$l->add("i")->Content = $from["file"];
	$l->addText(':');
	$l->add("b")->Content = $from["line"];
	if (is_object($v)){
			$st = "{";
			$h = 0;
			foreach($v as $k=>$s){
				if ($h){
					$st.= ', ';
				}
				$st.="<font color='red'>\"{$k}\"</font>=&gt;";
				if (is_object($s)){
					$st.='Object T';
				}else if (is_array($s)){
					$st.='Array T';
				}else{
					$st.=$s;
				}
				$h=1;
			}
			$st .= "}";
			$d->addDiv()->Content=$st;
	}else if (is_array($v)){
		$st = "[";
		$h = 0;
		foreach($v as $k=>$s){
			if ($h){
				$st.= '</span>,  ';
			}
			$st.="<span><font color='red'>\"{$k}\"</font>=&gt;";
			if (is_object($s)){
				$st.='Object T';
			}else if (is_array($s)){
				$st.='Array T';
			}else{
				$st.=$s;
			}
			$h=1;
		}
		$st .='</span>]';
		$d->addDiv()->Content=$st;
	}
	return $d->Render();
}

///<summary>detect that the environment in on command line mode</summary>
function igk_is_cmd(){
	//in linux server with "_" return the bash that run the script
	return igk_get_env("sys://func/".__FUNCTION__) || isset($_SERVER["argv"]);
}

function igk_text($msg){
	header("Content-Type: text/plain");
	echo $msg;
}
function igk_xml($msg){
	header("Content-Type: application/xml");
	echo $msg;
}
function igk_json($msg){
	header("Content-Type: application/json");
	echo $msg;
}
function igk_wln($msg)
{

	include(IGK_LIB_DIR.'/Inc/igk_trace.pinc');
	// echo __FILE__." : ".__LINE__. " <br />";
	$v_iscmd = igk_is_cmd();
	$lf = 	$v_iscmd ?IGK_CLF:"<br />";
	

	foreach(func_get_args() as $k){
		$msg = $k;
	if (is_string($msg))
		igk_wl($msg.$lf);
	else{
		if ($msg!==null){
			if (is_object($msg))
			{
				if (igk_reflection_class_extends($msg, IGK_HTML_ITEMBASE_CLASS))
				{
					igk_wln_ob_get($msg->Render().$lf);
					return;
				}
				var_dump($msg);
			}else{
				igk_show_prev($msg);
			}
			igk_wl($lf);
		}
		else{
			igk_wl(__FUNCTION__."::msg is null".$lf);
		}
	}
	}
}

function igk_wl($msg){
	include(dirname(__FILE__).'/Inc/igk_trace.pinc');
	if (is_array($msg) || is_object($msg)){
		print_r($msg);
	}
	else
		echo $msg;
}
function igk_print_ln($msg)
{
	igk_wl($msg . "\n");
}
function igk_print($msg)
{
	igk_wl( $ms);
}

///<summary>utility: write a message in a textarea</summar>
function igk_wln_area($msg)
{
	$t =  igk_createNode("textarea");
	$t->Content = $msg;
	$t->RenderAJX();
}
function igk_wcode($m){
	igk_wl("<code>");
	igk_wl($m);
	igk_wl("</code>");	
}
///<summary>write a message in a stderror</summary>
function igk_ewln($msg){
	if (defined("STDERR"))
		fwrite(STDERR, $msg.IGK_LF);
}


function igk_post_message($msg, $iMessageHandler, $args=null){
	$iMessageHandler->handleCmd($msg, $args);
}

function igk_post_header($extraheader){
	igk_set_env("sys://igk_post_uri/header", $extraheader);
}

function igk_send_request($uri, $method="POST", $args=null, $content=IGK_APP_FORM_CONTENT, $header=null){
	$postdata="";
	if ($args!=null)
		$postdata = http_build_query( $args);

	if ($header==null){
		$header ="";
		$header ='Content-type: '.$content.IGK_CLF
		."Content-Length: ".strlen($postdata)
		.IGK_CLF;

	}

	$opts = array('http' =>
    array(
        'method'  => $method,
        'header'  => $header,
        'content' => $postdata
		//'Content-Length'=>strlen($postdata)
    )
);



	$context  = stream_context_create($opts);
	$result = @file_get_contents($uri, false, $context);
	return $result;
}

function igk_get_platform_header_array(){
	return array(
		'igk-server: '.IGK_PLATEFORM_NAME,
		'igk-server-admin: bondje.doue@igkdev.com',
		'igk-server-build: '.IGK_PLATEFORM_NAME.'('.IGK_VERSION.')',
		'igk-cref: '.igk_app()->Session->getCRef()
	);
}

function igk_curl_post_uri($uri, $args=null, $curlOptions=null, $headers=null){
	$server = igk_getv($_SERVER, "HTTP_USER_AGENT");
	$sessid = igk_getv($_COOKIE, 'PHPSESSID', session_id());
	$strCookie = 'PHPSESSID=' .$sessid.'; path='.igk_get_cookie_path();
	$r = curl_init();
	if ($r){
		// igk_wln($v);
		// igk_flush_data("multi init");
		curl_setopt($r, CURLOPT_URL, $uri);
		curl_setopt($r, CURLOPT_SSL_VERIFYPEER, false);
		curl_setopt($r, CURLOPT_SSL_VERIFYHOST, false);
		if ($args){
			curl_setopt($r, CURLOPT_POSTFIELDS, http_build_query($args)); // to avoid 1001 timeout don't miss with http_build_query

			// igk_wln(http_build_query($args));
		}
		curl_setopt($r, CURLOPT_USERAGENT, $server);
		curl_setopt($r, CURLOPT_COOKIE, $strCookie );

		if ($curlOptions){
			foreach($curlOptions as $k=>$v){
				//igk_wln("option : ".$k." ".$v);
				curl_setopt($r, constant("CURLOPT_".$k), $v);
			}
		}
		if ($headers){
			curl_setopt($r, CURLOPT_HTTPHEADER, $headers);
		}
		IGKOb::Start();
		$data =curl_exec($r);

		if (curl_errno($r)){
			$err = curl_error($r);
			igk_ilog($err, __FUNCTION__);
			igk_set_error(__FUNCTION__,$err);
			igk_notifyctrl()->addError($err);
		}

		$c = IGKOb::Content();
		IGKOb::Clear();
		curl_close($r);
		return $c;
	}
	return null;

}

///<summary>post data in uri script a return data. in balafon system</summary>
function igk_post_uri($uri, $args=null, $content=IGK_APP_FORM_CONTENT, $samesession=true)
{
	if (igk_server_is_local()){
		igk_ilog("/!\\ obsolete : file_get_content not working well. you better invoke directly with a controller : igk_curl_post_uri instead: ".$uri);
		igk_die("failed to pos uri . ".$uri);
	}
	return "";

$postdata = null;
$v_gx = igk_get_env("sys://igk_post_uri/header");


if ($args!=null)
	$postdata = http_build_query( $args);
$header="";
$header='Content-type: '.$content.IGK_CLF.
'igk-server-admin: bondje.doue@igkdev.com'.IGK_CLF.
'igk-server-build: '.IGK_PLATEFORM_NAME.'('.IGK_VERSION.')'.IGK_CLF.
'igk-server: '.IGK_PLATEFORM_NAME
.IGK_CLF.
(!empty($v_gx)?$v_gx.IGK_CLF:"")
."Content-Length: ".strlen($postdata)
.IGK_CLF;
//backup session data
$tab  = $_SESSION;
if ($samesession)
{
	$header.= "Cookie: ".session_name()."=".session_id().IGK_CLF;
	//free session
	session_write_close();
}
// 		$opts = array( 'http'=>array( 'method'=>"GET",
	    // 'header'=>"Accept-language: en\r\n" .
	    // "Cookie: ".session_name()."=".session_id().IGK_CLF ) );
		// $context = stream_context_create($opts);
		// session_write_close();   // this is the key
		// $f = //ff( $u, false, $context);
//

$opts = array('http' =>
    array(
        'method'  => 'POST',
        'header'  => $header,
        'content' => $postdata
		//'Content-Length'=>strlen($postdata)
    )
);
$context  = stream_context_create($opts);
$result = @file_get_contents($uri, false, $context);

if ($samesession)
{
	//restart the session
	session_start();
	//igk_log_write_i("posturi", "start session: ".session_id() );
	//restore session data
	$_SESSION = $tab;
}
igk_set_env("igk_post_uri:/Error",null);
igk_set_env("sys://igk_post_uri/header", null);
if ($result === false){
	// igk_wln("uri result is null");
	// igk_wln(error_get_last());
	igk_set_env("igk_post_uri:/Error", error_get_last());
}
return $result;
}

///<summary> get environment last error for last call to igk_post_uri</summary>
function igk_post_uri_last_error(){
	return igk_get_env("igk_post_uri:/Error");
}
function igk_show_prev($obj)
{
	igk_wl("<pre class=\"igk-prev igk-prev-sys\">");
	print_r($obj);
	igk_wl("</pre>");
}
function igk_show_prevTo($target, $obj)
{
	$s = IGK_STR_EMPTY;
	ob_start();
	igk_show_prev($obj)	;
	$s = ob_get_contents();
	ob_end_clean();
	$target->addDiv()->Content = $s;

}
function igk_show_code($obj)
{
	igk_wl( "<code>");
	igk_wl($obj);
	igk_wl( "</code>");
}
function igk_show_textarea($obj)
{
	igk_wl( "<textarea>");
	igk_wl($obj);
	igk_wl( "</textarea>");
}

function igk_show_keytype($array)
{
	igk_wl( "<pre>");
	$out = IGK_STR_EMPTY;
	if (is_array($array))
	{
	foreach($array as $k => $v)
	{
		$out .= $k . " =&gt; ".$v."\n";
	}
	}
	igk_wl( $out);
	igk_wl( "</pre>");
}
function igk_regtowebpage($ctrl)
{
		$c = igk_get_defaultwebpagectrl();
		if ($c)
			$c->regChildController($ctrl);
}
//TODO: WHY CHAIN
function igk_push_article_chain($f){
	//igk_die("not implement ".__FUNCTION__);
	igk_set_env_array("sys://article_chain", $f);
}
function igk_pop_article_chain($f){
	//igk_die("not implement ".__FUNCTION__);
	$g = igk_get_env("sys://article_chain");
	$r = array_pop($g);
	igk_set_env("sys://article_chain", $g);
}

///<summary>split string data </summary>
function igk_str_split_string($splitchr, $str){
	$ln = strlen($str);
	$pos= 0;
	$tab = array();
	$v = "";
	
	$treat = function ($v){
		$cv = trim($v);
		if (!empty($cv) && (($ln =strlen($cv))> 1) && ($cv[0] == $cv[$ln-1]) && (strpos('"\'', $cv[0] )!==false) ){
			return substr($cv, 1, $ln-2);
		}
		return $cv;
	};
	
	
	while($pos<$ln){
		$ch = $str[$pos];
		
		switch($ch){
			case "\"":
			case "'":
			//$pos--;
			$v.= igk_str_read_brank($str, $pos, $ch, $ch);
			// igk_wln($v);
			$pos++;
			break;
			case $splitchr:
			$tab[] = $treat($v);
			$v = "";
			break;
			default:
			$v.=$ch;
			break;
		}
		$pos++;
	}
	if (!empty($v)){
		$tab[] = $treat($v);
	}
	return $tab;
}


//<summary>add article for this controller to a target node</summary>
//<param name="ctrl">Controler that require to get article</param>
//<param name="name">name or path to current article</param>
//<param name="target">target to node</param>
//<param name="data">data used as row in the target</param>
//<param name="tagname">node tagname</param>
//</param>
function igk_add_article($ctrl ,$name, $target, $data=null, $tagname=null, $forcecreation=true, $evalExpression=true, $articleoptions=true)
{
	$f = $name;
	$n = null;
	$d = dirname($name);
	if (!file_exists($f))
	{
		if (!empty($d) && ($d!=".") && is_dir($d) || IGKString::StartWith($d, igk_io_baseDir()) )
		{
			$f = $ctrl->getArticleInDir(basename($name), $d);
			if (!is_dir($d) && !IGKIO::CreateDir($d))
			{
				igk_ilog(__FUNCTION__, "create directory [{$d}] failed.");
				return;
			}
		}
		else{
			if(!file_exists($name) && ($ctrl !=null))
				$f = $ctrl->getArticle($name);
			else
				return;
		}
	}
	if ($forcecreation && !file_exists($f))
		{
			//save article
			igk_io_save_file_as_utf8_wbom($f, IGK_STR_EMPTY, true);

			//igk_io_save_file_as_utf8($f, IGK_STR_EMPTY, true);
		}
		if (($target==null) && ($tagname==null))
		{
			return;
		}
		igk_push_article_chain($f);

		if ($tagname == null){
			$n = $target;
		}
		else{
			$n = $target->add($tagname);
		}

		if ($n ==null )
			igk_die("igk_add_article::target is null" );
		if (!is_dir($f) && file_exists($f))
		{
			$content = igk_io_read_allfile($f);
			if ($evalExpression){
				$content = igk_html_eval_script($content, $ctrl,$data, basename($f));
			}
			$ldcontext= igk_createloading_context($ctrl, $data);
			if ($tagname == null){
				$target->Load($content, $ldcontext );
				igk_html_treatinput($target);
			}
			else if ($n!=null)
				{
					$n->Load($content, $ldcontext);
					igk_html_treatinput($n);
				}
		}
		//add article options
		if ($articleoptions){
			$s = igk_add_article_options($ctrl, $n, $f);
		}
		igk_pop_article_chain($f);
		return $n;
}

///<summary>add articles options</summary>
function igk_add_article_options($ctrl, $node, $filename, $force=0){	//add article options
	$app = igk_app();
	if (!$force && !($app->Configs->allow_article_config && $app->ConfigMode && ($node!=null)))
	{
		return;
	}

	$c = new IGKHtmlArticleConfigNode($ctrl, $node, $filename, $force);
	return $c;
}

///<summary>add article and treat image source as link</summary>
function igk_in_article($ctrl ,$name, $target, $tagname = null)
{
	if ($target==null)
		igk_die("igk_in_article:: target is null" );
		$f= $ctrl->getArticle($name);
		if (file_exists($f))
		{
			$uri = igk_io_baseUri()."/". igk_io_basePath($f);
			if ($tagname == null)
			{
				$target->Load(igk_io_read_allfile($f));//ff($uri));
			}
			else{
				$s = $target->add($tagname);
				$s->Load(igk_io_read_allfile($f));//ff($uri));
			}
		}
		$m = $target->getElementsByTagName("image");
		if ($m){
		$dir = dirname(igk_io_basePath($f));
		foreach($m as $k=>$v)
		{
			if (!IGKValidator::IsUri($v->lnk) && is_file( igk_io_dir($dir."/".$v->lnk)))
			{
				$v->lnk = igk_io_baseUri()."/". $dir."/".$v->lnk;
			}
		}
		}
	return null;
}

function igk_rm_article($ctrl , $name, $alllanguage=false){
	if ($alllanguage)
	{
		$d = dirname($name);
		$exp = "/(\\\\".igk_str_expr(igk_io_dir(basename($name))).")/i";
		//$exp = "/(\\\\class\.C)/i";
		if (!empty($d) && ($d!=".") && is_dir($d))
		{
			$f = igk_io_getfiles($d, $exp, false);
		}
		else{
			if(!file_exists($name))
			{
				$f = igk_io_getfiles($ctrl->getArticlesDir(), $exp, false);
			}
		}
		if ($f){
			$i = 0;
			foreach($f as $k=>$v){
				unlink($v);
				$i++;
			}
			return $i;
		}

	}
	else{
		$f = $name;
		$n = null;
		$d = dirname($name);
		if (!empty($d) && ($d!=".") && is_dir($d))
		{
			$f = $ctrl->getArticleInDir(basename($name), $d);
		}
		else{
			if(!file_exists($name))
				$f = $ctrl->getArticle($name);
		}
		if (file_exists($f)){
			unlink($f);
			return 1;
		}
	}
}

//----------------------------------------------------------------------------------------------------
// controller function
//----------------------------------------------------------------------------------------------------
function igk_ctrl_private_folder($ctrl, $u){
	return $ctrl->getDataDir()."/R/.private/".$u->clLogin;
}
function igk_ctrl_env_param_key($ctrl){
	return "sys://ctrl/".$ctrl->Name;
}
function igk_ctrl_env_view_arg_key($ctrl){
	return strtolower("sys://ctrl/viewargs/".get_class($ctrl)."/view/args");
}

function igk_ctrl_get_app_uri($ctrn, $path=null){
	$c = igk_getctrl($ctrn);
	if ($c){
		return $c->getAppUri($path);
	}
	return null;
}
///<summary>return a controller direct command</summary>
///<param name="ctrl">controller identifier</param>
///<param name="u">function request</param>
///<param name="type">system type</param>
///<param name="port">port request</param>
function igk_ctrl_get_cmd_uri($ctrl, $u=null,$type='sys', $port=null){
	if ($port)
		$port = ":".$port;
	return igk_io_baseUri().$port."/!@{$type}//{$ctrl->Name}/{$u}";
}
///<summary>get configuration setting</summary>
function igk_ctrl_get_setting($ctrl, $n){
	return igk_getv($ctrl->Configs, $n);
}
function igk_ctrl_zone_init($filepath){
	if (!file_exists($filepath))
		return null;
	$b = igk_get_env("sys://ctrl/zone/files");
	if (!$b){
		$b= array();
	}
	if (!isset($b[$filepath])){
		$b[$filepath] = new IGKCtrlZone($filepath);
	}
	igk_set_env("sys://ctrl/zone/files", $b);
	return $b[$filepath];
}
function igk_ctrl_zone($filepath){
	return igk_getv(igk_get_env("sys://ctrl/zone/files"), $filepath);
}
///<summary>CHECK if the name is a reserved name</summary>
function igk_ctrl_is_reservedname($name)
{
	if (preg_match("/^((a(bstract|nd|rray|s))|(c(a(llable|se|tch)|l(ass|one)|on(st|tinue)))|(d(e(clare|fault)|ie|o))|(e(cho|lse(if)?|mpty|nd(declare|for(each)?|if|switch|while)|val|x(it|tends)))|(f(inal|or(each)?|unction))|(g(lobal|oto))|(i(f|mplements|n(clude(_once)?|st(anceof|eadof)|terface)|sset))|
(n(amespace|ew))|(p(r(i(nt|vate)|otected)|ublic))|(re(quire(_once)?|turn))|(s(tatic|witch))|(t(hrow|r(ait|y)))|(u(nset|se))|
(__halt_compiler|break|list|(x)?or|var|while))$/i", trim($name)))
		return true;
	return false;
}



function igk_ctrl_is_current_subdomain($ctrl){
	return igk_sys_is_subdomain() && get_class(igk_app()->SubDomainCtrl) === get_class($ctrl);
}

///<summary>init controller node css class </summary>
function igk_ctrl_init_css($ctrl, $node, $classdef=null){
	if ($ctrl->getEnvParam(IGK_KEY_CSS_NOCLEAR)==1)
			return;
	$c = $node["class"];
	// igk_wln("bbb : ".$c->getValue(). " /// ".$classdef);
	if ($c){
		$c->Clear();
	}
	igk_ctrl_bind_css($ctrl, $node, $classdef);

}
function igk_ctrl_bind_css($ctrl, $n, $classdef=null){
	$k = IGK_CSS_DEFAULT_STYLE_FUNC_KEY;
	$g = null;
	if ($n->iscallback($k)){
		// igk_debug_wln("invoke ...............".$k);
		// igk_debug_wln("invoke : data ".$k);
		$g = $n->$k();
	}
	// igk_debug_wln("failed..................");
	$n["class"] = igk_css_str2class_name(strtolower($ctrl->Name)). ($classdef!=null? " ".$classdef:null). " ".$g;
}
///<summary>used to bind controller css file</summary>
///<param name="ctrl">controller that will be used to bind extra css setting</param>
///<param name="file">pcss file to bind. if null then the primarayCssFile of the controller is used</param>
function igk_ctrl_bind_css_file($ctrl, $file=null){
	$f = $file ?? $ctrl->getPrimaryCssFile();

	if (file_exists($f) && !igk_is_ajx_demand()){

		if (!defined("IGK_FORCSS")){	
			// store to doc theme list
			igk_css_reg_global_style_file($f, $ctrl->Doc->Theme, $ctrl);
		}else{
			// direct rendering
			igk_css_bind_file($ctrl, $f);
		}
	}
}
///<summary>shortcut to primary get controller info</summary>
function igk_ctrl_info($name){
	return igk_getctrl(IGK_CUSTOM_CTRL_MAN_CTRL)->getInfo($name);
}
///<summay>utility load contoller menu stored from database</summary>
///<param name="callback">the callback to call for head menu</param>
function igk_ctrl_loadmenu($ctrl, $menutable, $callback){
		$t = igk_db_table_select_where($menutable, null,  $ctrl,
			false,
			array(
				"Sort"=>"Asc",
				"SortColumn"=>"clIndex"
			)
		);
		foreach($t->Rows as $k=>$v){
			$callback($v);
		}
}

///-------------------------------------------------------------------------------------
///io shortcut
///-------------------------------------------------------------------------------------

//---------------------------------------------------------------------------------
//IGK IO Functions - IO input/ouput management
//---------------------------------------------------------------------------------
///<summary> used to check if uri is directory. used internally </summary>
function igk_io_check_request_file($uri, $failedcallback=null){

	$c = igk_str_rm_start($uri,'/');
	if (!empty($c)){
		$bdir = igk_io_baseDir();
		$dir = igk_io_dir(dirname(igk_io_baseDir()."/".$c));
		if (($bdir != $dir) && is_dir($dir)){
			header("Status: 404");
			header("HTTP/1.0 404 Not Found");
			if ($failedcallback){
				$failedcallback();
			}
			igk_exit();
		}
	}
}

function igk_io_read_header($f, $endpattern)
{
	if(!file_exists($f))
		return false;
	$hf = fopen($f, "r");
	$s = IGK_STR_EMPTY;

	while( ($c = fread($hf, 1))!==null)
	{
		$s .= $c;
		if (preg_match($endpattern, $s))
			break;
	}
	fclose(	$hf);
	return $s;
}
function igk_io_get_article_file($name, $dir, $lang="fr"){
	$file = IGK_STR_EMPTY;
	if (preg_match(IGK_ARTICLE_TEMPLATE_REGEX, $name))
		$file = $dir."/".$name;
	else{
		$file =$dir."/".$name.".".strtolower($lang).".phtml";
	}

	
	return $file;
}
///<summary>get article in folder</summary>
function igk_io_get_article($name, $dir=null){
		if ($dir==null){
			$dir = dirname(__FILE__)."/".IGK_ARTICLES_FOLDER;
		}
		//
		$f = $dir."/".$name;
		if (file_exists($f))
			return $f;
			
		//phtml, html		
		$s =  IGK_ARTICLE_TEMPLATE_REGEX;	
		if (preg_match($s, $name)){
			return igk_io_dir($dir."/".$name);
		}
		//get the article according to requirement 
		$lang = R::GetCurrentLang();
		foreach(["phtml",'html'] as $k=>$v){
			$f = igk_io_dir($dir."/{$name}.{$lang}.{$v}");
			if (file_exists($f))
				return $f;
		}	
		
		$ext = igk_get_article_ext();
		return igk_io_dir($dir."/".$name.$ext);
}
//return the dir from document root
function igk_io_rootBaseDir($dir=null){

	return IGKIO::GetRootBaseDir($dir);
}
///<summary> check if full path</summary>
///<remark>path mus exists</summary>
function igk_io_is_fullpath($d){
	$k = igk_io_dir($d);
	$c = realpath($k);
	if ($c ){
		//patch exists
		return $k==$c;
	}
	$droot = igk_html_uri($_SERVER["DOCUMENT_ROOT"]);
	$d = igk_html_uri($d);
	if (IGKString::StartWith(strtolower($d), strtolower($droot)))
	{
		return true;
	}
	return false;
}
///<summary>retrieve the current uri</summary>
function igk_io_get_uri(){
	$s = igk_sys_srv_uri_scheme()."://".igk_getv($_SERVER,"SERVER_NAME").igk_io_request_uri();
	return $s;
}

function igk_io_getdbconf_file($dir)
{
	return igk_io_dir($dir."/".IGK_DATA_FOLDER."/".IGK_CTRL_DBCONF_FILE);
}
function igk_io_getconf_file($dir)
{
	return igk_io_dir($dir."/".IGK_DATA_FOLDER."/".IGK_CTRL_CONF_FILE);
}

///<summary>shortcut to save file</summary>
function igk_io_touch($filename, $content=''){
		igk_io_save_file_as_utf8_wbom($filename,$content, 1);
}
function igk_io_unlink($file){
	if (file_exists($file)){
		return @unlink($file);
	}
	return 0;
}
///<summary> use to remove empty line from file</summary>
function igk_io_removeEmptyLine($file)
{
	if (!file_exists($file))
		return;
		$f = IGKIO::ReadAllText($file);
		$o = igk_str_remove_empty_line($f);
		igk_io_save_file_as_utf8($file, $o, true);
}
function igk_io_getrelativepath($source, $target)
{
			$o = IGK_STR_EMPTY;
			$v = $target;
			$sdir = $source;
			$i = strpos($target, $source);
			if ($i!== false)
			{
				//child of current dir
				$o = "./". igk_str_rm_start( substr($v,$i + strlen($sdir)), '/');
			}
			else{
				$o = $v;
				//retrieve the parent at
				 $i = strpos($v, $sdir);
				 $p = "../";
				 $sdir = dirname($sdir);
				 $ci = 0;//depth
				 while(!empty($sdir) && ($sdir!= $v))
				 {
					$ci++;
					//go to parent folder until found a correspondance
					$sdir = dirname($sdir);
					if (strpos($v, $sdir)=== false)
					{
						$p.= "../";
					}
					else
						break;
				 }
				 if ($sdir)
				 {
					$o = igk_io_dir($p.igk_str_rm_start( substr($v,$i + strlen($sdir)), '/'));
				 }
			}
			return $o;
}
///<summary>get file in current directory</summary>
///<param name="dir">directory</summary>
///<param name="match">match regex expression or callback</summary>
function igk_io_getfiles($dir, $match=IGK_ALL_REGEX, $recursive=true)
{
	return IGKIO::GetFiles($dir, $match, $recursive);
}
function igk_io_dirs($dir, $match=IGK_ALL_REGEXT, $recursive=true)
{
	return igk_io_dirs($dir, $match,$recursive);

}
///<summary>return the full request uri</summary>
function igk_io_fullrequestUri()
{
	return igk_html_uri(igk_str_rm_last(IGKIO::GetRootUri(), "/")."/".igk_str_rm_start(igk_io_request_uri(),'/'));
}
///<summary>return the full base uri</summary>
function igk_io_fullBaseRequestUri()
{
	return igk_html_uri(igk_str_rm_last(IGKIO::GetRootUri(), "/")."/".igk_str_rm_last(igk_getv(explode('?', igk_str_rm_start(igk_io_request_uri(),'/')),0),'/'));
}
///<summary>return the base request uri</summary>
function igk_io_baseRequestUri(){
	$s = igk_io_baseUri();
	$d = igk_io_fullrequestUri();
	return igk_str_rm_start(substr($d, strlen($s)), '/');
}
///<summary>return the root base request uri. starting with </summary>
///<remark > old function [igk_io_root_base_ur]i rename to [igk_io_rootBaseRequestUri]</remark >
function igk_io_rootBaseRequestUri(){
	$v_ruri = igk_io_baseRequestUri();
	$tab = explode('?',$v_ruri);
	$uri = igk_getv($tab, 0);
	return "/".$uri;
}

///<summary> return the full query request uri</summary>
function igk_io_query_request_uri(){
	$buri = igk_getv(explode("?", igk_io_request_uri()), 0);
	return $buri;
}
///<summary>fullbase query request uri</summary>
function igk_io_full_base_query_request(){
	return igk_io_baseUri().igk_io_query_request_uri();
}
///<summary>get the web site full uri according to uri file pass form basedir</summary>
///<exempl>if you pass string "info" to this function and your website is http://www.igkdev.com the response will be
/// http://www.igkdev.be/info
/// </exemple>
function igk_io_htmluri($uri=null)
{
	return igk_str_rm_last(igk_io_baseUri(), '/'). (($uri)? "/".igk_html_uri($uri) : IGK_STR_EMPTY);
}
function igk_io_save_file_as_utf8($filename, $content, $override=true, $transform=true)
{
	$r =$transform ? igk_ansi2utf8(utf8_encode($content)) : $content;
	return IGKIO::WriteToFile($filename, $r, $override);
}
///<summary>shortcut to igk_io_save_file_as_utf8</summary>
function igk_io_save_file_as_utf8_wbom($filename, $content, $overwrite=true, $chmod=IGK_DEFAULT_FILE_MASK, $type="w+")
{
	if (empty($filename))
			igk_die("filename is empty or null");

		$filename = igk_io_dir($filename);
		if (!is_dir (dirname($filename)))
		{
			if (!IGKIO::CreateDir(dirname($filename)))
				return false;
		}


		if (is_file($filename) && !$overwrite){
			return false;
		}
		$hf = @fopen($filename,  $type);
		if (!$hf)
		{
			return false;
		}
		//write content as utf-8
		$v_iempty =  empty($content);
		//NOTE : if empty notepad editor will open as ansi
		//but:
		//>write something
		//>save an reopend the file it will be at utf8 without bom

		fwrite($hf, $content);
		fflush($hf);
		// if ($v_iempty )
			// ftruncate($hf,0);
		fclose($hf);
		if ($chmod)	{
			if (!@chmod($filename, $chmod))
			{
				if (IGKApp::IsInit())
					igk_notify_error("/!\\ chmod failed " . $filename. " : ".$chmod);
				igk_log_write_i(__FUNCTION__, "chmodfailed");
			}
		}
		return true;
}

//shortcut to igk_io_save_file_as_utf8_wbom
function igk_io_w2file($file, $content, $overwrite=true, $chmod=IGK_DEFAULT_FILE_MASK, $type="w+"){
	return igk_io_save_file_as_utf8_wbom($file, $content, $overwrite, $chmod, $type);
}
///<summary>append to file</summary>
function igk_io_a2file($file, $content, $overwrite=true){
	return igk_io_save_file_as_utf8_wbom($file, $content, $overwrite, IGK_DEFAULT_FILE_MASK, "a+");
}
///<summary>return request base uri without query string</summary>
function igk_io_currentUri(){

	$s = IGK_STR_EMPTY;
	$root = igk_str_rm_last($_SERVER["DOCUMENT_ROOT"], '/');
	$bdir = igk_html_uri($root."/".IGKIO::GetRootBaseDir());
	$fdir = igk_html_uri($root.igk_getv(explode("?", igk_io_request_uri()),0));
	$s = igk_io_baseUri(substr($fdir, strlen($bdir)));

	// igk_wln($bdir);
	// igk_wln($fdir);
	// $s = IGKIO::GetRootBaseDir() ." ---".$_SERVER["DOCUMENT_ROOT"].igk_getv(explode("?", igk_io_request_uri()),0);
	//igk_wln($_SERVER);
	// igk_wln(igk_io_baseUri(substr($fdir, strlen($bdir))));

	return $s;
}


function igk_io_push_request_uri($d){
	igk_set_env("sys://io/globaluri", $d);
}
function igk_io_global_uri(){
	return igk_get_env("sys://io/globaluri");
}

///<summary>shortcut to IGKIO::GetBaseUri</summary>
///<param name="dir">null or existing fullpath directory or file element. </param>
///<return>full base uri path</return>
function igk_io_baseUri($dir=null, $secured=null)
{	
	$secured = $secured===null?igk_getv($_SERVER,'HTTPS')=='on':$secured;
	
		
	
	$s= igk_html_uri(IGKIO::GetBaseUri($dir, $secured ));
	//remove trailling space
	while(IGKString::EndWith($s,'/') && (($k =strlen($s))>0))
	{
		$s = substr($s, 0, $k-1);
	}

	//$s = igk_secure_uri($s, $secured);
	return $s;
}
///<summary>get a secure uri. on ssl protocol</summary>
function igk_secure_uri($s, $secured=false, $ssl_protocol=true){
	if (($secured && !$ssl_protocol) || ($ssl_protocol && igk_sys_srv_is_secure())){
		$s = str_replace("http://", "https://", $s);
	}
	return $s;
}

///<summary>get base current domain uri</summary>
function igk_io_currentBaseDomainUri(){
	$n = igk_sys_srv_uri_scheme()."://".IGKSubDomainManager::GetBaseDomain();
	return $n;
}
function igk_io_currentDomainUri(){
	$n = igk_sys_srv_uri_scheme()."://".(igk_sys_is_subdomain()?igk_sys_current_domain_name() :  IGKSubDomainManager::GetBaseDomain());
	return $n;
}
///<summary> get full current domain uri</summary>
function igk_io_baseDomainUri($secured=null){
	$app = igk_app();
	if (IGKServerInfo::IsLocal())
	{
		$s = igk_io_baseUri();//igk_getv($_SERVER,"REQUEST_SCHEME", "http")."://".IGKSubDomainManager::GetBaseDomain();//igk_io_baseUri();
	}
	else{
		$s = igk_sys_srv_uri_scheme()."://". igk_getv($app->Configs, "website_domain");
	}
	$s = igk_secure_uri($s, $secured);
	return $s;
}

function igk_io_baseUri_i($dir, $secured=null){
	if(empty($dir))
		return IGK_STR_EMPTY;
	return igk_io_baseUri($dir, $secured);
}

function igk_io_store_conf($file, $cnf, $tagname="config", $callback=null){

	$d =  igk_createNode($tagname);
	//store
	foreach($cnf as $k=>$v)
	{
		igk_conf_store_value($d, $k,$v);
	}
	$s = $d->Render();
	// igk_wln("<div>".htmlentities($s)."</div>");
	// exit;
	if( igk_io_save_file_as_utf8($file, $s))
	{
		//reload config setting
		if ($callback){
			$callback();
		}
		return true;
	}
	return false;
}

///<summary>store base64 encoding data to outfile</summary>
function igk_io_store_uploaded_base64($outfile, $data){
	if(empty($data))
		return 0;
	list($d, $v) = explode(";", $data);
	$g = base64_decode(trim(explode(",", str_replace(" ", "+", $v))[1]));
	return igk_io_save_file_as_utf8_wbom($outfile, $g, true);
}


/// retourne le chemin complet . si chemin relatif fournit c'est le cwd qui intervient
function igk_io_getfullpath($path){
	return realpath($path);
}

///<summary>get base directory</summary>
///<remark>return the directory full path according to base directory</remark>
function igk_io_baseDir($dir=null)
{
	if (!defined("IGK_APP_DIR"))
		return null;		
	$l =  IGK_APP_DIR; //igk_io_dir(IGK_APP_DIR);
	if ($dir==null)
		return $l;//IGK_APP_DIR;
	$s = str_replace("\\","\\\\", $l);//igk_io_dir( IGK_APP_DIR));
	$egext = "#^(".$s.")#";
	$dir = igk_io_dir($dir);
	if ($s && preg_match($egext , $dir))
		return $dir;
	return igk_io_dir(IGK_APP_DIR."/".$dir);
}
function igk_io_baseDirIsRoot(& $m=null){
	$bdir = igk_io_baseDir();
	$rdir = igk_io_baseDir(igk_io_dir($_SERVER["DOCUMENT_ROOT"]));
	$h = $bdir == $rdir;
	if ($h)
		$m = $bdir;
	return $h;

}
///<summary> retourne le chemin relatif à  partir de la racine du site. si le repertoire existe.</summary>
///<param name="dir">cwd path or full path</param>
///<remark>$dir must exist</remark>
function igk_io_basePath($dir){
	return igk_io_baseRelativePath(realpath($dir));
}

function igk_io_baseRelativeUri($dir){
	return igk_html_uri(igk_io_baseRelativePath($dir));
}

function igk_io_is_subdir($p, $c){
	if (DIRECTORY_SEPARATOR!="/"){
		$p = str_replace("\\","/", $p);
		$c = str_replace("\\","/", $c);
	}
	return preg_match("#^(?P<name>(".$p."))#", $c);
}
///<summary>return a unix presentation path</summary>
function igk_io_unix_path($p){
	return str_replace("\\", "/", $p);
}

//<summary>retourne un chemin relatif à  partir de la racine du site spécifier par IGK_BASE_DIR</summary>
function igk_io_baseRelativePath($dir, $separator=DIRECTORY_SEPARATOR){
	if (empty($dir)){

		return IGK_STR_EMPTY;
	}


	if ($separator =="\\")
	{
		$dir = str_replace("/","\\",$dir);
	}
	if (IGK_APP_DIR == $dir)
		return IGK_STR_EMPTY;
	if (igk_io_is_subdir(IGK_APP_DIR , $dir)){
		return IGKIO::GetChildRelativePath(IGK_APP_DIR, $dir, $separator);
	}
	$dir1 = explode($separator, IGK_APP_DIR);
	$dir2 = explode($separator, $dir);
	$r = 0;
	$out = PHP_OS=="unix"? $separator:"";
	$c = 0;
	while(!$r && ($c<igk_count($dir1)) && ($c<igk_count($dir2))){

		if ($dir1[$c] == $dir2[$c]){
			if ($c>0)
				$out.= $separator;
			$out.= $dir1[$c];
			$c++;
		}else{
			$r =1;
			break;
		}
	}
	// if (($k = strstr(IGK_APP_DIR, $out))){
		// is a child directory
		// igk_wln("child dir ".$out. " vs ".IGK_APP_DIR. " || ".$k);
		// return IGKIO::GetChildRelativePath(IGK_APP_DIR, $dir, $separator);
	// }
	if ($r){
		// igk_wln("out : ".$out);
		$lv = $c-igk_count($dir1);
		$td = array_slice($dir1, $lv);
		$st = "";
		for($i=0;$i<count($td);$i++){
			$st.="../";
		}
		$ro = $st.join($separator, array_slice($dir2, $c));
		//// igk_wln( array_slice($dir1, $lv));
		// igk_wln( $ro);
		// igk_wln("<a href=\"{$ro}\">open file </a>");
		//e_xit;
		return $ro;
	}
	igk_die("Not resolving failed : {$dir} ");
}


///<summary>shortcut to IGKIO::GetCurrentRelativePath</summary>
///<remark></remark>
///<parma name='dir'> $dir : sever absolute path or basedir relative path</dir>
function igk_io_currentRelativePath($dir,$musexists=1, $separator=DIRECTORY_SEPARATOR)
{
	return IGKIO::GetCurrentDirRelativePath($dir,$musexists,$separator);
}
/// get the current relative uri from dir according to web page base index
function igk_io_currentRelativeUri($dir=IGK_STR_EMPTY)
{
	return IGKIO::GetCurrentRelativeUri($dir);
}
function igk_io_cwdRelativePath($dir)
{
	return IGKIO::GetRelativePath($dir, getcwd());
}
function igk_io_treat_lnk_referer($f)
{
	if (igk_is_ajx_demand())
	{
		$str = trim(igk_getv(explode('?', igk_getv($_SERVER, "HTTP_REFERER")), 0));
		if (!empty($str) && !IGKString::EndWith($str, '/'))
		{
			if (IGKString::StartWith($f,'../'))
				$f = substr($f, 3);
		}
	}
	return $f;
}
///<summary>return the relative uri according to BASEDIR</summary>
function igk_io_fullpath2Uri($file, $img=false)
{
	$f = igk_io_currentRelativeUri(igk_io_baseRelativePath($file));
	if ($img){//treat uri image
		$f = igk_io_treat_lnk_referer($f);
	}
	return $f;
}
///<summary>get the full uri of full path</summary>
function igk_io_fullpath2fulluri($file){

	// igk_wln($file);
	// igk_wln(IGK_APP_DIR);
	// igk_wln($s);
	// igk_wl("\n");
	// igk_wln(igk_io_basePath($file));
	//e_xit;
	$s = igk_io_currentRelativePath( $file);
	if (igk_io_is_subdir(IGK_APP_DIR, $file)){

		$s = str_replace("../","",igk_html_uri($s));
		return igk_html_uri(igk_io_baseUri()."/".$s);
	}
	$s = igk_html_uri(igk_get_current_base_uri()."/".$s);
	return $s;
}





//
///<summary>return the system full path according to BASEDIR.</summary>
///<code>exemple: in window will return c://wamp/website/[$relativepath]</code>
function igk_io_syspath($relativepath=null)
{
	return igk_io_dir(IGK_APP_DIR."/".$relativepath);
}

///<summary>move uploaded file to destination</summary>
function igk_io_move_uploaded_file($file, $destination)
{
	if (!@move_uploaded_file($file, $destination))
	{
		return false;
	}
	return true;
}

function igk_io_moveUploadedFileToDataFolder($name, $dir, $pattern="pics_%d%")
{
	$img = igk_getv($_FILES, $name);
	if ($img){
		if (IGKIO::CreateDir($dir)){
			if (!file_exists($dir."/.htaccess"))
			{
				IGKIO::WriteToFile($dir."/.htaccess", "allow from all");
			}
			for($i = 0; $i<igk_count($img["name"]) ; $i++)
			{
				if (igk_getv($img["error"],$i) == 0)
				{
					$r = str_replace("%d%", $i, $pattern);
					$f = $img["tmp_name"][$i];
					$o = $dir.$r.".".igk_io_path_ext($img["name"][$i]);
					igk_io_move_uploaded_file($f,$o);
				}
			}
		}
	}
}
///<summary>Remove extension from filename @name file name</summary>
function igk_io_remove_ext($name)
{
	if (empty($name))
		return null;
	$t = explode(".", $name);
	if (count($t)>1){
		$s = substr($name, 0, strlen($name) - strlen($t[count($t)-1])-1);
		return $s;
	}
	return $name;
}
///<summary>get file name extension</summary>
function igk_io_path_ext($fname)
{
	if (empty($fname))
		return null;
	$t = explode(".", $fname);
	if (count($t)>0){
		return $t[count($t)-1];
	}
	return null;
}
/// get basename without extension
function igk_io_basenamewithoutext($file)
{
	return igk_io_remove_ext(basename($file));
}

function igk_io_saveContentFromTextArea($file, $content, $overwrite=true)
{
	if (ini_get("magic_quotes_gpc")){
		 $content = stripcslashes($content);
	}
	return igk_io_save_file_as_utf8($file, $content, $overwrite);  //igk_io_save_file_as_utf8($file,  $content, $overwrite);
}
function igk_io_fileIsPicture($type)
{
	$t = array(
		"image/png"=>1,
		"image/jpeg"=>1,
		"image/svg+xml"=>1,
		"image/tiff"=>1,
		"image/gkds"=>1
	);
	return isset($t[$type]);
}

//-----------------------------------------------------------------------------------
//HTML'S UTITLITY FUNCTION
//-----------------------------------------------------------------------------------
function igk_html_add_title($node, $title){
	if ($node==null)
		return;
	$d = $node->addDiv();
	$d["class"] ="igk-title";
	$d->Content = R::ngets($title);
	return $d;
}
///summary get context controller title</summary>
function igk_html_get_title($ctrl, $def=null){
	return igk_getv($ctrl->Configs, 'clTitle' ,igk_sys_getconfig("website_title")) ;
}

///<summary>used to create submenu item</summary>
function igk_html_createmenui($uri, $submenu){
	return new IGKMenuItemObject($uri, $submenu);
}
///<summary>shortcut to init menu</summary>
function igk_html_initmenu($name, $ctrl, $target, $tab, $tag="li", $selected=null){
	igk_getctrl(IGK_MENU_CTRL)->initCustomMenu($name, $ctrl, $target, $tab, $tag, $selected);
}

function igk_html_get_func_param($name){
	return igk_getv(igk_app()->Session->getParam("system://igk_html_func_param"), $name);
}
function igk_html_set_func_param($name, $v){
	$tab = igk_app()->Session->getParam("system://igk_html_func_param");
	if ($tab == null)
		$tab = array();
	$tab[$name] = $v;
	igk_getv(igk_app()->Session->setParam("system://igk_html_func_param"), $tab);
}
function igk_html_reset_func_param(){
	igk_app()->Session->setParam("system://igk_html_func_param", null);
}
//html debug function to parse message
function igk_html_debug_m($m){
	return "<div style=\"background-color:#B92900; color:FFC193;\">{$m}</div>";
}


///<summary>call this to unregister a callback node</summary>
function igk_html_unreg_callback_node($sender){
	$p = $sender->getParentNode();
	$s = $sender->getParam(IGK_NAMED_ID_PARAM);
	if ($s && $p){
		$t = $p->getParam(IGK_NAMED_NODE_PARAM);
		if (isset($t[$s])){
			unset($t[$s]);
			$p->setParam(IGK_NAMED_NODE_PARAM, $t);
		}
	}
}
///<summary>utility add confirm input</summary>
function igk_html_add_confirm($frm){
	$frm->addInput("confirm","hidden", 1);
}
///<summary>utility render mixed value data</summary>
function igk_html_buildview($mix, $target="div", $item="li"){
	$t = igk_createNode($target);
	if (is_object($mix)){
		foreach($mix as $k=>$v){
			$t->add($item)->setClass("{$k}")->Content = $v;
		}
	}
	else if (is_array($mix)){
		foreach($mix as $k=>$v){
			$t->add($item)->setClass("i i-{$k}")->Content = $v;
		}
	}else{
		$t->Content = $mix;
	}
	return $t;
}

///<summary>render on node type shortcut function</summary>
function igk_html_view($nodeType, $content){
	$n = igk_createNode($nodeType);
	$n->addObData($content);
	$n->RenderAJX();
}

///<summary>craete a balafon uri frame</summary>
// Remark: closeuri : uri callback when closing
// target: receive that will the frame. if null will be add to global document body and will be render at the when body requested
function igk_add_new_frame($ctrl, $name, $closeuri =null, $target=null, $reloadcallback=null)
{
	$frame = igk_getctrl(IGK_FRAME_CTRL)->createFrame($name, $ctrl, $closeuri, $reloadcallback);
	if ($target === null)
		$target = igk_app()->Doc->body;
	IGKHtmlUtils::AddItem($frame,  $target);
	return $frame;
}
function igk_frame_is_available($frame){
	return igk_getctrl(IGK_FRAME_CTRL)->IsFrameAvailable($frame);
}
//create a frame that will contain a form
function igk_add_new_frame_ex($ctrl, $id, $title, $uri, & $form, $closed=false){//!!!!! not used
	$frame = igk_add_new_frame($ctrl, $id);
	$div = $frame->BoxContent;
	$div->ClearChilds();
	$frame->Title = $title;
	$frm = $div->addForm();
	$frm["action"]=$uri;
	$frm["igk-ajx-lnk-tg-response"] = $ctrl->TargetNode["id"];
	if ($closed)
		$frm["igk-frame-close"] = "1";
	$form = $frm;
	return $frame;
}

function igk_frame_close_frame_callback($frame)
{
	if (igk_qr_confirm())
	{
		$p =  $frame->Owner->App->getControllerManager()->InvokeUri($frame->closeMethodUri);
		return $p;
	}
}
function igk_frame_add_confirm($ctrl, $id, $uri=null, $closeuri = ".", $title=null,$target=null, $buttonmodel= 0)
{
	$_id =  base64_encode($id);
	$frame = igk_add_new_frame($ctrl,$_id, $closeuri,$target);
	$frame->Title = ($title==null)?R::ngets(IGK_CONFIRM_TITLE):$title;
	$frame->closeMethodUri = $uri;
	$frame->callbackMethod = "igk_frame_close_frame_callback";
	$d = $frame->BoxContent;
	$d->ClearChilds();

	$igk = igk_app();
	$frame->Form = $d->addForm();
	$frame->Form["action"] = $frame->closeUri;
	$frame->Form["igk-confirmframe-response-target"] = $ctrl->TargetNode["id"];
	$frame->Form->Div = $frame->Form->addDiv();
	$frame->Form->addHSep();
	$frame->Form->addInput("confirm", "hidden",1);
	$frame->Form->addInput("frame-id", "hidden",$_id);
	$frame->Form->addInput("frame-close-uri", "hidden", igk_getctrl(IGK_FRAME_CTRL)->getUri("closeFrame_ajx&navigate=false&id=".$_id));
	$frame->Form->addScript()->Content ="window.igk.winui.framebox.init_confirm_frame(ns_igk.getLastScript(), '".$frame->closeUri."&cancel=1"."', ".($igk->Session->URI_AJX_CONTEXT?'true':'false').")";

	$canceluri = $frame->closeUri."&cancel=1";

	switch($buttonmodel)
	{
		case 0:
			$btn = $frame->Form->addBtn("btn_yes", R::ngets("btn.yes"), "submit");

			$btn["onclick"] =  $igk->Session->URI_AJX_CONTEXT?"javascript: return ns_igk.winui.framebox.btn.yes(this);":null;
			//no-
			IGKHtmlUtils::AddBtnLnk($frame->Form, R::ngets("btn.cancel"), "javascript: ".igk_js_post_frame_cmd($canceluri) . " this['igk:framebox'].close(); return false;");
		break;
		case 1:
			$frame->Form->addBtn("btn_ok", R::ngets("btn.ok"), "submit", array("onclick"=>$igk->Session->URI_AJX_CONTEXT?"javascript:return ns_igk.winui.framebox.btn.yes(this);":null) );
			//cancel
			IGKHtmlUtils::AddBtnLnk($frame->Form, R::ngets("btn.cancel"), "javascript: ".igk_js_post_frame_cmd($canceluri). " this['igk:framebox'].close(); return false;");
			break;
	}
	if ($ctrl->CurrentPageFolder == "Configs")
	{
		$frame["class"] = "+igk-cnf-framebox";
	}
	return $frame;
}
function igk_frame_close($name, $navigate=null)
{
	return igk_getctrl(IGK_FRAME_CTRL)->closeFrame($name, $navigate);
}
function igk_get_frame($name){
	return igk_getctrl(IGK_FRAME_CTRL)->getFrame($name);
}

//frame utility functions
function igk_frame_new($ctrl, $id, $closeuri=".", $target=null, $reloadcallback=null)
{
	$frm = igk_getctrl(IGK_FRAME_CTRL)->createFrame($id, $ctrl, $closeuri, $reloadcallback);
	if ($target === null)
		$target = igk_app()->Doc->body;
	igk_html_add($frm,  $target);
	$frm->Script->Content = new IGKFrameScript($frm, "confirm");
	return $frm;
}

function igk_frame_confirm($ctrl, $id, $title=null, $closeuri=".", $target=null, $reloadcallback=null)
{
	$frame = igk_getctrl(IGK_FRAME_CTRL)->createFrame($id, $ctrl, $closeuri, $reloadcallback);
	if ($target === null)
		$target = igk_app()->Doc->body;
	igk_html_add($frm,  $target);

	$frame->Title = ($title==null)? R::ngets(IGK_CONFIRM_TITLE) : $title;
	$d = $frame->BoxContent;
	$d->ClearChilds();

	$igk = $ctrl->App;
	$frame->Form = $d->addForm();
	$frame->Form["action"] = $frame->closeUri;
	$frame->Form["igk-confirmframe-response-target"] = $ctrl->TargetNode["id"];
	$frame->Form->Div = $frame->Form->addDiv();
	$frame->Form->addHSep();
	$frame->Form->addInput("confirm", "hidden",1);
	$frame->Form->addInput("frame-id", "hidden",$id);
	$frame->Form->addInput("frame-close-uri", "hidden", igk_getctrl(IGK_FRAME_CTRL)->getUri("closeFrame_ajx&navigate=false&id=".$id));
	$frame->Form->addScript()->Content ="igk.winui.framebox.init_confirm_frame(igk.getLastScript(), '".$frame->closeUri."&cancel=1"."', ".
	($igk->Session->URI_AJX_CONTEXT?'true':'false')
	.")";

	$canceluri = $frame->closeUri."&cancel=1";
	switch($buttonmodel){
	case 0:
		$btn = $frame->Form->addBtn("btn_yes", R::ngets("btn.yes"), "submit");
		$btn["onclick"] = $igk->Session->URI_AJX_CONTEXT?"javascript: return ns_igk.winui.framebbox.btn.yes(this);":null;
		IGKHtmlUtils::addBtnLnk($frame->Form, R::ngets("btn.no"), "javascript: ".igk_js_post_frame_cmd($canceluri)." this.frame.close(); ");
	break;
	case 1:
		$frame->Form->addBtn("btn_ok", R::ngets("btn.ok"), "submit", array("onclick"=>$igk->Session->URI_AJX_CONTEXT?"javascript:return ns_igk.winui.framebox.btn.yes(this);":null) );
		IGKHtmlUtils::addBtnLnk($frame->Form, R::ngets("btn.cancel"), "javascript: ".igk_js_post_frame_cmd($canceluri)." this.frame.close()" );
		break;
	}

	$frm->Script->Content = new IGKFrameScript($frm, "c");
	return $frm;
}

function igk_frame_js_postform_ref($ctrl){
	return  "javascript: return (function(q,s){ IGK.winui.frameBox.postForm(q.form, q.form.action, s); return false;})(this, '".$ctrl->TargetNode["id"]."');";
}

///<summary>get new relative html relative uri value</summary>
function igk_get_nhru($value)
{
	return new IGKHtmlRelativeUriValueAttribute($value);
}


function igk_register_balafon_db_table($tablenameinterface)
{
	IGKBalafonDBManager::getInstance()->register_db_table($tablenameinterface);
}


//-------------------------------------------------------------------
//database management
//-------------------------------------------------------------------
///<summary>close db and die with a message</summary>
function igk_db_close_die($db, $msg){
	$db->close();
	igk_die($msg);
}
function igk_db_backup_ctrl($ctrl){
	if ($ctrl){
	$tb = igk_db_get_ctrl_tables($ctrl);
	$schema = igk_html_node_DataSchema();
	$apt = igk_get_data_adapter($ctrl->getDataAdapterName());

	if ($apt->connect()){
		 $entries = $schema->addNode("Entries");
		foreach($tb as $k=>$v){
			$rep = $schema->addNode("DataDefinition")->setAttributes(array(
				"TableName"=>$v
			));
			// igk_getctrl(IGK_API_CTRL)->mysql("get_table_definition", $rep, $v, $apt, null, $entries);
		   igk_getctrl(IGK_API_CTRL)->datadb( "get_table_definition", $rep, $v, $apt, null, $entries);

		}
		$apt->close();
	}
	//$schema->RenderXML();
	return $schema;
	}
return null;
}

///<summary>create and filter an object data table to insert in form</summary>
function igk_db_form_data($tablanename, $callbackfilter=null){
	$fi = $callbackfilter!==null;

	$row = igk_db_create_row($tablanename);
	$t = array();
	foreach($row as $k=>$v){

		if ($fi &&  $callbackfilter($k, $t)){
			continue;
		}
		$t[$k] = array();
	}
	return $t;
}


///<summary>create an empty result</summary>
function igk_db_createEmptyResult($ctrl, $result=false){
	$g = igk_get_data_adapter($ctrl);
	$s = $g ? $g->CreateEmptyResult($result) : null;
	return $s;
}
///<summary>create a field objet</summary>
function igk_db_field($n, $op='='){
	$o = (object)array(
		"clName"=>$n,
		"clOperator"=>$op,
		"obj:type"=>__FUNCTION__);
	$o->getValue =function() use($o){
		igk_wln(array_keys(get_defined_vars()));
		return $o->clName;
	};
	return $o;
}
///<summary>get installed system controller</summary>
///<param name="n">name for global controller</param>
function igk_db_sys_ctrl($n){
	$t = igk_app()->Session->getParam(IGKSession::SYSDB_CTRL);
	if ($t){
		return igk_getv($t, $n);
	}
	return null;
}
///<summary>register a global system controller</summary>
///<param name="n">name for global controller</param>
///<param name="ctrlobj">controller or objet for that purpose</param>
function igk_db_reg_sys_ctrl($n, $ctrlobj){
	// igk_log_write_i(__FUNCTiON__, "reg system controller ".$n);
	// igk_die("d");
	$t = igk_app()->Session->getParam(IGKSession::SYSDB_CTRL);
	if (!is_array($t))
		$t = array();
	$t[$n] = $ctrlobj;
	igk_app()->Session->setParam(IGKSession::SYSDB_CTRL, $t);
}
function igk_db_unreg_sys_ctrl($n){
	$t = igk_app()->Session->getParam(IGKSession::SYSDB_CTRL);
	if (isset($t[$n])){
		unset($t[$n]);
		igk_app()->Session->setParam(IGKSession::SYSDB_CTRL, $t);
	}
}
///<summary>create a db expression that will be evaluated</summary>
///<exemple></exemple>
function igk_db_createExpression($value){
	return new IGKDbExpression($value);
}
function igk_db_load_row($src,& $dest){
	$t = (array)$src;
	foreach($dest as $k=>$v){
		if (isset($t[$k]))
			$dest->$k = $t[$k];
	}
}
///<summary>close adapter</summary>
function igk_db_close_adapter($ctrlOrAdapterName){
	$ad = igk_get_data_adapter($ctrlOrAdapterName);
	if ($ad){
		$ad->close();
	}
}
function igk_db_resolv_app_uri($u, $app){
	if (preg_match("/^app:/i", $u)){
		$u = substr($u, 4);
	}
	if (IGKValidator::IsUri($u))
		return $u;
	return $app->getAppUri($u);
}
///<summary> utility function. used to create object from data. the filter exclude data</summary>
function igk_db_createData($obj, $filter){
	$c = new StdClass();
	if ($obj){
		foreach($obj as $k=>$v){
			if (array_key_exists($k, $filter))
			{
				continue;
			}
			$c->$k = $v;
		}
	}
	return $c;
}

///<summary> utility function. create data by filtering with table info</summary>
function igk_db_createDataFromInfo($adapter, $table, $obj, $tabinfo){
	if ($obj===null)
$c = igk_db_create_row($table);
//init c
foreach($tabinfo as $k=>$v){
	if ($v->clNotNull){
		if ($v->clDefault){
			$c->$k = $v->clDefault;
		}
		else if ($v->clLinkType){
			$r = $adapter->select($v->clLinkType)->getRowAtIndex(0);
			if ($r){
				$c->$k = $r->clId;
			}
		}
	}
}
	if ($obj){
		foreach($obj as $k=>$v){
			if (array_key_exists($k, $tabinfo))
			{
				$c->$k = $v;
			}
		}
	}
	return $c;

}

function igk_db_getdefaultv($v){
	if ($v->clNotNull){
		switch(strtolower($v->clType)){
			case "int":
			case "float":
			if (empty($v->clDefault))
				return 0;
			break;
		}
	}
	return $v->clDefault;
}
function igk_db_create_obj_from_infokey($tb,$dataobj=null){
// if (igk_is_debug()){
	// igk_ilog("copy row ::::> ".$dataobj);
// }
	if ($tb)
	{
		$obj = igk_createObj();//(object)igk_array_tokeys(array_keys($tb), false);
		foreach($tb as $k=>$v){

			$obj->$k = igk_db_getdefaultv($v);
		}

		if ($dataobj != null){
			igk_db_copy_row($obj, $dataobj);
		}
		return $obj;
	}
	return null;
}
///<summary>create and empty row from global system datatable name</summary>
///<param name="tablename">registrated global sql data table</param>
///<param name="dataobj">object that will fill the value</param>
function igk_db_create_row($tablename, $dataobj=null){
	$tb = igk_db_getdatatableinfokey($tablename);
	return igk_db_create_obj_from_infokey($tb,$dataobj);

}

///<summary>copy filter dataobj value value only . erase the src data attributes if key not found in data object </summay>
function igk_db_copy_row(&$src, $dataobj, $erase=1){
	foreach($src as $k=>$v){
		if (isset($dataobj->$k)){
			$src->$k = $dataobj->$k;
		}else{
			//igk_wln("not found ".$k);
			if ($erase)
			$src->$k = null;
		}
	}
}

// function igk_db_copy_row_tinfo (&$src, $dataobj, $tb , $erase=1){
	// foreach($src as $k=>$v){
		// if (isset($dataobj->$k)){
			// $src->$k = $dataobj->$k;
		// }else{
			// //igk_wln("not found ".$k);
			// if ($erase)
			// $src->$k = null;
		// }
	// }

// }


///<summary>create and empty row from ctrl data table datatable na.me</summary>
function igk_db_create_row_obj($tablename, $ctrl, $dataobj=null){
	$tb = igk_db_ctrl_datatable_info_key($ctrl, $tablename);
	return igk_db_create_obj_from_infokey($tb,$dataobj);
}
function igk_db_create_opt_obj(){
	$obj = igk_createObj();
	$obj->Operand = "AND";
	$s ="@callback";
	$obj->$s = null;
	$obj->Sort = null;
	$obj->SortColumn = null;
	return $obj;
}

///<summary>get the definition key in this table</summary>
function igk_db_getdatatableinfokey($tablename){
	// igk_debug_wln(__FUNCTION__);
	if (!is_string($tablename)){
		igk_die("tablename not a string");
	}
	$tab = igk_getctrl(IGK_MYSQL_DB_CTRL)->getDataTableDefinition($tablename);
	if ($tab){
		return igk_array_object_refkey(igk_getv($tab, 'ColumnInfo'), IGK_FD_NAME);
	}
	return null;
}

function igk_db_ref_keyinfo($h){
	// igk_debug_wln(__FUNCTION__);
	 $c = igk_getv($h, 'ColumnInfo');
	 if ($c)
		return igk_array_object_refkey($c, IGK_FD_NAME);
	return $h;
}
function igk_db_ctrl_datatable_info_key($ctrl, $table){
	// igk_debug_wln(__FUNCTION__);
		//$key = IGK_CTRL_TABLE_INFO_KEY;
		$tc = $ctrl->getParam(IGK_CTRL_TABLE_INFO_KEY, array());
		//$tc = null;
		// igk_wln("inf");
		// igk_wln($tc);
		//e_xit;
		// if ($table == "tbigk_groupauthorizations"){
			// igk_wln($ctrl->Name);
			// igk_wln("?  ".$ctrl->UseDataSchema);
			// igk_wln($c);
			// $c = $ctrl->getDataTableInfo();


			// igk_wln("taddd .... ".$ctrl->getDataTableName());
			// igk_wln($c);

		// if (!$ctrl->UseDataSchema && ($ctrl->getDataTableName() != $table)){
			// igk_wln(IGK_CTRL_TABLE_INFO_KEY);
			// igk_wln(igk_db_get_table_info($table));
			// igk_die("single controller `{$ctrl->Name}` does't manage this table `{$table}` info  `{$ctrl->getDataTableName()}`");
		// }
		//e_xit;

		// if($table == "tbsnack_configs"){
			// igk_wln($ctrl->Name);
			// igk_wln("?  schemas : ".$ctrl->UseDataSchema);
			// igk_wln($c);
			// $c = $ctrl->getDataTableInfo();
				// igk_wln("a ==============");
				// igk_wln($c);
			//e_xit;
		// }

		$h = igk_getv($tc, $table);
		if ($h){
			return $h;
		}
		$c = $ctrl->getDataTableInfo();
		if (!$c)
			igk_die("getDataTableInfo info return null");

		if ($ctrl->UseDataSchema){
			//manage multiple table
			$h=  igk_getv($c, $table) ?? igk_die(__FUNCTION__.", no table {$table} found in [{$ctrl->Name}]");

			$d = igk_db_ref_keyinfo($h);

			if ($d != null ){ //store to table info key
				$tc[$table] = $d;
				$ctrl->setParam(IGK_CTRL_TABLE_INFO_KEY, $tc);
			}
			return $d;

		}else{
			//need to convert table info definition.
			// igk_wln($c);
			// exit_
			// igk_wln("not multi table");
			if($ctrl->getDataTableName() != $table)
				return null;
					//igk_die("does't manage table {$table}");
			if (igk_count($c)>0){
				$m  = igk_array_object_refkey($c, IGK_FD_NAME);
				$ctrl->setParam(IGK_CTRL_TABLE_INFO_KEY, array($table=>$m));
				return $m;
			}
			return null;
		}
}
function igk_db_sync_push_data(& $km, & $m , $k){
		if(!isset($km[$k])){
			$m['key'] .=  empty($m['key'])? $k :','.$k;
			$km[$k] = 1;
		}
}

///<summary>return an array of table column used to synchronise data</summary>
function igk_db_getsync_key($tablename){
	$tab = igk_getctrl(IGK_MYSQL_DB_CTRL)->getDataTableDefinition($tablename);

	if ($tab){
		$t = igk_getv($tab, 'SyncKey');
		if ($t === null){//no synchronise key found
			$h = igk_array_object_refkey(igk_getv($tab, 'ColumnInfo'), IGK_FD_NAME);
			$m = array();
			$km = array();
			$m['key'] = IGK_STR_EMPTY;
			// igk_wln($h);
			foreach($h as $k=>$v){
				if (($k == IGK_FD_ID)||
					isset($v->clLinkType)
					)
					continue; //ignore id, link type,

				if ($v->clIsUnique || $v->clIsPrimary)
				{
					$m[$k] = 1;
					igk_db_sync_push_data($km, $m, $k);
				}
				else if ($v->clIsUniqueColumnMember){
					if (!isset($m["_unique_columns"])){
						$m["_unique_columns"] = array();
					}
					$m["_unique_columns"][] = $k;
					igk_db_sync_push_data($km, $m, $k);
				}
			}
			unset($k);
			if (igk_count($m)>0)
				if (isset($m["_unique_columns"]))
				{
					if(igk_count($m["_unique_columns"])==1){
					$s = $m["_unique_columns"][0];
					igk_db_sync_push_data($km, $m, $s);
					unset($m["_unique_columns"]);

					}
				}
				$t = explode(',', $m['key']);
		}

		if (is_string($t)){
			$t = explode(',',$t);
		}
		return $t;
	}
	return null;
}
function igk_db_getdatatable_owner($tablename){
	return igk_getctrl(IGK_MYSQL_DB_CTRL)->getDataTableCtrl($tablename);
}
function igk_db_get_ctrl_tables($ctrl){
	return igk_getctrl(IGK_MYSQL_DB_CTRL)->getTablesFor($ctrl);
}

//<summary>get table result as xml response</summary>
function igk_db_table_xmlview_response($tablename, $where=null){
		$tb = igk_createNode("DataTable");
		$tb["name"] = $tablename;
		$dataentry = $tb->addDataEntry();
		$dataentry->LoadData(igk_db_table_select_where($tablename, $where));
		$e = IGKHtmlItemm::CreateWebNode("XmlViewer");
		$e->Load($dataentry);
		return $e->Render(null);
}

///<summary>return the declared table definition structure</summary>
function igk_db_get_table_def($adaptername=IGK_MYSQL_DATAADAPTER)
{
	$v_dictionary = array();
		foreach(igk_sys_getall_ctrl() as $k)
		{
			$v_name = $k->DataTableName; // primary table name
			//retrieve controller that match this adapter
			if ((($k->DataAdapterName != $adaptername) ||
			empty($v_name) ||
			(($v_info = $k->DataTableInfo) == null)))
				continue;
			//
			$te = null;
			if (isset($v_info["data-schema"]) || is_array($v_info) && is_array(igk_getv(array_values($v_info),0)))
			{
				foreach($v_info as $table=>$rinfo){
					if ($table == "data-schema")continue;
					$info = (object)array(
					"tableName"=>$table,
					"tableInfo"=>IGKdbColumnInfo::AssocInfo($rinfo, $table),
					"Ctrl"=>$k,
					IGK_ENTRIES_TAGNAME=>$te,
					"AdapterName"=>$adaptername
					);
					$v_dictionary[$info->tableName] = $info;
				}
			}
			else{
			$info = (object)array(
			"tableName"=>$v_name,
			"tableInfo"=>IGKdbColumnInfo::AssocInfo($v_info, $v_name),
			"Ctrl"=>$k,
			IGK_ENTRIES_TAGNAME=>$te,
			"AdapterName"=>$adaptername
			);
			$v_dictionary[$info->tableName] = $info;
			}
		}
	return $v_dictionary;
}

///<summary>get table that contains specified column</summary>
function igk_db_get_table_with_column($columnName, $adaptername=IGK_MYSQL_DATAADAPTER){
	$dic = igk_db_get_table_def($adaptername);
	$tab = array();
	$columnName = strtolower($columnName);
	foreach($dic as $k=>$v){
		$tb = array_keys($v->tableInfo);
		foreach($tb as $s=>$t){
			if (strtolower($t) == $columnName)
			{
				$tab[] = $v->tableName;
				break;
			}
		}
	}
	return $tab;
}

function igk_db_create_expression($v){
	return new IGKDbExpression($v);
}


function igk_db_getid($ctrlorName, $table, $condition){
	$r = igk_db_table_select_where($table, $condition, $ctrlorName);
	if ($r && ($r->RowCount==1)){
		return igk_getv($r->getRowAtIndex(0), IGK_FD_ID);
	}
	// $ad =  igk_get_data_adapter($ctrlorName);
	// igk_wln("last query ".$ad->getLastQuery());
	// igk_db_dump_result($ad->sendQuery("SELECT DATABASE()"));
	// igk_wln("condition $r ");

	// igk_wln($condition);

	return null;
}

function igk_db_drop_table($ctrlorName, $table, $leaveOpen=false){
	$apt = igk_get_data_adapter($ctrlorName);
	if ($apt)
	{
		$apt->connect();
		$apt->dropTable($table);
		$apt->close($leaveOpen);
	}

}
function igk_db_close($ctrlorName){
	$apt = igk_get_data_adapter($ctrlorName);
	if ($apt)
		$apt->close(false);
}
///<summary> load data schema from loaded node </summary>
function igk_db_load_data_and_entries_schemas_node($d){


	$n = $d->TagName ==IGK_SCHEMA_TAGNAME ? $d: igk_getv($d->getElementsByTagName(IGK_SCHEMA_TAGNAME),0);
	if ($n){
		$obj = (object)array("Data"=>null, "Entries"=>null, "Relations"=>null);
		$tab = array();
		$relation = array();
		igk_db_load_data_schema_array($n, $tab, $relation);
		$obj->Data=$tab;
		$obj->Relations=$relation;

		$e = $n ? igk_getv($n->getElementsByTagName(IGK_ENTRIES_TAGNAME), 0) : null;
		$tab = array();
		if ($e)
			igk_db_load_entries_array($e, $tab);
		$obj->Entries = $tab;

		return $obj;
	}
	return null;
}
function igk_db_load_data_and_entries_schemas($file){

	if (file_exists($file))
	{
		$d = IGKHtmlReader::LoadXMLFile($file);
		return igk_db_load_data_and_entries_schemas_node($d);

	}
	return null;
}
///<summary>load data schema in array</summary>
function igk_db_load_data_schema_array($n, & $tab, & $tbrelation=null){

		foreach($n->getElementsByTagName(IGK_DATA_DEF_TAGNAME) as $k=>$v)
		{
			$c = array();
			$tb = $v["TableName"];
			foreach($v->getElementsByTagName(IGK_COLUMN_TAGNAME) as $kk=>$vv)
			{
				$cl = new IGKdbColumnInfo(igk_to_array($vv->Attributes));//->ToArray());
				// igk_wln("link type ".$cl->clLinkType );
				if (($tbrelation !==null) && !empty($cl->clLinkType) ){
					if (!isset($tbrelation[$tb]))
						$tbrelation[$tb] = array();
					$tbrelation[$tb][$cl->clName] = array("Column"=>$cl->clName, "Table"=>$cl->clLinkType);
					//igk_push_array($tbrelation, $tb, array("Column"=>$cl->clName, "Table"=>$cl->clLinkType));
				}
				$c[] = $cl;
			}
			$tb = $v["TableName"];
			$tab[$tb] = array("ColumnInfo"=>$c, "Description"=>igk_getv($v, "Description"));
		}
}
///<summary>load data from schema files</summary>
function igk_db_load_data_schemas($file){
		$tab = array();
		if (file_exists($file))
		{
			$d = IGKHtmlReader::LoadFile($file);
			$n = igk_getv($d->getElementsByTagName(IGK_SCHEMA_TAGNAME),0);
			if ($n){
				igk_db_load_data_schema_array($n, $tab);

			}
		}
		// else{
			// igk_log_write_i(__FUNCTION__, "file not exists ".$file);
		// }
		return $tab;
}
function igk_db_load_entries_array($n, & $tab){

	foreach($n->Childs as $k=>$v)
	{
		if ($v->TagName !== IGK_ROWS_TAGNAME)
			continue;
		$tb= $v["For"];
		if (empty($tb))
			continue;
		$c = array();
		$ttb = $v->getElementsByTagName(IGK_ROW_TAGNAME);

		foreach($ttb as $kk=>$vv)
		{
			$attr = $vv->Attributes;
			if ($attr)
			$c[] = $attr->ToArray();
		}
		if (igk_count($c) > 0){

			$tab[$tb] = $c;
		}
	}
}
///<summary>ctrl adapter</suppary>
function igk_db_load_entries($ctrl, $tablename, $entries){

		$v_r =  igk_db_create_row($tablename);
		//foreach entries
		foreach($entries as $e=>$ee)
		{
			$v = igk_createObj();
			$b = (object)$ee;
			foreach($v_r as $k=>$v){
				if (isset($b->$k)){
					$b->$k= $b->$k;
				}else{
					$b->$k = null; //default value
				}
			}
			if (!$ctrl->insert($tablename, $b ))
			{
				igk_debuggerview()->addNotifyBox("error")->Content = "insert failed ".$ctrl->getError();
				return false;
			}
		}
}
///<summary>get default entries from data schema</summary>
///<summary>get default entries from data schema</summary>
function igk_db_load_data_entries_schemas($file){
		$tab = array();
		if (file_exists($file))
		{
			igk_debug_wln(__FUNCTION__."::: load files");
			$d = IGKHtmlReader::LoadXMLFile($file);
			$n = igk_getv($d->getElementsByTagName(IGK_SCHEMA_TAGNAME), 0);
			$n = $n ? igk_getv($n->getElementsByTagName(IGK_ENTRIES_TAGNAME), 0) : null;
			if ($n){
				igk_db_load_entries_array($n, $tab);

			}
		}
		// if (igk_count($tab)>0)
			// igk_wln(array_keys($tab));
		return $tab;
}

function igk_db_init_from_data_schema($ctrl, $schema, $entries=null){
		$tb = null;
		$db = igk_get_data_adapter($ctrl, true);
		if ($db){
			if ($db->connect()){
				// igk_wln("connect...=".$db->getDbName());
				// igk_db_dump_result($db->sendQuery('SELECT DATABASE()'));
				//$db->selectdb($this->App->Configs->db_name);
				foreach($schema as $k=>$v)
				{

					//igk_wln("entry $k");
					// igk_wln(igk_getv($etb, $k));
					$n = igk_db_get_table_name($k);
					$data = $entries? igk_getv($entries, $k) : null;
					// if ($n == "tbigk_community") {
						// igk_wln(__LINE__);
						// igk_wln($n);
						// igk_wln($k);
						// igk_debug(true);
					// $r = $db->createTable($n,
						// igk_getv($v, 'ColumnInfo'),
						// $data,
						// igk_getv($v, 'Description'),
						// $db->DbName
					// );
						// igk_debug(false);
						// igk_wln($data);
						// igk_wln(htmlentities( $data->RenderAJX()));
						// $db->dropTable($n);
						//e_xit;
					// }
					// else{
					$r = $db->createTable($n,
						igk_getv($v, 'ColumnInfo'),
						$data,
						igk_getv($v, 'Description'),
						$db->DbName
					);
					// }
				}
				$db->close();
				//$db->getNoLoadedEntry();
		}else{
			igk_debug_wln("db not connected");
		}

		}
		//igk_exit();
		return $tb;
}

function igk_db_getobj($tab){
	$t = array();
	foreach($tab as $k)
	{
		$t[$k->clName] = null;
	}
	return (object)$t;
}
function igk_db_last_id($ctrl, $leaveopen=false){
	$db = igk_get_data_adapter($ctrl);
	$r = null;
	if ($db){
		if ($db->connect()){

			$r = $db->getLastId();
			$db->close($leaveopen);
		}
		else{
			igk_debug_wln("<div class=\"igk-danger\" >/!\ connect to db failed [".__FUNCTION__."]</div>");
		}
		return $r;
	}
	return null;
}

// function igk_db_lastid($ctrlorName){
	// $apt = igk_get_data_adapter($ctrlorName);
	// if ($apt)
		// return $apt->getLastId();
	// return 0;
// }

function igk_db_select($ctrl, $tablename, $conditions=null){

	$db = igk_get_data_adapter($ctrl);
	$r = null;
	if ($db){
		if ($db->connect()){
			try{
				$r = $db->selectAndWhere($tablename, $conditions);
			}
			catch(Exception $ex)
			{
				igk_wln("error append".$ex);
			}
			$db->close();
		}
	}
	return $r;
}
function igk_db_select_all($ctrl, $tablename=null)
{
	return igk_db_select($ctrl, $tablename ? $tablename: $ctrl->DataTableName);
}
function igk_db_table_exists($ctrl){
	return igk_db_table_count_where($ctrl->DataTableName, null, $ctrl);
}
function igk_db_select_wherec($ctrl, $andcondition){
	$db = igk_get_data_adapter($ctrl);
	$r = null;
	if ($db){
		$db->connect();
		try{
			$r = $db->selectAndWhere($ctrl->DataTableName, $andcondition);
		}
		catch(Exception $ex)
		{
			igk_log_write_i("error", $ex);
		}
		$db->close();
		return $r;
	}
	return null;
}
function igk_db_table_count_where($table, $andcondition=null, $adapter=IGK_MYSQL_DATAADAPTER, $leaveOpen = false)
{
	$db = igk_get_data_adapter($adapter);
	$r = null;
	if ($db){
		$db->connect();
		try{
			$r = $db->countAndWhere($table, $andcondition);
		}
		catch(Exception $ex)
		{
			igk_log_write_i("error", $ex);
		}
		$db->close($leaveOpen);
		return $r;
	}
	return null;
}

///<summary>get table defition of a mysql db definition</summary>
function igk_db_get_table_info($table){
	$tab = igk_getctrl(IGK_MYSQL_DB_CTRL)->getDataTableDefinition($table);
	return $tab;
}

function igk_db_table_select_relationnal_where($table, $condition,  $ctrl =null, $leaveOpen=false){
	///TODO: DB SELECT RELATIONAL	- not yet implement
	$r = igk_db_table_select_where($table, $condition, $ctrl, $leaveOpen);
	$tab = igk_db_get_table_info($table);
	igk_exit();
}
function igk_db_table_select_where($table, $andcondition=null, $adapter=IGK_MYSQL_DATAADAPTER, $leaveOpen = false, $options=null)//mixed option array
{
	$db = igk_get_data_adapter($adapter);
	$isad =  $adapter == $db;
	// igk_wln($isad);
	// igk_wln($andcondition);
	//e_xit;
	$r = null;
	if ($db){
		if (!$isad && !$db->connect()) {
			igk_ilog(__FUNCTION__." try connect failed ");
			return $r;
			//igk_wln($db->connect());//$adapter);
		}
		try{

			$r = $db->selectAndWhere($table, $andcondition, $options);

		}
		catch(Exception $ex){
			igk_elog("error", $ex);
		}
		if (!$isad) $db->close($leaveOpen);

	}
	return $r;
}
function igk_db_load_to_node($result, $p){// load data to node
	if ($result && $result->RowCount >0)
	{
		foreach($result->Rows as $k=>$v)
		{
			$p->add("Item")->setAttributes($v);
		}
	}
}
function igk_db_view_result_node($result, $max=-1){
	//igk_wln("r");
	if (!$result || !igk_reflection_class_implement($result, 'IIGKQueryResult')){
		return null;
	}
	$n = igk_createNode("NoTagNode");
	$r =  $n->addTable();//igk_createNode("table");

	if ($result->getResultType() == "boolean"){
		$tr = $r->addTr();
		$tr->add("th")->Content = "result";
		$tr = $r->addTr();
		$tr->addTd()->Content = $result->getRowAtIndex(0);
		return $r;
	}
	$tr = $r->addTr();
	$key = array();
	foreach($result->Columns as $k=>$v){
		//igk_wln($result);
		$tr->add("th")->Content = $v->name;
		$key [] = $v->name;
	}

	if ($max>0){
		igk_html_paginate($r,
		  $n,
		  $result->Rows,
		  $max,
		  function($table, $k,$v)use($key){
				$tr = $table->addTr();
				foreach($key as $j){
					$tr->addTd()->Content = $v->$j;
				}
		  },
		  "",
		  1
		  );
	}else{
		foreach($result->Rows as $k=>$v){
			$tr = $r->addTr();

			foreach($key as $j){
				$tr->addTd()->Content = $v->$j;

			}
			//igk_wln($tr->Render());

			// figk_wln($tr->addTd()->Content oreach($v as $s=>$m){
				// $tr->addTd()->Content = $m;
			// }
		}
	}
	return $n;
}

//filter object entries to fit data base column info
function igk_db_objentries($ctrl, $tab)
{
			$ttab = $ctrl->getDataTableInfo();
			if( !$tab)
				return null;
			$v_otab = array ();
			$s = IGK_FD_NAME;
			foreach($ttab as $k=>$v)
			{
				$tk = igk_getv($v,IGK_FD_NAME);
				$v_otab[$tk] = igk_getv($tab, $tk);
			}
			return $v_otab;
}
///<summary>crate a adapter from class name</summary>
function igk_create_adapter_from_classname($n, $ctrl=null, $params=null){
	$out = new $n(!is_string($ctrl)? $ctrl: null);
	if (($out !=null) && ($params !=null))
	{
		$out->configure($params);
	}
	if (!$out->IsAvailable)
	{
		igk_debug_wln("adapter ".$ctrl." not available");
		return null;
	}
	return $out;
}
///<summary>create a new data adapter from existing</summary>
function igk_get_new_data_adapter($controllerOrAdpaterName, $throwException=false){
	$ad  = igk_get_data_adapter($controllerOrAdpaterName, false);
	if ($ad !==null){
		$n = get_class($ad);
		$r = igk_create_adapter_from_classname($n);
		return $r;
	}
	return null;
}
function igk_is_controller($obj){
	return  is_object($obj) && igk_reflection_class_extends($obj, "IGKControllerBase");
}
///<summary>get adapter </summary>
function igk_get_data_adapter($controllerOrAdpaterName, $throwException=false)
{
	$n = IGK_STR_EMPTY;
	if (is_string($controllerOrAdpaterName))
		$n = $controllerOrAdpaterName;
	else if (is_object($controllerOrAdpaterName))
	{

		if (igk_reflection_class_extends($controllerOrAdpaterName, "IGKDataAdapter"))
			return $controllerOrAdpaterName;
		if (igk_is_controller($controllerOrAdpaterName))
			$n = $controllerOrAdpaterName->getDataAdapterName();
	}
	$r = IGKDataAdapter::CreateDataAdapter($n, $throwException);
	return $r;
}
function igk_register_dataadapter($name, $class){
	igk_set_env_keys("sys://dataadapter", strtoupper($name), $class);
}
function igk_db_get_entries($controllerOrAdpaterName, $table, $dbname=null)
{
	$adapt = igk_get_data_adapter($controllerOrAdpaterName, false);
	if($adapt)
	{
		$adapt->connect($dbname);
		$r =  $adapt->selectAll($table);
		$adapt->close();
		return $r;
	}
	return null;
}
function igk_db_clear_table($ctrlOrAdapterName, $table, $dbname=null){

	$adapt = igk_get_data_adapter($ctrlOrAdapterName, false);
	if($adapt)
	{
		$adapt->connect($dbname);
		$r = $adapt->deleteAll($table);
		$adapt->close();
		return $r;
	}
	return null;
}
function igk_db_insertc($ctrl,$entries){//insert db

	return igk_db_insert($ctrl, $ctrl->getDataTableName(), $entries, null);
}
///<summary>insert in table if data not exists</summary>
function igk_db_insert_if_not_exists($controllerOrAdpaterName, $table, $entry, $condition=null, $dbname=null, $leaveOpen= false, $Op='OR')
{
	$adapt = igk_get_data_adapter($controllerOrAdpaterName, false);
	$r = false;
	$v_is_c = igk_is_controller($controllerOrAdpaterName);
	if($adapt)
	{
		// if(igk_is_debug())
		// igk_wln("is controller ? ".$v_is_c);

		 // $controllerOrAdpaterName->setParam(IGK_CTRL_TABLE_INFO_KEY, null);
		 // igk_wln("for ");
		 // igk_wln(igk_getv(igk_db_ctrl_datatable_info_key($controllerOrAdpaterName, $table),"clState"));

		$tabinfo =
		// (( $v_is_c )?
		// igk_db_ctrl_datatable_info_key($controllerOrAdpaterName, $table):null) ??
		// igk_db_ref_keyinfo(igk_db_getdatatableinfokey($table, 0));

		igk_db_getdatatableinfokey($table, 0);

		//igk_db_ref_keyinfo(igk_db_getdatatableinfokey($table, 0) ));
		if ($tabinfo == null){
			if (!igk_sys_env_production()){
				igk_wln("can't get table info for ".$table);
				igk_wln("is Controller ".$v_is_c);
				igk_wln(igk_db_ref_keyinfo(igk_db_getdatatableinfokey($table,0)));
				// igk_wln("for ::::: ");
				if ($v_is_c){
					$b = igk_db_ctrl_datatable_info_key($controllerOrAdpaterName, $table);
				}
				igk_wln(igk_db_ctrl_datatable_info_key($controllerOrAdpaterName, $table));
				igk_die("/tab info is null ");
			}
			return -1; //failed to get table info
		}

		// if($table == "tbsnack_configs"){

			// igk_wln(__FUNCTION__);

				// $tabinfo = (( $v_is_c )?
		// igk_db_ctrl_datatable_info_key($controllerOrAdpaterName, $table) ?? igk_db_ref_keyinfo(igk_db_getdatatableinfokey($table, 0)): igk_db_ref_keyinfo(igk_db_getdatatableinfokey($table, 0) ));

			// igk_debug(0);
			//e_xit;
			//igk_wln(igk_db_getdatatableinfokey($table));
			// igk_wln("?".$v_is_c);
			// igk_wln("sss ");
			// igk_wln(igk_db_ctrl_datatable_info_key($controllerOrAdpaterName, $table));
			// igk_wln("klj");
			// igk_wln($tabinfo);
			// igk_wln('last ....');
			// igk_wln(igk_db_ref_keyinfo($tabinfo));
			//e_xit;
		// }
		$c = $v_is_c ? $controllerOrAdpaterName: $dbname;

		if ($adapt->connect()){ //$c);//$dbname);
		// igk_wln("connected ");
			$e = null;
			if (igk_count($tabinfo) == 0){
				igk_debug_wln(__FUNCTION__.":::table [".$table. "]");
			}
			//prefilter entries to check
			//get if present
			if ($condition==null){
				// igk_wln("condition is null");
				// igk_wln("condition is null");
				//igk_wln($entry);
				$e = igk_db_data_is_present($adapt, $table, $entry, $tabinfo);
			}
			else{
				// igk_wln("not null");
				$e = igk_db_data_is_present($adapt, $table, $condition, $tabinfo);
			}
			// igk_wln("d ".$table);
			// igk_wln($e);
			// igk_wln("info".$tabinfo);
			if (!$e){
				// igk_wln("insert ....");
				$r =  $adapt->insert($table, $entry, $tabinfo);
			}
			$adapt->close($leaveOpen);
		}
		//igk_debug_wln("request for leave open ".$leaveOpen . " : ".$adapt->OpenCount());
		return $r;
	}
	else{
		igk_wln("/!\\ Adapter is null or connected ....".$table);
	}
	return null;
}
///<summary></summary>
///<remark>if entrie is a std class the reponds will have a clid updated </remark>
function igk_db_insert($controllerOrAdpaterName, $table, $entries,  $dbname=null, $leaveOpen= false){
	$adapt = igk_get_data_adapter($controllerOrAdpaterName, false);
	if($adapt)
	{
		$adapt->connect($dbname);
		$r =  $adapt->insert($table, $entries, igk_db_getdatatableinfokey($table));
		$adapt->close($leaveOpen);
		return $r;
	}
	else{
		igk_db_error("Adapter is null");
	}
	return null;
}

///<summary>select single row</summary>
function igk_db_table_select_row($table, $id, $controllerOrAdapterName=IGK_MYSQL_DATAADAPTER, $leaveopen=false)
{
	$k = null;
	if (is_array($id)) $k = $id;
	else if (is_object($id)) $k =(array)$id;
	else
		$k = array("clId"=>$id);


	$r = igk_db_table_select_where($table,
	$k,
	$controllerOrAdapterName,
	$leaveopen);
	if ($r && ($r->RowCount == 1))
		return $r->getRowAtIndex(0);
	return null;
}

function igk_db_send_query($controllerOrAdpaterName, $query,  $dbname=null, $leaveOpen=false)
{
	$adapt = igk_get_data_adapter($controllerOrAdpaterName, false);
	if($adapt && method_exists(get_class($adapt), "sendQuery"))
	{
		$adapt->connect($dbname);
		//!!!need of a query reader
		foreach(explode(";", $query) as $k=>$v)
		{
			$v = trim($v);
			if (!empty($v))
			{
				try{
					$r =  $adapt->sendQuery($v);
				}catch(Exception $exception){
				}
			}
		}
		$adapt->close($leaveOpen);
		return $r;
	}
	return null;
}
function igk_db_reload_index($controllerOrAdapterName, $table, $dbname=null, $leaveOpen=false){//used to reload index on database
$adapt = igk_get_data_adapter($controllerOrAdapterName, false);
	if($adapt)
	{
		$adapt->connect($dbname);
		$r =  $adapt->selectAll($table);
		$adapt->ClearTable($table);
		$i=1;
		foreach($r->Rows as $k=>$v){
			$v->clId = $i;
			$adapt->insert($table, $v);
			$i++;
		}
		$adapt->close($leaveOpen);
		return $r;
	}
	return null;
}
function igk_db_error($message){
	igk_app()->Session->setParam("db_error_msg", $message);
}
function igk_db_get_error(){
	return igk_app()->Session->getParam("db_error_msg");
}

///<summary>used to prefilter unique element entry for selection</summary>
///<note>auto increment is ignored for that reason.</note>
function igk_db_prefilter_for_select($entry, $tabinfo)
{
	if ($entry==null)
		return null;
	if ($tabinfo == null){
		//igk_html_wln_log("tabinfo", "tab info is null");
		return null;
	}

	$t = array();
	$uniquecolumn = array();
	foreach($entry as $k=>$v){
		if (!isset($tabinfo[$k])){
			igk_wln("Column [$k] not found in table definition ".__FUNCTION__);
			igk_html_wln_log("TabInfo", $tabinfo);
			igk_html_wln_log("Entry", $entry);
			//igk_wln($entry);
			igk_wln(igk_show_trace());
			igk_exit();
		}
		$s = $tabinfo[$k];
		if ($s->clAutoIncrement)
			continue;
		if ($s->clIsUnique){
			$t[$k]=$v;
		}
		if ($s->clIsUniqueColumnMember){
			$uniquecolumn[$k] = $v;
		}
	}
	// igk_wln($t);
	// igk_wln($uniquecolumn);
	if (igk_count($t)>0)
		return $t;
	return null;
}

function igk_db_data_is_present($adapter, $table, $entry, $tabinfo=null, & $present =null, & $ptype=null){
	if ($tabinfo==null){
		// igk_wln("get table info for ".$table);
		$tabinfo= igk_db_getdatatableinfokey($table);
	}
	if (($entry==null) ||($tabinfo == null))
		return false;
		$t = array();
	$uniquecolumn = array();
	foreach($entry as $k=>$v){
		if (!isset($tabinfo[$k])){
			// igk_wln("[".__FUNCTION__."] - Column [$k] not found in table `{$table}` definition. maybe you must reset  datatable cache");
			// igk_wln($tabinfo);
			// igk_wln(igk_show_trace());
			//e_xit;
			// igk_html_wln_log("TabInfo", $tabinfo);
			// igk_html_wln_log("Entry", $entry);
			//igk_wln($entry);
			igk_die("[".__FUNCTION__."] - Column [$k] not found in table `{$table}` definition. maybe you must reset  datatable cache");
			igk_exit();
		}
		$s = $tabinfo[$k];
		if ($s->clAutoIncrement)
			continue;
		if ($s->clIsUnique){
			$t[$k]=$v;
		}
		if ($s->clIsUniqueColumnMember){
			$rtab = null;
			if (!empty($s->clColumnMemberIndex)){
				$rindexes = explode("-", $s->clColumnMemberIndex);
				foreach($rindexes as $gk){
					if (!is_numeric($gk))
						continue;
					if (isset($uniquecolumn[$gk]))
						$rtab = $uniquecolumn[$gk];
					else
						$rtab = array();

					$rtab[$k] = $v;
					$uniquecolumn[$gk] = $rtab;
				}

			}else{
				// igk_debug_wln("define $k");
				if (isset($uniquecolumn[0]))
					$rtab = $uniquecolumn[0];
				else
					$rtab = array();

				$rtab[$k] = $v;
				$uniquecolumn[0] = $rtab;
			}
		}
	}

	// igk_wln($t);
	 // igk_debug_wln($uniquecolumn);

	if (igk_count($t)>0){
		foreach($t as $k=>$v){
			// igk_wln("check ...");
			// igk_wln($v);
			if ( ($g = igk_db_table_select_where($table, array($k=>$v), $adapter)) && $g->RowCount>0){
			// igk_wln("unique ".$k);
			// igk_wln("unique ".$v);
			// igk_exit();
				$present = $g;
				$ptype = 1;//unique;
				return true;
			}
		}
	}

	if (igk_count($uniquecolumn)>0){
		foreach($uniquecolumn as $k=>$v){
			// igk_wln($v);
			if (($g = igk_db_table_select_where($table, $v, $adapter)) && ($g->RowCount>0)){
				// igk_debug_wln("data present :  ".$g->RowCount);
				// igk_wln($v);
				// igk_exit();
				$present = $g;
				$ptype = 2;
				return true;
			}
		}
	}
	return false;
}

///<summary>filter object to fit table definition data</summary>
function igk_db_table_filter_data($table, $obj){
	$tobj = igk_db_create_row($table);
	if ($tobj){
		if ($obj && (is_object($obj) || is_array($obj))){

			foreach($tobj as $k=>$v){
				$tobj->$k = igk_getv($obj, $k);
			}
		}
	}
	return $tobj;
}


function igk_db_get_sync_row_data($ad, $table, $tabinfo, $row,& $syncRefTable){
	$obj = igk_db_create_row($table);
	if ($row){
		foreach($row as $k=>$v){

			$clinfo = igk_getv($tabinfo, $k);
			if (!$clinfo)continue;

			// if (preg_match('/_Id$/i', $k)){

			// }
			if (isset($clinfo->clLinkType) && isset($row->$k)){
				if (!isset($syncRefTable[$clinfo->clLinkType]))
				{
					$syncRefTable[$clinfo->clLinkType] = array();
				}
				$ii = $syncRefTable[$clinfo->clLinkType];
				$g = null;
				if (!isset($ii[$row->$k]))
				{
					$g = $ad->select($clinfo->clLinkType,array(IGK_FD_ID=>$row->$k))->getRowAtIndex(0);
					unset($g->clId);
					$ii[$row->$k] = $g;
					//update
					$syncRefTable[$clinfo->clLinkType] = $ii;
				}
				//$g = array("t"=>$clinfo->clLinkType, "Id"=>$row->$k);
				$obj->$k = "{\"t\":\"{$clinfo->clLinkType}\",\"id\":\"{$row->$k}\"}";//json_encode($g);
				continue;
			}
			$obj->$k = $row->$k;
		}
	}

	// igk_wln($tabinfo);
	// igk_wln($row);
	// igk_wln($obj);

	return $obj;
}

function igk_db_update($controllerOrAdpaterName, $table,$entry, $where=null,  $dbname=null, $leaveOpen=false){//update entries
	$adapt = igk_get_data_adapter($controllerOrAdpaterName, false, $leaveOpen);
	if($adapt)
	{
		$adapt->connect($dbname);
		$r =  $adapt->update($table, $entry, $where==null? array("clId"=>$entry->clId) : $where );
		if (!$r && IGKApp::$DEBUG){
			igk_log_write_i("udpate error", igk_debuggerview()->getMessage());
		}
		$adapt->close($leaveOpen);
		return $r;
	}

	return null;
}
function igk_db_deletec($ctrl, $where){
	return igk_db_delete($ctrl, $ctrl->getDataTableName(), $where, null);
}
function igk_db_delete($controllerOrAdpaterName, $table, $where=null,  $dbname=null, $leaveOpen=false)
{
	$adapt = igk_get_data_adapter($controllerOrAdpaterName, false);
	if($adapt)
	{
		$adapt->connect($dbname);
		$r =  $adapt->delete($table, $where );
		$adapt->close($leaveOpen);
		return $r;
	}
	else{
		igk_wln("adapt is null");
	}
	return null;
}
///<summary>compare time</summary>
function igk_db_cmp_time($type, $format, $oldd, $newd){
	$o = igk_time_span($format, $oldd);
	$n = igk_time_span($format, $newd);
	if ($o!==$n){
		return $n>$o?1:-1;
	}
	return 0;
}
///<summary> used to dump query result</summary>
function igk_db_dump_result($result){

	$r = igk_createNode();
	if ($result === null){
		$r->Content = "No result";
	}else{

	$r->addDiv()->Content = "Count : ".$result->RowCount;
	$tb = $r->addTable();
	$tr = $tb->addTr();
	foreach($result->Columns as $k=>$v){
		$tr = $tr->add("th");
		$tr->Content = $v->name;
	}
	$cl = $result->Columns;
	foreach($result->Rows as $k=>$v){
		$tr = $tb->addTr();
		foreach($v as $s=>$t){
			$tr->addTd()->Content = $t;
		}
	}
	}
	$r->RenderAJX();
}

///<summary>synchronise data of this controller to dataadapter</summary>
///adapter can't be an open adapter reference
///<remark>function init with required links</remarks>
function igk_db_sync_todb($ctrl, $adapter=null, $callinit=null){
	$ad = $adapter!=null ? igk_get_data_adapter($adapter) :
	igk_get_data_adapter($ctrl);
	if(!$ad || !$ad->connect() || !igk_is_conf_connected())
		return false;

	//dump_result($ad->sendQuery('SELECT DATABASE()'));
	$dbctrl = igk_getctrl(IGK_MYSQL_DB_CTRL);
	$tables = $dbctrl->getTablesFor($ctrl, true);
	$ad->initForInitDb();
	$tc  = $tables;
	foreach($tc as $k=>$v){
			$c = $dbctrl->getDataTableCtrl($v);
			if ($c===$ctrl)continue;
			if ($c && !isset($init[$c->Name])){
				// igk_debug_wln("init ".$c->Name);
				// igk_debug_flush_data();
				$c->initDb();
				$init[$c->Name] = 1;
				unset($tables[$c->Name]);
		}
	}
	$ctrl->initDb();
	$ad->flushForInitDb();
	$ad->close();
	return true;
}
///<summary>evaluate expression according to row</summary>
function igk_db_sync_key_eval($row, $expression){
	return eval("return \"{$expression}\";");
}

///<summary>get notification controller</summary>
function igk_notifyctrl($name =null){
	$ctrl = igk_getctrl(IGK_NOTIFICATION_CTRL,true);
	if ($name == null)
		return $ctrl;
	$c =  $ctrl->getNotification($name, true);
	return $c;
}
function igk_notify_assert($cond, $name=null, $goodmsg=null,$failemsg=null){
	$c = igk_notifyctrl($name);
	if ($cond){
		$c->addSuccess($goodmsg??"success");
	}else{
		$c->addError($failemsg??"failed");
	}
}
///<summary>shortcut to set notify host</summary>
function igk_notify_sethost($node, $notificationName=null){
	igk_notifyctrl()->setNotifyHost($node,$notificationName );
}

///<summary> return a notification id for a controller</summary>
function igk_notification_id($ctrl, $n){
	return "sys://ctrl/".strtolower($ctrl->Name)."/{$n}";
}
function igk_notification_response($name){
	$v_notification = igk_notifyctrl()->getNotification($name, false);
	if ($v_notification){
		$tb = array();//null;
		$p = null;
		$s = igk_html_render_node($v_notification, $p, $tb);//->Render();
		return $s;
	}
	return null;
}
///<summary>get notification event</summary>
function igk_notification_event($name){
	$ctrl = igk_getctrl(IGK_NOTIFICATION_CTRL,false) ?? igk_die("no notification ctrl registrated");
	return $ctrl->getNotificationEvent($name);
}

function igk_raise_globalcallback($obj, $n, $args){
	return $obj->onInvoke($n, igk_getv($args, 0), array_slice($args, 1));
}

//------------------------------------------------------------------
//notification utility
//------------------------------------------------------------------
///<summary>registrate a notification event</summary>
function igk_notification_reg_event($name, $callable){
	// igk_debug(true);
	$name  = $name ?? IGK_GLOBAL_EVENT;


	$ctrl = igk_getctrl(IGK_NOTIFICATION_CTRL,false);

	// igk_wln(igk_get_env("sys://app/controllers"));
	// igk_wln($ctrl);
	//e_xit;

	if (igk_is_callable($callable)){
		$h =  $ctrl->registerNotification($name, $callable);
		return ($h!=null);
	}
	if (is_object($callable) && method_exists($callable, "oninvoke")){

		$fc = igk_create_func_callback("igk_raise_globalcallback", array(IGK_FUNC_KEY=>$callable));
		$h =  $ctrl->registerNotification($name, $fc);
		return ($h!=null);
	}
	igk_debug_wln("/!\\ not register : ".$name);
	return false;
}
///<summary>unregister notification event</summary>
function igk_notification_unreg_event($name, $callable){
//	$obj,$func){
	$name  = $name ?? IGK_GLOBAL_EVENT;
	$ctrl = igk_getctrl(IGK_NOTIFICATION_CTRL,true);
	return $ctrl->unregisterNotification($name, $callable);// $obj,$func);
}
///<summary>free all callable from notification event</summary>
function igk_notification_reset($name){
	$ctrl = igk_getctrl(IGK_NOTIFICATION_CTRL,true);
	$ctrl->resetNotification($name);
}
///<summary>raise a notification event</summary>
function igk_notification_push_event($name, $o, $param=null){

	if (IGK_GLOBAL_EVENT!=$name){
		$e = igk_notification_event(IGK_GLOBAL_EVENT);
		if ($e)	{
			$e->Call($name, array($o, $param));
		}
	}
	$e = igk_notification_event($name);
	if ($e!=null){
		if ($param){
			$e->Call($o, $param);
		}
		else{
			$e->Call($o, array($name));
		}
	}
}




///<summary>get default web page controller.</summary>
function igk_get_defaultwebpagectrl(){
	$igk = igk_app();
	$n = $igk->Configs->web_pagectrl;
	return igk_getctrl($n) ?? ((function_exists('igk_template_create_ctrl') ) ?  igk_template_create_ctrl($n) : null);//add template to definition controller
}
///<summary>get default view content</summary>
function igk_get_default_view_content($ctrl){
	return "<?php ?>";
}

function igk_is_defaultwebpagectrl($ctrl){
	return igk_get_defaultwebpagectrl()===$ctrl;
}
///<summary>get the current page controller.</summary>
function igk_get_currentpagectrl(){
	$igk = igk_app();
	$tab = igk_get_all_uri_page_ctrl();
	$page = $igk->getCurrentPage();
	if ($tab && (count($tab)>0))
		{
			foreach($tab as $k=>$v)
			{
				if (igk_getv($v->Configs,"clDefaultPage") == $page)
				{
					return $v;
				}
			}
		}
	return null;
}
///<summary>get web page content utility</summary>
function igk_get_webpagecontent(){
	if (igk_app()->CurrentPageFolder == IGK_CONFIG_PAGEFOLDER)
	{
		return igk_getconfigwebpagectrl()->ConfigNode;
	}
	else{
	 $c = igk_get_defaultwebpagectrl();
		 if ($c)
			return $c->page_content;
		else{
			$igk = igk_app();
			return $igk->Doc->bodycontent;
	}
	}
	return null;
}
///<summary>return t he default config page ctrl<+summary>
function igk_getconfigwebpagectrl(){
	$igk = igk_app();
	return igk_getctrl(IGK_CONF_CTRL);
}
//sort functions
function igk_key_sort($k, $v)
{
	return strcmp($k,$v);
}
function igk_array_sortbykey(&$tab ){
$k = array_keys($tab);
$o = array();
sort($k);
foreach($k as $s=>$t){
	$o[$t] = $tab[$t];
}
$tab = $o;
return $tab;

}
///<summary> create a key array for value</summary>
function igk_array_createkeyarray($tab, $default=1){
	$tab1 = array();
	foreach($tab as $k=>$v){
		$tab1[$v] = $default;
	}
	return $tab1;

}

///<summary>add value to array. if key is present make an array</summary>
function igk_array_push_keyvalue(&$tab, $k, $v, $replace=true){
	if (!isset($tab[$k]) || $replace) {
		$tab[$k] = $v;
	}
	else {
		if (is_array($tab[$k]))
		{
			$tab[$k][] = $v;
		}
		else {
			$t = array($tab[$k]);
			$t[] = $v;
			$tab[$k] = $t;
		}
	}
}
function igk_array_value_exist($tab , $obj)
{
	foreach($tab as $k=>$v){
		if ($v === $obj)
			return true;
	}
	return false;
}
function igk_array_sortkey(& $tab)
{
	if (!is_array($tab))
		return false;
	$ckey = array_keys($tab);
	igk_usort($ckey, "igk_key_sort");
	$t = array();
	foreach($ckey as $k)
	{
		$t[$k] = $tab[$k];
	}
	$tab = $t;
	return true;
}
function igk_array_first($c)
{
	if (is_array($c) && (igk_count($c)>0))
	{
		return $c[0];
	}
	return null;
}
function igk_array_last($c)
{
	if (is_array($c) && (igk_count($c)>0))
	{
		return $c[igk_count($c)-1];
	}
	return null;
}
function igk_array_copy($c, $from = 0, $to = -1)
{
	$tab = array();
	$t = ($to==-1)?count(c):$to;
	if ($t<= igk_count($c))
	{
		foreach($c as $k=>$v)
		{
			$tab[$k] = $v;
			$t--;
			if ($t<=0)
				break;
		}
	}
	return $tab;

}

function igk_array_sort_bykey(& $tab, $key){
	$sorter = new IGKSorter();
	$sorter->key = $key;
	usort($tab, array($sorter, "SortValue"));
}

///<summary>remove empty entries from the table</summary>
function igk_array_remove_empty(& $tab){
	$ot = array();
	foreach($tab as $k=>$v){
		if (empty($v))
			continue;
		$ot[] = $v;
	}
	$tab = $ot;
	return $ot;
}
///<summary>Used to convert array to values to assoc table of (value => value)</summary>
function igk_array_tokeys($d, $value=true)
{
	$b = array();
	foreach($d as $k=>$v)
	{
		$b[$v] = $value?$v:null;
	}
	return $b;
}
function igk_array_object_refkey($d, $key)
{///used in getDataTableInfo () conversion. dont used it
	$b = array();
	if ($d){
		foreach($d as $k=>$v)
		{
			if (is_object($v))
				$b[$v->$key] = $v;
		}
	}
	return $b;
}
///<summary>used to get array of toggled value . keys=>keys </summary>
function igk_array_key_value_toggle($d){

	$b = array();
	foreach($d as $k=>$v)
		{	if (isset($b[$v]))continue;
			$b[$v] = $k;
		}
	return $b;
}
function igk_array_fill($tab, $size=0, $default=0){
	if ( ($s = igk_count($tab))<$size){
		while($s>0){
			$tab[]=$default;
			$s--;
		}
	}
	return $tab;
}

///<summary>convert assoc-array to object presentation</summary>
function igk_array_to_obj($c, $ns){
	if (($c==null) || !is_array($c)){
		igk_assert_die(!igk_sys_env_production(), __FUNCTION__." Invalid argument");
		return null;
	}
	$t = array();
	$ln = strlen($ns)+1;
	$ln -= $ns[$ln-2] == '/'? 1:0;
	// igk_wln($c);
	// igk_wln($this->m_params);
	// igk_wln($this->getParamKeys());
	//e_xit;
	foreach($c as $k=>$v){
		if (!strstr($k, $ns))
			continue;
		$n = substr($k, $ln);
		$tt  = explode("/",$n);
		if (igk_count($tt)==1){
			$t[$n] = $v;
		}else{
			$g = null;
			$nn = array_pop($tt);
			// igk_wln($tt);
			//e_xit;
			foreach($tt as $m){
				if (($g==null)){
					//firt line
					 if (isset($t[$m])){
						$g = $t[$m];
					 }
					 else {
						 $g = igk_createObj();
						 $t[$m] = $g;
					 }

				}else{
					if (!isset($g->$m)){
						$g->$m = igk_createObj();
						$g = $g->$m;
					}
				}
			}
			$g->$nn = $v;
		}

	}
	return (object)$t;
}

function igk_is_array_key_present($o, $k){
	$t = is_object($o)? (array)$o: (is_array($o)?$o:null);
	if ($t==null)
		return false;
	if (!is_array($k))
		return false;
	foreach($k as $s){
		if (!isset($t[$s]))
			return false;
	}
	return true;

}


function igk_save_config()
{
	IGKAppConfig::getInstance()->saveConfig();
}

///<summary>check if a file is included</summary>
function igk_file_IsNotIncluded($file)
{
	$tab = get_included_files();
	return $tab[0] == $file;
}

function igk_file_IsDirectChildOf($file, $parentFile)
{
	$tab = get_included_files();
	$c = igk_count($tab)-1;
	$r = 0;
	while($c>0){
		if (!$r){
			$r = ($tab[$c] == $file);
		}
		else{
			$tab[$c] == $parentFile;
			return 1;
		}
		$c--;
	}
	return 0;

	// if ($c>1){
		// return ($tab[$c-1] == $file) && $tab[$c-2] == $parentFile;
	// }
	// return 0;
}


function igk_font_get_code($name){
	$p = igk_app()->Doc->Theme->FontCode;
	return igk_getv($p,$name, $name);

}
///<summary>navigate to session redirection parameter</summary>
function igk_nav_session(){
	$s = igk_get_session(IGKSession::IGK_REDIRECTION_SESS_PARAM);
	if ($s){
		igk_navto($s);
	}
	igk_navtocurrent();
}

function igk_navtobase($path=null)
{
	if (defined('IGK_NO_WEB_REDIRECT'))
		return;
	$s = null;
	if ($path==null)
	{
		$s = igk_io_currentRelativePath(IGK_STR_EMPTY,"/");
	}
	else {
		$s = igk_io_currentRelativePath($path,"/");
	}
	if (empty($s))
	{
		if (igk_server_is_redirecting())
		{
			if (function_exists("igk_get_app_ctrl"))
			{

				$ctrl = igk_get_app_ctrl();
				if ($ctrl)
				{
					igk_navto($ctrl->getAppUri());
				}
			}
			igk_navto(igk_io_baseUri());
		}
		else{
			if (!empty($path) && strpos($path, "#")!==false){
				igk_navto("./#".igk_getv(explode("#", $path), 1));
			}
			else{
				igk_navto("./");
			}
		}
	}
	else{
		igk_navto(igk_html_uri($s));
	}
	igk_exit();
}
function igk_navto($uri){
	// define('IGK_TRACE',1);
	// igk_trace_function(2);
	// igk_wln("navto ::" . $uri);
	// igk_wln(igk_show_trace());
	// igk_exit();
	header("Location: ".$uri);
	igk_exit();
}
function igk_navto_referer($failuri=null){
	//get referrerer
	$u = igk_getv(explode("?", igk_getv($_SERVER, "HTTP_REFERER")), 0);
	if (empty($u))
	{
		if ($failuri){
			igk_navto($failuri);
		}
		igk_die("no referer");
	}
	igk_navto($u);
}
///<sumamry>navigate to current uri</summary>
function igk_navtocurrent($uri=null){
	$u = igk_io_get_relative_currenturi($uri);
	igk_navtobase($u);
}
///<summary>navigate to basic request uri</summari>
function igk_navtobaseuri(){
	$uri = igk_io_rootRequestUri();
	$uri = igk_getv (explode("?", $uri), 0);
	// igk_ilog("request ".$uri);
	igk_navto($uri);
}
function igk_navto_home($ctrl=null){
	if ($ctrl){
	$u = $ctrl->MainView == IGK_DEFAULT_VIEW ? null : $ctrl->MainView;
	igk_navto($ctrl->getAppUri($u));
	}
	else{
		igk_navto(igk_io_baseUri());
	}
}

function igk_get_local_file($fi, $ctrl=null){
	$s = igk_io_dir($fi);
	$s = igk_html_resolv_img_uri($s);
	return $s;
}

function igk_io_get_relative_currenturi($uri=null){

	if (IGKString::StartWith($uri,'#'))
		$uri = "./".$uri;

	$page = igk_app()->CurrentPageFolder;
	$t = IGK_STR_EMPTY;
	if (strtolower($page)!=IGK_HOME_PAGEFOLDER)
	{
		$t = ($uri)? IGK_STR_EMPTY.($page)."/".$uri : $page;
	}
	else{
		if ($uri !== null)
			$t = $uri;
	}
	return $t;
}

function igk_die_format($msg){
	return "<div>message : <i>".$msg."</i></div>";
}
///<summary>die by setting code values</summary>
function igk_die_e($c){
	$e = igk_getv(igk_get_env("sys://errors"),$c,$c);
	igk_die($e);
}

///<summary>die with message</summary>
///<param name="msg">mixed value. error_array|string </summary>
function igk_die($msg=IGK_DIE_DEFAULT_MSG, $throwex=1){
	if ($throwex){
		if (is_array($msg)){
			$t = $msg;
			$msg ="";
			if (isset($t["code"]))
			$msg .= "<div>code:{$t['code']}</div>";
			if (isset($t["message"]))
			$msg .= "<div>Message:{$t['message']}</div>";
		}
		// igk_wln(igk_show_trace());
		
		throw new Exception(igk_die_format($msg));
	}
	else{
		ob_clean();
		igk_wl(igk_die_format($msg));
		exit();
	}
}
function igk_debug_die($msg){
	if (igk_is_debug()){
		igk_die($msg);
	}
}
function igk_assert_die($cond, $msg){
	if ($cond)
		igk_die($msg);
}
function igk_debug_or_local_die($msg){
	if (igk_is_debug()|| igk_server_is_local()){
		igk_die($msg);
	}

}
function igk_io_ctrl_db_dir($ctrl){
	$dir = $ctrl->getDataDir()."/DataBase";
	if (!is_dir($dir) && (igk_io_createdir($dir) || igk_die("cant create directory"))){
		//try to create a dir
		igk_io_save_file_as_utf8_wbom($dir."/.htaccess", "deny from all");
	}
	return $dir;
}

///<summary>utility to handle controller app uri</summary>
///<param name="ctrl">the controller</param>
///<param name="u">mixed . uri:string or SysParamInfo </param>
///<param name="fc">callback to call with request of func and parameters</param>
function igk_io_ctrl_handle_uri($ctrl, $u, $fc){	
		if (igk_app()->getControllerManager()->InvokeUri()){
			igk_exit();
		}				
		$p = "";
		$params = null;
		if (is_string($u)){
			$p = igk_str_array_rm_empty(explode("/", explode("?",$u)[0]));		
		}else{
				$params = $u->getParams();
				return $fc(	
					$params["function"], 
					$params["params"]
					);
				
				// return $ctrl->_handle_uri_param(
					// $params["function"], 
					// $params["params"]);
				
				// return true;
		}		
		return $fc(igk_getv($p,0), array_slice($p,1));
}


function igk_js_load_found_script($doc, $dirname)
{
	$dirname = igk_io_dir($dirname);
	if (($doc == null) || !is_dir($dirname) || isset(IGKApp::$ScriptFolders[$dirname]) )
	{
		return;
	}
	$hdir = @opendir($dirname);
	if (!$hdir)
	{
		igk_debug_wln("scripts dirname can not be opened [".$dirname."]");
		return false;
	}
	while($fd = readdir($hdir))
	{

		if (($fd==".") || ($fd==".."))
			continue;
			$f = $dirname."/".$fd;
		if (is_dir($f))
		{
			if (($fd == IGK_SCRIPT_FOLDER))
			{
				igk_js_load_script($doc, $f);
			}
			else{
				igk_js_load_found_script($doc, $f);
			}
		}
	}
	closedir($hdir);
	return true;
}
//load javascript documenet from directory
function igk_js_load_script($doc, $dirname, $tag='priv', $regtype=0)
{
	$reg ="";
	switch($regtype){
		case 0:
		default:
			$reg = "/^[^\.](.)*\.js$/i";
			break;
		case 1:
			$reg = "/\.js$/i";
			break;
	}
	$dirname = igk_io_dir($dirname);
	if (($doc == null) || !is_dir($dirname) || isset(IGKApp::$ScriptFolders[$dirname]) )
	{
		return;
	}
	if (IGKApp::$ScriptFolders==null)
		IGKApp::$ScriptFolders = array($dirname=>$dirname);
	else
		IGKApp::$ScriptFolders[$dirname] = $dirname;


	$scriptFolder = array($dirname);
	while( $dirname=array_pop($scriptFolder)){

	$hdir = @opendir($dirname);
	if (!$hdir)
	{
		igk_debug_wln("scripts dirname can not be opened [".$dirname."]");
		return false;
	}

	$f = null;
	$fd = null;
	while($fd = readdir($hdir))
	{

		if (($fd==".") || ($fd==".."))
			continue;

		$f = $dirname."/".$fd;
		if (is_dir($f)){
			$scriptFolder[] = $f;

		}
		else {
			if (preg_match($reg, basename($f))) //IGKString::EndWith($f,".js"))
			{
				//igk_ilog($f);
				//add script with full path
				$doc->addScript(realpath($f),$tag);
			}
		}
	}
	// foreach($scriptFolder as $f)
	// {
		// igk_js_load_script($doc, $f);
	// }
	closedir($hdir);
	}
	return true;
}

function igk_js_bind_script_folder($folder)
{
	$folder = igk_io_dir($folder);
	if (!is_dir($folder))
		return;
	$tab = IGKApp::$ScriptFolders;
	if ($tab == null)
		$tab = array();
	if (!isset($tab[$folder]))
		$tab[$folder] =$folder;
	IGKApp::$ScriptFolders = $tab;
}
///<summary>render history</summary>
function igk_js_push_history_ajx($uri, $data=null){
	$n = igk_createNode("script");
	$n->Content = "igk.winui.history.push('{$uri}',{uri:'{$data}','src':'balafonjs'}, null);";
	$n->RenderAJX();
}
///<summary>init history</summary>
function igk_js_winui_init_history($t, $cn,$page=IGK_HOME, $src=IGK_BALAFON_JS){
	 $id = igk_get_component_id($cn);
	 if ($id){
	 $t->addScript()->Content = "igk.winui.history.push(null,{id:'{$id}', src:'{$src}', page:'{$page}'});";
	 }
}
function igk_ajx_replace_uri($uri){
	$n = igk_createNode('balafonJS');
	$n->Content = "ns_igk.winui.history.replace('{$uri}', null);";
	$n->RenderAJX();
	return $n;
}

///<summary>used to bind script for wui component</summary>
function igk_js_bind_wuiscript($document, $ctrl, $file, $node=null){
	$f = realpath($ctrl->getScriptDir()."/".$file);
	$document = $document ?? igk_get_last_rendered_document();
	$node = $node ?? igk_get_rendering_node();
	if (empty($f) || ($document == null) || $document->ScriptManager->isLoaded($f)){
		return;
	}
	$src = igk_createNode("script")->setAttribute("type", "text/javascript");
	$src->setContent(igk_io_read_allfile($f));
	if (igk_is_ajx_demand()){
		$src->RenderAJX();

	}else{
		if ($node){
			$node->add(new IGKHtmlSingleNodeViewer($src));
		}
	}
	$document->addScript($f,'temp');
}

function igk_get_adapter_name($ad){
	if (!is_object($ad))
		return;
	$c = get_class($ad);

	if (preg_match_all("/IGK(?P<name>(.)+)DataAdapter/i", $c, $tab)){

		return igk_getv($tab["name"],0);
	}
	return null;
}
///<summary>get the current base controller</summary>
function igk_get_current_base_ctrl(){
	$a = igk_app();
	$g  = $a->getSubDomainCtrl() ?? $a->getBaseCurrentCtrl() ?? igk_get_defaultwebpagectrl();
	if ($g!==null){
		return $g;
	}
	return null;
}
function igk_getctrls(){
	return igk_app()->getControllerManager()->getControllers();
}

function igk_init_ctrl($ctrlname){
	$n = igk_sys_get_controller($ctrlname);
	if (!empty($n) && class_exists($n)){

		$o = new $n();
		$man = igk_app()->getControllermanager();
		if ($man)
			$man->Register($n, $o);
		return $o;
	}
	return null;
}
///<summary>controller entry function </summary>
function igk_getctrl($ctrlname, $throwex = false){
	if (!IGKApp::IsInit())
	{
		if ($throwex)
		{
			igk_die("/!\\ Application not initialized. can't get controller ".$ctrlname);
		}
		return igk_init_ctrl($ctrlname);
	}
	$app = igk_app();
	if (is_string($ctrlname))
	{
		$ctrlname = trim($ctrlname);
		$cc = $app->getControllerManager();
		if ($cc===null){
			if ($throwex){
				igk_die("igk_app() ControllerManager is null. Session probably destroyed.".
				IGKApp::IsInit()
				);
			}
			igk_wln("controller manager is null");
			return null;
		}
		$v = $cc->$ctrlname ;
		if ($v==null){
			$v = igk_init_ctrl($ctrlname);
		}
		if ($throwex && ($v==null))
		 {
			igk_die("controller [".$ctrlname."] not found");
		 }
		return $v;
	}
	else{
		if (is_object($ctrlname) && igk_is_ctrl($ctrlname))
		{
			return $ctrlname;
		}
	}
	return null;
}
///<summary>return a controller by clRegisterName</summary>
function igk_getctrl_byid($id){
	if (!IGKApp::IsInit())
	{
		igk_die("application not initialized. can't get controller ".$id);
	}
	$app = igk_app();
	if (is_string($id))
	{
		$id = trim($id);
		$cc = $app->getControllerManager();
		$v = $cc->getRegisters()->$id;
		return $v;
	}
	return null;
}


function igk_getctrl_from_className($className){
	if (!IGKApp::IsInit())
	{
		return null;
	}
	if (class_exists($className)){

		return igk_app()->getControllerManager()->getControllerFromClass($className);
	}
	return null;
}

///<summary>register global system controller</summary>
function igk_get_regctrl($name){
	if (!IGKApp::IsInit())
	{
		return null;
	}
	return igk_app()->getControllerManager()->getRegCtrl($name);
}
///<summary>shortcut to register global system controller</summary>
function igk_reg_ctrl($name, $ctrl){
	if (IGKApp::IsInit() && $name && $ctrl){
		igk_app()->getControllerManager()->register($name, $ctrl);
		return 1;
	}
	return 0;
}
///<summary>used to reset parameters</summary>
///<param name="rg" >regular expression to match pattern</param>
function igk_ctrl_reset_params($ctrl, $rg="/(.)+/i"){
	$keys = $ctrl->getParamKeys();
	foreach($keys as $k=>$v){
		if (preg_match($rg, $v)){
			$ctrl->unsetParam($v);
		}
	}
}
///<summary> get if this controller name is active</summary>
///<note>Data/.non-active.csv will have the diseable controller</summary>
///
function igk_ctrl_isactive($ctrlname){//get non active controller from "Data/igk_nonactive.csv";
	return true;
}

///<summary>call View function of this controller. if this controller is not a child or call the parent view</summary>
function igk_ctrl_viewparent($ctrl)
{
	// if ($ctrl==null)
		// return;
	if ($ctrl->Configs->clParentCtrl && ($p = igk_getctrl($ctrl->Configs->clParentCtrl ))){
		if ($p!=null)
			igk_ctrl_viewparent($p);
	}
	else{
		if ($ctrl->IsVisible)
			$ctrl->View();
	}
}
///<summary>view the current controllerr and render it to cibling targetnode</summary>
///<remark>viewmode might be one in other to check if this view is visible or not
function igk_ctrl_view($ctrl, $targetnode, $requestedview=IGK_DEFAULT_VIEW, $params=null, $viewmode=1){
	if ($ctrl==null)return;

	$bck = $ctrl->getCurrentView();
	$tn = $ctrl->TargetNode;
	//$newnode =  igk_createNode("div");
	$ctrl->TargetNode = $targetnode;

	if ($viewmode==1){
		$ctrl->setCurrentView($requestedview, true, null, $params);
	}else{
		$f = $ctrl->getViewfile($requestedview);
		if (file_exists($f)){
			igk_set_env(IGK_ENV_CTRL_VIEW, $viewmode);
			$ctrl->getView($requestedview, false, $params);
		}
	}
	$ctrl->TargetNode = $tn;//targetnode;
	//$targetnode->Load($ctrl->TargetNode->Render());
	$ctrl->setCurrentView($bck, false);
}


///<summary>render controller document</summary>
///<param name="ctrl">the controller</summary>
///<param name="view">the requested view file</summary>
///<param name="ctrl">param to pass</summary>
///<param name="ctrl">the controller</summary>
function igk_ctrl_render_doc($ctrl, $view, $param=null, $exit=1){
	$f = $ctrl->getViewfile($view);
	if (file_exists($f)){
		$ctrl->getView($view, false, $param);
		//if view not called exit function then render the view to current document
		igk_render_node($ctrl->TargetNode, igk_get_document($ctrl, true));
		if ($exit)
			igk_exit();
	}

}
function igk_ctrl_auth_key($ctrl, $k=null){
	$s =  "sys://auth/".$ctrl->AppName;
	if ($k)
		$s.="/".$k;
	return strtolower($s);
}
function igk_ctrl_notify_key($ctrl){
	return "sys://notify/".$ctrl->Name;
}

///<summary>used to load view automacally view for controller according to pattern</summary>
///<param name="ctrl">controller</param>
///<param name="t">target node</param>
///<param name="pattern">partern nametarget node</param>
function igk_ctrl_view_load_pattern($ctrl, $t, $pattern="main_"){

//include pattern files
$tab = igk_io_getfiles($ctrl->getViewDir(), function($s) use($pattern){
	return preg_match("/^".$pattern."_(.)+\\.phtml$/", basename($s));
}, false);
sort($tab);


	foreach($tab as $k=>$v){
		$g = $t->addCtrlView($v, $ctrl);

	}

}

///<summary> check if an object is a controller</summary>
function igk_is_ctrl($ctrl)
{
	if ( is_object($ctrl) && igk_reflection_class_extends(get_class($ctrl), IGK_CTRLBASECLASS))
	{
		return true;
	}
	return false;
}

///<summary>include file</summary>
function igk_include_file($file, $args=null){
	if (!file_exists($file))
		return;
	if ($args){
		//extract($args);
		foreach($args as $k=>$v){
			$$k = & $args[$k];//get reference to variable key
		}
	}
	include($file);	
}

function igk_include_set_view($f){
	$t = igk_get_env("sys://included_view");
	if ($t==null){
		$t = array();
	}
	$t[igk_io_dir($f)]=1;
	igk_set_env("sys://included_view", $t);
}
function igk_include_unset_view($f){
	$t = igk_get_env("sys://included_view");
	unset($t[$f]);
	igk_set_env("sys://included_view", $t);
}
///<summary>
///<param name="args">array data to pass to view file </param>
function igk_include_view($ctrl, $target, $file, $create=false, $args=null){

	$f = file_exists($file)? $file : $ctrl->getViewFile($file);
	igk_include_set_view($f);
	$ctrl->getViewContent($file ,$target, $create, $args);
	igk_include_unset_view($f);

}

function igk_is_included_view($file){
	$g = igk_get_env("sys://included_view");
	return isset($g[$file]);
}

//return the current uri access
function igk_io_access(){
	return igk_get_env("igk://sys/currenturiaccess", igk_io_baseUri());
}

///<summary>include controller view</summary>
function igk_ctrl_include_view_file($ctrl, $source, $t,  $file, $args=null, $fname=null){
	$fc = function($ctrl, $source, $t,  $file, $params=null, $fname=null){
		$dir = dirname(realpath($file));
		$fname = $fname ?? igk_io_basenamewithoutext($file);
		$__local_uri__= $ctrl->getAppUri(($source ? $source."/": "").$fname);
		igk_set_env("igk://sys/currenturiaccess", $__local_uri__);
		igk_include_set_view($file);
		$viewargs = get_defined_vars();
		include($file);
		igk_include_unset_view($file);
	};
	$of = $fc->bindTo($ctrl);
	$of($ctrl, $source, $t,  $file, $args, $fname);
}

///<summary>return the current acting view controller</summary>
function igk_ctrl_current_view_ctrl(){
	return igk_get_env("sys://ctrl/view/controller");
}

///<summary>include controller view as content. the view to include is the first item of the params table</summary>
///<param name="file">first file of the param </param>
function igk_ctrl_include_content($ctrl, $file, $t,  $params, $source=null,$dir=null){
	$c =  igk_getv($params,0);
	if ($c ){
		if ($dir==null)
			$dir=  dirname($file);
		$f = $dir."/{$c}.phtml";
		if (($f!=$file) && file_exists($f)){
			$dt = array_slice($params,1);
			igk_ctrl_include_view_file($ctrl, $source, $t->addDiv(), $f ,$dt);
		}else{
			$t->addDiv()->addPanel()->Content = R::ngets("e.pagenotfound_1", $c);

		}
	}
}




///<summary>load environment files</summary>
function igk_load_env_files($dirname){
	$t_files = array();
	igk_raise_event("sys://event/cachelibreload", array(null, (object)array("files"=>& $t_files)));	
	$tab =  [IGK_INC_FOLDER, IGK_PROJECTS_FOLDER];
	foreach($tab as $k=>$s){
		$g_files = igk_loadcontroller($dirname."/".$s);	
		$t_files = array_merge($t_files, $g_files);
	}
	return $t_files;
	
}
///<summary>init environame</summary>
///<param name="dirname">starting directory</dirname>
function igk_initenv($dirname){
	if (!is_dir($dirname))
		return -9;
	$confFILE = $dirname."/Data/configure"; //configure file
	$Rfile = $dirname."/R/R.class.php"; //resources class
	if (!defined("IGK_APP_DIR"))
		define("IGK_APP_DIR", $dirname);

	// igk_exit();
	if (!(defined('IGK_INIT') && IGK_INIT) && file_exists($confFILE))
	{
		if (file_exists($Rfile))
			include_once($Rfile);


		if (!IGKApp::LoadCacheLibFiles())
		{
			$t_files = igk_load_env_files($dirname);
			igk_reglib($t_files);					
			IGKApp::CacheLibFiles(true);
		}
		IGKSubDomainManager::Init();
		return;
	}

	$hdir = null;
	if (is_dir($dirname))
		$hdir = opendir($dirname);
	if (!$hdir)
		return;
// define("IGK_INIT", 0);

		// igk_wln("init ".(!(defined('IGK_INIT') && IGK_INIT) && file_exists($confFILE)));
		// igk_wln(file_exists($confFILE));
		// igk_exit();
	//demand to initialize environment
	IGKApp::$INITENV = 1;
	$v_access = $dirname."/.htaccess";
	$access = "deny from all";//default htaccess . 
	$old = umask(0);
	IGKIO::CreateDir($dirname."/Configs");
	//----------------------------------------------------------------------------------------------
	//create and init framework environment
	//----------------------------------------------------------------------------------------------

	$idx = $dirname."/index.php";
	if (!file_exists($idx)){
		$indexsrc = igk_getbaseindex_src();
		igk_io_save_file_as_utf8($idx, $indexsrc);
	}



	igk_io_save_file_as_utf8($dirname."/Configs/index.php",igk_config_php_index_content(), false);
	igk_io_save_file_as_utf8($dirname."/Configs/.htaccess",igk_getconfig_access(), false);
	//write default access
	igk_io_save_file_as_utf8($v_access, igk_getbase_access(), true);
	igk_io_save_file_as_utf8($dirname."/Lib/.htaccess", $access, true);
	IGKIO::CreateDir($dirname."/R");

	igk_io_save_file_as_utf8($dirname."/R/.htaccess", "allow from localhost",true);
	IGKIO::CreateDir($dirname."/R/Img"); //folder that will contain image folder
	igk_io_save_file_as_utf8($dirname."/R/Styles/.htaccess", "allow from all",true);
	IGKIO::CreateDir($dirname."/R/Layouts");//folder that will contain layout
	igk_io_save_file_as_utf8($dirname."/R/Styles/.htaccess", "allow from all",true);
	IGKIO::CreateDir($dirname."/R/Styles"); //folder that will contain primary styles
	igk_io_save_file_as_utf8($dirname."/R/Styles/.htaccess", "allow from all",true);

	IGKIO::CreateDir($dirname."/R/Fonts"); //folders that will contain fonts
	igk_io_save_file_as_utf8($dirname."/R/Fonts/.htaccess", "allow from all", false); //folders that will contain fonts


	IGKIO::CreateDir($dirname."/R/Videos"); //folders that will contain fonts
	igk_io_save_file_as_utf8($dirname."/R/Styles/ie.css", "@import url(\"base.css\");", true);
	igk_io_save_file_as_utf8($dirname."/R/Styles/mod.css", "@import url(\"base.css\");", true);
	igk_io_save_file_as_utf8($dirname."/R/Styles/base.css", igk_css_getdefaultstyle(), true);
	igk_io_save_file_as_utf8($dirname."/R/Styles/balafon.css.php", igk_get_basestyle(), true);

	IGKIO::CreateDir($dirname."/R/Themes");
	//write basics theme
	//
	$v_f = IGKIO::ReadAllText(igk_io_syspath(IGK_DEFAULT_THEME_FOLDER."/default.themes"));

	igk_io_save_file_as_utf8($dirname."/R/Themes/default.phtml", $v_f, true);
	igk_io_save_file_as_utf8($dirname."/R/Themes/default.theme", IGKIO::ReadAllText(igk_io_syspath(IGK_DEFAULT_THEME_FOLDER."/default.theme")), false);

	//create project folder
	IGKIO::CreateDir($dirname."/".IGK_PROJECTS_FOLDER);
	IGKIO::CreateDir($dirname."/".IGK_PLUGINS_FOLDER);
	IGKIO::CreateDir($dirname."/".IGK_PAGE_FOLDER);

	igk_io_save_file_as_utf8($dirname."/".IGK_PAGE_FOLDER."/.htaccess", $access,true);

	igk_io_save_file_as_utf8($dirname."/".IGK_PROJECTS_FOLDER."/.htaccess", $access,true);
	$data_dir = $dirname."/".IGK_DATA_FOLDER;
	IGKIO::CreateDir($data_dir);
	IGKIO::CreateDir($data_dir."/Lang");
	//copy file to
	//igk_io_save_file_as_utf8($dirname."/Data/Lang/lang.fr.resources", IGKIO::ReadAllText(dirname(__FILE__)."/Default/Lang/lang.fr.resources"), true);

	//init default data. by copying data to output folder

	IGKIO::CopyFiles(dirname(__FILE__)."/Default/Data",	$dirname."/".IGK_DATA_FOLDER, true);

	igk_io_save_file_as_utf8($dirname."/".IGK_DATA_FOLDER."/.htaccess", $access,false);
	igk_io_save_file_as_utf8($dirname."/".IGK_CONF_DATA, igk_get_defaultconfigData(),false);
	IGKIO::CreateDir($dirname."/".IGK_SCRIPT_FOLDER);
	IGKIO::CreateDir($dirname."/".IGK_INC_FOLDER);
	igk_io_save_file_as_utf8($dirname."/".IGK_INC_FOLDER."/.htaccess", "deny from all");
	//caches folder
	IGKIO::CreateDir($dirname."/".IGK_CACHE_FOLDER);
	igk_io_save_file_as_utf8($dirname."/".IGK_CACHE_FOLDER."/.htaccess", "deny from all");

	
	igk_load_env_files(IGK_LIB_DIR);
	igk_loadcontroller($dirname."/".IGK_INC_FOLDER);
	igk_loadcontroller($dirname."/".IGK_PROJECTS_FOLDER);
	// igk_io_save_file_as_utf8($dirname."/Mods/.htaccess", "deny from all");

	igk_io_save_file_as_utf8($confFILE,"1", false);
	//store the domain config
	$ips =igk_getv($_SERVER, "SERVER_NAME");
	igk_io_save_file_as_utf8($dirname."/".IGK_DATA_FOLDER."/domain.conf", !IGKValidator::IsIPAddress($ips)?$ips : IGK_DOMAIN, true);

	//make all cgi executatble
	$cgi = dirname(__FILE__)."/cgi-bin";
	foreach(igk_io_getfiles($cgi, "/\.cgi$/") as $k){
			@chmod($k, octdec("0705"));
	}


	//require db configuration
	closedir($hdir);
	umask($old);

	igk_raise_initenv_callback();

	IGKApp::$INITENV = 0;
	IGKSubDomainManager::Init();
}


///<summary>raise environment event. </summary>
function igk_raise_event($evtn, $params){
	$g = igk_get_env("sys://environment/events",array());
	$b = igk_getv($g, $evtn);
	if ($b){
		if ($b->sortrequire)
			sort($b->callbacks);
		foreach($b->callbacks as $k=>$v){
			
			if (call_user_func_array($v, $params)){
				break;
			}
		}
	}
}
///<summary>register environment event. will not be serialize because store on environment variable.</summary>
function igk_reg_event($evtn, $callback){
	$key = "sys://environment/events";
	$g = igk_get_env($key,array());
	
	$s = igk_getv($g, $evtn);
	if ($s == null){
		$s = (object)array();
		$s->callbacks = array();
	}
	$s->sortrequire =1;	
	array_push($s->callbacks, $callback);
	$g[$evtn] = $s;	
	igk_set_env($key, $g);
}


function igk_reg_initenv_callback($callback){
	$c = igk_get_env("sys://init_env/callback", array());
	$c[] = $callback;
	igk_set_env("sys://init_env/callback", $c);
}
function igk_raise_initenv_callback(){
	$c = igk_get_env("sys://init_env/callback");
	if ($c){
		foreach($c as $k){
			$k();
		}
	}
	igk_set_env("sys://init_env/callback", null);
}

function igk_init_access($dirname=null){
	$v_access ="";
	if ($dirname==null)
		$dirname = IGK_APP_DIR;

	$v_access = $dirname. "/.htaccess";
	igk_io_save_file_as_utf8($v_access, igk_getbase_access(), true);
}


//
//Environment functions
//
function igk_get_env($k, $default=null){
	global $IGK_ENV;
	// if ($k == "sys://env/actions"){
		// igk_ilog("function : ".__FUNCTION__." ".igk_env_count(__FUNCTION__));
	// }
	if (isset($IGK_ENV[$k]))
		return $IGK_ENV[$k];

	if (($default!=null) && igk_is_callable($default)){ // updated to avoid igk_is_callable call nested
			$m = call_user_func_array($default, array());
			$IGK_ENV[$k] = $m;
			return $m;
	}
	// return $default;
	return igk_getv($IGK_ENV,$k,  $default);
}
function igk_get_env_init($key, $callback){
	$c = igk_get_env($key);
	if ($c==null){
		$c = $callback();
		igk_set_env($key, $c);
	}
	return $c;
}
///<summary>
///get all environment variable that match the pattern
///<summary>
function igk_get_env_all($match){
	$t = array();
	global $IGK_ENV;
	foreach($IGK_ENV as $k=>$v){
		if (strstr($k,$match)){
			$t[$k]=$v;
		}
	}
	return $t;
}
function igk_set_env($k, $v){
	 // igk_assert_die($v==="igk_test_api_play_video", "Setting video play");
	// igk_assert_die($k == "sys://ctrl/current__invoke_ctrl", "Not allowed");
//igk_assert_die($k == "env://IGKSubDomainCtrl/view/args", "tracked");
	global $IGK_ENV;
	if (isset($IGK_ENV[$k]))
	{
		if($v === null){
			unset($IGK_ENV[$k]);
			return;
		}
	}else if ($v===null){
		return;
	}
	$IGK_ENV[$k] = $v;
}
///<summary>push data on  environment variable. use to save state</summary>
function igk_push_env($n,$v){
	global $IGK_ENV;
	if ($v==null){
		return;
	}
	$tab = igk_getv($IGK_ENV, $n, function(){return array();});
	if (!is_array($tab))
		igk_die("failed tab is not an array", __FUNCTION__);
	array_push($tab, $v);
	$IGK_ENV[$n] = $tab;

}
///<summary>pop data on  environment variable. use to restore state</summary>
function igk_pop_env($n){
	global $IGK_ENV;
	$tab = igk_getv($IGK_ENV, $n);
	if (is_array($tab)){
		$r = array_pop($tab);
		$IGK_ENV[$n] = $tab;
		return $r;
	}
	return null;
}

///<summary>peek the data on environement variable</summary>
function igk_peek_env($n){
	global $IGK_ENV;
	if ($n == "sys://env/actions"){
		igk_die(__FUNCTION__);
	}
	$tab = igk_getv($IGK_ENV, $n);
	if (is_array($tab) && (($c = igk_count($tab))>0)){
		$r = $tab[$c-1];
		return $r;
	}
	return null;
}


///<summary>store environment data as array</summary>
function igk_set_env_array($k, $v){
	$s = igk_get_env($k);
	if (!is_array($s)){
		$s = array();
	}
	$s[] = $v;
	igk_set_env($k,$s);
	return $s;
}
///<summary>set environment value ass assoc key => $value</summary>
function igk_set_env_keys($n, $k,$v){
	$s = igk_get_env($n);
	if (!is_array($s)){
		$s = array();
	}
	$s[$k] = $v;
	igk_set_env($n,$s);
	return $s;
}
///<summary>get the current value of the counter</summary>
function igk_env_count_get($k){
	$sk = 'sys://counter/'.$k;
	return igk_get_env($sk, null);
}
function igk_env_count($k){
	$sk = 'sys://counter/'.$k;
	$c = igk_get_env($sk, 1);
	igk_set_env($sk, $c+1);
	return $c;
}
function igk_env_count_reset($k){
	$sk = 'sys://counter/'.$k;
	igk_set_env($sk, null);
}
///<ummary>start environment session</summary>
function igk_env_session_start($dir){
	igk_initenv($dir);
	igk_start_session();
	IGKApp::Init(__FILE__);
}
function igk_get_env_lib_loaded($v=null){
	$k = "sys://libloaded";
	igk_set_env($k, $v);
	return igk_get_env($k, 0);
}

///<summary>get all global environments table</summary>
function igk_get_envs(){
	global $IGK_ENV;
	return $IGK_ENV;
}

///<summary>retrieve environment variable as object</summary>
function igk_get_env_obj($ns){
	$c = igk_get_env_all($ns);
	if (!$c)
		return null;
	$t = array();
	$ln = strlen($ns)+1;
	$ln -= $ns[$ln-2] == '/'? 1:0;

	foreach($c as $k=>$v){
		$n = substr($k, $ln);
		$tt  = explode("/",$n);
		if (igk_count($tt)==1){
			$t[$n] = $v;
		}else{
			$g = null;
			$nn = array_pop($tt);
			// igk_wln($tt);
			//e_xit;
			foreach($tt as $m){
				if (($g==null)){
					//firt line
					 if (isset($t[$m])){
						$g = $t[$m];
					 }
					 else {
						 $g = igk_createObj();
						 $t[$m] = $g;
					 }

				}else{
					if (!isset($g->$m)){
						$g->$m = igk_createObj();
						$g = $g->$m;
					}
				}
			}
			$g->$nn = $v;
		}

	}
	return (object)$t;
}

///<summary>zip outpu content</summary>
function igk_zip_output($c , $forcegzip=0){
	//safari not allow to zip output content
	//igk_wln($_SERVER);
	
	
	$accept = igk_getv($_SERVER, 'HTTP_ACCEPT_ENCODING',0);
	if (!$forcegzip && strstr($accept, "deflate") && function_exists("gzdeflate")){
		header('Content-Encoding: deflate');
		igk_wl(gzdeflate( $c, 3 ));
	}
	else if (($forcegzip || strstr($accept, "gzip")) && function_exists("gzencode")){		
		header('Content-Encoding: gzip'); //safari gzip encode requirement
		igk_wl(gzencode( $c, 3 ));
	}else{
		igk_wl($c);
	}
}

///<summary>
function igk_set_error($tag, $message, $info=null){
	igk_push_env("sys://".__FUNCTION__, array("tag"=>$tag, "message"=>$message,"info"=>$info));
}
function igk_set_error_msg($tab){
	$t = igk_get_env("sys://error_msgs");
	if (is_array($t)){
		$t = array_merge($t, $tab);
	}
	igk_set_env("sys://error_msgs", $t);
}
///<summary>return all error</summary>
function igk_get_error($tag=null){
	$tab = igk_get_env("sys://igk_set_error");
	if ($tag!=null){
		$o = array();
		foreach($tab as $k=>$v){
			if ($v["tag"]==$tag){
				$o[] = $v;
			}
		}
		return $o;
	}
	igk_set_env("sys://igk_set_error", null);
	return $tab;
}

function igk_register_requirement($name, $callback){
	$t = igk_get_env(IGK_ENV_REQUIREMENT_KEY, array());
	$t[$name] = $callback;
	igk_set_env(IGK_ENV_REQUIREMENT_KEY, $tab);
}


function igk_getconfig_access(){

$root_dir = igk_html_uri(igk_io_rootBaseDir());
$root_dir = igk_str_rm_start(igk_str_rm_last($root_dir, "/"), "/");
$root_dir = !empty($root_dir)? "\"/".$root_dir: "\"";
$error_404 = $root_dir."/Lib/igk/igk_redirection.php?code=404&m=config\"";
$error_503 = $root_dir."/Lib/igk/igk_redirection.php?code=503&m=config\"";


	$out =<<<EIO
#SetEnv PHP_VER 5_4
Options -Indexes
ErrorDocument 404 {$error_404}
ErrorDocument 403 {$error_503}

#no mod rewrite
<IfModule rewrite_module>
RewriteEngine Off
</IfModule>
EIO;

return $out;
}
function igk_getbase_access()
{
$server_n = igk_io_dir(igk_getv($_SERVER,"SERVER_NAME"));
$rdir = igk_io_dir(igk_getv($_SERVER,"DOCUMENT_ROOT"));
$bdir = igk_io_baseDir();
$is_baseroot = $rdir  == $bdir;
// igk_wln($rdir ." ? ".$bdir ."=".$is_baseroot);

$root_dir = igk_html_uri(igk_io_rootBaseDir());
$root_dir = igk_str_rm_start(igk_str_rm_last($root_dir, "/"), "/");

$root_dir = !empty($root_dir)? "\"/".$root_dir: "\"";
$_rd = $root_dir."/Lib/igk/igk_redirection.php";
$error_404 = $_rd."?code=404\"";
$error_503 = $_rd."?code=503\"";
$error_901 = $_rd."?code=901\"";
$berror_901 = "Lib/igk/igk_redirection.php?code=901";
$const = "constant";
	$out = <<<EOF
#{$const('IGK_PLATEFORM_NAME')} primary htaccess file
#installing from {$server_n}
#rootdir {$root_dir}
#SetEnv PHP_VER 5_4
Options -Indexes
ErrorDocument 404 {$error_404}
ErrorDocument 403 {$error_503}

# Use UTF-8 encoding for anything served as text/plain or text/html
AddDefaultCharset utf-8
<IfModule mod_mime.c>
    # Force UTF-8 for certain file types
    AddCharset utf-8 .css .js .json .vtt .nex .webapp .xml
</IfModule>

#if web server support RewriteEngine the redirect file to igk_redirection.php?code=901. this code will support
#post value redirection
#note: because of ovh server when RewriteRule operate REQUEST_FILENAME is prefixe by redirect:
<IfModule rewrite_module>
RewriteEngine On
SetEnv IGK_REWRITE_MOD 1

#site map redirection
RewriteCond "%{REQUEST_FILENAME}" /sitemap(\.xml)?$
RewriteRule ^(/)?(.)*$  "Lib/igk/igk_sitemap.php" [QSA,L]

#default favicon file requested by browser but not present
RewriteCond "%{REQUEST_FILENAME}" /favicon.ico$
RewriteCond "%{REQUEST_FILENAME}" !-f
RewriteRule ^(/)?(.)*$  "Lib/igk/igk_favicon.php" [QSA,L]


#rewrite rule for subdomain checking

#ip detection 127.0.0.1
RewriteCond "%{REQUEST_FILENAME}" !^redirect:
RewriteCond "%{REQUEST_FILENAME}" !-f
RewriteCond "%{REQUEST_FILENAME}" !-d
RewriteCond "%{HTTP_HOST}" ^([0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3})$
RewriteRule ^(/)?(.)*$  "{$berror_901}&rwc=0" [QSA,L]

#subdomain detection
RewriteCond "%{REQUEST_FILENAME}" !^redirect:
RewriteCond "%{REQUEST_FILENAME}" !-f
RewriteCond "%{HTTP_HOST}" ^www\.((.)+\.){2,}((.)+)$
RewriteRule ^(/)?(.)*$  "index.php?rwc=1" [QSA,L]

RewriteCond "%{REQUEST_FILENAME}" !^redirect:
RewriteCond "%{REQUEST_FILENAME}" !-f
RewriteCond "%{HTTP_HOST}" !^www\.
RewriteCond "%{HTTP_HOST}" ^((.)+\.){2,}((.)+)$
RewriteRule ^(/)?(.)*$  "index.php?rwc=2" [QSA,L]

#rewrite global
RewriteCond "%{REQUEST_FILENAME}" !^redirect:
RewriteCond "%{REQUEST_FILENAME}" !-f
RewriteCond "%{REQUEST_FILENAME}" !-d
RewriteRule ^(/)?(.+)(/)?$  "{$berror_901}&rwc=3" [QSA,L]
</IfModule>

EOF;

$out = eval("?>".igk_io_read_allfile(IGK_LIB_DIR."/Inc/.htaccess.index.default"));
//note: rwc for rewrite condition
return $out;

}

//---------------------------------------------------------------------------------------------------
///retrieve base.css file. Management
//---------------------------------------------------------------------------------------------------
function igk_css_add_doc_style($doc){
	$t = $doc->addStyle("R/Styles/balafon.css.php",true);
	$t->cache = 1;
	return $t;
}



function igk_page($n){
	return igk_getv(array("films"=>"movies"), $n, $n);
	//return $n;
}
function igk_css_bind_sys_global_files($vsystheme=null, $bindfile=1){	
	$vsystheme = $vsystheme ?? igk_app()->Doc->getSysTheme() ?? igk_die("can't bind global files");
	$tab = igk_get_env("sys://css/file/global_files");
	
	foreach($tab as $d=>$s){
		if (file_exists($d)){				
			igk_css_bind_file(null, $d, $vsystheme);
		}
	}
	if ($bindfile)
	igk_css_bind_theme_files($vsystheme);
}


///<summary>bind file from theme</summary>
function igk_css_bind_theme_files($theme){
	$lfile = explode(";", igk_io_expand_path($theme->def->getFiles()));
	foreach($lfile as $d){
		if (empty($d))continue;
		
		if (strpos($d, '|')===false)
			$d.="|";
		list($file,$ctrl) = explode('|', $d);
		if (file_exists($file)){
			igk_css_bind_file(null, $file, $theme);
		}else{
			igk_ilog("File not found - [{$d}]", __FUNCTION__);
		}
	}
}
function igk_css_balafon_index($dir){
	header('Content-Type: text/css; charset=UTF-8');
	$c = igk_getr("Cache");
	if ($c){
		return;
	}
	
	
	igk_initenv($dir);
	igk_start_session();

	IGKOb::Start();
	//bind requested the files
	$doc = igk_app()->Doc;
	if ($doc){
		//close the session to disable update of value
		@session_write_close();
		$vsystheme = $doc->getSysTheme();
		igk_css_bind_sys_global_files($vsystheme);			
		igk_css_load_theme($vsystheme);
		igk_css_render_balafon_style();
		// $vsystheme->resetAll();
		// $doc->Theme->def->clear();
	}else{
		include(dirname(IGK_LIB_DIR."/Styles/balafon.min.css"));
	}
	$c = IGKOb::Content();	
	IGKOb::Clear();
	//clear definition
	igk_header_no_cache();
	if (!empty($c))
	{
		// if (igk_sys_env_production()){
			//igk_zip_output(igk_css_minify($c));
		// }
		// else
		igk_zip_output($c);		 
	}
	@session_write_close();
	igk_exit();
}
//<summary>build balafon css stylse</summary>
function igk_css_render_balafon_style(){

header('content-type: text/css');
$o = "/*\r\nBalafon.css Dynamic css-defition \r\n";
$o .=igk_css_header_comment();
$o.="\r\n".IGK_END_COMMENT."\r\n";
$f = igk_io_currentRelativePath("Caches/cssstyle.cache");
$t = (igk_app()->Doc === null) || igk_app()->Configs->UseCssCache;
 // igk_ilog(igk_ob_get($_SERVER));
igk_set_env(__FUNCTION__, 1);
if ($t)
{
	if (file_exists($f)){
		$o .= IGKIO::ReadAllText($f);
	}else{
		$o = "/*balafon: doc or no-cache available*/\n";
	    $o .= IGKIO::ReadAllText(IGK_LIB_DIR."/Styles/balafon.min.css");
	}
	$uri = igk_io_baseUri();
	$_is_firefox = strstr($_SERVER["HTTP_USER_AGENT"], "Firefox"); //suppose user agent firefox request for thumnail image
	if ($_is_firefox){
// $o.=<<<EOF
// body:not(.custom-thumbnail) *[igk-type='controller']{
	// display:none !important;
// }
// body:not(.custom-thumbnail):before{
	// content:' ';
	// display:block;
	// position:absolute;
	// width:100%;
	// height:100%;
	// background-image:url('{$uri}/R/Img/thumbnail.png');
	// background-size:auto 100%;
	// background-repeat:no-repeat;
// }
// EOF;
	}
}
else{

	$mfile = igk_getr("minfile") || igk_sys_env_production();
	if ($mfile){
		$o = implode('|', explode("\\r\\n",$o));
	}
	$o .= igk_css_getbasedef($mfile);
	if ($t){
		IGKIO::WriteToFile($f, $o);
	}
}
$o.="/*finish*/";
igk_wl($o);
}

///<summary>used to bind a theme files to a theme</summary>
///<remark>if no theme defined then the system global theme will be used</remark>
///<remark2>theme is file that contain only color, font and properties definition</remark2>
function igk_css_load_theme($th=null){
	$gt = igk_web_get_config("globaltheme", 'default');
	$f = igk_io_baseDir()."/R/Themes/{$gt}.theme";
	if (!file_exists($f))
		return;
	$th = $th ? $th :igk_app()->Doc->SysTheme;
	$t =array();
	$t["cl"] = & $th->def->getCl();
	$t["prop"] = & $th->def->getParams(); //properties;
	//$t["fs"]= array();//font size
	igk_include_file($f, $t);
}
function igk_get_basestyle()
{
	//10.02.13 new base style
	$bf = __FILE__;
	$rdir = realpath(IGK_APP_DIR);
$v = <<<EOF
<?php
define("IGK_FORCSS", 1);
define("IGK_NO_WEB", 1);
require_once('{$bf}');
igk_css_balafon_index('{$rdir}');
?>
EOF;
return $v;
}

function igk_config_php_index_content()
{

$cwize_f= igk_io_basePath(dirname(__FILE__)."/View/wizeinstall.phtml");
$v = <<<ETF
<?php
define("IGK_CONFIG_PAGE",1);
@require_once(dirname(__FILE__)."/../index.php");
igk_sys_config_view(__FILE__);
?>
ETF;
return $v;
}

function igk_sys_get_mtime_uid(){
$m = microtime();
$l = igk_getv(explode(' ', $m), 1);
return 	IGKNumber::ToBase((int)($l), 36);
}


///<summary>invoke configuration page settings</summary>
function igk_sys_config_view($file){
$cfavicon= "/Lib/igk/Default/R/Img/cfavicon.ico";
$igk = igk_app();


// igk_wln(__LINE__.":root uir : ".IGKIO::GetRootUri());
// igk_wln(__LINE__.":fullrequest uri : ".igk_io_fullrequestUri());
// igk_wln(__LINE__.":baseUri : ".igk_io_baseUri());
$p= igk_sys_getconfig("configuration_port");
// igk_wln($p);
// igk_wln($_SERVER["SERVER_PORT"]);

if (($p= igk_sys_getconfig("configuration_port")) && ($p != $_SERVER["SERVER_PORT"])){
	if ($p==443){
		$s  = igk_secure_uri(igk_io_baseDomainUri(), true, false)."/Configs";
	}
	else
		$s = igk_io_baseDomainUri();
	igk_navto($s);
	igk_exit();
}

if (!$igk){
	igk_log_write_i("CONFIG", "No Instante found for configuration page");
	igk_exit();
}


try{
	if (igk_is_thumbnail_request()){
		$d = igk_createNode("thumbNailDocument",null,array( $file));
		$d->Title = "Configuration Page - [".igk_sys_getconfig("website_title")."]";
		$d->RenderAJX();
		igk_exit();
	}



if ($igk->Session->getParam("igk_wizeinstall") || (igk_server_is_local() && igk_getr("wizeinstall")==1) ){
		igk_header_no_cache();
		$c = igk_getctrl(IGK_CONF_CTRL);
		//build params to pass to view
		$t = array();
		if (isset($_POST["install"])){
			$t[] = "install";
		}
		//call view to render as document
		igk_ctrl_render_doc($c,"wizeinstall", $t);
		igk_exit();
}

// igk_wln("config page");
igk_getconfigwebpagectrl()->View();
//get the global document
$doc = $igk->Doc;
//change title
$doc->Title = R::ngets("title.igkwebconfig_1",  igk_sys_domain_name());
//set favicon
$doc->Favicon = new IGKHtmlRelativeUriValueAttribute("{$cfavicon}");
igk_set_session_redirection(null);
igk_header_no_cache();
$doc->RenderAJX();
}
catch(Exception $Ex){
	igk_show_exception($Ex);
	igk_exit();
}
}


function igk_get_defaultconfigData()
{
$servname = igk_getv($_SERVER, "SERVER_NAME", "igkdev.com");
$const = "constant";//including constant value

$v = <<<EOF
admin_login,admin
admin_pwd,21232f297a57a5a743894a0e4a801fc3
app_default_controller_tag_name,div
show_powered,1
show_debug,0
menu_defaultPage,default
allow_debugging,0
allow_log,0
allow_article_config,0
allow_auto_cache_page,0
cache_loaded_file,0
website_domain,{$servname}
website_title, {$servname}
company_name, igkdev
mail_server,relay.skynet.be
mail_port,25
mail_admin,administrator@igkdev.com
mail_contact,info@igkdev.com
db_server,localhost
db_user,igkdev
db_name,igkdev
db_pwd,
db_prefix, {$const('IGK_DEFAULT_DB_PREFIX')}
web_pagectrl,defaultpagectrl
powered_message,
meta_description,default page description
meta_copyright,igkdev@igkdev.com
meta_enctype,text/html; charset=utf-8
meta_keysword,"IGKDEV, .NET, C#, BONDJE DOUE, Developper, PHP, HTML5, WEBDEV, PLATEFORM, BALAFON"
meta_title, igkdev.be
website_prefix, igk,
copyright, {$const('IGK_COPYRIGHT')}
EOF;
return $v;
}


function igk_reglib_once($file)
{
	$f = realpath($file);

	if (!empty($f) && file_exists($f))
	{
		require_once($f);
		igk_reglib(array(igk_html_uri($f)=>igk_html_uri($f)));
	}
}
function igk_reglib($files)
{
	if (($files==null)  || (igk_count($files)==0))
		return;
	if (IGKApp::$LibFiles == null)
		IGKApp::$LibFiles = array();

	foreach($files as $k=>$v)
	{
		if (!isset(IGKApp::$LibFiles[$v]))
			IGKApp::$LibFiles[$v] = $v;
	}
}
///<summary>used to load library files</summary>
function igk_loadlib($dir, $ext="php", $excludedir=null){
	global $IGK_ENV;
	$dir = igk_io_dir(realpath($dir));
	$dirs = array();
	$dirs[] = $dir;
	$files = array();
	$excluded_key = "sys://lib/ignoredir";
	if ($excludedir==null){
		$excludedir = igk_get_env($excluded_key) ?? array(
			"Data"=>1 ,
			"View"=>1
		);
	}
	$IGK_ENV[$excluded_key ] = & $excludedir;
	
	// igk_debug_wln("exclude dir ....");
	// igk_debug_wln($excludedir);

	// $b = microtime(true);
	// $fc = 0;//folder count;
	while(igk_count($dirs )> 0){
		$dir = array_shift($dirs);
		// if(igk_sys_is_lib_ignore($dir))continue;
		if(isset($excludedir[$dir]))continue;
		$hdir = @opendir($dir);
		if (!$hdir)
			continue;
		$file = IGK_STR_EMPTY;


		while($fdir = readdir($hdir))
		{
			if (($fdir == ".") || ($fdir=="..") || isset($excludedir[$fdir]))
				continue;
			$file  = $dir.DIRECTORY_SEPARATOR.$fdir;



			if (is_dir($file) ){
				
				if(isset($excludedir[$file]) || ($fdir[0]==".")){
					// igk_wln("ignored : ".$file);
					$excludedir[$file]=1;
					continue;
				}
				$dirs[] = $file;//push folder
				// $fc++;
			}
			else {
				if (strstr($file, ".phtml") || !IGKString::EndWith($file,$ext))
					continue;
					
				include_once($file);				
				$files[] = igk_html_uri($file);

			}
		}
		closedir($hdir);
		if (count($dirs)>1){
			sort($dirs);
		}
	}
	
	//unset($IGK_ENV["sys://lib/ignoredir"]);

	return $files;
}



//--------------------------------------------------------------------------------------------------------
// AGENT FUNCTIONS
//--------------------------------------------------------------------------------------------------------

//get if client user agent is microsoft internet explorer
function igk_agent_isIE(){
	return IGKUserAgent::IsIE();
}
function igk_agent_ieVersion()
{
	if (igk_agent_isIE())
	{
		$tab = array();
		$c = preg_match_all("/(?<type>(MSIE|Trident|Edge))(\/)?\s*(?P<version>[0-9\.]+)/i", $_SERVER["HTTP_USER_AGENT"], $tab);
		if ($c>=1){

			$t = igk_getv($tab["type"],0);
			$v = igk_getv($tab["version"],0);
			switch($t){
				case 'MSIE':
				default:
					return $v;
				break;
			case 'Trident':
				return "11.0/".$v;
			case 'Edge':
				return "12.0/".$v;
		}
		}
	}
	return null;
}
function igk_agent_isAndroid(){//get if the gent is an android device
	return IGKUserAgent::IsAndroid();
}
function igk_agent_androidVersion(){//get the android device version
	return IGKUserAgent::GetAndroidVersion();
}


///<summary>return the map selection fo the node</summary>
///<return >array of selection</return>
function igk_get_selector_map($node){
	$o = array();


	$toi = IGK_STR_EMPTY;
	$c = 0;
	while($node){
		$oi = "((\s|^)(".$node->tagName;
		$h = ($cl = $node["class"]) ? $cl->getValue() : null;
		$id = $node["id"];
		$tf = IGK_STR_EMPTY;
		if (!empty($id))
		{
			$tf .= "(#".$id.")";
		}
		if (empty($h) == false)
		{
			$b = explode(" ", $h);
			if (count($b)>0){
				$i = 0;
				$rk=IGK_STR_EMPTY;
				foreach($b as $r=>$s){
					if (!empty($s))
					{
						if ($i)
						$rk.="|";

						$rk.="\.".$s;


					$i=1;
					}
				}
				if ($i)
				{
					if (!empty($tf)){
						$tf .= "|(".$rk.")";
					}
					else
						$tf .= "(".$rk.")";
				}
			}
		}
		if (!empty($tf))
			$oi .= $tf."*|".$tf;

		$oi .=")";

		if (empty($toi))
			$toi = $oi."$)".$toi;
		else {
			$toi = "(((".$oi.")"."(|>))*".$toi."))";
		}
		$node = $node->getParentNode();
		if (!$node || ($node->tagName=="body"))
		{
			break;
		}
		//$node->RenderAJX();
		$c++;
		$o[] = "/(".$toi.")/im";
	}
	$o[] = "/(".$toi.")/im";

	return $o;
}

function igk_create_cref(){
	static $cref;
	if (!isset($cref)){
		$cref = "cref:".date("Ymd-His")."|".igk_new_id();
	}
	return $cref;
}

///<summary>shortcut to get session param value</summary>
function igk_get_session($name){
	return igk_app()->Session->$name;
}
///<summary>shortcut to set session param value</summary>
function igk_set_session($name, $v){
	igk_app()->Session->$name = $v;
}
///<summary>set session redirection page</summary>
function igk_set_session_redirection($uri=null, $reset=1){


	$h = igk_get_env("sys://func/".__FUNCTION__);
	if ($reset){
		$h =0;
	}

	if ($h)
		return;

	if ($uri==null){
		//reset to base request uri
		$uri = igk_io_fullBaseRequestUri();
	}
	igk_set_session(IGKSession::IGK_REDIRECTION_SESS_PARAM, $uri);
	igk_set_env("sys://func/".__FUNCTION__,1);
}

///<summary>convert value to presentation</summary>
function igk_get_sizev($v,$round=4){
$sm_sizeFormat = array(
		"Tb"=>1099511627776,
		"Gb"=>1073741824,
		"Mb"=>1048576,
		"Kb"=>1024,
		"B"=>1
	);

	if ($v==0)
			return "0 byte";
		foreach($sm_sizeFormat as $k=>$vv){
			if ($v>$vv){
				return round(($v/$vv), $round)." ".R::gets("enum.memoryunit.".$k, $k);
			}
		}
		return "0 byte";
}


///<summary>create xml node</summary>
function igk_createXmlNode($d){
	$c = new IGKXmlNode($d);
	return $c;
}
///<summary>create xlst node</summary>
function igk_createXsltNode(){
	$xsl = igk_createXmlNode("xsl:stylesheet");
	$xsl["version"]="1.0";
	$xsl["xmlns"]="http://www.w3.org/1999/xhtml";
	$xsl["xmlns:xsl"]="http://www.w3.org/1999/XSL/Transform";	
	return $xsl;
}

///<summary>create a object node</summary>
function igk_createObj($tab=null){

	if ($tab==null)
		return (object)array();
	if (is_array($tab))
		return (object)$tab;
	if (is_object($tab)) //create a object from
	{
		$obj = (object)array();
		foreach($tab as $k=>$v){
			$obj->$k = $v;
		}
		return $obj;
	}
	return null;
}
///<summary> used to create a filtered object </summary>
function igk_create_filterObject($n, $initarray){
	//passing object or null with initarray
	if (!isset($n) || ($n == null))
		$n = (object)$initarray;
	else{
		if (is_array($n))
			$n = (object)$n;
		foreach($initarray as $k=>$v){
			if (!isset($n->$k)){
				$n->$k = $v;
			}
		}
	}
	return $n;
}
///<summary>create filtered object </summary>
function igk_createObj_filter($src, $filter , $default=null){
	$o = igk_createObj();
	foreach($filter as $k=>$v){
		$o->$k = igk_getv($src, $k, $default);
	}
	return $o;
}
///<summary>create an object by keys</summary>
function igk_createObj_array($keys, $default=null){
	$o = igk_createObj();
	foreach($keys as $m){
		$o->$m = $default;
	}
	return $o;
}


function igk_createObj_strict($array_key){
	return IGKObjectStrict::Create($array_key);
}

///<summary>init controller with a source creation listener</summary>
function igk_init_controller($listener){

	$grantaccess = "allow from all";

	$listener->addDir(IGK_VIEW_FOLDER); //view folder
	$listener->addDir(IGK_ARTICLES_FOLDER);//article folder
	$listener->addDir(IGK_DATA_FOLDER);//data folder
	$listener->addDir(IGK_SCRIPT_FOLDER);//data folder
	$listener->addDir(IGK_STYLE_FOLDER);//data folder

	$listener->addSource(IGK_DATA_FOLDER."/.htaccess", $grantaccess);
	$listener->addSource(IGK_SCRIPT_FOLDER."/.htaccess", $grantaccess);
	$listener->addSource(IGK_STYLE_FOLDER."/.htaccess", $grantaccess);
	$listener->addSource(IGK_STYLE_FOLDER."/default.pcss", igk_get_default_style());
}


function igk_community_get_followus_service(){
	return igk_get_env("sys://services/community/followus");
}

function igk_community_register_followus_service($name, $callback){
	$k="sys://services/community/followus";
	$tab = igk_get_env($k, function(){return array();});
	$tab[strtolower($name)] = $callback;
	igk_set_env("sys://services/community/followus", $tab);
}

function igk_get_services($servicename){
	$k="sys://services/".$servicename;
	return igk_get_env($k);
}
function igk_register_service($type, $name, $callback){
	$k="sys://services/".strtolower($type);
	$tab = igk_get_env($k, function(){return array();});
	$tab[$name]=$callback;
	igk_set_env($k, $tab);
	return $tab;
}


//--------------------------------------------------------------------------------------------------------
// IGK JSON file manager
//--------------------------------------------------------------------------------------------------------
///<summary>convert json string expression to object</summary>
function igk_json_parse($expression){
	$k = "sys://volatile/instance/".__FUNCTION__;
	$r = igk_get_env($k);
	if (!$r){
		$r = new IGKCoreJSon();
		igk_set_env($k, $r);
	}
	return $r->ToDictionary($expression);
}
function igk_json_value($n){
		if (preg_match_all("/^(?P<delimiter>('|\"))(?P<key>(.)+)\\1$/i", $n,$tab)){
			//igk_wln($tab);
			return $tab["key"][0];
		}
		return $n;

}


///<summary>parse expression. multi json object expression</summary>
///<param name="exp">param or semi column expression</param>
function igk_json_array_parse($exp, & $err=null){

	$t = array();//out array
	$st = array();//push state
	$eof = 0;
	$c =0; //position
	$ln=strlen($exp);
	$rm = 0; // read mode
	$q = null;
	$v = "";
	$_br=0;
	$k = "";
	$err = array();
	$decimal_regex = "/^(?P<_dec>([0-9]+(\\.|\\.([0-9]+)){0,1}))$/i";
	$identifier_regex = "/^(?P<_identier>(null|((_|[a-z])([0-9a-z_])*)))$/i";

	while(!$eof && ($ln>$c)){
		$ch = $exp[$c];
		if ($rm==0x18){
			if ($ch==","){
				if ($q){
					$rm=0x2;//read key
				}
			}
			$c++;
			continue;
		}
		switch($ch){
			case "{"://sub string
				if ($rm == 0){
				//	igk_wln("create obj");
					$q = igk_createObj();
					$t[] = $q;
					$rm=0x2;
					$v ="";
				}else if (($rm & 0x1) == 0x1){
					$v.=$ch;
				}else if ($rm ==0x2){
					//bad json
					$err[] = ("bad json .... 0x2");
					// igk_wln($err);
					// igk_wln($t);
					return null;
				}
				else {

					if ($rm == 0x4){ //at non litteral value
						$q->$k = igk_createObj();
						array_unshift($st, $q);
						$q = $q->$k;
						$rm=0x2;
						$v ="";

					}else {
						$err[] = "Not read litteral : read mode : ".$rm;
						return null;
					}
				}
			break;
			case "}":
				if (($rm & 0x1) == 0x1){
					$v.=$ch;
				}else{
					if ($rm == 0x10){
						// igk_wln($q);
						$q = array_shift($st);
						if ($q == null){
							$rm = 0;
						}
						// igk_wln($q);
						//$rm=0;
					}
					else if ($rm ==0x4){

						if ($v!=null){
							 if (empty($v)){
								$err[] = "empty value ";
								// igk_wln($err);
								// igk_wln($t);
								return null;
							}
							//end read value non litteral
							$decimal = preg_match($decimal_regex,$v);
							if ($decimal && $v[strlen($v)-1]==".")
								$v .="0";

						}
						$q->$k= $v;
						$v="";
						$k="";


						// igk_wln($q);
						// igk_wln("count :::: ".count($st));
						$rm = 0x10;
						$q = array_shift($st);
						if ($q == null){
							$rm= 0;
						}

					}else {
						if ($rm!=0){
							$err[] = "possible not catchable object";
							return $t;
						}
					}
				}
				break;
			case "[":
// igk_wln("star t read ...".$rm);

				if (($rm == 0) || ($rm== 0x04)){
					$iv = igk_str_read_brank($exp,$c);
					$iv = trim($iv);
// igk_wln("iv ".$iv);
					if (!empty($iv)){
						// igk_wln("read array!!!!!");
						$ttab  = igk_json_readarray($iv);

						if ($rm ==0){
							$q=$ttab;
							return $q;
						}
						else{
							$q->$k = $ttab;
							$rm = 0x1;
						}
					}
				}else
				$rm = 0x08;
				//$v .= $ch;
				break;
			default:
					switch($rm){
						case 0x2: //read key

							if (($ch=="\"")||($ch=="'")){
								$_br = $ch;
								$rm=0x3;
								//e_xit;
							}else{
								if ($ch==':'){
									//finnish readin key e
									if (empty($v))return null;
									$k = $v;
									$rm= 0x4; //start reading value
									$v="";

									//igk_wln("key : ".$k);

								}else{
									$v = trim($v.$ch);
								}
							}
							break;
						case 0x3: //read key litteral
							if (($ch!= $_br) ||  (($ch==$_br) && ($c>0) && ($exp[$c-1]=="\\"))){
								$v = $v.$ch;
								//igk_wln($v);
							}else{
								//litteral end
								// igk_wln("en read ".$v);
								$k = $v;
								$q->$k=null;
								$rm=0x21;
								$v ="";
							}
							break;
						case 0x4: //start ready value
							if (($ch==="\"")||($ch==="'")){
								$_br = $ch;
								$rm=0x05;
							}else if ($ch=="["){
								$rm = 0x08; //start read array
							}else {

								$t_s = trim($v.$ch);
								if ( ($ch != ',' ) && (empty($t_s) || preg_match($identifier_regex, $t_s) || preg_match($decimal_regex,$t_s))){
									// igk_wln("match ====================".$ch. " : ".$t_s);
									if ($t_s=='null'){
										$v = null;
									}else
										$v = $t_s;
								}
								else{
									$rm = 0x2;
									if($v!=null){
									//end read value non litteral
									$decimal = preg_match($decimal_regex,$v);
									if ($decimal && $v[strlen($v)-1]==".")
										$v .="0";
									}
									$q->$k= $v;
									$v="";
									$k="";
									// igk_wln("normal");
									// igk_wln($q);
								}
							}
							break;
						case 0x5: //reading value litteral
							if (($ch!= $_br) ||  ($ch==$_br && ($c>0) && ($exp[$c-1]=="\\"))){
								$v = $v.$ch;
							}else{
								// igk_wln("second value ".$v);
								$q->$k= $v;
								$rm=0x10;
								$v="";
								$k=null;
								// igk_wln($q);
								//e_xit;
							}
							break;
						case 0x8: //reading value array
							$iv = "";
							$iv = igk_str_read_brank($exp,$c);
							$iv = trim($iv);
// igk_wln("read array 2");
							if (!empty($iv)){
								$ttab  = igk_json_readarray($iv);

								$q->$k=$ttab;
							}
							$rm	=0x18;
							$v="";
							break;
						case 0x10: //splitter
							if ($ch == ","){
								//start reading key
								$rm  = 0x2;
							}
							break;
						case 0x21: //wait for ready value
							if ($ch==':')
								$rm = 0x4;
							break;
					}
				break;

		}
		$c++;

		if ($eof)
			break;
	}
	return $t;
}

function igk_json_readarray($v){

	$rm = 0;
	$ch = 0;
	$pos = 0;
	$ln = strlen($v);
	$iv = "";
	$start= 0;
	$tbalue = array();

	while($pos<$ln){
		$ch = $v[$pos];
			switch($ch){
				case ",":
					if ($rm=0x11){
						$rm=0;
					}else{
						$iv.=$v;
					}
					break;
				case "\"":
				case "'":
				if ($rm == 0){
					$rm=1;//read value
					$start= $ch;
					$iv="";//$ch;
				}else if ($rm==1){
					if (($ch!==$start) || $v[$pos-1]=="\\"){//escape t
						$iv.=$ch;
					}else{
						$tbalue[] = $iv;//.$ch;
						$iv="";
						$rm=0x11;
					}
				}
				break;
				case "{"://start json data
					if ($rm==0){
						$c = igk_str_read_brank($v,$pos,"}","{");
						$obj = igk_json_parse($c);
						if ($obj)
							$tbalue[] = $obj;
						$iv = "";
					}
					else
						$iv.=$ch;
				break;
				case "]"://detect end
					$_cd= trim($iv);
					// igk_wln("end detected ".$_cd);
					if (!empty($_cd)){
						$tbalue[] = $_cd;
					}
					$iv=null;
					break;
				default:
					$iv.=$ch;
					break;
			}

		$pos++;
	}
	return $tbalue;
}
///<summary>transform object to json string presentation</summary>
function igk_json_encode($t){	
	return json_encode($t);
}


///<summary>init html basic method</summary>
function igk_init_html_basic_method(){
	IGKHtmlItemBase::$BasicMethod = array(
		"AcceptRender"=>"__AcceptRender"
	);
}


///<summary>create a file callback object</summary>
function igk_create_file_callback($ctrl, $file , $func=null, $param=null){
	return (object)array(IGK_OBJ_TYPE=>"_callback","clType"=>"file",  "Ctrl"=>$ctrl, "clFile"=>$file, "clFunc"=>$func, "clParam"=>$param);
}
function igk_is_callback_obj($c){
	$s = IGK_OBJ_TYPE;

	//igk_wln("is obj ".is_object($c) ." : ". is_callable($c) );

	return (is_array($c) && isset($c[$s]) && ($c[$s]=="_callback")) ||
			(is_object($c) && !is_callable($c) && isset($c->$s)  && ($c->$s == "_callback"));
}

function igk_create_invoke_callback($fcname, $node){
	$t = array("fc"=>$fcname, "n"=>$node );
	if (func_num_args()>2)
		$t = array_merge($t, array_slice(func_get_args(), 2));
	return igk_create_expression_callback("return \$invokeParam(\$obj,\$fc,null,1);", $t );
}
///<summary> extend is callable function for igk usage</summary>
///<remark> used echo to write something. igk_wln failed nested looping for tracing data. because of igk_getv</remark>
function igk_is_callable($tab){
	if ($tab==null)return 0;
	if (is_callable($tab))
		return true;
	if (is_array($tab) && count($tab)>2)
	{
		$c = array_slice($tab, 0,2);
		return is_callable($c);
	}
	//
	return igk_is_callback_obj($tab);
	// igk_wln("d");

	// return false;
}
///<summary>get if an object is typeof closure</summary>
function igk_is_closure($f){
	return is_callable($f) && is_object($f) && strtolower(get_class($f))=="closure";
}

///<summary>is webmaster callback</summary>
function igk_is_webmaster_callback(){
		return igk_app()->IsSupportViewMode(IGKViewMode::WEBMASTER);
}
	
function igk_callable_id($callable){
	if (is_string($callable) && is_callable($callable))
		return $callable;
	if (!igk_is_callable($callable)){
		return null;
	}


	// if (is_
	if (is_array($callable) && (igk_count($callable)==2)){
		$cl = get_class(igk_getv($callable, 0));
		$m = igk_getv($callable,1);
		$f =  $cl."::\x3a".$m;
		// igk_wln(igk_count($callable));
	// igk_wln(is_array($callable));
	// igk_wln($f);
	//e_xit;
		return $f;
	}

}
///<summary>append data to current object</summary>
function igk_obj_append(& $obj , $data){
	foreach($data as $k=>$v){
		$obj->$k= $v;
	}
	return $obj;
}
///<summary>used to bind request data to object</summary>
function igk_obj_binddata( $obj, $data){
	if (is_object($data))
	{
	// init data
	foreach($obj as $k=>$v){
		$obj->$k = igk_getv($data, $k, $v);
	}
	}
	return $obj;
}

///<summary>invoke a function of a StdClass</summary>
function igk_obj_call($obj, $callable, $params=null)
{
	$g = $obj->$callable;
	if (igk_is_callable($g)){
		if ($params )
			return call_user_func_array($g, $params);
		return $g();
	}
}

function igk_invoke_param($obj,$n, $k,$offset=1 ){

	if (igk_is_callable($n)){
		return call_user_func_array($n, array_slice($obj->clParam, $offset));
	}
	return call_user_func_array(array($n, $k), array_slice($obj->clParam, $offset));
}

function igk_create_func_callback($func, $param=null){
	// if (igk_is_closure($func)){
		// igk_wln("closure created");
		// igk_wln(igk_show_trace());
		// exit();
	// }
	return (object)array(IGK_OBJ_TYPE=>"_callback","clType"=>"func",  "clFunc"=>$func, "clParam"=>$param);
}

///<summary>used to create a evaluable expression callback</summary>
function igk_create_expression_callback($exp, $param=null){
	return (object)array(IGK_OBJ_TYPE=>"_callback","clType"=>"exp",  "clFunc"=>$exp, "clParam"=>$param);
}
function igk_create_node_callback($callable, $params=null){
	return (object)array(IGK_OBJ_TYPE=>"_callback","clType"=>"node",  "clFunc"=>$callable, "clParam"=>$params);
}
///<summary>invoke a callback object</summary>
///<param name="bind">object that will be the host </param>
///<param name="bind">object to bind</param>
///<param name="extra">extra information</param>
function igk_invoke_callback_obj($bind, $obj, $extra = null){
	if (is_callable($obj)){

		if ("Closure"==get_class($obj)){
			$fc = $obj->bindTo($bind);
			return call_user_func_array($fc, $extra ?? array());
		}
		igk_die(__FUNCTION__.": object is callable. Not allowed. ".get_class($obj));
	}
	switch($obj->clType){
		case "node":
			if (is_callable($obj->clFunc))
			{
				if (igk_is_closure($obj->clFunc)){
					$tab = array_merge(array(), (array)$obj->clParam, $extra!=null ? $extra : array());
					$fc = $obj->clFunc->bindTo($bind);
					return call_user_func_array($fc, $tab);
				}
				$tab = array($bind);
				$tab = array_merge($tab, (array)$obj->clParam, $extra!=null ? $extra : array());
				return call_user_func_array($obj->clFunc, $tab);
			}else{
				igk_ilog("/!\\ not a valid callable: ", __FUNCTION__);
				return false;
			}
			break;
		case "func":
			if (is_callable($obj->clFunc)){
				$tab = array_merge((array)$obj->clParam, $extra!=null ? $extra : array());
				//igk_wln("bind to ". $bind);

				if (igk_is_closure($obj->clFunc)){
					$fc = $obj->clFunc->bindTo($bind);
					return call_user_func_array($fc, $tab);
				}
				if ($bind){
					array_push($tab, $bind);
				}
				return call_user_func_array($obj->clFunc, $tab);//array_merge($obj->clParam, $extra || array()));
			}else{
				igk_ilog("/!\\ not a valid callable: ", __FUNCTION__);
				return false;
			}
		break;
		case "exp":
			//$invokeParam = "igk_invoke_param";//invoke param functions
			if ($obj->clParam)
			extract($obj->clParam);
			//extrac special argument function
			$fc_args = igk_getv($obj->clParam, "func:args");//{'func:args'};


			igk_set_env(IGK_LAST_EVAL_KEY, $obj->clFunc);
			$o= eval($obj->clFunc);
			igk_set_env(IGK_LAST_EVAL_KEY, null);
			return $o;
		break;
		case "file"://invoke for file
			if (class_exists("Closure"))
			{
				$ex = function () use ($bind, $obj){

					$this->_include_file_on_context($obj->clFile);
					$func = $obj->clFunc;
					ob_clean();
					if (isset($func))
						$func($bind,$obj);
					igk_exit();
				};
				$f = $ex->bindTo($obj->Ctrl,$obj->Ctrl);
				$f();
			}
			// include_once($obj->clFile);
			// $func = $obj->clFunc;
			// $func($bind,$obj);
			break;
		default:
			igk_debug_wln("failed to send ");
			return false;
	}

}



//call environment closure
function igk_call_env_closure($n){
	$fc = igk_getv(igk_get_env(IGK_ENV_CALLBACK_KEYS), $n);
	if ($fc){
		return call_user_func_array($fc, array_slice(func_get_args(), 1));
	}
	return null;	
}
//register environnement closure 
function igk_reg_env_closure($n, $closure){
	if (!is_object($closure) || get_class($closure)!="Closure")
		return 0;
	$key = IGK_ENV_CALLBACK_KEYS;
	$tab = igk_get_env($key, array());
	$tab[$n] = $closure;
	igk_set_env($key, $tab);
	return 1;
}

///<summary>register file that will be used as script</summary>
function igk_reg_action_script($name, $callback){
	igk_set_env("sys://actions/scripts/{$name}", $callback);
}
function igk_get_action_uri($name, $args){
	return igk_io_baseUri()."/@!actions/{$name}/".$args;
}
///<summary>register view action</summary>
function igk_view_reg_action($fname, $action, $callback){
	igk_set_env("sys://view/actions/".$fname."/".$action, $callback);
}

///<summary>handle view command action</summary>
function igk_view_handle_action($fname, $params, $redirectfailed=1){
	$action = igk_getv($params, 0);
	$fs = "sys://view/actions/".$fname;
	$fc = igk_get_env($fs."/".$action);
	$fc_result=null;
	if ($fc){
			igk_set_env("sys://view/current_action", $action);

			$ht = array_slice($params, 1);
			if (igk_count($ht)>0){
				$fc_result = call_user_func_array($fc, $ht);
			}
			else
				$fc_result = $fc();
			unset($ht);
	}
	return $fc_result;
	//include(IGK_LIB_DIR."/Inc/.igk.fc.call.inc");
}
///<summary>handle view command actions. </summary>
///<param name="arrayList">assoc array of callback. </summary>
function igk_view_handle_actions($viewname, $arrayList, $params, $exit=1){
	igk_set_env(__FUNCTION__, array("v"=>$viewname, "list"=>$arrayList, "args"=>$params));
	foreach($arrayList as $k=>$v){
		igk_view_reg_action($viewname, $k, $v);
	}
	$b = igk_view_handle_action($viewname, $params);
	igk_set_env(__FUNCTION__, null);
	if ($b && $exit){
		//resent params
		igk_get_current_base_ctrl()->regSystemVars(null);
		igk_exit();
	}
	return $b;
}

function igk_view_handle($action){
	$fname = igk_get_env("igk_view_handle_actions");
	if (!$fname)
		return;
	$fs = "sys://view/actions/".$fname["v"];
	$params = func_num_args()>1? array_slice(func_get_args(),1) :  $fname["args"];
	$fc = igk_get_env($fs."/".$action);

	$fc_result=null;
	if ($fc){
			$ht = array_slice($params, 1);
			igk_set_env("sys://view/current_action", $action);
			if (igk_count($ht)>0){
				$fc_result = call_user_func_array($fc, $ht);
			}
			else
				$fc_result = $fc();
			unset($ht);
	}
	return $fc_result;
}
function igk_view_handle_name(){
	return igk_get_env("sys://view/current_action");
}

function igk_get_config_action($name, $callback){
	$t = igk_get_env("sys://configs/options", array());
	$t[$name]=$callback;
	igk_get_env("sys://configs/options", array());
}


///<summary>dispatch message to a specific controller</summary>
function igk_dispatch_message($source, $c, $params){	
	$bck = array("sess_id"=>session_id(), "sess"=> $_SESSION);	
	session_write_close();
	$actionctrl = igk_getctrl(IGK_SYSACTION_CTRL);
	$uri = igk_io_baseUri()."/".$actionctrl->getUri("dispatchMessage");
	
	igk_wln(igk_curl_post_uri($uri, array(
	"ctrl"=>$c->getName(),
	"classname"=>get_class($c),
	"source"=>$source->getName(),
	"uri"=>"/".implode("/", $params)), 
	null,
	igk_get_platform_header_array()
	));

	//restore session
	if ($bck){
		session_id($bck["sess_id"]);
		session_start();
		$_SESSION = $bck["sess"];
	}	
}
function igk_android_ondoc_render($doc, $options){
	// igk_ilog("call meta ".__FUNCTION__ . " for : ".$options->Context . " ?android ".igk_agent_isAndroid());
	$v_isandroid =igk_agent_isAndroid();

	if ($options->Cache){
		//when caching init with javascript
		$js = igk_createNode("Script");
		$js->Content = "igk.android.init('width=device-width, initial-scale=1, user-scalable=no');";
		$m = new IGKHtmlSingleNodeViewer($js);
		$doc->body->add($m);

	}else{

		if ($options->Context == IGK_WEB_CONTEXT)
		{
			$sm = $doc->getMetas();
			if ($sm){
				if ($v_isandroid)
				{
			//igk_wln("add view");

					$meta = $sm->getMetaById("android:viewport");
					if ($meta==null){
							$meta =  igk_createNode("meta");
							$meta["name"]="viewport";
					}
					$meta["content"]="width=device-width, initial-scale=1, user-scalable=no";
					$sm->addMeta("android:viewport", $meta);
				}
				else{
					// igk_wln("remove view");
					$sm->rmMeta("android:viewport");
				}
			}
			else{
				igk_die("No meta defined for  [".$document."]");
			}
			if ($v_isandroid)
			{
				$doc->body["class"] = "+igk-android";
			}
			else{
				$doc->body["class"] = "-igk-android";

			}
		}
	}
	// igk_exit();
}


///<summary>create session start info</summary>
function igk_sys_create_session_start_info(){
	igk_ilog("create start session info");
	$t = igk_date_now();
	return array(
		"server"=>$_SERVER,
		"start-time"=>$t,
		"user-addr"=>igk_getv($_SERVER,"REMOTE_ADDR"),
		"user-agent"=>igk_getv($_SERVER,"HTTP_USER_AGENT"),
	);
}

function igk_sys_debug_components(){
	return igk_get_env("sys://debug/components");
}
function igk_sys_reg_debug_components($n,$callable){
	$g = igk_get_env("sys://debug/components") ;
	if ($g ==null)
			$g = array();
	$g[$n] = $callable;
	igk_get_env("sys://debug/components", $g);
}
///<summary>shortcut to invoke uri</summary>
function igk_sys_invoke_uri($uri=null){
	igk_app()->getControllerManager()->InvokeUri($uri);
}


///<summary>handle global system single action</summary>
function igk_sys_handle_action($name, $args){
	$b = igk_get_env("sys://env/actions");
	if (!$b)
		return false;
	$t = igk_getv($b, $name);
	if ($t){
		call_user_func_array($t, array_slice(func_get_args(), 1));
		return 1;
	}
	return false;
}
///<summary>register global system action</summary>
function igk_sys_reg_action($name, $callback){
	if (empty($name) || !is_callable($callback))
		return 0;
	$key = "sys://env/actions";
	$d = igk_get_env($key, array());
	$d[$name] = $callback;
	igk_set_env($key, $d);
	return 1;
}
///<summary>get if action registrated
function igk_sys_is_action($name){
	$key = "sys://env/actions";
	return ($t = igk_get_env($key)) && igk_getv($t, $name)!=null;
}

function igk_db_create_identifier($key,$user=null, $base=36, $length=3){
		$u = $user ?? igk_app()->Session->User;
		if ($u==null){
			$u = igk_get_system_user();
		}
		$ct = igk_getctrl(IGK_UCB_REF_CTRL);
		$number = intval($ct->get_ref_nextnumber($u->clId, $key));
		$c = intval(date("Ymd").$u->clId);
		$bill_ref = IGKNumber::ToBase($number,$base, $length);
		$ct->update_ref_nextnumber($u->clId, $key);


		$c = intval(date("Ymd").$u->clId);
		$format = IGKNumber::ToBase($c,36,8);
		$bill_ref = $format."-".IGKNumber::ToBase($number, 36,3);
		igk_set_env(__FUNCTION__."/number",$number); //passing the next number
		return $bill_ref;
}

function igk_cancel_last_ref_number(){
	$ct = igk_getctrl(IGK_UCB_REF_CTRL);
	$ct->cancel_last_ref_number();
}


function igk_db_drop_identifier($key){
	$ct = igk_getctrl(IGK_UCB_REF_CTRL);
	$ct->delete_key($key);
}

//-----------------------------------------------------------------------------------------
//SVG USE Function list
//-----------------------------------------------------------------------------------------

///<summary>register svg list document in directory</summary>
function igk_svg_register_icons($doc, $dir=IGK_LIB_DIR."/Data/R/svg/icons"){
	foreach(IGKIO::GetFiles($dir, "/\.svg$/i") as $k=>$v){		
		igk_svg_register($doc, igk_io_basenamewithoutext($v),  $v);
	}
}
///<summary>use svg image</summary>
function igk_svg_use($name, $context=null){
	$c  = igk_app()->Session->getParam(IGK_SVG_REGNODE_KEY);
	if ($c==null){
		//register default document
		
		
		igk_svg_register_icons(igk_app()->Doc);
		$c = igk_app()->Session->getParam(IGK_SVG_REGNODE_KEY) ?? igk_die("failed");	
		
		(function(){			
			$n = igk_createNode("div");
			igk_set_env("sys://node/svg_regnode", $n);
			return $n;
		})();
			// igk_die(array(
			// "code"=>0xEAF001,
			// "message"=>";-) sorry but you must first class igk_svg_register to register svg item to use"
			// ));
	}
	$n = igk_createNode("div");
	$n["class"]="igk-svg-lst-i"; //listview item
	$n["igk:svg-name"]=$name;
	$obj = $c->getParam("sys://svg/lists", function(){return array();});
	$obj[$name] = $context;
	$c->setParam("sys://svg/lists", $obj);

	$fc = "igk_svg_use_callback";
	if (!igk_get_env(__FUNCTION__)){
		//the firts added item must call igk_svg_use_callback on rendering if is ajx demand or bind to document
		$n->setCallback("AcceptRender", $fc);
		igk_set_env(__FUNCTION__, 1);
	}
	igk_set_env($fc, null);
	return $n;

}
function igk_svg_use_callback($o, $options=null){
	
	if (!igk_get_env(__FUNCTION__)){
		//render document once
		igk_svg_render_ajx($options);
		igk_set_env(__FUNCTION__, 1);
	}
	return 1;
}

///<summary>render svg list</summary>
function igk_svg_callable_list($n,$m){
	//on context normal deliver an remove all
	//g the list of stored file
	//TODO: indicate that file is already served or not on ajx context
		$c = $m->getParam("sys://svg/lists");
		$g = $m->getParam("file");
		if (!$c || igk_count($c)==0)
			return 0;

		$is_ajx= igk_is_ajx_demand();
		$o = "";
		if ($g){
				foreach($c as $k=>$gg)
				{
					$v=igk_getv($g,$k);
					if ($v===null){
						igk_ilog("svg : {$k} no found", __FUNCTION__);
						continue;
					}
					if (!file_exists($v)){
						$v = realpath(igk_io_baseDir()."/{$v}");
					}
					if (empty($v)){
						continue;
					}
					$o.="<".$k.">";
					$o .= igk_svg_content(igk_io_read_allfile($v));
					$o.="</".$k.">";
				}
				$n->addSingleNodeViewer("NoTagNode")->targetNode->Content =$o;
		}
		$m->setParam("sys://svg/lists",null);				
		return 1;
}
function igk_svg_render_ajx($o=null){
	$c  = igk_app()->Session->getParam(IGK_SVG_REGNODE_KEY);
	if (!$c)
		return;
	$obj = $c->getParam("sys://svg/lists");
	$tab = (array)$obj;

	 
	if (igk_count($tab)>0){

		igk_svg_callable_list($c, $c);
		if (igk_is_ajx_demand() || ($o==null)){
			//igk_wln(__FUNCTION__." render because object is null ?".($o==null));
			$c->RenderAJX();
		}else{
			//igk_ilog("append to body ");
			if ($o->Document){
				// igk_ilog("append to document");
				$o->Document->body->getAppendContent()->addSingleNodeViewer('NoTagNode')->targetNode->add($c);
				// igk_exit();
			}
			else
				$c->RenderAJX();		

		}
		$c->getParam("sys://svg/lists", null);
		igk_app()->Session->getParam(IGK_SVG_REGNODE_KEY,null);
	}else{
		//igk_ilog("failed to render svg list document",__FUNCTION__);
	}
	// return;


	// if ($node ){
		// if (igk_is_ajx_demand() || !$g){
			// if (($r === null) && ($doc!=null)){
				// // igk_wln("need to register");
				// // igk_wln($node->getParamKeys());
				// igk_svg_register_icons($doc);
				// igk_svg_callable_list($node, $node);
				// $node->RenderAJX();
				// $doc->body->setCallbackNode("svgregister",  $node);
				// return;
			// }
			// $node->RenderAJX();
			// $node->Clear();
		// }
		// else if ($r==null){

		    // $d = igk_html_node_CloneNode($node);
			// $g->body->setCallbackNode("svgregister",  $node);
			// $g->body->getAppendContent()->add($node);

			// //$g->body->setCallbackNode("svgregister",  null);
		// }
	// }
	// igk_app()->Session->setParam(IGK_SVG_REGNODE_KEY, null);
}

function igk_svg_content($s){
	$s = preg_replace("#\<\?(.)+\?\>\s*#i","",$s);//remove version declaration
	//$s = preg_replace("#\<\?(.)+\?\>#i","",$s);//remove comment declaration
	$s = preg_replace("#\<!DOCTYPE([^\>]+)\>\s*#i","",$s);//remove doctype declaration declaration
	 // igk_debug_wln($s);
	//TO AVOID EDGET 1500 warning detect and dynamicaly close self-closing tag
	//[a-z0-9_\-\.\,\=\"\' ]*
	$s = preg_replace_callback("#\<(?P<name>".IGK_XML_IDENTIFIER_RX.") (?P<attrib>([a-z0-9_\-\.\,\=\"\' :]*))/>#i",function($t){
		// igk_wln("match");
		//igk_debug_wln("match : ... ".$t["attrib"]."\n\n");
		return "<".$t["name"]. " ".$t["attrib"]."></".$t["name"].">";
		//igk_exit();
	}, $s);

	return $s;
}

function igk_svg_get_regicons(){
	
	$source = igk_app()->Session->getParam(IGK_SVG_REGNODE_KEY);
	if ($source)
		return $source->getParam("file");
	return null;
}

///<summary>register svg item</summary>
function igk_svg_register($doc, $name, $file){

	$b = $doc ? $doc->body : null;
	
	$_newfc = function(){
			$n = igk_createNode("div")
			->setClass("igk-svg-lst")->setStyle("display:none;");
			$n->addOnRenderCallback(igk_create_node_callback('igk_svg_callable_list', array($n)));
			return $n;
	};
		
		
	if (!$b){
		//if atomic
		
		if (igk_is_atomic()){
			$b = igk_get_env("sys://node/svg_regnode");
				if ($b==null){
					$b = $_newfc();
					igk_set_env("sys://node/svg_regnode", $b);
			}
				
			igk_app()->Session->setParam(IGK_SVG_REGNODE_KEY, $b);
			igk_svg_bindfile($name, $file);
			
			return $b;
		}
		return null;
	}
	
	//add a single node callback to bodynode. will be maintenain throw session
	$n = $doc->body->addNodeCallback("svgregister", function()use($_newfc){
		//if global session doesn't content the global svg item Session->getParam("sys://node/svg_register")
		// igk_wln($_newfc);
		$n = igk_app()->Session->getParam(IGK_SVG_REGNODE_KEY, $_newfc) ?? igk_die("can't create node");
		return igk_html_node_CloneNode($n);
	});

	
	igk_svg_bindfile($name, $file);
	return $n;
}
function igk_svg_bindfile($name, $file){	
	$source = igk_app()->Session->getParam(IGK_SVG_REGNODE_KEY);
	if ($source){
		$f = $source->getParam("file", function(){ return array();});	
		$f[$name]= igk_io_basePath($file);	
		$source->setParam("file", $f);		
	}
}

///<summary>temporise the data execution by the callback</summary>
///<param name="duration">time in second</summary>
function igk_get_live_data($ctrl, $name, $callback, $duration=10){
	//$ctrl->setParam("sys://liveddata",null);
	$t = $ctrl->getParam("sys://liveddata", array());
	$mt = igk_getv($t, $name);
	if (!$mt || ((time() - $mt->time)>$duration)){
		//igk_wln("create new ????".(time() - $mt->time) );
		$o = $callback();
		$mt=(object)array("time"=>time(),"data"=>$o);
		$t[$name] = $mt;
		$ctrl->setParam("sys://liveddata",$t);
	}else
		$o = $mt->data;

	return $o;
}

function igk_createCallbackNode(){
	return new IGKHtmlCallbackNode();
}


function igk_xml_type2str($t){
	$tab = array(
	IGKXMLNodeType::NONE => "NONE",
	IGKXMLNodeType::ELEMENT =>"Element",
	IGKXMLNodeType::PROCESSOR =>"PROCESSOR",
	IGKXMLNodeType::COMMENT =>"COMMENT",
	IGKXMLNodeType::ENDELEMENT =>"ENDELEMENT",
	IGKXMLNodeType::CDATA =>"CDATA",
	IGKXMLNodeType::TEXT =>"TEXT",
	IGKXMLNodeType::DOCTYPE =>"DOCTYPE"
	);
	if (isset($tab[$t]))
		return $tab[$t];

	return "UNKNOW";
}

///<summary>file reading object</summary>
function igk_xml_create_readinfo(& $inf){
	return igk_create_filterObject($inf,[
	"min"=>0,
	"max"=>10,
	"offset"=>0,
	"path"=>"root" ,//root node access
	"pathinfo"=>[], //object of path info
	"current"=>null,
	"start"=>0,
	"count"=>0, //to total read items
	"objects" =>[],
	"item"=>0,
	"bufferSize"=>4096
	]);
}

///<summary>xml reader info</summary>
function igk_xml_read($xreader){

	$eof=0;
	$v_c=0;
	$v_enter=0;
	$q = $xreader;
	$v="";
	$canread=null;
	$init = "::init";
	$xreader->attribs = null;
	if (!isset($xreader->$init)){


		if ($xreader->context=="stream")
		{
			//move file to target the offset
			fseek($xreader->text, $xreader->offset);
			$hfile = $xreader->text;
			$xreader->offset = 0;

			$canread=function()use(& $xreader, & $hfile, & $eof){
				if($eof )
					return 0;

				//igk_wln("ccan");
				//$buffsize=4096;
				$buffsize= $xreader->inf->bufferSize; // 4096;
				if($xreader->length==-1){
					//igk_wln("read 1");
					$b = @fread($hfile, $buffsize);
					// igk_wln("d ".$b);
					// igk_exit();
					if ($b){
						$xreader->length = strlen($b);
						$xreader->text=$b;
						return 1;
					}
					return 0;
				}else{
					if ($xreader->offset< $xreader->length)
						return 1;

					$b = fread($hfile, $buffsize);
					//igk_wln("read 2 > ".strlen($b) . " ".$xreader->length);
					$xreader->length += strlen($b);
					$xreader->text.=$b;
					return ($xreader->offset< $xreader->length);
				}
			};

		}else{
			if ($xreader->offset>= $xreader->length)
				return 0;
			$canread=function()use(& $xreader, & $eof){
				return !$eof && ($xreader->offset< $xreader->length);
			};
		}

		$readnext=function()use($q , & $canread){
		$readsub="";
		$ics = $q->offset;
		$q->offset++;
		$icx= $q->offset;
		$icc = 7;
		$ico = $icc;
		while($canread() && ($icc>0) && ($m = $q->text[$icx])){
			$icc--;
			$readsub .= $m;
			$icx++;
			$q->offset++;
		}
		$q->offset=$ics;
		return $readsub;
	};
	$readname=function()use(& $xreader, $canread){
		// igk_wln("read name");
		$v = IGK_STR_EMPTY;
		$s = "/".IGK_TAGNAME_CHAR_REGEX."/i";
		//check reaed cararacter
		while( $canread() && preg_match($s, $k = $xreader->text[$xreader->offset]))
		{
			$v .= $k;
			$xreader->offset++;
		}
		return $v;
	};
	$__readTextValue=function()use(& $xreader, $canread){
		// igk_wln("read text data");

		$q = $xreader;
		$v=IGK_STR_EMPTY;
		$p = $q->offset;
		while( $canread())
		{
			$v .= $q->text[$q->offset];
			$q->offset++;
			if (substr($v, -1, 1) == "<")
			{
				$v = substr($v, 0, strlen($v)-1);
				if (empty(trim($v))){
					$q->offset -=2;
					$q->name=null;
					$q->value=null;
					return false;
				}

				$q->offset--;
				$q->name = null;
				$q->value = $v;
				$q->nodetype = IGKXMLNodeType::TEXT;
				return true;
			}
		}

		$q->offset = $p;//restore
		return false;
	};

		$xreader->{"can:read"}=$canread;
		$xreader->{"can:readt"}=$__readTextValue;
		$xreader->{"can:readn"}=$readname;
		$xreader->{"can:readnx"}=$readnext;
		$xreader->$init=1;

	}else{
		$canread = $xreader->{"can:read"};
		$__readTextValue = $xreader->{"can:readt"};
		$readname = $xreader->{"can:readn"};
		$readnext = $xreader->{"can:readnx"};
	}

	$i = $xreader->offset;
	$xreader->context = "xml";
	$r = 0;
	while($r = $canread()){ //read char

			$c =$q->text[$q->offset];
			//igk_wln("dd: ".$c. " ".$v_enter);
			switch($c)
			{
			case "<":
				$v_enter = true;
			break;
			case "?": //preprocessor instruction
				if ($v_enter)
				{
						//reading process
						$q->offset++;
						$v =IGK_STR_EMPTY;
						while( $canread())
						{
							$v .= $q->text[$q->offset];
							$q->offset++;
							//end comment
							if (substr($v, -2, 2) == "?>")
							{
								$v = substr($v, 0, strlen($v)-3);

								$q->name = null;
								$q->value = $v;
								$q->nodetype = \IGKXMLNodeType::PROCESSOR;

								return true;
							}
						}

				}
				else{
					//not entered a prepropecessor instruction
					return $__readTextValue();
				}
				//igk_debug_wln("failed");
				return false;
			break;
			case "!":
				if ($v_enter)
				{
					$readsub = $readnext(2);
					//if (substr($q->text, $q->offset+1,2) == "--")
					if ($readsub=="--")
					{
						//reading comment
						$q->offset +=3;
						$v =IGK_STR_EMPTY;
						while( $canread())
						{
							$v .= $q->text[$q->offset];
							$q->offset++;
							//end comment
							if (substr($v, -3, 3) == "-->")
							{
								$v = substr($v, 0, strlen($v)-3);
								$q->name = null;
								$q->value = $v;
								$q->nodetype = \IGKXMLNodeType::COMMENT;
								return true;
							}
						}
					}
					else{
						$readsub = $readnext(7);
						if (strlen($readsub)==7){
							$readsub = strtoupper($readsub);

							switch($readsub){
								case "[CDATA[":
								$q->offset +=8;
								$v =IGK_STR_EMPTY;
								while( $canread())
								{
									$v .= $q->text[$q->offset];
									$q->offset++;
									//end comment
									if (substr($v, -3, 3) == "]]>")
									{
										$v = substr($v, 0, strlen($v)-3);
										$q->name = null;
										$q->value = $v;
										$q->nodetype = \IGKXMLNodeType::CDATA;
										return true;
									}
								}
								break;
								case "DOCTYPE":
								$q->offset +=8;
								$v =IGK_STR_EMPTY;
								while( $canread())
								{
									$v .= $q->text[$q->offset];
									$q->offset++;
									//end doctype
									if (substr($v, -1, 1) == ">")
									{
										$v = substr($v, 0, strlen($v)-1);
										$q->name = null;
										$q->value = $v;
										$q->nodetype = \IGKXMLNodeType::DOCTYPE;
										return true;
									}
								}
								break;
							}
						}
						// igk_wln("failed : ".$readsub);
						// igk_exit();
						return false;

						// if (strtoupper(substr($q->text, $q->offset+1,7)) == "[CDATA[")
						// {//reading CDATA
								// $q->offset +=8;
								// $v =IGK_STR_EMPTY;
								// while( $canread())
								// {
									// $v .= $q->text[$q->offset];
									// $q->offset++;
									// //end comment
									// if (substr($v, -3, 3) == "]]>")
									// {
										// $v = substr($v, 0, strlen($v)-3);
										// $q->name = null;
										// $q->value = $v;
										// $q->nodetype = \IGKXMLNodeType::CDATA;
										// return true;
									// }
								// }
						// }
						// else if (strtoupper(substr($q->text, $q->offset+1,7)) == "DOCTYPE")
						// {//reading DOC TYPE
								// $q->offset +=8;
								// $v =IGK_STR_EMPTY;
								// while( $canread())
								// {
									// $v .= $q->text[$q->offset];
									// $q->offset++;
									// //end doctype
									// if (substr($v, -1, 1) == ">")
									// {
										// $v = substr($v, 0, strlen($v)-1);
										// $q->name = null;
										// $q->value = $v;
										// $q->nodetype = \IGKXMLNodeType::DOCTYPE;
										// return true;
									// }
								// }
						// }

					}
					return false;
				}
			break;
			case "/": //end element
				if ($v_enter)
				{
					$q->offset+=1;
					$q->nodetype =  IGKXMLNodeType::ENDELEMENT;
					$q->name = $readname($q);//this->ReadName();
					$q->value= null;
					$v_enter = false;

					//read to end  >

					while(($v_c >$q->offset) && ( $q->text[$q->offset] !== '>')){
						$q->offset++;
					}
					// if($q->name == "igk:sectionTitle"){
						// igk_wln("eiikk ".$q->text[$q->offset]);
						// igk_exit();
					// }
					return true;
				}
				$v .= $c;
				break;
			default:	//read default case
				if (!$v_enter)
				{
					if ($q->nodetype ==  \IGKXMLNodeType::ELEMENT)
					{

						$match = array();
						switch(strtolower($q->name))
						{
							case "script":
							case "code":
							{//special script node
								$tag = strtolower($q->name);
								while( $canread())
								{
									$v .= $q->text[$q->offset];
									$q->offset++;

									if (preg_match("/\<\/([\s]*)".$tag."([\s]*)\>$/i",$v, $match))
									{
										$q->offset-= strlen($match[0]);
										$v = substr($v, 0, strlen($v)-strlen($match[0]));
										break;
									}
								}
								$q->name = null;
								$q->value = $v;
								$q->nodetype = \IGKXMLNodeType::TEXT;
								return true;
							}
							break;
							case "style":
							{//for style

								while( $canread())
								{
									$v .= $q->text[$q->offset];
									$q->offset++;

									if (preg_match("/(\<\/([\s]*)style([\s]*)>)$/i",$v, $match))
									{
										$q->offset-= strlen($match[0]);
										$v = substr($v, 0, strlen($v)-strlen($match[0]));
										break;
									}
								}
								$q->name = null;
								$q->value = $v;
								$q->nodetype = \IGKXMLNodeType::TEXT;
								return true;
							}
							break;
						default:
						{
						    //
							//DO: read text value
							//
							if ($__readTextValue()){
								return true;
							}
							continue;
						}
						break;
						}
					}
					else{
							//read text elements
							$v=IGK_STR_EMPTY;
							if ($q->nodetype == IGKXMLNodeType::ENDELEMENT)
								$q->offset++;
							while( $canread())
							{
								$v .= $q->text[$q->offset];
								$q->offset++;
								//e
								if (substr($v, -1, 1) == "<"){//detect start or end element
									$v = substr($v, 0, strlen($v)-1);

									if (empty(trim($v))){
										//
										$q->offset-=2;
										break;
									}

									$q->offset--;
									$q->name = null;
									$q->value = $v;
									$q->nodetype = \IGKXMLNodeType::TEXT;
									return true;
								}
							}
					}
				}
				else
				{//element requested

					$q->name = $readname();
					$q->value= null;
					$q->nodetype =  \IGKXMLNodeType::ELEMENT;
					$q->isEmpty = false;
					$q->hasAttrib = false;
					//get attribute
					$v_end = false;
					$v = IGK_STR_EMPTY;//for xml read attribute contains
					$v_readname =false;
					$v_readvalue=false;
					//$v_assoc = array();
					$v_attribname = null;
					$v_ch = null;//character
					$v_startattribvalue = false;
					$v_attribmatch =IGK_STR_EMPTY;
					$v_bracketstart = false; // for bracket reading ....
					$v_bracketch =""; //bracket char ... supported bracket [], (), {}
					$v_expressions = array();
						while( $canread())
						{
							$v_ch =  $q->text[$q->offset];

							$q->offset++;

							if (preg_match("/(\[)/",$v_ch))
							{
								if (!$v_startattribvalue)
								{
									$exp = $v_ch. igk_str_read_brank(
										$q->text, $q->offset,  ']', '['
									);
									//self::__readBracket($q->text,$q->offset,  '[', ']');
									$cout = igk_count($v_expressions);
									$v_expressions[] = $exp;
									$v .= "@igk:expression$cout=\"$cout\"";
									continue;
								}
							}
							$v .= $v_ch;

							if (preg_match("('|\")", $v_ch))
							{
								if ($v_startattribvalue )
								{
									if($v_attribmatch == $v_ch)
										$v_startattribvalue = false;
								}
								else{
									$v_startattribvalue = true;
									$v_attribmatch = $v_ch;//save the attrib value start match
								}
							}
							if ($v_startattribvalue)
								continue;
							if (substr($v, -2, 2) == "/>")
							{
								//empty element
								//$v = trim(substr($v,0, strlen($v)-2));
								$v = trim(substr($v,0, strlen($v)-2));
								$q->isEmpty = true;
								break;
							}
							else if (substr($v, -1, 1) == ">")
							{
								//$v = trim(substr($v,0, strlen($v)-1));
								$v = substr($v,0, strlen($v)-1);
								$q->isEmpty = false;
								break;
							}
							//for reading the name
							if ($v_readname ==false)
							{
								if (preg_match("/([\s])/",$v_ch))
								{
									$v_attribname=$v_ch;
									$v_readname = true;
									$v_readvalue = false;
								}
							}
							else{
								if (preg_match("/[\s]/", $v_ch))
									$v_attribname .= $v_ch;
								else{
									$v_readname = false;
									//$v_assoc[] = $v_attribname;
								}
							}
						}

						if (!empty($v))
						{
							//TOTASK:READATTRIBUTES
							//get all matching attributes
							$q->hasAttrib =true;
							$m = null;
							//def: "/(\w+)[\s]*=[\s]*(\"|')(?P<value>(([^\"']*(')?)+))(\"|')/"
							$machv = "(?P<value>";
							$machv .= "([\"](([^\"]*(')?(\"\")?)+)[\"])";
							$machv .= "|([\'](([^']*(\")?('')?)+)[\'])";
							$machv .= "|(([^\s]*)+)";
							$machv .= ")";

							//$acount = preg_match_all("/(\w+)[\s]*=[\s]*(".$machv.")/",$v, $m);
							$acount = preg_match_all("/(?P<name>(@?".IGK_TAGNAME_CHAR_REGEX."+))[\s]*=[\s]*(".$machv.")/i",$v, $m);
							$q->attribs = array();
							for($cc =0;$cc< $acount; $cc++)
							{
								$k =$m["name"][$cc];
								if (preg_match("/^@igk:expression/", $k))
								{
									$q->attribs[$k] = $v_expressions[IGKHtmlUtils::GetAttributeValue($m["value"][$cc], $q->context)];
								}
								else
									$q->attribs[$k] =IGKHtmlUtils::GetAttributeValue($m["value"][$cc], $q->context);
							}
						}
						return true;
				}
				break;

		}
		++$q->offset;
	}
	//$i++;
	//$xreader->offset +=$i;
	//igk_wln("finish : ". $xreader->offset );
	return $r;
}

///<summary>function to read xml content</summary>
///<param name='content'>xml string value</param>
///<param name='callback'>callback that will be call when read data</param>
///<param name='callback'>information used</param>
///<exemple>
/// $inf->path = path to rootnode
// $inf->objects list of all object on that root node populate
///</exempl>
function igk_xml_read_content($content, $callback, & $inf=null){
	$inf = igk_xml_create_readinfo($inf);
	$xreader = (object)[];//igk_createObj();
	$xreader->offset=$inf->offset;
	$xreader->text = $content;
	$xreader->length = strlen($content);
	$xreader->name = "";
	$xreader->value="";
	$xreader->type="";
	$xreader->parent=null;
	$xreader->context="xml";
	$xreader->inf = $inf;
	$xreader->attribs=null;
	$xreader->nodetype=0;
	while(igk_xml_read($xreader)){
		if (!$callback($xreader, $inf)){
			break;
		}
	}
	$inf->offset = $xreader->offset;
	igk_xml_unset_read_info($inf);

}

function igk_xml_unset_read_info(& $inf){
	if ($inf->count ===null){
		$inf->count = igk_count($inf->objects);
	}
	unset($inf->pathinfo);
	unset($inf->current);
}

///<summary>skiping reader</summary>
function igk_xml_read_skip($xreader){
	$q = $xreader;
	if ($q->nodetype == IGKXMLNodeType::ELEMENT)
		{
			if (!$q->isEmpty ){

				$n = strtolower($q->name);
				$depth = 0;
				$end = false;
				while(!$end && igk_xml_read($q))
				{
					switch($q->nodetype ){
						case IGKXMLNodeType::ELEMENT:
							if (!$q->isEmpty)
							{
								$depth++;
								// igk_wln("\n".$depth);
							}
							break;
						case IGKXMLNodeType::ENDELEMENT:
						// igk_wln("\n end ".$depth);
							if (($depth==0) && (strtolower($q->name) == $n))
							{
								$end =true;
							}
							else if ($depth>0)
								$depth--;
							break;
					}
				}
				return $end;
			}
		}
		return false;
}

function igk_xml_xpath_object_callback ($xreader, & $inf){
	if (!isset($inf->cmode)){
		$inf->cmode = 0;
	}
	$n = $xreader->name;
	//current object detect
	// current:
	// @parent : view parent
	// @name : name of the property
	// @o: object to store
	// @path: target path . not used



	switch($xreader->nodetype){
		case IGKXMLNodeType::ENDELEMENT:
			$t = array_shift($inf->pathinfo);
			// igk_wln(array_keys($inf->current));
			if ($inf->start && ($inf->path==$t)){
				$inf->start = 0; //reset reading object
				$inf->max--;
				$inf->current = null;
				if ($inf->max <0){
					return 0; //terminate reading
				}
			}
			else{
				//move to parent
				if ($inf->current){
					$inf->current = igk_getv($inf->current,'parent');
				}
			}
		break;
		case IGKXMLNodeType::ELEMENT:
// igk_wln($n);
// igk_wln($inf->cmode);
		array_unshift($inf->pathinfo, count($inf->pathinfo)==0? $n : $inf->pathinfo[0]."/{$n}");
		if ($inf->start ==0){
				if ($inf->pathinfo[0] == $inf->path){
					if ($inf->min > $inf->item){
						//igk_wln("\n".$xreader->offset);
						igk_xml_read_skip($xreader);
						$inf->item++;//skip object
						array_shift($inf->pathinfo);
						// igk_wln("skip ".$inf->path);
						//igk_wln("\n".$xreader->offset);
						// igk_wln($inf->min );
						return 1;
					}
					$inf->start=1;
					$o = igk_createObj($xreader->attribs);
					$inf->current = array("o"=>$o,
					"parent"=>null,
					"path"=>$inf->pathinfo[0],
					"name"=>$n
					);
					$inf->objects[] = $o;

				}
		}else{

			$o=null;
			if (igk_count($xreader->attribs) > 0)
			{
				$o = igk_createObj($xreader->attribs);
			}

			//igk_wln('-------------------5 :::: '.$inf->current["o"]);
			if ($inf->current['o']===null){
				$for =$inf->current['name'];
				$co = igk_createObj();
				$co->content = $inf->current["parent"]['o']->$for;
				$inf->current["parent"]['o']->$for=$co;
				$inf->current = array("o"=>$co, "parent"=>$inf->current["parent"], "name"=>$for);
				// exit;
			}
			$inf->current["o"]->$n = $o;
			$inf->current = array("o"=>$o, "parent"=>$inf->current);
			if ($xreader->isEmpty){
				array_shift($inf->pathinfo);
				$inf->current = $inf->current["parent"];
			}else{
				$inf->current["name"]=$n;
			}
		}
		break;
		case IGKXMLNodeType::TEXT:
		case IGKXMLNodeType::CDATA:
			if($inf->start && $xreader->value && $inf->current ){
				$c = $inf->current["name"];
				if (!empty($c)){
					$s =  $xreader->value;
					$ii = igk_getv($inf->current['parent']['o'], $c);
					// igk_wln("d:".$s);
					if (!isset($ii)){
						// igk_wln(1);
						$inf->current['parent']['o']->$c = $s;
					}else{
						if (is_object($ii)){
							$ii->content = $s;
							// igk_wln(2);
							$inf->current['parent']['o']->$c->content = $s;
							// igk_wln($ii);
							// exit;
						}
						else{
							if (is_string($ii)){
								// igk_wln(4);
								$inf->cmode = 4;
								$inf->current['parent']['o']->$c .= $s;
							}else{
								$inf->current['parent']['o']->$c->content =$s;
								// igk_wln(3);
							}
						}
					}
				}
			}

		break;

	}
	return 1;
}

///<summary>read xml object from file memory stream</summary>
function igk_xml_read_stream($f, $callback, $inf){

	if (!file_exists($f))
		return;

	if ($hf = fopen($f, "r")){

		$inf = igk_xml_create_readinfo($inf);
		$xreader = (object)[];//igk_createObj();
		$xreader->offset=$inf->offset;
		$xreader->text = $hf;
		$xreader->length = -1;
		$xreader->name = "";
		$xreader->value="";
		$xreader->type="";
		$xreader->parent=null;
		$xreader->context="stream";
		$xreader->nodetype=0;
		$xreader->inf = $inf;
		$xreader->attribs=null;
		while(igk_xml_read($xreader)){

			if (!$callback($xreader, $inf)){
				break;
			}
		}

		$inf->offset = $xreader->offset;
		if ($inf->count ===null){
			$inf->count = igk_count($inf->objects);
		}
		fclose($hf);

		igk_xml_unset_read_info($inf);
	}

}

///<summary>used to read tagname
function igk_xml_read_tagname($content, & $pos){
	//$ch = $content[$pos];
	$n = "";
	//$pos++;
	$ln = strlen($content);
	while( 
	($pos < $ln)&&
	($ch = $content[$pos]) && ($ch!=">") && ($ch != " ")){
		$n.=$ch;
		$pos++;
	}
	return $n;
}

function igk_xml_is_valid_name($n){
	return preg_match("/^[a-z_][a-z_0-9\-]*(:[a-z]+){0,1}$/i", $n);
}

function igk_xml_read_attribute($s, & $pos = 0, & $outstring=null, $securename=1){
	$ln = strlen($s);
	$m =0;
	$n ="";
	$v ="";
	$tab = array();
	while($pos< $ln){
		$ch = $s[$pos];
		switch($ch){
			case "=":
			if ($m==0){
				if (empty($n = trim($n))){
					throw new IGKInvalidXmlReadException('Not a valid attribute', $pos);
				}
				//start reading value
				$m=1; 	
				$v=$n;
				$n="";	
				$outstring.= " ".$v."=";
				if ($securename && !igk_xml_is_valid_name($v)){
					throw new IGKInvalidXmlReadException("[".$v.'] is not a valid xml\'s attribute name', $pos);
				}
				// igk_wln($v);
				
			}			
			break;
			case "'":
			case "\"":
				if ($m!=1 || !empty($n))
					throw new IGKInvalidXmlReadException('Not a valid attribute value', $pos);
				$n = igk_str_read_brank($s, $pos, $ch, $ch);
				$outstring .=$n; 
				$n = substr($n,1, strlen($n)-2);
				$tab[$v] = $n;
				$v= $n = "";
				$m=0;
			break;
			case " ":
			if ($m==1){
				if (!empty($n=trim($n))){
					//update name
					$tab[$v] = $n;
					$outstring .=$n; 
					$v = $n = "";
					$m=0;
					continue 2;
				}
				
			}
			$n.=$ch;
			break;
			case '>': //finish reading
				if($m==0)
					break 2;
			break;
			default:
				$n.=$ch;
			break;
		}
		$pos++;
	}
	if ($m==1){
		$tab[$v] = $n;
		$outstring .=$n; 
	}
	// igk_wln("mode : ".$m);
	return $tab;
}

function igk_xml_read_doctype($s, & $pos){
	$out = "";
	$brank = array();
	$depth = 0;
	$ln = strlen($s);
	while($pos<$ln){
		$ch = $s[$pos];
		
		switch($ch){
			case "[":
			case "(":
			$depth++;
			break;
			case "]":
			case ")":
			$depth--;
			break;
			case ">":
				if ($depth<=0)
					break 2;
				break;
		}
		$out.=$ch;
		$pos++;
	}
	return $out;
	
}

///<summary>used to read xml</summary>
///<param name="path">xpath object</param>
///<param name="callback">the callback(index) used to read valid data at index</param>
function igk_xml_read_xml($c, $path=null, & $inf=null, $callback=null){
	$inf = new StdClass();	
	$inf->ln = strlen($c);
	$inf->content = $c;
	$inf->offset=0;	
	$inf->out="";
	$path = igk_str_rm_start($path, "/");
	$inf->path = $path;
	$g = $path !=null ? explode("/", $path) : null;//gpath
	$o = "";
	$t  = "0";
	$m = 0;
	$depth = 0;
	$skip_depth=0;
	$item = 0;
	$start = 0;
	$pathlevel = count($g);
	
	while($inf->offset<$inf->ln){
		$ch = $inf->content[$inf->offset];
		switch($ch){
			case "<"://start
				$m=1;
			break;
			case "?":// <?
				if ($m==1){
					//read processor
					$gp = strpos($inf->content, "?>", $inf->offset+1);
					if ($gp== false){
						throw new IGKInvalidXmlReadException("?&gt; close not found");
					}
					$s = substr($inf->content, $inf->offset+1, $gp - $inf->offset-1);
					if ($skip_depth ==0)
						$o .="<?".$s."?>";
					$inf->offset += ($gp);
					$m=0;
				}
			break;
			case "/": //endtag
				if ($m==1){
					if ($depth==0){
						igk_wln(htmlentities($o));
						throw new IGKInvalidXmlReadException("No Root found");
					}
					$inf->offset++;
					$n = igk_xml_read_tagname($inf->content, $inf->offset);
					//igk_wln("end : ".$n. " skiip depth ".$skip_depth.  " ==== ".$depth);
					if ($skip_depth>0){
						$skip_depth--;
					}else{
						$o.="</".$n.">";					
					}
					$depth--;
					$m=0;
					// igk_wln("end :: :".$skip_depth);
				}
			break;
			case "!": //read command <!--			
				if ($m==1){
					if (substr($inf->content, $inf->offset+1, 2)=="--")
					{
						$inf->offset +=3;
						$gp = strpos($inf->content, "-->", $inf->offset);
						if ($gp==false){
							//read to end
							$s = substr($inf->content, $inf->offset+1);
							$inf->offset= $inf->ln;
						}else {
							$s = substr($inf->content, $inf->offset, $gp - $inf->offset);
							$inf->offset = $gp+2;
						}
						if ($skip_depth ==0)
						$o .="<!--".$s."-->";
						$m=0;	
					}
					else if (substr($inf->content, $inf->offset+1, 7)=="[CDATA["){
						$inf->offset +=8;
						$gp = strpos($inf->content, "]]>", $inf->offset);
						if ($gp==false){
							//read to endtag							
							$s = substr($inf->content, $inf->offset);
							$inf->offset= $inf->ln;
						}else {
							$s = substr($inf->content, $inf->offset, $gp - $inf->offset);
							$inf->offset = $gp+2;							
						}
						// igk_wln("cdaté : ".$s);
						// igk_wln("cdaté : = ".($inf->content[$inf->offset]));
						if ($skip_depth ==0)
						$o .="<![CDATA[".$s."]]>";
						$m=0;
						// igk_exit();
					}
					else if (substr($inf->content , $inf->offset+1, 8 )=="DOCTYPE "){
						$inf->offset +=8;
						igk_xml_read_doctype($inf->content, $inf->offset, $attr);
						
					}
					else{
						throw new IGKInvalidXmlReadException("&lt;! not a valid specification");
					}
					// igk_exit();
				}
			break;
			default:
				// igk_wln("default ::: ".$ch);
				// igk_wln("default ::: ".$m);
				if ($m==1){
					//read tag name
					$n = igk_xml_read_tagname($inf->content, $inf->offset);
					// $n = $ch;
					// $inf->offset++;
					
					// while( 
					// ($inf->offset < $inf->ln)&&
					// ($ch = $inf->content[$inf->offset]) && ($ch!=">") && ($ch != " ")){
						// $n.=$ch;
						// $inf->offset++;
					// }
					igk_assert_die($n ===null, "tagname is null");
					
					if (($skip_depth >0) || ($pathlevel>$depth) &&  ($g && ($g[$depth] != $n)))
					{
						$skip_depth++;
						// igk_wln($n);
						// igk_exit();
					}
					
				
					if (($skip_depth == 0) && (($pathlevel - 1) ==($depth))){
						
						if ($callback){
							if (!$start)
							{	
								if ($callback($item)){									
									$start=1;
								}else
									$skip_depth = 1;
							}else{
							
								// igk_wln("check");
								if (!$callback($item)){
									for($i = $depth-1; $i>= 0 ; $i--){
										$o.="</".$g[$i].">";
									}
									break 2;
								}
							
							}
						
						}
						$item++;	
					}
					//TODO: read attribute
					$empty = 0;
					// //(($gp = strpos($inf->content , "/>", $inf->offset))&&($empty=1)) || 
					// ($gp = strpos($inf->content , ">", $inf->offset));
					
					
					// if ($gp===false){
						// throw new IGKInvalidXmlReadException ("tag declaration error", $inf->offset);
					// }
					// $empty = ($inf->content[$gp-1] == "/");
					// if ($empty)
						// $gp--;
					// $attr = substr($inf->content, $inf->offset, $gp - $inf->offset);
					// igk_wln( $gp - $inf->offset-1);
					// igk_wln("attr:  ".htmlentities($attr));
					// igk_wln("is empty ? ".$empty);
					// igk_wln("empty ::: ".$empty);
					$attr="";
					igk_xml_read_attribute($inf->content, $inf->offset , $attr);
					$empty = ($inf->content[$inf->offset-1] == "/");
					// igk_wln("is empty ".$empty);
					// igk_wln($attr);
					// igk_exit();
				
					
					$gap =0;
					if ($skip_depth>0){
						if ($empty){
							$skip_depth--;							
						}
						else {
							$depth++;
							//$skip_depth++;
							$gap=0;
						}		
					}else{
						$o.="<".$n;	
						$o.= $attr;
						if ($empty){
							$o.="/>";						
						}
						else {
							$o.=">";
							$depth++;
							$gap=0;
						}					
					}
					// igk_wln("Depth for :{$n} ".$depth);
					//$inf->offset = $gp + $gap;
					//igk_wln("next char ".($inf->content[$inf->offset]). " gap ".$gap);
					$m=0;
				}else{
					//igk_wln('read text '.$m);
					$ggg = strpos($inf->content, "<", $inf->offset);
					if ($ggg!==false){
						// igk_wln($g);
						$s = trim(substr($inf->content, $inf->offset, $ggg - $inf->offset));
						if ($skip_depth==0){
							$o.=$s;
						}
						$inf->offset = $ggg-1;
						
					}
					
				}
			break;
		}
		$inf->offset++;
		
	}
	
	
//	igk_wln("done");
	// igk_wln($inf->offset);
	$inf->out = $o;
	return $inf->out;
}


///end. file reading object
function igk_xslt_transform($xml, $xslt){	
	$dom = new DOMDocument();
	$dom->loadXML($xml);		
	$xsl = new DOMDocument();
	$xsl->loadXML($xslt);		
	$proc = new XSLTProcessor();
	$proc->importStyleSheet($xsl);		
	return $proc->transformToXML($dom);
}

///<summary>drop application table from system config</summary>
function igk_db_drop_ctrl_db($ctrl, $tb=null,  $fc=null){
		//$this->User = null;
		//igk_wln($this->Db->select(IGK_TB_USERS, array("clLogin"=>"bondje.doue@igkdev.com"))->getRowAtIndex(0));
		//$this->User = null;// $this->Db->select(IGK_TB_USERS, array("clLogin"=>"bondje.doue@igkdev.com"))->getRowAtIndex(0);
		$s = igk_is_conf_connected() || igk_sys_isuser_authorize(igk_user(), $ctrl->Name.":".$fc);
		if (!$s){
			//igk_html_wln_log("Error", "User Not allowed to ".__FUNCTION__);
			if (igk_app_is_uri_demand($ctrl, $fc)){
				igk_navto($ctrl->getAppUri());
			}
			return;
		}


		if(!igk_getv($ctrl->getConfigs(), "clDataSchema"))
		{
				$db = igk_get_data_adapter($ctrl, true);

				if ($db && $db->connect()){
					$db->dropTable($ctrl->getDataTableName());
					$db->close();
			}

		}
		else{
				//$tb = $ctrl->loadDataFromSchemas();

				$db = igk_get_data_adapter($ctrl, true);
				if ($db){
					if ($db->connect()){
						// igk_wln("connect...=".$db->getDbName());
						// igk_db_dump_result($db->sendQuery('SELECT DATABASE()'));
						//$db->selectdb($this->App->Configs->db_name);
						$v_tblist = array();
						foreach($tb as $k=>$v)
						{
							$v_tblist [$k]=$k;
						}
						//igk_wln("drop table ".$k);
						//igk_html_wln_log("DropTableList",
						$db->dropTable($v_tblist);
						$db->close();

				}
				}
		}

		if (igk_app_is_uri_demand($ctrl, "dropdb")){
			igk_navto($ctrl->getAppUri());
		}

	}

function igk_db_create_ref($ctrl, $model=null, $base=36, $length=4){
	return igk_getctrl(IGK_CB_REF_CTRL)->get_ref($ctrl, $model, $base, $length);
}
///<summary>call update of the reference obj</summary>
function igk_db_ref_update(& $ref){

	// $fc = $ref->update;
					// if (is_callable($fc))
						// $fc();
	return igk_obj_call($ref, "update");
}
///<summary>get gloval config properties</summary>
function igk_db_get_config($n, $default=null, $comment=null, $init=0){
	return igk_getctrl(IGK_BDCONFIGS_CTRL)->getConfigv($n, $default, $comment, $init);
	//return $default;
}
///<summary>register configuration properties</summary>
function igk_db_get_configp($ctrl, $n, $default=null){
	return igk_db_get_config(strtolower($ctrl->getName())."://".$n, $default);
}
///<summary>get registered user configuration </summary>
function igk_db_get_configup($ctrl, $u, $n, $default=null, $comment=null, $init=0){
	return igk_db_get_config(strtolower($ctrl->getName())."://".$u->clLogin."/".$n, $default,$comment, $init);
}
function igk_db_set_configup($ctrl, $u, $n, $value){
	$key = strtolower($ctrl->getName())."://".$u->clLogin."/".$n;
	return igk_getctrl(IGK_BDCONFIGS_CTRL)->setConfigv($key, $value);
}

///<summary>handle system command</summary>
function igk_io_handle_system_command($uri){
	$rx = "#^(".igk_io_baseUri().")?\/!@(?P<type>".IGK_IDENTIFIER_RX.")\/\/(?P<ctrl>".IGK_FQN_NS_RX.")\/(?P<function>".IGK_IDENTIFIER_RX.")(\/(?P<args>(.)*))?$#i";
	$c = preg_match_all($rx, $uri, $ctab);
	if ($c>0){

	// igk_wln($ctab["ctrl"][0]);
	// igk_exit();

		igk_getctrl(IGK_SYSACTION_CTRL)->invokePageAction(
		$ctab["type"][0],
		$ctab["ctrl"][0],
		$ctab["function"][0],
		$ctab["args"][0]
		);
		return true;
	}
	return false;
}
///<summary> handle redirection uri</summary>
function igk_io_handle_redirection_uri($actionctrl, $uri, $params=null, $redirection=0, $render=1){
	$app = igk_app();
	if ($actionctrl  && ($e = $actionctrl->matche($uri)))
	{
		$e->requestparams = $params;
		//$e->ctrl = "hsot";
		$app->Session->RedirectionContext = $redirection;
		try{
			$actionctrl->invokeUriPattern($e, $render);
		}catch(Exception $e){
			igk_show_exception($e);
			igk_exit();
		}
		return true;
	}
	return false;
}
function igk_io_invoke_uri($uri, $render=1){
	//uri must be full local uri. on the same domain
	$v_buri = igk_io_baseUri();
	$s = strstr($uri, $v_buri);
	// igk_wln("ssss : ".$s);
	if (!$s)
		return false;

	$c = igk_sys_get_subdomain_ctrl($uri);
	$app = igk_app();
	
	$v_ruri = igk_str_rm_start(substr($uri, strlen($v_buri)), "/");
	$tab = explode('?',$v_ruri);
	$p = igk_getv($tab, 0);
	$params = igk_getv($tab, 1);
	$page = "/".$p;

	// igk_debug_wln("handle subdomain ? ".__FUNCTION__);
	$actionctrl = igk_getctrl(IGK_SYSACTION_CTRL);
	igk_set_env("sys://io_invoke_uri",1);
	igk_set_env("sys://no_render",!$render);

	if ($c!==false){
			// igk_wln("handle subdomain ? ".$c);
			$k = "sys://env/state/subdomain";
			igk_push_env($k, $c);
			//primitive actions
			$k = IGK_REG_ACTION_METH ;
			$pattern = igk_sys_ac_getpattern($k);

			$e = new IGKSystemUriActionPatternInfo( array(
					"action"=>$k,
					"value"=>$c->getRegInvokeUri(),
					"pattern"=>$pattern,
					"uri"=> $page,
					"keys"=> igk_str_get_pattern_keys($k),
					"ctrl"=>$c,
					"requestparams"=>$params));

			if ($actionctrl && ($c!== $actionctrl)){
					// $app->Session->RedirectionContext = 1;
					// //invoke uri
					// //$app->getControllerManager()->InvokeUri($uri);	//handle global pattern
					if (!$c->NoGlobalAction && ($ce = $actionctrl->matche_global($page))){
						// igk_wln("handle .".$page);
						try{
							$ce->ctrl = null;//$actionctrl;
							$actionctrl->invokeUriPattern($ce);
						}catch(Exception $e){
							igk_show_exception($e);
							igk_exit();
						}
					}
					else{
						$actionctrl->invokeCtrlUriPattern($c, $e, false);
					}

			}
			igk_pop_env($k);
	}else{
		// igk_ilog("can't invoke : " . $uri);
		$app->getControllerManager()->InvokeUri($uri);

		// igk_ilog("primitive required");
		if (!igk_io_handle_redirection_uri($actionctrl, $page, $params, 1, $render)) //&& ($e = $actionctrl->matche($page)))
		{
			// igk_ilog("matched primitive required");
			// unset($e->ctrl);
			// igk_ilog(igk_ob_get(array_keys((array)$e)));
			// igk_ilog(igk_ob_get($e));

			// $e->requestparams = $params;
			// $app->Session->RedirectionContext = 1;
			// try{
				// $actionctrl->invokeUriPattern($e, $render);
			// }catch(Exception $e){
				// igk_show_exception($e);
				// igk_exit();
			// }

		// }
		// else{
			//handle in default controller
			$defctrl = igk_get_defaultwebpagectrl();
			//igk_wln("def ".$defctrl . " ".method_exists($defctrl, "is_handle_uri"). " {$page}");
			if ($defctrl && method_exists($defctrl, "handle_redirection_uri")){
					// igk_wln("handle uri ??? ");
				$defctrl->handle_redirection_uri($page);//"/".igk_io_baseRequestUri());
			}
		}

	}
	igk_set_env("sys://no_render",null);
	igk_set_env("sys://io_invoke_uri",0);

}


function igk_sys_reg_referencedir($src, $dir){
	$ttab = igk_get_env( IGK_ENV_COMPONENT_REFDIRS_KEY, function(){return array(); });
	if (file_exists($src))
		$ttab[realpath($src)]=$dir;
	igk_set_env( IGK_ENV_COMPONENT_REFDIRS_KEY, $ttab);
}
function igk_sys_get_referencedir($file){
	return igk_getv(igk_get_env(IGK_ENV_COMPONENT_REFDIRS_KEY), realpath($file));
}
///<summary>register component display name</summary>
function igk_sys_reg_componentname ($tab){
	//enviroment expression
	$ttab = igk_get_env( IGK_ENV_COMPONENT_DISPLAY_NAMES_KEY, function(){return array(); });

	if (igk_count($ttab)== 0){
		if (file_exists(IGK_COMPONENT_NAMESFILE)){
			$f = function(& $htab){
				include(IGK_COMPONENT_NAMESFILE);
			};
			$f($ttab);
		}
	}

	foreach($tab as $k=>$v){
		$ttab[strtolower($k)] = $v;
	}
	igk_set_env( IGK_ENV_COMPONENT_DISPLAY_NAMES_KEY, $ttab);

}
///<summary>get index file basename</summary>
function igk_get_index($dir, $default='index.php'){	
	$dab = igk_io_getfiles($dir, "/\\\index\.(php|phtml|html|htm)$/", false);
	return basename(igk_getv($dab, 0, $default));
}
function igk_get_web_content($uri){
	igk_die("not implement ", __FUNCTION__);
}
function igk_db_get_schema_filename($ctrl){
	return $ctrl->getDataDir()."/".IGK_SCHEMA_FILENAME;
}
function igk_db_is_typelength($t){
	return preg_match("/(int|varchar)/i", strtolower($t));
}
function igk_db_get_table_name($name){
	$v = "/^%prefix%/i";
	if (preg_match($v, $name)){
		$p = igk_db_get_config("sys://db/prefix", IGK_DEFAULT_DB_PREFIX);
		$name = preg_replace($v, $p, $name);
	}
	return $name;

}
///<summary>used to filter object for table info</summary>
function igk_db_get_select_entry($obj , $einfo){
	$t = array();
	$i = (array)$obj;
	$kt= IGK_FD_NAME;
	foreach($einfo as $k=>$v){

		$n = $v->$kt;
		if (isset($i[$n])){

			$t[$n] = $i[$n];
		}
	}
	return $t;
}

//<summary>inset a user group. </summary>
function igk_db_register_group($name){
	$cgctrl = igk_db_getdatatable_owner(IGK_TB_GROUPS);
	if ($cgctrl)
	igk_db_insert_if_not_exists($cgctrl , IGK_TB_GROUPS, array(IGK_FD_NAME=>$name));
}

function igk_db_register_auth($name, $cgctrl=null){
	$cgctrl = $cgctrl ?? igk_db_getdatatable_owner(IGK_TB_AUTHORISATIONS);
	if ($cgctrl)
	igk_db_insert_if_not_exists($cgctrl , IGK_TB_AUTHORISATIONS, array(IGK_FD_NAME=>$name));
}

function igk_db_init_groups($groups){
	foreach($groups as $k=>$v){
		igk_db_register_group($v);
	}
}
///invoke to init system auto
function igk_db_init_auths($auths){
	$c = igk_db_getdatatable_owner(IGK_TB_AUTHORISATIONS);
	foreach($auths as $k=>$v){
		igk_db_register_auth($v, $c);
	}
}
///<summary>grant system authorisation</summary>
///<exemple>igk_db_grant('sys://drop', 'root')</exemple>
function igk_db_grant($authname, $groupname, $access=1, $ctrl=null){
	$auth = igk_db_table_select_row(IGK_TB_AUTHORISATIONS, array(IGK_FD_NAME=>$authname));
	$group = igk_db_table_select_row(IGK_TB_GROUPS, array(IGK_FD_NAME=>$groupname));
	$ctrl= $ctrl ?? igk_db_getdatatable_owner(IGK_TB_GROUPAUTHS);
	if ($auth && $group)
		return igk_db_insert_if_not_exists($ctrl, IGK_TB_GROUPAUTHS, array(IGK_FD_AUTH_ID=>$auth->clId, IGK_FD_GROUP_ID=>$group->clId, "clGrant"=>$access));
	return 0;
}

///<summary>get system user groups</summary>
///<param name="u">mixed id or user object</param>
function igk_db_user_groups($u){
	$cgctrl = igk_db_getdatatable_owner(IGK_TB_USERGROUPS);
	$id = $u;
	if (is_object($u))
		$id = $u->clId;
	$r =  igk_db_table_select_where(IGK_TB_USERGROUPS, array("clUser_Id"=>$id));
	$g =  igk_db_table_select_where(IGK_TB_GROUPS);
	$o = array();
	// igk_wln($g);
	foreach($r->Rows as $k=>$v){
		$o[$v->clGroup_Id]= $g->Rows[$v->clGroup_Id]->clName;
	}
	return $o;
}
///<summary></summary>
function igk_db_is_user_authorized($s, $actionName,
	$authTable= IGK_TB_AUTHORISATIONS,
	$userGroupTable=IGK_TB_USERGROUPS,
	$userGroupAuthTable=IGK_TB_GROUPAUTHS){
	//$s : user object
	//get auth
	if (!is_object($s) || empty($actionName))
		return 0;

	$r = igk_db_table_select_row($authTable,  array(IGK_FD_NAME=>$actionName));
	$v_r = false;
	// igk_wln($actionName);
	// igk_wln($r);
	if ($r)
	{
		//get authorization id
		$v_authid = $r->clId;
		//find group that user is member of
		$v_usergroup =igk_db_table_select_where($userGroupTable, array(IGK_FD_USER_ID=> $s->clId));

		if ($v_usergroup->RowCount<=0)
			return false;
		//$v_r = true;
		foreach ($v_usergroup->Rows as  $item )
		{
			$q = igk_db_table_select_where($userGroupAuthTable, array(IGK_FD_GROUP_ID=>$item->clGroup_Id,
			IGK_FD_AUTH_ID=> $v_authid));

			//igk_wln("q ".$q->RowCount );
			// igk_wln($q);

			if (!$v_r && $q && ($q->RowCount == 1)){
				//igk_wln("checking ");
				$v_r = (!$v_r && ($q->getRowAtIndex(0)->clGrant== 1)) ? 0: 1;
				if ($v_r)
					break;
				//igk_wln("checking ".$v_r);
			}else{
				$v_r=1;
				break;
			}
		}
		return !$v_r;
	}
	else{

		$p = (object)array();
		$p->clName = $actionName;
		$ctrl = igk_db_getdatatable_owner($authTable);
		if ($ctrl)
		igk_db_insert($ctrl, $authTable, $p);
	}
	return $v_r;
}


function igk_db_store_cookie($identifier, $name, $date=null){
	$ctrl = igk_db_getdatatable_owner(IGK_TB_COOKIESTORE);
	return igk_db_insert_if_not_exists($ctrl, IGK_TB_COOKIESTORE, array("clIdentifier"=>$identifier,"clName"=>$name, "clDateTime"=>$date));
}
function igk_db_update_cookie($identifier, $name, $date=null){
	$ctrl = igk_db_getdatatable_owner(IGK_TB_COOKIESTORE);
	igk_db_update($ctrl, IGK_TB_COOKIESTORE, array("clIdentifier"=>$identifier,"clName"=>$name, "clDateTime"=>$date));
}
function igk_db_delete_cookie($r){
	$ctrl = igk_db_getdatatable_owner(IGK_TB_COOKIESTORE);
	return igk_db_delete($ctrl, IGK_TB_COOKIESTORE, is_object($r) ? $r->clId : $r);
}


///<summary>init user global info setting</summary>
function igk_init_user_info(){
	igk_user_set_info("TOKENID", "", "(.)+", 1,1);
}

//--------------------------------------------------------------------------------------------------------
//test functions
//--------------------------------------------------------------------------------------------------------
function igk_utest_wln($wln){
	if (defined("IGK_UTEST")){
		igk_wln($wln);
	}
	igk_push_env('utest://message', $wln);
}

///<summary>unserialize internal data</summary>
//-data base exemple:  "v:balafon default;r:15;" ==> object(v=>balafon default, r=>15)
function igk_unseri_data($data){
	$nobj = (object)array();
	$ln = strlen($data);
	$lnf = "\n";
	$pos = 0;
	while($pos<$ln){
		$g = strpos($data, ':', $pos);
		if ($g===false)
			break;	
		$v ="";
		$n = trim(substr($data, $pos, $g-$pos));
		$pos = $g+1;
		
		while(($pos<$ln-1) && ($data[$pos]==' '))
			$pos++;
		
		if ($data[$pos]=='"'){
			//read_
			
			$v  = igk_str_read_brank($data, $pos,'"','"');			
			
		}else{
		
		$g = strpos($data, ';', $pos);
		if ($g===false)
			$v = trim(substr($data, $pos));
		else 
			$v = trim(substr($data, $pos, $g-$pos));
		
		
		}
		
		$nobj->$n = $v;	
		
		$pos = $g+1;
	}
	
	return $nobj;
}

//WIDGET MANAGEMENT ZONE
///<summary>from wordpress template edition</summary>
function igk_invoke_widget_zone($name, $args=null){
	
}
///<summary>register a widget zone</summary>
function igk_reg_widget_zone($name, $args){
	
}


//+--------------------------------------------------------------------------------------------------------
// SUMMARY: INTERFACES DEFINITION
//--------------------------------------------------------------------------------------------------------
interface IIGKAppModuleListener{
	function getTable($n);
	function getBaseUri();
	function getConfigs();
}

interface IIGKParamHostService{
	//get the param
	function getParam($name, $default=null);
	//set the parameter value
	function setParam($name, $value);
	//return the current parameter keys
	function getParamKeys();
	//reset param list
	function resetParam();
}
interface IIGKControllerInitListener{
	function addSource($name, $source);
	function addDir($name);
}
interface IIGKMailAttachmentContainer{
	function attachContent($content, $type="text/plain", $cid=null);
	function attachFile($file, $type="text/plain", $cid=null);
}
interface IIGKCssCtrlHost{
	function getIsCssActive($doc=null);
	function bindCss();
}

interface IIGKUriActionRegistrableController{
	//registration uri key
	function getRegUriAction();
	//basic uri parttern
	function getBasicUriPattern();
	///<summary>registrated invocation uri </summary>
	function getRegInvokeUri();
}
interface IIGKFrameController{
	function ContainFrame($id,$frame, $remove=true);
}

interface IIGKDataTable{//basic interface

}
interface IIGKSystemUser
{
	function getLogin();
}
interface IIGKConfigController
{
	function showConfig();
}
interface IIGKWebController extends IIGKController
{
	//return an array of childs controller
	function getChilds(); //get childs
	function regChildController($ctrl);//reg child controller
	function unregChildController($ctrl);//unreg child controller
}
interface IIGKWebPageController extends IIGKWebController
{
	// function getheaderNode();
	// function getbodyNode();
	// function getfooterNode();
	function loadWebTheme($file);//load web structure
	function manageErrorUriRequest($uri);//manage error request
}
interface IIGKWebPageChildCtrontroller{
	function getWebParentCtrl();

}

interface IIGKWebAdministrativeCtrl
{
	function getConfigNode();
}

interface IIGKHtmlLoadContent
{
	function LoadView($ctr, $article);
	function LoadExpression($data, $context = null);
	function LoadFile($file);
}

interface IIGKHtmlGetValue
{
	function getValue($options=null);
}
///<summary>use to indicate that an element can store a cookie to client size</summary>
interface IIGKHtmlCookieItem{
	function getCookieId();
	function setCookieId($v);

}

///<summary>db manager interface</summary>
interface IIGKdbManager
{
	function connect();
	function dropTable($tableName);
	function close($leaveopen=false);
}
interface IIGKQueryConditionalExpression extends IIGKHtmlGetValue
{
	//add an expression
	function add($expression, $operator="AND");
	//remove an expression
	function remove($expression);
	//get number of expression
	function getCount();
}
///<summary> represent </summary>
interface IIGKQueryResult{//represent a queryr result....

}
///<summary>notification message</summary>
interface IIGKNotifyMessage
{
	function addMsg($message);
	function addMsgr($keymessage);
	function addSuccess($message);
	function addSuccessr($keymessage);
	function addError($message);
	function addErrorr($keymessage);
	function addWarning($message);
	function addWarningr($keymessage);
	function addInfo($message);
	function addInfor($keymessage);
}


interface IIGKCtrlDirManagement{
	function getStyleDir();
	function getDataDir();
	function getViewDir();
	function getDeclaredDir();
	function getName();
}
interface IIGKController{


	//get the name of the controller
	function getName();
	//init de data menu
	function initMenu();
	//view method that will be call to render the view of this controller
	function View();
	//primary target node
	function getTargetNode();
	function getTargetNodeId();
}
interface IIGKDataController extends IIGKController
{
	//init the data base model
	//function initDb();
	function getDataTableName();
	///<summary>return primary data table info or mixed array of table info
	function getDataTableInfo();
	//return the primary data table info
	function getDataAdapterName();
}

interface IIGKUserController{
	function connect();
	function signup();
}

interface IIGKHtmlComponent{
	function getController();
	function getComponentUri($uri);
	function getComponentId();
}
interface IIGKHtmlUriItem{
	function getUri();
	function setUri($v);
}



///+-------------------------------------------------------------------------------------------------------
/// SUMMARY: CLASS DEFINITION
///-------------------------------------------------------------------------------------------------------

///<summary>Represent the base IGK object class </summary>
class IGKObject
{
	//private $m_cmpObj;
	// function __destruct() {
		// dispose the object
		// $this->Dispose();
	// }
	protected function getCmpObj(){ ///get object osed to compare

	}

	///<sumary>used to dispose and release element</summary>
	public function Dispose(){	//base igkobject dispose
	}
	public function CompareTo($obj)
	{
		$g = $this->getCmpObj();
		$s = $obj->getCmpObj();
		//$this->m_cmpObj = igk_new_id();
		$r = ($g == $s); //($this->m_cmpObj == $obj->m_cmpObj);
		//$this->m_cmpObj = null;
		return $r;
	}

	///<summary>override this method to filter call of global method
	//used to call internal function (protected)
	///<summary>
	public function Invoke($method, $args=null)
	{
		if (method_exists($this, $method))
		{
			if (($args == null) || (is_array($args )))
			{
				return $this->$method($args);
			}
			else{

				$r =  call_user_func_array(array($this, $method), is_array($args) ? $args :  array($args));
				return $r;
			}
		}
		return null;
	}

	protected function _setIn($name, & $value){//base set object
		if (method_exists($this, "set".$name) )
		{
			call_user_func(array($this, "set".$name), $value);
			return true;
		}
		return false;
	}
	public function __set($name,$value){//set for igk object
		$this->_setIn($name, $value);
	}

	public function __get($key)
	{
		if (method_exists($this, "get".$key) )
		{
			return call_user_func(array($this, "get".$key), array_slice(func_get_args(),1));
		}
		return null;
	}
	public function __toString(){
		return get_class($this);
	}
	public function regEvent($name, $value)
	{
		//add event
		if (AppString::IndexOf($name, IGK_ADD_PREFIX) == 0)
		{
			$event = substr($name,3)."Event";
			if ($this->ContainVars($event))
			{
				if ($this->$event == null)
				{
					$this->$event = new IGKEvents($this, $event);
				}
				$this->$event->add($value[0],$value[1]);
				return true;
			}
		}
		//remove event
		if (AppString::IndexOf($name, "remove") == 0)
		{
			$event = substr($name,6)."Event";
			if ($this->ContainVars($event))
			{
				if ($this->$event != null)
				{
				$this->$event->remove($value[0],$value[1]);
				}
				return true;
			}
		}
	}

	public function callEvent($event, $method){
		if (($event!=null) && ($event->Owner==$this))
		{
			$this->$method();
		}
	}
}


final class IGKObjectStrict{
	private $m_ins;
	private function __construct(){

	}
	public function __call($n, $params){
		return null;
	}
	public function __set($key, $value){
		if (!isset($this->m_ins, $key))
			igk_die("setting of $key is not allowed");
		$this->m_ins[$key ] = $value;
	}
	public function __get($key){
		return igk_getv($this->m_ins, $key);
	}
	public static function Create($arraykey){
		if (is_array($arraykey) && igk_count($arraykey)>0){

		$m = array();
		foreach($arraykey as $n){
			if (is_string($n))
				$m[$n] = null;
		}

		if (igk_count($m)>0){
			$g = new IGKObjectStrict();

			$g->m_ins = $m;
			return $g;
		}
		}
		return null;
	}
}


final class IGKNSValue implements IIGKHtmlGetValue{
	private $m_ns;//namespace
	private $m_n;//node
	public function __construct($n, $ns){
		$this->m_ns=$ns;
		$this->m_n = $n;
	}
	public function getValue($options=null){
		if (igk_html_is_ns_child($this->m_n)){
			return $this->m_ns;
		}
		return null;
	}
	public function __toString(){
		return __CLASS__.":ns:".$this->m_ns;
	}
}


class IGKHtmlItemAttribute extends IGKObject
implements IIGKHtmlGetValue {

	public function getValue($option=null){
	}
}

///<summary>R Class class </summary>
final class R extends IGKObject
{

	var $m_lang;
	var $langRes;
	var $LangChangedEvent;//used to inform that keys changed. or updated
	var $KeysAdded;
	var $PageLangChangedEvent;


	static $sm_instance;
	static $sm_keyVAR;

	private $m_langChangedDate;
	private $m_langloaded;
	private $m_langctrl;
	private $m_langFiles;
	///<summary>register a language controller</summary>
	public static function RegLangCtrl($ctrl){
		$_instance = self::getInstance();
		$v = self::getInstance();
		//igk_ilog("regLang : ".$ctrl->Name);

		if ($_instance->m_langctrl == null)
			$_instance->m_langctrl = array();
		if ($_instance->m_langFiles == null)
			$_instance->m_langFiles = array();

		if ($ctrl && !IGKControllerManagerObject::IsSystemController($ctrl) &&   !isset($_instance->sm_langctrl[$ctrl->Name]))
		{
			$_instance->m_langctrl[$ctrl->Name]=$ctrl;
			if ($v->m_langloaded){
				self::LoadCtrlLang($ctrl);
			}
		}

	}
	public static function UnRegLangCtrl($ctrl){
		$_instance = self::getInstance();
		if ($_instance->m_langctrl == null)
			$_instance->m_langctrl = array();
		if (isset($_instance->m_langctrl[$ctrl->Name]))
			unset($_instance->m_langctrl[$ctrl->Name]);
	}

	private function langscript(){

	$f = igk_io_basePath("Lib/Scripts/lang/".R::GetCurrentLang().".xml");
	if (empty($f))
		return;

	$s = <<<EOF
var lang = igk.R.getLang();
var h = igk_getdir(igk_get_script_src());
if (h){
var dir = "{$f}";

igk.file.getcontents(dir, function(data){
	var d = igk.createNode("dum");
	var ts = d.setHtml(data).getElementsByTagName("string");
	for(var i = 0;i < ts.length; i++){
		 keys[ts[i].getAttribute("name")] = ts[i].innerHTML;
	}
}, true);

}
EOF;
	}
	/// get the current language file
	public function GetCurrentLangPath($folder=null){
		if ($folder==null)
			$folder = dirname(__FILE__)."/Default/Lang";
		return $folder."/lang.".$this->m_lang.".resources";
	}

	public static function getInstance(){ //R session
			if (self::$sm_instance === null)
			{
				$b = 0;
				self::$sm_instance =
				//igk_get_class_instance(__CLASS__, function() use (&$b){
					//$b = 1;
					//return 
					new R();
				//}//);
				//if ($b){
					self::LoadLang();
				//}
			}
			return self::$sm_instance;
	}
	private function __construct()
	{
			$this->m_lang = IGK_DEFAULT_LANG;
			$this->LangChangedEvent = new IGKEvents($this, "LangChangedEvent");
			$this->PageLangChangedEvent = new IGKEvents($this, "PageLangChangedEvent");
			$this->KeysAdded = new IGKEvents($this,"KeysAdded");
	}
	private static function LoadCtrlLang($ctrl){
		$v = self::getInstance();
		//load ctrl lang
		//$f = $v->GetCurrentLangPath($ctrl->getDataDir());
		$f = igk_io_dir( $v->GetCurrentLangPath($ctrl->getDataDir()."/R/Lang"));
		
		if (file_exists($f)&& !isset($_instance->m_langFiles[$f])){
			$l = & $v->langRes;
			include($f);
			$v->langRes = $l;
			$_instance->m_langFiles[$f]=1;
			// $_instance->m_langctrl[$ctrl->Name]=$ctrl;
		}else{
			//load xml language
			//load language
			$lang = igk_io_dir($ctrl->getDataDir()."/R/Lang/".R::GetCurrentLang().".xml");
			if (file_exists($lang)){
				R::LoadLangFileXml($lang);
				$_instance->m_langFiles[$f]=1;
				// $_instance->m_langctrl[$ctrl->Name]=$ctrl;
			}
		}
	}
	public static function LoadLang(){

		$v = self::getInstance();
		//clear lang
		$v->langRes = array();
		$v->m_langloaded = false;
		$l = & $v->langRes;
		$f = $v->GetCurrentLangPath();
		if (file_exists($f))
		{
			include($f);
			//load controller lang files
		}
		else{
			igk_ilog("language file not found.[{$f}]", __METHOD__);
		}

		if ($v->m_langctrl){
			foreach($v->m_langctrl as $k=>$vc){
				self::LoadCtrlLang($vc);
			}
		}
		$v->m_langloaded = true;


	}
	public static function LoadLangFiles($file){
		// igk_wln("load lang file ...$file ".igk_show_trace());
		if (file_exists($file)){
			$v = self::getInstance();
			$l = $v->langRes;
			include($file);
			$v->langRes = $l;
		}
	}
	public static function LoadLangFileXml($file, $override=true){

		if (!file_exists($file))
			return;

		$t = IGKHtmlReader::LoadFile($file);
		$h = igk_getv($t->getElementsByTagName("resources"), 0);
		if ($h){
			//reset lang
			$g = self::getInstance();
			// self::ResetLang();
			$tab = $h->getElementsByTagName("string");
			foreach($tab as $k=>$v)
			{
				$n = strtolower($v["name"]);
				$r = trim($v->innerHTML);
				if (!empty($n) && ($override || !isset($g->langRes[$n]))){
					$g->langRes[$n] = $r;
				}
			}

		}

	}
	public static function ResetLang(){
		$v = self::getInstance();
		$v->langRes = array();
	}

	public static function AddLang($key, $value){
		if (!empty($key))
			self::getInstance()->langRes[strtolower(trim($key))]=$value;
	}
	protected function OnKeyAdded($key)
	{//raise event
		$this->KeysAdded->Call($this, $key);
	}
	protected function OnLangChangedEvent($key)
	{
		if ($this->LangChangedEvent !=null)
			$this->LangChangedEvent->Call($this, null);
	}
	///<summary>get string expression </summary>
	public static function gets($key, $default=null)
	{
			$i = self::getInstance();
			$t = strtolower($key);
			if (isset($i->langRes[$t]))
			{
			    $s = $i->langRes[$t];
				$match = array();
				$c = 0;
				//get include key in string  exemple : title.error ==> the [info] error
				// [info] will be replaced by its real value if found in keys
				$c = preg_match_all("/\[(?P<value>[a-zA-Z0-9_\.]+)\]/i",$s, $match);
				if ($c > 0)
				{
					for($i = 0; $i < $c ; $i++)
					{

						$ckey = $match["value"][$i];
						if (strtolower($ckey) == $t)
							continue;

						$s = str_replace( $match[0][$i],R::gets($ckey),$s);

					}
				}

				return $s;
			}
			else{
				if (!empty($key))
				{
					$i->langRes[$key] = $key;
					$i->OnKeyAdded($key);
				}
			}
			if ($default)
				return $default;
			return $key;
	}
	///<summary>get new key string value from controller</summary>
	public static function ncgets($ctrl, $key){
		if (empty($key) || ($ctrl == null))
			return null;
		return self::ngets(strtolower($ctrl->Name.".".$key));
	}
	///<summary>get new language definition</summary>
	public static function ngets($key)
	{
		if ($key==null)
			return null;
		if (!is_string($key))
		{
			//igk_die("not a valid keys");
			return $key;
		}
		if (self::$sm_keyVAR == null)
			self::$sm_keyVAR = array();
		$T = strtolower($key);
		$default = self::gets($T);
		$args = array();
		if (func_num_args() > 1)
		{
			$t = func_get_args();
			for($i=1; $i< count($t) ; $i++)
			{
				if ( ($i == 1) && is_array($t[$i]))
				{
					$args = array_merge($args, $t[$i]);
				}
				else
					$args[] = $t[$i];
			}
			return new IGKLangKey($key, $default, $args);
		}
		else{
			if (isset(self::$sm_keyVAR[$T]))
			{
				return self::$sm_keyVAR[$T];
			}
			else{
				self::$sm_keyVAR[$T] = new IGKLangKey($key, $default, $args);
				return self::$sm_keyVAR[$T];
			}
		}
	}
	public static function getlang($keys)
	{
		return new IGKLangExpression($keys);
	}
	public static function ChangeLang($lang = "fr"){
		$v = self::getInstance();
		if (($v->m_lang != $lang)&& igk_getctrl(IGK_CSVLANGUAGE_CTRL)->support($lang)){
			$v->m_lang = $lang;
			self::LoadLang();
			$v->onPageLangChangedEvent();
		}
	}
	public function onPageLangChangedEvent()
	{
		if ($this->PageLangChangedEvent !=null){
			// igk_ilog("lang changed event");
			// igk_ilog("methods ".$this->PageLangChangedEvent);
			// $this->PageLangChangedEvent->enumerateMethod(function($t){
				// igk_ilog("func ".$t);
			// });
			//e_xit;
			$this->PageLangChangedEvent->Call($this,null);
		}
	}
	public static function GetLangInfo(){
		return self::getInstance()->langRes;
	}

	public static function SaveLang()
	{
		$v = self::getInstance();
		$out = "<?php \n";
		$tab = $v->langRes;
		$ktab = array_keys($tab);
		igk_usort($ktab, "igk_key_sort");
		foreach($ktab as $k)
		{
			$k = trim($k);
			$v = $tab[$k];
			$v = str_replace("\'", "'", str_replace("\"", "&quot;",$v));
			if (!empty($k))
			{
				//$out .= "R::AddLang(\"$k\", \"".$v."\");\n";
				$out .= "\$l[\"".strtolower($k)."\"]=\"".$v."\";\n";
			}
		}
		$out .= "?>";
		$v = self::getInstance();
		$file = $v->GetCurrentLangPath();

		if (igk_io_save_file_as_utf8_wbom($file, $out, true))
		{
			//reload lang files
			self::LoadLang();
			igk_sys_regchange("LangChanged", $v->m_langChangedDate);
			$v->OnLangChangedEvent(null);
			return true;
		}
		else{
			igk_notify_error("can't save lang file");
		}
		return false;
	}

	public static function SaveLangXml($filename=null){
		$q = self::getInstance();
		$out = igk_createNode("resources");
		$tab = $q->langRes;
		$ktab = array_keys($tab);
		igk_usort($ktab, "igk_key_sort");
		foreach($ktab as $k)
		{
			$v = $tab[$k];
			$v = str_replace("\'", "'", str_replace("\"", "&quot;",$v));
			$v = str_replace("<", "&lt;",$v);
			$v = str_replace(">", "&gt;",$v);
			$v = preg_replace_callback("/([&](.){0,1})/i", function($m){

				if (trim($m[0]) == "&" )
				{
					return "&amp;";
				}
				return $m[0];
			}, $v);
			if (!empty($k))
				$out->add("string")->setAttribute("name", $k)->Content = $v;

		}
		$file = $filename==null ? igk_io_baseDir("R/Lang/".self::GetCurrentLang().".xml") : $filename;

		if (igk_io_save_file_as_utf8($file, $out->Render(), true))
		{
			//reload lang files
			self::LoadLang();
			igk_sys_regchange("LangChanged", $q->m_langChangedDate);
			$q->OnLangChangedEvent(null);
			return true;
		}
		else{
			igk_notify_error("can't save lang file");
		}
		return false;
	}
	//
	//get the current lang
	//
	public static function GetCurrentLang(){
		$v = self::getInstance();
		return $v->m_lang;
	}
	public static function GetImgUri($name)
	{

		$v = igk_getctrl(IGK_PIC_RES_CTRL);
		if ($v)
		{
			return $v->getImgUri($name);
		}
		return IGK_STR_EMPTY;
	}
	///<summary>get resource image uri
	public static function GetImgResUri($name){
		$v = igk_getctrl(IGK_PIC_RES_CTRL);
		if ($v){
			return $v->getImgUri($name, true);
		}
		return IGK_STR_EMPTY;
	}

	public static function RemoveKey($name){
		$name = strtolower($name);
		$v = self::getInstance();
		if(isset($v->langRes[$name]))
		{
			unset($v->langRes[$name]);
			return true;
		}
		return false;
	}
	public static function ClearLang(){
		$v = self::getInstance();
		$v->langRes = array();
		self::SaveLang(null);
	}
}


final class IGKVector2f extends IGKObject{
	private $m_x;
	private $m_y;

	public function getX(){return $this->m_x;}
	public function getY(){return $this->m_y;}

	public function setX($value){ $this->m_x = $value;}
	public function setY($value){ $this->m_y = $value;}

	public function __construct($x=0,$y=0)
	{
		$this->m_x = $x;
		$this->m_y = $y;
	}
	public function __toString(){
		return "IGKVector2f [x:".$this->X." y:".$this->Y."]";
	}
	public static function FromString($data){
		$b = explode(";", $data);
		list($X,$Y) = count($b) == 2? $b : array($data,$data);
		return new IGKVector2f($X,$Y);
	}
}

//used to pass argument to data binding
//used to
final class IGKDataBindingScript extends IGKObject {
	var $args; //argument for data binding
	public function __construct(){
		$this->args = array();
	}
}
///<summary>frame class script</summary>
final class IGKFrameScript implements IIGKHtmlGetValue {//represent a frame class script
	var $owner;
	private $m_type;

	public function __construct($owner, $type="f"){
		$this->owner = $owner;
		$this->m_type = $type;
	}

	public function getValue($option=null)
	{
		$n =IGK_STR_EMPTY;
		switch($n)
		{
			case "c":
				$n = "initconfirm";
				break;
			case "f":
			default:
				$n = "init";
				break;
		}
		return  igk_get_string_format("IGK.winui.frameBox.{$n}({0}],{1});",
		igk_getsv($this->owner->Width?'"'.$this->owner->Width.'"':null,'null'),
		igk_getsv($this->owner->Height?'"'.$this->owner->Height.'"':null,'null'));
	}
}

///<summary>represent les rectangles</summary>
final class IGKRectanglef extends IGKObject{
	private $m_x;
	private $m_y;
	private $m_w;
	private $m_h;

	public function getX(){return $this->m_x;}
	public function getY(){return $this->m_y;}

	public function setX($value){ $this->m_x = $value;}
	public function setY($value){ $this->m_y = $value;}

	public function getWidth(){return $this->m_w;}
	public function getHeight(){return $this->m_h;}

	public function setWidth($value){ $this->m_w = $value;}
	public function setHeight($value){ $this->m_h = $value;}


	public function __construct($x=0,$y=0, $width=0, $height=0 )
	{
		$this->m_x = $x;
		$this->m_y = $y;
		$this->m_w = $width;
		$this->m_h = $height;
	}
	public function __toString(){
		return "IGKRectanglef [x:".$this->X." y:".$this->Y."; width: ".$this->Width." ;height: ".$this->Height."]";
	}
}

//--------------------------------------------------------------------------------------------------------
//igk Application class
//--------------------------------------------------------------------------------------------------------

//attention la serialisation des donnée consome enormement.
//c'est pour cette raison que j'utiliserai des flags
//sauf si je ne peux faire autrement

final class IGKApp extends IGKObject{
	// public static $BASEDIR;//base directory
	public static $DEBUG;//for debuging purpose
	public static $LibFiles;
	public static $ScriptFolders; //represent script folder
	public static $controllerdir;
	public static $INITENV; //flag for environment init
	//application events obsolete
	// public $InitEvent;				//init event
	// private $m_CurrentPageFolderEvent;		//current page event
	// private $m_DocCreatedEvent; //event raised when a new web document is created on the system. used to initalize a document

	private static $sm_instance;

	//private $m_from;
	private $_f;   	//array of storage flags	
	private $m_doc; //html document
	
	// private $m_Validator; //get html the validator object

	private $m_ControllerManager; //controller manager objects
	// private $m_subdomainctrl; //store the current subdomain controller.
	// private $m_basecurrent_ctrl;
	// private $m_firstUse; //is first used
	// private $m_invokedUriController ; //invoked uri controller
	// private $m_selectedController ; //selected controller
	//private $m_cPage ;
	// private $m_appconfigs;
	// private $m_themeRegistry;//to manage style
	private $m_authorizations;
	private $m_session; //igk session parameters.

	public function getSelectedController(){
		igk_die("Not Implement ".__METHOD__);
		return null;
	}

	public function __toString(){
		return "igk framework[Version:". IGK_VERSION."]";
	}
	private function __construct(){//init framework app constructr
		//magic function
		//$this->m_ViewMode = IGKViewMode::VISITOR;
		//$this->m_from = $_SERVER;
		
		$ie_diagnonstic = igk_getv($_SERVER, "HTTP_REFERER") == "diagnostics://5/";
		if ($ie_diagnonstic ){			
			//igk_ilog(igk_show_trace());
			igk_exit();
		}
		
		$this->_f = array(
			IGK_VIEW_MODE_FLAG=>IGKViewMode::VISITOR,
			IGK_CONFIG_FLAG=>0x0
		);
	}
	
	
	public function __sleep(){
		$t = igk_reflection_get_member($this);
		 if (empty($this->_f)){
			 unset($t["\0".__CLASS__."\0_f"]);
		}
		return array_keys($t);
	}
	
	//app. flag parameter
	//------------------------------------
	public function getcreateAt(){
		return $this->_f[IGK_CREATE_AT];
	}
	public function getsessionId(){
		return $this->_f[IGK_SESSION_ID];
	}
	public function setsessionId($v){
		$this->_f[IGK_SESSION_ID] = $v;
	}
	public function setcreateAt($v){
		$this->_f[IGK_CREATE_AT] = $v;
	}
	public function getSubDomainCtrl(){
		return igk_getv($this->_f, IGK_SUBDOMAIN_CTRL);
	}
	protected function setSubDomainCtrl($v){
		return $this->setFlag(IGK_SUBDOMAIN_CTRL, $v);
	}
	public function getInvokedUriController(){
		return igk_getv($this->_f, IGK_INVOKE_URI_CTRL);
	}
	
	public function setFlag($id, $v){
		if ($v==null){
			unset($this->_f[$id]);
		}else{
			$this->_f[$id]=$v;
		}
		return $this;
	}

	public function regCssController($ctrl){
		igk_die(__FUNCTION__." Not Implement");
		//return $this->m_themeRegistry->regController($ctrl);
	}

	public function OnNewDocumentCreated($doc){		
		igk_invoke_session_event(IGK_ENV_NEW_DOC_CREATED, array($this, $doc));
	}	

	public static function GetAppDir(){
		$g = IGK_APP_DIR;
		return isset($g) ? IGK_APP_DIR: dirname(__FILE__);
	}
	public static function GetLibFolder(){
		return dirname(__FILE__);
	}

	public static function Run($filename){
		//run application as index
		igk_sys_render_index($filename);
	}
	public static function CacheLibFiles($force=false){//cache library files

		$f =  igk_io_baseDir(IGK_FILE_LIB_CACHE);
		if (empty($f))
			return;
		
		$t = 3600;
		$expire = time()-$t;
		$el = "\n";
		if (!$force && file_exists($f) && (filemtime($f) > $expire))
		{	//no cache
			return;
		}
		$data  =IGK_STR_EMPTY;
		$dir = dirname(__FILE__);
		$mdir = igk_html_uri(dirname(__FILE__));
		foreach(self::$LibFiles as $k=>$v)
		{
			$o = igk_io_getrelativepath($dir, realpath($v));
			$data .= 'require_once(\''.igk_io_dir(realpath($v)).'\');'.$el;
			// $data .= 'require_once(\''.
			// igk_io_dir(
			// IGKIO::GetRelativePath(dirname(realpath($v)), $dir )."/".basename($v)
			// ).'\');'.$el;
		}
		$date= igk_date_now();
		$out = <<<EOF
<?php
//file auto generate
//lib cache files : {$date}
//author: C.A.D BONDJE DOUE
\$bck = getcwd();
chdir(dirname(__FILE__));
\$d = '{$dir}';
chdir(\$d);

{$data}

chdir(\$bck);
unset(\$bck);
?>
EOF;


		igk_io_save_file_as_utf8($f, $out);
		//if opcache is enabled . invalidate the script for next loading
		if (function_exists("opcache_invalidate"))
			opcache_invalidate($f, true);
	}
	public static function LoadCacheLibFiles(){
	//load cached files. igk instance not created yet. the only wait to do that
	//is to check if a cached files exists.
	//if ture then load it otherwise return no cached dir file.
		$f = igk_io_baseDir(IGK_FILE_LIB_CACHE);
		//$cc = 1; //igk_get_env("sys://checkcache");
		$v = false;
		if (!defined("IGK_NO_CACHE_LIB") && file_exists($f))
		{
			try{
				include_once($f);
				$v = true;
				igk_get_env_lib_loaded(true);
			}
			catch(Exception $ex){
				igk_wln("[ ".__FUNCTION__." ]- can't load files...[".$f."]");
			}
		}
		return $v;
	}

	public static function IsInit(){
		return self::getInstance()->getIsInit();
	}

	public function getIsInit(){
		return ((igk_getv($this->_f, IGK_ISINIT_FLAG, 0) & 0x02) >>1) == 1;//m_isInit;
	}
	private function setIsInit($v){
		$iv = igk_getv($this->_f, IGK_ISINIT_FLAG, 0);
		$this->_f[IGK_ISINIT_FLAG] =
			$v ?$iv | 0x02 :
			($iv & ~0x2);
		// $this->m_isInit = $v;

	}
	public static function setConfig($v){
		igk_die( __CLASS__."::".__FUNCTION__." is Not Defined Impletement ");
		//self::getInstance()->m_isConfig = $v;
	}

	public function getAutorisations(){return $this->m_authorizations;}
	public function getControllerManager(){
		return $this->m_ControllerManager ?? igk_get_env("sys://instance/controllermanager");

	}
	public function setControllerManager($value) {$this->m_ControllerManager = $value;	}

	///<summary> get the global document</summary>
	public function getDoc(){
		return $this->m_doc;
	}
	private function setDocument($document){
		$this->m_doc = $document;
	}
	///<summary> get if application is in first used</summary>
	public function getFirstUse(){ return $this->_f[IGK_FIRSTUSE_FLAG]; }
	//used to check if this is in configuration mode
	public function getConfigMode(){ return igk_getv(igk_getconfigwebpagectrl(), 'IsConnected'); }
	public function getViewMode(){
		return //IGKViewMode::WEBMASTER;// 
		$this->_f[IGK_VIEW_MODE_FLAG];//ViewMode;
	}
	public function setViewMode($v){
	
		if($this->_f[IGK_VIEW_MODE_FLAG] == $v)
			return;
		
	
    	$this->_f[IGK_VIEW_MODE_FLAG] = $v;//ViewMode;
		$this->ViewControllers();
		igk_notification_push_event("sys://events/viewmodechanged", $this, $v);
		
		//igk_ilog( "KK : ".$this->_f[IGK_VIEW_MODE_FLAG]);
	}
	///return current application configuration setting
	//that will store data on the fly. different use from session who store session data
	public function getAppConfiguration(){ return $this->m_appconfigs; }
	// // function setViewMode($mode){
	// // if ($mode != $this->m_ViewMode){
		// // $this->m_ViewMode = $mode;
		// view controller
		// // $this->ViewControllers();
		// // igk_notification_push_event("sys://events/viewmodechanged", $this, $mode);
	// // }
	// // }

	public function IsSupportViewMode($view){
		return (($this->getViewMode() & $view) == $view);
	}
	 ///<summary>get api current page folder</summary>
	public function getCurrentPageFolder(){
		// igk_wln("current ".IGKIO::GetCurrentDir());
		// igk_wln("base ".IGKIO::GetBaseDir());
		$cdir = IGKIO::GetCurrentDir();
		$bdir = IGKIO::GetBaseDir();
		if ($cdir == $bdir)
			return IGK_HOME_PAGEFOLDER;
		 else{
			 return IGKIO::GetChildRelativePath($bdir, $cdir);
		}
	}

	 // function __destruct() {
        // print "Destruction de " . $this->name . "\n";
		// igk_log_write_i("IGKAPP", "Destroy");
    // }

	//class::igk system current page return a menu current page
	public function getCurrentPage(){ return igk_getv(igk_getctrl(IGK_MENU_CTRL), 'CurrentPage', 'home'); }
	public function getCurrentPageIndex(){return igk_getv(igk_getctrl(IGK_MENU_CTRL),'CurrentPageIndex', 0); }
	//set the current page
	public function setCurrentPage($value, $index=0)
	{
		$p = $this->CurrentPage;
		$i = $this->CurrentPageIndex;
		$index = ($index == 0)?igk_getr("pageindex",$index):$index;
		if (($p != $value) || ($index!= $i )){
			igk_getctrl(IGK_MENU_CTRL)->setPage($value, $index);
		}
	}
	//define
	const CURRENT_PAGEFOLDER_EVT = "sys://event/".__CLASS__."/currentpagefolder";
	static $REG_CSS_CLASS_EVT;

	public function addCurrentPageFolderEvent($obj, $method){
		igk_reg_session_event(self::CURRENT_PAGEFOLDER_EVT, array($obj, $method));
		//$this->m_CurrentPageFolderEvent->add($obj, $method);
	}
	public function removeCurrentPageFolderEvent($obj, $method){
		//$this->m_CurrentPageFolderEvent->remove($obj, $method);
	}
	public function addCurrentPageEvent($obj, $method){
		$m = igk_getctrl(IGK_MENU_CTRL, true);
		$m->addPageChangedEvent($obj, $method);
	}
	public function removeCurrentPageEvent($obj, $method)
	{
		igk_getctrl(IGK_MENU_CTRL)->removePageChangedEvent($obj, $method);
	}
	// public function getValidator(){return $this->m_Validator;}
	//is configurating
	public function getIsConfigurating(){return $this->getCurrentPage() == IGK_CONFIG_MODE; }
	public function getConfigs(){return IGKAppConfig::getInstance()->Data; }
	public function getSession(){return $this->m_session;}
	public function getUser(){return $this->getSession()->User; }


	//reset
	public function reset(){
		$this->_f[IGK_FIRSTUSE_FLAG] = true;
		//$this->m_cPage = null;
		$this->Doc->body->ClearChilds();
	}

	///<summary>
	/// call global function private to call function
	///</summary>
	public function __call($name, $arguments){
		if (function_exists("igk_".$name))
		{
			return call_user_func_array("igk_".$name, $arguments);
		}

	}
	///<summary>private function get igk m</summary>
	public function __get($name)
	{
		if (function_exists("igk_".$name))
		{
			return call_user_func_array("igk_".$name, array());
		}
		return parent::__get($name);
	}

	public function onCurrentPageFolderEvent($oldpage){
		//call primary method register
		$f = $this->CurrentPageFolder;
		//call page folder event
		$v_evt = array("currentPage"=>$f, "oldPage"=>$oldpage);

		igk_set_env("sys://view/context", array("name"=>"currentfolderchanged", "event"=>$v_evt));

		// igk_ilog("page ???" . $this->m_CurrentPageFolderEvent->getMethodCount());
		// if ($this->m_CurrentPageFolderEvent!=null)
				// $this->m_CurrentPageFolderEvent->Call($this, $v_evt);
		igk_notification_push_event(IGK_CONF_PAGEFOLDER_CHANGED_EVENT, $this, $v_evt);
		igk_set_env("sys://view/context", null);
	}
	private static function RegViewPicture(){
		//for getting web resource
		if (igk_getr("c")== IGK_PIC_RES_CTRL)
		{
			if (igk_getr("css")==1)
			{
				$f = igk_getr("f","viewpic");
				if ($f=="viewpic")
				{
					igk_getctrl(IGK_PIC_RES_CTRL)->$f();
					igk_exit();
				}
			}
		}
		if (igk_getr("vimg", null)!=null)
		{
			//priority to image request
			igk_getctrl(IGK_PIC_RES_CTRL)->viewpic(igk_getr("vimg"));
			igk_exit();
		}
	}

	public static function setErrorQuery($error, $uri=null){
		igk_set_env("sys://error//Query",
		array(
		"error"=>$error,
		"uri"=>$uri
		));
	}
	///<summary> init for no web activity</summary>
	private static function InitNoWebInstance($igk){
		if ($igk->getIsInit()){
			return;
		}
		$igk->setIsInit(true);
	}

	///<summary>init global application entry</summary>
	///<param name="file">source file</param>
	///<param name="renderDefault">render the default document. </param>
	///<remark>if renderDefault=1 the default document will only be rendered if it's not sub included</remark>
	public static function Init($file, $renderDefault=1, $setting=null){//init IGKAPP FRAMEWORK
		//initialize app page loading according to file.
		//-
		//if $file is null consider it as non web flow application
		//-
		if(!defined('IGK_APP_DIR')){
			
				define('IGK_APP_DIR',($file==null) ?
					dirname(igk_getv($_SERVER, "SCRIPT_FILENAME")) :
					dirname(realpath($file))
					);
			
		}
		
		$flow = igk_get_env("sys://initAppFlow"); //init application flow  
		
		if ($flow){
			$flow($file, $renderDefault, $setting);
			return;
		}
		
		//
		//default web flow
		//
		$v_igk = self::getInstance();
		if (defined("IGK_NO_WEB")){
			//no web rendering and no controller support
			self::InitNoWebInstance($v_igk);
			return;
		}
		igk_set_env(IGK_ENV_APP_CONTEXT, IGKAppContext::starting);
		// igk_wln($file);
		// igk_wln("dombdir :::". $v_igk->Session->domainBaseDir);
		// igk_wln("BDIR:".IGK_APP_DIR);
		$b = $v_igk->Session->domainBaseDir;
		if (isset($b) && (!$setting || !$setting->domainfileNotMaintain)){
			//check if domain bdir registerer
			// igk_wln("isset ".$b);
			if ($b !== $file){
				igk_wln("/!\\ init file failed .....");
				//session_destroy();
				// igk_wln("destroy");
				//igk_navto(igk_io_baseUri());
				igk_exit();
			}
		}
		else{
			$v_igk->Session->domainBaseDir = $file;
		}
		$v_igk->Session->RedirectionContext = 0;
		$v_igk->setBaseCurrentCtrl(null);



		//
		//chek in protocol uri system
		//---------------------------
		$p = igk_getv($_SERVER, "SERVER_PORT");
		if ($v_igk->Configs->force_secure_redirection && ($p!=443)){
			$s = igk_secure_uri(igk_io_fullrequestUri(), true, false);
			igk_navto($s);
			igk_exit();
		}


		if ($v_igk->getIsInit())
		{
			igk_set_env(IGK_ENV_APP_CONTEXT, IGKAppContext::running);
			//checking document global document
			//if null recreate the session an navigate to base uri
			if ($v_igk->Doc == null){
				$buri = igk_io_fullBaseRequestUri();
				self::Destroy();
				session_destroy();
				igk_navto($buri);//Domain
				igk_exit();
			}

			$v_igk->__checkDomain();
			$v_igk->__checkSubDomain();
			$c = $v_igk->getControllerManager()->InvokeUri();
			$defctrl = igk_get_defaultwebpagectrl();
			if (igk_own_view_ctrl($defctrl) && defined("IGK_REDIRECTION"))
			{
				igk_sys_render_default_uri(null, $defctrl);
				return;
			}
			//if CSS DEFINED exit
			if (defined("IGK_FORCSS"))
				return;
			//IGKOb::Start();
			$v_igk->maintainPageFolderView(false);

		}
		else{

		//continue for page loading
		$v_igk->setIsInit(true);
		//init setting
		// $v_igk->getAppConfiguration()->init();
		//check if picture demand. if found Init exit
		self::RegViewPicture();
		$v_igk->_initControllers();
		$v_spagef = $v_igk->Session->PageFolder;
		//$v_raise = $raisePageFolderChanged; //raise page folder changed
		$v_initFrom1stUse = false;
		$c = null;
		//for single domain operation
		$v_igk->__checkDomain();
		// igk_utest_wln("initalize");
		// return;
		//-------------------------------------------------------------
		//init for the first used
		//-------------------------------------------------------------
		if ($v_igk->FirstUse)
		{
			//setup the default language
			R::ChangeLang(IGKUserAgent::GetDefaultLang());
			//call initialize event to initialize system
			igk_invoke_session_event(IGK_ENV_APP_INIT, array($v_igk, null));
			//$v_igk->InitEvent->Call($v_igk, null);
			//call the user init default page
			if(function_exists("InitDefaultPage"))
			{
				InitDefaultPage($v_igk);
			}
			else{
				$v_igk->__initDefaultPage();
			}
			//init the default document. init view
			self::__initDocument($v_igk);
			//change the first use
			$v_igk->_f[IGK_FIRSTUSE_FLAG] = false;
			//$v_raise  = false; //don't raise the page folder changed event
			$v_initFrom1stUse = true;
		}
		//initialize event
		$v_igk->Session->initalize($v_igk);
		//

		//if CSS DEFINED exit
		if (igk_is_const_defined("IGK_FORCSS|IGK_FRAMEWORK_ATOMIC"))
			return;

		
		//1. check if subdomain
		$v_igk->__checkSubDomain();

		//2. try to handle primary invocation uri
		$c = $v_igk->getControllerManager()->InvokeUri();	

		//3. Change current page if require
		$v_igk->maintainPageFolderView();


			//for debugging purpose maintain the lasted invoked controller
			$linf = $v_igk->Session->LastInvokedCtrl;
			if ($c && ($c  != $linf )){
				$v_igk->Session->LastInvokedCtrl = $c;
				igk_invoke_session_event("sys://event/LastCtrlChanged", $v_igk, $c);
			}
			//init system DataBase
			if ($v_igk->isConfig){
				igk_getctrl(IGK_MYSQL_DB_CTRL)->initSDb(false, false);
				$v_igk->isConfig = false;
			}
			// MAINTAIN THE CURRENT PAGE VISIBILITY
			if ($v_igk->CurrentPage != igk_web_defaultpage())
			{
				$s = igk_io_baserequestUri();
				if ((empty($s)) && preg_match("/\?p=".$v_igk->CurrentPage."/i", igk_io_request_uri())==false)
				{
					$uri = igk_io_baseUri()."?p=".$v_igk->CurrentPage;
					igk_navto($uri);
				}
			}
		}
		//Render Global document on BaseDomain
		if ($renderDefault){
			igk_sys_render_default_uri();
			self::Render($v_igk, $file);
		}
	}
	///<summary>initialize Balafon application With atomic context</summary>
	///<remark>in that context only registrated controller can be used</remark>
	///<remark>if you plan to use session. please start session before invoking this method</remark>
	public static function InitAtomic(){
		$v_igk = self::getInstance();
		if ($v_igk->getIsInit()){
			return;
		}
		if(!defined("IGK_FRAMEWORK_ATOMIC"))
			define("IGK_FRAMEWORK_ATOMIC", 1);

		$v_igk->_initControllers();
		$c = $v_igk->getControllerManager()	;
		$v_igk->setIsInit(true);
		$v_igk->Session->initalize($v_igk);
		// self::__initDocument($v_igk);
		$v_igk->initControllerComplete();
		//start setup igk app
		$_SESSION[IGK_APP_SESSION_KEY]=$v_igk;

	}
	private function __checkDomain(){
		$domain = $this->Session->Domain;
		$buri = $this->Configs->website_domain; //igk_io_baseUri();
		// igk_wln(" $domain 1");
		// igk_wln(" $buri 2");


		if ($domain !== $buri)
		{
			if (!empty($domain))
			{
				// igk_ilog("domain changed ... ".$domain. " ? ".$buri, __METHOD__);
				//Clear session and reconnect
				$this->Session->Domain = $buri;
				//change the domain
				session_write_close();
				@session_destroy();

				// igk_notifyctrl()->addMsgr("Domain name changed");
				igk_getconfigwebpagectrl()->reconnect();
				igk_exit();
			}
			$this->Session->Domain = $buri;
		}

	}
	///<summary></summary>
	private function __checkSubDomain(){
		//used to define a config pages
		if (defined('IGK_CONFIG_PAGE') || igk_is_cmd()){
			//if config page no check subdomain //
			return;
		}
		$v_ruri = igk_io_baseRequestUri();
		$uri = igk_io_fullrequestUri();
		if (igk_io_handle_system_command($uri)){
			igk_exit();
		}
		
		igk_sys_handle_ctrl_request_uri($uri);
		

		//before checking the domain we must be sure that all controller are loaded
		//get the controller domain
		$c = IGKSubDomainManager::getInstance()->checkDomain();
		if ($c !== false)
		{

			$this->setSubDomainCtrl($c);
			$app = $this;

			$tab = explode('?',$v_ruri);
			$uri = igk_getv($tab, 0);
			$params = igk_getv($tab, 1);
			$page = "/".$uri;

			//primitive actions
			$actionctrl = igk_getctrl(IGK_SYSACTION_CTRL);
			$k = IGK_REG_ACTION_METH ;
			$pattern = igk_sys_ac_getpattern($k);

			$e = new IGKSystemUriActionPatternInfo( array(
					"action"=>$k,
					"value"=>$c->getRegInvokeUri(),
					"pattern"=>$pattern,
					"uri"=> $page,
					"keys"=> igk_str_get_pattern_keys($k),
					"ctrl"=>$c,
					"requestparams"=>$params,
					"context"=>"subdomain"));
			if ($actionctrl && ($c!== $actionctrl)){
				$app->Session->RedirectionContext = 1;
				//invoke uri
				//$this->getControllerManager()->InvokeUri();
				// igk_ilog(igk_io_request_uri());

				if (!$c->NoGlobalAction && ($ce = $actionctrl->matche_global($page))){
					try{
						$ce->ctrl = null;//$actionctrl;
						$actionctrl->invokeUriPattern($ce);
					}catch(Exception $e){
						igk_show_exception($e);
						igk_exit();
					}
					// igk_wln("done");
					return;
				}
				else
				//invoke uri pattern
				$actionctrl->invokeCtrlUriPattern($c, $e);
			}
		}else{
			//subdomain adress
			$s = igk_io_subdomain_uri_name();
			// igk_wln($_SERVER);
			// igk_wln($c);
			// igk_wln($s);
			// exit();
			if (!empty($s)){
				header("Status: 404");
				header("HTTP/1.0 404 Not found ".$s);
				igk_sys_show_error_doc(5404);
				igk_exit();
			}
		}
		$this->setSubDomainCtrl(null);
	}

	
	public function setBaseCurrentCtrl($v){
		$this->m_basecurrent_ctrl = $v;
	}
	public function getBaseCurrentCtrl(){
		return $this->m_basecurrent_ctrl;
	}
	private function maintainPageFolderView($v_initFrom1stUse=true){
		$v_cpage = $this->CurrentPageFolder;
		$v_opage = $this->Session->PageFolder;

		// igk_wln("call maintainPageFolderView");
		// igk_wln("cpwdf:".$v_cpage);
		// igk_wln("v_opage:".$v_opage);
		if ($v_opage != $v_cpage)
		{
			//store current page to setting
			$this->Session->PageFolder = $v_cpage;
			//raise page folder change only if (page is not home or not on )
			if (!$v_initFrom1stUse || ($v_initFrom1stUse && ($v_cpage != IGK_HOME_PAGEFOLDER))){
				 // igk_ilog("raise page folder ....".$v_opage);
				$this->onCurrentPageFolderEvent($v_opage);
				igk_set_env(IGK_ENV_PAGEFOLDER_CHANGED_KEY, 1);
			}
		}
	}
	/// init default page rendering system
	private function __initDefaultPage(){
		$doc = $this->Doc;
		//define user entry
		//$doc->bodypage = $doc->body->add("div", array("id"=>"bodypage", "class"=>"igk-bodypage"));

	}

	private static function __initDocument($igk){//init document
		$igk->ViewControllers();
		igk_set_env(IGK_KEY_FORCEVIEW, 1);
	}
	//<summary>render document if not include or need for foce view</summary>
	private static function Render($v_igk, $file=null){//render document in inclusion
	// igk_wln("rendering ......");
	$fview =$v_igk->Session->getParam("forceview");

		if (igk_file_IsNotIncluded($file)){
			if ($fview == 1){
				$v_igk->Session->setParam("forceview", null);
				if (igk_get_env(IGK_KEY_FORCEVIEW) !== 1){
					igk_sys_force_view();
				}
			}
			igk_set_session_redirection(null);
			self::RenderDocument();
			session_write_close();
			igk_exit();
		}
	}
	///<summary>force to render global html document</summary>
	public static function RenderDocument(){
		$igk = self::$sm_instance;
		if (!$igk->ConfigMode && $igk->Configs->allow_auto_cache_page)
		{
			$ctrl = igk_getctrl("cache");
			if ($ctrl)
			{
				$ctrl->loadCache($App->CurrentPage.".html",igk_app());
			}
		}
		else{
			// igk_wln("render document :::".igk_get_env(IGK_KEY_FORCEVIEW));
			// igk_wln("key ::: ".igk_get_env(IGK_ENV_PAGEFOLDER_CHANGED_KEY));
			$ctrl = igk_get_defaultwebpagectrl();
			if ($ctrl && (igk_get_env(IGK_KEY_FORCEVIEW) !== 1)){
				if (!igk_get_env("sys://tempdata")){
					igk_set_env("sys://tempdata", 1);
				}
				//FORCE REFRESH the current default controller
				if (!igk_get_env(IGK_ENV_PAGEFOLDER_CHANGED_KEY)){
					$ctrl->View();
				}
			}
			$igk->Doc->RenderAJX();
			//always clear body after rendering
			// $igk->Doc->body->clearChilds();
			igk_flush_data();			
		}
	}
	//call document view
	public function View(){
		//do nothing
	}
	public function getTargetNode(){
		return $this->Doc;
	}

	///<summary>get the igk instance value</summary>
	public static function getInstance(){ //instance of this igk

		if ((self::$sm_instance === null)||!isset($_SESSION))
		{

			if (isset($_SESSION[IGK_APP_SESSION_KEY]))
			{
				self::$sm_instance = $_SESSION[IGK_APP_SESSION_KEY];
			}
			else {
				//
				$t = igk_date_now();
				self::$sm_instance = new IGKApp();
				self::$sm_instance->createAt  = $t;
				self::$sm_instance->sessionId =   session_id();
				$_SESSION[IGK_APP_SESSION_KEY] = self::$sm_instance;
				//CURTODO: session writing data finish
				// session_write_close();
				// igk_wln($_SESSION[IGK_APP_SESSION_KEY]);
				// igk_wln(__FILE__. "..".__LINE__);
				// self::$sm_instance->setIsInit(1);
				// igk_wln(self::$sm_instance->isInit);
				// igk_wln(IGKApp::IsInit());//elf::$sm_instance->isInit);
				// session_destroy();
				// exit;

				self::$sm_instance->_load();
				// self::$sm_instance->Session->setParam(IGK_KEY_PARAM_SESSION_START_AT, $t);
				//self::$sm_instance->Session->setParam("startInfo", igk_sys_create_session_start_info());


			}
		}else{
			$iapp  = igk_getv($_SESSION, IGK_APP_SESSION_KEY);
			if (($iapp !==null) && ($iapp !== self::$sm_instance) && (get_class($iapp) === __CLASS__)){
				//return the stored session IGKApp
				// igk_debug_wln("from  debug... iner");
				// igk_debug_wln("from  debug... iner");
				return $iapp;
			}
		}
		return self::$sm_instance;
	}
	///<summary>destroy the application</summary>
	public static function Destroy(){
		if (self::$sm_instance !==null){
		igk_notification_push_event("system/events/destroyapp", self::$sm_instance, __FUNCTION__);
		self::$sm_instance = null;
		return 1;
		}
		return 0;
	}

	private function _load(){
		//LOAD APPLICATION
		//$this->m_appconfigs = 	new IGKAppConfiguration($this);
		$this->m_authorizations = new IGKAuthorization($this);
//		$this->m_themeRegistry = new IGKTHmlDocThemeCssCtrlRegistry($this);
		$this->m_session = new IGKSession($this);
		
		// $this->m_CurrentPageFolderEvent = new IGKEvents($this,"CurrentPageEvent");
		// $this->m_DocCreatedEvent = new IGKEvents($this,"DocCreatedEvent");
		include_once(IGK_LIB_DIR."/.run_script.global.pinc");
		//initialize controller list before create any object
		$this->_f[IGK_FIRSTUSE_FLAG] = true;



	}
	public final function beforeRenderDocument($doc, $options){
		//igk_ilog("before ".$doc);
		//$this->m_themeRegistry->bindCtrlStyle($doc);
	}

	private function _initControllers(){
		//testing . init controller execution time . must not exced 2s
		// $t = igk_start_time(__FUNCTION__);
		$v_ctrlm =IGKControllerManagerObject::getInstance(1);		
		//igk_utest_wln(__FUNCTION__." : ".igk_execute_time(__FUNCTION__)."s");
	}
	public function initControllerComplete(){
		if (defined('IGK_NO_WEB'))
			return;
		$this->_initDocument();
		igk_notification_reg_event(IGK_EVENT_DOC_BEFORE_RENDER, array($this, "beforeRenderDocument"));
	}
	private function _initDocument(){
		//
		//create global web Document and init it . all sub document will be initialize according to the main document
		//
		// igk_ilog("init document ....");
		$v_doc = new IGKHtmlDoc($this);
		$this->setDocument($v_doc);
		
		$v_doc->setup_document();

		//register global setup  event
		$v_cevent =  array($this->m_Doc, 'setup_document');
		igk_notification_reg_event(IGK_CONF_USER_CHANGE_EVENT, $v_cevent);
		igk_notification_reg_event(IGK_CONF_PAGEFOLDER_CHANGED_EVENT, $v_cevent);

		// $this->m_Validator = igk_createNode()->setStyle("igk-validator")->setCallback("add",
// <<<EOF
// parent::Add("div")->Content = \$text;
// EOF

		// );
		
		//array(new IGKHtmlValidatorItem();
		$t = igk_css_add_doc_style($v_doc);

		//
		//load all javascript from the basedir script folder
		//
		IGKApp::$ScriptFolders = null;		
		igk_js_init_doc($v_doc);
		

	    // igk_js_load_script($this->m_Doc, igk_io_dir(dirname(__FILE__)."/".IGK_SCRIPT_FOLDER),'igk');
		// igk_js_load_script($this->m_Doc, igk_io_dir(IGK_APP_DIR."/".IGK_SCRIPT_FOLDER),'sys');
		// //load script from extendsions dir
		// igk_js_load_found_script($this->m_Doc, igk_io_dir(dirname(__FILE__)."/Ext"),'ext');

		//init registered script
		$t = igk_get_env("igk://globalScripts");
		if ($t){
			foreach($t as $k=>$v){
				$v_doc->addScript(realpath($k),'glo');
			}
		}
		
		///init lib on global script
		// igk_doc_reg_script($doc, IGK_APP_DIR."/Lib/tiny_mce/tiny_mce.js", );
		$v_doc->addScript(IGK_APP_DIR."/Lib/tiny_mce/tinymce.min.js", 'glo', false);
		$v_doc->setParam(IGK_DOC_ID_PARAM, "main_document");
	}

	private function storeDBConfigsSettingMenu()
	{
		$tab = $this->m_configMenuConf;
		$f = dirname(__FILE__)."/Data/config.menu.xml";
		if (file_exists($f))
		{
			$d =  igk_createNode("configmenu");
			foreach($tab as $k=>$v)
			{
				$s = $d->add($k);

				foreach($v as $c=>$cm)
				{
					$s->add($c)->Content = $cm;
				}
			}
			igk_io_save_file_as_utf8($f, $out, true);
		}
	}

	public function ViewControllers(){//app : shortcut to view controller
		IGKControllerManagerObject::getInstance()->ViewControllers();
	}

	public static function NavigateTo($url){
		igk_navto($url);
	}
	public static function InitStatic(){
		IGKApp::$REG_CSS_CLASS_EVT = strtolower("sys://event/".__CLASS__."/registercssclass");		
	}
}
IGKApp::InitStatic();




final class IGKAppContext {
	const running="running";
	const starting="starting";
	private function __construct(){
		//.ctr diseable constructor
	}
}


// final class IGKAppConfiguration extends IGKObject{
	// private $m_configs;
	// private $m_app;
	// public function __construct($app){
		// if ($app ==null)
			// throw  new Exception("app can't be null");
		// $this->m_app = $app;
		// $this->m_configs = array();
	// }
	// public function init(){
		// $this->setConfig("BASEDIR", IGK_APP_DIR);
	// }
	// public function getConfig($k){
		// return igk_getv($this->m_configs, $k);
	// }
	// public function setConfig($k, $v){
		// if ($v!=null)
			// $this->m_configs[$k] = $v;
		// else {
			// unset($this->m_configs[$k]);
		// }
	// }
// }

///<summary>represent system view mode </summary>
final class IGKViewMode extends IGKObject
{
	const VISITOR = 1;
	const WEBMASTER = 2;
	const ADMINISTRATOR=6;

	public static function GetSystemViewMode(){
		$m = igk_app()->getViewMode();
		$t = array();
		foreach(igk_get_class_constants(__CLASS__) as $k=>$v)
		{
			if (($m & $v) == $v)
				$t[] = $k;
		}
		return IGKString::Join($t, ',', false);
	}
	public static function  IsWebMaster(){
		return igk_app()->IsSupportViewMode(IGKViewMode::WEBMASTER);
	}
	public static function IsViewMode($mode){
		return igk_app()->IsSupportViewMode($mode);
	}
}


///<summary>represent the core json string convertor</summary>
final class IGKCoreJSon extends IGKObject{
	const ExpressionRegex = "\\{(?<expression>(.)+)\\}";
	private static function json_key($n){
		//igk_wln("cll ".$n);
		if (preg_match_all("/^(?P<delimiter>('|\")*)(?P<key>(.)+)\\1$/i", $n,$tab)){
			//igk_wln($tab);
			return $tab["key"][0];
		}
		return $n;
	}
	public function ToDictionary($expression){
		$h = igk_json_array_parse($expression);
		return igk_count($h)==1 && is_object($m=igk_getv($h, 0)) ? $m : $h;
	}
}


///<summary>represent global user Info</summary>
class IGKUserInfo extends IGKObject
{
	// var $authtable ;
	// var $grouptable;
	// var $groupauthtable ;
	// var $usertable;
	// var $usergrouptable;

	var $clId;
	var $clLogin;
	var $clPwd;
	public function getDbInfoKey(){
		return "sys://db/info";
	}

	public function __construct(){
	}

	public static function GetIsAuthorize($uinfo, $authname, $authCtrl=null, $adapter=IGK_MYSQL_DATAADAPTER){
		$s = $uinfo;
		// igk_wln($s);
		// exit();
		$k = $s->getDbInfoKey();
		$v_authtable = $s->$k->authtable;
		$v_grouptable = $s->$k->grouptable;
		$v_usergrouptable = $s->$k->usergrouptable;
		$v_groupauthtable = $s->$k->groupauthtable;

		if ($authCtrl!==null){
			$v_authtable = $authCtrl->AuthTable;
			$v_grouptable = $authCtrl->GroupTable;
			$v_usergrouptable = $authCtrl->UserGroupTable;
			$v_groupauthtable = $authCtrl->GroupAthTable;
		}
		// igk_wln($uinfo);
		return igk_db_is_user_authorized($uinfo, $authname, $v_authtable, $v_usergrouptable, $v_groupauthtable);

		 // if ($s == null)
                // return false;
            // if (igk_getv($s,"clLevel", 0) == -1){
				// igk_notifybox()->show("grant", "you have all access");
                // return true;//administrator have all access
			// }

            // $r = igk_db_table_select_where($v_authtable, array(IGK_FD_NAME=>$authname ));


            // if ($r && ($r->RowCount == 1))
            // {
			// // igk_wln("auth found ".$v_usergrouptable);
				// $v_r = false;
                // //get authorization id
                // $v_authid = $r->getRowAtIndex(0)->clId;
                // //find group that user is member of
                // $v_usergroup = igk_db_table_select_where($v_usergrouptable, array(IGK_FD_USER_ID=>$s->clId));
                // if ($v_usergroup)
				// {
					// foreach ($v_usergroup->Rows as $item)
					// {
						// //	igk_wln("check  ...".$authname. " ".$item->clGroup_Id . " ".$v_grouptable . " ".$v_groupauthtable);
						// $q = igk_db_table_select_where($v_groupauthtable, array (IGK_FD_GROUP_ID=>$item->clGroup_Id,
										   // IGK_FD_AUTH_ID=>$v_authid));
										   // // igk_wln("q ".$q);

						// if ($q && ($q->RowCount == 1))
						// {
						// // igk_wln("found ...");
							// $v_r = ($q->getRowAtIndex(0)->clGrant == 1);
							// if (!$v_r)
								// break;
						// }
					// }
				// }
                // return $v_r;
            // }
            // else
            // {
				// igk_db_insert( $adapter, $v_authtable, array(IGK_FD_NAME=>$authname));
            // }
		// return false;
	}

	public final function IsAuthorize($authname,$authCtrl=null, $adapter=IGK_MYSQL_DATAADAPTER){
		$s = $this;
		return self::GetIsAuthorize($s, $authname, $authCtrl, $adapter);
	}
	public function loadData($userTableData)
	{
		if ($userTableData){
		foreach($userTableData as $k=>$v){
			$this->$k  = $v;
		}
		}
	}
	public function toString(){
		return get_class($this);
	}
	public function __set($name, $value){//set user user info
		if (!$this->_setIn($name, $value))
			$this->$name = $value;
	}


	public function getGroups(){
		if ($this->clId){
			$tab = array();
			$db = igk_db_table_select_where($this->usergrouptable, array(IGK_FD_USER_ID=>$this->clId));
			foreach($db->Rows as $k=>$v){
				$rdb = igk_db_table_select_where($this->grouptable, array("clId"=>$v->clGroup_Id))->getRowAtIndex(0);
				if ($rdb){
					$tab[$rdb->clName] = $rdb;
				}
			}
			return $tab;
		}
		return null;
	}
	///get all available authorisation for this user
	public function getAuths(){
		if ($this->clId){
			$tab = array();
			//get all groups that match user
			$db = igk_db_table_select_where($this->usergrouptable, array(IGK_FD_USER_ID=>$this->clId));
			foreach($db->Rows as $k=>$v){

				$rdb = igk_db_table_select_where($this->groupauthtable, array(IGK_FD_GROUP_ID=>$v->clGroup_Id));
				if ($rdb){
					foreach($rdb->Rows as $a=>$b){
						if (!isset($tab[$b->clAuthId]))
						{
							$authinfo = igk_db_table_select_row($this->authtable, array("clId"=>$b->clAuthId));
							$authinfo->clGrant = $b->clGrant;

							$tab[$b->clAuthId] = $authinfo;
						}
						else
							$tab[$b->clAuthId]->clGrant = $tab[$b->clAuthId]->clGrant  && $b->clGrant;
					}
				}
			}
			return $tab;
		}
		return null;
	}
}
///<summary>Ob management utility class</summary>
final class IGKOb
{
	public static function Start()
	{
		ob_start();
	}
	public static function Clear(){
		ob_end_clean();
	}
	public static function Content()
	{
		return ob_get_contents();
	}
}

//-------------------------------------------------------------------------------------
//EXECPTION CLASS
//-------------------------------------------------------------------------------------
///<summary>represent a base IGK Framework execption</summary>
class IGKException extends Exception
{
	public static function GetCallingFunction($level=1)
	{
		$e = new Exception();
		$trace = $e->getTrace();
		//position 0 would be the line that called this function so we ignore it
		$last_call = $trace[$level];
		return (object)$last_call;
	}
	public function __toString(){
		return get_class($this);
	}
}

class IGKInvalidXmlReadException extends Exception{
	var $offset;
	public function __construct($msg, $offset=0){
		parent::__construct($msg);
		$this->offset=$offset;
	}
}


class IGKResourceNotFoundException extends IGKException
{
	private $m_file;
	public function getResourceFile(){
		return $this->m_file;
	}
	public function __construct($message, $file){		
		parent::__construct($message);
		$this->m_file = $file;
	}
}


///<summary> global registration class to register data table</summary>
final class IGKBalafonDBManager  extends IGKObject
{//context before session start
	static $sm_instance;
	private $m_regTables;
	public static function getInstance(){
		if (self::$sm_instance == null)
		{
			self::$sm_instance = new IGKBalafonDBManager();
		}
		return self::$sm_instance;
	}
	public function __toString(){
		return __CLASS__;
	}
	private function __construct(){
		$this->m_regTables = array();
	}
	public function register_db_table($tablenameinterface)
	{
		if (igk_reflection_interface_exists($tablenameinterface))
		{
			$this->m_regTables[$tablenameinterface] = $tablenameinterface;
		}
	}
	public function getCount(){
		return igk_count($this->m_regTables);
	}
}
abstract class IGKQueryResult extends IGKObject
{
	private $m_error;
	private $m_errormsg;
	protected function setError($error){
		$this->m_error = $error;
	}
	protected function setErrorMsg($msg){
		$this->m_errormsg = $msg;
	}
	public function getError(){
		return $this->m_error;
	}
	public function getHasError(){
		return !empty($this->m_error);
	}
	public function ResultTypeIsBoolean(){
		return $this->getResultType() == "boolean";
	}
	public function getResultType(){return "unknow"; }
	public function getValue(){return null;}
	public function getSuccess(){return false;}
	//create an empty entry for this query result
	public function createEmptyEntry(){ return null; }
	//
	public function getRows(){return null;}
	//return the number of columns in the result
	public function getColumns(){return null;}
	//return the number of rows in the result
	public function getRowCount(){return 0;}
	public function getHasRow(){ return ($this->getRowCount()>0); }
	///<summary>return the itarator that can be used to iterate shift onto an element</summary>
	public function getIterator(){
		 $t = new IGKIterator($this->getRows());
		 return $t;
	}
	///<summary>sort this result by </summary>
	public function SortBy($key, $asc=true){
		$t = new IGKSorter();
		$t->key = $key;
		$t->asc = $asc;
		$t->Sort($this);
		return $this;
	}
}


///<summary>represent an igk object data array</summary>
///<exemple>use to pass array parameter to a callback expression</exemple>
class IGKArray implements ArrayAccess{
	var $m_items;
	public function __construct(){
		$this->m_items = array();
	}
	public function offsetExists($key){
		return isset($this->m_items[$key]);
	}
	public function offsetGet($key){
		return $this->m_items[$key];
	}
	public function offsetSet($key, $value){//IGKHtmlChildElementCollections
		$this->m_items[$key] = $value;

	}
	public function offsetUnset($key){
		unset($this->m_items[$key]);
	}
	public function getCount(){
		return igk_count($this->m_items);
	}
}

///<summary>used to iterate thru an array
final class IGKIterator extends IGKObject implements ArrayAccess, Iterator, Countable
{
	private $m_target;
	private $m_index;
	private $m_viewCount;
	private $m_it_key;
	private $it_vtab;
	private $it_index;
	private $m_count;

	public function setrewindStart($i){
		$this->m_index = $i;
	}

	public function __construct($ob){
		$this->m_target = $ob;
		$this->m_count = igk_count($ob);
		$this->m_index = 0;
	}
	public function count(){
		return igk_count($this->m_target);
	}
	public function Shift($index, $count= null){
		$this->m_index = $index;
		if ($count && is_numeric($count)){
			$this->m_count = min( $index + $count,  igk_count($this->m_target));
		}
	}

	function current(){ return $this->m_target[$this->m_it_key];}
	function next(){
		$this->it_index++;
		if ( $this->it_index < $this->m_count)
		{
			$this->m_it_key  = $this->it_vtab[$this->it_index];
		}
	}
	function key(){ return $this->m_it_key;}

	function valid(){

		$v = ($this->it_index >= 0) && ($this->it_index < $this->m_count);
		return $v;

	}
	function rewind(){

		$this->it_vtab = array_keys($this->m_target);
		$this->it_index = $this->m_index;
		$c = count($this->it_vtab);
		if (( $c>0 )&& ($this->m_index <= $c))
		{
			$this->m_it_key = $this->it_vtab[$this->m_index];
		}
		else{
			$this->m_it_key  = null;
		}
	}

	//arrayaccess
	function offsetExists($key){
	return isset($this->m_target[$key]);
	}
	public function offsetGet($key){//iterator offset get
	if (isset($this->m_target[$key]))
		return $this->m_target[$key];
	}
	function offsetSet($key, $value){//nothing
	}
	function offsetUnset($key){//nothing
	}
}

final class IGKValidator extends IGKObject
{
	private $sm_enode;
	private $sm_cibling;

	static $sm_instance;
	private function __construct()
	{
		$this->sm_enode =  igk_createNode("error");
		$this->sm_cibling = array();
	}
	public static function IsValidPwd($o){
		if ((is_string($o) && strlen($o)>=6))
		{
			return true;
		}
		return false;
	}
	public static function Validate($o, $fields, & $error)
	{
		$g = self::getInstance()->sm_enode;
		$g->ClearChilds();
		$e = false;
		if (is_array($fields))
		{
			foreach($fields as $k=>$v)
			{
				$s = $o->$k;
				$cond = call_user_func_array(array(__CLASS__, $v["f"]), array($s));
				self::Assert($cond, $e, $g, $v["e"]);
			}
		}

		return !$e;
	}
	public static function IsIpAddress($p){
		return preg_match(IGK_IPV4_REGEX, trim($p));
	}

	public static function getInstance()
	{
		if (self::$sm_instance == null)
		{
			self::$sm_instance = igk_get_class_instance(__CLASS__, function(){
					return new IGKValidator();
			});
		}
		return self::$sm_instance;

	}
	public static function Cibling()
	{
		return self::getInstance()->sm_cibling;
	}
	public static function ContainCibling($name)
	{
		$e = self::getInstance();
		return isset($e->sm_cibling[$name]);
	}
	public static function AddCibling($name)
	{
		$e = self::getInstance();
		$t =explode(",",$name) ;

		foreach($t as $k=>$v){
			$e->sm_cibling[$v]=1;
		}
	}
	public static function Error(){
		$e = self::getInstance();
		return $e->sm_enode;
	}
	public static function Init(){
		$e = self::getInstance();
		$e->sm_enode->ClearChilds();
		$e->sm_cibling = array();
	}
	public static function Assert($condition, & $error, $node = null, $errormsg=IGK_STR_EMPTY)
	{
		if ($condition)
		{
			$error = $error || true;
			if ($node!=null)
			{
				$node->addLi()->Content = $errormsg;
			}
		}
	}
	///<summary>check is null or empty.</summary>
	public static function IsStringNullOrEmpty($v, $cibling=null, $msg="error...")
	{
		$v =  (($v==null) || (is_string($v) && (strlen($v)==0)));
		if ($v && $cibling){
			$cibling->addError($msg);
		}
		return $v;
	}
	public static function IsEmail($mail){
		if(self::IsStringNullOrEmpty($mail))
			return false;
		return preg_match('/[a-z0-9\.\-_]+@[a-z0-9\.\-_]+\.[a-z]{2,6}$/i',  $mail);

	}
	public static function IsInt($v){
		return is_numeric($v);
	}
	public static function IsDate($v){
	}
	public static function IsFloat($v){
		return is_float($v);
	}
	public static function IsDouble($v){
		return is_Double($v);
	}
	public static function IsString($v)
	{
		return is_string($v);
	}
	public static function IsUri($v){

		if (empty($v))
			return false;

		//$r = preg_match('/^((http(s){0,1}):\/\/([\w\.0-9]+)|(\?))/i',  $v);
		$r = preg_match('/^(((http(s){0,1}):)?\/\/([\w\.0-9]+)|(\?))/i',  $v);

		return $r;

	}

}

///<summary> IGKServerInfo: Represent the server utility method</summary>
final class IGKServerInfo
{
	/// get if this server runing on the loal server
	public static function IsLocal()
	{
		$v_saddr = self::ServerAddress();
		$v_srddr = self::RemoteIp();
		$v = ($v_srddr == "::1") || ($v_saddr == $v_srddr ) || preg_match("/^127\.(.)/i",$v_saddr); //|| IGKString::StartWith($v_srddr, "192.168");
		return $v;
	}
	public static function ServerAddress(){return  igk_gettv( igk_getv($_SERVER,"SERVER_ADDR"), null); }
	public static function RemoteIp(){return igk_gettv(igk_getv($_SERVER, "REMOTE_ADDR"),null); }

	public static function IsIGKDEVSERVER(){
		$r = igk_getv($_SERVER, "HTTP_USER_AGENT");
		if (strstr($r, IGK_SERVERNAME)){
			return true;
		}
		return false;
	}
}

class IGKUserAgent{
	const REGEX_ANDROID = "android";
	const REGEX_ANDROID_VERSION = "android\s+(?P<version>[0-9\.]+);";
	const REGEX_ANDROID_MODELNUMBER = "android\s+(?P<version>[0-9\.]+);\s*(?P<model>[\w0-9\.]+)\s*";
	const REGEX_ANDROID_BUILDNUMBER = "android\s+(?P<version>[0-9\.]+);\s*(?P<model>[\w0-9\.]+)\s+build\/(?P<buildnumber>[a-z0-9\.]+)";

	public static function Agent(){ return igk_getv($_SERVER, "HTTP_USER_AGENT"); }
	public static function IsAndroid(){
		$regex = "/".self::REGEX_ANDROID."/i";
		return preg_match( $regex,  self::Agent());
	}
	public static function IsXBox(){
		$regex = "/xbox/i";
		return preg_match( $regex,  self::Agent());
	}
	public static function IsXBoxOne(){
		$regex = "/xbox one/i";
		return preg_match( $regex,  self::Agent());
	}
	public static function IsMobileDevice(){
		return self::IsAndroid();
	}
	public static function GetAndroidVersion(){
		if (self::IsAndroid()){

			$regex = "/".self::REGEX_ANDROID_VERSION."/i";
			$tab = array();
			preg_match_all( $regex,  self::Agent() ,$tab);

			return $tab["version"][0];
		}
		return null;
	}
	public static function GetAndroidModel(){
		if (self::IsAndroid()){
			$regex = "/".self::REGEX_ANDROID_MODELNUMBER."/i";
			$tab = array();
			preg_match_all( $regex,  self::Agent() ,$tab);
			return $tab["model"][0];
		}
		return null;
	}
	public static function GetAndroidBuildNumber(){
		if (self::IsAndroid()){
			$regex = "/".self::REGEX_ANDROID_BUILDNUMBER."/i";
			$tab = array();
			preg_match_all( $regex,  self::Agent() ,$tab);
			return $tab["buildnumber"][0];
		}
		return null;
	}
	public static function GetDefaultLang(){
		$regex = "/^(?P<name>\w+)(,*)/i";
		$tab = array();

		$r = igk_getv($_SERVER, "HTTP_ACCEPT_LANGUAGE");
		if ($r){
			preg_match_all( $regex,  $r ,$tab);

			return $tab["name"][0];
		}
		return IGK_DEFAULT_LANG;
	}

	public static function IsIE()
	{
		if (isset($_SERVER["HTTP_USER_AGENT"]))
		{
			return preg_match("#(MSIE|Trident/|Edge/)#i", $_SERVER["HTTP_USER_AGENT"]);
			// if (strstr($_SERVER["HTTP_USER_AGENT"],"MSIE"))
				// return true;
			return false;
		}
		return false;
	}
	public static function IsIOS(){
		return false;
	}
	public static function IsChrome()
	{
		if (isset($_SERVER["HTTP_USER_AGENT"]))
		{
			if (strstr($_SERVER["HTTP_USER_AGENT"],"Chrome"))
				return true;
			return false;
		}
		return false;
	}
	public static function GetChromeVersion()
	{
		if (self::IsChrome())
		{
			$v_r= "/Chrome\/\s*(?P<version>[0-9\.]+)\s/i";
			$tab = array();
			preg_match_all( $v_r,  self::Agent() ,$tab);
			return $tab["version"][0];
		}
		return null;
	}
	public static function IsSafari()
	{
		if (isset($_SERVER["HTTP_USER_AGENT"]))
			{
				if (strstr($_SERVER["HTTP_USER_AGENT"],"Safari"))
					return true;
				return false;
			}
			return false;
	}
	public static function GetSafariVersion()
	{
		if (self::IsSafari())
		{
			$v_r= "/Safari\/\s*(?P<version>[0-9\.]+)(\s*)/i";
			$tab = array();
			preg_match_all( $v_r,  self::Agent() ,$tab);
			return $tab["version"][0];
		}
		return null;
	}
	public static function IsMod()
	{
		if (isset($_SERVER["HTTP_USER_AGENT"]))
			{
				if (strstr($_SERVER["HTTP_USER_AGENT"],"Firefox"))
					return true;
				return false;
			}
			return false;
	}

}

///<summary>represent a event method pointer</summary>
class IGKEvents extends IGKObject
{
	private $m_methods;
	private $m_singlemethod;
	private $m_owner;
	private $m_name;

	//system new event
	const VIEWCOMPLETE=0x1;

	public function getOwner(){return $this->m_owner;}
	public function getName(){return $this->m_name; }
	public function getMethodCount(){return igk_count($this->m_methods); }
	public function getInfo(){
		return $this->__toString() . " count # ".igk_count($this->m_methods);
	}
	public function __toString(){
		return __CLASS__."[".$this->m_name.";for[". get_class($this->m_owner)."]]";
	}
	///get the number of method in this events
	public function getCount(){
		return count($this->m_methods);
	}
	public function getIsDebugging(){
		return igk_get_env("sys://event/isdebugging/".$this->m_name, 0);//, IGK_EVENT_IS_DEBUG;
	}
	public function setIsDebugging($v){

	}
	public function __construct($owner, $name, $single=false)
	{
		$this->m_owner = $owner;
		$this->m_methods =  array();
		$this->m_singlemethod = $single;
		$this->m_name = $name;
	}
	public function Clear()
	{
		//unset($this->m_methods);
		$this->m_methods = array();
	}
	///<summary>register a class method to this</summary>
	///<param class="class">mixed class or callable</param>
	///<param class="method">if class method is a name</param>
	public function add($class, $method=null){
		//igk_wln("add __ ".$this->m_name . " ::: ".$this->m_singlemethod);

		if ($this->m_singlemethod)
		{

			if ($this->Count() >= 1)
			{
				$this->Clear();
			}
		}
		//$this->Clear();
		$_info = null;
		//create an appMethodInfo for class
		$_info = IGKAppMethod::Create($class, $method, $this);


		if ($_info)
		{
			//test if already registered
			if (!$_info->IsRegistered($this->m_methods, $this))
			{
				// igk_debug_wln($_info);
				$this->m_methods[]= $_info;
				$_info->setParentEvent($this);
				return $_info;
			}else{
				//igk_debug_wln("event info is not registered .[[".$this->m_name. "]] - " . $this->m_owner . " ".get_class($this->m_owner) ." for ".$class . igk_get_env("LoadFOR"));
				//igk_ilog("Event already registered [".$this->m_name. "] - your component is aparently removed or multiple instance of it ");
				return null;
			}
		}else{
			//igk_debug_wln("can't create method");
			igk_die("can't add event info is null.[== ".$this->m_name . " ".$method);
		}
		return null;

	}
	//remove menthod
	public function remove($class, $method)
	{
		for($i = 0 ; $i<count($this->m_methods) ; $i++)
		{
			$k = $this->m_methods[$i];
			if ($k->match($class, $method))
			{
				$meth = $this->m_methods[$i];
				unset($this->m_methods[$i]);
				$this->m_methods = array_values($this->m_methods);
				$k->setParentEvent(null);
				return 1;
			}
		}
		return 0;
	}
	//remove an object used for call bkc;
	public function removeObject($obj, $name=IGK_FUNC_KEY){
		$tab = array();
		$r = 0;
		for($i = 0 ; $i<count($this->m_methods) ; $i++)
		{
			$meth = $this->m_methods[$i];
			if ($meth->matchParam($name, $obj)){
				$r = 1;
				$meth->setParentEvent(null);
				continue;
			}
			$tab[] = $meth;
		}
		$this->m_methods = $tab;
		return $r;
	}

	///<summary>invoke resgistrated method</summary>
	public function Call($sender, $args)
	{
		if ($this->m_methods)
		{
			foreach($this->m_methods as $k=>$v){
				$v->Invoke($sender, $args);
			}
		}
	}

	///<summary>enumerate registrated methods</summary>
	public function enumerateMethod($callback){
		foreach($this->m_methods as $k){
			$callback($k);
		}
	}

}
///<summary>
///represent a language key entries. it support IIGKHtmlGetValue for getting and setting the values
///<summary>
final class IGKLangKey implements IIGKHtmlGetValue
{
	var $key;
	var $default;
	var $args;

	public function __construct($key,$default, $args=null)
	{
		if (empty($key))
			igk_die("key is null or empty");
		$this->key = strtolower($key);
		$this->default = $default;
		$this->args = $args;
	}
	public function __toString(){
		return $this->key;
	}
	public function getValue($options=null){//get lang key value

		$s = R::gets($this->key);
		$c = 0;
		if ($this->args != null)
		{
			$macth = array();
			//match
			$c = preg_match_all("/\{(?P<value>[0-9]+)\}/i",$s, $match);

			for($i = 0; $i < $c ; $i++)
			{
				$index = $match["value"][$i];
				if (is_numeric($index))
				{
					if (isset($this->args[$index]))
					{
						$s = str_replace( $match[0][$i], IGKHtmlUtils::GetValue($this->args[$index]),$s);
					}
				}
			}
		}
		if ($s == strtolower($this->key) && igk_app()->IsSupportViewMode(IGKViewMode::WEBMASTER)){
			$s = "<span class=\"igk-new-lang-key\" igk-new-lang-key=\"1\" >".$s."</span>";
		}
		return html_entity_decode($s);
	}
}

final class IGKLangExpression extends IGKObject
implements IIGKHtmlGetValue
{
	private $m_keys;
	public function __construct($keys)
	{
		if (!is_array($keys) || (igk_count($keys) == 0))
			igk_die("keys is not an array");
		$this->m_keys = $keys;
	}
	public function getValue($options=null){
		$nl = R::GetCurrentLang();
		return igk_getv($this->m_keys, $nl, igk_getv(array_values($this->m_keys), 0));
	}
}


final class IGKFormatString implements IIGKHtmlGetValue
{
	private $m_args;
	private $m_v;
	private function __construct()
	{
	}
	public static function Create($string)
	{
			$args = array();
			if (func_num_args() > 1)
			{
				$t = func_get_args();
				for($i=1; $i< count($t) ; $i++)
				{
					$args[] = $t[$i];
				}
			}
			$cfrm = new  IGKFormatString();
			$cfrm->m_args = $args;
			$cfrm->m_v = $string;

			return $cfrm;
	}
	public function getValue($options=null)
	{
		$s = $this->m_v;
		if ($this->m_args != null)
		{
			$macth = array();
			$c = preg_match_all("/\{(?P<value>[0-9]+)\}/i",$s, $match);
			for($i = 0; $i < $c ; $i++)
			{
				$index = $match["value"][$i];
				if (is_numeric($index))
				{
					if (isset($this->m_args[$index]))
					{
						$m = $this->m_args[$index];
						if (is_string($m))
						{
							$s = str_replace( $match[0][$i], $m ,$s);
						}
						else if (is_object($m) && method_exists(get_class($m), IGK_FC_GETVALUE))
						{
							$s = str_replace( $match[0][$i], $m->getValue() ,$s);
						}
						else {
							$s = str_replace( $match[0][$i], '' ,$s);
						}
					}
					else{
						$s = str_replace( $match[0][$i], '' ,$s);
					}
				}
			}

		}
		return $s;
	}

	public function __toString(){
		return $this->getValue();
	}
}

///<summary>format string value</summary>
final class IGKFormatGetValueString extends IGKObject implements IIGKHtmlGetValue
{
	private $m_obj;
	private $m_member;
	private function __construct(){
	}
	public static function Create($obj, $property)
	{
		if (!is_object($obj))
			return null;

		$out = new IGKFormatGetValueString();
		$out->m_obj = $obj;
		$out->m_member = $property;
		return $out;
	}
	public function getValue($options=null)
	{
		$c = $this->m_member;
		$v = $this->m_obj->$c;
		return IGKHtmlUtils::GetValue($v);
	}
	public function __toString(){
		return "IGKFormatGetValueString::"+$this->getValue();
	}
}

///<summary>Represent a APP METHOD. Used in event invocation</summary>
final class IGKAppMethod
{
	// private $_class;
	// private $_object;
	// private $_methodname;
	// private $_index;
	// private $_type;
	// private $_parentEvent;
	// private $_func; // for closure function
	// private $_callable;
	// private $_keyid; //store the key id of this app method. used to reference in CALLABLE_USER_FUNC

	const OBJECT_METHOD =  1;
	const CLASS_METHOD = 2;
	const FUNCTION_METHOD = 3;
	const OBJECT_METHOD_CLOSURE = 4;
	const CALLABLE_FUNC = 8;
	const CALLABLE_USER_FUNC  =16;
	const METHNAME  =32;
	const C_CLASS  =33;
	const C_METHODN  =34;
	const C_OBJN  =35;
	const C_PEVN  =36;
	const C_CALLABLEN  =37;
	const C_IDN  =38;

	private $m_fs;

	public function getParentEvent(){return $this->m_fs->getFlag(self::C_PEVN, $n); }
	public function setParentEvent($n){ 		$this->m_fs->setFlag(self::C_PEVN, $n); }


	public function getType(){
		return $this->m_fs->getFlag(-1);//self::CLASS_METHOD);
	}

	public function setType($t){
		$this->m_fs->setFlag(-1, $t);
	}
	public function setClass($n){
		$this->m_fs->setFlag(self::C_CLASS, $n);
	}
	public function getClass(){
		return $this->m_fs->getFlag(self::C_CLASS);//self::CLASS_METHOD);
	}
	public function setMethodName($n){
		$this->m_fs->setFlag(self::C_METHODN, $n);
	}
	public function getMethodName(){
		return $this->m_fs->getFlag(self::C_METHODN);//self::CLASS_METHOD);
	}


	public function setObject($n){
		$this->m_fs->setFlag(self::C_OBJN, $n);
	}
	public function getObject(){
		return $this->m_fs->getFlag(self::C_OBJN);//self::CLASS_METHOD);
	}


		public function setCallable($n){
		$this->m_fs->setFlag(self::C_CALLABLEN, $n);
	}
	public function getCallable(){
		return $this->m_fs->getFlag(self::C_CALLABLEN);//self::CLASS_METHOD);
	}

		public function setId($n){
		$this->m_fs->setFlag(self::C_IDN, $n);
	}
	public function getId(){
		return $this->m_fs->getFlag(self::C_IDN);//self::CLASS_METHOD);
	}

	///<summary>check if this match the target param</summary>
	public function matchParam($paramname, $obj){
		return igk_getv($this->getClass()->clParam,$paramname) === $obj;
	}
	private function _typeToString()
	{
		switch($this->getType())
		{
			case self::OBJECT_METHOD:
					return "OBJECT_METHOD";

			case self::CLASS_METHOD:
					return "CLASS_METHOD";

			case self::FUNCTION_METHOD:
					return "FUNCTION_METHOD";

			case self::OBJECT_METHOD_CLOSURE:
				return "CLOSURE_METHOD";

			case self::CALLABLE_FUNC:
				return "CALLABLE";

			case self::CALLABLE_USER_FUNC:
				return "CALLABLE_USER_FUNC";

		}
		return "TYPEUNKNOW";
	}
	public function __toString(){
		$v_pattern = IGK_STR_EMPTY;
		switch($this->getType())
		{
			case self::OBJECT_METHOD:
					return "IGKAppMethod[FOR OBJECT METHOD]";//.$this->getType()."::".$this->_object."::".$m."]";
			break;
			case self::CLASS_METHOD:
					return "IGKAppMethod[".$this->getType()."::".$this->_class."::".$m."]";
			break;
			case self::FUNCTION_METHOD:
					return "IGKAppMethod[".$this->getType()."::".$m."]";
					break;
			case self::OBJECT_METHOD_CLOSURE:
					$v_pattern = "CLOSURE =&gt; ".$this->getType();
					break;
			case self::CALLABLE_FUNC:
				$v_pattern = $m;
					break;
			case self::CALLABLE_USER_FUNC:
				$v_pattern = "CALLABLE USER FUNC";
					break;
		}
		return "IGKAppMethod[".$v_pattern ."]";
	}
	private  function __construct()
	{
		$this->m_fs = new IGKFv();
		// _class =null;
		// $m= null;
	}
	public function match($class_or_object, $method)
	{
		$_cl = $this->getClass();
		$m = $this->getMethodName();
		$_obj = $this->getObject();
		switch($this->getType())
		{
			case self::OBJECT_METHOD:
				return (($class_or_object === $_obj) &&  ($m == $method));
			break;
			case self::CLASS_METHOD:
				//return call_user_func(array(	$_cl, $m), $sender, $args);
			break;
			case self::FUNCTION_METHOD:
				return ($m == $method);
			break;
			case self::CALLABLE_FUNC :
						return $m($sender,  $args);
					break;
			case self::CALLABLE_USER_FUNC:
				break;
		}
		return (($class_or_object === 	$_cl) &&  ($m == $method));
	}

	///<summary>create a IGKAppMethodInfo</summary>
	public static function Create($class_or_object, & $method, $event)
	{
		$c = $class_or_object;
		$out = null;

		if (($method === null) && igk_is_callable($c))
		{
			$out = new IGKAppMethod();
			$out->setType(self::CALLABLE_USER_FUNC);
			$out->setCallable($c);
			$out->setClass($c);
			$out->setId(igk_callable_id($c));

			//igk_wln("key id : ".$out->_keyid);
		//	exit;
		}
		else{


		if (is_object($c))
		{
			if (is_string($method))
			{
				if (method_exists($c, $method))
				{
					//create a objet IGKAppMethod
					$out = new IGKAppMethod();
					$out->setType( self::OBJECT_METHOD);
					$out->setMethodName( $method);
					$out->setClass(get_class($c));
					$out->setObject($c);
				}
				else if (is_callable($method))
				{
					$out = new IGKAppMethod();
					$out->setType( self::CALLABLE_FUNC);
					$out->setMethodName( $method);
					// $out->_class = IGK_STR_EMPTY;
					// $out->_object = $c;

					$out->setClass(IGK_STR_EMPTY);
					$out->setObject($c);
				}
			}

		}
		else {
			if (class_exists($c))
			{

				if (method_exists($c, $method))
				{

					$out = new IGKAppMethod();
					$out->setType(self::CLASS_METHOD);
					$out->setMethodName( $method);
					$out->setClass($c);
				}

			}
			else if (function_exists($c))
			{
				$out = new IGKAppMethod();
				$out->setType(self::FUNCTION_METHOD);
				$out->setMethodName($method);
			}
		}
		}
// igk_wln("data ....".$out);
		return $out;
	}
	public function Invoke($sender, $args)
	{
		// igk_debug_wln("Invoke Type : ".$this->_type);
		// igk_debug_wln("Invoke Type : ".$sender);
		//igk_debug_wln($this->_callable);

		//----------------------------------------------------------------------------
			try{
				$extra = array($sender, $args);
				$m = $this->getMethodName();
				$o = $this->getObject();
				switch($this->getType())
				{
					case self::CALLABLE_USER_FUNC:
						$c = $this->getCallable();
						if (igk_is_callback_obj($c)){

							// igk_debug_wln("invoke callback");
							return igk_invoke_callback_obj(null, $c, $extra);
						}
						return call_user_func_array($c, $extra);
						break;
					case self::OBJECT_METHOD:

						if (method_exists(get_class($o), IGK_FUNC_CALL_IN_CONTEXT))
						{
							return $o->call_incontext($m, $extra);
						}
						else
							return call_user_func_array(array($o, $m),$extra);
					break;
					case self::CLASS_METHOD:
					$c = $this->getClass();
						return call_user_func_array(array($c, $m), $extra);
					break;
					case self::FUNCTION_METHOD:
						return call_user_func($m, $sender, $args);
					break;
					case self::CALLABLE_FUNC:
						if (function_exists($m)){
							// igk_wln("invo kkkkk pppppppp");
							return $m($sender, $args);
						}
						else{
							if ($o && method_exists($this->_object ,'invokeInContext'))	{
								return $o->invokeInContext($m, array($sender, $args));
							}
						}
					break;
				}
		}
		catch(Exception $ex){
			igk_show_exception($ex);
			igk_wln("IGKAppMethod::Invoke exception raised Method:[".$this->_typeToString()." ; ".$m."]" . $this->__toString());
			igk_exit();
		}
	}
	public function getIdKey(){
		$m = $this->getMethodName();
		switch($this->getType() ){
			case self::OBJECT_METHOD:
				$o = $this->getObject();
				return get_class($o)."::!>".$m."@".spl_object_hash($o);
			case self::CLASS_METHOD:
				return $this->getClass()."::>".$m;
			case self::FUNCTION_METHOD:
				return $m;
			case self::CALLABLE_USER_FUNC:
				return $this->getId();
		}
		return null;
	}
	public function IsRegistered($tab, $event)
	{
	if ($tab==null)
		return false;
		if ($this->getType() == self::CALLABLE_FUNC)
		{
			foreach($tab as $k=>$v)
			{
				if ($v->getMethodName() == $m)
				{
					igk_ilog(__CLASS__, "try to register method name twice is not allowed.[".$m."]:::".$event->Name);
					return true;
				}
			}
			return false;
		}
		//search default key
		$idkey = $this->getIdKey();
		foreach($tab as $k=>$v){
			if ($v->getIdKey() === $idkey){
				igk_ilog(!igk_sys_env_production(),"failed to register {$idkey} - key already in collection. ".$idkey);
				igk_die("base");
				return true;
			}
		}
		return false;
	}

	public function __set($n,$v){
		igk_die("setting ".$n);
	}

	public function __call($d, $v){
		igk_die("call ".$d);
	}
	public function __sleep(){
		$t = igk_reflection_get_member($this);
		 if ($this->m_fs->isEmpty()){
			 unset($t["\0".__CLASS__."\0m_fs"]);
		}
		return array_keys($t);
	}
}

///<summary>represent IO management class utility</summmary>
final class IGKIO{

	public static function ReadFile($f, $offset, $ln)
	{
		if (!file_exists($f))
			return null;
		$fsize = filesize($f);
		$ln = min($ln, $fsize - $offset);
		if ($ln > 0)
		{
			$hf  = fopen($f, "r");
			fseek($hf, $offset);
			$o = fread($hf, $ln);
			fclose($hf);
			return $o;
		}
		return null;
	}
	///<summary> get relative path according to the IGK_APP_DIR</summary>
	///<param name="dir">must be a full path to existing file or  existing directory </param>
	public static function GetBaseDirRelativePath($dir, $separator = DIRECTORY_SEPARATOR)
	{
		$doc_root = IGKIO::GetBaseDir();
		return self::GetSysRelativePath($dir, $doc_root,$separator	);
	}
	public static function GetSysRelativePath($dir, $doc_root,$separator = DIRECTORY_SEPARATOR)
	{
		if (empty($dir) || empty($doc_root))
			return null;

		$i = IGKString::IndexOf($dir, $doc_root);
		if ($i != -1)
		{
			//// remove the base dir
			$dir = igk_str_rm_start(substr($dir, $i + strlen($doc_root)), $separator);
			return $dir;
		}
		//find base dir of the path
		$p = "../";
		$found = false;
		while( !empty($doc_root))
		{
			$doc = dirname($doc_root);
			if ($doc==$doc_root)
			{
				break;
			}
			$doc_root= $doc;
			$i = IGKString::IndexOf($dir, $doc_root);
			if ($i == -1){
				$p .= "../";
			}
			else {
				$found = true;
				break;
			}

		}
		if ($found){
			$dir = igk_str_rm_start(substr($dir, $i + strlen($doc_root)), $separator);
			return igk_io_dir($p.$dir);
		}
		return null;
	}

	public static function CopyFiles($inputDir, $outputDir , $recursive=false, $overwrite=false)
	{
		$hdir = opendir($inputDir);
		if ($hdir)
		{
			while(($r = readdir($hdir)))
			{
				if ($r=="." || ($r==".."))continue;
				$f = self::GetDir($inputDir . DIRECTORY_SEPARATOR . $r);
				$p  = self::GetDir($outputDir .DIRECTORY_SEPARATOR . $r);

				if (file_exists($p) ==false)
					copy($f, $p);

			}
			closedir($hdir);
		}
	}
	public static function GetFiles($dir, $match, $recursive=false)
	{
		if (is_dir($dir) === false)
			return null;

		$v_out = array();
		//: no recursivity
		$q = 0;
		$dirs = array();
		array_push($dirs, $dir);
		$iscallable = is_callable($match);
		while( $q = array_pop($dirs)){

			$hdir = @opendir($q);


			while(($r = readdir($hdir)))
			{
				if ($r=="." || ($r==".."))continue;
				$f =igk_io_dir( $q . DIRECTORY_SEPARATOR . $r);
				if (!is_dir($f) &&  ( ($iscallable && $match($f)) ||  ($match==null) || (is_string($match) &&  preg_match($match, $f)))){
					$v_out[] = $f;
				}
				else{
					if(is_dir($f) && $recursive){						
						array_push($dirs, $f);
					}
				}
			}
			closedir($hdir);
		}

		return $v_out;



		//: recursivity

		$hdir = @opendir($dir);

		if ($hdir)
		{
			if (is_callable($match)){
				while(($r = readdir($hdir)))
				{
					if ($r=="." || ($r==".."))continue;
					$f =igk_io_dir( $dir . DIRECTORY_SEPARATOR . $r);
					if (is_file($f) && $match($f))
					{
						$v_out[] = $f;
					}
					else if(is_dir($f) && $recursive)
					{
						foreach(IGKIO::GetFiles($f, $match, $recursive) as $k)
						{
							$v_out[] = $k;
						}
					}
				}
			}else{

				while(($r = readdir($hdir)))
				{
					if ($r=="." || ($r==".."))continue;
					$f =igk_io_dir( $dir . DIRECTORY_SEPARATOR . $r);
					if (is_file($f) && (($match==null) || (($match!=null) && ( preg_match($match, $f)))))
					{
							$v_out[] = $f;
					}
					else if(is_dir($f) && $recursive)
					{
						foreach(IGKIO::GetFiles($f, $match, $recursive) as $k)
						{
							$v_out[] = $k;
						}
					}
				}
			}
			closedir($hdir);
		}

		return $v_out;

	}

	public static function GetDirs($dir, $match, $recursive=false)
	{
		if (is_dir($dir) === false)
			return null;

		$v_out = array();

		$hdir = @opendir($dir);

		if ($hdir)
		{
			while(($r = readdir($hdir)))
			{
				if ($r=="." || ($r==".."))continue;
				$f = $dir . DIRECTORY_SEPARATOR . $r;
				if (is_dir($f) && (($match==null) || (($match!=null) && ( preg_match($match, $f)))))
				{
						$v_out[] = $f;
				}
				if($recursive)
				{
					foreach(igk_io_dirs($f, $match, $recursive) as $k)
					{
						$v_out[] = $k;
					}
				}
			}
			closedir($hdir);
		}

		return $v_out;

	}


	//utility fonction get picture files
	public static function  GetPictureFile($dir, $recursive=true)
	{
		if (is_dir($dir) === false)
			return null;
		$tab = array();
		$tdir = array();
		$hdir = opendir($dir);
		if ($hdir)
		{
			while(($r = readdir($hdir)))
			{
				if ($r=="." || ($r==".."))continue;
				$f = $dir . DIRECTORY_SEPARATOR . $r;
				if (is_file($f) )
				{
					$ext = strtolower(IGKIO::GetFileExt($f));

					switch($ext)
					{
						case "png":
						case "jpeg":
						case "jpg":
						case "ico":
							$tab[] = $f;
							break;

					}
				}
				else if(is_dir($f))
				{
					$tdir[] = $f;
				}
			}
			closedir($hdir);
		}
		if ($recursive){
			foreach($tdir as $k)
			{
				$m= self::GetPictureFile($k);
				if ($m!=null){
					$tab = array_merge($tab, $m);
				}
			}
		}
		return $tab;
	}
	public static function GetFileSize($size)
	{
		if ($size == 0)
			return "0 Bytes";
		$sizes = array('Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB');
		return (round($size/pow(1024, ($i = floor(log($size, 1024)))), 2) . ' ' . $sizes[$i]);

	}
	public static function IsDirEmpty($dir)
	{
		if (!is_dir($dir))
			return true;

		$hdir = @opendir($dir);
		if ($hdir)
		{
			$empty = true;
			while( $s = readdir($hdir))
			{
				if (($s==".") || ($s==".."))
					continue;
				$empty = false;
				break;
			}
			closedir($hdir);
			return $empty;
		}
		else{
			igk_debug_wln("warning:impossible d'ouvir le repertoire : ".$dir);
		}
		return true;
	}
	//return a directory list
	public static function GetDirList($folder)
	{
		if (!is_dir($folder))
			return false;
		$dirs = array();
			$hdir = opendir($folder);
			if ($hdir)
			{
				while( ($cdir=readdir($hdir)))
				{
					if (($cdir== ".") || ($cdir==".."))
						continue;
					$f = self::GetDir($folder."/".$cdir);
					if (is_dir($f))
					{
						$dirs[] = $f;
					}
				}
				closedir($hdir);
			}
		return $dirs;
	}

	//return a directory file list
	public static function GetDirFileList($folder)
	{
		if (!is_dir($folder))
			return false;
		$dirs = array();
			$hdir = opendir($folder);
			if ($hdir)
			{
				while( ($cdir=readdir($hdir)))
				{
					if (($cdir== ".") || ($cdir==".."))
						continue;
					$f = self::GetDir($folder."/".$cdir);
					if (is_file($f))
					{
						$dirs[] = $f;
					}
				}
				closedir($hdir);
			}
		return $dirs;
	}
	public static function GetCurrentDir()
	{
		// $tb = get_included_files();
		// return dirname($tb[0] );
		return getcwd();
	}
	public static function RemoveFirstDirectorySeparator($dir)
	{
		while((!empty($dir) && ($dir[0] == DIRECTORY_SEPARATOR)))
		{
			$dir = substr($dir, 1);
		}
		return $dir;
	}
	public static function CreateDir($dirname, $mode=IGK_DEFAULT_FOLDER_MASK){
		return igk_io_createdir($dirname, $mode);
	}
	///<summary> Create a directory recursivily</summary>
	///<dir>directory to create</dir>
	///<root>mus add a as directory separator </root>
	///<return>-1 if dir is empty, </return>
	public static function CreateRDir($dir, $root=false)
	{
		if (empty($dir))
		{
			return -1;
		}
		if (is_dir($dir))
			return 1;
		$d = explode(DIRECTORY_SEPARATOR, igk_io_dir($dir));
		$s = IGK_STR_EMPTY;
		for($i=0 ; $i<count($d);$i++)
		{
			if ($root || ($i>0))
			{
				$s .= DIRECTORY_SEPARATOR;
			}
			$s.=$d[$i];
			//igk_wln($s);
			if ( empty($s)  || is_dir($s))
				continue;
			if(!@mkdir($s))
				return false;
		}
		return true;
	}
	public static function WriteToFileAsUtf8WBOM($filename, $content, $overwrite = true, $chmod=IGK_DEFAULT_FILE_MASK){
		return self::WriteToFile($filename, $content, $overwrite, $chmod);
	}
	public static function AppendToFileAsUTF8WBOM($filename, $content, $chmod = IGK_DEFAULT_FILE_MASK){
		return self::WriteToFile($filename, $content, true, $chmod, "a+");
	}
	///<summary>write text to a file</summary>
	///<remarks>return true if success. or throw exception</remarks>
	public static function WriteToFile($filename, $content, $overwrite = true, $chmod = IGK_DEFAULT_FILE_MASK, $type="w+")
	{	return igk_io_save_file_as_utf8_wbom($filename, $content,$overwrite, $chmod, $type);
	}

	///<summary>read entiere file in one shot. speed for small file</summary>
	public static function ReadAllText($filename)
	{
		if (file_exists($filename) == false)
			return null;
		//file size all error
		$fsize = @filesize($filename);
		if ($fsize<=0)
			return null;
		$fw = fopen($filename, "r");
		$str = fread($fw, $fsize);
		fclose($fw);
			//$str = @//ff($filename);
		return $str;

	}


	public static function GetFileName($filename)
	{
		$pathinfo = pathinfo($filename);
		$b = $pathinfo["basename"];
		return $b;
	}

	public static function GetFileExt($filename)
	{
		$pathinfo = pathinfo($filename);


		try{
		if (isset($pathinfo["extension"]))
			return $pathinfo["extension"];
		}
		catch(Exception $exception)
		{
			die ($filename);
		}
		return null;
	}

	///<summary>tranforme le repertoire passer en paramètre en une chemin compatible celon le systeme d'exploitation serveur</summary>
	public static function GetDir($dir)
	{
		return igk_io_dir($dir);
	}

	//----------------------------------------------------------
	//return the formatted base directory according to base path
	//----------------------------------------------------------
	///<summary>DIRECTORY FUNCTION.  </summary>
	public static function GetBaseDir($dir=null)
	{
		if ($dir)
		{
			if (igk_io_is_fullpath($dir))
			{
				// igk_debug_wln("full uri");
				// $droot = igk_html_uri($_SERVER["DOCUMENT_ROOT"]);
				if (realpath($dir))
					return self::GetDir(IGK_APP_DIR.DIRECTORY_SEPARATOR.igk_io_basePath($dir));
				else {
					return self::GetDir($dir);
				}
			}
			//igk_debug_wln("full not uri");
			return self::GetDir(IGK_APP_DIR.DIRECTORY_SEPARATOR.$dir);

		}
		return self::GetDir(IGK_APP_DIR);
	}
	///<summary>get the current base uri according to local specification</summary>
	///<param name="dir">null or existing fullpath directory or file element. </param>
	public static function GetBaseUri($dir=null, $secured=false)
	{
		$out = IGK_STR_EMPTY;
		$v_dir = self::GetBaseDir($dir);
		$root = $_SERVER["DOCUMENT_ROOT"];
		$t = substr($v_dir, strlen($root));



		if ($secured){
			$out = 'https://';
		}
		else{
			$out = 'http://';
		}

		$port = "";		
		if ($c = self::GetPort($secured)){
			$port = ':'.$c;
		}
		$out .= igk_str_join(
		igk_str_rm_last(igk_getv($_SERVER,"SERVER_NAME"),'/').$port,//self::GetPort(),
		igk_str_rm_start(igk_html_uri($t), '/'),
		'/');

		//sample
		$out = str_replace('\\','/', $out);
		return $out;
	}
	//get root uri
	public static function GetRootUri($uri=IGK_STR_EMPTY, $secured=null)
	{
		$root = $_SERVER["DOCUMENT_ROOT"];
		if (!$secured && igk_sys_srv_is_secure() )
			$secured = true;
		if ($secured){
			$out = 'https://';
		}
		else{
			$out = 'http://';
		}
		$port = "";
		if ($c = self::GetPort($secured)){
			$port = ':'.$c;
		}


		$out .= igk_str_join(igk_str_rm_last(igk_getv($_SERVER,"SERVER_NAME"),'/').$port,
		igk_str_rm_start($uri, '/'),'/');
		//sample
		$out = str_replace('\\','/', $out);
		return $out;

	}
	private static function GetPort($secure=false){
		$p = igk_getv($_SERVER, 'SERVER_PORT');		
		if (($secure) && ($p!= 443) || (!$secure && ($p!=80)))
			return $p;
		return null;
	}

	public static function GetRequestBaseUri(){
		$refUri = IGKIO::GetRootUri(igk_getv(explode("?",igk_io_request_uri()), 0));
		return $refUri;
	}
	//return relative uri from server requested URI
	///<summary></summary>
	///<exemple>: GetCurrentRelativeUri("test") </exemple>
	public static function GetCurrentRelativeUri($dir= IGK_STR_EMPTY)
	{
		//event from uri
		$r_uri = null;
		$v_isdir =true;
		// if (!igk_sys_isredirecting())
		// {

			// igk_io_fullrequest
			$r_uri = igk_getv(explode("?",igk_io_request_uri()),0);
			// $r_uri = igk_getv(explode("?",igk_io_fullrequestUri()),0);

			//igk_ilog($r_urit. " vs ".$r_uri);
			$v_isdir = IGKString::EndWith($r_uri, '/');
	// }
		// else {
			// igk_wln("root basedir: ".self::GetRootBaseDir());
			// igk_wln("base dir: ".igk_io_baseDir());
			// igk_wln("base uri: ".igk_io_baseUri());
			// igk_wln("root uri: ".IGKIO::GetRootUri(self::GetRootBaseDir()));
			// igk_wln("rqst uri: ".igk_getv(explode("?",igk_io_request_uri()),0));
			// $r_uri = igk_io_baseDir(self::GetRootBaseDir());//igk_getv(explode("?",igk_io_request_uri()),0);

			// $r_uri = "/".self::GetRootBaseDir();
			// $v_isdir = false; //IGKString::EndWith($r_uri, '/');


			// igk_debug(true);
		// }

		$cdir = igk_io_dir(IGKIO::GetRootUri(igk_str_rm_last($r_uri,'/')));
		$bdir = igk_io_dir(igk_io_baseUri());


		$dir = igk_io_dir($dir);
		$i = -1;
		if ($bdir == $cdir)
		{
			// igk_ilog("the smae : ".$dir);
			if (empty($dir))
				return "./";
			return self::GetRootRelativePath($dir);
		}

		//get the current directory according to BASEDIR
		$i = IGKString::IndexOf($cdir, $bdir);
		if ($i != -1){
			$cdir = substr($cdir, $i + strlen($bdir));
		}
		//build dir according to path
		$i = IGKString::IndexOf($dir, $bdir);
		if ($i!= -1){
			$dir = substr($dir, $i + strlen($bdir));
		}
		//remove the first directory separator
		$dir = IGKIO::RemoveFirstDirectorySeparator($dir);
		$cdir = IGKIO::RemoveFirstDirectorySeparator($cdir);

		$t = count(explode(DIRECTORY_SEPARATOR, $cdir));
		if (($t>0 ) && (!$v_isdir))
		{
			$t--;
		}
		if ($t>0){
		for($i = 0; $i< $t; $i++)
		{
			$dir= "..".DIRECTORY_SEPARATOR.$dir;
		}
		}
		else{
			$dir =".".DIRECTORY_SEPARATOR.$dir;
		}
		// if (empty($dir))
			// return "./";

		return igk_html_uri($dir);
	}
	///<summary>Get the Root directory according to DocumentRoot apache configuration </summary>
	///@get the root dir according to document root. uses for css script file
	/// <param name="dir">relative dirctory that will be append to result</param>
	//<exemple>GetRootBaseDir(test) ?= SERVER["Document_ROOT"]-/+ test</exemple>
	public static function GetRootBaseDir($dir=null)
	{
		//get the current base directory
		$s = self::GetBaseDir();
		$s  = str_replace("\\","/", $s);
		$doc = str_replace("\\","/",$_SERVER["DOCUMENT_ROOT"]);
		$dir =  str_replace("\\","/", $dir);
		if (strlen($s) >0)
		{
			if ($s[0] == "/")
			{
				//linux implementation
				$s = strstr($s, $doc);
				$s  = trim(substr($s, strlen($doc)));
				if((strlen($s) > 0) && ($s[0] != "/"))
					$s = "/".$s;
			}
			else{
				$s  = substr($s, strlen($doc));
				if ((strlen($s)>0) && $s["0"]!="/")
					$s .="/";
			}
		}
		if ($dir)
		{
			if ($s == "/")
				$s = IGK_STR_EMPTY;

			if (IGKString::StartWith("/",$dir))
				$s .= $dir;
			else
				$s .= "/".$dir;
		}
		return $s;
	}
	//retrieve the relative path according the directory
	public static function GetChildRelativePath($source, $destination, $separator  = DIRECTORY_SEPARATOR)
	{
		$doc_root = $source;
		$dir = $destination;
		$i = IGKString::IndexOf($dir,$doc_root);
		if ($i!= -1)
		{
			//root document found in dir path
			$dir = substr($dir, $i + strlen($doc_root));
		}
		//not found
		$dir = str_replace(self::GetRootBaseDir(),IGK_STR_EMPTY, $dir);
		while( (strlen($dir)>0) && ($dir[0] == DIRECTORY_SEPARATOR))
		{
			$dir = substr($dir, 1);
		}
		return empty($dir)?null:self::__fixPath($dir);
	}
	private static function __fixPath($path, $separator = DIRECTORY_SEPARATOR)
	{
		if ($separator == "/")
		{
			$path = preg_replace('/([\/]+)/i', '/', $path);

		}
		else
			$path = preg_replace('/([\\'.$separator.']+)/i', ''.$separator.'', $path);
		return $path;
	}
	/// get relative path according to the DOCUMENT_ROOT
	/// dir = must be a full path to an existing file or directory
	public static function GetRootRelativePath($dir, $separator = DIRECTORY_SEPARATOR)
	{
		$doc_root = self::GetDir( $_SERVER["DOCUMENT_ROOT"]);
		$i = IGKString::IndexOf($dir,$doc_root);
		$c = IGK_STR_EMPTY;
		if ($i!= -1)
		{
			//root document found in dir path
			$dir = substr($dir, $i + strlen($doc_root));
			$bdir = igk_io_dir($doc_root."/".self::GetRootBaseDir());
			$c = igk_io_getrelativepath($bdir, $doc_root);
		}
		//not found
		$dir = str_replace(self::GetRootBaseDir(),IGK_STR_EMPTY, $dir);
		while( (strlen($dir)>0) && ($dir[0] == DIRECTORY_SEPARATOR))
		{
			$dir = substr($dir, 1);
		}
		if ($c)
			$dir = $c.DIRECTORY_SEPARATOR.$dir;
		return igk_html_uri(empty($dir)?null:self::__fixPath($dir));
	}
	private static function GetRelativePathToDir($dir, $cdir, $bdir){

			//get the current directory according to BASEDIR
			$i = IGKString::IndexOf($cdir, $bdir);//$doc);
			if ($i!= -1){
				$cdir = substr($cdir, $i + strlen($bdir));
			}
			//build dir according to path
			$i = IGKString::IndexOf($dir, $bdir);
			if ($i!= -1){
				$dir = substr($dir, $i + strlen($bdir));
			}

			//remove the first directory separator
			$dir = IGKIO::RemoveFirstDirectorySeparator($dir);
			$cdir = IGKIO::RemoveFirstDirectorySeparator($cdir);

			$t = count(explode(DIRECTORY_SEPARATOR, $cdir));

			for($i = 0; $i< $t; $i++)
			{
				$dir= "..".DIRECTORY_SEPARATOR.$dir;
			}
			//remove dual separator
			return empty($dir)?null:IGKIO::__fixPath($dir);
	}
	/// <summary>get relative path according to IGK_APP_DIR base dir</summary>
	/// @dir: absolute path or basedir relative path
	public static function GetCurrentDirRelativePath($dir,$mustexists=1, $separator = DIRECTORY_SEPARATOR)
	{

		$doc = igk_io_dir( $_SERVER["DOCUMENT_ROOT"]);
		$cdir = IGKIO::GetCurrentDir();
		$bdir = IGKIO::GetBaseDir();
		$dir = igk_io_dir($dir);
		$i = -1;
		$v_iscurrent = ($bdir == $cdir);
		if ($v_iscurrent)
		{	//base dir is current
			if ($mustexists ){
				if (file_exists($dir))
					$dir = realpath($dir);
				$d = self::GetBaseDirRelativePath($dir);
			}else{
				$dir = $cdir.$separator.$dir;
				$d = self::GetBaseDirRelativePath($dir);
			}
			// igk_wln("is current ".$dir);
			// igk_wln("bdir : $bdir");
			// igk_wln("cdir : $cdir");


			return $d;

		}
		if (empty($dir))
		{
			return self::GetRelativePathToDir($dir, $cdir, $bdir);
		}

		$r = realpath($dir);
		if ($r!= null)
			$r = self::GetSysRelativePath($r, $cdir);
		else{
			$r = self::GetSysRelativePath(igk_io_baseDir($dir), $cdir);
		}
		return $r;

	}

	//retrieve the relative page
	public static function GetRelativePath($sourcepath, $targetdir, $separator = DIRECTORY_SEPARATOR)
	{

		$i = IGKString::IndexOf($targetdir, $sourcepath);
		if ($i != -1)
		{
			$s = self::__fixpath(substr($targetdir, strlen($sourcepath)));
			while(!empty($s) && IGKString::StartWith($s, DIRECTORY_SEPARATOR))
			{
				$s = substr($s, 1);
			}
			return $s;
		}


		$dir = $sourcepath;
		$cdir = $sourcepath;
		$bdir = $targetdir;
		$i = -1;
		$c = 0;
		$tsdir = explode(DIRECTORY_SEPARATOR, $cdir);
		$tbdir = explode(DIRECTORY_SEPARATOR, $bdir);
		$rstep = false;
		while(($c< count($tbdir)) && ($c< count($tsdir)))
		{
			if ($tbdir[$c]!=$tsdir[$c])
			{
				$rstep = true;
				break;
			}
			$c++;
		}
		$s = IGK_STR_EMPTY;
		if ($rstep)
		{
			for($h = $c; $h< count($tbdir) ; $h++)
			{
				$s .= "..".DIRECTORY_SEPARATOR;
			}

		}
		for($h = $c; $h< count($tsdir) ; $h++)
			{
				if ($h>$c)
					$s .= DIRECTORY_SEPARATOR;
				$s .= $tsdir[$h];
			}
		return $s;

	}


	///<summary>GET BASE FOLDER FULLPATH</summary>
	///<exemple>GetBaseFolderFullpath("test") == BASEDIR+"/test"</summary>
	public static function GetBaseFolderFullpath($dir)
	{
		$d = igk_app()->CurrentPageFolder;
		if (!empty($d) && ($d!=IGK_HOME_PAGEFOLDER))
			return igk_io_dir(igk_io_currentRelativePath(IGK_APP_DIR ."/".$d."/".$dir));
		return igk_io_dir(igk_io_currentRelativePath(IGK_APP_DIR ."/".$dir));
	}


	///<summary>REMOVE FOLDER</summary>
	public static function RmDir($dir, $recursive=true)
	{
		if (!is_dir($dir))
			return false;
		if (@rmdir($dir))
			return true;
		if (!$recursive)
			return false;
		$hdir = opendir($dir);
		if (!$hdir)
			return false;
		while( ($f =  readdir($hdir)))
		{
			if (($f=="." ) || ($f==".."))
				continue;
			$v = igk_io_dir($dir."/".$f);
			if (is_dir($v))
			{
				if (self::RmDir($v,$recursive) == false)
				{
					return false;
				}
			}
			else if (is_file($v))
			{
				unlink($v); //remove file
			}
		}
		closedir($hdir);
		return @rmdir($dir);
	}
	public static function RmFiles($dir, $pattern=null){
		if (!is_dir($dir))
			return false;
		$hdir = opendir($dir);
		if (!$hdir)
			return false;
		while( ($f =  readdir($hdir)))
		{
			if (($f=="." ) || ($f==".."))
				continue;
			$v = igk_io_dir($dir."/".$f);
			if (is_file($v))
			{
				if (($pattern ==null) || preg_match($pattern,$v))
				{
					unlink($v); //remove file
				}
			}

		}
		closedir($hdir);
		return true;
	}


}

///<summary>represent a string utility class</summary>
class IGKString{
	//@chaine : string where to operate
	public static function IndexOf($chaine, $research, $offset=0)
	{
		if (empty($chaine) || empty($research))
			return -1;
		$i = strpos($chaine, $research, $offset);
		if ($i === false)
			return -1;
		return $i;
	}
	//@personal sub
	public static function Sub($chaine, $start, $length=null)
	{
		if ($length)
		{
			return substr($chaine, $start, $length);
		}
		else
			return substr($chaine, $start);
	}
	public static function StartWith($chaine, $pattern)
	{
		return (self::IndexOf($chaine, $pattern) == 0);
	}
	public static function EndWith($chaine, $pattern)
	{
		return igk_str_endwith($chaine, $pattern);

	}
	public static function Trim($chaine)
	{
		return trim($chaine);
	}
	public static function Contains($text, $pattern){
		if (!empty($pattern))
			return (strstr($text, $pattern) != null);
		return true;
	}
	public static function Format($s){

			$c = preg_match_all("/\{(?P<value>[0-9]+)\}/i",$s, $match);
			if ($c>0)
			{
			$args = array_slice(func_get_args(), 1);
			for($i = 0; $i < $c ; $i++)
			{
				$index = $match["value"][$i];
				if (is_numeric($index))
				{
					if (isset($args[$index]))
					{
						//replace with value
						$s = str_replace( $match[0][$i], IGKHtmlUtils::GetValue($args[$index]),$s);
					}
				}
			}
			}
			return $s;
	}

	public static function Join($tab, $separator=",", $key=true)
	{
		$s = IGK_STR_EMPTY;
		$t = 0;
		if ($tab){
			foreach($tab as $k=>$v){
				if ($t==1)
				$s.= $separator;
				if ($key)
					$s .=$k;
				else
					$s .= "".$v;
				$t = 1;
			}
		}
		return $s;
	}
}

///<summary> Number operator class </summary>
final class IGKNumber
{
	static $sm_sizeFormat = array(
		"Tb"=>1099511627776,
		"Gb"=>1073741824,
		"Mb"=>1048576,
		"Kb"=>1024,
		"B"=>1
	);

	private static function HexP($r)
	{
		$g = ($r >= 10) ?chr(ord("A")+($r-10)): $r;
		return $g;
	}
	public static function ToBase($d, $base, $length = -1)
	{
		if (is_numeric($d) ==false)
			return "0";
		$o = IGK_STR_EMPTY;
		if ($base > 0)
		{
			if (is_string($d)){
				for($i=0;$i<strlen($d) ;$i++){

					$th = ord($d[$i]);
					$p = (int)($th/$base);
					$r = ($th%$base);

					if ($p < $base)
					{
						if ($p!=0)
							$o = self::HexP($p) . self::HexP($r);
						else
							$o = self::HexP($r);
					}
					else
					{
						//igk_wln("dd");
						$o = self::HexP($r) . $o;
						$o = self::ToBase($p, $base) . $o;
					}
				}
			}
			else{

				$p = (int)($d / $base);
				$r = $d % $base;
				if ($p < $base)
				{
					if ($p!=0)
						$o = self::HexP($p) . self::HexP($r);
					else
						$o = self::HexP($r);
				}
				else
				{
					//igk_debug_wln("dd ".$p. " = ".self::ToBase($p, $base));
					$o = self::HexP($r) . $o;
					$o = self::ToBase($p, $base) . $o;
				}

			}
		}
		if ($length != -1)
		{
			for ($i = strlen($o); $i < $length; $i++)
			{
				$o = "0" . $o;
			}
		}
		return $o;
	}

	//<summary>convert number form base x to base</summary>
	public static function FromBase($d, $base){

		$o  = 0;
		$v = strtoupper(IGK_STR_EMPTY.$d);
		$ln = strlen($v);
		for($i = 0; $i < $ln;$i++)
		{
			$h = self::__GetValue($v[$ln - $i-1]);
			$o += pow( $base, $i) * $h;
		}
		return $o;
	}
	private  static function __GetValue($d){
			if (is_int($d) || preg_match("/[0-9]/i",$d))
			{
				return $d;
			}
			else
				return 10+ ( ord($d) - ord('A'));
	}

	public static function GetMemorySize($value, $round=4){
		if ($value==0)
			return "0 byte";
		foreach(self::$sm_sizeFormat as $k=>$v){
			if ($value>$v){
				return round(($value/$v), $round)." ".R::gets("enum.sizeUnit.".$k);
			}
		}
		return "0 byte";
	}
}

final class IGKDynamicObject extends IGKObject
{
	private $m_properties;

	public function __construct(){
		$this->m_properties= array();
	}
	public function __toString(){
		return __CLASS__."#";
	}
	public function initProperties($data){
		if ($data)
		foreach($data as $k=>$v){
			$this->m_properties[$k] = $v;
		}
	}
	public function __get($name){//IGKDynamicObject
		if (isset($this->m_properties[$name]))
			return $this->m_properties[$name];
		return parent::__get($name);
	}
	public function __set($name, $v){//IGKDynamicObject
		if (!_setIn($name,$v)){
			$this->m_properties[$name] = $v;
		}
	}
	public function __call($name, $arguments)
	{
		if (isset($this->m_properties[$name]))
		{
			return call_user_func_array($this->m_properties[$name], $arguments);
		}
	}
}

///<summary>represent datetime utility class</summary>
class IGKDateTime extends IGKObject
{
	private $m_day;
	private $m_month;
	private $m_year;
	private $m_min;
	private $m_hour;
	private $m_sec;
	public function getmonth(){return $this->m_month; }
	public function getday(){return $this->m_day; }
	public function getyear(){return $this->m_year; }
	public function getmin(){return $this->m_min; }
	public function getsec(){return $this->m_sec; }
	public function gethour(){return $this->m_hour; }

	private function __construct(){
	}
	public static function CreateFrom($format,  $value)
	{
		$tab = (object)date_parse_from_format($format, $value);

		if ($tab->error_count == 0)
		{
			$d = new IGKDateTime();
			$d->m_day = $tab->day;
			$d->m_month = $tab->month;
			$d->m_year = $tab->year;
			$d->m_min = $tab->minute;
			$d->m_sec = $tab->second;
			$d->m_hour = $tab->hour;
			return $d;
		}
		else{
		if (IGKApp::$DEBUG)
			igk_show_prev($tab);
		}
		return null;
	}
	public function __toString(){
		return "IGKDateTime:[".$this->day."-".$this->month."-".$this->year."]";
	}
	public function getDate($format)
	{
		$s = $format;
		$s =str_replace("Y", $this->year, $s);
		$s =str_replace("m", $this->month, $s);
		$s =str_replace("d", $this->day, $s);
		$s =str_replace("H", $this->hour, $s);
		$s =str_replace("i", $this->min, $s);
		$s =str_replace("s", $this->sec, $s);

		return $s;
	}
	public static function compareDate($date1, $date2)
	{
		if (!$date1 || !$date2)
			return -2;
		$s1 = $date1->getDate("Ymd");
		$s2 = $date2->getDate("Ymd");
		return strcmp($s1,$s2);
	}
	public static function isDateEqual($date1, $date2)
	{
		return self::compareDate($date1, $date2)==0;
	}
	public static function isDateYearEqual($date1, $date2)
	{
			if (!$date1 || !$date2)
			return -2;
		return $date1->year == $date2->year;
	}
	public static function isDateMonthEqual($date1, $date2)
	{
		return (self::IsDateYearEqual($date1, $date2)===true) && ($date1->month == $date2->month);
	}
}

///<summary>represent attributes management of object</summary>
class IGKAttribute extends IGKObject
{
	static $classAttributes = array();

	public function __construct(){
	}
	public static function GetAttributes($classOrObject)
	{
		$n = null;
		if (is_string($classOrObject))
		{
			$n = $classOrObject;
		}
		else
			$n = get_class($classOrObject);
		return igk_getv(self::$classAttributes,$n);
	}
	public static function Register($classname, $attribute,$allowmultiple=true, $inherits=false)
	{
		$n = get_class($attribute);
		if (class_exists($classname))
		{
			if (igk_reflection_class_extends($n, __CLASS__))
			{
				if (($tab = igk_getv(self::$classAttributes, $classname)) == null)
				{
					$tab = array();
				}
				$tab[] = $attribute;
				self::$classAttributes[$classname] = $tab;
			}
		}
	}
}
///<summary>represent system global theme color</summary>
final class IGKGlobalColor{
	private $COLORS;
	private static $sm_instance;

	public static function SetGlobalColor($clname, $value){
		$i =
		self::getInstance();
		$i->COLORS[$clname] = $value;
	}
	public static function IsGlobalColor($clname){
			$i =
		self::getInstance();
		return isset($i->COLORS[$clname]);
	}
	public static function getInstance(){
			if (self::$sm_instance===null){
			self::$sm_instance = //igk_get_class_instance(__CLASS__, function(){
					//return
					new IGKGlobalColor();
				//});
			}
			return self::$sm_instance;
	}

	private function __construct(){
		$this->COLORS = array();
	}
}

///<summary>represent color float</summary>
class IGKColorf extends IGKObject
{
	private $m_R;
	private $m_G;
	private $m_B;
	private $m_A;


	public function getR(){ return $this->m_R; }
	public function getG(){ return $this->m_G; }
	public function getB(){ return $this->m_B; }
	public function getA(){ return $this->m_A; }

	public function setR($value){ if (($value>=0) && ($value<=1.0)) $this->m_R = $value; }
	public function setG($value){ if (($value>=0) && ($value<=1.0)) $this->m_G = $value; }
	public function setB($value){ if (($value>=0) && ($value<=1.0)) $this->m_B = $value; }
	public function setA($value){ if (($value>=0) && ($value<=1.0)) $this->m_A = $value; }

	private static function __bindStringData($cl, $v)
	{
	 $v = trim (strtoupper($v));
            if (IGKString::StartWith($v, "#") || IGKString::StartWith($v, "0x"))
            {
                $v = str_replace("#", IGK_STR_EMPTY, $v);
				$v = str_replace("0x", IGK_STR_EMPTY, $v);
                $i = 0;
                switch (strlen($v))
                {
                    case 8:
                        break;
                    case 4:
                        $v = IGK_STR_EMPTY . $v[0] . $v[0] .
                            $v[1] . $v[1] .
                            $v[2] . $v[2] .
                            $v[3] . $v[3];
                        break;
                    case 6:
                        $v = "FF" . $v;
                        break;
                    case 3:
                        $v = "FF" .$v[0] . $v[0] .
                            $v[1] . $v[1] .
                            $v[2] . $v[2];
                        break;
                    default :
                        break;
                }
                try
                {
                    $i = IGKNumber::FromBase($v, 16);// (uint)System.Convert.ToInt32(txt, 16);
					// igk_wln("v : ".$v);
					// igk_wln("i : ".$i);


                    // Colorf c = new Colorf();
                   //$a = (int)((i >> 24) & 0x00FF);
                    $r = (($i >> 16) & 0x00FF);
                    $g = (($i >> 8) & 0x00FF);
                    $b = (($i) & 0x00FF);
                    $cl->m_R = $r / 255.0;
                    $cl->m_G = $g / 255.0;
                    $cl->m_B = $b / 255.0;
					// igk_wln("v : ".$r);
					// igk_wln("i : ".$g);
					// igk_wln("i : ".$b);

                }
                catch(Exception $ex) {
                }
            }
	}
	public static function FromString($v){

		$t = igk_css_get_color_value($v);
		if (empty($t))
		{
		$cl = new IGKColorf();
		$cl->m_A = 1.0;
		self::__bindStringData($cl, $v);
		return $cl;
		}
		$cl = new IGKColorf();
		$cl->m_A = 1.0;
		self::__bindStringData($cl, $t);
		return $cl;
	}
	public function loadw($v){
		self::__bindStringData($this, $v);
	}
	public function toByte(){
		return IGKColor::FromFloat($this->R, $this->G, $this->B, $this->A);
	}
}
///<summary>reprenset color in Byte </summary>
class IGKColor extends IGKObject
{
	private $m_R;
	private $m_G;
	private $m_B;
	private $m_A;

	public static function Black(){ return self::FromFloat(0.0);}
	public static function White(){ return self::FromFloat(1.0);}

	public function getR(){ return $this->m_R; }
	public function getG(){ return $this->m_G; }
	public function getB(){ return $this->m_B; }
	public function getA(){ return $this->m_A; }

	public function setR($value){ if (($value>=0) && ($value<=255)) $this->m_R = $value; }
	public function setG($value){ if (($value>=0) && ($value<=255)) $this->m_G = $value; }
	public function setB($value){ if (($value>=0) && ($value<=255)) $this->m_B = $value;}
	public function setA($value){ if (($value>=0) && ($value<=255)) $this->m_A = $value; }
	public function __construct($r, $g, $b, $a)
	{
		$this->m_R = $r;
		$this->m_G = $g;
		$this->m_B = $b;
		$this->m_A = $a;
	}
	public static function FromFloat($rgb, $g=null, $b=null,$a=null)
	{

		if ($g===null)
			return new IGKColor($rgb * 255,$rgb*255, $rgb*255, 255);

		return new IGKColor($rgb * 255,$g*255, $b*255, $a*255);
	}
	public static function FromString($s)
	{
		$c = IGKColorf::FromString($s);
		return self::FromFloat($c->R, $c->G, $c->B, 255);
	}
}

//------------------------------------------------------------------------------------------
//HTML DEFINITION
//------------------------------------------------------------------------------------------

///<summary>base html item function</summary>
abstract class IGKHtmlItemBase extends IGKObject
implements ArrayAccess,
		   IIGKHtmlLoadContent,
		   IIGKParamHostService//IGKStoreParameterObject
{


	static $BasicMethod;
	// protected $m_tagName;//only child can change the tag name
	// private $m_content;
	// private $m_parent; //igk hierarchie parent
	// private $m_previousCiblingParent; //real cibling parent
	// private $m_parentHost; //parentHost
	// private $m_index;
	// private $m_AutoIndex;
	// protected $m_IsVisible; //get or set if this element is visible. if not overrided boolean or callable that return a boolean is allowed
	// protected $m_params;//store hosted paramater attached to this node
	// private $m_isLoading;
	// private $m_loadingcontext;
	// protected $m_igk_nodeType;
	// protected $m_igk_nodeTypeName;
	// private $m_callback;//callback to modify some global method like __AcceptRender, getIsVisible ....
	// private $m_nsfckey;


	private $_f; //flags variable for sessions storage

	public function setTempFlag($n, $v){
		$t = igk_get_env("sys://node/temp/flags", array());
		$h = spl_object_hash($this);
		if (!isset($t[$h] )){
			$t[$h] = array();
		}
		$t[$h][$n] = $v;
		igk_set_env("sys://node/temp/flags",$t);
		
		//igk_die("base ".__METHOD__);
		
		// $c = $this->{"#tempflag-s"} ?? array();
		// if ($v==null){
			// unset($c[$n]);
		// }else
			// $c[$n] = $v;
		// $this->{"#tempflag-s"} = $c;
	
	}
	public function getTempFlag($n){
		$t = igk_get_env("sys://node/temp/flags");
		$h = spl_object_hash($this);
		if ($t && isset($t[$h])){
		// igk_die("base ".__METHOD__);
			return igk_getv($t[$h], $n);
		}
		return null;
		// $c = $this->{"#tempflag-s"};
		// if ($c){
			// return igk_getv($c, $n);
		// }
		// return null;		
	}
	
	public function gethasContent(){
		return !empty($this->Content) || $this->getHasChilds();
	}
	public function getFlag($flag, $default=null){
		return igk_getv($this->_f, $flag, $default);
	}
	public function unsetFlag($flag){
		unset($this->_f[$flag]);
	}
	public function setFlag($flag, $v){
		if (!isset($v) && (func_num_args()<2)){

			igk_die("Argument not found ".func_num_args());
			return;
		}

		if ($v==null){
			unset($this->_f[$flag]);
		}else
			$this->_f[$flag] = $v;
	}

	//<summary>IGKHtmlItemBase .constructor</summary>
	public function __construct($tagname=null)
	{
		// if (($tagname == "igk:ajxa")&& igk_is_debug()){
			// igk_die(IGKHtmlItemBase );
		// }
		$this->_f=array();
	
		// $this->m_params = array();
		// $this->m_tagName = $tagname;
		// $this->m_IsVisible = true;
		// $this->m_content = null;
		// $this->m_index = null;
		$this->setFlag(IGK_NODETAG_FLAG, $tagname);
		$this->setFlag(IGK_NODETYPE_FLAG, 'c');
		$this->setFlag(IGK_NODETYPENAME_FLAG, null);//"class or null";

		// $this->m_igk_nodeType="class";
		// $this->m_igk_nodeTypeName=get_class($this);
		// $this->setCallback("AcceptRender", array($this, "__AcceptRender"));
		// igk_debug_wln("init {$tagname} : ".$this->m_igk_nodeType);
	}

	///<summary>update: get visible</summary>
	///<return>true if flag not set. if callable evaluate callable if 1 visibile</return>
	public function getIsVisible(){		
		$v = igk_getv($this->_f, IGK_ISVISIBLE_FLAG);	
		if (($v!=null) && igk_is_callable($v)){
			$g =  igk_invoke_callback_obj($this, $v);		
			return $g;
		}
		if ($v === false)
			return 0;		
		$s = 0;		
		if (!$v || ($v===null))
			$s= 1;				
		return $s;
		
	}
	///<summary>set is visible and maintain chain</summary>
	public function setIsVisible($value){
		if ($value===false)		
			$this->setFlag(IGK_ISVISIBLE_FLAG, !$value);
		else{
			$this->setFlag(IGK_ISVISIBLE_FLAG, $value);
		}		
		return $this;
	}
	///<summary>register a namespace key to resolv function that will be call for the callback</summary>
	public function setCallbackNameSpaceKey($key){
		//$this->m_nsfckey = $key;
		$this->setFlag(IGK_NSFC_FLAG, $key);
		//
		//TODO: use it to auto dectect and add callback function to this node
		//Note : function must be visible on the node scope.
		//and it must accept the current note as a first parameter
		//because of clearing the session necessaire if add new functions to callback list
	}
	public function setCallback($n, $callable){
		//igk_wln("set ".$n);
		$g = $this->getFlag(IGK_CALLBACK_FLAG);


		if ($callable == null){

			unset($g[$n]);
			$this->setParam($n."Params",null);
		}
		else {
			$g[$n] = $callable;
			$tb = array_slice(func_get_args(),2);
			if ((count($tb)>0) && is_array($tb[0])){
				$this->setParam($n."Params",$tb[0]);
			}
		if (!$g){
			$g = array();
		}
		}
		if (igk_count($g)==0)
			$this->unsetFlag(IGK_CALLBACK_FLAG);
		else
			$this->setFlag(IGK_CALLBACK_FLAG, $g);

		return $this;
	}
	protected final function callbackKeys(){
		$g = $this->getFlag(IGK_CALLBACK_FLAG);
		return $g ? array_keys($g) : null;
	}
	protected final function iscallback($name){
		$g = $this->getFlag(IGK_CALLBACK_FLAG);
		return $g ? isset($g[$name]) : 0;
	}
	//evaluate callback
	protected final function evalCallback($name, &$o){
		$v_nsfc = $this->getFlag(IGK_NSFC_FLAG);
		$g = $this->getFlag(IGK_CALLBACK_FLAG);
		if (! ($g && isset($g[$name])) && isset($v_nsfc)){
			$fcname = $v_nsfc."_".$name;
			if (function_exists($fcname))
			{
				
				//$this->setCallback($name,  igk_create_invoke_callback($fcname,$this));
				$g = igk_create_invoke_callback($fcname,$this);
				$this->m_callback[$name] = $g;//callable;
			}
		}

		if (isset($g[$name])){
			$b = $g[$name];
			// igk_debug ($name == "getIsVisible");
			// igk_debug_wln($this->TagName ." eval ".$name);
			if (is_callable($b)){ //igk_is_callable($b) && ! igk_is_callback_obj($b)){
				//	igk_debug_wln("is callable");
				// igk_debug_wln("no :::: is ".$b);
				if (is_array($b))
				{
					if (igk_getv($b, 0) === $this)
					{
						//igk_wln("invoke in current content".count($b));
						//igk_wln(" = ".func_num_args());
						$o= call_user_func_array($b, igk_getv(func_get_args(), 2, array()));
						return true;
					}
					else{
						if (count($b)>2){
							$cp = array_slice($b, 2);
							$o= call_user_func_array(array_slice($b, 0,2), $cp);
							return true;
						}
					}
				}
				// igk_wln("faucn ".func_num_args());
				// igk_wln(igk_getv(array_slice(func_get_args(), 2), 0));

				// igk_wln($t);
				//e_xit;
				if (func_num_args()>2){
					$t = array($this);
					$t = array_merge($t, igk_getv(array_slice(func_get_args(), 2), 0));
					$o = call_user_func_array($b, $t);
					return true;
				}else{
					$o = $b($this);
					return true;
				}
			}
			else if (is_string($b)){
				//invoke in argument data
				$param = igk_getv(func_get_args(), 2, array());
				//$base ="parent::";
				extract($param);
				extract($this->getParam($name."Params", array()));
				//store evaluation string to environment in case of error
				igk_set_env(IGK_LAST_EVAL_KEY, $b);
				// igk_wln("code : ".$b);
				$o = eval($b);
				igk_set_env(IGK_LAST_EVAL_KEY, null);
			}
			else if (is_object($b) && isset($b->clType)){
				//param object
				$addArgs = igk_getv(array_slice( func_get_args(), 2), 0);
				//get static parameter to pass to callback function
				//make a clone copy by calling array_slice with index 0;
				$sourceParam = "source\x01:param";
				$sourceDeepth = "source\x01:depth";
				$gc =  null;

				if (isset($b->$sourceParam)){
					$gc = $b->$sourceParam;
					$b->$sourceDeepth++;
				}else{
					$gc = isset($b->clParam) && $b->clParam? array_slice($b->clParam, 0):null;
					$b->$sourceParam = $b->clParam;
					$b->$sourceDeepth=1;
				}

				// igk_wln("addArgs");
				$extra =null;
				$fc_args = igk_getv(func_get_args(), 2, null);
				if(($_v_c = igk_count($addArgs)) > 0){
					if ($gc==null){
						$gc = $addArgs;//replace
					}
					else{
						//igk_debug_wln("mergin ...? ".(($_v_c == 1) && (array_keys($addArgs)[0] === 0)));
						if(!is_array($gc))
							$gc = array($gc);
						if (($_v_c == 1) && (array_keys($addArgs)[0] === 0)){
							$extra = array($addArgs[0]);
						}else
							$gc = array_merge($gc, $addArgs);
					}

				}
				if ($fc_args){
					$gc["func:args"] = $fc_args;
				}
				//backup param previous arguments
				$bck =isset($b->clParam)? $b->clParam : null;
				// igk_log_write_i("sourced", "source depth : {$name} : ".$b->$sourceDeepth);
				$b->clParam = $gc;
				//must not call exit because of closure parameter can't be serialize
				$o = igk_invoke_callback_obj($this, $b, $extra);
				//restore
				$b->clParam = $bck;
					// igk_log_write_i("sourced", "source depth : {$name} : a : ".$b->$sourceDeepth);
				$b->$sourceDeepth--;
				if ($b->$sourceDeepth<=0){
					unset($b->$sourceDeepth);
					unset($b->$sourceParam);
				}
				//igk_debug_wln("out is : ".$o);
				return true;
			}
			else {
				//igk_debug_wln("{$name} not a callable");
				return false;
			}

			return true;
		}
		return false;
	}


	public function __get($name){//for xml node

		if (preg_match("/^get/i", $name))
		{
			$o = null;
			if ($this->evalCallback($name, $o))
				return $o;
		}
		return parent::__get($name);
	}
	///<summary>get the generated node type</summary>
	public function getIGKNodeType(){return $this->getFlag(IGK_NODETYPE_FLAG);} // $this->m_igk_nodeType;}
	///<summary>get the generated node type Name or parameters</summary>
	public function getIGKNodeTypeName(){return $this->getFlag(IGK_NODETYPENAME_FLAG) ?? get_class($this); } //$this->m_igk_nodeTypeName;}

	public function setNodeType($t='c'){		
		$this->setFlag(IGK_NODETYPE_FLAG, $t);
	}
	public function setNodeTypeName($t){
		$this->setFlag(IGK_NODETYPENAME_FLAG, $t);
	}
	protected function setNodeCreationArgs($args){
		// $this->setFlag(IGK_NODE_CREATE_ARGS_FLAG, $args);
		//tempory variable that will store the creationg args
		$this->setTempFlag("creationargs", $args);
		//$this->{"@creationargs"} = $args;
	}
	
	public function getNodeCreationArgs(){
		return $this->getTempFlag("creationargs");		
	}
	
	public function getIsLoading(){return $this->getFlag(IGK_ISLOADING_FLAG, 0); }
	public function getLoadingContext(){return  $this->getFlag(IGK_LOADINGCONTEXT_FLAG, 0);}//$this->m_loadingcontext; }
	///<summary>get auto index . true by default</summay>
	public function getAutoIndex(){
		return igk_getv($this->_f, IGK_AUTODINDEX_FLAG, 1);
	}
	public function setAutoIndex($v){
		$this->getFlag(IGK_AUTODINDEX_FLAG, $v);
	}

	//<summary>the this to file</summary>
	public function SaveToFile($file)
	{
		if (!empty($file))
			igk_io_save_file_as_utf8($file, $this->Render(null), true);
	}
	///<summary> get this node allow to render tag name</summary>
	public abstract function getIsRenderTagName();
	///<summary> get an array of childs to render</summary>
	public final function GetRenderingChildren($options=null){
		$o = array();
		if (!$this->evalCallback('GetRenderingChildren', $o, func_get_args())){
			return $this->__getRenderingChildren($options);
		}
		return $o;
	}
	///<summary> get if this node accept rendering. and initialeze it  </summary>
	protected function __AcceptRender($opt=null){
		$s = $this->getIsVisible();
		// igk_debug_wln(": result ".$s);
		// if (igk_is_debug())exit;
		return $s;
	}
	///<summary> call after node is rendering. call after item render</summary>
	public function RenderComplete($opt=null){

	}
	//utility function
	public static function IsComponent($classname)
	{
		$f = $classname;
		if(class_exists($f) && !igk_reflection_class_isabstract($f) && igk_reflection_class_extends($f, 'IGKHtmlComponentNodeItem')
		&& preg_match(IGK_HTML_NODE_REGEX, $f))
		{
			return true;
		}
		return false;
	}
	public static function IsElement($classname)
	{
		$f = $classname;
		if(class_exists($f) && !igk_reflection_class_isabstract($f) && igk_reflection_class_extends($f, __CLASS__)
		&& preg_match(IGK_HTML_NODE_REGEX, $f))
		{
			return true;
		}
		return false;
	}
	//clear childs - no remove the content
	public function ClearChilds(){//override this to clear your child
	}
	public function addNode($tag, $attributes=null){
		$t = new IGKHtmlItem($tag);
		if ($this->add($t)){
			$t->setAttributes($attributes);
			return $t;
		}
		unset($t);
		return null;
	}
	public function addXmlNode($tag, $attributes =null)
	{
		$t = new IGKXmlNode($tag);
		if ($this->add($t)){
			$t->setAttributes($attributes);
			return $t;
		}
		unset($t);
		return null;
	}

	public function getCallbackNode($name){
		$c = $this->getParam(IGK_NAMED_NODE_PARAM);
		return igk_getv($c, $name);
	}
	public function setCallbackNode($name, $node){
		$c = $this->getParam(IGK_NAMED_NODE_PARAM, array());
		$c[$name]=$node;
		$this->setParam(IGK_NAMED_NODE_PARAM, $c);
	}
	///<summary>special function add a node as a callback. if name defined return the name or create and add it with the callback</summary>
	public function addNodeCallback($name, $callback){
		$c = $this->getParam(IGK_NAMED_NODE_PARAM, array());
		if (isset($c[$name])){
			 $f = $c[$name];
			 igk_html_add($f, $this);
			return $f;
		}
		$h = $callback($this);
		if ($h){
			$c[$name] = $h;
			$h->setParam(IGK_NAMED_ID_PARAM, $name);
			$this->setParam(IGK_NAMED_NODE_PARAM, $c);
			return $h;
		}
		return null;
	}
	///<summary>free callback node</summary>
	public function freeNodeCallback($n=null){
		$c = $this->getParam(IGK_NAMED_NODE_PARAM);
		if ($n==$ull){
			//remove all
			$c = array();
		}else{
			unset($c[$n]);
		}
		$this->setParam(IGK_NAMED_NODE_PARAM, $c);
	}
	function startLoading($className, $context){
		if (!igk_reflection_class_extends(get_called_class(), __CLASS__))
		{
			igk_die(__FUNCTION__."not allowed");
		}
		// $this->m_loadingcontext = $context;
		$this->setFlag(IGK_LOADINGCONTEXT_FLAG, $context);
		$this->setFlag(IGK_ISLOADING_FLAG, 1);
	}
	///<summary>override this method to initialize your component int view</summary>
	protected function loadingComplete(){//loading complete on loading context
		if (!igk_reflection_class_extends(get_called_class(), __CLASS__))
		{
			igk_die(__FUNCTION__." call not allowed");
		}
		if (method_exists($this,"initView"))
			$this->initView();
		$this->unsetFlag(IGK_ISLOADING_FLAG);
		//$this->m_isLoading = false;
		//$this->m_loadingcontext = null;
		$this->unsetFlag(IGK_LOADINGCONTEXT_FLAG);
	}


	public function getNodeType(){return IGKXMLNodeType::ELEMENT; }


	public function getIndex(){
		return $this->getFlag(IGK_ZINDEX_FLAG);//$this->m_index;
	}
	public function setIndex($value, $autoindex=false){
		$i = $this->getIndex();
		if ($i !== $value){
			$i = $value;
			if ($i==null){
				$this->unsetFlag(IGK_ZINDEX_FLAG);
			}else{
				$this->setFlag(IGK_ZINDEX_FLAG, $i);
			}
		}
		if (!$autoindex){
			$this->setAutoIndex(0);
		}
		//$this->m_AutoIndex = $autoindex;
	}

	public function getTagName(){//get tagname by default
		return $this->getFlag(IGK_NODETAG_FLAG,'div');
	}
	public function getContent(){return $this->getFlag(IGK_NODECONTENT_FLAG); //$this->m_content;
	}
	public function setContent($value){
		if ($value===null)
			$this->unsetFlag(IGK_NODECONTENT_FLAG);
		else
			$this->setFlag(IGK_NODECONTENT_FLAG,$value);
		//$this->m_content = $value;
		return $this;
	}
	///<summary>get ParentNode. attention to referrence model. & is removed to allow setting the value</summary>
	public function getParentNode(){ return  $this->getFlag(IGK_PARENT_FLAG);}

	///<summary> get the root node of this element</summary>
	public function getRootNode(){
		$q = $this;
		while(($p = $q->ParentNode)){
			$s = $p->ParentNode;
			if ($s == null)
				break;
			$q = $p;
		}
		return $q;
	}

	///<summary>get the parent document </summary>
	public function getParentDocument(){
		$q = $this;
		while(($p = $q->ParentNode)){
			$cl = get_class($p);
			if ($cl == "IGKHtmlDoc"){
				return $p;
			}
		}
		return null;
		// if ($this->m_parent )
		// {
			// $cl = get_class($this->m_parent) ;
			// if ($cl == "IGKHtmlDoc"){
				// return $this->m_parent;
			// }
			// return $this->m_parent->getParentDocument();
		// }
		// return null;
	}
	///<summary>indicate that the element must be closed with close tag. <i></i> not  if empty</summary>
	public function closeWithCloseTag($opt, $tag)
	{

		if (($opt==null) || !method_exists($opt, "mustclosetag"))
			return igk_html_mustclosetag($tag);

		return $opt->mustclosetag($tag);
	}
	public function isCloseTag($tag)
	{
		if (IGKString::StartWith($tag, "igk:"))
			$tag = substr($tag, 4);
		if (strtolower($this->tagName) == strtolower($tag))
			return true;
		return $this->_p_isClosedTag($tag);
	}
	protected function _p_isClosedTag($tag)
	{
		return false;
	}
	//set parent of this node
	protected function setParentNode($value, $context=null){
		$p = $this->getParentNode();
		if ($p !== $value){
			if (($value == null) && $context && (strtolower($context) == "dispose")){
			    // igk_ilog("request dispose ".$context. " ".get_class($this));
				$this->Dispose();
			}
			if ($value == null)
				$this->unsetFlag(	IGK_PARENT_FLAG, $value);
			else
				$this->setFlag(	IGK_PARENT_FLAG, $value);

		}
	}
	protected function setPreviousCiblingParent($value){
		$this->setFlag(IGK_PREVIOUS_CIBLING_FLAG, $value);
		//$this->m_previousCiblingParent = $value;
	}
	public function getParentHost(){
		return $this->getFlag(IGK_PARENTHOST_FLAG);
	}
	public function setParentHost($host){
		if (($host == null) || igk_reflection_class_extends($host, __CLASS__))
		{
			$this->setFlag(IGK_PARENTHOST_FLAG, $host);
		}
	}

	public function __call($name, $arguments)
	{
		//for special function
		if ($name === "__destruct"){
			//igk_ilog("call for parent " .$name);
			return 0;//parent::__destruct();//$name, $arguments);
		}
		if ($name=="iscallback"){//because method is protected
			// igk_debug_wln("is callback call ");
			// igk_debug_wln($arguments);
			$o =call_user_func_array(array($this,"iscallback"),$arguments);
			// igk_debug_wln("CALLL =".$o);
			//igk_die("iscallback call " .method_exists($this, $name  ));
			return $o;

		}

		$v_is_callb = $this->iscallback($name);
		$o = null;
		// igk_debug_wln("try :: ".get_class($this) . " ".$name . " ? ".$v_is_callb);
		if (!$v_is_callb)
		{
		if ( IGKString::StartWith($name, IGK_ADD_PREFIX))
		{
			$k = substr($name, 3);
			if (!empty($k))
			{
				//add ns item target
				if (substr($k,0, 2)=="NS"){//namespace request
					//igk_wln("NS function");
					$n = substr($k, 2);
					//igk_wln("name : ".$n);
					if (empty($n)){
						igk_die("Name not set can't create obj");
					}
					//first param : is namespace
					if (igk_count($arguments)<1){
						igk_die("first argument must be a namespace");
					}
					$ns = $arguments[0];
					$arg = array_merge(array($ns, $n), array_slice($arguments, 1));

					return call_user_func_array(array($this, "addNS"), $arg);

				}
				else{

					$g = $this->getParam(IGK_NS_PARAM_KEY);
					if (!empty($g)){
						//igk_wln("add item in ns");
						$arg = array_merge(array($g, $k), $arguments);
						//add in namespace
						return call_user_func_array(array($this, "addNS"), $arg);
											return $v_ot;
					}
				}
				// igk_debug_wln("tryd dd".$name . " ? ".$v_is_callb);
				$tab = array(strtolower($k),null, $arguments);
				return call_user_func_array(array($this,IGK_ADD_PREFIX) , $tab);

			}
		}

			if ( isset(IGKHtmlItemBase::$BasicMethod[$name])){
				// igk_debug_wln("call ".$name);
				$f = IGKHtmlItemBase::$BasicMethod[$name];
				if (method_exists($this, $f)){
					return call_user_func_array(array($this, $f), $arguments);
				}
			}
		}
		else{
			if ($this->evalCallback($name, $o, $arguments)){
				return $o;
			}
		}
		$c = get_class($this);
		if (method_exists($c, $name)){
			return call_user_func_array(array($this, $name), $arguments);
		}
		igk_die ("/!\\ function not exists ".$c.":::&gt;&gt;".$name);
	}

	///<summary>html item get param implementation</summary>
	public function getParam($key,$default=null){
		$p = $this->getFlag(IGK_PARAMS_FLAG, array());
		$v_in = isset($p[$key]);
		$s = igk_getv($p, $key, $default);
		if(!$v_in && is_callable($default)){
			$p[$key] = $s;
			$this->setFlag(IGK_PARAMS_FLAG, $p);
		}
		return $s;
	}
	///<summary>get param reference</summary>
	public function & getParamR($key){
		igk_die("not implemement ".__METHOD__);
		// if (isset($this->m_params[$key])){
				// $s = & $this->m_params[$key];
				// return $s;
		// }
		// //$s =  igk_getv($this->m_params, $key);
		// return null;
	}
	public function setParam($key, $value){
		$p = $this->getFlag(IGK_PARAMS_FLAG, array());
		if ($value==null){
			unset($p[$key]);
		}else
			$p[$key] = $value;
		$this->setFlag(IGK_PARAMS_FLAG,$p);
	}
	public function unsetParam($key){
		$p = $this->getFlag(IGK_PARAMS_FLAG);
		//if (isset($this->m_params[$key]))
		unset($p[$key]);
		if (igk_count($p) <=0 )
			$this->unsetFlag(IGK_PARAMS_FLAG);
		else{
			$this->setFlag(IGK_PARAMS_FLAG, $p);
		}
	}
	public function getParamKeys(){
		$p = $this->getFlag(IGK_PARAMS_FLAG);
		return $p ? array_keys($p) : null;
	}
	public function resetParam(){
		//$this->m_params=array();
		$this->unsetFlag(IGK_PARAMS_FLAG);
	}

	protected function getDepthIndent(& $options)
	{
		return igk_html_get_depth_indent($this, $options);
	}

	/// must be overrided
	public abstract function Render($options=null);  //render IGKHtmlItemBase must be overrided in child to render the node or item

	public function RenderAJX(& $options =null){//render in ajx context. directly to client side.
		if ($options===null){
			$options = igk_xml_create_render_option();
		}
		$s  = igk_html_render_node($this, $options, array($this));
		if ($options->Context =="xml")
			$s = str_replace("&", "&amp;", $s);
		igk_wl($s);
	}
	public function RenderHtmlEntities($options=null){
		igk_wl(htmlentities($this->Render($options=null)));
	}
	public function RenderXML(){//render for global item
		header("Content-Type: application/xml");
		$opt=  igk_xml_create_render_option();
		$opt->Context= "xml";
		$this->RenderAJX($opt);
	}
	///aditionnal array of expression attributes
	public function getExpressionAttributes (){
		$tab = igk_getctrl(IGK_REFERENCE_CTRL)->getHtmlExpresionTab($this);
		if ($tab !==null)
		{
			$t = array();
			foreach	($tab as $k=>$v){
				$t[$k] = $this->$k;
			}
			return $t;
		}
		return null;
	}

	public function getinnerHTML($options=null){return $this->innerHTML($options);}
	//override this for inner settings
	protected function innerHTML(& $options=null){return null;}

	public function addElement($tagname, $attributes=null, $index=null)
	{
		$s = new IGKHtmlItem($tagname);
		if ($this->add($s)){
			$this->AppendAttributes($attributes);
			return $s;
		}
		unset($s);
		return null;
	}

	///<summary>create child web node</summary>
	public static function CreateWebNode($name, $attributes=null, $indexOrArgs=null){
		$c = new IGKXmlNode($name);
		if ($c && $attributes)
		{
			$c->AppendAttributes($attributes);
		}
		return $c;
	}
	///Load a single node if found in a text sources
	public static function LoadNode($text)
	{
		if(empty($text))
			return null;

		$v_dummy =  igk_createXMLNode("dummy");
		$v_dummy->Load($text);
		if ($v_dummy->HasChilds)
		{
			return $v_dummy->Childs[0];
		}
		return null;
	}
	//return attribute that match the html requirement for rendering
	public static function GetStringAttribute($v, $options)
	{
		if (empty($v) && !is_numeric($v))
			return null;
		if (is_object( $v))
		{
			if (method_exists(get_class($v), IGK_FC_GETVALUE))
					return self::GetStringAttribute($v->getValue($options), $options);

			switch(igk_getv($v, IGK_OBJ_TYPE)){
				case 'callable':
					return call_user_func_array($v->name, $v->attrs?$v->attrs:array());
					break;
				case '_callback':
					return igk_invoke_callback_obj(null, $v);
			}
			//not handle definition !! inform that is IGK:DATAOBJ
			return "\"IGK:DATAOBJ\"";
		}
		else if (is_string($v))
		{
			if (IGKString::StartWith($v, "\""))
			{
				return $v;
			}
			if (IGKString::StartWith($v, "\'"))
				return $v;
		}

		$v = str_replace("\"", "&quot;", $v);
		if (is_array($v))
		{
			igk_wln(__FUNCTION__.":: attribute is array");
			igk_show_prev($v);
			igk_exit();
		}
		return "\"".$v."\"";
	}

	public function & getElementsByTagName($name){//basic get element by tag name
		$tab = array();
		return $tab;
	}
	public function getElementById($name){return null;
	}
	public function __toString(){
		return get_class($this)."#";
	}
	///<summary>Load html content to this node </summary>
	///<param name="content">source string to load</param>
	///<param name="context">context of the loading. mixed string or object</param>
	///<remark>Data will be evaluated. if you don't what IGK system balafon evaluation used LoadExpression</remark>
	public static function LoadInContext($t, $content, $context=null){
		$d = IGKHtmlReader::Load($content, $context);

		if ($d){
			$d->CopyTo($t);
			return true;
		}
		return false;
	}

	public function LoadExpression($content, $context= null){

		$d = IGKHtmlReader::LoadExpression($content, $context);
		if ($d){
			$d->CopyTo($this);
			return true;
		}
		return false;
	}
	public function LoadView($ctrl, $articlename)
	{
		if ($ctrl)
		{
			$c = $ctrl->getViewContent($articlename,$this);
			if (!empty($c))
				$this->Load($c);
		}
	}
	///<summary> load file content .xphtml <summary>
	public function loadFile($file, $options=null, $args=null){		
	
		if (!file_exists($file))
			return false;
		
		
		$options = igk_create_filterObject((object)$options , [
		"stripComment"=>0,
		]);
		$content = IGKIO::ReadAllText($file);
		if ($options->stripComment){
			$content = igk_html_strip_comment($content);
		}
		if (is_array($args))
			$args = (object)$args;//convert to object		
		return $this->Load($content , $args);
		
	}
	///<summary>set attribute directly
	public function setAttr($key, $value){
		$this->Attributes->Set($key, $value);

	}
	public function setSysAttribute($key, $value, $context=null){//override this to setup your custom attribute
		//igk:style setup the class usage igk:style="danger"

		if(($context !=null) && ($value!==null) && (is_string($value))){

			$tb =array();
			if (($c = preg_match_all("%\[eval:(?P<value>[^\]]*)]%i", $value, $tb))> 0)
			{
				$e = igk_str_read_in_brancket($value, "[","]");
				$script = substr($e[0], strpos($e[0], ":")+1);
				if (!empty($script))
					$value = igk_html_eval_value_in_context($script, $context);
			}
		}
		//array or list properties
		$t = array("style"=>"class");
		$m = igk_getv($t, strtolower($key));
		if ($m){//setting extra properties
			$this[$m] = strtolower("+igk-".$this->getItemType()."-". $value);
		}
		else{
			$k = "set".$key;
			if (method_exists( $this, $k))
			{
				$this->$k($value);
			}
			else{

				igk_assert_die(igk_server_is_local() && (($context!==null) && ($context!='Load')),"/!\\ Method not define [" .$key. "] ::: ".$value . " ::: ".get_class($this). ":::: Context[".$context."]");			
				return false;
			}
		}
		return $this;
	}
	public function setSysAttributes($attributes, $context=null)
	{
		if (is_array($attributes))
		{
			foreach($attributes as $k=>$v)
			{
				$this->setAttribute($k,$v);
			}
		}
		return $this;
	}

	///<summary>get the component type </summary>
	public function getItemType(){
		$exp = "/^(IGKHtml)(?P<name>[\w_-]+)Item$/i";
		$v = get_class($this);
		$t = array();
		if (igk_reflection_class_extends( $v,  __CLASS__) && !igk_reflection_class_isabstract($v) && preg_match($exp, $v) )
		{
			preg_match_all($exp, $v, $t);
			return $t["name"][0];
		}
		return "unknow";


	}
	public function __set($key, $value){ //HtmlItemBase
		if (IGKString::StartWith($key, "igk:"))
		{
			$this->setSysAttribute(substr($key, 4), $value, $this->LoadingContext);
			return;
		}
		if (!$this->_setIn($key, $value))
		{
			//if evalCallback
			//igk_debug_wln("eval call....");
			$o = null;
			if (!$this->evalCallback("set".$key, $o, array("value"=>$value))) {
				$this->$key = $value;
			}
		}
	}
	function offsetExists($key){
	}
	public function offsetGet($key){
	}
	function offsetSet($key, $value){//nothing
	}
	function offsetUnset($key){//nothing
	}
	//23052017	
}



igk_init_html_basic_method();

//represent a html options
class IGKHtmlOptions
{
	//indicate that the tag must be closed with  "/>"
	static $EmptyTag = array(
	"br"=>"br",
	"link"=>"link",
	"input"=>"input",
	"meta"=>"meta",
	"img"=>"img",
	"source"=>"source",
	"embed"=>"embed"
	);
	//indicate that the tag must be closed </tag>
	static $closeWithCloseTags =array(
	    "style"=>"style",
		"label"=>"label",
		"i"=>"i",
		"b"=>"b",
		"canvas"=>"canvas",
		"div"=>"div","iframe"=>"iframre","select"=>"select",
		"tr"=>"tr",
		"td"=>"td",
		"a"=>"a",
		"ul"=>"ul",
		"li"=>"li",
		"ol"=>"ol",
		"form"=>"form",
		"script"=>"script",
		"code"=>"code",
		"noscript"=>"noscript",
		"html"=>"html",
		"body"=>"body",
		"head"=>"head",
		"video"=>"video",
		"option"=>"option",
		"object"=>"object",
		"textarea"=>"textarea",
		"quote"=>"quote",
		"p"=>"p",
		"span"=>"span",
		"igk-img"=>"igk-img",
		"igk-anim-img"=>"igk-img",
		"table"=>"table"
	);

}
final class IGKHtmlActiveAttrib extends IGKObject
{
	public static function getInstance(){
		$key ='sys://html/active/attribInstance';
		$b = igk_get_env($key);
		if ($b)
			return $b;
		$b = new IGKHtmlActiveAttrib();
		igk_set_env($key,$b);
		return $b;
	}
}

///</summary>represent IGKFlagValueData data</summary>
class IGKFv
{//flag value data
	private $_;
	
	
	public function IsEmpty(){
		return count($this->_)==0;
	}
	public function __construct(){
		$this->_ = array();
	}
	public function __sleep(){//sleep data
		if (count($this->_) == 0){
			return array();
		}
		else{
			return array('_');
		}
	}
	public function __wakeup(){//flag data
		if ($this->_==null)
			$this->_ = array();
	}
	public function & getFlag($code, $default=null){
		//because need to return the reference
		$g=$default;
		if (isset($this->_[$code]))
			$g = $this->_[$code];
		return $g;
	}
	public function setFlag($code, $v){
		if (func_num_args()<2){
			igk_die("Argument count");
		}
		if ($v===null)
			$this->unsetFlag($code);
		else{
			if (is_array($v))
				$this->_[$code]=  & $v;
			else
				$this->_[$code]= $v;
		}
		//$v["ggs"]="45";
		// igk_wln($this->_);
		// session_destroy();
		// exit;
	}
	public function unsetFlag($code){
		unset($this->_[$code]);
	}
	public function Clear(){
		$this->_=array();
	}
	///<summary>free the flag if test ok</summary>
	public function freeFlag($code, $force=0){
		$g = $this->getFlag($code);
		if ($force || ($g==null) || ((is_array($g) && (count($g) == 0)))){
			$this->unsetFlag($code);
		}
	}
	public function updateFlag($code, $v){
		$this->setFlag($code, $v);
		$this->freeFlag($code);
	}
}

///<summary>represent a html attrib collection</summary>
///<note>2 type of attribute. active attribute | default attribute</node>
class IGKHtmlAttribs
extends IGKObject
implements ArrayAccess, Iterator
{
	// private $getAttributes();
	// private $m_o; //attribute owner
	// private $m_namespaces;
	// private $m_activated; //activated attributes

	private $_f;//flag properties

	const ACTIVATE=1;
	const ATTRIBS =2;
	const ITERATOR =3;
	const OWNER = 4;

	public function Dispose(){//dispose elements attributes
		//igk_debug_wln("dispose attributes");
		foreach($this->getAttributes() as $k=>$v){
			if (is_object($v) && method_exists(get_class($v), "Dispose")){
				$v->Dispose();
			}
		}
	}
	public function getCount(){
		$c = 0;
		$g = $this->_f->getFlag(self::ACTIVATE);
		$c = igk_count($this->getAttributes()) + ($g ? igk_count($g) : 0);
		return $c;
	}
	public function getOwner(){
		return $this->_f->getFlag(self::OWNER);
	}
	
	
	
	public function __construct($owner){
		if (($owner === null) || !is_object($owner) || (is_object($owner) && !igk_reflection_class_extends(get_class($owner), IGK_HTML_ITEMBASE_CLASS)))
			igk_die("owner must be a HTML Item Base");
		// $this->m_o = $owner;
		$this->_f = new IGKFv();
		$this->tobj ="base";
		//$this->getAttributes() = array();
		// $this->m_namespaces = array();
		//$this->m_activated =array();
		//$this->it_index;
		$this->_f->setFlag(self::OWNER, $owner);
	}

	private function _initActivateAttrib(){
		$g = array();
		$this->_f->setFlag(self::ACTIVATE, $g);
		return $g;
	}
	public function getActivateAttribs(){
		$g = $this->_f->getFlag(self::ACTIVATE);
		if ($g)
			return array_keys($g);
		return null;
	}
	///<summary>used to activate an attributes</summary>
	public function activate($n){
		if (empty($n))return;

		$g = $this->getActivateAttribs() ?? $this->_initActivateAttrib();// (function(){})() ;//array();
		$g[$n] = 1;		
		$this->_f->updateFlag(self::ACTIVATE, $g);

	}
	public function deactivate($n){
		$g = $this->_f->getFlag(self::ACTIVATE);
		if ($g){
			unset($g[$n]);
			$this->_f->updateFlag(self::ACTIVATE, $g);
		}
	}
	public function ToArray(){		
		return $this->getAttributes();
	}
	//Clear attribute
	public function Clear(){//clear attributes
		$this->_f->Clear();
		// $this->getAttributes() = array();
		// $this->m_activated = array();
	}
	//iterator
	public function __toString(){

		return "IGKHtmlAttribs [".$this->getcount()."] : ".$this->tobj;
	}
	public function getAttributes(){
		return $this->_f->getFlag(self::ATTRIBS);
	}


	// private $it_index;//value tab index
	// private $it_key; //key index
	// private $it_vtab;//keys value tab
	function current(){
		$o = $this->_f->getFlag(self::ITERATOR);
		$a = $this->getActivateAttribs();		
		$v_out = isset($a[$o->it_key])?
			IGKHtmlActiveAttrib::getInstance() : $o->it_vtab[$o->it_key];
		return $v_out;
	}
	function next(){
		$o = $this->_f->getFlag(self::ITERATOR);
		$o->it_index++;
		if ( $o->it_index < $o->it_total)
		{
			$o->it_key  = $o->it_keys[$o->it_index];
		}
	}
	function key(){
		$o = $this->_f->getFlag(self::ITERATOR);
		return $o->it_key;
	}

	function valid(){
		$o = $this->_f->getFlag(self::ITERATOR);
		$v = (($o->it_index >= 0) && ($o->it_index < $o->it_total));
		if (!$v){
			$this->_f->unsetFlag(self::ITERATOR);
		}
		return $v;

	}
	function rewind(){
		
		$attr = $this->getAttributes() ?? array();
		$g = $this->_f->getFlag(self::ACTIVATE) ?? array();
		if ($g){
			$attr["@activated"]= $g;
		}
		$o = igk_createObj();
		$o->it_vtab = $attr;
	
		$o->it_index = 0;
		$o->it_total = igk_count($o->it_vtab);
		$o->it_keys = $o->it_vtab ? array_keys($o->it_vtab) : null;

		
		// igk_html_dump($o);
		// igk_wln($o->it_vtab);
		// igk_exit();
		if ($o->it_total >0)
			$o->it_key = $o->it_keys[0];
		else
			$o->it_key = null;
		$this->_f->setFlag(self::ITERATOR, $o);


		// $this->it_vtab = array_keys($this->getAttributes());
		// $this->it_index = 0;
		// if (count($this->it_vtab)>0)
			// $this->it_key = $this->it_vtab[0];
		// else
			// $this->it_key  = null;
		// $this->iterator = array("data"=>1);
		// igk_wln("rewind");

	}

	//arrayaccess
	function offsetExists($key){
		if (is_object($key))
			igk_die("offsetExists :: keys is object ");
		$g = $this->getAttributes();
		return isset($g[$key]);
	}
	public function offsetGet($key){//IGKHtmlItemAttribute offsetGet
		$g = $this->getAttributes();
		if ($g && isset($g[$key]))
			return $g[$key];
		return null;
	}

	function getNS(){
		return $this->_f->getFlag(IGK_DEFINEDNS_FLAG);
	}
	///<summary>set the attribute</summary>
	///<remark>if value is null then the value will be unset</summary>
	function Set($key, $value){

		if (preg_match("/^xmlns(:(?P<prefix>(.)+)){0,1}$/",trim($key),$tab)){
			$ns = $this->_f->getFlag(IGK_DEFINEDNS_FLAG) ?? array();
			if ($value!==null){
				if (isset($tab["prefix"])) {
					$ns[$tab["prefix"]]	= $value;
				}else{
					$ns["@global"] = $value;
				}
			}else{
				if (isset($tab["prefix"])){
					unset($ns[$tab["prefix"]]);
				}else
					unset($ns["@global"]);
			}

			if (igk_count($ns) > 0){
				// igk_wln("set flag :::: ");
				// igk_wln($ns);
				$this->_f->setFlag(IGK_DEFINEDNS_FLAG, $ns);
			}else{
				$this->_f->unsetFlag(IGK_DEFINEDNS_FLAG);
			}

			return;
		}

		$g = $this->getAttributes() ?? $this->_initattribs();
		if ($value===null){
			unset($g[$key]);
		}
		else
			$g[$key] = $value;

		$this->_f->updateFlag(self::ATTRIBS, $g);

	}
	function offsetSet($key, $value){//offsetSet::IGKHtmlItem Attribute collection
		$o = $this->getOwner();
		switch(strtolower($key))
			{
			case "class":
			{
				$attr = $this->getAttributes();
				if ($value ===null)
				{
					unset($attr[$key]);
				}
				else{
					$g = igk_getv($attr,$key);
					if (($g ==null) || !is_object($g))
					{
						 $g = new IGKHtmlClassValueAttribute($this);
						 $attr[$key] = $g;
					}
					$g->add($value);
				}
				$this->_f->updateFlag(self::ATTRIBS, $attr);
			}
			break;
			case "rmclass":
				$tb = explode(" ",$value);
				foreach($tb as $k=>$v){
					$v = trim($v);
					if (empty($v))
						continue;
					$this->offsetSet("class","-".$v);
				}
				break;
	default:
		if (IGKString::StartWith($key, 'igk:'))//setting attribute
		{	//sending attribute to owner
			$ck= substr($key,4);
			if ($ck=="param"){
				//igk_wln("loading context : ".$this->m_owner->LoadingContext);
				return;
			}
			if (!$o->setSysAttribute($ck, $value, $o->LoadingContext)){
				$this->offsetSetExpression($key, $value);
			}
		}else{

			$this->offsetSetExpression($key, $value);
		}
		break;
		}
	}
	function offsetUnset($key){
		$g = $this->getAttributes();
		if ($g){
			unset($g[$key]);
			$this->_f->freeFlag(self::ATTRIBS);
		}
		// unset($this->getAttributes()[$key]);
	}
	private function _initattribs(){
		$g = array();
		$this->_f->setFlag(self::ATTRIBS, $g);
		return $g;
	}
	function offsetSetExpression($key, $value){
		if (preg_match("/^@igk:expression/", $key))
		{
			$g = $this->getAttributes() ?? $this->_initattribs();
			if ($g){
				if ($value ===null)
					unset($g[$key]);
				else
					$g[$key] = new IGKHtmlExpressionAttribute($value);


			}
			return;
		}
		$this->Set($key,$value);
		// if (isset($this->getAttributes()[$key]))
		// {
			// if ($value ===null)
				// unset($this->getAttributes()[$key]);
			// else
				// $this->getAttributes()[$key] = $value;
		// }
		// else if ($value !== null)
		// {
			// $this->getAttributes()[$key] = $value;

		// }
	}

}



final class IGKValueListener extends IGKObject
implements IIGKHtmlGetValue
{
	private $m_owner;
	private $m_attr;

	public function __construct($owner, $attr){
		$this->m_owner = $owner;
		$this->m_attr = $attr;
	}
	public function getValue($options=null){
		$k  = $this->m_attr;
		$v="";

		if (method_exists(get_class($this->m_owner), $k))
		{
			$v= $this->m_owner->$k($options);
		}
		else
			$v= $this->m_owner->$k;
		if ($v)
		{
			$rv = IGKHtmlUtils::GetValue($v, $options);
			return $rv;
		}
		return null;
	}
}


class IGKHtmlExpressionAttribute implements IIGKHtmlGetValue
{
	private $m_v;
	public function __construct($v){
		$this->m_v = $v;
	}
	public function getValue($o=null){
		return $this->m_v;
	}
}



class IGKHtmlChildElementCollections
extends IGKObject
implements ArrayAccess, Iterator
{
	private $m_o;  //owner of the childs
	private $m_childs; //array of childs
	// private $it_index;  //referer index
	private $m_fs;
	const ITERATOR = 1;
	public function ToArray(){
		$t = array_values($this->m_childs);
		return $t;
	}
	public function getCount(){return count($this->m_childs); }
	public function getKeys(){ return array_keys($this->m_childs); }


	public function __sleep(){
		$t = igk_reflection_get_member($this);
		 if ($this->m_fs->isEmpty()){
			 unset($t["\0".__CLASS__."\0m_fs"]);
		}
		return array_keys($t);
	}
	public function __wakeup(){
		if ($this->m_fs == null){
			$this->m_fs =  new IGKFv();
		}
	}
	//</summary>Clear array</summary>
	public function Clear()	{//Clear child collection
		// if (get_class($this->m_owner) == "IGKHtmlBodyBox")
			 // igk_die("d");
		$this->m_childs = array();
		//igk_debug_wln("child clear ....".$this->m_owner->getParam("debug_id"));
	}
	public function Sort($params)
	{
		igk_usort($this->m_childs, $params);
	}
	public function __construct($owner)
	{
		$this->m_o = $owner;
		$this->m_childs = array();
		// $this->it_index = 0;
		$this->m_fs = new IGKFv();
	}
	public function & __get($key)
	{
		if (is_numeric($key))
		{
			return $this->m_childs[$key];
		}
		return $this->m_o->getElementById($key);
	}
	//iterator
	function current(){
		$o = $this->m_fs->getFlag(self::ITERATOR);
		return $this->m_childs[$o->it_index];
	}
	function next(){
		$o = $this->m_fs->getFlag(self::ITERATOR);
		$o->it_index++;
	}
	function key(){
	$o = $this->m_fs->getFlag(self::ITERATOR);
	return $o->it_index;}

	function valid(){
		$o = $this->m_fs->getFlag(self::ITERATOR);
		$v = ($o->it_index>=0) && ($o->it_index< count($this->m_childs)) && isset($this->m_childs[$o->it_index]);
		if (!$v){
			$this->m_fs->Clear();
		}
		return $v;
	}

	function rewind(){
		$o = igk_createObj();
		$o->it_index = 0;
		$this->m_fs->setFlag(self::ITERATOR, $o);
	}

	//arrayaccess
	public function offsetExists($key){
			$v= ($key>=0) && ($key< count($this->m_childs)) && isset($this->m_childs[$key]);
			return $v;
	}
	public function offsetGet($key){
		if (isset($this->m_childs[$key]))
			return $this->m_childs[$key];
		return null;
	}
	public function offsetSet($key, $value){//IGKHtmlChildElementCollections

		if (empty($key)){
			//$c = $value;
			if ($value === null){
				igk_die($key." try to set null not allowed. ");
			}
			$this->m_childs[] = $value;
		}

	}
	public function offsetUnset($key){
		$tab = $this->m_childs;
		if (count($tab)<=0)
			return;

		$p = igk_getv($tab, $key, null);
		if($p !=null)
		{
			unset($tab[$key]);
			if (count($tab)==0)
			{
				$this->m_childs =array();
			}
			else{
				$this->m_childs = array_values($tab);
			}
			if ((count($tab) >0) &&  (igk_getv($this->m_childs, 0, null) == null))
			{
				//igk_wln("value 0 is null ==== [0]/ ".count($this->m_childs) ." ::: ". ($p == null));
				igk_show_prev(array_keys($this->m_childs ));
			}
		}

	}
	public function __toString() {
		return "HtmlChilds [ ".count($this->m_childs)." ]";
	}

	public function Dispose(){//dispose child collection elements
		$t = $this->ToArray();
		$ti = 0;
		foreach($t as $k)
		{
			if ($k)
			{
				$k->Dispose();
			}
			else{
				igk_die("was disposed?");
			}
			$ti++;
		}
		return $ti;
	}
}
///<summary>rendering context enumaration</summary>
final class IGKHtmlContext{
	const XML = "XML";
	const Html = "Html";
}

class IGKXmlChilds extends IGKHtmlChildElementCollections{
	public function __construct($owner){
		parent::__construct($owner);
	}
}
///<summary>represent the base xml node type</summary>
class IGKXmlNode  extends IGKHtmlItemBase
implements ArrayAccess
{
	// private $m_childs;//child of this node
	// private $m_attachChilds;
	//private $m_attributes; //xmlnode attribute
	// private $m_sortRequired;
	// private $m_desc;
	// private $m_disposing;
	// private $m_attachDisposed;
	// public function attachDispose($arrayCallback){
		// $this->m_attachDisposed = $arrayCallback;
	// }
	// function getIsVisible(){
		// $s = parent::getIsVisible();
		// igk_debug_wln(__METHOD__. " call ".$s);
		// return $s;
	// }

	public function offsetSetExpression($n,$v){
		$attr = $this->Attributes;
		if ($attr)
			$attr->offsetSetExpression($n,$v);
		else {
			$g = $this->_initAttributeCollections();
			$g->offsetSetExpression($n,$v);
		}
	}
	public function __construct($tagname)
	{
		parent::__construct($tagname);
	}

	// public function __destruct(){
		// igk_ilog("kill");
		// $this->Dispose();
	// }
	protected function createChildCollection(){
		return new IGKXmlChilds($this);
	}
	protected function createAttributeCollection(){
		return new IGKHtmlAttribs($this);
	}


	public function getDefineNS(& $out, $options=null){
		$ns = $this->getFlag(IGK_DEFINEDNS_FLAG);
		if ($options && (igk_count($ns)>0)){
			if (!isset($options->ns))
				$options->ns = array();
		}
		$m = 0;
		$ns = $this->getFlag(IGK_DEFINEDNS_FLAG);//$this->m_namespaces
		if ($ns)
		foreach($ns as $k=>$v){
			if (isset($options->ns) && (igk_getv($options->ns, $k) == $v))
				continue;
			if ($m)
				$out.= " ";
			if ($k=="@global"){
				$out .="xmlns=\"".$v."\"";
			}else{
				$out .="xmlns:{$k}=\"".$v."\"";
			}
			$m=1;
			$options->ns[$k]=$v;
		}
	}

	public function Load($source){
		return self::LoadInContext($this, $source, IGKHtmlContext::XML);
	}
	public function getIsVisible(){
		if ($this->evalCallback(__FUNCTION__, $o)){
			return $o;
		}
		return parent::getIsVisible();
	}
	public function getIsRenderTagName(){
		if ($this->evalCallback(__FUNCTION__, $o)){
			return $o;
		}
		return true;
	}
	protected function __getRenderingChildren($option=null){//IGKXmlNode __getRenderingChildren
		//sort child if required
		$this->__sortChild();
		$g = $this->getChilds();
		if ($g)
			return igk_to_array($g);
		return null;
	}
	///<summary>utility function</summary>
	public function loadArray($tab, $callback=null){
		if($tab==null){
			return;
		}
		if ($callback){
			foreach($tab as $k=>$v){
				if (!$callback($this, $k,$v)){
					$this->addNode($k)->Content = $v;
				}
			}
		}
		else{
			foreach($tab as $k=>$v){
				$this->addNode($k)->Content = $v;
			}
		}
	}


	protected function getIsDisposing(){
		return $this->getFlag(IGK_ISDISPOSING_FLAG);
	}
	protected function unsetDisposing(){
		$this->unsetFlag(IGK_ISDISPOSING_FLAG);
	}
	protected function setIsDisposing($v){
		$this->setFlag(IGK_ISDISPOSING_FLAG,$v);
	}

	protected function getAttachDisposed(){
		return $this->getFlag(IGK_ATTACHDISPOSE_FLAG);
	}
	protected function unsetAttachDisposed(){
		$this->unsetFlag(IGK_ATTACHDISPOSE_FLAG);
	}
	protected function setAttachDisposed($v){
		$this->setFlag(IGK_ATTACHDISPOSE_FLAG, $v);
	}

	public function Dispose(){//Dispose xml node
		//igk_ilog("disposing");
		//dispose childs
		$q = $this;
		$tab = array();
		array_push($tab, $q);
		while(count($tab)>0){
			$q = array_pop($tab);
			if (!$q->getIsDisposing())
			{
				$q->setIsDisposing(true);
				//dispose attributes
				if ($q->m_attributes)
						$q->m_attributes->Dispose();

					if ($q->m_childs){
						$t = $q->m_childs->ToArray();
						if (count($t)>0){
							array_push($tab, $q);
							foreach($t as $r=>$m){
								array_push($tab, $m);
							}
							continue;
						}
					}
			}
			$q->unsetDisposing();
			if (($r = $q->getAttachDisposed())){
				//$r= $q->m_attachDisposed;
				//igk_ilog("call dispose all ".$q->TagName);
				call_user_func_array($r, array($q));

				$q->unsetAttachDisposed();
			}
			igk_html_unreg_callback_node($q);
			//free resources
			igk_html_rm($q);
			$q->setParentNode(null, __FUNCTION__);
			$q->resetParam();
			igk_notification_push_event(IGK_NODE_DISPOSED_EVENT, $q);

		}

		// if (igk_is_debug()){
				// igk_ilog("node disposed : ".get_class($q). " ".$this->Content);
			// }
		// // igk_notification_push_event(IGK_NODE_DISPOSED_EVENT, $this);
		// return;




		// if ($this->m_disposing){
			// igk_debug_wln("current item is disposing ".get_class($this));
			// return;

		// }
		// $this->m_disposing = true;
		// if (is_object($this->m_childs))
		// {
			// $this->m_childs->Dispose();
		// }
		// //dispose attribute
		// if ($this->m_attributes)
			// $this->m_attributes->Dispose();
		// $this->m_disposing = false;
		// igk_notification_push_event(IGK_NODE_DISPOSED_EVENT, $this);
	}

	public function closeWithCloseTag($opt, $tag){//xml node close tag
		return true;
	}
	public function getAttributesKeys(){
		$attr = $this->getAttributes();
		if ($attr){
			$tab = array();
			foreach($attr as $k=>$v){
				$tab[] = $k;
			}
			return $tab;
		}
		return null;
	}
	///<summary>set internal description</summary>
	public function setDesc($desc){
		$this->setFlag(IGK_DESC_FLAG, $desc);
		return $this;
	}
	public function getDesc(){
		return $this->getFlag(IGK_DESC_FLAG);
	}
	///<summary>set the id of this item</summary>
	public function setId($id){
		$this["id"]=$this["name"] = $id;
		return $this;
	}
	///<summary>set the class combination of this item</summary>
	public function setClass($value){
		// igk_wln("set class ".$value);
		//igk_exit();
		$this["class"]=$value;
		return $this;
	}
	///<summary>clear class</summary>
	public function clearClass(){
		$this["class"]=null;
		return $this;
	}

	public function setAttribute($key, $value){

		$this[$key]=$value;
		return $this;
	}
	public function setAttribute_assert($assert, $key, $value){
		if ($assert){
			$this[$key]=$value;
		}
		return $this;
	}
	public function setAttributeç($assert, $key, $value){
		return $this->setAttribute_assert($assert, $key, $value);
	}
	public function setAttributes($item){
		if (is_array($item) || is_object($item))
		{
			foreach($item as $k=>$v)
			{
				$this[$k]= IGKHtmlUtils::GetValue($v);
			}
		}
		return $this;
	}

	public function attachChild($node)
	{
		$g = $this->getFlag(IGK_ATTACHCHILD_FLAG);
		if ($g ==null){
			$g = array();
		}
		$this->add($node);
		$g[] = $node;
		$this->setFlag(IGK_ATTACHCHILD_FLAG, $g);
		return $this;
	}
	public function detachChild($node)
	{
		$tab = $this->getFlag(IGK_ATTACHCHILD_FLAG);
		$i = 0;
		while($i<count($tab))
		{
			if ($tab[$i] == $node)
			{
				unset($tab[$i]);
			}
			$i++;
		}
		//$this->m_attachChilds = array_values($tab);
		if (igk_count($tab)== 0){
			$this->unsetFlag(IGK_ATTACHCHILD_FLAG);
		}else
			$this->setFlag(IGK_ATTACHCHILD_FLAG, $tab);
		igk_html_rm($node);
	}
	public function getAttachChilds(){
		return $this->getFlag(IGK_ATTACHCHILD_FLAG);
	}
	public function getHasAttachedChild()
	{
		return igk_count($this->getFlag(IGK_ATTACHCHILD_FLAG))>0;// (($this->m_attachChilds) && (igk_count($this->m_attachChilds) > 0));
	}

	public function getHasAttributes(){
		$attr = $this->getAttributes();
		if (!$attr || $attr->getCount()==0)
			return false;
		return true;
	}
	///<summary>get the childs collection</summary>
	public function getChilds(){return $this->getFlag(IGK_CHILDS_FLAG);}

	public function copyAttributes($node, $erase=true)
	{
		if ($node->HasAttributes)
		{
			foreach($node->m_attributes as $k=>$v)
			{
				if ($erase)
				{
					if (is_object($v ))
					{
						if (get_class($v ) == "IGKHtmlClassValueAttribute")
						{
							$this[$k]= $v->getValue();
							continue;
						}
						$this[$k]= IGKHtmlUtils::GetValue($v);
					}
					else
						$this[$k]=$v;
				}
				else{
					if (igk_getv($this->m_attributes, $k)==null)
					{
						$this[$k] = $v;
					}
				}
			}
		}
	}
	///<summary>get attributes collection</summary>
	public function getAttributes(){
		return $this->getFlag(IGK_ATTRS_FLAG);
	}

	public function getChildAtIndex($index){
		$e = igk_getv($this->Childs, $index);
		return $e;
	}

	public function getChildCount(){return igk_count($this->Childs); }
	public function getHasChilds(){return ($this->ChildCount > 0);}
	public function getSortRequired(){return $this->getFlag(IGK_SORTREQUIRED_FLAG,0);}

	public function __toString(){
		return  get_class($this)."[ ".$this->TagName." ] ; Attributes : [".($this->m_attributes?$this->m_attributes->getCount():0)."] ; Childs : [ ".$this->ChildCount." ]";
	}
	//---------------------------------------------------------------------------------------------
	//IGKHtmlItem child functions
	//---------------------------------------------------------------------------------------------
	public function ClearChilds(){ //IGKHtmlItem
		$this->__rm_childs(__FUNCTION__);
		return $this;
	}
	public function RemoveChilds(){//Same as ClearChidld but context is RemoveChild
		$this->__rm_childs(__FUNCTION__);
		return $this;
	}
	protected function __rm_childs($context)
	{
		// $s = igk_get_env("domo");
		// igk_ilog($s." :: ".$context . " === ".$this->ChildCount , __METHOD__);
		$is_rmc = $context == 'RemoveChilds';
		$fc = function($v, $context){
			//free component
			$tab = array();
			while($v){
				if ($c = $v->Childs){
					foreach($c as $k=>$c){
						$c->setParentNode(null, $context);
						array_push($tab, $c);
					}
				}
				$v = array_pop($tab);
			}
		};

		$fc = $fc->bindTo($this);

		if ($this->ChildCount >0)
		{
			$c = $this->Childs;
			foreach($c as $k=>$v)
			{
				if ($v === $this){
					continue;// /!\ strange reason ! child and parent is null
				}
				else{
					//unset parent
					$v->setParentNode(null, $context);
					//unset childs count
					if ($is_rmc)
					$fc($v, $context);
				}
			}
			//clear the chils list
			//igk_debug_wln("clear the child list : ".get_class($this));
			$c->Clear();
		}
		$this->unsetFlag(IGK_CHILDS_FLAG);
		if ($tab = $this->getAttachChilds())
		{
			//maintain attached childs
			foreach($tab as $v)
			{
				$this->add($v);
			}
		}
		//igk_debug_wln(__FUNCTION__."::".$context . " ??[[c=".$this->ChildCount."]]");
		//$this->unsetFlag(IGK_CHILDS_FLAG);
		// exit;
	}


	//<summary>Clear all in current node</summary>
	public function Clear()	{//Clear current node
		$this->Content = null;
		$c = $this->getAttributes();
		if ($c)
			$c->Clear();
		$this->ClearChilds();
	}
	protected function isEmptyTag(){
		return igk_html_emptytag($this->TagName);
	}
	private function _initChildCollection(){
		$g = $this->createChildCollection();
		$this->setFlag(IGK_CHILDS_FLAG, $g);
		return $g;
	}
	protected function _AddChild($child, $index=null){
		if ($this->isEmptyTag() || ($child->ParentNode === $this)){
			igk_debug_wln("/!\\ parent is this");
		    return false;
		}
		//push childs
		$g = $this->Childs ?? $this->_initChildCollection();
		$g[] = $child;
		$this->setupChild($child, $index, __FUNCTION__);
		$this->setFlag(IGK_SORTREQUIRED_FLAG,1);// = true;
		return true;
	}
	protected function setupChild($child, $index, $context){
		if (!$child || !is_object($child) || !is_subclass_of(get_class($child), IGK_HTML_ITEMBASE_CLASS) )
		//if (!$child || !is_object($child) )
			return false;
		//igk_wln("child ::: ".$child);
		$child->setParentNode($this, $context);
		$child->setPreviousCiblingParent($this, $context);;
		$this->_setUpChildIndex($child, $index);


	}
	protected function _setUpChildIndex($child,
		$index=null)
	{
		if ($index === null){
			$i = $child->Index;
			if (!is_numeric($i) || $child->AutoIndex){

				$child->setIndex($this->ChildCount>0? $this->ChildCount-1: 0, true);
			}
		}
		else if(is_numeric($index)){
			$child->setIndex($index, true);
		}
	}
	public function AddRange($arrayChilds)
	{
		if (is_array($arrayChilds))
		{
		foreach($arrayChilds as $k){
			$this->add($k);
		}
		return true;
		}
		return false;
	}
	public function addTo($target)
	{
		if ($target){
			$target->add($this);
		}
	}

	///<summary>
	///add child to this node.
	///</summary>
	///<param name="nameorchilds">tagname or HtmlItem element</param>
	///<param>array of attribute</param>
	///<param>Required index</param>
	public function add($nameorchilds, $attributes =null, $index = null)
	{
		$node = null;
		if ($nameorchilds === null)
			return null;
		if (is_string($nameorchilds)){
			// check if item can add tagname

			$tab = func_get_args();
			$node = $this->__init_new_node_func(array(get_class($this), 'CreateWebNode'), $tab);
		}
		else if(is_object($nameorchilds) && igk_reflection_class_extends(get_class($nameorchilds), IGK_HTML_ITEMBASE_CLASS)){
			//correction parent and parent node

		    $b = $nameorchilds->ParentNode;
			if (($b !== $this) && $this->_AddChild($nameorchilds))
			{
				// if ($s)
				// igk_wln("add child....".$this->Childs);
				$node = $nameorchilds;
				if ($b !== null){//change the parent of this node
					$b->remove($node,0);
				}
			}
		}
		else {
			igk_die("Exception:::Tag not valid ".$nameorchilds);
		}
		if($node)
		{
			if ($attributes)
			{
				$node->AppendAttributes($attributes);
			}
			// if ($node->Index === null){
				// igk_debug_wln("node index is null");
			// }
		}
		return $node;
	}
	protected function __init_new_node_func($p, $params){
			//set the item that request node creation
			//last argument is init callback
			// $callInit=0;
			// $initfc = null;
			// $v_ot=null;
			// $v_regname='';
			//regex :add(NS){0,1}(?P<name>(.)+)(?P<ca>Callback){0,1}
			//preg_match_all("/^add((NS){0,1})(?P<name>(.)+)(?P<ca>(CallBack))?$/i", $name, $g);
			// if (preg_match("/callback$/i", $name) && (($tc= igk_count($arguments))>1) &&
				// igk_is_callable($arguments[$tc-1])){
				// $callInit = 1;
				// //remove last arguments
				// $initfc = array_pop($arguments);
				// $v_regname =array_pop($arguments); //$arguments[$tc-1];

				// $regs = $this->getParam("sys://reg_components", array());

				// //			exit;
			// }

			igk_html_push_node_parent($this);
			$node =  call_user_func_array($p, $params);
			if (!igk_get_env("sys://xml/no_add")){ // ask if request creation no add return node to hierarachi
				if (($node != null ) && igk_is_html($node) && ($node->parentNode !==$this) && !$this->_AddChild($node)){
					igk_debug_wln("!?> node not added ".$node. " ".get_class($this));

					$node = null;
				}
			}
			igk_html_pop_node_parent();
			igk_set_env("sys://xml/no_add", null);

			return $node;
	}

	///<summary>used to add non declared element by namespace</summary>
	public function addNS($ns, $name){

		$h = igk_get_env(IGK_ENV_HTML_COMPONENTS);
	// igk_wln($h);
	// igk_exit();
		if($h==null)
			return null;
		$c = igk_getv(igk_getv( igk_getv($h, $ns), strtolower($name)),"callback");

		//igk_wln($c);
		$p = array_slice(func_get_args(), 2);

		if (igk_is_callable($c)){
			$s = $this->__init_new_node_func($c, $p);
			if ($s){
				//init ns param key
				$s->setParam(IGK_NS_PARAM_KEY, $ns);
				$s["xmlns"] = new IGKNSValue($s, $ns);
			}
			return $s;
		}
		else{
			igk_log_write_i(__FUNCTION__."::".__LINE__, "/!\\ No component ".$name." found in NS ".$ns);
			$k = "add".$name;
			return call_user_func_array(array($this, $k), $p);//$this->$k
		}
		return null;

	}

	///add attribute array
	public function AppendAttributes($attributes =null)
	{
		if (is_array($attributes)){
			foreach($attributes as $k=>$v)
			{
				$this[$k]=$v;
			}
		}
		return $this;
	}
	protected function __sortChild()
	{
		if ($this->SortRequired)
		{
			$g = $this->Childs;
			if ($g)
			igk_usort($g, array("IGKHtmlItem", "SortChild" ));
			$this->unsetFlag(IGK_SORTREQUIRED_FLAG);
			//$this->m_sortRequired = false;
		}
	}
	public static function SortChildCallBack($item, $callback){
		//igk_die(__FUNCTION__);
		//$item->m_sortRequired = false;
		$g = $item->Childs;
		igk_usort($g, $callback);
		$item->unsetFlag(IGK_SORTREQUIRED_FLAG);

	}
	public static function SortChild($a, $b){
		if ($a->Index == $b->Index)
			return 0;
		return ($a->Index < $b->Index)? -1 : 1;
	}

	protected function innerHTML(& $options=null){//html item inner html

		$out = IGK_STR_EMPTY;
		$c = $this->Content;
		$v_iline = igk_html_indent_line($options);
		$v_pdepth =  $this->getDepthIndent($options);
		if (is_numeric($c ))
		{
			return $c;
		}

		$t_childs = $this->GetRenderingChildren($option=null);
		$tc_childs = igk_count($t_childs );

		if ((empty($c) || is_scalar($c) || is_numeric($c)) &&( $tc_childs == 0))
		{
			return $c;
		}
		else {
			if ($options)
			{
				if (isset($options->Depth))
					$options->Depth++;
				else
					$options->Depth = 1;
			}

			$s =IGKHtmlUtils::GetContentValue($this, $options);
			$ck = 0;
			$ch =  $this->__renderVisibleChild($t_childs , $options, $ck);
			$v_depth = $this->getDepthIndent($options);
			if ($s!=null){
				if ($s == "0")
				{
					$out .= "&#48;";
				}
				else{
					if (!empty($s))
					{
						$out .= empty($ch)?$s: $s.$v_iline;
					}
				}
			}
			if (is_numeric($ch) || !empty($ch))
			{
				$out .= $v_iline.$v_depth.$ch.$v_pdepth;
			}
			if ($options)
			{
				$options->Depth--;
			}
		}
		return $out;
	}
	protected function __renderVisibleChild($childs, $options=null, & $tk=0)
	{
		if (!$childs)
			return null;
		$out = IGK_STR_EMPTY;
		$ch = $childs;
		$v_depth = $this->getDepthIndent($options);
		$v_iline = igk_html_indent_line($options);
		$s = "";
		foreach($childs as $k=>$v)
		{
			if ($v->getIsVisible()){
				$s = $v->Render($options);
				if (is_numeric($s) || !empty($s))
				{
					if ($tk==1)
						$out .=$v_iline.$v_depth;
					$out .= $s;
					$tk = 1;
				}
			}
		}
		if ($tk)
			$out .=$v_iline;
		return $out;
	}
	protected function __renderChild($options = null){
		$k = 0;
		$out = $this->__renderVisibleChild($this->GetRenderingChildren($option), $options, $k);
		$v_iline = igk_html_indent_line($options);
		$out .= $k ? $v_iline : null;
		return $out;
	}
	public function getAttributeString($options=null)
	{

		$out = IGK_STR_EMPTY;

		igk_get_defined_ns($this, $out, $options);
		//$this->Attributes->getDefineNS($out, $options);


		if ($this->HasAttributes)
		{
			$attrs = $this->Attributes;
			foreach($attrs as $k=>$v)
			{
				if (($k=="@activated") && is_array($v)){
					$out.= " ";
					foreach($v as $ak=>$av){
						$out.= $ak." ";						
					}
					continue;
				}
				// if (IGKHtmlNoValueAttribute::IsNoValue($v))
				// {
					// $out .= $k." ";
					// continue;
				// }
				$v_is_obj = is_object($v);
				if ($v_is_obj && igk_reflection_class_extends($v, 'IGKHtmlActiveAttrib')){
					if (!empty($out))
						$out .= " ";
					$out .= $k." ";
					continue;
				}
				$r =  (is_object($v) && igk_reflection_class_extends($v, 'IGKHtmlExpressionAttribute'));

				if ($r)
					$c = $v->getValue();
				else {
					$c =self::GetStringAttribute($v, $options);
				}

				if (is_numeric($c) || !empty($c)){
					if (!empty($out))
						$out .= " ";
					if ($options && !$r && igk_getv($options, "UseInXml")){
						//treat for xml
						$c = str_replace('&','&amp;', $c);
					}
					if ($r)
					{
						$out .= $c;
					}
					else
						$out .= $k."=".$c;
				}
			}
			return $out;
		}
		return $out;
	}
	public function RenderInNode($nodename){
		$n =  igk_createNode($nodename);
		$n->setContent($this->Render());
		$n->RenderAJX();
	}
	///<summary></summary>
	public function Render($options=null){//render IGKXmlNode
		return igk_html_render_node($this, $options);
	}
	public function & getElementsByTagName($name){//get elements by tags name

			//igk_debug_wln(__FUNCTION__.":: ".$this->m_childs ." ".$name );

			$tab = array();
			$s = strtolower($name);
			$c = $this->getChilds();
			if( $c)
			{

				if ($name == "*")
				{
					$tab = array_merge ($tab , $c->ToArray());
					foreach($c as $k)
					{
						$c = $k->getElementsByTagName($s);
						if (is_array($c) && (count($c)>0))
							$tab = array_merge($tab, $c);
					}
				}
				else{
					foreach($c as $k)
					{
						if (strtolower($k->TagName) == $s){
							$tab[] = $k;
						}
						$c = $k->getElementsByTagName($s);
						if (is_array($c) && (count($c)>0))
							$tab = array_merge($tab, $c);
					}
				}
			}
			return $tab;
	}
	//retrieve all element that match the current attribute value
	public function getElementByAttribute($name, $value){
		if ( ($c = $this->getChilds())==null)
			{
				return null;
			}
			$tab = array();
			$s = strtolower($value);
			foreach($c as $k)
			{
				if (strtolower($k[$name]) == $s)
					$tab[] = $k;
				$r = $k->getElementByAttribute($name, $s);
				if (is_array($r))
					$tab = array_merge($tab, $r);
				else if ($r)
					$tab[] = $r;
			}
			if (count($tab)== 1)
				return $tab[0];
			return $tab;
	}
	//get element by id
	public function getElementById($id)
	{
		$c = $this->getChilds();
		if ($c ==null)
		{
			return null;
		}
		$tab = array();
		$s = strtolower($id);
		$q = $this;
		$p = null;
		$itab = array($q);

		while($q = array_pop($itab)){
			if (strtolower($q["id"]) == $s){

				$tab[] = $q;
				continue;
			}
			if ($c = $q->Childs){
				foreach($c as $k){
					array_push($itab, $k);
				}
			}
		}

		//avoid recursuion
		// foreach($this->m_childs as $k)
		// {
			// if (strtolower($k["id"]) == $s)
				// $tab[] = $k;
			// $r = $k->getElementById($s);
			// if (is_array($r))
				// $tab = array_merge($tab, $r);
			// else if ($r)
				// $tab[] = $r;
		// }
		if (count($tab)== 1)
			return $tab[0];
		return $tab;
	}
	///<summary>Remove childs</summary>
	public function remove($child, $changeParent=1)
	{

		$v_deleted = false;
		$c = $this->getChilds();
		if (($c ==null) ||( !isset($child)))
			return $v_deleted;

			for	($i = 0; $i< igk_count($c); $i++)
			{
				if (isset($c[$i]) )
				{
					if ( ($c[$i] === $child) )
					{
						unset($c[$i]);
						if ($changeParent)
							$child->setParentNode(null, __FUNCTION__);
						$v_deleted = true;
						break;
					}
				}
				else{
					igk_debug_wln(" index ".$i." not found ". $child["id"]);
				}
			}
			if ($v_deleted)
			{
				//remove all reference
				$v_deleted |= $this->remove($child);
			}
			return $v_deleted;
	}

	public function removeChildAt($index)
	{
		$c = $this->getChilds();
		if ($c){
			$p  = igk_getv($c, $index , null);
			if ($p)
			{
				unset($c[$index]);
				$p->setParentNode(null);
				return true;
			}
		}
		return false;
	}
	protected function unsetAttributes(){
		$this->unsetFlag(IGK_ATTRS_FLAG);
	}
	protected function _initAttributeCollections(){
		$g = $this->createAttributeCollection() ?? igk_die("failed to create attribute collections");
		$this->setFlag(IGK_ATTRS_FLAG, $g);
		return $g;
	}
	//arrayaccess
	function offsetExists($key){
		$g = $this->Attributes;
		return $g ? $g->offsetExists($key) : false;
	}
	public function offsetGet($key){
		$g = $this->Attributes;
		if ($g==null)
		{
			return null;
		}
		return $g->offsetGet($key);
	}
	function offsetSet($key, $value){//xml node
		$g = $this->Attributes;
		// if ($key == "style"){
			// igk_wln("o : ".$g);
			// igk_wln("f : ".$value);
			// igk_exit();
		// }
		if( $value){
			if ($g==null)
				$g = $this->_initAttributeCollections();
			$g[$key] = $value;
		}else{
			if ($g){
				$g[$key]=null;
			}
		}

	}
	function offsetUnset($key){
		$g = $this->Attributes;
		if ($g){
			$g->offsetUnset($key);
			if ($g->Count == 0)
				$this->unsetAttributes();
		}
	}
}


///<summary>represent a CDATA xmln node</summary>
final class IGKXmlCDATA extends IGKXmlNode{
	public function getIsRenderTagName(){ return false;}
	public function getCAnAddChild(){return false;}
	public function Render($options=null){
		$c = "<![CDATA[";
		$s = $this->Content;
		if (is_string($s))
				$c.= $s;
		else
			if (is_object($s) && (method_exists($s, "getValue")))
				$c.=$s->getValue();
		$c .="]]>";
		return $c;
	}
	public function __construct(){
		parent::__construct("igk:cdata");
	}

}


/// <summary>represent a html item</summary>
class IGKHtmlItem extends IGKXmlNode
implements ArrayAccess
{
	// private $m_style;

	public function inflate($fname, $context=null){
		if (!preg_match("/\.pxhtml$/i", $fname))
			$fname .=".pxhtml";
		if (!file_exists($fname)){
			return;
		}
		$ctrl = null;
		$ctrl = igk_get_env("sys://ctrl/view/controller");
		if ($context==null){
			$context = (object)array("ctrl"=>$ctrl);
		}else{
			if (!isset($context->ctrl))
				$context->ctrl = $ctrl;
		}
		$this->Load(igk_io_read_allfile($fname),$context);
	}
	///<summary> used to activate an attribute</summary>
	public function activate($attr){		
		$attrib = $this->Attributes ??  $this->_initAttributeCollections();		
		$attrib->activate($attr);
		return $this;
	}
	///<summary> used to remove an activated attribute</summary>
	public function deactivate($attr){
		$attrib = $this->Attributes ?? $this->_initAttributeCollections();		
		$attrib->deactivate($attr);
		return $this;
	}
	public function closeWithCloseTag($opt, $tag){//html item must close tag
		if (($opt==null) || !method_exists($opt, "mustclosetag"))
			return igk_html_mustclosetag($tag);
		return true;// isset(IGKHtmlOptions::$closeWithCloseTags[$this->getTagName]);
	}
	public function Load($source, $contextObj=null){
		return self::LoadInContext($this, $source, $contextObj ?? IGKHtmlContext::Html);
	}


	public function setStyle($value){
		if (empty($value))
			return;
		$s = "";
		if (IGKString::StartWith($value,'+/'))
		{
			$s = $this["style"];
			$value = substr($value, 2);
		}
		$this["style"] = igk_css_treatstyle($value);
		return $this;
	}
	public function setFont($ft){
		$this->setClass("+ft-".$ft);
		return $this;
	}
	public function getStyle(){
		return $this->getFlag(IGK_STYLE_FLAG);//m_style;
	}
	//<summary>Clear all in current node</summary>
	public function Clear()	{//Clear current node
		$this->Content = null;
		$this->ClearChilds();
		//$s = $this->getStyle();
		//$this["style"] = $s;//this->m_style;
	}
	public function __construct($tagname){
		parent::__construct($tagname);
		//$this->m_style = new IGKHtmlStyleValueAttribute($this);
		//$this["style"] = $this->m_style;
	}
	function offsetSet($key, $value){
		if ($key=="style")
		{

			if (empty($value)){
				$this->unsetFlag(IGK_STYLE_FLAG);
				parent::offsetSet($key, null);
			}else{
				$g = $this->getStyle();
				if ($g==null)
					$g = new IGKHtmlStyleValueAttribute($this);
				$g->setValue($value);
				$this->setFlag(IGK_STYLE_FLAG, $g);
				parent::offsetSet($key, $g);
			}


				// $this->setIGK_STYLE_FLAG
			// if ($value !== $this->m_style){
				// $this->m_style->setValue($value);
			// }
			// parent::offsetSet($key, $this->m_style);
		}
		else
			parent::offsetSet($key, $value);


	}

	public function offsetGet($key){
		if ($key == "style")
			return $this->m_style;
		return parent::offsetGet($key);
	}


	///<summary>create a web node with is value</summary>
	///<param name="indexOrArgs">mixed. index or array </param>
	///<param name="attributes">attribute to set to created node</param>
	///<param name="name">registration name</param>
	public static function CreateWebNode($name, $attributes=null, $indexOrArgs=null)
	{
		// igk_debug_wln("create html webnode : {$name}");
		$c = null;
		if (!empty($name))
		{
			switch(strtolower($name))
			{
				case "table":
					$c = new IGKHtmlTable();
					break;
				case "code":
					$c = igk_html_node_code();//new IGKHtmlCode();
					break;
				case "script":
					$c = new IGKHtmlScript();
					break;
				case "meta":
					$c=  new IGKHtmlMeta();
					break;
				case "input":
					$c =  new IGKHtmlInput();
					break;
				case "igk-html-image":
				case "igk-img":
				case "img":
				case "image":
					$c =  new IGKHtmlImgItem();
					break;
				case "ul":
					$c = new IGKHtmlUl();
					break;
				case "form":
					$c = new IGKHtmlForm();
					break;
				// case "label":
					// $c =  new IGKHtmlItem(strtolower($name));
					// $c["class"]="cllabel";
					// break;
				case "div":
					$c = new IGKHtmlDiv();
					break;
				default:							
					
					return igk_create_html_component($name,$indexOrArgs, function($c, $def)use($name, $indexOrArgs){
						 if (!igk_is_html($c))
							 return;
						 $fc = igk_getv($def,"name");
						 $fg=$c->getIGKNodeType();
						if (!isset($fg)){
							igk_wln("/!\ Created node ins't valid for specification [{$fg}] ..... ".$fc . "== ".get_class($c) . " ::: ");
						}
						$c->setNodeType(igk_getv($def,"type"));//"function";
						$c->setNodeTypeName($fc);
						$c->setNodeCreationArgs($indexOrArgs);
						// igk_wln(" for name : {$name} : ".$fc);
						// igk_wln(" check name : {$name} : ". $c->getFlag(IGK_NODETYPENAME_FLAG));
					}
					);
					// $f = IGKString::Format(IGK_HTML_CLASS_NODE_FORMAT, $name);
					// if(class_exists($f) && !igk_reflection_class_isabstract($f) && igk_reflection_class_extends($f, __CLASS__) )
					// {
						// $p = new ReflectionClass($f);
						// $tb = array();
						// if (is_array($indexOrArgs))
							// $tb = $indexOrArgs;
						// $o = call_user_func_array(array($p, "newInstance"), $tb);
						// if ($o )
							// $c =  $o;
						// else {
							// $c = new $f();
						// }

					// }
					// else{

	// // igk_wln("kd function ".$name);
				// //e_xit;
						// if (function_exists(IGK_FUNC_NODE_PREFIX.$name)){
							// $fc = IGK_FUNC_NODE_PREFIX.$name;
							// $tb = is_array($indexOrArgs) ? $indexOrArgs : array();

							// $s = new ReflectionFunction($fc);
							// // igk_wln($name);
							// // igk_wln($fc);
							// // igk_wln($s->getNumberOfRequiredParameters());
							// // igk_exit();
							// if (igk_count($tb) >= $s->getNumberOfRequiredParameters() ){
								// // /igk_html_set_func_param("owner",
								// $c = call_user_func_array($fc, $tb);
								// // igk_wln("kjdf {$name} = ".$c->m_igk_nodeType);
								// if ($c){
									// // igk_wln(":::".$c->m_igk_nodeType . " ".$c->m_igk_nodeTypeName);
									// if (!isset($c->m_igk_nodeType)){
										// igk_ilog("/!\ Created node is not an [igk_node_type] ..... ".$fc);
										// //e_xit;
									// }
									// $c->m_igk_nodeType="function";
									// $c->m_igk_nodeTypeName=$fc;
									// // if ($fc=="igk_html_node_RollIn"){
										// // igk_die($fc);
									// // }
								// }
								// else{
									// igk_ilog("item not created ::: ".$fc);
									// // igk_exit();
								// }
							// }


						// }else
							// $c = new IGKHtmlItem($name);

						// if (igk_is_debug() && ($name=="fragment")){
						// igk_wln("/8\   done");
						//e_xit;
						// }
					// }
					break;
			}
		}
		else
			$c = igk_html_node_text();
		if ($c && $attributes)
		{
			$c->AppendAttributes($attributes);
		}
		return $c;
	}

	public static function CreateElement($name, $param=null){
		if (!empty($name))
		{
			if (IGKString::StartWith($name, 'igk:'))
			{		
				$f = igk_createNode(substr($name, 4),null, $param);
				if ($f)
					return $f;
			}
			$tb = explode(':', $name);
			if (count($tb) == 1){
				return new IGKHtmlItem($name);
			}
			//get ns and create
		}
		return null;
	}


	//-----------------------------------
	// HTML ITEM
	//-----------------------------------

	public function addPrev($itemorarray)
	{
		$p = $this->add("pre");
		igkOb::Start();
		print_r($itemorarray);
		$c = igkOb::Content();
		igkOb::Clear();
		$p->Content = $c;
		return $p;
	}

	public function addTableBuild($itemorarray, $filter = null)
	{
		$p = $this->addDiv();
		if (is_array($itemorarray) || is_object($itemorarray))
		{
			$tab = $p->addTable();
			$tr = $tab->addTr();
			$tr->add("th")->Content = "Key";
			$tr->add("th")->Content = "Value";
			foreach($itemorarray as $k=>$v)
			{
				$tr = $tab->addTr();
				$tr->addTd()->Content = $k;
				$tr->addTd()->Content = $v;
			}
		}
		else{
			$p->Content = $itemorarray;
		}
		return $p;
	}


	public function addBr($style=null){
		$br =  $this->add("br", $style);


		return $br;
	}
	/// add horizontal separator
	public function addHSep(){
		return $this->add(igk_html_node_Separator());//new IGKHtmlSeparatorItem());
	}
	/// add vertical separator
	public function addVSep(){
		return $this->add(igk_html_node_Separator('vertical'));//new IGKHtmlSeparatorItem("vertical"));
	}
	public function addSpace(){
		$this->add(igk_html_node_text("&nbsp;"));
		return $this;
	}
	public function addForm($attributes = null, $index=null){
		return $this->add("form", $attributes, $index);
	}
	public function addSelect($id, $attributes=null, $index=null){
		$s =  $this->add("select", $attributes, $index);
		$s["name"] = $s["id"] = $id;
		return $s;
	}

	public function addTable($attributes = null, $index=null){
		return $this->add("table", $attributes, $index)->setClass("igk-table");
	}
	public function addDiv($attributes=null, $index= null){
		return $this->add("div", $attributes, $index);
	}
	public function addResImg($name, $alt=null){
		$img = $this->add("img",
			array(
			"src"=>R::GetImgUri(trim($name)),
			"alt"=>$alt));
		return $img;
	}


	public function addIFrame($id,$uri=null,  $attributes = null, $index=null){
		$frm = $this->add("iframe", null, $index);
		if ($frm == null) return null;

		$frm["id"] = $id;
		$frm["src"] = $uri;
		$frm["class"] = "cliframe";
		$frm->AppendAttributes($attributes);
		return $frm;
	}

	public function addObject($uri, $attributes = null)
	{
		$obj = $this->add("object");
		if ($obj ==null)return null;

		$obj["data"] = $uri;
		$obj->AppendAttributes($attributes);
		return $obj;
	}



	public function addInput($id, $type="text",$value=null, $attributes=null)
	{
			$i = $this->add("input");
			if ($i){
			$i["type"]=$type;
			$i["value"]= ($value==null)? igk_getr($id, null): $value;
			$i["id"]=$i["name"]=$id;
			$i["class"] = "cl".$type;

			switch($type){
				case "button":
				case "submit":
				case "reset":
					$i["class"]="igk-btn";
					break;
			}

			$i->AppendAttributes($attributes);
			}
			return $i;
	}
	public function addFile($id , $multiselect = false, $attributes=null)
	{
			$i = $this->add("input");
			if ($i){
			$i["type"]="file";
			$i["id"]=$id;
			$i["name"]= $multiselect? $id."[]": $id;
			$i["class"] = "clfile";
			$i["multiple"]="true";
			$i->AppendAttributes($attributes);
			}
			return $i;
	}
	///<summary>add inline script to node</summary>
	public function addScript($file= null, $tag =null, $canBeMerged = true ){//add inline script to node script
		$s = $this->add("script");
		$s["src"] = $file;
		$s->canBeMerged = $canBeMerged;
		$s->tag = $tag;
		return $s;
	}
	public function addNothing(){
		$c = new IGKHtmlNothingItem();
		$this->add($c);
		return $c;
	}


}

//<summary>empty html node</summary>
final class IGKHtmlEmptyNode extends IGKHtmlItem{
	protected function _AddChild($child, $index=null){
		return false;
	}
	public function __construct($tagname){
		parent::__construct($tagname);
	}
	public function addNode($n, $attributes=null){
		return null;
	}
}


class IGKXmlRenderOptions extends IGKObject{
	var $ns;//stored namespace
	var $Indent;
	var $UseInXml;
	var $Depth;
	var $Context;

	public function __construct(){
		$this->Indent = true;
		$this->UseInXml = true;
		$this->Depth = 0;
		$this->Context = "xml";
	}

	// public function html_attr_value($node, $v){
		// return $v;
	// }
	// public function html_element_value($node, $v){
		// return $v;
	// }
}





//------------------------------------------------------------
//only used to render item once
//------------------------------------------------------------
final class IGKHtmlSingleNodeViewer extends IGKHtmlItem{
	var $targetNode;
	private $m_callback;
	///<summary>.ctr</summary>
	///<param name="node">.node to render once</param>
	///<param name="callback">call after render</param>
	public function __construct($node, $callback=null)
	{
		parent::__construct("igk:singleViewItem");
		$this->targetNode = $node;
		$this->m_callback = $callback;
	}

	public function RenderComplete($options=null){

		igk_html_rm($this);
		if ($this->m_callback){
			igk_invoke_callback_obj($this, $this->m_callback);
			$this->m_callback = null;
			unset($this->m_callback);
		}
		unset($this->targetNode);
	}
	public function getIsRenderTagName(){
		return false;
	}
	protected function __AcceptRender($options=null){
		if ($this->targetNode )
			return $this->IsVisible; //parent::AcceptRender($options);
		return false;
	}
	protected function __getRenderingChildren($option=null){
		return array($this->targetNode); //null;
	}
	protected function _AddChild($item, $index=null){ return false;}
}


///uri relative value
//@@ used to get the current relative link value according to BASEDIR
final class IGKHtmlRelativeUriValueAttribute extends IGKHtmlItemAttribute
{
	private $m_lnk; //relative path according to base dir
	private $m_isfullp; //save if the path is a fullpath
	public function getLnk(){
		return $this->m_lnk;
	}

	public function __construct($uri=null){
		$this->m_lnk = $uri;
		$this->m_isfullp = file_exists($uri) && ($uri == realpath($uri));
	}
	public function getValue($options=null){
		if (empty($this->m_lnk)){
			if (igk_get_env("sys://error")){
				//for system error
				return igk_io_currentBaseDomainUri();
			}
		}

		if ($this->m_isfullp){
			$rp = realpath($this->m_lnk);
			if (!igk_io_is_subdir(IGK_APP_DIR, $rp)){
				// igk_wln("data : ".igk_io_fullpath2fulluri($rp));
				//e_xit;
				return igk_io_fullpath2fulluri($rp);
			}
		}


		if (igk_is_ajx_demand()){
			return igk_html_uri(igk_io_baseUri()."/".$this->m_lnk);
		}
		//igk_ilog_assert(igk_is_debug(), " /!\\ empty lnk ". igk_io_currentRelativeUri(), __METHOD__);
		$v = igk_html_get_system_uri($this->m_lnk, $options);
		return $v;
	}
	public function __toString(){
		return get_class($this)."#".$this->m_lnk;
	}
}

///<summary>represent a tinyMceScript general component</summary>
final class IGKHtmlTinyMceScript extends IGKHtmlItem
{
	private static $sm_instance = null;
	private  $m_tinyScript;
	private  $m_rendered ;

	function __construct(){
		parent::__construct(IGK_STR_EMPTY);
		$this->m_tinyScript = igk_js_enable_tinymce($this);
		$this->m_rendered = false;
	}

	public static function getInstance(){
		if (self::$sm_instance == null)
		{
		self::$sm_instance = igk_get_class_instance(__CLASS__, function(){
					return new IGKHtmlTinyMceScript();
			});


		}
		return self::$sm_instance;
	}
	protected function innerHTML(& $option=null){
		return $this->m_tinyScript->innerHTML($option);
	}
	public function Render($option=null){
		// if (!$this->m_rendered)
			// $this->m_rendered = true;
		// else
			// return null;
		return $this->m_tinyScript->Render($option);
	}
}

class IGKHtmlAHref extends IGKObject
implements IIGKHtmlGetValue
{
	private $m_uri;
	private $m_owner;
	private $m_designmode;

	public function __construct($a){
		$this->m_owner = $a;
		$this->m_designmode= igk_is_design_mode(); //check if created on design mode
	}
	public function getValue($options=null){
		if ($this->m_designmode)
			return "#";
		return $this->_checkLnk($options); //$this->m_uri;
	}
	public function setValue($v){
		$this->m_uri = $v;
	}
	public function getUri(){
		return $this->m_uri;
	}

	private function _checkLnk($option){
		$bck = $this->m_uri;
		if (!is_string($bck)){
			return $bck;
		}

		$m = igk_xml_is_options_mail($option);

		if (IGKValidator::IsUri($bck))
		{
			if(igk_xml_is_caching_require($option)){
				//get if this uri is child of the base uri
				$s = igk_io_baseUri();
				// igk_wln($s);
				// igk_wln($bck);
				if (strstr($bck,$s)){
					return "./".igk_str_rm_start(substr($bck, strlen($s)),  '/');
				}
				// igk_wln(strstr($bck, $s));
				//e_xit;
			}
			//igk_ilog("is uri ".$bck);
			return $bck;
		}

		$s = preg_replace_callback("/%(?P<name>[^%]+)%/i", function($m){
			switch($m["name"]){
				case "base":
					return igk_io_baseUri();
				case "base_config":
					return igk_io_baseUri()."/Configs/";
			}
			return "";
		}, $bck);
		//igk_wln($bck.".::". $s);
		$bck = $s;//str_replace("%base%", igk_io_baseUri(), $bck);


		$dx = igk_getv(explode("?", str_replace(igk_io_baseUri(), "", $bck)),0);
		if (!empty($dx)){
			//accoring to base dir
			$dx = igk_io_baseDir().$dx;
			if (is_dir($dx) && !preg_match("/\/$/", $dx) ){
				// $dx .="/";
				// igk_wln("bck : ".$bck);
				// igk_wln("dx : ".$dx);
				$m = igk_getv(explode("?", $bck),0);
				$r = str_replace($m, igk_io_fullpath2fulluri($dx)."/", $bck);
				// igk_wln("uri : ".igk_io_fullpath2fulluri($dx)."/");
				// igk_wln("r : ".$r);
				return $r;
				//transform dx to uri
				// igk_wln("dx : ".igk_io_baseUri(igk_io_baseDir($dx)));

			}
		}

		//if uri redirect to existing folder without trailing "/"
		//apache make a 301 redirection. so the POSTED DATA will be lost and the client data will request the page twice
		$dir = igk_io_baseDir().$bck;
		//igk_wln("check . ".$dx);

		if ($this->m_owner->domainLink){
			if (preg_match("/^\/[^\/](.)+$/", $bck) && !igk_sys_is_subdomain()){
				$u = igk_io_baseUri().$bck;
				return $u;
			}
		}
		if ($this->m_owner->domainLink && igk_sys_is_subdomain() ){
			$u  = "";
			if(IGKValidator::IsUri($bck)){
				$u = $bck;
			}else{
				$uri = new IGKHtmlUri();
				$u = igk_sys_srv_uri_scheme()."://".igk_sys_domain_name().$uri->getValue($option);
			}
			$dn = igk_get_domain($u);
			if (!empty($dn) && (igk_sys_current_domain_name() != $dn))
			{

				// igk_wln("current domain name ".igk_sys_domain_name());
				// igk_wln("subdoain ".igk_sys_subdomain_name());
				// igk_wln("domain name : [$u] ".$dn);
				// igk_wln("cdomain name : [$u] ".igk_sys_current_domain_name());
				$u .= (strpos($u,'?')!==false)?"&":"?";
				//$u .= "PHPSESSID=".session_id();

			}
			return $u;
		}

		if ($m)
			{
				$uri = new IGKHtmlUri();
				$uri->setValue($bck);
				return $uri->getValue($option);
			}
			else{
				//treat href data
				if (IGKValidator::IsUri($bck)){
					//domain remove
					if (IGKString::StartWith($bck, "?") == false)
					{
					}
				}
				else{
					if ($this->m_owner["onclick"] != null)
					{
						$bck =  "#";//javascript:void();";
					}
				}
			}

		return $bck;
	}

}

///<summary>represent a href link data</summary>
class IGKHtmlA extends IGKHtmlItem
{
	private $m_href;
	private $m_rdef;
	var $domainLink;
	public function __construct(){
		parent::__construct("a");
		$this->m_href = new IGKHtmlAHref($this);
		$this->domainLink=0;
		parent::offsetSet("href", $this->m_href);
	}
	public function offsetSet($k,$v){
		if ($k == "href")
		{
			if ($this->m_href !== $v){
				$this->m_href->setValue($v);
				return;
			}
			else
				igk_die("can't set the href to the same value");
		}
		parent::offsetSet($k,$v);
	}
	protected function __AcceptRender($option = null){
		if(!$this->getIsVisible())
			return false;
		if ($this["onclick"] == null)
		{
			$bck = $this["href"]->getUri();
			$kr = is_string($bck)?$bck: IGKHtmlUtils::GetValue($bck);
			if (IGKString::StartWith(trim($kr), "javascript"))
			{
				$this["onclick"] = $kr." return false;";
				$this->m_rdef = 1;
			}
		}
		return true;
	}
	public function RenderComplete($option = null){
		if($this->m_rdef ==1){
			$this["onclick"] = null;
			$this->m_rdef = 0;
		}
	}
}

final class IGKHtmlTable extends IGKHtmlItem
{
	private $m_headers;
	public function __construct(){
		parent::__construct("table");
		$this["class"] = "igk-table";
	}
	public function setHeader(){
		if ($this->m_headers ){
			$this->m_headers->ClearChilds();
		}
		else
			$this->m_headers = $this->addTr();
		foreach(func_get_args() as $k=>$v){
			$this->m_headers->add("th")->Content = $v;
		}
	}
	public function addRow(){
		return $this->addTr();
	}
}


//current session class event
final class IGKHtmlClassSessionOpt extends IGKObject{
	var $regClass; //registered class
	var $regParentClass; //used to store parent of class
	public function __construct(& $tab)
	{
		$this->regClass = & $tab;
		$this->regParentClass = array();
		//$this->regEvent = new IGKEvents($this, "regEvent");
	}
	// function __sleep(){
		// // sleep DISABLE ClassSessionOpt
		// return array();
	// }
}

/// represent classe used to register platform css class definition
final class IGKHtmlClassValueAttribute 
extends IGKHtmlItemAttribute
implements Serializable
{
	private $m_classes ;
	private $m_expressions; //used to store inserted expression
	// private $m_owner;
	private static $sm_regClass = null;

	// public function getOwner(){
		// return $this->m_owner;
		
	// }
	public function serialize(){
		if (igk_get_env("seri")){
			igk_wln("dected loop");
			igk_exit();
		}
		igk_set_env("seri", 1);
		//igk_wln("serialize");
		$s =  'v:'.implode(" ",array_keys($this->m_classes)).';';//"99999";
		igk_set_env("seri", null);
		return $s;
	}
	public function unserialize($data) {
		$o = igk_unseri_data($data);
		
		// igk_wln("unserialize ".$data);
		$tab = explode(" ", $o->v);
		$this->m_classes = array_combine($tab, $tab);
		
		//igk_wln("owner ".$this->m_owner);
		//-
		//get serialize
		//-
		$r = igk_getv($o, "r");//owner
		if ($r){
			// $v = 'O:8:"stdClass":1:{s:5:"value";r:'.$r.';}';		
			$owner = igk_get_env("sys://serialize/owner");
			igk_wln("owner : ".$owner);
igk_wln($r);			
			$v = 'O:8:"stdClass":1:{s:5:"value";r:1;}';	
			igk_wln("try : ".$v);			
			// $gg = unserialize($v);
			// igk_wln(get_class($gg->value));
			// igk_wln($gg->value);
			// unset($gg);
			// exit;
			// if ($gg !== false){
				// //$this->m_owner = $gg->value;
			// }						
		}
		//igk_die("kjd");
    }
	public function __sleep(){
		$c= array();
		if (!empty($this->m_classes)){
			//igk_wln($this->m_classes);
			$c[] ="\0".__CLASS__."\0m_classes";
		}
		if (!empty($this->m_expressions))
			$c[] = "\0".__CLASS__."\0m_expressions";
		return $c;
	}
	public function __wakeup(){
		//igk_wln("waikeup ...");
	}

	public function __construct(){
		$this->m_classes = array();
		$this->m_expressions = array();
		// $this->m_owner =$owner;
		// igk_wln(get_class($owner));
		// exit;
	}
	public function getKeys(){
		return array_keys($this->m_classes);
	}
	//register current class
	private static function _RegClass($name)
	{
		$v = & self::_GetRegClass();
		$App = igk_app();
		if (($App->Doc == null) ||
			isset($App->Doc->SysTheme->def[$name])||
			(isset($App->Doc->Theme->def[$name])))
			{
				return;
			}

		if (!isset($v[$name]))
		{
			$v[$name] = $name;
			self::_initThemeDef($App, $name);
			igk_invoke_session_event(IGKApp::$REG_CSS_CLASS_EVT, array($App, $name));
			//$App->Session->RegClasses->onPropertyAdded($name);
		}

	}
	private static function _initThemeDef($App, $name)
	{

		$tab  = array();
		$c = preg_match_all("/^\.(?P<type>(bgcl|fcl|res|ft))\-(?P<name>(.)+)$/i", $name, $tab);
		if ($c>0){
			$def = $App->Doc->Theme->def;
			for($i=0;$i<$c;$i++){
				$t = strtolower($tab['type'][$i]);
				$n = strtolower($tab['name'][$i]);
				$def[$name] = "[$t:$n]";
			}
		}
	}
	/// get if this instance contain classe name
	public function contain($name)
	{
		return isset($this->m_classes[$name]);
	}
	private static function _UnRegClass($name)
	{

		$v = & self::_GetRegClass();
		if (isset($v[$name]))
		{
			unset($v[$name]);
			igk_invoke_session_event(IGKApp::$REG_CSS_CLASS_EVT, array($App, null));			
		}

	}
	//unregister css class
	public static function UnRegClass($key){
		self::_UnRegClass($key);
	}
	//get all registrated css class
	public static function GetRegClass(){
		return self::_GetRegClass();
	}
	//return the reference of this object
	private static function & _GetRegClass(){
		if (self::$sm_regClass === null)
		{
			if (igk_app()->Session->RegClasses !==null)
			{
				self::$sm_regClass = & igk_app()->Session->RegClasses->regClass;
			}
			else{
				self::$sm_regClass = array();
				igk_app()->Session->RegClasses = new IGKHtmlClassSessionOpt( self::$sm_regClass);
			}
		}
		return  self::$sm_regClass;
	}
	public function Clear(){
		$this->m_expression = array();
		$this->m_classes = array();
	}
	//add class with the add value
	public function add($class)
	{
		if (empty($class))
			return;
		$tab = explode(" ", $class);
		if (count($tab) == 1)
		{
			$this->_add($class);
		}
		else{
			foreach($tab as $v)
			{
				$this->_add($v);
			}
		}
		if (igk_count($this->m_expressions)>0){
		}
		// igk_wln($this->m_expressions);
		//e_xit;
	}
	private function _add($v)
	{
	// if ($v == "igkdev_com_games_jbgame_application")
	// {
		// igk_wln(igk_show_trace());
		//e_xit;
	// }
	//igk_wln("add ".$v);
		$v = trim($v);
		if (strlen( $v) > 0)
		{
			switch($v[0])
			{
				case '-'://remove the class
					$v = substr($v,1);
					$this->remove($v);

				break;
				case '+'://add a new class
					$v = substr($v, 1);
					if (!isset($this->m_classes[$v]))
					{
						$this->m_classes[$v] = $v;
					}
					self::_RegClass(".".$v);
				break;
				case "[":
				case "{"://bind with expression - filter it
					$this->m_expressions[] = $v;
					// igk_die("d:".$v);
					// igk_wln("bind expression .....".$v);
					//igk_exit();
				break;
				 default:
				if (!isset($this->m_classes[$v]))
				{
					$this->m_classes[$v] = $v;
				}
				self::_RegClass(".".$v);
				break;
			}
		}
	}


	public function remove($class)
	{
		if (empty($class))
			return;
		if (isset($this->m_classes[$class]))
		{
			unset($this->m_classes[$class]);
		}
	}

	///<summary>get html css class presentation value</summary>
	public function getValue($options=null){

		$out = IGK_STR_EMPTY;
		//for class mail info
		$i = 0;
		foreach($this->m_classes as $k=>$v)
		{
			if ($i == 0)
					$i= 1;
			else
				$out .=" ";
			//replacing parent item
			if (self::IsCssChild($v))
			{
				$out .= self::GetParentClass(igk_app()->Doc->Theme, $v);
			}
			else
				$out.= $v;
		}
		$b = IGKHtmlUtils::GetValue($out);
		return empty($b)? null: $b;
	}
	public static function IsCssChild($v){
		$c = igk_app();
		if ($c &&  $c->Doc)
		{
			$s = $c->Doc->Theme[$v];
			if (!empty($s))
			{
				//check matrix match
				$r= preg_match(IGK_CSS_CHILD_EXPRESSION_REGEX, trim($s));
				return $r;
			}
		}
		return false;
	}
	private static function GetParentClass($theme, $v)
	{
		$s = $theme[$v];
		if (!empty($s))
		{
				$t = array();
				if (preg_match_all(IGK_CSS_CHILD_EXPRESSION_REGEX, $s, $t))
			    {
					 $vv = $t["name"][0];
					if (self::IsCssChild($vv))
					 {
						return self::GetParentClass($theme, $vv);
					}
					return $vv;
				}
		}
		return $v;
	}
	public function EvalClassStyle(){
		$out = IGK_STR_EMPTY;
		$i = 0;
		foreach($this->m_classes as $k=>$v)
		{
			if ($i == 0)
					$i= 1;
			else
				$out .=" ";
			$out .= igk_css_get_style(".".$v);
		}
		return $out;
	}
}

///<summary>style presentation value used only to store additional style for an item</summary>
final class IGKHtmlStyleValueAttribute extends IGKHtmlItemAttribute{
	private $m_v;
	private $m_o;
	public function __construct($target){
		$this->m_o = $target;
	}
	public function setValue($value){
		if (($value == null) || is_string($value))
			$this->m_v = $value;
		else{
			igk_die("no value allowed ".$value . " target :".get_class($this->m_target));
		}
	}
	public function getValue($options=null){//get style value
		$opt = IGK_STR_EMPTY;
		if (igk_xml_is_options_mail($options)){
			$p = $this->m_o["class"];

			$style = new IGKCssStyle();
			$s = trim($p ? $p->EvalClassStyle() : IGK_STR_EMPTY);

			if (!empty($s))
				$style->Load($s, 1, $p);

			$opt .= igk_css_get_style_from_map($this->m_target, $options, $style);
			// if (empty($opt))
				// return null;
		}
		if (!empty($opt) && !empty($this->m_v))
			$opt .= " ";
		$opt = $opt.$this->m_v;
		return empty($opt) ? null: $opt;
	}
	function __sleep(){
		if (empty($this->m_v)){
			return array();
		}
		return array("m_v", "m_o");
	}
	function __wakeup(){
	}
}



//text element
class IGKHtmlText extends IGKHtmlItemBase
{

	private $m_text;
	protected function __getRenderingChildren($option=null){return null;}
	public function getTagName(){return "igk:text"; }
	public function getType(){return "HtmlText"; }
	public function getIsRenderTagName(){return false;}
	public function getContent(){
		return $this->m_text;
	}
	public function setContent($v){
		$this->m_text = $v;
		return $this;
	}
	public function ClearChilds(){//do nothing
	}
	public function __construct($content = null){
		parent::__construct();
		$this->m_text = $content;
	}
	public function Render($options=null){
		$m = IGKHtmlUtils::GetValue($this->m_text);
		$s = trim($m);
		if (strlen($s)==0)
			return null;
		return $this->getDepthIndent($options).$m;
	}
	protected function innerHTML(& $option=null){
		return null;
	}
	protected function _AddChild($item, $index=null){return false;}
	public function add(){return null;}
	public function getIsVisible(){return true;}
	public function getNodeType(){return IGKXMLNodeType::TEXT; }
	public function __toString(){
		return __CLASS__."#".$this->TagName.":".$this->m_text;
	}
}

///<summary>represent a html process item instruction like <%, %\> </summary>
class IGKHtmlProcessInstruction extends IGKHtmlItemBase
{
	private $m_content;
	protected function __getRenderingChildren($option=null){return null;}
	public function getIsRenderTagName(){return false;}
	public function getContent(){return $this->m_content;}
	public function __toString(){
		return __CLASS__."#".$this->Render();
	}
	public function __construct($content)
	{
		parent::__construct();
		$this->m_content = $content;
	}
	public function Render($options=null){
		$out = "<?";
		$out .= $this->Content;
		$out .= "?>";
		return $out ;
	}
	protected function _AddChild($item, $index=null){return false;}
	public function add($item, $attributes =null, $index= null){return null;}
}

///<summary>represent a body debugger node</summary>
final class IGKHtmlBodyDebuggerNode extends IGKHtmlItem
{
	function __sleep(){
		return array();
	}
	public function __construct(){
		parent::__construct("div");
	}
	public function getIsVisible(){
		$b = parent::getIsVisible();
		$c = igk_debuggerview();
		return $b && $c->HasChilds && (IGKServerInfo::IsLocal() || IGKApp::$DEBUG);
	}
	protected function __AcceptRender($o=null){
		if (igk_is_atomic())
			return false;
		$c = igk_debuggerview();
		$c["class"] = "igk-debuggernode";
		$c->setStyle("max-height: 210px; overflow:auto;");
		return $this->IsVisible;
	}
	protected function __getRenderingChildren($o=null){
		$c = igk_debuggerview();
		return array($c);
	}
	public function RenderComplete($o=null){
		$c = igk_debuggerview();
		$c->getMessage();
		parent::RenderComplete();
	}
	protected function innerHTML(& $options =null){
		return null;
	}
}

//body class
final class IGKHtmlBody extends IGKHtmlItem
{
	private $m_script;//basic script on body
	private $m_bodyScripts;//body script list
	private $m_bodyDiv;
	private $m_bodyDebugHeader;
	private $m_appendContent; // append content to body if necessery. exemple use in igk_svg_use technique

	
	public function __toString(){
		return "HtmlBody";	
	}
	public function getDebuggerHeader(){
		return 	$this->m_bodyDebugHeader;
	}
	public function __construct()
	{
		parent::__construct("body");

		$this->m_script =  igk_createNode("script");
		$this->m_script->Content = new IGKHtmlBodyMainScript("ns_igk.init_document();");
		$this->m_bodyScripts = new IGKHtmlBodyAppendScript($this);
		$this->m_bodyDebugHeader = new IGKHtmlBodyDebuggerNode($this);
		$this->m_appendContent = igk_createNode("NoTagNode");
	}
	public function getAppendContent(){
		return $this->m_appendContent;
	}
	///<summary>get the body box</summary>
	public final function getBodyBox(){
		if ($this->m_bodyDiv===null){
			$this->m_bodyDiv = igk_html_node_BodyBox();
			parent::Add($this->m_bodyDiv);
		}
		return $this->m_bodyDiv;
	}
	///<summary>change the body box behaviour</summary>
	public final function addBodyBox(){
		return $this->getBodyBox();
	}

	public function getSharedContent()
	{
		return igk_getctrl(IGK_SHARED_CONTENT_CTRL)->TargetNode;
	}
	public function ClearChilds(){
		parent::ClearChilds();
		if ($this->m_bodyDiv){
			$this->m_bodyDiv = null;
		}
		return $this;

	}
	///load addition script content when page request loaded.
	public function addScriptContent($key, $script){//add script function to body main script
		return $this->m_script->Content->addScript($key, $script);
	}
	private function _getList($options, & $t){//return list of subitem

		$t[] = $this->m_bodyDebugHeader;//->Render($options);
		$t = array_merge($t, $this->Childs->ToArray());

		$t[] = $this->SharedContent;//->Render($options);
		$t[] = $this->m_script;//->Render($options);
		if (!(igk_xml_is_options_mail($options)))
			$t[] = $this->m_bodyScripts;//->Render($options);

		if (!igk_get_env("igk://nopowered")){
			$d = igk_sys_powered_node();
			if ($d){
				$t[] = $d;//->Render($options).$ln;
			}
		}

		$t[] = $this->m_appendContent;
	}
	protected function innerHTML(& $options=null){

		$t = array();
		$this->_getList($options, $t);
		return igk_html_render_node($this, $options, $t);
	}
	protected function __getRenderingChildren($option=null){
		$t = array();
		$this->_getList(null, $t);
		return $t;
	}


	public function appendScript($scriptfile, $canbeMerged=false,  $index=0){
		$this->m_bodyScripts->addScript($scriptfile,$canbeMerged, $index);
	}
	public function removeScript($scriptfile){
		$this->m_bodyScripts->removeScript($scriptfile);
	}
	public function appendScriptNode($id){
		$sc = igk_createNode("script");
		$this->m_bodyScripts->addScriptNode($id, $sc);
		return $sc;
	}
	public function removeScriptNode($id){
		$this->m_bodyScripts->removeScriptNode($id);
	}
}

final class IGKHtmlBodyAppendScript extends IGKHtmlItem
{
	private $m_scripts;
	private $m_tscripts;
	public function __construct(){
		parent::__construct("igk:bodyscript");
		$this->m_scripts = array();
		$this->m_tscripts = array();
		parent::add($this->m_childv );
	}
	public function add($name, $attributes=null, $index=null){
		return null;
	}
	public function addScriptNode($id, $n){
		if (!isset($this->m_tscripts[$id]))
			$this->m_tscripts[$id] = $n;
	}
	public function removeScriptNode($id){
		unset($this->m_tscript[$id]);
	}
	public function addScript($file=null,$canBeMerged=false, $index=0){	//Append Body Script
		$c = new  IGKHtmlScript($file);

		if ($index!=0){
			$c->Index = $index;
		}
		else{
			$c->Index = 0;
		}
		$this->m_scripts[$file] = $c;
		$tab = array_values($this->m_scripts);
		igk_usort($tab, array(get_class($this), "__sortScript"));
		//initialize the scripts
		$this->m_scripts = array();
		foreach($tab as $k=>$v){
			$this->m_scripts[$v->link] = $v;
		}

	}
	public static function __sortScript($a, $b){
		$aa = $a->Index;
		$bb = $b->Index;
		if ($aa==$bb)return 0;
		return ($aa<$bb)?-1:1;
	}
	public function removeScript($scriptFile){
		if (isset($this->m_scripts[$scriptFile]))
		{
			unset($this->m_scripts[$scriptFile]);
		}
	}
	protected function innerHTML(& $options=null){
		$s = IGK_STR_EMPTY;
		foreach($this->m_scripts as $k=>$v)
		{
			$s .= $v->Render($options);
		}
		return $s;
	}
	public function getIsRenderTagName(){return false;}
	protected function __getRenderingChildren($option=null){
		$tab = array();
		foreach($this->m_scripts as $k=>$v)
		{
			if ($v->getIsVisible())
				$tab[] = $v;
		}
		foreach($this->m_tscripts as $k=>$v)
		{
			if ($v->getIsVisible())
				$tab[] = $v;
		}
		return $tab;
	}
}
final class IGKHtmlBodyMainScript implements IIGKHtmlGetValue
{
	private $m_base;
	private $m_scripts;
	private $m_v;

	public function __construct($value){
		$this->m_base = $value;
		$this->m_v = $value;
		$this->m_scripts = array();
	}
	public function getScriptAt($index)
	{
		return igk_getv($this->m_scripts, $index, null);
	}
	///<summary>add inline script to bodymain  script</summary>
	///<return>index of this script</return>
	public function addScript($key,  $script){//add script to body main script
		if (!isset($this->m_scripts[$key]))
		{
			if (is_string($script))
				$this->m_v .= $script;
			else {
				$this->m_v .= IGKHtmlUtils::GetValue($script);
			}
			$this->m_scripts[$key] = $script;
		}
		else{
			$this->m_scripts[$key] = $script;
			$this->_initValue();

		}
		return igk_count($this->m_scripts);
	}
	private function _initValue(){
		$this->m_v = $this->m_base." ".implode('',$this->m_scripts);
	}
	public function removeScript($index )
	{
		$str = igk_getv($this->m_script, $index);
		if ($str)
		{
			unset($this->m_script[$index]);
			$this->_initValue();
		}
	}
	public function __toString(){
		return __CLASS__.":#".$this->getValue();
	}
	public function getValue($option=null){
		return $this->m_v;
	}

}


///<summary>represent the base component node item</summary>
abstract class IGKHtmlComponentNodeItem extends IGKHtmlItem
	implements IIGKHtmlComponent
{
	// private $m_controller;
	const  IGK_COMPONENT_CTRL_FLAG = 0xc001;
	public function getController(){
		return $this->getFlag(self::IGK_COMPONENT_CTRL_FLAG); //$this->m_controller;
	}
	public function getComponentUri($uri){
		return $this->getController()->getUri($uri, $this);
	}
	public function getComponentId(){
		return $this->getParam(get_class($this->m_controller).":id");
	}
	public function __construct($tagname, $controller=null){
		$ctrl = $controller ?? igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, false) ?? new IGKComponentManagerCtrl();		
		parent::__construct($tagname);
		
		
		if ($ctrl){
			$this->setFlag(self::IGK_COMPONENT_CTRL_FLAG, $ctrl);
			$ctrl->Register($this);
			//expose component id
			// $this->setParam(IGK_COMPONENT_ID_KEY, new IGKHtmlComponentIdValue($this));
		}else{
			igk_die("component failed");
		}
	}
	///<summary>dispose component</summary>
	public function Dispose(){	//dispose component
		$c = $this->getController();
		if ($c !=null){
			$c->Unregister($this);
				$this->setFlag(self::IGK_COMPONENT_CTRL_FLAG, null);
		}
		parent::Dispose();
	}
}

final class IGKHtmlComponentIdValue implements IIGKHtmlGetValue
{
	private $m_host;
	public function __construct($host)
	{
		$this->m_host = $host;
	}
	public function getValue($options=null){
		if (method_exists($this->m_host, "getComponentId"))
			return $this->m_host->getComponentId();
		$ctrl = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, true);
		return $ctrl->getComponentId($this->m_host);//"componentIdIsnull";
	}
	public function __toString(){
		return $this->getValue();
	}
}

//---------------------------------------------------------------------------------------------
//CLASS: HTMLDOC
//---------------------------------------------------------------------------------------------
///<summary>represent the a igk app document instance</summary>
final class IGKHtmlDoc extends IGKHtmlComponentNodeItem
{
	// private $m_parent;//igk app parent object that host the document . by default is IGKApp
						 //preferer null data
	private $m_metaManager;
	private $m_scriptManager; //manage global script attatched to document
	// private $m_linkManager;
	//private $m_params; //param will store data associate to ducument
	// private $m_namespase = "http://www.igkdev.com/schema";
	private $m_components; //used component list en register node that required some special behaviour. by id
	private $m_head;
	private $m_body;
	// private $m_title;
	// var $m_doctype;
	// var $m_sys_theme; //système - global theme use for configuration
	var $m_theme;     //custom - theme
	var $m_private; //temporary theme will not be serialized
	// var $m_favicon;
	//var $lang; //set or set the lang of this document default lang is fr

	const IGK_DOC_TYPE_FLAG = 0xB01;
	const IGK_DOC_TITLE_FLAG = self::IGK_DOC_TYPE_FLAG + 1 ;
	const IGK_DOC_LINKMANAGER_FLAG= self::IGK_DOC_TYPE_FLAG + 2;
	const IGK_DOC_FAVICON_FLAG= self::IGK_DOC_TYPE_FLAG + 3;
	
	//<summary>shortcut to igk  app</summary>
	public function getApp(){
		return igk_app();
	}
	public function getLang(){
		return $this->getApp()->Configs->default_lang;
	}
	public function getDocType(){
		$d= $this->getFlag(self::IGK_DOC_TYPE_FLAG) ?? IGK_DOC_TYPE;
		return "<!DOCTYPE ".$d.">";
	}
	public function getNameSpace(){
		return "http://www.igkdev.com/schema";
	}
	public function setHtmlOptions($attr, $value){
		$this->setParam("doc://html/{$attr}", $value);
	}
	public function getHtmlOptions(){
		$c = $this->m_params;
		$ns = "doc://html";
		if ($c)
			return igk_array_to_obj($c, $ns);
		return $c;
	}
	
	///<summary>setup document title</summary>
	public function setTitle($value){//document title
		$g = $this->getFlag(self::IGK_DOC_TITLE_FLAG);
		if ($value ===null) {
			
			igk_html_rm($g);
			$this->setFlag(self::IGK_DOC_TITLE_FLAG, null);
			return;
		}
		if ($g === null)
		{
			$g = $this->m_head->add("title");
			$this->setFlag(self::IGK_DOC_TITLE_FLAG, $g);
		}
		
		igk_html_add($g, $this->m_head);		
		$g->Index = -9999;
		$g->Content = $value;
		return $this;
	}
	public function getTitle(){
		$g = $this->getFlag(self::IGK_DOC_TITLE_FLAG);
		if ($g !== null)
		{
			return $g->Content;
		}
		return null;
	}
	
	///<summary>render this document as html context</summary>
	public function RenderHtmlAJX($options=null, $header=IGK_HTML_CONTENT_TYPE){
		igk_set_header('200', $header);
		$this->RenderAJX($options);
	}
	public static function LastRenderedDocument(){
		$api = igk_app();
		return $api->Session->getParam(IGK_KEY_LAST_RENDERED_DOC);
	}
	private static function SetLastRenderingDocument($doc){

		$api = igk_app();
		if (!$doc->getParam(IGK_KEY_DOC_NO_STORE_RENDERING))
		$api->Session->setParam(IGK_KEY_LAST_RENDERED_DOC, $doc);
	}
	public function setHeaderColor($cl){
		$sm = $this->getMetas();
		$n = "theme-color";
		$meta = $sm->getMetaById($n);
		if ($meta==null){
				$meta =  igk_createNode("meta");
				$meta["name"]=$n;
				$this->Metas->addMeta($n, $meta);
		}

		// $this->m_metas["keywords"]  = $this->m_node->add("meta", array("name"=>"keywords",
		// "content"=>
		// $pmetas?$pmetas->Keywords:IGK_STR_EMPTY));
		// $m= igk_createNode("meta");
		$meta["name"]= "theme-color";
		$meta["content"] = $cl;
	}

	public function __toString(){
		return get_class();
	}
	public function toString(){
		return get_class();
	}
	public function getMetas(){return $this->m_metaManager; }
	public function getBody(){return $this->m_body; }
	public function getHead(){return $this->m_head;}
	public function getSysTheme(){
		return igk_app()->Session->getParam(IGKSession::SESS_GLOBAL_THEME, function(){
			return  new IGKHtmlDocTheme(igk_app(), "sys://document");
		});
	}
	public function getTheme(){return igk_get_env("sys://css_temp")? $this->m_private: $this->m_theme;}
	public function getTempTheme(){return $this->m_private; }
	public function getTemporaryCssDef($minfile, $export, $reset=0){

		igk_set_env("sys://css_temp", 1);
		$p =  $this->m_private->get_css_def($minfile, $export);
		igk_set_env("sys://css_temp", null);
		if ($reset){
			$this->m_private->resetAll();
		}
		return $p;
	}

	public function getScriptManager(){return $this->m_scriptManager; }
	public function setDocType($value){ $this->m_docType = $value;}
	public function getElementById($name){
		$tab = array();
		$r1 = $this->m_head->getElementById($name);
		$r2 = $this->m_body->getElementById($name);
		if (is_array($r1))
			array_merge($tab, $r1);
		else
			$tab[] = $r1;
			if (is_array($r2))
			$tab = array_merge($tab, $r2);
		else
			$tab[] = $r2;
			if (count($tab) == 1)
				return $tab[0];
			return $tab;

	}

	public function & getElementsByTagName($name){//document get element by tag name
		$n  = strtolower($name);
		$tab = array();
		if ($n == "head"){ $tab [] = $this->m_head; return $tab;}
		if ($n == "body"){ $tab [] = $this->m_body; return $tab;}
		$tab1 = $this->m_head->getElementsByTagName($name);
		$tab2 = $this->m_body->getElementsByTagName($name);
		$h = array_merge($tab1, $tab2);
		return $h;
	}
	//store the global script manager
	static $sm_scriptManager;
	
	private function prepareScriptManager(){
		if (self::$sm_scriptManager != null)
			return self::$sm_scriptManager;
		$q = $this;
		self::$sm_scriptManager = igk_get_class_instance(IGKHtmlScriptManager::class, function()use($q){
			return new IGKHtmlScriptManager($q);
		});
		return self::$sm_scriptManager;
	}
	///<summary>.ctr initialize a document</summary>
	///<param name="parent">Application</param>
	///<param name="context">if context setup will generate child hierachi document </param>
	public function __construct($parent=null, $context=false, $themeId="theme://document"){
		// igk_ilog("create new document ".igk_env_count(__METHOD__) . " ".$parent);
		
		parent::__construct("document");
		// $this->m_parent = $parent;
		// $this->m_params = array();
		$this->m_components = array();
		$this->m_head = new IGKHtmlHead($this);
		igk_html_add($this->m_head, $this);
		$this->m_body = new IGKHtmlBody();
		igk_html_add($this->m_body, $this);
		$this->m_scriptManager = $this->prepareScriptManager(); 
		//$this->m_linkManager = new IGKHtmlLinkManager($this);
		$this->m_metaManager = new IGKHtmlMetaManager($this, $parent->Doc);

		//share the m_sys_theme
		// $this->m_sys_theme =
		// igk_wln("the new teheme ".get_class($this->m_sys_theme->def));


		$this->m_private = new IGKHtmlDocTheme($this, "css:private");//temporary theme
		$this->m_theme = new IGKHtmlDocTheme($this, $themeId);//private theme

		$this->lang = "fr";
		//raise on new document created
		$this->App->OnNewDocumentCreated($this);

		if ($context){
			//
			// igk_die('init system controller'.$context);
			// igk_ilog("init system controller ");
			$this->setup_document();
			igk_css_add_doc_style($this);
			$parent->Doc->ScriptManager->bindScriptTo($this);
		}
	}
	///<summary>setup global document</summary>
	public function setup_document()
	{
		$this->_initThemes();
		$this->m_body["class"] = "igk-body";
	}
	private function _initThemes(){
		//init the default main document theme
		// return;
		$d = igk_app()->Doc;
		if ($d !== $this){ //check if the application if the current global document
			return;
		}


		$vsystheme = $this->getSysTheme();

		//global document themes
		$vsystheme->Name = "igk_system_theme";
		$this->m_private->Name = "igk_private_theme";
		//set the default name
		$this->m_theme->Name = "default";

		$vsystheme->def->Clear();
		$def = $vsystheme->def;
		$def[IGK_CSS_MEDIA_TYPE_CLASS] = "z-index:-9999; content:'global'";
		

		//init colors
		$d = $vsystheme->get_media( IGKHtmlDocThemeMediaType::SM_MEDIA);//$this->m_sys_theme->reg_media("(max-width:700px)");
		$d = $vsystheme->get_media( IGKHtmlDocThemeMediaType::XSM_MEDIA);

		//.end primary theme definitions
		$d = $vsystheme->reg_media("(max-width:700px)");


		
		//igk platform theme definition
		$lfile = [];
		//load cache css files

		$v_cache_file = igk_io_dir(igk_io_baseDir(IGK_LIB_DIR."/Cache/css.cache"));
		if (file_exists($v_cache_file)){
			igk_css_include_cache($v_cache_file, $lfile);
		}
		else{
			$lfile[] = igk_io_dir(IGK_LIB_DIR."/Styles/global.pcss");
			$lfile[] = igk_get_env("sys://css/file/global_color", igk_io_dir(IGK_LIB_DIR."/igk_css_colors.phtml"));
			$lfile[] = igk_get_env("sys://css/file/global_template", igk_io_dir(IGK_LIB_DIR."/igk_css_template.phtml"));
		}
		$g = implode(";",$lfile);
		$g = str_replace(IGK_LIB_DIR, "%lib%", $g);
		$vsystheme->def->setFiles($g);
		
	
		//store default files
			
		//bind ctrl styles definition
		$this->m_private->resetAll();
		// $this->m_parent->bindCtrlStyle();
	}
	public function getSystemCssContent($min=false)
	{
		$o = IGK_STR_EMPTY;
		foreach($def->Attributes as $k=>$v)
		{
			if (!$min)
			{
				$o.=IGK_CLF;
			}
			$o .= $k."{".igk_css_treat($this->m_sys_theme, $v)."}";
		}
		return $o;
	}
	public function initSysTheme()
	{
		//init configurable variables
		igk_get_uvar("CONFIG_SCHEMA_FONT", "R/Fonts/PDFFont.TTF", true);
		igk_get_uvar(IGK_CSV_SEPARATOR, ",", true);
		igk_get_uvar("CONFIG_DB_MAX_VISIBLEITEM", "50", true);
	}

	
	///<summary>shortcut to add script</script>
	public function addScript($file=null, $tag=null, $canbeMerged=true ){//document addScript
		igk_assert_die(($tag==null) && igk_is_debug(), "/!\\ error : please set tag ");
		
		return $this->m_scriptManager->addScript($file, $canbeMerged, $tag);
	}

	public function addLink($name){
		$link = $this->getFlag(self::IGK_DOC_LINKMANAGER_FLAG);
		if ($link == null){
			$link = new StdClass();
		}
		
		igk_die("not implement");
		
		
		//return $this->m_linkManager->addLink($name);
	}

	///<summary>load temp extra script file. must be called out of rendering context. /!\\ Before</summary>
	public function addTempScript($file, $onlyonce=1){
		$v_t = igk_get_env("sys://temp/script");
		if ($v_t == null){
			$v_t = new IGKHtmlSingleNodeViewer( igk_html_node_NoTagNode());
		}
		$t = $v_t->targetNode;
		$g = $t->getParam("files");
		if ($g == null)
			$g = array();

		if ($onlyonce && isset($g[$file])){
			igk_ilog("file allready loaded : {$file}", __FUNCTION__);
			return;
		}
		$g[$file]=1;
		$ln = $t->addScript($file);
		igk_set_env("sys://temp/script", $v_t);
		igk_html_add($v_t, $this->m_head);
		return $ln;
	}

	///<summary>add tempory file to temp document. must be called out of rendering context.
	///the file will be requested with link in the header
	///</summary>
	public function addTempStyle($file){
		$v_t = igk_get_env("sys://temp/css");
		if ($v_t == null){
			$v_t = new IGKHtmlSingleNodeViewer( igk_html_node_NoTagNode());
		}
		$ln = $this->__addStyle($v_t->targetNode, $file);
		igk_set_env("sys://temp/css", $v_t);
		igk_html_add($v_t, $this->m_head);
		return $ln;
	}

	protected function __addStyle($n, $file , $system=false){
		$g = $n->getParam("sys://css");
		if ($g==null){
			$g = array();
		}
		if (isset($g[$file])){
			return $g[$file];
		}


		$ln = new IGKHtmlCssLink($file, $system);
		$n->add($ln);
		$g[$file] = $ln;
		$n->setParam("sys://css", $g);
		return $ln;
	}

	///<sumary>file : relative path to file according to system base dir</summary>
	public function addStyle($file, $system=false){
		return $this->__addStyle($this->m_head, $file, $system);


	}
	public function removeStyle($file)
	{
		$g = $this->m_head->getParam("sys://css");

		if (isset($g[$file])){
			$ln =  $g[$file];
			igk_html_rm($ln);
			unset($g[$file]);
			$this->m_head->setParam("sys://css", $g);
			return;
		}

		$tab = ($c =  $this->m_head->Childs)? $c->ToArray():null;
		foreach( $tab as $k=>$v)
		{
			if (get_class($v) == "IGKHtmlCssLink")
			{
				if ($v->link == $file)
				{
					$b = igk_html_rm($v);
				}
			}
		}
	}
	public function ClearStyle()
	{
		$v_childs = array();
		//remove all style added to head
		foreach( $this->m_head->Childs as $k=>$v)
		{
			if ( get_class($v) == "IGKHtmlCssLink")
			{
				$v_childs[] = $v;
			}
		}
		foreach($v_childs as $k)
		{
			$this->m_head->remove($k);
		}
	}

	public function getStylesList(){
		$v_childs = array();
		//remove all style added to head
		foreach( $this->m_head->Childs as $k=>$v)
		{
			if ( get_class($v) == "IGKHtmlCssLink")
			{
				$v_childs[] = $v;
			}
		}
		return $v_childs;
	}
	public function Render( $options=null){ // Render A document
		//init document setting
		// igk_wln("render document", __FILE__.'::'.__LINE__);
		// igk_die("d");
		// igk_exit();
		if ($options==null){
			$options = igk_xml_create_render_option();
		}
			$options->Document = $this;
			$options->StandAlone = igk_html_is_fullurirequest($options);
			if (!isset($options->BodyOnly))
					$options->BodyOnly = 0;
			if (!isset($options->Indent))
					$options->Indent = 0;

		igk_set_env(IGK_ENV_CURRENT_RENDERING_DOC, $this);
		igk_notification_push_event(IGK_EVENT_DOC_BEFORE_RENDER, $this,  $options);

		$ln = ($options->Indent)? "\n" : "";
		if ($options->BodyOnly){
			$out = $this->m_body->Render($options);
			return $out;
		}

		$out =IGK_STR_EMPTY;
		$out .= $this->getDocType();
		if (defined("IGK_PADDING_HEADER")){
			$out.=str_repeat("\n\n\n", 40);
		}
		$out .=$ln;
		$lang = R::GetCurrentLang();
		$out .= "<html lang=\"".$lang."\" xmlns=\"http://www.w3.org/1999/xhtml\" xmlns:igk=\"".$this->m_namespase."\" ";

		$b = $this->getHtmlOptions();
		if ($b){
			// igk_wln($this->getParamKeys());
			// igk_wln($b);
			//e_xit;
			foreach($b as $k=>$v){
				$out.="{$k}=\"{$v}\" ";
			}
		}

		//build additional property
		if (file_exists(igk_io_currentRelativePath("manisfest.appcache")))
			$out .= "manifest=\"manifest.appcache\" ";
		$out .= "class=\"igk-web-page\" ";
		if (igk_xml_is_options_mail($options)){
			$out .= "style=\"width:100%; height:100%; \" ";
		}

		$out .= ">".$ln;

		$out .= $this->innerHTML($options).$ln;
		if ($options->Cache && ($options->Context =IGK_WEB_CONTEXT) ){
			//for caching document purpose
			$c = igk_createNode("style");
			$c["type"]="text/css";
			$c->Content = igk_css_getbasedef(1);
			$out.= $c->Render();
			unset($c);
		}
		$out .= igk_bind_host_css_style($this);
		$out .= "</html>";

		//igk_wln( $options && isset($options->NoStoreRendering) && ($nostore = $options->NoStoreRendering));
		if(!isset($options->NoStoreRendering) || !$options->NoStoreRendering){
			self::SetLastRenderingDocument($this);
		}
		return $out;
	}
	///<summary>shortcut to render node to buffer</summary>
	public function RenderAJX(& $options =null){
		// $this->Render($options);
		// return;
		igk_wl($this->Render($options));
	}

	protected function innerHTML(& $options=null){//get inner html document
		$out =IGK_STR_EMPTY;
		$ln = ($options->Indent)? "\n" : "";
		//because of rendering extra header content the algorithm is inversed
		if ($this->m_body->getIsVisible()){
			$out .= $this->m_body->Render($options);
		}
		if ($this->m_head->getIsVisible()){
			$out =  $this->m_head->Render($options).$ln .$out;
		}
		return $out;
	}
	//get the saved params
	// public function getParams()	{
		// return $this->m_params;
	// }
	// public function getbodypage(){

		// $i =  igk_getv($this->m_params, "bodypage");
		// if ($i == null)
		// {
			// igk_wln("notice: the system bodypage is null");
		// }
		// return $i;
	// }
	
	// public function __get($key){
		// if (method_exists($this, "get".$key) )
		// {
			// return call_user_func(array($this, "get".$key), null);
		// }
		// else{
			// return $this->getParam($key);
		// }
	// }
	// public function __set($key, $value){	//style
		// if (!$this->_setIn($key, $value))
		// {
			// $this->setParam($key,$value);
			// // if ($value==null)
				// // unset($this->m_params[$key]);
			// // else
				// // $this->m_params[$key] = $value;
		// }
	// }
	public function setFavicon($icon){
		$g = $this->getFavicon();
		if ($icon)
		{
			if ($g == null)
			{
				$g = new IGKHtmlFavicon();
				$g["title"] = "Favicon";
				igk_html_add($g, $this->m_head);
					$this->setFlag(self::IGK_DOC_FAVICON_FLAG, $g);
			}
			$g["rel"]="shortcut icon";
			$g["type"]="image/x-icon";
			$g["href"]=$icon;
		}
		else {
			igk_html_rm($g);
			$this->setFlag(self::IGK_DOC_FAVICON_FLAG, null);
			
		}
	}
	public function getFavicon(){
		return 	$this->getFlag(self::IGK_DOC_FAVICON_FLAG);
	}

	// public function ClearParams(){
		// $this->m_params = array();
	// }
	///<summary>clear component list</summary>
	public function ClearComponents(){
		$this->m_components  = array();

	}
	///<summary>register a component to the current document</summary>
	public function RegComponent($id, $component){

		if (isset($this->m_components[$id])){
			if ($component == null){
				$g = $this->m_components [$id];
				unset($this->m_components [$id]);
				if ($g === $component)
					$component->setParam("system://component/id", null);
				return;
			}
		}
		$this->m_components [$id] = $component;
		$component->setParam("system://component/id", $id);
	}
	public function getComponent($id){
		return igk_getv($this->m_components, $id);
	}
	public function Dispose(){ //dispose document
		$this->ClearComponents();
		parent::Dispose();
	}
}


final class IGKHtmlUri extends IGKObject
implements IIGKHtmlGetValue
{
	private $m_v;
	public function setValue($v){$this->m_v = $v;}

	public function __construct(){
	}
	public function getValue($options = null){

		$bck = $this->m_v;

		if ($options && igk_xml_is_options_mail($options))
		{
			if (!IGKValidator::IsUri($bck)){

				$tab = explode('?', $bck);
				$cf = igk_getv($tab,0);
				if (!empty($cf) && file_exists($cf)){
					$f = igk_io_baseUri(realpath($cf));
					$t = array_slice($tab,1);
					if (igk_count($t)>0)
						$f .= "?".igk_str_join_tab($t,'?', false);
					return $f;
				}
			}
			else {
				if (IGKString::StartWith($bck, "?"))
				{
					return igk_io_baseUri().$bck;
				}
			}
		}

		// ::treat href data
			// if (IGKValidator::IsUri($bck)){
				// domain remove
				// if (IGKString::StartWith($bck, "?") == false)
				// {
					// return igk_io_baseUri().$bck;
					// $d = igk_html_rm_base_uri($bck);
					// if ($d !== $bck)
					// {
						// igk_wln($bck);
						// $b = igk_io_currentRelativeUri(igk_html_rm_base_uri($bck));
						// igk_wln($b);
						// if (empty($b))
							// $this["href"] = "./";
						// else {
							// $b = igk_io_treat_lnk_referer($b);
							// $this["href"] = $b;
						// }
					// }
				// }
			// }

		return $this->m_v;
	}

}

///<summary></summary>
final class IGKHtmlMailDoc extends IGKHtmlItem
{
	private $m_theme;//theme used styles
	private $_attachement;//every render is create a new attachement container
	private $m_message;
	private $m_app;
	///<summary>get the theme used in this mail definition</summary>
	public function getTheme(){ return $this->m_theme; }
	///<summary>get the message node in this mail definition</summary>
	public function getMessage(){return $this->m_message; }
	public function getAttachement(){ return $this->_attachement; }
	public function __construct(){
		$this->m_app = igk_app();
		if ($this->m_app == null)
			igk_die("apps not initialize");
		parent::__construct("div");
		$this["class"] = "igk-mail";

		$this->m_theme = new IGKHtmlDocTheme($this->m_app, __CLASS__.":theme");

		//MAILO------------------------------
		//good solution sample
		$this->_initTheme();
		$this->m_message = $this->addDiv();
		$this->setId("message");
	}

	public function renderDoc(){

		$this->_attachement =  new IGKMailAttachementContainer();
		$p = igk_xml_create_render_option();
		$p->Context = "mail";
		$p->Attachement =	$this->_attachement;
		$s = "<!DOCTYPE ".IGK_DOC_TYPE." >";
		$s .= "<html ";
		$s .= trim($this->getAttributeString($p));
		$s .=">";
		$s .= $this->innerHTML($p);
		$s .= "</html>";
		return $s;
	}

	private function _initTheme(){
		//cause: mail truncate in gmail so we must define a mail themes definition
		// $th = $this->m_app->Doc->SysTheme;
		// $this->loadTheme($th);
		// $th = $this->m_app->Doc->Theme;
		// $this->loadTheme($th);
	}
	private function _copyAddBuildDefinition($target, $source)
	{
		$selector = array();
		foreach($source->def->Attributes as $k=>$v)
		{
			$tab = explode(',', $k);
			if (empty($v))
				continue;
			foreach($tab as $s=>$t)
			{
				if (!empty($t))
				{
					$selector[trim($t)] = $v;
				}
			}
		}
		foreach($selector as $k=>$v){
			if (IGKString::StartWith($k,".igk-mail"))
			{
				$target->def[$k.",.a3s > div "] = $v;
			}
			else {
				$target->def[".igk-mail ".$k.",.a3s > div ".$k] = $v;
			}
		}
	}
	public function loadTheme($theme){
		$this->_copyAddBuildDefinition($this->m_theme, $theme);
		foreach($theme->getMedias() as $k=>$m)
		{
			$r = $this->m_theme->reg_media($k);
			if ($r)
			$this->_copyAddBuildDefinition($r, $m);
		}
	}
	public static function  CreateFromDocument($doc){
		if ($doc==null)
			return null;
		$c = new IGKHtmlMailDoc();
		$c->m_doc = $doc;
		return $c;
	}
	//render base mail document
	public function Render($o =null){
		// if ($this->m_doc)
			// $this->setAttributes($this->m_doc->body->Attributes);
		// create attachement
		// $this->_attachement =  new IGKMailAttachementContainer();
		// $p = igk_xml_create_render_option();
		// $p->Context='mail';
		// $p->Attachement =	$this->_attachement;
		// $p->Doc = $this;
		return $this->renderDoc();//parent::Render($p);
	}
	protected function innerHTML(& $options = null){
		$out = "";
		$s = new IGKHtmlItem("style");
		$s["type"] = "text/css";
		$s->Content = $this->m_theme->get_css_def(true);


		if ($this->m_doc !=null){

			$out .= "<head>".$this->m_doc->head->innerHTML($options);
			$out .= $s->Render($options)."</head>";
			$out .= $this->m_doc->body->Render($options);
		}
		else{
			$out .= "<head>".$s->Render($options)."</head>";
			// $out .= $s->Render($options);
			// $out .= "<body>".parent::innerHTML($options)."</body>";
			$out .= parent::innerHTML($options);
		}
		unset($s);
		return $out;

	}

	//<summary>utility function . use to send this document as mail content. use IGKMail::SendDocument($doc); instend </summary>
	public function sendMail($to,$from, $subject){
		$src = $this->Render();
		 $g =  igk_mail_sendmail($to, $from, $subject,
		$src,
		null,
		$this->_attachement? $this->_attachement->getList() : null,
		"text/html");
		return $g;
	}
	public function __AcceptRender($opt =null){
		return true;
	}
}

///<summary>represent the header document's node</summary>
final class IGKHtmlHead extends IGKHtmlItem
{
	public function getTagName(){return "head"; }
	
	//private $m_doc;
	public function __construct()
	{//add method node
		parent::__construct("head");
		//$this->m_doc = $doc;
		$this->add(new IGKGlobalScriptManagerHost());
		
	}
	// public function Render($options=null){
		
		//$this->m_doc->ScriptManager;
		// return igk_html_render_node($this, $options);
	// }
	public function clearChilds(){
		parent::clearChilds();
		$this->setParam("sys://css", null);
	}
}
///<summary>used to render global script</summary>
final class IGKGlobalScriptManagerHost extends IGKHtmlItem{
	public function __construct(){
		parent::__construct('igk:scripthostnode');
	}
	public function Render($options=null){
		//$n = igk_app()->Doc->ScriptManager->getNode();
		// igk_wln("node");
		
		$v = igk_ob_get_func(function()use($options){
			igk_app()->Doc->ScriptManager->localScriptRenderCallback($options);
		});
		return $v;
		
		// igk_text($v);
		// igk_text($n);
		// session_destroy();
		// igk_exit();
		// return igk_html_render_node($n, $options);
	}
	
	// public function __sleep(){//global script manager
		// return array();
	// }
}
///<summary>represent the favicon document's node</summary>
final class IGKHtmlFavicon extends IGKHtmlItem
{
	public function __construct()
	{//add method node
		parent::__construct("link");
	}
	public function getTagName(){
		return "link";
	}
	protected function __AcceptRender($o = null){
		$src = $this["href"];
		if (is_object($src))
		{
			$s = $src->getLnk();
			if (empty($s))
				return false;
		}
		return true;
	}
	public function __sleep(){//favicon
		$src = $this["href"];
		if ($src==null)
			return array();
		$this->{"@h"}= $src->getLnk();
		return array('@h');
	}
	public function __wakeup(){
		$c = $this->{"@h"};		
		if ($c){
			$this["href"]= new IGKHtmlRelativeUriValueAttribute($c);
		}
		$this["rel"]="shortcut icon";
		$this["type"]="image/x-icon";
		unset($this->{'@h'});
	}

}

final class IGKHtmlMetaViewNode extends IGKHtmlItem
// implements Serializable
{
	public function __construct()
	{//add method node
		parent::__construct("igk-metanode");
	}
	public function getIsRenderTagName(){return false;}
	protected function __AcceptRender($options=null)
	{
		$o = $this->innerHTML($options);
		if ($options && $options->Indent)
		{
			$o = trim($o);
		}
		//igk_log_write_i("meta", $o);
		return parent::__AcceptRender($options);


	}
	public function getIsVisible(){
		 $b = $this->HasChilds;
		return $b;
	}
	
	// public function serialize(){
		// return "";
	// }
	// public function unserialize($seri){
		
	// }
}


///<summary>represent an object used to manage document's meta data.</summary>
final class IGKHtmlMetaManager extends IGKObject
{
	// private $m_htmlDoc;
	private $m_managerItem ;
	private $m_node;
	private $m_metas;
	public function RenderNode(){ return $this->m_node->Render(); }
	public function getNode(){return $this->m_node; }
	public function getAuthor(){ return IGKHtmlUtils::GetValue($this->m_metas["author"]["content"]);}
	public function getCopyright(){ return IGKHtmlUtils::GetValue($this->m_metas["copyright"]["content"]);}
	public function getDescription(){ return IGKHtmlUtils::GetValue($this->m_metas["description"]["content"]);}
	public function getKeywords(){ return IGKHtmlUtils::GetValue($this->m_metas["keywords"]["content"]);}
	public function getContentType(){ return IGKHtmlUtils::GetValue($this->m_metas["contenttype"]["content"]);}


	public function setAuthor($value){  $this->m_metas["author"]["content"] = $value;}
	public function setCopyright($value){ $this->m_metas["copyright"]["content"]= $value;}
	public function setDescription($value){  $this->m_metas["description"]["content"]= $value;}
	public function setKeywords($value){ $this->m_metas["keywords"]["content"]= $value;}
	public function setContentType($value){  $this->m_metas["contenttype"]["content"]= $value;}
	public function Render($options=null)
	{
		return $this->m_node->Render($options);
	}
	///<summary>ownerDoc is used to initialize data</summary>
	public function __construct($doc, $ownerDoc)
	{
		// $this->m_htmlDoc = $htmlDoc;
		$this->m_node = new IGKHtmlMetaViewNode();
		igk_html_add($this->m_node , $doc->head);

		$pmetas = $ownerDoc?$ownerDoc->Metas:null;
		$this->m_metas = array();
		$this->m_metas["author"]  = $this->m_node->add("meta", array("name"=>"author", "content"=>IGK_AUTHOR));
		$this->m_metas["copyright"]  = $this->m_node->add("meta", array("name"=>"copyright", "content"=>IGK_COPYRIGHT));
		$this->m_metas["description"]  = $this->m_node->add("meta", array("name"=>"Description", "content"=>
		$pmetas? $pmetas->Description: IGK_STR_EMPTY));
		$this->m_metas["keywords"]  = $this->m_node->add("meta", array("name"=>"keywords",
		"content"=>
		$pmetas?$pmetas->Keywords:IGK_STR_EMPTY));
		$this->m_metas["contenttype"]  = $this->m_node->add("meta", array("http-equiv"=>"Content-Type", "content"=>"text/html; charset=utf-8"));
		$this->m_metas["generator"]  =$this->m_node->add("meta", array("name"=>"generator", "content"=> igk_app_version()));
	}
	// public function __sleep(){//meta view node
		// return array();
	// }
	// public function __wakeup(){
		// $this->m_node = new IGKHtmlMetaViewNode();		
	// }
	public function addMeta($name, $meta)
	{
		if ($meta && !isset($this->m_metas[$name])){
			$this->m_node->add($meta);
			$this->m_metas[$name] = $meta;
			return 1;
		}
		return 0;
	}
	public function rmMeta($name)
	{
		if (isset($this->m_metas[$name]))
		{
			unset($this->m_metas[$name]);
		}
	}
	public function getMetaById($name){
		if (isset($this->m_metas[$name]))
		{
			return $this->m_metas[$name];
		}
		return null;
	}
	public function __toString(){ return "HtmlMetaManager";}
}


///<summary>represent a callback node</summary>
///<usage>use to add a node with content comming on render</summary>
final class IGKHtmlCallbackNode extends IGKHtmlItem{
	var $callback;
	public function __construct(){
		parent::__construct('igk:callbacknode');
	}
	public function getIsRenderTagName(){
		return false;
	}
	public function __AcceptRender($option=null){
		return 1;
	}
	public function Render($options=null){
		IGKOb::Start();
		$fc = $this->callback;
		$fc($options);
		$s = IGKOb::Content();
		IGKOb::Clear();
		return $s;
	}
}

final class IGKHtmlScriptManager extends IGKObject
{
	//private $m_o; //script manager owner. generally a document
	private $_f;//flag used store script manager params

	//flag params
	const MANAGER_FLAG = 1;
	const JSMAN_ASSOC_TABLE_FLAG =2;
	const DOC_FLAG = 3;
	const JSMAN_NODE = 4;
	const SCRIPT_ITEM_MANAGER= 5;


	public function Flags(){return $this->_f; }
	//<summary>get flag param</summary>
	public function getFlag($n,$default=null){
		return $this->_f->getFlag($n,$default);
	}
	public function getManager(){
		return $this->getFlag(self::MANAGER_FLAG);
	}
	///<summary> get the parent document</summary>
	public function getDoc(){ return $this->getFlag(self::DOC_FLAG);}
	public function getNode(){
		return $this->getFlag(self::JSMAN_NODE);
	}
	public function getAssoc(){
		$g = igk_get_env(__CLASS__);
		if ($g){
			$this->_f->setFlag(self::JSMAN_ASSOC_TABLE_FLAG, $g);
			igk_set_env(__CLASS__, null);
			return $g;
		}
		return $this->getFlag(self::JSMAN_ASSOC_TABLE_FLAG); //$this->m_assocTable;
	}
	
	// public function __sleep(){//script manager 
		// //igk_wln("sleep data ------------------------".igk_io_request_uri());
		// //igk_wln(igk_show_trace());
		// $t = igk_reflection_get_member($this);
		// if ($this->_f->isEmpty())
		// {
			// unset($t["\0".__CLASS__."\0_f"]);
		// }else {
			// $g = $this->getFlag(self::JSMAN_ASSOC_TABLE_FLAG);
			// //transform array to string presentation
			// if (is_array($g)){
				// $this->_f->setFlag(self::JSMAN_ASSOC_TABLE_FLAG, implode(";", array_keys($g)));
				// igk_set_env(__CLASS__, $g);
			// }
		// }
		// return array_keys($t);//array("_f");
	// }
	// public function __wakeup(){		
		// if (!$this->_f){
			// $this->_f = new IGKFv();
		// }else{
			// $g =$this->_f->getFlag(self::JSMAN_ASSOC_TABLE_FLAG);
			// if ($g){
				  // $d = explode(";", $g);
				  // $tab=array();
				  // foreach($d as $k){
					  // $tab[$k]=1;
				  // }
				  // $this->_f->setFlag(self::JSMAN_ASSOC_TABLE_FLAG,$tab);
			// }
		// }
	// }

	public function __construct($owner)
	{		
		$this->_f = new IGKFv();
		$this->_f->setFlag(self::DOC_FLAG, $owner);
		$this->_f->setFlag(self::SCRIPT_ITEM_MANAGER, new IGKHtmlScriptItemManager($this));
	}
	public function __toString(){ return get_class($this);  }

	public function getScript($file){
		$tasc = $this->getAssoc();
		if ($tasc && isset($tasc[$file]))
			return $this->$tasc[$file];
		return null;
	}
	public function localScriptRenderCallback($option=null){
	
		if (igk_xml_is_options_mail($option))
			return false;

		if (igk_sys_env_production() || defined("IGK_JS_TRIMSCRIPTS"))
		{
			$c = igk_createXMLNode("script");
			$c["type"]="text/javascript";
			$c["language"] = "javascript";
			$c["src"]=new IGKHtmlRelativeUriValueAttribute("R/Scripts/balafon.js?v=".IGK_BALAFON_JS_VERSION);
			$c->RenderAJX();
			return;
		}

		$tasc = $this->getAssoc();
		if ($tasc){		
			$g  = "";
			$files =array_keys($tasc);
			$buri = igk_io_baseUri();
			$libdir= igk_io_dir(IGK_BALAFON_JS_CORE_FILE );
			$bdir = igk_io_baseDir();
			foreach($files as $k=>$b){
				$bb = $bdir.DIRECTORY_SEPARATOR.$b;
				$u = igk_io_html_link($bb)->getValue();
				//igk_html_uri($buri."/".igk_io_basePath($b));
				//igk_ilog($u);
				$active="";
				if ($libdir!=$bb)
					$active="defer";
				$g .="<script type='text/javascript' language='javascript' src='{$u}' {$active}></script>";
			}
			igk_wl($g);
		}		
	}
	///<summary>register script do manager</summary>
	public function addScript($file,  $canbeMerged=true, $tag='priv'){//Script Manager
		
		$local = false;
		$fname = true;
		$f = $file;
		if (!IGKValidator::IsUri($file)){
			$fname =false;
			$f = igk_io_dir($file);
			if (file_exists($f))
			{
				$file = igk_io_basePath($f);
				// igk_ilog($file);
				$local = true;
			}
			else{
				$local = false;
			}
		}
		$tasc = $this->getAssoc() ?? array();

		
		// if (realpath($file)==realpath(IGK_BALAFON_JS_CORE_FILE)){
			// igk_wln("data === ".igk_env_count(__METHOD__));
			// igk_wln($tasc);
		// }
		if (isset($tasc[$file]))
			return $tasc[$file];

		//$node = $this->getNode();
		// $man = $this->getManager() ?? (function(){
			//init manager
			// $g = igk_createCallbackNode();
			// $g->callback = array($this, "localScriptRenderCallback");
			// $this->_f->setFlag(self::MANAGER_FLAG,$g);
			// return $g;
		// })();
		
		// if ($man ===null)
			// igk_die("manager is null");

		// if ($node == null){
			// $node = igk_html_node_BlockNode();//new IGKHtmlBlockNodeItem();
			// // igk_html_add($node, $man);
			// $this->_f->setFlag(self::JSMAN_NODE, $node);
		// }
		$g = !$fname && !$local;

		// $s = new IGKHtmlScript($g ? $f :$file);
		// if ($g)
		// {
			// $s->link =null;
		// }
		// $s->canBeMerged = $canbeMerged;
		// $s->tag = $tag; //script tag
		// //add script manager item to document head
		// $node->add($s);
		$tasc[$file] = $canbeMerged ? 1 : 2;		
		$this->_f->updateFlag(self::JSMAN_ASSOC_TABLE_FLAG, $tasc);
		return $tasc[$file];
	}


	///<summary>get merged content</summary>
	public function getMergedContent($zip=0){
		$tasc = $this->getAssoc();
		$o = "";
		if ($tasc){
			$g  = "";
			$files = array_keys($tasc);
			$buri = igk_io_baseUri();
			foreach($files as $k=>$b){
				$u = igk_html_uri($buri."/".igk_io_basePath($b));
				$o.= IGK_START_COMMENT." FILE :  ". $u."".IGK_END_COMMENT."\n";
				if ($zip)
				$o .= igk_js_minify(utf8_decode(igk_io_read_allfile($b)))."\n";//"<script type='text/javascript' language='javascript' src='{$u}'></script>";
				else
					$o .= utf8_decode(igk_io_read_allfile($b))."\n";
			}
			// igk_ilog("data");
			// igk_ilog($g);
			//igk_wl($g);
		}
		return (object)(array("data"=>$o));
	}
	
	public function getNonMergedContent($tab=null){
		// if (defined("IGK_NO_JAVASCRIPT") && IGK_NO_JAVASCRIPT){
			// return null;
		// }

		$nonMerged = $tab == null ? $this->getMergedContent()->notMerged: $tab->notMerged;
		$o = "";
		foreach($nonMerged as $k=>$v){
			$o .= $v->Render(null);
		}
		return $o;
	}

	///<summary>current script to new document</summary>
	public function bindScriptTo($document){
		if ($document ==null)
			return;
		//make a clone copy of the script tag
		$tasc = $this->getAssoc();
		if ($tasc)
		foreach($tasc as $k=>$v){
			//t:tag
			//m:merged
			list($t,$m)= igk_array_fill(explode(";", $v), 2);
			$document->addScript($k, $t, $m);
		}
	}

	///<summary>clear loaded script</summary>
	public function Clear($tag=null){
		if ($tag==null){
			$this->m_assocTable = array();
			$this->m_node->ClearChilds();
			return;
		}
		$t = array();
		foreach($this->m_assocTable as $k=>$v){
			if ($v->tag == $tag){
				igk_html_rm($v);
				continue;
			}
			$t[$k] = $v;
		}
		$this->m_assocTable = $t;
	}

	///<summary>get if this script file is loaded to the document</summary>
	public function isLoaded($file){
		//igk_ilog(igk_ob_get(array_keys($this->m_assocTable)));
		return isset($this->m_assocTable[$file]);
	}
	
	public static function InitStatic(){
		igk_reg_class_instance_key(__CLASS__, 0xc0);
	}

}//End IGKHtmlScriptManager


IGKHtmlScriptManager::InitStatic();


///<summary>Represent html node that will host all primary javascript script to load</summary>
final class IGKHtmlScriptItemManager extends IGKHtmlItem{//used to manage script on document
	private $m_scriptManager;

	public function __construct($scriptManager){
		parent::__construct("igk-script-manager");
		$this->m_scriptManager = $scriptManager;
	}
	public function getIsRenderTagName(){return true;}


	public function Render($options =null){

		if (igk_sys_env_production() || defined("IGK_JS_TRIMSCRIPTS"))
		{
			$c = igk_createXMLNode("script");
			$c["type"]="text/javascript";
			$c["language"] = "javascript";
			$c["src"]=new IGKHtmlRelativeUriValueAttribute("R/Scripts/balafon.js");
			return $c->Render();
		}
		
		$o="";
		foreach($this->Childs as $k=>$v){
			$o.=igk_html_render_node($v, $options);
		}
		return $o;
	}
}


// final class IGKHtmlLinkManager extends IGKObject
// {
	// private $m_links;
	// private $m_node;
	// public function __construct()
	// {
		// $this->m_links = array();
		// $this->m_node = null;
	// }
	// public function addLink($doc, $name){
		// if (isset($this->m_links[$name]))
			// return $this->m_links[$name];
		// if ($this->m_node == null)
		// {
			// $this->m_node = igk_html_BlockNode();
			// IGKHtmlUtils::AddItem($this->m_node, $doc->head);
		// }else{
			// igk_html_add($this->m_node, $doc->head);
		// }
		// $c = new IGKHtmlLink();
		// $this->m_node->add($c);
		// $this->m_links[$name] = $c;
		// return $c;
	// }
	
// }

///<summary>reprensent a html document default style.</summary>
//note: custom serialization is important de reduce data storage.
final class IGKCssDefaultStyle 
implements ArrayAccess, Serializable
{
	//private $m_declaredRule;
	private $_;
	
	const PROPERTIES = 0;
	const DECLARED_RULE = 1;
	const FLAG_RULE = 2;
	const SYMBOLS_RULE = 3;
	const FILES_RULE = 4; //store files;
	const COLORS_RULE = 5; //color attached 
	const PARAMS_RULE = 6; //param attached
	const FONT_RULE = 7; //font attached
	const TEMP_FILES_RULE = 8; //temp file attached
	
	public function serialize(){
		
	
		//on closing
		if (defined("IGK_FORCSS") && (session_status() == 2) && (igk_app()->Doc->SysTheme->def !== $this)){
			// igk_ilog("for css ... ".igk_env_count(__FUNCTION__));
			$bckf = igk_getv($this->_, self::FILES_RULE);		
			$s = serialize($this->_);			
			if ($bckf){
				$this->_[self::FILES_RULE] = $bckf;				
			}
			return $s;
		}
		return serialize($this->_);
	}
	public function unserialize($seri){
		$this->_ = unserialize($seri);
	}
	public function resetParams(){
		unset($this->_[self::PARAMS_RULE]);
	}
	public function & getParams(){	
		$g = & $this->prepareStorage(self::PARAMS_RULE);
		return $g;	
	}
	
	public function getAttributes(){
		return igk_getv($this->_, self::PROPERTIES);
	}
	public function getFiles(){	
		return igk_getv($this->_, self::FILES_RULE);	
	}
	public function setFiles($files){
		if (($files==null ) || !is_string($files)){
			unset($this->_[self::FILES_RULE]);
		}else{
			$this->_[self::FILES_RULE] = igk_io_collapse_path($files);
		}
	}
	public function clearFiles(){
		unset($this->_[self::FILES_RULE]);
		//igk_ilog("clear files ::: ".igk_env_count(__FUNCTION__) . " session status ? : ".session_status());
		// session_write_close();
	}
	public function & getTempFiles(){
		$g = & $this->prepareStorage(self::TEMP_FILES_RULE);
		return $g;
	}
	public function & getFont(){
		$g = & $this->prepareStorage(self::FONT_RULE);
		return $g;
	}
	///<summary>get reference to getCl</summary>
	public function & getCl(){
		$g = & $this->prepareStorage(self::COLORS_RULE);
		return $g;
	}
	private function & prepareStorage($id){		
		$g = null;
		if (isset($this->_[$id]))
			$g = & $this->_[$id];
		else{
			$g = array();
			$this->_[$id] = & $g;
		}
		return $g;
	}
	public function setCl($n,$v){		
		$g = & $this->prepareStorage(self::COLORS_RULE);
		$g[$n] = $v;
	}
	
	public function getSymbols(){
		return igk_getv($this->_, self::SYMBOLS_RULE);
	}
	public function & getRules(){
		
		$g = null;
		if (isset($this->_[self::FLAG_RULE])){
			$g = & $this->_[self::FLAG_RULE];
		}else{
			$g = array();
			$this->_[self::FLAG_RULE] = & $g;
		}
		return $g;
	}
	public function __get($n){
		igk_die("__get not allowed");
	}
	public function __set($n,$v){
		igk_die("__set not allowed");
	}
	public function offsetGet($i){
		if (!isset($this->_[self::PROPERTIES])){
			return null;
		}
		return igk_getv($this->_[self::PROPERTIES], $i);
	}
	public function offsetSet($i,$v){		
		$g = null;
		if (!isset($this->_[self::PROPERTIES])){
			$g = array();
			$this->_[self::PROPERTIES] = & $g;			
		}else {
			$g = & $this->_[self::PROPERTIES];
		}
		$g[$i]=$v;
	}
	public function offsetUnset($i){
		if (!isset($this->_[self::PROPERTIES])){
			return false;
		}
		unset($this->_[self::PROPERTIES][$i]);
	}
	public function offsetExists($i){
		if (!isset($this->_[self::PROPERTIES])){
			return false;
		}
		return isset($this->_[self::PROPERTIES][$i]);
	}

	public function getHasRules(){
		$tab = igk_getv($this->_, self::DECLARED_RULE);		
		return $tab && (igk_count($tab) > 0);
	}
	public function getRulesString($lineseparator=null){
		$o = "";
		$tab = igk_getv($this->_, self::DECLARED_RULE);		
		foreach($tab as $k=>$v){
			$o .= $k."{".$v."}".$lineseparator;
		}
		return $o;
	}
	public function __construct()
	{	
		//parent::__construct("Default");
		//$this->m_declaredRule = array();
		$this->_ = array();		
		
	}
	public function Clear(){//not implement	
		$this->_ = array();
	}
	public function __toString(){
		return get_class($this)."#items";
	}
	public function addRule($name, $expression)
	{
		$rule = & $this->_[self::DECLARED_RULE];
		$rule[$name] = $expression;
	}
	public function rmRule($name)
	{
		$rule = & $this->_[self::DECLARED_RULE];
		unset($rule[$name]);
	}

}


///<summary>used to store css properties
final class IGKCssStyle extends IGKObject
{
	private $m_properties;

	public function __construct(){
		$this->m_properties = array();
	}
	public function Load($v, $level, $source){
		$v  = igk_css_treatstyle($v);
		$tab  = igk_str_explode(array(":", ";"), $v);
		for($i=0; $i < igk_count($tab)-1; $i+=2){
			$this->m_properties[trim($tab[$i])] = trim($tab[$i+1]);
		}
	}
	public function Render(){
		$o = "";
		foreach($this->m_properties as $k=>$v)
		{
			$o .= $k.":".$v.";";
		}
		return $o;
	}
}

///<summary>used to manage compoent global style. and instance of it will be store on session</summary>
final class IGKCssComponentStyle extends IGKObject{
	private $m_loadedStyles;

	///.ctr
	private function __construct(){
		$this->m_loadedStyles = array();
	}
	public static function getInstance(){
		$k = igk_get_instance_key(__CLASS__);
		//"sys://class/instance/".__CLASS__;
		$v = igk_app()->Session->getParam($k);
		if (!$v)
		{
			$v = new IGKCssComponentStyle();
			igk_app()->Session->setParam($k, $v);
		}
		return $v;
	}
	///<summary>create a register file</summary>
	public function regFile($file, $host=null){
		if (!file_exists($file))
			return null;

		if (isset($this->m_loadedStyles[$file])){
			$ct = igk_html_node_cloneNode($this->m_loadedStyles[$file]);//igk_createNode("cloneNode",);
			return $ct;

		}
		$c = igk_createNode("style");
		$c["type"]="text/css";
		$c->setCallback("AcceptRender",
igk_create_expression_callback(
<<<EOF

if (igk_env_count('sys://rendering/'.\$file)>1)
	return false;
\$bind->Content = igk_bind_host_css_style_file(\$file, \$extra[0]->Document ?? igk_get_document(\$host),\$host);
return true;
EOF
,
array("file"=>$file,
"host"=>$host))
);

$c->setCallback("attachDispose", igk_create_expression_callback(<<<EOF
igk_ilog("disposall ");
unset(\$tab[\$file]);
EOF
,
array(
"file"=>$file,
"n"=>$c,
"tab"=>$this->m_loadedStyles)));


		$this->m_loadedStyles[$file] = $c;
		return $c;
	}
}

final class IGKHtmlDocThemeMediaType extends IGKObject
{
	const XSM_MEDIA = 0;
	const SM_MEDIA = 1;
	const LG_MEDIA = 2;
	const XLG_MEDIA = 3;
	const XXLG_MEDIA = 4;

	const CTN_OFFSET = 10; //offset for container media type
	const CTN_XSM_MEDIA = self::XSM_MEDIA + self::CTN_OFFSET;
	const CTN_SM_MEDIA = self::SM_MEDIA + self::CTN_OFFSET;
	const CTN_LG_MEDIA =  self::LG_MEDIA + self::CTN_OFFSET;
	const CTN_XLG_MEDIA = self::XLG_MEDIA + self::CTN_OFFSET;
	const CTN_XXLG_MEDIA =self::XXLG_MEDIA + self::CTN_OFFSET;


	//greather than media
	const GT_OFFSET = 0xA0;
	const GT_XSM_MEDIA = self::GT_OFFSET + 0x1;
	const GT_SM_MEDIA = self::GT_OFFSET + 0x2;
	const GT_LG_MEDIA = self::GT_OFFSET + 0x3;
	const GT_XLG_MEDIA = self::GT_OFFSET + 0x4;
}

// final class IGKTHmlDocThemeCssCtrlRegistry extends IGKObject{
	// private $m_ctrls;//controller that will register for css view setting
	// private $app;
	// public function __construct($app){
		// $this->app = $app;
	// }
	// public function bindToDocument($doc,$o){
		// $this->bindCtrlStyle($doc);
	// }
	// public function regController($ctrl){
		// if ($this->m_ctrls ===null)
			// $this->m_ctrls=array();
		// if (is_object($ctrl) && igk_reflection_class_extends($ctrl, IGK_CTRL_BASE)){
			// $this->m_ctrls[get_class($ctrl)] = $ctrl;
		
		// return 1;
		// }
		// return 0;
	// }

	// public function bindCtrlStyle($doc=null){
		// if ($this->m_ctrls){
			// igk_set_env("sys://css_temp",1);
			// foreach($this->m_ctrls as $k=>$v){
				// if ($v->getIsCssActive($doc)){
					// $v->bindCss();
				// }
			// }
			// igk_set_env("sys://css_temp",null);
		// }
	// }
// }

abstract class IGKObjectGetProperties{
	public function __get($key){
		if (method_exists($this, "get".$key) )
		{
			return call_user_func(array($this, "get".$key), null);
		}
	}
	public function __set($key,$v){
		$nk = "set".$key;
		if (method_exists($this, $nk)){
			return call_user_func_array(array($this, $nk), array($v));
		}
	}
}
///<summary> used to store message data</summary>
final class IGKMedia implements ArrayAccess { //represent settings for media
	private $_; //flags to store media
	const MEDIA_ID = 0x0; //media id
	const CUSTOM_COLOR = 0x1;
	const DEFAULT_THEME = 0x2;
	const FONT_THEME = 0x3;
	const PROPERTIES_THEME = 0x4;
	const FILES_THEME = 0x5; //file in theme
	
	
	public function isEmpty(){
		return true;
	}
	
	// public function __sleep(){//save media
		// if (empty($this->_)){
			// return array();
		// }
		// return array("_");
	// }
	
	public function __construct($type, $name){
		$this->_ = array();
		//$this->setFlag(self::MEDIA_ID, $type);
		// $this[".body"]= "background-color:red;";
		// $this[".body > #main-body"]= "background-color:indigo";
	}
	
	
	function _get_css_def($minfile=true, $themeexport=false){
		$o = "";
		$tv = "";
		$lineseparator= $minfile? "": "\n";
		$def = $this->getDef();
		
	
		
		if ($def){//get main definition
			foreach($def as $k=>$v){
				$kv = trim(igk_css_treat($this, $v, $themeexport));
				if (!empty($kv))
				{
					$o .= $k."{".$kv."}".$lineseparator;
					$tv=1;
				}			
				//$o.="{$k}:{{{$kv}}}";
			}
		}
		
		
		// igk_wln($this->_);
		// session_destroy();
		// igk_exit();
		return $o;
	}
	public function getId(){
		return $this->getFlag(self::MEDIA_ID);
	}
	private function setFlag($n, $v){
		$this->_[$n] = $v;
		return $this;
	}
	private function & getFlag($n){
		$g = null;
		if (isset($this->_[$n])){
			// igk_wln("def :: ".$n);
			$g = & $this->_[$n];
		}
		return $g;
	}
	public function & getDef(){
		return $this->getFlag(self::DEFAULT_THEME);
	}
	public function & __get($n){
		$o = null;
		if (method_exists($this, "get".$n) )
		{
			$o = call_user_func(array($this, "get".$n), array_slice(func_get_args(),1));
		}
		return $o ;
	}
	public function __set($n, $v){
		
	}
	
	public function offsetSet($n, $v){	
		$g = null;		
		//good reference
		// if (isset($this->_[self::DEFAULT_THEME]))
			// $g =  & $this->_[self::DEFAULT_THEME]; 
		
		//if (isset($this->_[self::DEFAULT_THEME]))
			
		$g = & $this->getFlag(self::DEFAULT_THEME);		
		if (!$g){
			$g = array();
			$this->_[self::DEFAULT_THEME] = & $g;
		}
		$g[$n] = $v;
	}
	public function offsetExists($n){
		$g = $this->getFlag(self::DEFAULT_THEME);
		if ($g){
			return isset($g[$n]);
		}
		return false;
		
	}
	public function offsetGet($n){
		$g = $this->getFlag(self::DEFAULT_THEME);
		if ($g){
			return igk_getv($g, $n);
		}
		return null;
	}
	public function offsetUnset($n){
		$g = $this->getFlag(self::DEFAULT_THEME);
		if ($g){
			unset($g[$n]);
		}
	}
	
	
}

///<summary>represent a document themes</summary>
final class IGKHtmlDocTheme //extends IGKXmlNode
extends IGKObjectGetProperties
implements ArrayAccess
{
	private static $MEDIA;
	private static $SM_MEDIAKEY;
	
	//private $m_tc;//theme child
	//var $def; // default system
	// var $cl;//custom color
	// var $ft; //font
	//var $res;//resources - not currently used
	//var $properties; //some properties
	//var $Append; //append to all
	//var $rules;//rules
	// var $files; //files to includes;
	// private $m_FontCode; //document font code list
	private $m_medias;   //media array
	// private $m_mediasid; //media id keys
	
	private $m_type;
	// private $m_document;
	private $m_lastchanged; //store last theme changed
	// private $m_files;
	private $m_id; //for debugging
	private $m_def;
	
	public function getProperties(){
		return $this->m_def->getParams();
	}
	public function getAppend(){
		return "";
	}
	public function & getCl(){
		return $this->m_def->getCl();		
	}
	
	// public function __sleep(){//sleep doc theme
		// $t  = igk_reflection_get_member($this);		
		// return array_keys($t);
	// }

	//array access definition
	public function offsetExists($i){ return ($i>=0) && ($i<count($this->m_tc)); }
	public function offsetUnset($i){ unset($this->m_tc); }

	public function & getrules(){
		$q = $this;
		$sd =  & $this->m_def->getRules();
		return $sd;
	}

	public function getParam(){
		return null;
	}

	public function & getdef(){
		return  $this->m_def;
	}
	///protected the access to allow parent or child call via calluser func
	protected function setdef($v){

		if (($v===null) || (get_class($v) == "IGKHtmlDoc")){
			igk_die("/!\\ bad ? ".($v===null), __METHOD__);
		}
		$this->m_def=$v;

	}

	public function addTemporaryFile($file){
		if (!file_exists($file))
			return 0;
		$file = igk_io_dir($file);
		$v_tfiles = & $this->m_def->getTempFiles();		
		$v_tfiles[$file] = $file;
		return 1;
	}

	public function resetAll(){
		$this->def->Clear();
		$cl = $this->def->getCl();
		$cl["mainbackgroundColor"]="red";
		
		//$this->def->ClearChilds();
		// $fc = function($n,$tab){
			// foreach($tab as $k){
		    // $h = $n->$k;
			// if (!$h)return;
			// $t = $h->getAttributes();
			// if ($t)
				// $t->Clear();
			// }
		// };
		// $fc($this,["cl","res", "ft", "properties", "rules"]);

		// $c = $this->cl->getAttributes()?$c->Clear();// = $this->add("Colors");
		// $this->res->Attributes->Clear();// = $this->add("Resources");
		// $this->ft->Attributes->Clear(); //= $this->add("Fonts");
		// $this->properties->Attributes->Clear();// = $this->add("properties");
		// $this->rules->Attributes->Clear();// = $this->add("rules");
		$this->m_medias = array();
		// $this->m_mediasid = array();
		$this->_initMedia($this->m_id);
	}
	public function & getFontCode(){
		return $this->m_FontCode;
	}
	public function getFiles(){
		return $this->m_files;
	}

	const REGKEY = "HtmlDocTheme";

	public function ClearChilds(){	//do nothing
	}
	public function __toString(){
		return "IGKHtmlDocTheme : [id:".$this->m_id.", type: {$this->m_type} ]";
	}
	///<summary> get the parent document</summary>
	public function getDoc(){ return $this->m_document; }
	
	///<summary>register a media </summary>
	///<param name="$name">name or condition</param>
	public function reg_media($name="print", $id=null, $display=null)
	{
		$s = "";
		$n = null;
		$doc = $this->m_document;
		$is_root = 	IGKString::StartWith($this->m_id, "sys:");// is root media
		$display = ($name == 'print')&& ($display==null)? 'ptrdevice': $display;

		if (!isset($this->m_medias[$name]))
		{
			$n = new IGKMedia ("media:".$name, $display);// new IGKHtmlDocTheme($doc, "media:".$name, $display);
			$idkey = $id ?? $name;
			$this->m_medias[$idkey] = $n;		
		}
		else {
			$n = $this->m_medias[$name];
		}
		return $n;
	}
	public  function get_media($id){
		$g = null;
		if (isset($this->m_medias[$id])){
			 $g = & $this->m_medias[$id];
		}
		else{
			igk_wln("media not found {$id}");
		}
		// igk_exit();
		return $g;
	}
	///<summary>get print media</summary>
	public function getPrintMedia(){
		return $this->reg_media("print",null,'print');
	}

	public function reg_keyFrames($def, $name, $expression)
	{
		$def->addRule("@-webkit-keyframes ".$name, $expression);
		$def->addRule("@-moz-keyframes ".$name,$expression);
		$def->addRule("@-ms-keyframes ".$name, $expression);
		$def->addRule("@-o-keyframes ".$name,$expression);
		$def->addRule("@keyframes ".$name, $expression);
	}

	private function add($style){
		//add private style
		$tc = $this->m_tc ?? array();
		if (is_string($style) && !empty($style)){
			$n = igk_createXMLNode($style);
			array_push($tc, $n);
			return $n;
		}
		array_push($tc, $style);
		return $style;
	}

	public function __construct($document, $id,  $type="global"){
		// parent::__construct("themes");
		$this->m_id = $id;
		$this->m_document = $document;
		$this->m_type =$type;
		$this->_initialize();		
	}
	private function _initialize(){
		$this->m_files = array();
		$this->m_FontCode = array();

		//$css_style = new IGKCssDefaultStyle();
		$this->def = new IGKCssDefaultStyle();// $this->add($css_style) ?? igk_die("no default css definition ");
		//init media type		
		$this->m_medias = array();
		$this->m_mediasid = array();
		//--------------------------------------------
		//cutom theme definitions
		//--------------------------------------------
		$this->Append = $this->add("AppendCss");
		$this->_initMedia($this->m_id);
	}
	private function _initMedia($id){
		//media is reserved
		if (!IGKString::StartWith($id, "media:"))
		{	$this->reg_media("(max-width:".(IGK_CSS_XSM_SCREEN)."px)", IGKHtmlDocThemeMediaType::XSM_MEDIA, "xsm");
			$this->reg_media("(min-width:".(IGK_CSS_XSM_SCREEN+1)."px) and (max-width:".IGK_CSS_SM_SCREEN."px)", IGKHtmlDocThemeMediaType::SM_MEDIA,"sm");
			$this->reg_media("(min-width:".(IGK_CSS_SM_SCREEN+1)."px) and (max-width:".IGK_CSS_LG_SCREEN."px)", IGKHtmlDocThemeMediaType::LG_MEDIA, "lg");
			$this->reg_media("(min-width:".(IGK_CSS_LG_SCREEN+1)."px) and (max-width:".IGK_CSS_XLG_SCREEN."px)", IGKHtmlDocThemeMediaType::XLG_MEDIA, "xlg");
			$this->reg_media("(min-width:".(IGK_CSS_XLG_SCREEN+1)."px)", IGKHtmlDocThemeMediaType::XXLG_MEDIA,"xxlg");

			//init greather than media
			$this->reg_media("(min-width:".(IGK_CSS_XSM_SCREEN+1)."px)", IGKHtmlDocThemeMediaType::GT_XSM_MEDIA);
			$this->reg_media("(min-width:".(IGK_CSS_SM_SCREEN+1)."px)", IGKHtmlDocThemeMediaType::GT_SM_MEDIA);
			$this->reg_media("(min-width:".(IGK_CSS_LG_SCREEN+1)."px)", IGKHtmlDocThemeMediaType::GT_LG_MEDIA);
			$this->reg_media("(min-width:".(IGK_CSS_XLG_SCREEN+1)."px)", IGKHtmlDocThemeMediaType::GT_XLG_MEDIA);

			//container view media
			$this->reg_media("(min-width:855px)", IGKHtmlDocThemeMediaType::CTN_LG_MEDIA);
			$this->reg_media("(min-width:1258px)", IGKHtmlDocThemeMediaType::CTN_XLG_MEDIA);
			$this->reg_media("(min-width:1820px)", IGKHtmlDocThemeMediaType::CTN_XXLG_MEDIA);
			
			// register print media
			$this->reg_media();
		}
	}
	
	public static function GetMediaName($idk){
		if (!isset(self::$MEDIA))
			self::$MEDIA = [
			IGKHtmlDocThemeMediaType::XSM_MEDIA=>"(max-width:".(IGK_CSS_XSM_SCREEN)."px)",
			IGKHtmlDocThemeMediaType::SM_MEDIA=>"(min-width:".(IGK_CSS_XSM_SCREEN+1)."px) and (max-width:".IGK_CSS_SM_SCREEN."px)",
			IGKHtmlDocThemeMediaType::LG_MEDIA=>"(min-width:".(IGK_CSS_SM_SCREEN+1)."px) and (max-width:".IGK_CSS_LG_SCREEN."px)",
			IGKHtmlDocThemeMediaType::XLG_MEDIA=>"(min-width:".(IGK_CSS_LG_SCREEN+1)."px) and (max-width:".IGK_CSS_XLG_SCREEN."px)",
			IGKHtmlDocThemeMediaType::XXLG_MEDIA=>"(min-width:".(IGK_CSS_XLG_SCREEN+1)."px)",
			
			IGKHtmlDocThemeMediaType::GT_XSM_MEDIA=>"(min-width:".(IGK_CSS_XSM_SCREEN+1)."px)", 
			IGKHtmlDocThemeMediaType::GT_SM_MEDIA=>"(min-width:".(IGK_CSS_SM_SCREEN+1)."px)",  
			IGKHtmlDocThemeMediaType::GT_LG_MEDIA=>"(min-width:".(IGK_CSS_LG_SCREEN+1)."px)",  
			IGKHtmlDocThemeMediaType::GT_XLG_MEDIA=>"(min-width:".(IGK_CSS_XLG_SCREEN+1)."px)", 
			
			IGKHtmlDocThemeMediaType::CTN_LG_MEDIA=>"(min-width:855px)", 
			IGKHtmlDocThemeMediaType::CTN_XLG_MEDIA=>"(min-width:1258px)",
			IGKHtmlDocThemeMediaType::CTN_XXLG_MEDIA=>"(min-width:1820px)"
		];		
		return igk_getv(self::$MEDIA , $idk, $idk);
		
	}
	public static function GetMediaClassInfo($idk){
		
		if (self::$SM_MEDIAKEY==null){
			self::$SM_MEDIAKEY = [
			IGKHtmlDocThemeMediaType::XSM_MEDIA=>"xsm",
			IGKHtmlDocThemeMediaType::SM_MEDIA=>"sm",
			IGKHtmlDocThemeMediaType::LG_MEDIA=>"lg",
			IGKHtmlDocThemeMediaType::XLG_MEDIA=>"xlg",
			IGKHtmlDocThemeMediaType::XXLG_MEDIA=>"xxlg",
			];
		}
		
		$s = null;
		if (isset(self::$SM_MEDIAKEY[$idk])){
			$g = self::$SM_MEDIAKEY[$idk];
			$s = IGK_CSS_MEDIA_TYPE_CLASS ."{z-index:{$idk}; content:'{$g}'}";
		}
		
		return $s;
	}

	public function getRegChangedKey(){
		return self::REGKEY."_".$this->Name;
	}

	public function addColor($cl, $value)
	{
		$changed = false;
		if (isset($this->cl[$cl]))
		{
			if ($this->cl[$cl] != $value)
			{
				$this->cl[$cl] = $value;
				$changed = true;
			}
		}
		else{
			$this->cl[$cl] = $value;
			$changed = true;
		}
		if ($changed)
		{
			$this->save();
		}
	}
	public function removeColor($cl)
	{
		if (isset($this->cl[$cl]))
		{
			$this->cl[$cl] = null;
			$this->save();
		}
	}
	public function ClearFont()
	{
		$tab=  $this->ft->Attributes;
		if (count($tab)> 0)
		{
			foreach($tab as $k=>$v)
			{
				//igk_wln($v);
				if (is_object($v)){
					foreach($v->Fonts as $m=>$n){
						$f = igk_io_baseDir($n->File);
						if (file_exists($f))
							@unlink($f);
					}
				}
				else{
					$f = igk_io_baseDir($v);
					if (file_exists($f))
						@unlink($f);
				}
			}
			$this->ft->Attributes->Clear();
			$this->save();
		}
	}
	///<summary>add font package</summary>
	public function addFont($name, $path)
	{
		$changed = false;
		$ft  = & $this->def->getFont();
		if (isset($ft[$name]))
		{
			$changed = $ft[$name] != $path;
			$ft[$name] = $path;
		}
		else{
			$ft[$name] = $path;
			$changed = true;
		}		
	}
	///remove a specific font
	public function removeFont($name)
	{
		$f = $this->ft[$name];
		if ($f )
		{
			if (is_object($f))
			{

				$this->ft[$name] = null;
				unset($this->ft[$name]);
				$this->save();
				return true;
			}

			if (is_string($f))
			{
			$f = igk_io_currentRelativePath($f);

			if (file_exists($f) && (unlink($f)))
			{
				igk_notifyctrl()->addMsg(R::gets("msg.fontfile.removed"));

			}
				$this->ft[$name] = null;
					$this->save();
					return true;
			}
		}
		return false;
	}
	//load custom theme on that theme
	public function LoadThemeFromFile($file)
	{
		if (file_exists($file))
		{
			include($file);
		}
	}
	public function getAttributes(){
		igk_die("getAttributes not avaiable for theme");
	}
	public function getDeclaration($key = null)
	{
		$out = IGK_STR_EMPTY;
		$key = $key == null ? "\$this" : $key;
		foreach($this->def->Attributes as $k=>$v){

			$out .= $key."[\"$k\"]=\"".$v."\";\n";
		}
		foreach($this->getChilds() as $k)
		{
			$t = strtolower($k->TagName);
			$c = false;
			switch($t)
			{
				case "default":
				case "igk:text":
				case "":
					$c = true;
					break;
				default:
					$c = !preg_match(IGK_ISIDENTIFIER_REGEX, $t);
					break;
			}
			if ($c)continue;

			$out .= "\$$k->TagName = igk_getv({$key}->getElementsByTagName(\"$k->TagName\"), 0);\n";
			$tab = $k->Attributes;
			if ($tab){
				foreach($tab as $r=>$s)
				{
					if (is_object($s))
					{
						switch($k->TagName)
						{
							case "Fonts":
							$out .= "\$$k->TagName[\"$r\"]=\"".str_replace("\\", "\\\\", str_replace("\"","'", igk_css_get_fontdef($s->Name, $s)))."\";\n";
							break;
						}
						continue;
					}
					$out .= "\$$k->TagName[\"$r\"]=\"".str_replace("\\", "\\\\", str_replace("\"","'", $s))."\";\n";
				}
			}
		}
		return $out;
	}
	///<save> the current theme to file .</summary>
	public function save($file =null){//save theme properties
		if (($file==null)&& empty($this->Name))
			return;

		$f = ($file==null) ? igk_io_syspath("R/Themes/".$this->Name.".phtml") : $file;


		$out =IGK_STR_EMPTY;
		$out .="<?php\n";
		$out .= <<<EOF
// Theme Media creation
// Name : {$this->Name}
\$cl = get_class(\$this);
if (\$cl != 'IGKHtmlDocTheme')
{
	igk_die("this file can be only included in IGKHtmlDocTheme context");
}

EOF;
		$out .= $this->getDeclaration();
		$out .=IGK_START_COMMENT."media properties ".IGK_END_COMMENT."\n";
		foreach($this->m_medias as $k=>$v)
		{
			$out .= "\$media = igk_getv(\$this->m_medias, '$k');\n";
			$out .= "if (\$media){ \n";
			$out .= $v->getDeclaration("\$media");
			$out .= "}\n";
		}
		$out .="?>";
		$result =  igk_io_save_file_as_utf8($f, $out, true);
		igk_sys_regchange(self::REGKEY."_".$this->Name, $this->m_lastchanged);
		return $result ;
	}
	///<summary>reset all media</summary>
	public function reset($save=false){

		$this->def->Clear();
		$this->cl->Clear();
		$this->res->Clear();
		$this->ft->Clear();
		$this->properties->Clear();
		$this->rules->Clear();
		foreach($this->m_medias as $k=>$v){
			$v->Clear();
		}
		if ($save)
			$this->save();
	}
	public function getMedias(){
		return $this->m_medias;
	}

	public function get_css_def($minfile=false, $themeexport=false)
	{
		$out = $this->_get_css_def(!$minfile, $themeexport );	
		$el = $minfile ? IGK_STR_EMPTY : "\n";
		$is_root = $this === igk_app()->Doc->SysTheme;
		
		//write media and media query expression
		foreach($this->m_medias as $k=>$v)
		{
				$g = trim($v->_get_css_def(!$minfile, $themeexport ));
				if (!empty($g)){

					$out .="@media ".self::GetMediaName($k)."{".$el;
					if ($is_root){
						$inf = self::GetMediaClassInfo($k);
						if(!empty($inf)){
							$out.=$inf.$el;
						}
					}
					$out .= $g.$el;
					$out .="}".$el;
				}
		}
		return $out;
	}
	private function _get_css_def($indent=true, $themeexport=false)
	{
	//igk_wln("get css definition from .... ".$this."\n");
$lineseparator = $indent ? IGK_CLF : IGK_STR_EMPTY;
$out =IGK_STR_EMPTY;
$def = $this->def;
$colors = $this->cl;
$fonts = $def->getFont();
$res = $this->res;
// $rules = $this->rules;
$ft_def="";

//write fonts


// igk_wln("---------------------------------");
// igk_wln(igk_app()->Doc->Theme->getFont());
// igk_wln($fonts);
// igk_exit();
// if (!$themeexport){
$tv=0;
$s="";

//register for symbol
$s = $def->getSymbols();//Param("::igk-svg-symbols");
if (is_array($s)){
	$v_cacherequire = igk_sys_cache_require();
	$tb = array();
	// $m = "";
	foreach($s as $k=>$v){
		if (file_exists($k)){
			$rk = realpath($k);
			if ($v_cacherequire ){
				$tb[] = "./".igk_html_uri(igk_io_basePath($k));
			}else
				$tb[] = igk_io_fullpath2fulluri($k);
		// $m .= $k;
		}
	}
	$ks = igk_str_join_tab($tb, ',',false);
	//exit;
	$out .= ".igk-svg-symbol-lists:before{content:'$ks'} ".$lineseparator;
}




if ($fonts ){
	$ft_def="";
foreach($fonts as $k=>$v){
	$tv = 1;
	$s .= igk_css_get_fontdef($k, $v, $lineseparator);
	$v_def=null;
	if (isset($v->Def)){
		$v_def =", ".$v->Def;//add extra definition
	}
	$ft_def.=".ft-".$k." { font-family: \"$k\"{$v_def}; }".$lineseparator;
}
if ($tv) $out .= "/* <!-- Fonts --> */".$lineseparator.$s.$ft_def;


// igk_ilog("font def ::: ".$ft_def);
// igk_ilog("base ".$lineseparator.$s.$ft_def);
// igk_exit();
}
// else{
	// igk_ilog("font is not defined: ".igk_io_request_uri(). " ? ajx ".igk_is_ajx_demand());
// }
//set default property
if ($def->getHasRules())
{
	$out .= "/* <!-- Rules --> */".$lineseparator;
	$out .= $def->getRulesString($lineseparator).$lineseparator;
}

$s="";
$tv=0;
if ($attr = $def->getAttributes())
foreach($attr as $k=>$v)
{	
	$kv = trim(igk_css_treat($this, $v, $themeexport));
	if (!empty($kv))
	{
		$s .= $k."{".$kv."}".$lineseparator;
		$tv=1;
	}
}

if ($tv) $out .= "/* <!-- Attributes --> */".$lineseparator.$s;

// get store rules
// if ($rules && ($attr = $rules->Attributes))
// foreach($attr as $k=>$v)
// {
	// $v=trim($v);
	// if (!empty($v))
	// {
		// $out .= $k." { ".$v."}".$lineseparator;
	// }
// }

//add global attribute
// $tab = $this->def->Attributes->ToArray();
// $keys = array_keys($tab);
// igk_usort($keys, "igk_key_sort");
// foreach($keys as $k)
// {
	// $cc = $def->Attributes[$k];
	// already define in definition context continue;
	// if (!empty($cc))continue;

	// $v = $tab[$k];
	// $kv = trim(igk_css_treat($this, $v));
	// if (!empty($kv))
	// {
		// if (IGKString::StartWith($k, "#"))
			// $out .= $k."{".$kv."}".$lineseparator;
		// else
			// $out .= $k."{".$kv."}".$lineseparator;
	// }
// }

$res = $this->res;
if (!$themeexport){
	if ($res && ($attr = $res->Attributes))
	foreach($attr as $k=>$v)
	{
		$out .= ".".$k."{background-image: url('../Img/".$v."');}".$lineseparator;
	}
}
	//render Append theme
	$tab = $this->Append;	
	if ($tab && igk_count($tab)>0)
	{		
		$keys = array_keys($tab);
		$out .= IGK_START_COMMENT." APPEND THEME ".IGK_END_COMMENT."\n";
		
		
		igk_usort($keys, "igk_key_sort");
		foreach($keys as $k)
		{
			$v = $tab[$k];
			$kv = trim(igk_css_treat($this, $v,  $themeexport));
			if (!empty($kv))
			{
				if (IGKString::StartWith($k, "#"))
					$out .= $k."{".$kv."}".$lineseparator;
				else
					$out .= ".".$k."{".$kv."}".$lineseparator;
			}
		}
	}
	//loading tempory files
		$ktemp = IGK_CSS_TEMP_FILES_KEY;
		$v_csstmpfiles = $def->getTempFiles();
		
		if (!igk_get_env($ktemp) && $v_csstmpfiles){			
			igk_set_env($ktemp, 1);
			$vtemp = new IGKHtmlDocTheme($this, "theme://inline/tempfiles");
			foreach($v_csstmpfiles as $k){
				IGKOb::Start();
				igk_css_bind_file(null,$k,$vtemp);
				$m = IGKOb::Content();
				IGKOb::Clear();

				if (!empty($m)){
					$out.=$m;
				}
				$h = $vtemp->get_css_def($indent, $themeexport);
				$out.=$h;
			}
			igk_set_env($ktemp, null);
		}
		return $out;
	}

	public function getAllClassExpression(){
		$out = IGK_STR_EMPTY;
		$def = $this->def;
		$tab =  igk_createNode("table");
		foreach($def->Attributes as $k=>$v){
			$r = $tab->addRow();
			$r->addTd()->Content =  $k;
			$r->addTd()->Content =  $v;
		}
		$out .= $tab->Render();
		return $out;
	}


	public function OffsetGet($key){
		return $this->def[$key];
	}
	public function OffsetSet($key, $value){
		if ($key =="file"){
			igk_die("kjb");
		}
		$this->def[$key] = $value;
	}
	///<summary>Add file to document theme</summary>
	public function addFile($host, $f){
		if ($host===null)
			igk_die("controller host must be defined");
		$this->m_files[$f] = array("file"=>$f,"host"=>$host);
	}

	///<summary>add file from tempory</summary>
	public function addTempStyle($host, $f){
		if (!file_exists($f))
			return false;
		$key = "css://temp/rendering";
		$tab = $this->getParam($key);
		if ($tab===null)
			$tab = array();
		$tab[$f] = (object)array('file'=>$f,'host'=>$host);
		$this->setParam($key, $tab);
	}
}
///used with form to render content only
final class IGKHtmlFormInner extends IGKHtmlItem
{
	private $m_form;

	public function __construct($form){
		parent::__construct("igk:FormInner");
		$this->m_form = $form;
	}
	public function getIsRenderTagName(){return false;}
}

final class IGKHTmlFormTitle extends IGKHtmlItem{
	public function __construct(){
		parent::__construct("div");
		$this["class"]="title";
	}
	public function AcceptRender($options=null){
		if (!$this->IsVisible){
			return 0;
		}
		$c = $this->Content ;
		if ($c)
			return 1;
		return 0;
	}
}

///<summary>igk framework form</summary>
final class IGKHtmlForm extends IGKHtmlItem
{
	private $m_encType;
	private $topdiv;
	private $bodydiv;
	private $footdiv;
	private $m_notitle;
	private $m_nofoot;
	private $m_definition;
	const URLEncoded = "application/x-www-form-urlencoded";

	public function getNoTitle(){return $this->m_notitle;}
	public function getNoFoot(){return $this->m_nofoot;}
	public function setNoTitle($value){ $this->m_notitle = $value;}
	public function setNoFoot($value){ $this->m_nofoot = $value;}
	public function getAction(){return $this["action"];}
	public function setAction($value){return $this["action"]=$value;}
	public function getMethod(){return $this["method"];}
	public function setMethod($value){return $this["method"] = $value;}
	public function getEncType(){return $this->m_encType;}
	public function setEncType($value){$this->m_encType=$value;}
	public function setTitle($value){$this->topdiv->Content = $value;}
	public function getTitle(){return $this->topdiv->Content;}
	public function getBox(){return $this->bodydiv; }

	///<summary>input environement confirmation</summary>
	public function addConfirm($v=1){
		return $this->addInput("confirm", "hidden", $v);
	}
	public function addToken(){
		$tokenid = igk_html_form_tokenid();
		$i = $this->add('input');
		$i["name"]= $tokenid;//md5($cref);
		$i["value"]=1;
		$i["type"]="hidden";
		return $i;
	}
	public function addHidden($n,$v){
		return $this->addInput($n, "hidden", $v);
	}
	public function __construct($notitle=false, $nofoot = true){
		parent::__construct("form");
		$this->Method = "POST";
		$this->Action= ".";
		$this->m_encType =true;
		$this->m_notitle = $notitle;
		$this->m_nofoot = $nofoot;
		$this["class"]="igk-form";
		$this["enctype"]=IGK_HTML_ENCTYPE;
		$this->topdiv =  new IGKHtmlFormTitle();
		$this->bodydiv =  igk_createNode("div")->AppendAttributes(array("class"=>"content"));
		$this->footdiv =  igk_createNode("div")->AppendAttributes(array("class"=>"foot"));
		$this->m_definition =new IGKHtmlFormInner($this);
		parent::_AddChild($this->m_definition);
		$this->m_definition->Add($this->topdiv);
		$this->m_definition->Add($this->bodydiv);
		$this->m_definition->Add($this->footdiv);
	}
	public function ClearChilds(){//Clear only the body childs
		$this->bodydiv->ClearChilds();
		//parent::_AddChild($this->m_definition);
	}
	protected function _AddChild($item, $index=null){	//bodydiv addchild

		return $this->bodydiv->_AddChild($item);
	}
	public function add($nameoritem, $attributes=null, $index= null)
	{
		$t = null;
		$t = $this->bodydiv->add($nameoritem, $attributes, $index);
		return $t;
	}

	protected function __AcceptRender($o = null){

		$e = $this->topdiv->Content;
		$this->topdiv->setIsVisible(!empty($e) && !$this->m_notitle);

		
		$this->footdiv->setIsVisible(!$this->footdiv->hasContent  && !$this->m_nofoot);

		return true;
	}
	public function getFooter(){
		return $this->footdiv;
	}
	public function setContent($v){//set content div shortcut
		$this->bodydiv->setContent($v);
		return $this;
	}
	public function getContent(){
		return null;
	}
}

class IGKHtmlCssLink extends IGKHtmlItem
{
	var $link;
	var $cache; //used for caching. will add the cache args in this
	private $ln;
	private $system;

	public function getType(){return $this->ln["type"];}
	public function getRel(){return $this->ln["rel"];}
	public function setType($value){$this->ln["type"]= $value;}
	public function setRel($value){ $this->ln["rel"] = $value;}
	public function __construct($link, $system=false){

	    parent::__construct("igk-css-link");		
		$this->link = $link;
		$this->ln = self::CreateWebNode("link");
		$this->ln["type"]="text/css";
		$this->ln["rel"]="stylesheet";
		$this->cache=false;
		$this->system = $system;
	}
	public function getIsRenderTagName(){return false; }
	protected function innerHTML(& $option = null){//CSS innerHTML render nothing
		return null;
	}
	protected function __getRenderingChildren($option=null){
		return array($this->ln);
	}
	protected function __AcceptRender($o =null){
		if($this->system && $o && ($o->Context == "mail"))
		{
			return false;
		}
		$uri = "";
		/*
		if (IGKValidator::IsUri($this->link))
		{	//no validation
			$uri= $this->link;
		}
		else{
			//to base relative according to requested path

			if (igk_is_ajx_demand()){
				//if in ajx demand context return full uri to link. simple method
				$uri = igk_html_uri(igk_io_baseUri()."/".$this->link);
			}
			else{
				$s = IGKIO::GetCurrentRelativeUri($this->link);
				$uri = igk_html_uri($s);
			}
		}

		*/

		$uri = igk_html_get_system_uri($this->link, $o);
		if ($this->cache && ($o &&  $o->Cache)){
			$uri= igk_uri_add_args($uri, array("Cache"=>1));
		}
		$this->ln["href"] =$uri;
		return $this->IsVisible;
	}

}

///<summary>html link</summary>
final class IGKHtmlLink extends IGKHtmlItem
{
	var $i;
	public function __construct(){
		parent::__construct("link");
		$this->i = 1;
	}
}

class IGKHtmlScriptLink extends IGKObject
{
	private $m_owner;

	public function __construct($o){
		$this->m_owner = $o;
	}
	public function getValue($options){


		$src = IGK_STR_EMPTY;
		$o = $this->m_owner;
		$lnk = $o->link;

		if ($lnk){
			// if ($lnk=="https://cdnjs.cloudflare.com/ajax/libs/stacktrace.js/1.0.0/stacktrace.min.js"){

					// $src = igk_html_get_system_uri($lnk, $options);
					// igk_wln("bad ".$src);
					//e_xit;
			// }
			$src = igk_html_get_system_uri($lnk, $options);
		}
		return $src;

	}
}

class IGKHtmlScript extends IGKHtmlItem
{
	var $link;
	var $canBeMerged;
	var $tag;

	private $m_scriptLink;
	private $_accept;
	public function __construct($link=null){
		parent::__construct("script");
		$this->link = $link;
		$this->m_scriptLink = new IGKHtmlScriptLink($this);
		$this["type"]="text/javascript";
		$this["language"]="javascript";
		parent::offsetSet("src", $this->m_scriptLink);
		$this->canBeMerged = true;
		$this->__iaccept();

	}
	private function __iaccept(){
		$this->_accept =
		!( !empty($this->link) && (!IGKValidator::IsUri($this->link) && !file_exists(igk_getv(explode("?", $this->link),0)) ));
	}
	public function offsetSet($name, $value){
		if (strtolower($name)=="src")
		{
			$this->link = $value;
			$this->__iaccept();
		}
		else {
			parent::offsetSet($name, $value);
		}
	}
	protected function innerHTML(& $o =null){

		if (igk_xml_is_options_mail($o)){
			return IGK_STR_EMPTY;
		}

		return parent::innerHTML($o);
	}
	protected function __AcceptRender($opt=null){
		//$this->deactivate("async");
		if ($this->link){
			// if ($this->getParentNode()==null)
				// return false;
			// igk_ilog($this->link. " ::: ". igk_env_count($this->link));// . " vs ". igk_io_dir(IGK_BALAFON_JS_CORE_FILE));

			if ($this->link!=igk_io_dir(IGK_BALAFON_JS_CORE_FILE)){
				//$this->activate("defer");
			}else{
				$this->deactivate("defer");
				$this->activate($this->tag);
			}
		}


		if ($opt && $opt->Document && $opt->Document->getParam("no-script")){
			return 0;
		}	
		if (igk_xml_is_options_mail($opt))
				return false;
		return $this->_accept;
	}
}

///<summary>base div model</summary>
class IGKHtmlDiv extends IGKHtmlItem
{
	public function closeWithCloseTag($opt, $tag){//force closing of div
		return true;
	}
	public function __construct(){
		parent::__construct("div");
	}
}


final class IGKHtmlImgEvalSrc extends IGKObject
implements IIGKHtmlGetValue{
	private $m_o;//owner
	private $m_img;//image tag

	public function __toString(){
		return __CLASS__."#".$this->m_o->getSrc();
	}
	public function __construct($o, $img)
	{
		$this->m_o = $o;
		$this->m_img = $img;
	}
	public function getValue($options =null){
		//remove image not found class
		$this->m_img["class"] = "-igk-img-not-found";

		$lnk = $this->m_o->getSrc();

		//igk_log_write_i("SRC",  ":".$lnk);
		$m = igk_xml_is_options_mail($options);
		if ($m)	{
			$uri = new IGKHtmlUri();
			$uri->setValue($lnk);
			$r = new IGKHtmlItem("img");
			$r->setAttributes($this->Attributes);
			if($options && $options->Attachement){
				$d = null;
				if (!empty($this->m_lnk) && file_exists($lnk))
				{
					$d = $options->Attachement->attachFile(realpath($lnk), "images/pictures",null);
				}
				else{
					$q = igk_post_uri($this->m_lnk);
					if (!empty($q)){
						$d = $options->Attachement->attachContent($q, "images/pictures",null);
					}
				}
				if ($d)
				// $r["src"]
					$s ="cid:".$d->CID;
			}
			else{
				//$r["src"]
				$s = $uri->getValue($options);
			}
			return $s ; //,$r->Render($options);
		}
		//treat lnk
		if (strstr($lnk, ".."))
		{
			$lnk = str_replace("../",IGK_STR_EMPTY,  $lnk);
		}
		$s = IGK_STR_EMPTY;
		$k = igk_html_uri($lnk);
		$rf = null;//real filename
		$extra = null;
		if (!empty($k))
		{
			if (IGKValidator::IsUri($k) ||
				(preg_match("#^file://#i", $k)) ||
				(preg_match("#^\{(.)*\}$#i", $k)) //expression must not be evaluated.
			 )
			{
				$s = $k;
			}
			else{
				$f = igk_getv(explode("?", $lnk), 0);
				if (strpos($f, "#")!==false){
					list($f, $extra) = explode("#", $f);
				}
				//igk_ilog("check for file ".$f. "?".file_exists($f). " :: ".file_exists(igk_io_baseDir($f)));
				if (file_exists($f))
				{

					$rf = realpath($f);
					if (igk_is_ajx_demand())
					{
						$s = igk_io_baseUri()."/".igk_html_uri(igk_io_basePath($rf));
					}
					else {
						$s = igk_io_fullpath2Uri($rf, true);
					}
				}
				else {

					$s = "";// igk_html_uri(igk_io_currentRelativePath($f));
					$bf = igk_html_uri(igk_io_currentRelativePath($f));
					if (!file_exists($bf))
					{
						//adding info
						$this->m_img["class"] = "+igk-img-not-found";
						// $this->m_img["exists"] = file_exists($bf);
						// $this->m_img["ruri"] = $f;
					}
					$s = $bf;
				}

			}
		}
		else
			$s = $k;

		if (!empty($extra)){
			$s .= "#".$extra;
		}
		if ( ($kc =  strpos($lnk, "?")) !== false){
				$s .= "?".substr($lnk, $kc+1);
		}
		return $s;
	}
}


///<summary>Represent global doctype</summary>
class IGKHtmlDoctype extends IGKHtmlItem
{
	static $Html;
	public function __construct($value){
		$this->Content = $value;
	}
	public function Render($options=null){//render doc type
		$out = "<!DOCTYPE ".$this->Content . " >".igk_html_indent_line($options);
		return $out;
	}
	protected function _AddChild($item, $index=null){
		return false;
	}
	static function init(){
		if (self::$Html)
			return;
		self::$Html = new IGKHtmlDoctype(IGK_DOC_TYPE);
	}
	public function AcceptRender(){
		return true;
	}
}


IGKHtmlDoctype::init();


class IGKHtmlMeta extends IGKHtmlItem
{
	public function __construct(){
		parent::__construct("meta");
	}
	public function setContent($v){
	//no set content
	return $this;}
	protected function _AddChild($item, $index=null){return false;}
}


class IGKHtmlUl extends IGKHtmlItem
{
	public function __construct(){
		parent::__construct("ul");
	}
	public function addLi($attributes=null){
		return $this->add("li", $attributes);
	}
	public function addLiA($url, $attributes=null)
	{
		return $this->addLi($attributes)->addA($url);
	}
}


class IGKHtmlInput extends IGKHtmlItem
{
	public function __construct(){
		parent::__construct("input");
	}

	protected function _AddChild($item, $index=null){return false;}
}


///<summary>represent a server response item. used to send name, value, description data to client</summary>
final class IGKHtmlResponse extends IGKHtmlItem
{
	public function __construct(){
		parent::__construct("response");
	}
	public function addItem($name, $value, $description = null)
	{
		$i = $this->add("item");
		$i["name"] = $name;
		$i->Content =  $value;
		$i["description"] = $description;
		return $i;
	}
}

///<summary>represent html utility </summary>
final class IGKHtmlUtils
{
	private static $gRendering;
	public static function GetContentValue($n, $options=null){
		if ($n->iscallback("handleRender")){
			return $n->handleRender();
		}
		$c = $n->getContent();
		$inner = "";
		if (igk_is_callback_obj($c)){
			return igk_invoke_callback_obj(igk_getv($c,'clType')=='node'? $n:null, $c);
		}

		if (is_array($c))
		{
			$r =  igk_createNode("content");
			$i = 0;
			foreach($c as $k=>$v)
			{
				if (ord($k)==0)
				$r->add("item")
				->setAttribute("key", $k)
				->setContent($v);
				$i++;
			}
			return $r->getinnerHTML(null);
		}
		if (is_object($c) && igk_reflection_class_extends($c, "IGKHtmlItem"))
		{
			if (self::$gRendering ===$c)
				return "";
			self::$gRendering = $c;
			$o = $c->Render($options);
			self::$gRendering = null;
			return $o;
		}
		return self::GetValue($c, $options);
	}
	public static function AddToggleAllCheckboxTh($tr, $targetid=null)
	{
		if ($targetid !=null)
			$targetid = ",'#$targetid'";
		return $tr->add("th",array("class"=>"box_16x16"))->addLi()->add("input",
			array("type"=>"checkbox","onchange"=>"ns_igk.html.ctrl.checkbox.toggle(this, ns_igk.getParentByTagName(this, 'table'), this.checked, true $targetid);"));
	}

	public static function GetTableFromSingleArray($array)
	{
		$tab =  igk_createNode("table");
		foreach($array as $k=>$v)
		{
			$tr = $tab->addTr();
			$tr->addTd()->Content  = $k;
			$tr->addTd()->Content  = $v;
		}
		return $tab;
	}
	///get all element childs
	public static function GetAllChilds($t)
	{
		$d = array();
		if (method_exists(get_class($t), "getChilds"))
		{
			$s = $t->getChilds();
			if (is_array($s))
			{
				$d = array_merge($d, $s);

				foreach($s as $k){
					$d = array_merge($d, igk_getAllChilds($k));
				}
			}
		}
		return $d;
	}

	///used to create sub menu in category
	public static function CreateConfigSubMenu($target, $items, $selected =null)
	{

		$ul = $target->add("ul", array("class"=>"igk-cnf-content_submenu"));
		foreach($items as $k=>$v)
		{
			$li = $ul->addLi();
			$li->add("a", array("href"=>$v))->Content = R::ngets("cl".$k);
			if ($selected == $k)
			{
				$li["class"] = "+igk-cnf-content_submenu_selected";
			}
			else{
				$li["class"] = "-igk-cnf-content_submenu_selected";
			}
		}
		return $ul;
	}
	public static function ToggleTableClassColor($target, $type="tr",  $startAt=0, $class1="table_darkrow", $class2="table_lightrow")
	{
		if ($target == null)return;
		$k = 0;
		$tab = $target->getElementsByTagName($type);

		for	($i = $startAt; $i< count($tab); $i++)
		{
			if (isset($tab[$i])){
			$tr = $tab[$i];
			if ($k == 0)
			{
				$tr["class"] =$class1;
				$k=1;
			}
			else
			{
				$tr["class"] = $class2;
				$k = 0;
			}
			}
		}
	}
	public static function BuildForm($array)
	{
		$frm =  igk_createNode("form");
		foreach($array as $k=>$v)
		{
			switch(strtolower($k))
			{
				case "label":
					$lb = $frm->addLabel();
					$lb->Content = R::ngets(IGK_STR_EMPTY);
				break;
				case "radio":
					$frm->addInput($v["id"],igk_getv($v ,"text", null), "radio");
				break;
				case "checkbox":
					$frm->addInput($v["id"],igk_getv($v ,"text", null), "checkbox");
				break;
				case "hidden":
					$frm->addInput($v["id"],igk_getv($v ,"text", null), "hidden");
				break;

				case "button":
				case "submit":
				case "reset":
					$frm->addInput($v["id"],strtolower($k),igk_getv($v ,"text", "r") );
				break;
				case "textarea":
					$frm->addTextArea($v["id"]);
				break;
				case "br":
					$frm->addBr();
				break;
			}
		}
		return $frm;
	}
	public static function ShowHierarchi($var){

	$out = IGK_STR_EMPTY;
	if ($var->HasChilds){
		$out .="<ul>";
	foreach($var->Childs as $k)
	{
		$out .= "<li>".$k->TagName;
		if ($k->TagName == "a")
			$out.= " : ".$k->Content;
		if ($k->TagName == "input")
			$out.= " : ".$k["value"];
		$out .= self::ShowHierarchi($k);

		$out .="</li>";
	}
	$out.="</ul>";
	}
	return $out;
}
	//new input
	public static function nInput($id, $value=null, $type="text")
	{
		$btn =  igk_createNode("input")->AppendAttributes(array("id"=>$id, "name"=>$id, "type"=>$type, "value"=>$value));
		switch(strtolower($btn["type"]))
		{
			case "button":
			case "submit":
			case "reset":
				$btn["class"]="clbutton";
			break;
		}
		return $btn;
	}
	//
	public static function nTextArea($id, $value){
		return igk_createNode("textarea")->AppendAttributes( array("id"=>$id, "name"=>$id, "value"=>$value));
	}

	public static function RemoveItem($item)
	{
		$p = null;
		if (($item!=null)&&	(($p= $item->getParentNode()) !=null ))
		{
			if ($p->remove($item) == false){
				igk_debug_wln("/!\\ Failed to remove an item");
				return false;
			}
			return true;
		}
		return false;
	}

	//add items
	public static function AddItem($item, $target, $index=null)
	{
		if (($item==null) || ($target==null))
			return false; //cant not add
		if ($item->ParentNode === $target)
			return true;//already a item child
		self::RemoveItem($item);
		return $target->add($item, null, $index);
	}
	//copy item child to target
	public static function CopyChilds($item, $target)
	{
		if (($item==null)||($target==null)|| !$item->HasChilds)
			return false;
			foreach($item->getChilds() as $k)
			{
				$target->Load($k->Render());
			}
			return true;
	}
	//move instance
	public static function MoveChilds($item, $target)
	{
		if (($item==null)||($target==null)|| !$item->HasChilds)
			return false;
			foreach($item->getChilds() as $k)
			{
				IGKHtmlUtils::AddItem($k, $target);
			}
			return true;
	}
	///<summary>return value according to string</summary>
	public static function GetValue($c, $options=null)
	{
		$out = IGK_STR_EMPTY;
		if (is_numeric($c) && ($c === "0"))//"for dual response resolution
			return '0';
		if (is_numeric($c) || (is_string($c) &&  !empty($c)))
		{
			$out.=$c;
		}
		else if (is_object($c))
		{
			$cl = get_class($c);
			if (igk_reflection_class_extends($cl, 'IGKHtmlItemBase'))
			{
				return  igk_html_render_node($c, $options,null);// "";//$c->Render($options);
			}
			else if (method_exists($cl,IGK_FC_GETVALUE))
			{
				$out .= $c->getValue($options);
			}
			else if(igk_is_callable($c)){
				$out .= igk_invoke_callback_obj(null, $c, $options);
			}
		}
		return $out;
	}
	public static function GetAttributeValue($c, $context=null)
	{
		$s = self::GetValue($c);
		$q = trim($s);
		$v_h = "\"";
		if (preg_match("/^\'/", $q) && preg_match("/\'$/", $q))
		{
			$v_h ="'";
		}
		if (IGKString::StartWith($q, $v_h))
		{
			$q = substr($q,1);
		}
		if (IGKString::EndWith($q, $v_h))
		{
			$q = substr($q,0, strlen($q) - 1);
		}
		if ($v_h == "\"")
		{
			$q = str_replace("\"", "&quot;", $q);
		}
		if ($context && ($context ==='XML')){
			$q = str_replace("&amp;", "&", $q);
			//igk_exit();
		}
		return $q;
	}
	/// add button link
	public static function AddBtnLnk($target, $langkey,  $uri, $attributes = null)
	{
		if ($target==null)return;
		$a  = $target->add("a" ,array("class"=>"igk-btn-lnk",
			  "href"=>$uri));
			  $a->Content = is_string($langkey) ?  R::ngets($langkey) : $langkey;
		if (is_array($attributes))
		{
			$a->AppendAttributes($attributes);
		}
		return $a;
	}
	/// AddImgLnk add image link
	public static function AddImgLnk($target, $uri, $imgname, $width="16px", $height="16px", $desc=null, $attribs=null)
	{
		if (is_object($target))
		{
			$a = $target->addImgLnk($uri, $imgname, $width, $height, $desc);

			// $a  = $target->add("a", array("href"=>$uri, "class"=>"img_lnk"));
			// $t = array();
			// $t["a"] = $a;
			// $t["img"] = $a->add("img",
							// array(
							// "width"=>$width,
							// "height"=>$height,
							// "src"=>R::GetImgUri($imgname),
							// "alt"=>R::ngets($desc)));
			$a->AppendAttributes($attribs);
			return $a;
		}
		return null;
	}
	/// AddImgLnk add image link
	public static function AddAnimImgLnk($target, $uri, $imgname, $width="16px", $height="16px", $desc=null, $attribs=null)
	{
		if (is_object($target))
		{
			$a  = $target->add("a", array("href"=>$uri, "class"=>"img_lnk"));
			$t = array();
			$t["a"] = $a;
			$t["img"] = $a->add("igk-anim-img",
							array(
							"width"=>$width,
							"height"=>$height,
							"src"=>R::GetImgUri($imgname),
							"alt"=>R::ngets($desc)));
			$a->AppendAttributes($attribs);
			return (object)$t;
		}
		return null;
	}
}






///<summary>represnet xml node type</summary>
final class IGKXMLNodeType{//enum type
	const NONE = -1;
	const ELEMENT = 1;
	const PROCESSOR = 2;
	const COMMENT = 3;
	const ENDELEMENT = 4;
	const CDATA = 5;
	const TEXT = 6;
	const DOCTYPE = 7;

	public function GetString($i){///represent nod type
		switch($i)
		{
			case self::NONE: return "NONE";
			case self::ELEMENT : return "ELEMENT";
			case self::PROCESSOR : return "PROCESSOR";
			case self::COMMENT : return "COMMENT";
			case self::ENDELEMENT : return "ENDELEMENT";
			case self::CDATA : return "CDATA";
			case self::TEXT : return "TEXT";
			case self::DOCTYPE : return "DOCTYPE";
		}
		return "UNKNOWN";
	}
}

///<summary> xml render document</summary>
class IGKHtmlReaderDocument extends IGKXmlNode //HtmlItem
{
	public function __construct()
	{
		parent::__construct("DocumentToRender");
	}
	public function Render($options=null)
	{
		$out = IGK_STR_EMPTY;
		foreach($this->Childs as $k)
		{
			$out .= $k->Render($options);
		}
		return $out;
	}
	///<summary> copy the current node to destination</summary>
	public function CopyTo($target)
	{
		$t =( $c = $this->Childs) ? $c->ToArray():null;
		$this->__rm_childs(__FUNCTION__);
		foreach($t as $k)
		{
			if ($k == null)
				continue;
			$target->add($k);
		}
	}
}

///<summary> represent a html/xml reader info</summary>
final class IGKHtmlReader extends IGKObject
{
	private $m_hfile;
	private $m_text;
	private $m_mmodel;
	private $m_offset;
	private $m_name;
	private $m_v;
	private $m_nodetype;
	private $m_isEmpty;
	private $m_hasAttrib;
	private $m_attribs;
	private $m_resolvKeys;
	private $m_resolvValues;
	private $m_nodes; // store read node hierarchi. not getParent is used

	public $context;//context value (null|XML|html)

	private static $sm_openertype;//set the opener
	private static $sm_nodeListener; //node listener
	static $ss;
	static $sm_ItemCreatorListener; //creator node listener. used to create node custom node from load text file

	public static function SetCallbackListener($callback){
		self::$sm_nodeListener = $callback;
	}

	public function getNodeType(){
		return $this->m_nodetype;
	}
	private function __construct($text)
	{
		$this->m_text= $text;
		$this->m_offset =0;
		$this->m_nodetype= IGKXMLNodeType::NONE;
		$this->m_resolvKeys = array();
		$this->m_resolvValues = array();
		$this->m_attribs = null;
		$this->m_nodes = array();
	}
	public function getSource(){return $this->m_text; }
	public function Name(){ return $this->m_name;}
	public function getValue(){ return $this->m_v;}
	public function IsEmpty(){return $this->m_isEmpty;}
	public function HasAttrib(){return $this->m_hasAttrib;}
	public function Attribs(){return $this->m_attribs; }

	public function Skip(){
		if ($this->m_nodetype == IGKXMLNodeType::ELEMENT)
		{
			if (!$this->m_isEmpty ){

				$n = $this->Name();
				$depth = 0;
				$end = false;
				while(!$end && $this->Read())
				{
					switch($this->m_nodetype ){
						case IGKXMLNodeType::ELEMENT:
								$depth++;
							break;
						case IGKXMLNodeType::ENDELEMENT:
							if (($depth==0) && (strtolower($this->Name()) == strtolower($n)))
							{
								$end =true;
							}
							else if ($depth>0)
								$depth--;
							break;
					}
				}
				//igk_wln("skip ::: ".$end);
				return $end;
			}
			//igk_exit();
		}
		return false;

	}

	public function Read(){
		if (!$this->CanRead())
		{//default setting
			$this->m_nodetype  = IGKXMLNodeType::NONE;
			$this->m_v = null;
			$this->m_name = null;
			$this->m_isEmpty = true;
			$this->m_hasAttrib = false;
			$this->m_attribs = null;
			return false;
		}

		$v_enter = false;
		$this->m_isEmpty = false;
		$this->m_hasAttrib  = false;
		$this->m_attribs = array();
		$v = IGK_STR_EMPTY;
		$v_c = strlen($this->m_text);

		while($this->CanRead())	{ //read char
			$c =$this->m_text[$this->m_offset];

			switch($c)
			{
			case "<":
				$v_enter = true;
			break;
			case "?": //preprocessor instruction
				if ($v_enter)
				{
						//reading process
						$this->m_offset ++;
						$v =IGK_STR_EMPTY;
						while( $this->CanRead())
						{
							$v .= $this->m_text[$this->m_offset];
							$this->m_offset++;
							//end comment
							if (substr($v, -2, 2) == "?>")
							{
								$v = substr($v, 0, strlen($v)-3);

								$this->m_name = null;
								$this->m_v = $v;
								$this->m_nodetype = IGKXMLNodeType::PROCESSOR;
								return true;
							}
						}

				}
				else{
				//not entered a prepropecessor instruction
					return $this->__readTextValue($v);
				}
				igk_debug_wln("failed");
				return false;
			break;
			case "!":
				if ($v_enter)
				{
					if (substr($this->m_text, $this->m_offset+1,2) == "--")
					{
						//reading comment
						$this->m_offset +=3;
						$v =IGK_STR_EMPTY;
						while( $this->CanRead())
						{
							$v .= $this->m_text[$this->m_offset];
							$this->m_offset++;
							//end comment
							if (substr($v, -3, 3) == "-->")
							{
								$v = substr($v, 0, strlen($v)-3);
								$this->m_name = null;
								$this->m_v = $v;
								$this->m_nodetype = IGKXMLNodeType::COMMENT;
								return true;
							}
						}
					}
					else if (strtoupper(substr($this->m_text, $this->m_offset+1,7)) == "[CDATA[")
						{//reading CDATA
							$this->m_offset +=8;
							$v =IGK_STR_EMPTY;
							while( $this->CanRead())
							{
								$v .= $this->m_text[$this->m_offset];
								$this->m_offset++;
								//end comment
								if (substr($v, -3, 3) == "]]>")
								{
									$v = substr($v, 0, strlen($v)-3);
									$this->m_name = null;
									$this->m_v = $v;
									$this->m_nodetype = IGKXMLNodeType::CDATA;
									return true;
								}
							}
					}
					else if (strtoupper(substr($this->m_text, $this->m_offset+1,7)) == "DOCTYPE")
					{//reading DOC TYPE
							$this->m_offset +=8;
							$v =IGK_STR_EMPTY;
							while( $this->CanRead())
							{
								$v .= $this->m_text[$this->m_offset];
								$this->m_offset++;
								//end doctype
								if (substr($v, -1, 1) == ">")
								{
									$v = substr($v, 0, strlen($v)-1);
									$this->m_name = null;
									$this->m_v = $v;
									$this->m_nodetype = IGKXMLNodeType::DOCTYPE;
									return true;
								}
							}
					}
					return false;
				}
			break;
			case "/": //end element
				if ($v_enter)
				{
					$this->m_offset+=1;
					$this->m_nodetype =  IGKXMLNodeType::ENDELEMENT;
					$this->m_name = $this->ReadName();
					$this->m_v= null;
					$v_enter = false;

					//read to end  >

					while(($v_c >$this->m_offset) && ( $this->m_text[$this->m_offset] !== '>')){
						$this->m_offset++;
					}
					// if($this->m_name == "igk:sectionTitle"){
						// igk_wln("eiikk ".$this->m_text[$this->m_offset]);
						// igk_exit();
					// }
					return true;
				}
				$v .= $c;
				break;
			default:	//read default case
				if (!$v_enter)
				{
					if ($this->m_nodetype ==  IGKXMLNodeType::ELEMENT)
					{

						$match = array();
						$tag = strtolower($this->m_name);
						switch($tag)
						{
							case "script":
							case "code":
							{//special script node

								while( $this->CanRead())
								{
									$v .= $this->m_text[$this->m_offset];
									$this->m_offset++;

									if (preg_match("/\<\/([\s]*)".$tag."([\s]*)\>$/i",$v, $match))
									{
										$this->m_offset-= strlen($match[0]);
										$v = substr($v, 0, strlen($v)-strlen($match[0]));
										break;
									}
								}
								$this->m_name = $tag;
								$this->m_v = $v;
								$this->m_nodetype = IGKXMLNodeType::TEXT;
								return true;
							}
							break;
							case "style":
							{//for style

								while( $this->CanRead())
								{
									$v .= $this->m_text[$this->m_offset];
									$this->m_offset++;

									if (preg_match("/(\<\/([\s]*)style([\s]*)>)$/i",$v, $match))
									{
										$this->m_offset-= strlen($match[0]);
										$v = substr($v, 0, strlen($v)-strlen($match[0]));
										break;
									}
								}
								$this->m_name = null;
								$this->m_v = $v;
								$this->m_nodetype = IGKXMLNodeType::TEXT;
								return true;
							}
							break;
						default:
						{
						    //
							//read text value
							//
							return $this->__readTextValue($v);
						}
						break;
						}
					}
					else{
							//read text elements
							$v=IGK_STR_EMPTY;
							if ($this->m_nodetype ==  IGKXMLNodeType::ENDELEMENT)
								$this->m_offset++;
							while( $this->CanRead())
							{
								$v .= $this->m_text[$this->m_offset];
								$this->m_offset++;
								//e
								if (substr($v, -1, 1) == "<")
								{
									$v = substr($v, 0, strlen($v)-1);
									$this->m_offset--;
									$this->m_name = null;
									$this->m_v = $v;
									$this->m_nodetype = IGKXMLNodeType::TEXT;
									return true;
								}
							}
					}
				}
				else
				{//element requested

					$this->m_name = $this->ReadName();
					$this->m_v= null;
					$this->m_nodetype =  IGKXMLNodeType::ELEMENT;
					$this->m_isEmpty = false;
					$this->m_hasAttrib = false;
					//get attribute
					$v_end = false;
					$v = IGK_STR_EMPTY;//for xml read attribute contains
					$v_readname =false;
					$v_readvalue=false;
					//$v_assoc = array();
					$v_attribname = null;
					$v_ch = null;//character
					$v_startattribvalue = false;
					$v_attribmatch =IGK_STR_EMPTY;
					$v_bracketstart = false; // for bracket reading ....
					$v_bracketch =""; //bracket char ... supported bracket [], (), {}
					$v_expressions = array();
						while( $this->CanRead())
						{
							$v_ch =  $this->m_text[$this->m_offset];

							$this->m_offset++;

							if (preg_match("/(\[)/",$v_ch))
							{
								if (!$v_startattribvalue)
								{
									$exp = $v_ch. self::__readBracket($this->m_text,$this->m_offset,  '[', ']');
									$cout = igk_count($v_expressions);
									$v_expressions[] = $exp;
									$v .= "@igk:expression$cout=\"$cout\"";
									continue;
								}
							}
							$v .= $v_ch;

							if (preg_match("('|\")", $v_ch))
							{
								if ($v_startattribvalue )
								{
									if($v_attribmatch == $v_ch)
										$v_startattribvalue = false;
								}
								else{
									$v_startattribvalue = true;
									$v_attribmatch = $v_ch;//save the attrib value start match
								}
							}
							if ($v_startattribvalue)
								continue;
							if (substr($v, -2, 2) == "/>")
							{
								//empty element
								//$v = trim(substr($v,0, strlen($v)-2));
								$v = trim(substr($v,0, strlen($v)-2));
								$this->m_isEmpty = true;
								break;
							}
							else if (substr($v, -1, 1) == ">")
							{
								//$v = trim(substr($v,0, strlen($v)-1));
								$v = substr($v,0, strlen($v)-1);
								$this->m_isEmpty = false;
								break;
							}
							//for reading the name
							if ($v_readname ==false)
							{
								if (preg_match("/([\s])/",$v_ch))
								{
									$v_attribname=$v_ch;
									$v_readname = true;
									$v_readvalue = false;
								}
							}
							else{
								if (preg_match("/[\s]/", $v_ch))
									$v_attribname .= $v_ch;
								else{
									$v_readname = false;
									//$v_assoc[] = $v_attribname;
								}
							}
						}

						if (!empty($v))
						{
							//TOTASK:READATTRIBUTES
							//get all matching attributes
							$this->m_hasAttrib =true;
							$m = null;
							//def: "/(\w+)[\s]*=[\s]*(\"|')(?P<value>(([^\"']*(')?)+))(\"|')/"
							$machv = "(?P<value>";
							$machv .= "([\"](([^\"]*(')?(\"\")?)+)[\"])";
							$machv .= "|([\'](([^']*(\")?('')?)+)[\'])";
							$machv .= "|(([^\s]*)+)";
							$machv .= ")";

							//$acount = preg_match_all("/(\w+)[\s]*=[\s]*(".$machv.")/",$v, $m);
							$acount = preg_match_all("/(?P<name>(@?".IGK_TAGNAME_CHAR_REGEX."+))[\s]*=[\s]*(".$machv.")/i",$v, $m);
							$this->m_attribs = array();
							for($cc =0;$cc< $acount; $cc++)
							{
								$k =$m["name"][$cc];
								if (preg_match("/^@igk:expression/", $k))
								{
									$this->m_attribs[$k] = $v_expressions[IGKHtmlUtils::GetAttributeValue($m["value"][$cc], $this->context)];
								}
								else
									$this->m_attribs[$k] =IGKHtmlUtils::GetAttributeValue($m["value"][$cc], $this->context);
							}
						}
						return true;
				}
				break;

		}
			$this->m_offset+=1;
		}

		if (!$v_enter && !empty($v))
		{
			$this->m_name = null;
			$this->m_v = $v;
			$this->m_nodetype = IGKXMLNodeType::TEXT;
			return true;
		}
		return false;
	}

	private static function __readBracket($text, & $offset, $start='[', $end=']')
	{
		$c = 0;
		$m = "";
		$ct = strlen($text);
		while( ($offset < $ct)) {
			$ch = $text[$offset];
			$m.= $ch;

			$offset++;
			if ($ch == $end)
			{
				if ($c == 0)
				{
					break;
				}
				$c--;
			}
			else if ($ch == $start)
			{
				$c++;
			}
		}
		return $m;

	}

	private function __readTextValue($v=IGK_STR_EMPTY)
	{

		while( $this->CanRead())
		{
			$v .= $this->m_text[$this->m_offset];
			$this->m_offset++;

			if (substr($v, -1, 1) == "<")
			{
				$v = substr($v, 0, strlen($v)-1);
				$this->m_offset--;
				$this->m_name = null;
				$this->m_v = $v;
				$this->m_nodetype = IGKXMLNodeType::TEXT;
				return true;
			}
		}
		return false;
	}
	//check if can read
	private function CanRead(){
		return (($this->m_offset>=0) && ($this->m_offset < strlen($this->m_text)));
	}
	/// read tag name
	public function ReadName()
	{
		$v = IGK_STR_EMPTY;
		//check reaed cararacter
		while( $this->CanRead() && preg_match("/".IGK_TAGNAME_CHAR_REGEX."/i",$this->m_text[$this->m_offset]))
		{
			$v .= $this->m_text[$this->m_offset];
			$this->m_offset++;
		}

		return $v;
	}

	public static function Create($file){
		if (is_file($file))
		{
			$f = fopen($file,"r");
			if ($f)
			{
				$c = filesize($file);
				$str = fread($f, $c);
				$reader = new IGKHtmlReader($str);
				$reader->m_hfile = $f;
				return $reader;

			}
		}
		return null;
	}

	public function Close(){
		if ($this->hfile)
		fclose($this->hfile);
	}

	//---------------------------------------------------------------
	// return a array of html node
	//---------------------------------------------------------------
	public static function Load($text, $context=null){//xmlreader
	//TODO: what is context.
		$opentag = false;
		$tab_doc = null;
		if (empty(self::$sm_openertype) && ($context!=null)){
			self::$sm_openertype = $context;
		}
		// igk_ilog(__METHOD__." = ".self::$sm_openertype . " ".$text);
		if (is_string($text))
		{
			$tab_doc =  new IGKHtmlReaderDocument();
			$reader = new IGKHtmlReader($text);
			$reader->context = $context;
			self::_ReadModel($reader, $tab_doc, $text, __FUNCTION__);
			self::$sm_openertype =null;
		}
		return $tab_doc;
	}
	private static function _BuildNode($reader, $cnode,$name,  $tab_doc, $pargs){
		if ((self::$sm_openertype=="XML") || (isset($reader->context) &&  ($reader->context == IGKHtmlContext::XML))){
			$n  = self::CreateNode($name, $pargs );
			if ($cnode){
				$cnode->add($n);
			}
			return $n;
		}else{
			return ($cnode !==null) ? $reader->_addNode($cnode, $name, $tab_doc, $pargs): self::CreateNode($name, $pargs );
		}
	}

	public static function CreateNode($name, $args=null){
		if (is_callable(self::$sm_ItemCreatorListener)){
			$fc = self::$sm_ItemCreatorListener;
			return $fc($name, $args);
		}
		if (self::$sm_openertype== "XML"){
				//igk_wln("create node xml ".$name);
				//igk_die("d");
			return new IGKXmlNode($name);
		}
		return IGKHtmlItem::CreateElement($name, $args);
	}
	public static function SetCreator($listener){
		self::$sm_ItemCreatorListener = $listener;
	}

	///<summary>read the model</summary>
	///<param name="context">name of the function that call the read model</param>
	private static  function _ReadModel($reader, $tab_doc , $text, $context=null){
		$cnode = null;
		$pnode = null;
		$vp_item = (object)array(
			"clCurrent"=>null,
			"clParent"=>null
		);
		if ((self::$sm_openertype == null)&&($reader->context !=null)){
			self::$sm_openertype = $reader->context;
		}
		$v_tags = array();
		$_shift_setting = function($n,$cnode, & $v_tags , & $krsv){
			$s = array_shift($v_tags);

			if ($s->clName == $n){
				//igk_wln("read from last ".$n);
				if ($cnode === $s->item){
					$krsv = false;
				}
				else
					array_unshift($v_tags , $s);
			}
		};

		//igk_debug_wln("readmodel in : ".$reader->context);
		// igk_debug_wln("Context : ".$context);
		//get elements
		while($reader->Read()){

			// igk_wln(igk_xml_type2str($reader->NodeType));
			//break;

			switch($reader->NodeType)
			{
				case IGKXMLNodeType::ELEMENT :
					$name = $reader->Name();
					//igk_wln(igk_xml_type2str($reader->NodeType));
					// igk_debug_wln("read ".$name);

					if(empty($name)){
						//protect empty name
						continue;
					}
					//get attributes
					$cattr = $reader->Attribs();
					if ($context == "LoadExpression"){
						//build attribs
						$v_tn = new IGKHtmlItem($name);
						$v_tn->startLoading(__CLASS__, $context);
						if ($reader->HasAttrib())
						{
							foreach($cattr as $k=>$c)
							{
								$v_tn->offsetSetExpression($k,  $c);
							}
						}
						if ($cnode == null)	{
							$tab_doc->add($v_tn);
						}else{
							$cnode->add($v_tn);
							if ($v_tn->ParentNode !== $cnode){
								$ht = $cnode->ParentNode;
								while($ht){
									if ($ht->add($v_t)->ParentNode ===$ht)
										break;
									$ht = $ht->ParentNode;
								}
								if ($ht===null){
									$tab_doc->add($v_tn);
								}
								else
									igk_die("failed ".($ht===null));
							}

						}
						$cnode = $v_tn;
						if ($reader->IsEmpty())
						{
							//move to parent
							$cnode = $reader->_LoadComplete($cnode, $name);
							if ($cnode == $tab_doc)
							{//empty setting
								$cnode = null;
								$reader->m_nodes = array();
							}
						}
					}
					else{
						//build attribs
						
						$pargs = igk_engine_get_attr_arg(igk_getv($cattr,"igk:args"), $reader->context);
						$v_tn = self::_BuildNode($reader, $cnode, $name, $tab_doc, $pargs);

						if ($v_tn->tagName && ($v_tn->tagName != $name) && !$reader->IsEmpty()){
							// igk_debug_wln("push setting");
							array_unshift($v_tags , (object)array("clName"=>$name, "item"=>$v_tn));
							if ($cnode==null)
								$reader->_appendResolvNode($name,$v_tn,$cnode);
						}

						// ($cnode !==null) ?
						// $reader->_addNode($cnode, $name, $tab_doc, $pargs)
						// : self::CreateNode($name, $pargs );
						if ($v_tn)
						{
								$v_tn->startLoading(__CLASS__, $context);
								if ($reader->HasAttrib())
								{
									foreach($cattr as $k=>$c)
									{
										if ($k=="igk:args")
											continue;
										if (self::$sm_openertype == "XML"){
											$v_tn->setAttribute($k,$c);
										}
										else
											$v_tn[$k] = $c;
									}
									// igk_wln(" dd ".$v_tn);
								}
								if ($cnode == null)
								{
									$tab_doc->add($v_tn);
								}
								$cnode = $v_tn;

							if ($reader->IsEmpty())
							{
								//move to parent
								$cnode = $reader->_LoadComplete($cnode, $name);
								if ($cnode == $tab_doc)
								{//empty setting
									$cnode = null;
									$reader->m_nodes = array();
								}

							}
						}else{
							igk_ilog(__FILE__.":".__LINE__.": Node not created", __METHOD__);
							$reader->Skip();
						}
					}
					break;
				case IGKXMLNodeType::TEXT:
					//add only text to current node element
					// igk_wln("c node ".$cnode . " :: ".$reader->Name());

					// if ($reader->Name()=="code"){
						// igk_wln("check parent ".$cnode->ParentNode);
						// //igk_wln("check parent ".$cnode->ParentNode);
						// igk_ilog($cnode->ParentNode->Render());
						//e_xit;
					// }
					$v_sr= $reader->getValue()."";
					$v_c=IGK_STR_EMPTY;
					if (strlen(trim($v_sr))>0)
					{
						//$v_c = $v_sr."";
						if ($cnode)
						{
							if ($cnode->getTempFlag("replaceContentLoading") || (($cnode->Content=="") && !$cnode->HasChilds))
								$cnode->Content = $v_sr;
							else{
								$cnode->addText($v_sr);
							}

						}
						else{
							$v = igk_html_node_text($v_sr);
							$tab_doc->add($v);
						}
					}
					break;
				case IGKXMLNodeType::COMMENT:
					$v_v = $reader->getValue();
					$v = new IGKHTMLCommentItem($v_v);
					if (!$cnode)
					{
						$tab_doc->add($v);
					}
					else{
						$cnode->add($v);
					}
					break;
				case IGKXMLNodeType::CDATA:
				case IGKXMLNodeType::DOCTYPE;
					$v = self::CreateElement($reader->NodeType);
					$v->Content = $reader->getValue();
					if (!$cnode){
						$tab_doc->add($v);
					}else{
						$cnode->add($v);
					}
					//$cnode = $v;
					break;
				case IGKXMLNodeType::ENDELEMENT :
					$n = $reader->Name();
					if ($cnode)
					{
						$t = $cnode->TagName;
						// igk_wln("end : ".$t. " ".$n. " from ".$context);

						if($context == "LoadExpression")
						{
							if ($n == $t)
							{
								$cnode = $reader->_LoadComplete($cnode, $n);
							}
							else{
								$rsv = false;
								$krsv = true;
								$_shift_setting($n,$cnode, $v_tags, $krsv);

								while( $cnode && ($cnode->TagName != $n))
								{
									$cnode = $reader->_LoadComplete($cnode,$n);
									$rsv =true;
								}
								if (!$krsv && $cnode)
								{
									$cnode = $reader->_LoadComplete($cnode,$n);
								}
								else{
									igk_die("[Bad Html structure] can't get parent, cnode is null, name : $n  , tagName : $t  ?  <br/>\n".
									"Line : ".__LINE__
									."<br />\n<code>".$text."</code><br />\n"."\n"
									."<br /><div >Context:".$context."</div>"
									." : ".get_class($cnode)
									);
								}
							}
							//empty document
							if ($cnode == $tab_doc)
							{
								$cnode = null;
								$reader->m_nodes = array();
							}
						}
						else{// Load Context

							// $l = trim($t." ".$n);
							// if ($l=="div igk:panel"){
								// igk_wln("sample 0");
							// }
							//|| $cnode->isCloseTag($n) : demand if is available closed tag;
							if (($n == $t) || $cnode->isCloseTag($n) || $reader->IsResolved($cnode, $n))
							{
								// if ($l=="div igk:panel"){
									// igk_wln("sample 1");
								// }

								// igk_wln("sample 1 before : ".$cnode->parentNode);
								$cnode = $reader->_LoadComplete($cnode, $n);
								// igk_wln("sample 1 end : ".$cnode);
							}
							else{
								$rsv = false;
								$krsv = true;
								$_shift_setting($n,$cnode, $v_tags, $krsv);

								while($krsv && $cnode && ($cnode->TagName != $n) && (!$rsv && $reader->IsResolved($cnode, $n)))
								{
									$cnode = $reader->_LoadComplete($cnode,$n);
									$rsv =true;
								}
								if (!$krsv && $cnode)
								{
									$cnode = $reader->_LoadComplete($cnode,$n);
								}
								else{
									igk_ilog($reader->getSource());
									igk_ilog($reader->m_resolvKeys);

									igk_die("[Bad Html structure] can't get parent, cnode is null? ".($cnode===null)
									.",<br />name : {$n}  , tagName : {$t}  <br/>\n"
									."File: ".__FILE__."<br />\n"
									."Line: ".__LINE__."<br />\n"
								    ."Context:".$context."<br />\n"
									."Class: ".get_class($cnode)
									);
								}
							}
							//empty document
							if ($cnode == $tab_doc)
							{
								$cnode = null;
								$reader->m_nodes = array();
							}
							}//end load
						}
						else {
							$cnode = null;
						}
				break;
				case IGKXMLNodeType::PROCESSOR:
					{
						$v = $reader->getValue();
						$v_cnode = new IGKHtmlProcessInstruction($v);
						if ($cnode == null)
						{
							$tab_doc[] = $cnode;
						}
						else{
							$cnode->add($v_cnode);
						}
					}
					break;
			}
		}
	}

	//---------------------------------------------------------------
	// return a array of xml node
	//---------------------------------------------------------------
	public static function LoadExpression($text, $context=null){//xmlreader
		$opentag = false;
		$tab_doc = null;

		if (is_string($text))
		{
			$tab_doc =  new IGKHtmlReaderDocument();
			$reader = new IGKHtmlReader($text);
			$reader->context = $context;
			self::_ReadModel($reader,$tab_doc,$text, __FUNCTION__);
		}
		return $tab_doc;

	}
	private function _appendResolvNode($n, $k,$cnode){
		// igk_debug_wln(__METHOD__);

		if ($k){
			$this->m_resolvKeys[] = $n;
			$this->m_resolvValues[] = $k;
			$this->m_nodes[] = $cnode;
		}
	}
	private function _addNode($cnode, $n, $tab, $args){	//add node
		$g = explode(':',$n);
		if (igk_count($g) == 1)
		{	//html node
			$v = self::CreateNode($n, $args);
			// igk_wln("create || ".$n);
			if (!$cnode->add($v) && !self::_AddToParent($tab, $cnode, $v)){
				//failed to add to parent --> add to root
				$b = $tab->add($v);
				// $this->m_nodes[] = $v;	//push top node
			}else
			{
				$b = $v;
			}
			// $b = $cnode->addNode($g[0]);
			// if ($b === null){
				// $v = self::CreateNode($n, $args);
				// $tt = 45;
				// if (!self::_AddToParent($tab, $cnode, $v)){
					// failed to add to parent --> add to root
					// $b = $tab->add($v);
				// }
			// }
			// if ($b!==null)
				// $this->m_nodes[] = $cnode;	//push node
			return $b;
		}
		$k= call_user_func_array(array($cnode, IGK_ADD_PREFIX.$g[1]), $args!=null? $args :  array());

		$this->_appendResolvNode($n,$k,$cnode);
		return $k;
	}
	private function _LoadComplete($cnode,$tag)
	{
		$m = (strtolower($cnode->tagName) == strtolower($tag));

		if ($m){
			$cnode->loadingComplete();
			return $cnode->getParentNode();
		}

		//resolv require

		$n = count($this->m_resolvKeys)>0? $this->m_resolvKeys[count($this->m_resolvKeys)-1] : null;// array_pop($this->m_resolvKeys);
		$d = count($this->m_resolvValues)>0? $this->m_resolvValues[count($this->m_resolvValues)-1] : null;
		if ((strtolower($n) == strtolower($tag)) && ($d === $cnode))
		{
			array_pop($this->m_resolvKeys);
			array_pop($this->m_resolvValues);
		}
		$cnode->loadingComplete();
		$b = array_pop($this->m_nodes);
		$pnode = $cnode->getParentNode();
		if (($b !==null) && ($pnode !== $b))
		{
			$pnode = $b;
		}
		$cnode =  $pnode;
		return $cnode;
	}
	private function IsResolved(&$node, $tagName){// igk::
		if (!$node)
			return false;
		// igk_wln("resolve ".$tagName);
		//resolv from
		$n = count($this->m_resolvKeys)>0? $this->m_resolvKeys[count($this->m_resolvKeys)-1] : null;// array_pop($this->m_resolvKeys);
		$d = count($this->m_resolvValues)>0? $this->m_resolvValues[count($this->m_resolvValues)-1] : null;


		// if ($tagName=="igk:panel")
		// {
			// igk_wln("".$d);
			// igk_wln("".$node);
			// igk_wln("".$node->tagName);
			// igk_wln("finish");
			//e_xit;
		// }

		if ((strtolower($n) == strtolower($tagName)) && ($d === $node))
		{
			return true;
		}

		if (IGKString::StartWith($tagName, "igk:"))
		{
			$f = IGKString::Format(IGK_HTML_CLASS_NODE_FORMAT, substr($tagName, 4));
			if (strtolower($f) == strtolower(get_class($node)))
			{
				return class_exists($f) && !igk_reflection_class_isabstract($f) && igk_reflection_class_extends($f, 'IGKHtmlItem');
			}
			else{
				//not a class
				if ($node->getParentHost()!=null){
					$node = $node->getParentHost();
					return self::IsResolved($node, $tagName);
				}
			}
		}
		return false;
	}
	///<summary>create Element</summary>
	public static function CreateElement($nodetype,$value=IGK_STR_EMPTY)
	{
		$v = null;
		switch($nodetype)
		{
			case IGKXMLNodeType::CDATA:
				$v = (new IGKXmlNode("!CDATA"));
				$v->setContent($value);// new IGKHtmlCData($value);

				break;
			case IGKXMLNodeType::DOCTYPE:
				$v = new IGKHtmlDoctype($value);
				break;
		}
		return $v;
	}


	///<summary>load the html file</summary>
	public static function LoadFile($file)
	{

		if (is_file($file))
		{
			$size  = @filesize($file);
			if ($size > 0)
			{
				try{
				$hfile = fopen($file, "r");
				}
				catch(Exception $ex)
				{
				}
				if ($hfile)
				{
				$text  = fread($hfile, $size);
				fclose($hfile);

				return self::Load($text,null);
				}
			}
			return null;
		}
		igk_die("file : ".$file." doesn't exist");
	}

	public static function LoadXMLFile($file){
		self::$sm_openertype="XML";
		$d =  self::LoadFile($file);
		self::$sm_openertype = null;
		return $d;
	}
	///<summary> load in xml opening context</summary>
	public static function LoadXML($content){
		self::$sm_openertype="XML";
		$d =  self::Load($content);
		self::$sm_openertype = null;
		return $d;
	}
	private static function _AddToParent($topnode, $cnode, $node){
		//avoid recursivty
		$p = $cnode->ParentNode;
		while($p && ($p!==$topnode)){
			// igk_wln("M : ".$cnode);
			// igk_wln("T : ".$topnode);
			// igk_wln("for : ".$p);
			// igk_wln("node : ".$node);

			if ($p->add($node)!==null){

				return 1;
			}
			$p = $p->ParentNode;
		}
		return 0;
		// $p = $cnode->getParentNode();
		// if ($topnode === $p)
			// return false;
		// if ($p)
		// {
			// if ($p->add($node)==false)
			// {
				// return self::_AddToParent($topnode, $p, $node);
			// }
			// else
				// return true;
		// }
		// return false;
	}
}//END CLASS

//------------------------------------------------------------------------------------------
//DATABASE MANAGEMENT
//------------------------------------------------------------------------------------------


///<summary> represent IGKDbEntiry object </summary>
class IGKDbEntity extends IGKObject
{
	private $m_propertyChangedEvent;
	private $m_db_origin;
	private $m_table_origin;

	public function __construct(){
			$this->m_propertyChangedEvent = new IGKEvents($this, "propertyChangedEvent");
	}
	public function __toString(){return "IGKDbEntity";}

	public function __set($name, $value){//set in for db entity
		parent::__set($name, $value);
		$this->onPropertyChanged($name, $value);
	}
	protected function onPropertyChanged()
	{
		$this->m_propertyChangedEvent->Call($this, null);
	}
}


final class IGKdbColumnDataType
{
	const VARCHAR = "VarChar";
	const INT32 = "Int";
	const TEXT = "Text";
	const SINGLE = "Float";
	const DOUBLE_SINGLE = "Double";
	const DATE_TIME = "Datetime";

	public static function GetDbTypes()
	{
		$t = array(
			self::VARCHAR=>self::VARCHAR,
			self::INT32=>self::INT32,
			self::TEXT=>self::TEXT,
			self::SINGLE=>self::SINGLE,
			self::DOUBLE_SINGLE=>self::DOUBLE_SINGLE,
			self::DATE_TIME=>self::DATE_TIME
			);
		return $t;


	}
}
//represent column info
final class IGKDbColumnInfo extends IGKObject
{
	var $clName;
	var $clType;
	var $clTypeLength;
	var $clAutoIncrement;
	var $clNotNull;
	var $clIsPrimary;
	var $clIsUnique;
	var $clIsIndex;
	var $clIsUniqueColumnMember;
	var $clColumnMemberIndex;
	var $clDefault;
	var $clDescription;

	var $clIsNotInQueryInsert; //not in insertion query

	//for table relation
	//var $clLink; //data table relations // array of link relation in a column
	var $clLinkTableDisplay;//array or string expression used to display the property. if string expression must be as exemple : %clName% - %clId
	var $clLinkType; // table used in relation
	var $clLinkColumn; // default link column clId

	var $clInsertFunction;
	var $clUpdateFunction;
	var $clInputType;

	public function __toString(){
		return "IGKdbColumnInfo[".$this->clName."]";
	}
	///get association info array
	public static function AssocInfo($array, $tablename=null)
	{
		if (!is_array($array))
			igk_die("array is not an array");

		$t = array();
		foreach($array as $k=>$v)
		{
			if (is_object($v)){
				if ($k !== $v->clName)
				{
					$t[$v->clName] = $v;
				}
				else{
					$t[$k] = $v;
				}
			}
			else{
				igk_debug_wln("v is not an object : ".igk_count($array));
			}
		}
		return $t;
	}

	public function __construct($array=null)
	{
		$this->clType = "Int";
		$this->clTypeLength = 11;
		$this->clNotNull = false;
		$this->clInputType="text";
		if (is_array($array))
		{
			$t = get_class_vars(get_class($this));
			foreach($array as $k=>$v)
			{
				if (!array_key_exists($k, $t))
				{
					continue;
				}
				$this->$k = $v;
			}
		}
		if (!igk_db_is_typelength($this->clType))
			$this->clTypeLength=null;
	}
	public function __get($key){
		$d = get_class_vars(get_class($this)) ;
		if (array_key_exists ( $key, $d)){
			return $this->$key;
		}
		igk_die("__get Not implements : ".$key. " ".get_class($this));
	}
	public function __set($key, $value){igk_die("variable : [". $key ."] Not Implements");}

	public static function GetColumnInfo()
	{
		return get_class_vars("IGKDbColumnInfo");
	}
	public static function NewEntryInfo()
	{
		return new IGKDbColumnInfo(array(IGK_FD_NAME=>IGK_FD_ID, IGK_FD_TYPE=>"Int", "clAutoIncrement"=>true));
	}
}

///<summary>class used to manage database for a controller</summary>
class IGKDbUtility extends IGKObject
{
	private $m_Ctrl;
	private $m_ad;//stored adapter
	private $m_errorstr;
	private $m_errorcode;

	public function beginTransaction(){
		return $this->m_ad->beginTransaction();
	}
	public function commit(){
		return $this->m_ad->commit();
	}
	public function rollback(){
		return $this->m_ad->rollback();
	}
	public function insertAndUpdate($table, $obj,$id='clId'){
		if ($this->insert($table, $obj)){
			$obj->$id = $this->getLastId();
			return 1;
		}
		return 0;
	}
	public function __call($name, $arguments){
		if (preg_match("/Callback$/i", $name)){
			//igk_wln($name);
			$fc = igk_getv($arguments, 0);
			$n = substr($name, 0, strlen($name) -8);
			if (!empty($n) && (strtolower($n) != "callback")){
				$s = call_user_func_array(array($this, $n), array_slice($arguments, 1));
				if ($s !==null){
					$fc($s);
				}
				return $s;
			}

		}
		$msg = "/!\\ DBUtility[".get_class($this)."] Action {$name} not implements";
		igk_ilog($msg, __CLASS__);
		igk_notifyctrl()->addError($msg);
		igk_assert_die(igk_server_is_local(), $msg);
		return null;
	}
	///------------------------------------------------------------------
	/// SYNC functions
	///------------------------------------------------------------------
	///note : it used clId as id by default if you don't want to used clId by default for row identification
	///       override
	public function getSyncIdentificationId($table, $syncrow){
		$r = igk_getv($syncrow, "clId");
		if ($r){
			return $r;
		}
		return igk_getv($syncrow, "clName");
	}
	///<summary>
	public function getSyncDataValueDisplay($table, $valueInTable,$info=null){
	//	igk_wln($table);
		$row = $this->selectSingleRow($table, $valueInTable);
		// return "notddd";
		if (!$row){
			return "[row is null ". $valueInTable."]";
		}
		if ($table==IGK_TB_USERS && $row){
			return "+@id:/".$row->clLogin;
		}

		return "@:/".$this->getSyncIdentificationId($table, $row);//array("clId"=>$valueInTable));
		/*
		if (($info!==null ) && isset($info->list[$table])){
			$gs = $info->list[$table];
			$v_has_ref = igk_count($gs["Links"])>0;
			// igk_wln($info);
			// igk_wln($gs);
			if ($v_has_ref){
					// igk_wln("as ref");
					if ($info->mask  == null)
						$info->mask = array();
					$key = $table."/".$value;
					if($info->mask[$key]){
						//recursion happend to the same value
						igk_wln("recursion happend can't get display data");
						igk_exit();
					}
					$info->mask[$key] = 1;
					foreach($gs["Links"] as $m=>$n){

						//m: table
						//n:[Column, Table]
						foreach($n as $k){
						$cl = $k["Column"];
						// igk_wln("value $cl = {$row->$cl} ");
							$gkey = $m."/".$row->cl;
							if (isset($tables->values[$gkey])){
								$row->$cl =$tables->values[$gkey];
							}else{
								$row->$cl = $this->getSyncDataValueDisplay($m,$row->$cl, $tables);
								$tables->values[$gkey]=$row->$cl;
							}
						// igk_wln($row->$cl);
						}
					}
					// igk_wln($row);
					$auto = igk_getv($info->list[$table], "auto");
					if ($auto){
						unset($row->$auto);
					}
					unset($info->mask[$key]);
					return json_encode($row);
			}

			//exit;
		}
		return ($s = igk_getv($row, "clName"))? "@:/".$s : "[value:".$valueInTable."]";
		*/
	}

	public function getCanSyncDataTable($table){
		return true;
	}

	protected function _syncValue($table, $value){
		$v_ = $value;
		if (preg_match_all("#^@:/(?P<value>(.)+)$#", $value, $tab)){
			$v_ = igk_getv($tab["value"], 0);
		}
		return $v_;
	}
	///get default condition id
	// protected function _sync_condition_id($table, $v){

		// return  array("clName"=>$v);
	// }
	// protected function _sync_insert_value($table, $v){
		// return  array("clName"=>$v);
	// }
	///<summary>return a sync data id</summary>
	public function getSyncDataID($table, $value, $properties=null){
		if ($table==IGK_TB_USERS){
			//get login
			if ("+@id:/".$properties->User->clLogin === $value){
				return $properties->User->clId;
			}
			return $value;
		}
		$tab = array();
		$v_ =  $this->_syncValue($table, $value);
		if (!empty($v_)){


			// //igk_wln("JSON NOT USED ANYMORE : ".$v_);
			// if (preg_match('/^\{(.)*\}$/i', $v_)){
				// //json expression
				// if (isset($properties->values[$v_]))
				// {
					// return $properties->values[$v_];
				// }

				// //igk_wln("json data ".$v_);

				// $jobj = json_decode(htmlspecialchars_decode( $v_));
				// //igk_wln($jobj);
				// //treat json object
				// $ln = $properties->Relations[$table];
				// if (igk_count($ln)>0){

					// foreach($ln as $kcolumn=>$info){

						// $ktable = $info["Table"];
// // igk_wln("for ".$ktable);
						// $jobj->$kcolumn = $this->getSyncDataID($ktable, $jobj->$kcolumn, $properties);
					// }
				// }
					// // igk_wln("after");
					// // igk_wln($jobj);

				// // igk_wln($properties);
				// $c = $this->selectSingleRow($table, $jobj);
				// if ($c !==null){
					// //igk_wln("column found");
					// $properties->values[$v_] = $c->clId;
					// return $c->clId;
				// }

				// //
				// igk_wln("column not found : " . $this->Ad->getLastQuery());



				// igk_wln($ln);
				// igk_wln($properties);

				// $properties->values[$v_] = $rv;
				// exit;
			// }
			//get row that get targered
			 //for condition
			$tb_row = igk_getv($properties->Rows[$table], $v_);
				// igk_wln($tb_row);
			//e_xit;

			//sync
			$c = $this->selectSingleRow($table, $tb_row["row"]);
			if ($c){
				//row match
				return $c->clId;
			}

			//igk_wln("get row don't match ");
			// igk_wln($row);
			//e_xit;
			if ($this->connect()){
				igk_log_write_i(__FUNCTION__, "query : failed to execute : ".$this->Ad->getLastQuery());
				$id = null;

				//get row to insert
				// igk_wln("get rk properties");
				// $rk=igk_getv(igk_getv($properties, "Rows"), $v_,  $this->_sync_insert_value($table, $v_));
				// igk_wln($rk);

				if ($this->insert_if_not_exists($table, $tb_row["row"])){
					$id = $this->getLastId();
					//remove entries
					unset($properties->Entries[$table][$tb_row["index"]]);
					// igk_wln("insert new data ");
					// igk_wln($tb_row["row"]);
				}else{
					igk_log_write_i(__FUNCTION__, " failed to insert value : ".$this->Ad->getLastQuery());
				}
				$this->close();
				return $id;
			}
		}
		return null;
	}

	/// END sync functions

	public function getErrorCode(){
		return $this->m_errorcode;
	}
	public function getErrorString(){
		return $this->m_errorstr;
	}
	protected function setErrorCode($code){
		$this->m_errorcode = $code;
	}
	protected function setErrorString($s){
		$this->m_errorstr = $s;
	}
	public function __construct($ctrl){
		if ($ctrl == null)
			igk_die("variable ctrl can't be null");
		$this->m_Ctrl = $ctrl;
	}
	public function getAd(){
		if ($this->m_ad == null){
			$a = igk_get_data_adapter($this->m_Ctrl);
			//if ($a && ($a->OpenCount()>0)){
				$this->m_ad = $a;
			//}
		}
		return $this->m_ad;
	}
	///<summary>get controller</summary>
	public function getCtrl(){return $this->m_Ctrl; }
	///<summary>get user id</summary>
	public function getUID(){
		$u = $this->m_Ctrl->User;
		return $u ? $u->clId  : 0;
	}
	protected function initDb(){//override this to initialize your data. this method will be called after parent initDb
	}
	public function select($table, $condition=null, $options=null){
		if ($this->m_ad){
			return $this->m_ad->select($table, $condition, $options);
		}
		igk_die("/!\ no adapter created. tips. call connect function first ");
		return igk_db_table_select_where($table, $condition, $this->m_Ctrl, false, $options);
	}
	public function selectFirstRow($table, $condition=null, $options=null){
		$r  = $this->select($table, $condition, $options);
		if ($r && $r->RowCount>0)
			return $r->getRowAtIndex(0);
		return null;
	}
	public function selectCallback($table, $condition=null, $callback=null){
		$options = array("callback" => $callback);
		$r  = $this->select($table, $condition, $options);
		return $r;
	}
	public function selectLastRow($table, $condition=null, $options=null){
		$r  = $this->select($table, $condition, $options);
		if ($r && $r->RowCount>0)
			return $r->getRowAtIndex($r->RowCount-1);
		return null;
	}
	public function selectSingleRow($table, $condition=null, $options=null){
		$r  = $this->select($table, $condition, $options);
		if ($r && $r->RowCount==1)
		{
			$g =  $r->getRowAtIndex(0);
			$g->{"sys:table"}=$table;
			return $g;
		}
		return null;
	}

	public function getSystemUserById($id){
		return $this->select(IGK_TB_USERS, array(IGK_FD_ID=>$id))->getRowAtIndex(0);
	}
	public function insert($table, $obj){
		if ($this->m_ad){
			return $this->m_ad->insert($table, $obj);
		}else
			return igk_db_insert($this->m_Ctrl, $table, $obj);
	}
	public function insert_if_not_exists($table, $obj, $leaveOpen= false){
		return igk_db_insert_if_not_exists($this->m_Ctrl, $table, $obj, null, null, $leaveOpen, "Or");
	}
	///<summary>insert or update $obj</summary>
	public function insertOrUpdate($table, $condition, $obj, $callback=null){
	$_invoke = function($r) use($table, $condition, $obj, $callback){

		if  ($r->RowCount==1){
				$row = $r->getRowAtIndex(0);
				if (is_callable($callback)){

					if (!$callback($row, $obj))
						return false;
				}
				$obj->clId = $row->clId;
				if  ($this->update($table, $obj, $condition)){
						return 2;
				}

			}else{
				igk_die("not implement ".$r->RowCount);
			}
	};
		if ($condition == null){
			// igk_debug_wln("check if data is present");
			$tab = null;
			if (igk_db_data_is_present($this->Ctrl, $table, $obj, null, $tab )){
				return $_invoke($tab);
			}
			if ($this->insert($table, $obj))
					return 1;
		}
		else{
			$r  = $this->select($table, $condition);
			if ($r->RowCount > 0){
				return $_invoke($r);
			}else{
				if ($this->insert($table, $obj))
					return 1;
			}
		}
		return 0;
	}
	public function getRow($table, $condition){
		$r = $this->select($table, $condition)->getRowAtIndex(0);
		return $r;
	}
	public function getID($table, $condition){
		$r = $this->select($table, $condition)->getRowAtIndex(0);
		if ($r)
			return $r->clId;
		return null;
	}
	public function getRowById($table, $id){
		return $this->select($table, array(IGK_FD_ID=>$id))->getRowAtIndex(0);
	}
	///<summary>connect adapter</summary>
	public function connect(){//connect adapter
		$this->m_ad = igk_get_data_adapter($this->m_Ctrl);
		return $this->m_ad && $this->m_ad->connect($this->m_Ctrl);
	}
	public function close(){
		if ($this->m_ad)
		{
			$this->m_ad->close();
			if ($this->m_ad->OpenCount() <=0)
			{
				$this->m_ad =null;
			}
		}
	}
	public function getLastId(){
		$ad = $this->Ad;
		return $ad? $ad->getLastId() : -1;
	}
	public function getLastQuery(){
			$ad = $this->Ad;
		return $ad? $ad->getLastQuery() : -1;
	}

	public function delete($table, $id=null){
		if (is_numeric($id))
		{
			return igk_db_delete($this->m_Ctrl, $table, array(IGK_FD_ID=>$id));
		}
		return igk_db_delete($this->m_Ctrl, $table, $id);
	}


	///<summary> get configs db function</summary>
	public function getConfigv($n, $default=null, $table=null, $comment=null){ //.db utility
		//
		return igk_db_get_config($n, $default, $comment, 0);
		// if (igk_get_adapter_name( $this->Ad) != IGK_MYSQL_DATAADAPTER)
			// return null;

		// $tb = $table? $table: IGK_TB_CONFIGS;
		// $r = $this->select($tb, array(IGK_FD_NAME=>$n))->getRowAtIndex(0);

		// if ($r){
			// return $r->clValue;
		// }
		// if (!$default)
			// $this->insert($tb, array(IGK_FD_NAME=>$n, "clValue"=>$default, IGK_FD_DESC=>$comment));
		// return $default;
	}
	///send query string
	public final function sendQuery($querystring){

		$this->connect();
		$r = null;
		if ($this->m_ad){
			$r =  $this->m_ad->sendQuery($querystring);
		}
		$this->close();
		return $r;
	}
	public final function update($table, $entrie, $condition=null, $tabinfo=null){
		$this->connect();
		$r = null;
		$_ad = $this->Ad;
		if ($_ad){
			$r = $_ad->update($table, $entrie, $condition, $tabinfo);
		}
		$this->close();
		return $r;
	}
	public final function tableExists($table){
		$this->connect();
		$r= $this->getAd()->tableExists($table);
		$this->close();
		return $r;
	}
	public final function dropTable($table){
		$this->connect();
		$r = null;
		if ($this->m_ad){
			$r = $this->m_ad->dropTable($table);
		}
		$this->close();
		return $r;
	}
	///<summary>add direct object for table name</summary>
	public function addObject($tablen, $mixed){
		$r = igk_db_create_row($tablen, $mixed);
		return $this->insert_if_not_exists($tablen, $r);
	}
}

//-------------------


//<summary>used to IGKSQLManager. it store data and maintaine connenction</summary>
class IGKSQLManager
extends IGKObject
implements IIGKdbManager
{



	private $m_dbserver; //db server
	private $m_dbuser;   //db user
	private $m_dbpwd;    //data pwd
	private $m_dbselect; //selected db
	private $m_isconnect;
	private $m_resource;
	private $m_openCount;
	public  static $Config;
	private static $sm_resid;
	private static $__store;
	//private $m_tableinit_info;
	private $m_closeCallback;
	private $m_openCallback;
		//select db
	static $idd = 0;
	private $m_adapter;

	public function setAdapter($o){
		$this->m_adapter = $o;
	}

	public function getConstraint_Index($n){
		igk_wln(get_class($this));
		igk_wln(get_class($this->m_resource));
		return null;
	}

	public static function GetValue($k, $rowInfo=null, &$tinfo=null){
		$sys = self::$Config["db"];

		if (empty($sys))
			return null;
		$m= igk_getv(self::$Config[$sys], $k);//"system"];
		if (igk_is_callable($m))
		{
			return $m($rowInfo, $tinfo);
		}
		return $m;
	}
	public static function SaveConfig($cbinfo){
		$ctn = array_merge(IGKSQLManager::$Config);
		$g = IGKSQLManager::$Config["func"];
		IGKSQLManager::$Config["db"]="user";
		$tab = array("escapestring"=>function($v) use ($cbinfo){
			return $cbinfo->escapeString ($v);

		});
		 IGKSQLManager::$Config["func"] = $tab;
		self::$__store = $ctn;
	}
	public static function RestoreConfig(){
		IGKSQLManager::$Config = self::$__store ;
		self::$__store  =null;
	}
	public static function GetFunc($n , $throwError=1){
		$tn = self::$Config["db"];

		if (empty($tn))
			return null;
	//	igk_wln($n."  = ".igk_getv(self::$Config[$tn]["func"], $n));
		$fc =  igk_getv(self::$Config[$tn]["func"], $n);
		if (empty($fc)) $fc = null;
		return $fc ?? ( $throwError? igk_die("no <b>{$n}</b> found in {$tn} dataadapter "):null);
	}
	public function setCloseCallback($v){
		$this->m_closeCallback = $v;
	}
	public function setOpenCallback($v){
		$this->m_openCallback = $v;
	}
	public function OpenCount(){
		return $this->m_openCount;
	}

	public static function Init($callback){
		if (self::$Config ==null)
			self::$Config = array();

		$callback(self::$Config);

		// self::$Config["db"]="mysqli";


		// self::$Config["func"]["connect"] = "mysqli_connect";
		// self::$Config["func"]["selectdb"] = "mysqli_select_db";
		// self::$Config["func"]["check_connect"] = "mysqli_ping";
		// self::$Config["func"]["query"] = "mysqli_query";
		// self::$Config["func"]["escapestring"] = "mysqli_real_escape_string";
		// self::$Config["func"]["num_rows"] = "mysqli_num_rows";
		// self::$Config["func"]["num_fields"] = "mysqli_num_fields";
		// self::$Config["func"]["fetch_field"] = "mysqli_fetch_field";
		// self::$Config["func"]["fetch_row"] = "mysqli_fetch_row";
		// self::$Config["func"]["close"] = "mysqli_close";
		// self::$Config["func"]["error"] = "mysqli_error";
		// self::$Config["func"]["errorc"] = "mysqli_errno";
		// self::$Config["func"]["lastid"] = "mysqli_insert_id";
		// igk_db_num_rows
		//self::$sm_resid =null;
		//for mysql
		//igk_db_escape_string
	}
	public static function GetResId(){
		return self::$sm_resid;
	}
	private static function SetResId($r, $context=null){
		self::$sm_resid = $r;
	}
	public static function  IsMySQLi(){
		$s = self::$Config["db"] ;
		return ($s== "mysqli")
	//	|| (IGKSQLManager::$Config[IGK_SQL3LITE_KN]["res"] !==null)
		;
	}

	private static $LENGTHDATA = array("int"=>"Int","varchar"=>"VarChar");

	public function getDbServer(){return $this->m_dbServer;}
	public function getDbUser(){return $this->m_dbUser;}
	public function getIsConnect(){return $this->m_isconnect;}


	///<summary>.ctr</summary>
	private function __construct(){

	}

	public static function Create($dbserver="localhost", $dbuser="root",$dbpwd="")
	{
		$out = new  IGKSQLManager();
		$out->m_dbserver = trim($dbserver);
		$out->m_dbuser = trim($dbuser);
		$out->m_dbpwd = trim($dbpwd);

		//dummy try to connect
		$out->connect();

		if ($out->m_isconnect)
		{
			$out->close();
		}
		else{
			$out = null;
		}
		return $out;

	}
	public static function InitDefault()
	{
		$db = new IGKSQLManager ();
		$db->connect();
		$db->selectdb(dBNAME);
		return $db;
	}
	public function dropTable($tablename){
		igk_die(__METHOD__." not implement");
	}
	//call this to connect to db
	public function connect(){//connect from db manager
		// igk_log_write_i("connect", "start");
		if ($this->m_isconnect && $this->m_resource)
		{
			// igk_wln($this->m_dbserver." ".$this->m_dbuser." ::: #".$this->m_dbpwd . " @".$this->m_openCount);
			// igk_wln("Ping : ".@$this->m_resource->{'ping'}());
			// igk_wln(error_reporting());
			// error_reporting(0);
			// igk_display_error(0);
			//e_xit;
			//maintain rest id
			if (@$this->m_resource->ping())
			{
				self::SetResId($this->m_resource, __FUNCTION__);
				$this->m_openCount++;
				return true;
			}
			$this->m_openCount=0;
		}
		// igk_log_write_i("connect", "create new connexion");
		$r = igk_db_connect($this->m_dbserver, $this->m_dbuser, $this->m_dbpwd);
		if (igk_db_is_resource($r) ){

			self::SetResId($r, __FUNCTION__);
			// igk_wln(IGKSQLManager::GetResId());
			$t = igk_db_query("SELECT SUBSTRING_INDEX(CURRENT_USER(),'@',1)");
			if ($t && (igk_db_num_rows($t)==1))
			{
				$this->m_isconnect = true;
				$this->m_resource = $r;
				$this->m_openCount = 1;
				return true;
			}

			igk_wln(IGKSQLManager::GetResId());
		}
		else{
			$s = igk_mysql_db_error();
			igk_notifyctrl()->addError("MySQLError  : ".$s);
			igk_debug_wln("ERROR : ". $s);
		}
		self::SetResId(null,__FUNCTION__);
		$this->m_isconnect = false;
		$this->m_resource = null;
		return false;

	}
	public function getError(){//mysql manager getError
		return igk_mysql_db_error();
	}
	///<summary>get if last execution has an error</summary>
	public function getHasError(){
		return igk_mysql_db_has_error();
	}
	  public function getErrorCode(){
		return igk_mysql_db_errorc();
	}
	public function connectTo($dbserver, $dbname, $dbuser, $dbpwd)	{
		if ($this->m_isconnect)
			$this->close();

		$r = @igk_db_connect($dbserver, $dbuser, $dbpwd);

		if (igk_db_is_resource($r)){
			$t = igk_db_query("SELECT SUBSTRING_INDEX(CURRENT_USER(),'@',1)");
			if ($t && (igk_db_num_rows($t)==1))
			{
				$this->m_isconnect = true;
				$this->m_resource = $r;
				$this->m_openCount = 1;
				$tt = $this->selectdb($dbname);
				if (!$tt){
					igk_debug_wln("DB Not selected : ". $dbname);
				}
				return $tt;
			}

		}
		else{
			$s = igk_mysql_db_error();
			igk_notifyctrl()->addError("MySQLError  : ".$s);
			igk_debug_wln("ERROR : ". $s);
		}
		$this->m_isconnect = false;
		$this->m_resource = null;
		return false;
	}

	public function close($leaveOpen=false){
		if ($this->getIsConnect())
		{
			if ($leaveOpen && ($this->m_openCount == 1)) {
				return;
			}
			$this->m_openCount--;
			if ($this->m_openCount<=0)
			{
			if (igk_db_is_resource($this->m_resource))
				igk_mysql_db_close($this->m_resource);
				$this->m_isconnect = false;
				$this->m_resource = null;
				self::SetResId(null, __FUNCTION__);
				$this->m_openCount = 0;
			}
		}
	}

	public function closeAll(){
		if (igk_db_is_resource($this->m_resource))
		{
			igk_mysql_db_close($this->m_resource);
			$this->m_isconnect = false;
			$this->m_resource = null;
			$this->m_openCount = 0;
		}

		if ($this->m_closeCallback){
				call_user_func_array($this->m_closeCallback, array());
		}
	}
	public function createdb($db){
		if (!$this->getIsConnect())
			return false;
		$t = $this->sendQuery("CREATE DATABASE IF NOT EXISTS `".$db."` ");
		return $t;
	}
	public function getdatabases(){
		if (!$this->getIsConnect())
			return;
		$t = $this->sendQuery("SHOW DATABASES");
		return $t;

	}
	///<summary>reset db initialize algorithm algorithm</summary>
	public function initForInitDb(){
		//$v_tableinit_info = null;
		igk_set_env("sys://db/tabfinfo/data", null);
	}
	public function flushForInitDb(){
		// igk_wln("at end tableinfo ");
		// igk_wln("flush for init db");
		// igk_wln("failed ");

		$tb = igk_getv(igk_get_env("sys://db/tabfinfo/data","__failed"), 0);
		//igk_getv($v_tableinit_info, "__failed");
		if (igk_count($tb)>0){
			//send failed query to debug
			//send failed alter query append when multiple column require data
			//igk_wln("send failed table .... ");
			foreach($tb as $k=>$v){
				// igk_debug_wln($v);
				$this->sendQuery($v);
			}
		}

		// igk_wln($v_tableinit_info);
		$msg = igk_debuggerview()->getMessage();
		igk_wln_assert(!empty($msg), $msg);
		return !empty($msg);
	}
	private $fkeys;
	public function getNewContraintKeys($tablename, $name){
		if ($this->fkeys == null)
			$this->fkeys = array();
	     $s = "csk_". ( (strlen($name) >3)? substring($name, 0, 3) : $name).
               IGKNumber::ToBase(count($this->fkeys) + 1, 16, 4);

			$this->fkeys[] = $s;

				return $s;
	}

	public function getTabInitInfo(){
		return $v_tableinit_info;
	}

	public function haveNoLinks($tabname, $ctrl=null){
		$c = & $v_tableinit_info["__tables"];

			//igk_wln($c);//this->m_tableinit_info);
			//$c = $v_tableinit_info["__tables"];
			if (isset($c[$tabname])){ //have alter table{
				//igk_wln("have link ".$tabname);
				if ($ctrl!=null){
					$c[$tabname]["callback"] = array($ctrl, "invokeInitDataEntry");
				}
				return 0;
			}
			return 1;

	}
	public function createTable($tbname, $columninfo, $entries=null, $desc=null, $dbname=null){//mysql create able
		if (!$this->getIsConnect())
			return false;


		// igk_debug($tbname == "tbbaobabtv_vat_types");
		$v_rs = false;
		$v_tableinit_info = igk_get_env("sys://db/tabfinfo/data");
		if ($v_tableinit_info===null){
			//init info
			$v_tableinit_info = array(
			"__linkdata"=>array(),
			"__tables"=>array(),
			"__failed"=>array(),
			"__created"=>array(),
			"__constraint"=>0
			);
		}
		$query = IGKSQLQueryUtils::CreateTableQuery($tbname, $columninfo, $desc);
		$t = $this->sendQuery($query);
		$dbname = $dbname ==null ? igk_sys_getconfig("db_name") : $dbname;
		//filter name name expression
		$tbname = igk_mysql_db_tbname($tbname);


		// igk_debug_wln("create table ".$tbname. " ".$t);

		if ($t){
			// igk_log_write_i(__CLASS__."::".__FUNCTION__, "create table ... {$tbname} ok");
			igk_notification_push_event(IGK_NOTIFICATION_DB_TABLECREATED, $this, $tbname);


			$v_tableinit_info["__created"][$tbname]=$tbname;
			// $tc[$tbname]=$tbname;
			// igk_flush_data();
			// igk_wln("<div style='color:red'> table : ".$tbname ."</div>");
				//create table success
				//alter table for require query
				$query = "";
				$tlinks = array();
				///make a copy
				$linkdata = igk_getv($v_tableinit_info, "__linkdata");
				$c = & $v_tableinit_info["__tables"];

                foreach ($columninfo as $k=>$v) {
                    if ($v->clLinkType!=null)
                    {

					//constraint name limit
					$v_tableinit_info["__constraint"]++;
					$ck_index = $v_tableinit_info["__constraint"];
					$nk = igk_get_env("sys://db/constraint_key", "ctn_");

					if ($ck_index == 1){
						$idx = $this->m_adapter->getConstraint_Index($nk);
						$ck_index = max($idx, $ck_index);
						$v_tableinit_info["__constraint"] = $idx;
					}

					// $idx = $this->getConstraint_Index($nk);
					// igk_wln($idx);
					// $this->dropTable(array("tbbaobabtv_video_tag_assoc", "tbbaobabtv_video_tags"));
					// igk_die("done");


					$nk = strtolower($nk.$ck_index);//$tbname."_".$v->clName."_constraint");
					if (strlen($nk)>64){
						$tbm  = explode("_",$nk);
						$tbs = "";
						foreach($tbm as $_rs){
							$tbs .= !empty($_rs) ? $_rs[0]:"";
						}
						$nk= "constraint_".$tbs;
					}

					//add relation constraint
					$query = IGKString::Format("ALTER TABLE `{0}` ADD CONSTRAINT `{1}` FOREIGN KEY (`{2}`) REFERENCES {3}  ON DELETE RESTRICT ON UPDATE RESTRICT;\n",
					$tbname,
					$nk,
					$v->clName,
					IGKString::Format ("`{0}`.`{1}`(`clId`)", $dbname,  $v->clLinkType ) );

					// igk_wln($v_tableinit_info);
					//igk_debug_wln($query);
					//e_xit;
						if ($this->tableExists($v->clLinkType)){
							$t = $this->sendQuery($query);
						}
						else{
							if (!isset($tlinks[$v->clLinkType]))
							{
								$mm = igk_getv($linkdata, $v->clLinkType);
								if ($mm == null)
								{
									$mm = (object)array("To"=>1, "from"=>array($tbname=>1) );
								}
								else{
									$mm->To++;
									$mm->from[$tbname]=1;
								}
								$tlinks[$v->clLinkType] = $mm;
								$linkdata[$v->clLinkType] = $mm;
							}
							else {
								$tlinks[$v->clLinkType]->To++;
								$tlinks[$v->clLinkType]->from[$tbname] = 1;
							}
							$inf = null;
							if (isset($v_tableinit_info[$v->clLinkType]))	{
								$inf = $v_tableinit_info[$v->clLinkType];
							}
							else {
								$inf = array();
							}
							// igk_debug_wln("query  ::: ".$query);
							$inf[] = $query;
							$v_tableinit_info[$v->clLinkType] = $inf;
						}
					}
				}

				$direct = true;
				if ($entries!=null)
				{
					// igk_debug_wln("----entry not null");
					if (igk_count($tlinks)>0){
						//store entries
						$c[$tbname] = array("links"=>$tlinks, "entries"=>$entries);
						//dans la ___tables sauve les besoins de la table , lien et entrée
						$direct =false;
					}
					else{
						// igk_debug_wln("init table entries ".$tbname);
						$this->__initTableEntries($tbname, $entries, 1);
					}
				}else
					{
						$ctrl = igk_get_env("sys://db_init_table/ctrl");
						if ($ctrl && (igk_count($tlinks)==0)){

							//igk_wln("init entries .....".$tbname);
							$ctrl->invokeInitDataEntry($this, $tbname);
						}
						else{
							$c[$tbname] = array("links"=>$tlinks, "entries"=>null, "callback"=>array($ctrl, "invokeInitDataEntry"));
						}

					// if (igk_count($tlinks)>0)
						// $v_tableinit_info["__links"][$tbname] = $tlinks;
				}
				//igk_debug_wln(" init entries .... ::::: ".igk_count($tlinks));

				//check : current created table is require by some table
				if (isset($v_tableinit_info[$tbname]))
				{
					$error = false;
					foreach($v_tableinit_info[$tbname] as $k=>$v){
						if (!$this->sendQuery($v)){
							$msg = "Alter failed : ". igk_debuggerview()->getMessage();
							//igk_debug_wln($msg);
							// igk_wln("<div class=\igk-danger\>Error in [".__FUNCTION__."] : </div><div>$k ::::".$v."</div>". igk_debuggerview()->getMessage());
							// flush();
							$error = true;
							$v_tableinit_info["__failed"][] = $v;
							// igk_wl("<div style='color:blue'>");
							// igk_wln($v_tableinit_info[$tbname]);
							// igk_wl("</div>");
							// igk_wl("<div style='color:red'>");
							// igk_wln($v_tableinit_info);
							// igk_wl("</div>");
						}
					}

					//if (!$error){
							unset($v_tableinit_info[$tbname]);
							igk_verbose_wln("init table with link ".$tbname);
							if (isset($linkdata[$tbname])){
								$tt = $linkdata[$tbname]->from;
								foreach($tt as $x=>$y){
									if (isset($c[$x]))
									{
										unset($c[$x]["links"][$tbname]);
										if (igk_count($c[$x]["links"])==0){
											//load table
											$e = $c[$x]["entries"];
											if ($e)
												$this->__initTableEntries($x, $e);//$c[$x]["entries"]);
											else{
												$cb = igk_getv($c[$x], "callback");
												if ($cb){
													call_user_func_array($cb, array($this, $tbname));
												}else{
													igk_log_write_i(__METHOD__, " no callback found for ".$tbname);
												}
											}

											unset($c[$x]);
									}
								}
							}
							unset($linkdata[$tbname]);
						}
					//}
				}
				//go find table that require the current created table
				//search extra
				// igk_wln("c is ".$c);
				// igk_wln($v_tableinit_info);
				foreach($c as $k=>$v){
						$m = $v["links"];
						if (isset($m[$tbname]))
						{

							unset($m[$tbname]);
							if (igk_count($m)==0){
								$e = $v["entries"];
								//igk_wln("init table entries ");
								$this->__initTableEntries($k, $e);
								unset($v["links"]);
								unset($v["entries"]);
								unset($v_tableinit_info["__tables"][$k]);
							}
							else {
								$v["links"] = $m;
							}
						}
				}
				//update info
				$v_tableinit_info["__linkdata"] = $linkdata;
				$v_tableinit_info["__tables"] = $c;
				// igk_ilog("have No link : ".$this->haveNoLinks($tbname));
				$v_rs =  true;
		}
		if (!$v_rs)
			igk_debug_wln("failed to create ".$tbname);
	//store the table infor
		igk_set_env("sys://db/tabfinfo/data", $v_tableinit_info);
		// igk_debug(0);
		return $v_rs;
	}

	// public function getNoLoadedEntry(){
		// igk_wln($v_tableinit_info);

	// }
	private function __initTableEntries($tablename, $entries, $forceload=0){
		if(!$forceload && igk_get_env("pinitSDb")){
			$o = new IGKDbEntryToLoad($this, $tablename, $entries);
			igk_ilog("reg init tables ".$tablename);
			igk_notification_reg_event("sys://db/initentries", array($this,"loadEntries"));
			return;
		}
		igk_db_load_entries($this, $tablename, $entries);

	}



	public function insert($tbname, $values, $tableinfo = null){//sql manager insert
		$this->dieNotConnect();
		$tableinfo = $tableinfo == null? igk_db_getdatatableinfokey($tbname) : $tableinfo;
		$query = IGKSQLQueryUtils::GetInsertQuery($tbname, $values, $tableinfo);

	// if (igk_is_debug() && ($tbname=="tbbaobabtv_videos")){

		// igk_wln("query : ".$query);
		// // igk_wln("tab : ".$tableinfo);
		// igk_exit();
	// }
		$t = $this->sendQuery($query);

		if ($t){
			if (is_object($values))
			{

				if (igk_getv($values,"clId") == null)
					$values->clId = $this->lastId();

			}
			return true;
		}
		else{
			$error = "Insertion Query Error : ".igk_mysql_db_error() . " : ".$query;
			igk_debug_wln($error);
			igk_db_error($error);
		}
		return false;
	}
	///delete item in tables
	public function delete($tbname, $values=null){
		$this->dieNotConnect();
		$query = IGKSQLQueryUtils::GetDeleteQuery($tbname, $values);
		$t = $this->sendQuery ($query);
		if ($t){
			if ($values ==null)//reset the auto increment
				$this->sendQuery("ALTER TABLE `".$tbname."` AUTO_INCREMENT =1");
			return true;
		}
		return false;
	}
	///<summary>delete all items</
	public function deleteAll($tbname){
		$this->dieNotConnect();
		$t = $this->sendQuery("TRUNCATE TABLE `".$tbname."`");
		$c = $t &&  $this->sendQuery("ALTER TABLE `".$tbname."` AUTO_INCREMENT =1");
		if ($t)
			return true;
	}
	///get the last inserted id
	public function lastId(){
		return 	igk_mysql_db_last_id();
	}


	public function sendQuery($query, $throwex=true)
	{
		if (igk_db_is_resource($this->m_resource))
		{
			$this->setLastQuery($query);
			$t = igk_db_query($query, $this->m_resource);
			if ($throwex){
				$this->dieinfo($t,"/!\\ SendQuery Error :<div style='font-style:normal;'>".igk_html_query_parse($query)."</div>");
			}
			else if (!$t)
				return null;
			return $t;
		}
		igk_debug_wln("[".get_class($this)."]::".__FUNCTION__." -> no resources found");
		return null;

	}
	function dieinfo($t, $msg="")
	{
		if (!$t){
			$d = igk_mysql_db_errorc();
			$em = igk_mysql_db_error();
			$m = "<div><div class=\"igk-title-4 igk-danger\" >/!\ MySQL Error</div><div>". $em."</div>"
			."<div>Code: ".$d."</div>"
			."<div>Message: <i>".$msg."</i></div></div>";

			//TODO: check for configuration duplication entries for inserting community
			switch($d){
				case 1062: //duplicate entries
				if (strstr($msg, "tbigk_configurations")){
					igk_die($m);
				}
				break;
				case 1146: //table not exists
				$this->ErrorString = $em;
				return null;
				break;
			}

			//igk_debuggerview()->addDiv()->Content = $m;
			//die if environment is on debug mode
			igk_ilog($m, __METHOD__);
			if (!igk_sys_env_production()){
				igk_die($m);
			}

		}
	}
	function dieNotConnect(){
		if (!$this->getIsConnect()){  igk_die("/!\\ DB Not connected"); }
	}
	//select database
	function selectdb($dbname){
		$this->dieNotConnect();
		//$mysql_func =  "mysql_select_db";
		$mysql_func = self::GetFunc("selectdb");
		if (self::$Config["db"] == "mysqli")
		{
			if ($this->m_resource)
			{
				if (!@$this->m_resource->ping())
					return false;
				return $mysql_func($this->m_resource, $dbname);
			}
			return false;
		}
		else {
			return $mysql_func($dbname);
		}
	}
	//send a select last id
	public function selectLastId()
	{
		return IGKMySQLQueryResult::CreateResult($this->sendQuery("SELECT  LAST_INSERT_ID()"));
	}
	///update data table
	public function update($tbname, $entry, $where=null, $querytabinfo=null)
	{
		$this->dieNotConnect();
		$query = IGKSQLQueryUtils::GetUpdateQuery($tbname, $entry, $where, $querytabinfo);
		$s = $this->sendQuery($query);
		return $s;
	}
	public function tableExists($tablename){
		if (empty($tablename))
			return false;
		try{
			$s = $this->sendQuery(
			"SELECT Count(*) FROM `".igk_mysql_db_tbname($tablename)."`", false);
			return $s!==null;
		}
		catch(Exception $ex){
			return false;
		}
		return true;
	}

		private $m_lastQuery;
		public function getLastQuery(){
			return $this->m_lastQuery;
		}
		private function setLastQuery($v){
			$this->m_lastQuery = $v;
		}
}

final class IGKDbEntryToLoad extends IGKObject{
	var $ctrl;
	var $tablename;
	var $entries;
	public function __construct($ctrl, $tablename, $entries){
		$this->ctrl = $ctrl;
		$this->tablename = $tablename;
		$this->entries = $entries;
	}
	public function loadEntries(){
		igk_db_load_entries($this->ctrl, $this->tablename, $this->entries);
	}
}

//utility function to create query
class IGKSQLQueryUtils
{
	private static $LENGTHDATA = array("int"=>"Int","varchar"=>"VarChar");

	public static function GetExtraOptions($options){
		$q = "";
		if (isset($options->Sort) && isset($options->SortColumn)){
			$q = " ORDER BY `".igk_db_escape_string($options->SortColumn) ."` ".strtoupper($options->Sort);
		}
		return $q;
	}
	public static function GetUpdateQuery($tbname, $values, $condition = null, $tableInfo=null)
	{
		$rtbname = igk_mysql_db_tbname($tbname);
		$out = "";
		$out .= "UPDATE `".$rtbname."` SET ";
		$t = 0;

		$id = $condition==null? igk_getv($values,"clId") : null;
		if (($id == null) && is_integer($condition)){
			$id = $condition;
		}
		$tableInfo = $tableInfo ?? igk_db_getdatatableinfokey($tbname);


		foreach($values as $k=>$v)
		{
			//don't allow to update or change id by default
			// igk_wln($k . " ? ".strpos($k, ":"));
			if ($id && ($k=="clId") || (strpos($k, ":")!==false))
				continue;

			if ($t == 1)
				$out .= ",";



			if ($tableInfo){
				$out .= "`".igk_db_escape_string($k)."`=".self::GetValue($rtbname, $tableInfo, $k, $v, "u");
			}
			else{
				$out .= "`".igk_db_escape_string($k)."`=";
				if (!empty($v) && is_integer($v)){
					$out.=$v;
				}
				else
					$out.="'".igk_db_escape_string($v) . "'";
			}
			$t = 1;
		}
		if ($condition)
		{
			if (is_array($condition))
			{
				$out .= " WHERE ".self::GetCondString($condition);
			}
			else if (is_string($condition) && !preg_match("/^[0-9]+$/i", $condition))
				$out .= " WHERE ".$condition;
			else if (is_integer($condition) || preg_match("/^[0-9]+$/i", $condition))
				$out .= " WHERE `clId`='".igk_db_escape_string($condition)."'";
			else{
				igk_wln("data is ".$condition. " ".strlen($condition) . " :: ".is_integer((int)$condition));
			}

		}
		else if ($id){
			$out .= " WHERE `clId`='".igk_db_escape_string($id)."'";
		}

		//igk_debug_wln($out);
		// igk_exit();
		return $out;
	}

	////<summary>get value</summary>
	////<param name="type">get the type of this inserted value i=insert or other == update </summary>
	public static function GetValue($tbname, $tableInfo, $columnName, $value, $type="i")
	{
		// if ($columnName=="clParent_Id"){
			// igk_wln("at");
			// igk_wln($value);
			// igk_wln($tableInfo);
			//e_xit;

		// }
		$tinf = igk_getv($tableInfo, $columnName);

		// if ($columnName == 'clParent_Id'){

			// igk_wln("check for status " . $value);
			// igk_wln("check for status " . is_string($value));
			// igk_wln("?".empty($value));
		// }

		if ($tinf===null){
			igk_die("can't get column: {$columnName} info in table: {$tbname}");
		}
		if (($tinf->clType=="Int") && (is_integer($value))){
			return $value;
		}



		if (($value===null) || (($value!=='0') && empty($value))){
				$of = 'NULL';
				if (($type=="i") && $tinf->clInsertFunction){
					$of= $tinf->clInsertFunction;
				}else if(($type!="i") && $tinf->clUpdateFunction){
					$of= $tinf->clUpdateFunction;
				}
		//		if ($columnName == "clState"){
					//igk_wln("column ");
					//igk_ilog(igk_ob_get($tinf));

					// igk_wln(igk_getv(igk_db_getdatatableinfokey(TBBAOBABTV_VIDEOS), "clState"));
					// igk_exit();
				//}
			if ($tinf->clNotNull){
				if($tinf->clDefault!==null)
					return $tinf->clDefault;

				switch (strtolower($tinf->clType)){//ignore mysql functions data
					case 'int':
					case 'integer':
					case 'float':
					case 'double':
						return "0";
					case "datetime":
						if (preg_match("/now\(\)/i", $of)){
							return "'".igk_db_escape_string(igk_mysql_datetime_now())."'";
						}
						return "'".igk_db_escape_string(IGK_SQL_DEFAULT_DATE_TIME)."'";
					case "time":
						if (preg_match("/now\(\)/i", $of)){
							return "'".igk_db_escape_string(date("H:i:s"))."'";
						}
						return "'".igk_db_escape_string(IGK_SQL_DEFAULT_TIME)."'";
					case "date":
						if (preg_match("/now\(\)/i", $of)){
							return "'".igk_db_escape_string(date("Y-m-d"))."'";
						}
						return "'".igk_db_escape_string(IGK_SQL_DEFAULT_TIME)."'";
					default:
						if (($type=="i") && $tinf->clInsertFunction){
							return $tinf->clInsertFunction;
						}
						if (($type!="i") && $tinf->clUpdateFunction){
							return $tinf->clUpdateFunction;
						}
					break;
				}
			    return " '' ";
			}
			if (preg_match("/date(time)?/i",$tinf->clType)){
				if (strtolower($of) == 'now()')
				{
					switch(strtolower($tinf->clType)){
						case "datetime":
							return "'".igk_db_escape_string(igk_mysql_datetime_now())."'";
						case "date":
							return "'".igk_db_escape_string(date("Y-m-d"))."'";
						case "time":
							return "'".igk_db_escape_string(date("H:i:s"))."'";
					}
				}
			}
			return $of;//'NULL';
		}
		if (empty($value)){
			//igk_wln("value is empty [$columnName] ".$tinf->clNotNull.":". $tinf->clType);
			if (!$tinf->clNotNull || ($tinf->clAutoIncrement && strtolower($tinf->clType)=='int' ) )
				return 'NULL';
		}

		if ($tinf){
			$inf = $type == "i" ?  $tinf->clInsertFunction : $tinf->clUpdateFunction ;
			if (preg_match("/date(time)?/i",$tinf->clType)){
				return "'".igk_db_escape_string($value)."'";
			}
			if ($inf){
				return self::GetFCN($inf)."('".igk_db_escape_string($value)."')";
			}
		}
		if (is_object($value)){
			if (igk_reflection_class_implement($value,'IIGKHtmlGetValue'))
			{
				return igk_db_escape_string($value->getValue());
			}
		}

		 return "'".igk_db_escape_string($value)."'";
	}
	public static function GetFCN($b){
		return strtoupper($b);
	}

	public static function GetInsertQuery($tbname, $values, $tableInfo=null)
	{
;
		if (!$values)
			return null;
		$rtbname =igk_mysql_db_tbname($tbname);
		$query = "INSERT INTO `".$rtbname."`(";
		$v_v = "";
		$v_c = 0;

		//
		// igk_exit();
		foreach($values as $k=>$v)
		{
			if ($v_c != 0){
				$query .= ",";
				$v_v .= ",";
			}
			else
				$v_c = 1;
			$query .= "`".igk_db_escape_string($k)."`";
			if ($tableInfo )
				$v_v .= self::GetValue($rtbname, $tableInfo, $k, $v);
			else {
				if ($v===null){

					$v_v.="NULL ";
				}
				else if (is_object($v) && method_exists($v, "getValue")){
					$v_v .= "".$v->getValue();
				}else
					$v_v .= "'".igk_db_escape_string($v)."'";
			}

		}
		$query .=") VALUES (".$v_v.");";


		// if($tbname == "tbigk_user_info_types"){
			// $d = igk_createNode('div');
			// $d->addObData(function()use($query,$values, $tableInfo){
				// $c = igk_db_create_row("tbigk_user_info_types");
				// igk_wln($c);
				// igk_wln($query);
			    // igk_wln($values);
				// // igk_wln($tableInfo);
		    // });
			// $d->setStyle("height:300px; overflow-y:auto")->RenderAJX();
			// igk_die("kldj");
		// }
		return $query;
	}
	// public static function CreateTableQueryCallback($cbinfo , $tbname, $columninfo, $desc=null){
		// IGKSQLManager::SaveConfig($cbinfo);

		// //igk_wln( $g);
		// $query = self::CreateTableQuery($tbname, $columninfo, $desc=null, 1);

	// //	IGKSQLManager::$Config["func"] = $g;
		// //IGKSQLManager::$Config= $ctn;
		// IGKSQLManager::RestoreConfig();
		// return $query;

	// }
	public static function CreateTableQuery($tbname, $columninfo, $desc=null, $noengine=0, $nocomment=0)
    {

		//create a mysql table query
		$query = "CREATE TABLE IF NOT EXISTS `".igk_mysql_db_tbname($tbname)."`(";
		$tb = false;
		$primary = ""; //primary key
		$unique =""; //unique row
		$funique = ""; //unique row
		$findex ="";
		$uniques = array();
		//$unique_entity = "";
		$primkey = "";
		$tinf = array();
		foreach($columninfo as $k=>$v)
		{

			if (($v==null) || !is_object($v)){
				igk_die(__CLASS__." ::: Error table column info is not an object error for ".$tbname);
			}
			$primkey = "noprimkey://".$v->clName;
			if ($tb)
				$query.=",";
			$v_name = igk_db_escape_string($v->clName);
			$query .= "`".$v_name."` ";
			$type = igk_getev($v->clType, "Int");//default type
			$query .= igk_db_escape_string($type);
			$s = strtolower($type);
			$number =false;
			if (isset(self::$LENGTHDATA[$s]))
			{

				if ($v->clTypeLength>0)
				{
					$number = true;
					$query .="(".igk_db_escape_string($v->clTypeLength).") ";
				}
				else
					$query .= " ";
			}
			else
				$query .= " ";

			//number data
			if (!$number)
			{
				if(($v->clNotNull) || ($v->clAutoIncrement))
					$query .= "NOT NULL ";
				else
					$query .= "NULL ";
			}
			else if ($v->clNotNull){
				$query .= "NOT NULL ";
			}
			if ($v->clAutoIncrement){
				$query .= IGKSQLManager::GetValue("auto_increment_word", $v, $tinf)." ";// "AUTO_INCREMENT ";

			}
			$tb = true;
			//igk_wln("default : ".$v_name . " : ".$v->clDefault);
			if ($v->clDefault || $v->clDefault==='0'){
				$query .= "DEFAULT '".igk_db_escape_string($v->clDefault)."' ";
				//igk_wln("set ok ");
			}

			if ($v->clDescription && !$nocomment)
			{
				$query .= "COMMENT '".igk_db_escape_string($v->clDescription)."' ";
			}

			if ($v->clIsUnique){
				if (!empty($unique))
					$unique .= ",";

				$unique .= "UNIQUE KEY `".$v_name."` (`".$v_name."`)";
			}
			//to merge all unique column members
			if ($v->clIsUniqueColumnMember)
			{
				if (isset($v->clColumnMemberIndex))
				{

					$tindex = explode("-", $v->clColumnMemberIndex);
					$indexes = array();
					foreach($tindex as $kindex){
						//$ck = 'unique_'.$v->clColumnMemberIndex;
						if (!is_numeric($kindex) || isset($indexes[$kindex]))
							continue;
						// igk_wln($kindex);
						$indexes[$kindex] = 1;
						$ck = 'unique_'. $kindex;

						//igk_wln("for ".$ck);
						$bf ="";
						if (!isset($uniques[$ck]))
						{
							$bf  .= "UNIQUE KEY `clUC_".$ck."_index`(`".$v_name."`";
						}
						else{
							$bf = $uniques[$ck];
							$bf  .= ", `".$v_name."`";
						}
						$uniques[$ck] = $bf;
					}
				}
				else{
					if (empty($funique))
					{
						$funique  = "UNIQUE KEY `clUnique_Column_".$v_name."_index`(`".$v_name."`";
					}
					else
						$funique  .= ", `".$v_name."`";
				}
			}
			if ($v->clIsPrimary && !isset($tinf[$primkey]))
			{
				// igk_wln("isset ".isset($tinf[$primkey]));
				// igk_wln($primkey);
				// igk_wln($tinf);
				if (!empty($primary))
				$primary .= ",";
				$primary .= "`".$v_name."`";
			}

			if (($v->clIsIndex || $v->clLinkType) && !$v->clIsUnique && !$v->clIsUniqueColumnMember && $v->clIsPrimary ){
				if (!empty($findex))
					$findex .= ",";
				$findex .= "KEY `".$v_name."_index` (`".$v_name."`)";
			}
			unset($tinf[$primkey]);
		}
		if (!empty($primary))
		{
			$query .=", PRIMARY KEY  (".$primary.") ";
		}
		if (!empty($unique))
		{
			$query .=", ".$unique." ";
		}
		if (!empty($funique))
		{
			$funique .= ")";
			$query .=", ".$funique." ";
		}
		if (igk_count($uniques)>0)
		{
			foreach($uniques as $k=>$v){
				$v .= ")";
				$query .=", ".$v." ";
			}
		}

		if (!empty($findex))
			$query .=", ".$findex ;
		$query .=")";
		if (!$noengine)
		$query .= ' ENGINE=InnoDB ';
		if ($desc){
			$query .= "COMMENT='".igk_db_escape_string($desc)."' ";
		}
		$query.=";";
		return $query;
	}
	public static function GetCondString($tab, $operator='AND')
	{
		$query = "";
		$t = 0;
		$fc = "getValue";
		$to = "obj:type";
		$op = igk_db_escape_string($operator);
		if (is_numeric($tab)){
			return "`clId`='{$tab}'";
		}

			foreach($tab as $k=>$v)
			{
				if ($t == 1)
					$query .=" $op ";

				if (is_object($v)){
					//TODO: OBJECT MANAGEMENT
					if (isset($v->$to)){
						switch($v->$to){
							case "igk_db_field":
							if (is_array($v->clName)){
								$hh = array();
								foreach($v->clName as $ks){
									$hh[] = "`".igk_db_escape_string(str_replace(".", "`.`", $ks))."`";
								}
								$query .= igk_str_join_tab($hh, $v->clOperator,false);

							}
							break;
						}
					}else{
					$query .= "`".igk_obj_call($v, $fc)."`";
					}

				}else{
					$query .= "`".igk_db_escape_string($k);
					if ($v!==null)
						$query .="`='".igk_db_escape_string($v)."'";
					else
						$query .="` IS NULL";
				}
				$t = 1;
			}
		return $query;
	}
	public static function GetDeleteQuery($tbname, $values)
	{
		$query = "";
		$query .= "DELETE FROM `".igk_mysql_db_tbname($tbname)."`";
		if (is_numeric($values)){

			return $query . " WHERE `clId`={$values}";
		}
		$id = igk_getv($values, "clId");

		//igk_wln($values);
		//
		if (is_array($values))
		{
			$query .= " WHERE " .self::GetCondString($values);
		}
		else {
			if ($id){
				$query .= " WHERE `clId`='".igk_db_escape_string($id)."'";
			}
		}
		return $query;
	}

	protected function initConfig(){

	}
	public function insert($tbname, $values, $tableinfo = null){
		$this->dieNotConnect();
		$this->initConfig();
		$query = IGKSQLQueryUtils::GetInsertQuery($tbname, $values, $tableinfo);

		//igk_wln($query);
		//e_xit;
		$t = $this->sendQuery($query);

		if ($t){
			if (is_object($values))
			{

				if (igk_getv($values,"clId") == null)
					$values->clId = $this->lastId();

			}
			return true;
		}
		else{
			$error = "Insertion Query Error : ".igk_mysql_db_error() . " : ".$query;
			igk_debug_wln($error);
			igk_db_error($error);
		}
		return false;
	}
}


abstract class IGKSQLDataAdapter extends IGKDataAdapter{

	///<summary>setup manager config for next operation
	protected function initConfig(){
	}
	public function getLastId(){

	}
	public function selectAll($tbname){
		$tbname = igk_mysql_db_tbname($tbname);
		$q = "SELECT * FROM `".($tbname)."` ";
		return $this->sendQuery($q, $tbname);
	}
	public function insert($tbname, $values, $tableinfo = null){
		//igk_wln("insert ");
		$this->dieNotConnect();
		$this->initConfig();
		$query = IGKSQLQueryUtils::GetInsertQuery($tbname, $values, $tableinfo);
		//igk_wln($query);
		$t = $this->sendQuery($query,$tbname);

		if ($t){
			if (is_object($values)){
				if (igk_getv($values,"clId") == null)
					$values->clId = $this->getLastId();

			}
			return true;
		}
		else{
			$error = "Insertion Query Error : ".igk_mysql_db_error() . " : ".$query;
			igk_debug_wln($error);
			igk_db_error($error);
		}
		return false;
	}

	public function delete($tbname, $entry){
		$this->dieNotConnect();
		$query = IGKSQLQueryUtils::GetDeleteQuery($tbname, $entry);
		//igk_wln("delete query  $query");
		$t = $this->sendQuery ($query, $tbname);
		if ($t){

			return true;
		}
		return false;
	}
	///<summary>delete all from table</summary>
	public function deleteAll($tbname){
		return $this->sendQuery("DELETE FROM `".igk_mysql_db_tbname($tbname)."`",$tbname);
	}
	public function update($tbname, $entry, $condition=null,$tabinfo=null){
		$this->dieNotConnect();
		$query = IGKSQLQueryUtils::GetUpdateQuery($tbname, $entry, $condition, $tabinfo);
		// igk_wln("update query : ".$query);
		$s = $this->sendQuery($query,$tbname);
		return $s;
	}


	///<summary>build and send a mysql select query</summary>
	///<param name="options">callback or igk_db_create_opt_obj()</param>
	public function select($tbname, $where =null, $options=null){
		$q = "";
		$q = "SELECT * FROM `".igk_mysql_db_tbname($tbname)."`";
		if ($options==null){
			$options = igk_db_create_opt_obj();
		}else if (is_callable($options)) {
			$g = igk_db_create_opt_obj();
			$c = "@callback";
			$g->$c = $options;
			$options=$g;
		}
		if ($where!=null)
		{
			$q .= " WHERE  ".IGKSQLQueryUtils::GetCondString($where, $options->Operand);
		}
		$q .= IGKSQLQueryUtils::GetExtraOptions($options);

			// return $q;
			// if (is_string($where) && !empty($where))
				// $q .= " WHERE ".$where."";
			// else if (is_array($where) || is_object($where)){
				// $c = 0;
				// $q .= " WHERE ";
				// foreach($where as $k=>$v)
				// {
					// if ($c!==0)
						// $q.= " ".$operand. " ";
					// else
						// $c= 1;

					// $q.= "`".igk_db_escape_string($k);
					// if( $q == null)
					// $q.="` IS NULL";
					// else
					// $q.="`='".igk_db_escape_string($v)."'";
				// }
			// }
		// }
		//igk_wln("send query ".$q);
		return $this->sendQuery($q, $tbname, $options);
	}

	public function selectAndWhere($tbname, $condition=null, $options=null){
		//build a mysql select query
		$o = "";
		$q = "";
		$s = 0;
		$sort = is_array($options) ? igk_getv($options, "Sort"): 0;
		$scl = $sort ? $options["SortColumn"] : null;
		$limit = is_array($options) ? igk_getv($options, "Limit"): null;

		if (is_string($tbname)){
			$tbname =  igk_mysql_db_tbname($tbname);
			$q = "SELECT * FROM `".$tbname."`";
		}
		else if (is_array($tbname)){
			$r =0;
			foreach($tbname as $k){
				$_n =  igk_mysql_db_tbname($k);
				if($r) $q.=",";
				$q .= "`".$_n."`";
				$r=1;
			}
			$q = "SELECT * FROM ".$q."";
		}
		if ($condition){
			if (is_object($condition)){
				$q .= " WHERE ".IGKSQLQueryUtils::GetCondString($condition);
			}
			else if (is_array($condition) && igk_count($condition) > 0)
			{
				$q .= " WHERE ".IGKSQLQueryUtils::GetCondString($condition);
			}
			else if (is_numeric($condition) || !is_string($condition)){
				$q .= " WHERE `".IGK_FD_ID."`='".igk_db_escape_string($condition)."' ";
			}
			else if (is_string($condition)){
				$q .= " WHERE ".igk_db_escape_string($condition)." ";
			}
		}

			if ($sort){
				$q .= " ORDER BY `".igk_db_escape_string($scl )."` ".$sort. " ";
			}
			if ($limit)
				$q.= "Limit ".$limit. " ";

		// igk_log_write_i(eval('__FILE__;'), "query : ".$q);
		return $this->sendQuery($q, $tbname, $options);

	}

}

class IGKDbUserProfile extends IGKObject
{
	private $m_user;
	private $m_apps;
	public function __call($s,$args){
		return call_user_func_array(array($this->m_user, $s), $args);
	}
	public function __get($s){
		if (method_exists($this, "get".$s) ){
			return call_user_func(array($this, "get".$s), null);
		}
		return $this->m_user->$s;
	}
	public function __set($s, $v){
		if (!$this->_setIn($s,$v))
			$this->m_user->$s = $v;
	}

	public function __construct($u, $apps){
		$this->m_user = $u;
		$this->m_apps = $apps;
	}
	public function getCtrl(){
		return $this->m_apps;
	}
	public function getUser(){
		return $this->m_user;
	}
	public function initiliazeSetting($s){
	}
}


final class IGKDbCacheData extends IGKObject{
	var $Data;
	var $DateTime;
	public function Expires(){
		if ($this->DateTime)
		{
			$s = igk_time_span("Ymd His", $this->DateTime);
			$d = igk_time_span("Ymd His", date('Ymd His'));
			return $d>$s;
		}
		return true;
	}
}

class IGKDbExpression
extends IGKObject
implements IIGKHtmlGetValue{
	private $m_v;
	public function getValue($o=null){
		return $this->m_v;
	}
	public function __construct($value){
		$this->m_v = $value;
	}
}

final class IGKControllerOptionsItem extends IGKHtmlItem{
	private $m_ctrl;
	public function getCtrl(){return igk_getctrl($this->m_ctrl); }
	public function __construct($ctrl){
		if ($ctrl==null)
			igk_die("Argument exception");
		parent::__construct("div");
		$this->m_ctrl = $ctrl;
		$this["class"] = "igk-ctrl-options";
		$this["igk-type"] = "igk-ctrl-options";
		//force top most
		$this->Index = -1000;
		$t = $ctrl->TargetNode;
		// if ($t)
			// $t->attachChild($this);
		// else
		// {
			//igk_wln("is init " . IGKApp::IsInit());
			// igk_die("target not created : ".$this->Ctrl. " : ".$ctrl ." = ".get_class($ctrl));
		// }
	}
	public function getIsVisible(){
		$r=  parent::getIsVisible() && $this->m_ctrl->App->IsSupportViewMode(IGKViewMode::WEBMASTER)
		&& $this->Ctrl->CurrentPageFolder!= IGK_CONFIG_PAGEFOLDER;
		return $r;
	}

	protected function __AcceptRender($o=null){
		$this->ClearChilds();
		$c = igk_getctrl($this->Ctrl);
		if($c == null)
			return false;
		$v_opts = $this->Ctrl->getControllerConfigOptions();
		$v_opts->Index = -1000;
		$this->add($v_opts);
		return parent::__AcceptRender($o);
	}
}

//------------------------------------------------------------------------------------------
//CLASS: IGKCONTROLLERBASE
//------------------------------------------------------------------------------------------
abstract class IGKControllerBase extends IGKObject
 implements IIGKController , IIGKWebController , IIGKDataController
{
	// private $m_visiblePage;
	// private $m_targetNode;
	// private $m_webParentCtrl;
	// private $m_childsctrl;
	// private $m_regviewChilds;
	//private $m_configs;

	//private $m_params;   // the params for controller
	// private $m_pageview; // the page view
	// private $m_view;     // the current view of this controller. "default" is the default value -> default.phtml
	// private $m_mainView; // represent the main view in page logic. "default" is the   mainView .. change the main view in order set the default visible view of the controller
	// private $m_visibility;
	// private $m_showChildFlag; //flag to call _showChild method automatically. default is true. this flag must be changed by the viewer

	private $m_fs;
	//IGKControllerBase events :
	//private $m_viewCompleteEvent;
    static $sm_regComplete; //registered controller for init complete event. template will not be called for init complete event

	//flags
	const WEBPARENT_FLAG = 1;
	const VISIBILITY_FLAG = 2;
	const SHOWCHILD_FLAG = 3;
	const PAGE_VIEW_FLAG= 4;
	const CHILDS_FLAG= 5;
	const VIEWCHILDS_FLAG= 6;
	const PARAMS_FLAG= 7;
	const CURRENT_VIEW = 8;
	const MAIN_VIEW = 9;
	const SHOW_CHILD = 10;
	
	// public function __sleep(){
		// return array();
	// }
// public function __sleep(){
		// $t = igk_reflection_get_member($this);
		// if($this->m_fs->isEmpty()){
			// unset($t["\0".__CLASS__."\0m_fs"]);
		// }
		// return array_keys($t);
	// }
	public function __wakeup(){
		if ($this->m_fs==null){
			$this->m_fs = new IGKFv();
		}
		//waike up event list
	}

	public function getShowChildFlag(){
		return $this->getFlag(self::SHOW_CHILD);
	}
	public function setShowChildFlag($v){
		$this->setFlag(self::SHOW_CHILD, $v);
	}
	///<summary>in order to speed up initialisation - disabling Can register on init by default</summary>
	protected function getCanRegisterOnInit(){
		return true;
	}

	public function handleCmd($msg, $args){

		$f = igk_io_dir($this->getDeclaredDir()."/.msghandler.pinc");
		if (file_exists($f)){
			$fc = array();
			include($f);
			$b = igk_getv($fc, $msg);
			if (is_callable($b)){
				$g = $args;
				if (func_num_args()>2){
					$g = array_merge( is_array($g)? $g: array($g), array_slice(func_get_args(),2));
				}
				$c = call_user_func_array($b, is_array($g)?$g: array($g));
				return;
			}
		}else{
			$fc = "handle_{$msg}";
			if(method_exists($this, $fc)){
				
				//callable(

				$c = call_user_func_array(array($this,$fc), is_array($args)?$args: array($args));
				//(new ReflectionClass($this))->getMethod($fc)->invoke(null);
				//$this->invokeInContext($fc);
				//igk_ilog("Done ::: ");
				return;
			}
			else{
				igk_ilog(get_class($this)." no function define to handle command");
			}
		}

		igk_die("message {$msg} not implement");
	}

	protected final function handle_func($c, $param, $doc, $exit=1){
		$h = 0;
		if (method_exists($this, $c))
			{
				//igk_exit();
				
				if ($this->IsFuncUriAvailable($c))
				{	
				$h=1;
					if ($param == null) //is_array($p) == false)
						$param = array();			
					else if (is_array($param) == false)
						$param = array($param);					
						
					$this->_include_constants();
					call_user_func_array(array($this, $c), $param);					
					if (IGKString::EndWith($c, IGK_AJX_METHOD_SUFFIX)){
						igk_exit();
					}		
						// igk_wln("function call ...".$h);
				// igk_exit();
					// $doc->RenderAJX();
				}
				else {
					if ($exit && !$this->HandleError(5406)){					
						igk_sys_error(IGK_ERR_FUNCNOTAVAILABLE);
					}
				}
				if ($exit)
					igk_exit();
			}
			return $h;
	}
	

	///<summary>determine if this controller need to register to view mecanism</summary>
	public function getRegisterToViewMecanism(){return false;} //base : return false

	public function getUseDataSchema(){
		return !self::IsSysController(get_class($this)) && igk_getv($this->getConfigs(), "clDataSchema");
	}
	public function getCanEditConfig(){//used to get rendering options
		//by default not a system controller
		return (IGKControllerManagerObject::IsSystemController($this) == false);
	}
	///<summary>RegisterInitComplete . if Ctrl is not null add it to base controller list</summary>
	///<param name="ctrl">if null return the count number of the registrated controller. else register the controller to iniList</param>
	public static function RegisterInitComplete($ctrl=null)
	{
		if (self::$sm_regComplete ==null)
			self::$sm_regComplete = array();
		if (($ctrl !== null) && ($ctrl->CanRegisterOnInit)){
			self::$sm_regComplete[] = $ctrl;			
		}
		return igk_count(self::$sm_regComplete);
	}
	public static function UnRegisterInitComplete($ctrl){
		$t = array();
		// igk_ilog("unregister count ".igk_count(self::$sm_regComplete ));
		foreach(self::$sm_regComplete as $k=>$v){
			if ($v===$ctrl)
				continue;
			$t[] = $v;
		}
		self::$sm_regComplete = $t;
		// igk_ilog("after count ".igk_count(self::$sm_regComplete ));
	}
	public static function InvokeRegisterComplete(){
		if (self::$sm_regComplete){
			foreach(self::$sm_regComplete as $k=>$v){
				$key = ("init_".$v->Name);	
				//igk_start_time($key);			
				$v->InitComplete();
				//igk_utest_wln("mesure ".igk_execute_time($key). " \t for : ".$v->Name . ":".get_class($v));
			}
		}
		self::$sm_regComplete =null; //clear the register complete list
	}
	protected static function InvokeInitCompleteOn($ctrl){
		if ($ctrl!=null)
			$ctrl->InitComplete();
	}


	// public function addViewCompleteEvent($obj, $methodName){//add method event
		// // if ($this->m_viewCompleteEvent)
		// // {
			// // $this->m_viewCompleteEvent->add($obj, $methodName);
		// // }
	// }
	// public function removeViewCompleteEvent($obj, $methodName){//remove method event
		// // if ($this->m_viewCompleteEvent)
		// // {
			// // $this->m_viewCompleteEvent->remove($obj, $methodName);
		// // }
	// }

	///<summary>call function in context of the class</summary>
	public function call_incontext($funcname, $params){
		//grant access to private or protected function
		if (get_called_class() == get_class($this)){
			return call_user_func_array(array($this, $funcname), $params);
		}
		return false;
	}
	public function getVisibility(){return $this->m_visibility; }
	protected function setVisibility($visibility) { $this->m_visibility = $visibility; }
	public function getCurrentView (){		
		return $this->getFlag(self::CURRENT_VIEW, IGK_DEFAULT_VIEW);
	}
	///<summary>get the main view </summary>
	public function getMainView(){
		return $this->getFlag(self::MAIN_VIEW, IGK_DEFAULT_VIEW); 
		// if (empty($this->m_mainView)){
			// $this->m_mainView = IGK_DEFAULT_VIEW;
		// }
		// return $this->m_mainView;
	}
	//<summary>set the main view</summary>
	protected function setMainView($v){
		$this->setFlag(self::MAIN_VIEW, $v);
		// $this->m_mainView = $v;
	}
	///<summary>reset the value of the current view</summary>
	protected function resetCurrentView($view=null){
		$this->setFlag(self::CURRENT_VIEW, $view);//IGK_DEFAULT_VIEW);
		// if ($view==null){
			// $this->m_view= IGK_DEFAULT_VIEW;
		// }else{
			// $this->m_view = $view;
		// }
	}
	public function setCurrentView($view, $reload=true, $targetNode= null, $args=null){

		$cview = $this->getCurrentView();

		if ($cview != $view )
		{			
			$this->setFlag(self::CURRENT_VIEW, $view);
			$reload = true;
		}
		if ($reload)
		{
			$bck = $targetNode ? $this->TargetNode : null;
			if ($bck)//set target node
				$this->TargetNode = $targetNode;
			//passing argument view . append args
			$this->regSystemVars($args);
			$this->View();
			//restore backup target node
			if ($bck)
				$this->TargetNode = $bck;
		}
	}

	public function getTable($n){
		igk_die("not implements : ".__FUNCTION__);
	}
	public function getBaseUri(){
		return $this->getEnvParam("fulluri") ?? $this->getAppUri($this->currentView);
	}

	///<summary>used to run crons script on server</summary>
	public static function RunCrons($ctrl){
		//initialize and call con operation
		$f = igk_io_getfiles($ctrl->getDeclaredDir()."/Crons","/\.phtml$/");
		foreach($f as $k=>$v){
			$ctrl->_include_file_on_context($v);
		}
	}


	///<summary>get controller config options</summary>
	public function getControllerConfigOptions(){//configs options
		$node =  igk_createNode("ul");
		$node["class"] = "igk-ctrl-config-options";
		$node->addLi()->addspan()->Content = 'Controller: '.$this->Name;
		//cn : cibling name
		// IGKHtmlUtils::AddImgLnk($node->addLi(), igk_js_post_frame(igk_getctrl(IGK_THEME_CTRL)->getUri("theme_editStyle_ajx&n=".$this->Name."&cibling=1&cn".$this->Name)), "editstyle");

		$ca_ctrl = igk_getctrl(IGK_CA_CTRL);

		IGKHtmlUtils::AddImgLnk($node->addLi(), igk_js_post_frame($ca_ctrl->getUri("ca_edit_ctrl_ajx&n=".$this->Name)), "edit_16x16");
		IGKHtmlUtils::AddImgLnk($node->addLi(), igk_js_post_frame($ca_ctrl->getUri("ca_edit_ctrl_properties_ajx&n=".$this->Name)), "setting_16x16");
		IGKHtmlUtils::AddImgLnk($node->addLi(), igk_js_post_frame($ca_ctrl->getUri("ca_edit_ctrl_atricles_ajx&n=".$this->Name)), "article_16x16");
		IGKHtmlUtils::AddImgLnk($node->addLi(), igk_js_post_frame($ca_ctrl->getUri("ca_edit_ctrl_views_ajx&n=".$this->Name)), "views_16x16");

		IGKHtmlUtils::AddImgLnk($node->addLi(), "javascript: ns_igk.ajx.post('".$ca_ctrl->getUri("ca_edit_ctrl_force_view_ajx&n=".$this->Name)."');", "foreceviews_16x16");
		IGKHtmlUtils::AddImgLnk($node->addLi(), igk_js_post_frame($ca_ctrl->getUri("ca_drop_controller_ajx&forceview=1&n=".$this->Name)), "drop_16x16");
		return $node;
	}
	//retrieve the global application uri
	public static function CurrentUri(){
		return igk_io_request_uri();
	}
	public static function CurrentQueryString()
	{
		return igk_getv($_SERVER, "QUERY_STRING");
	}

	///<summary>this method will be call by system manager to configure requirement need by a specific controller</summary>
	protected function SetupCtrl($param){
		if ($this->getDeclaredFileName() == __FILE__)
			return;
		if (dirname(__FILE__) != $this->getDeclaredDir())
		{
			$f = $this->getDeclaredDir()."/.requirement.phtml";
			if (!isset($param["Requirements"]))
			{
				$param["Requirements"] = array();
			}
			if (!isset($param["Requirements"][$f]))
			{

			$libFile = __FILE__;
			$bDir= realpath(IGK_APP_DIR);
			$ads = igk_getv($param, "AddRequires");
			igk_io_save_file_as_utf8($f, <<<EOF
<?php
//file: .requirement.phtml
//Description: This files is generated by balafon framework and its contains may not be edited directly.
//it purpose is to be included in direct access stand alone script
@require_once("{$libFile}");
define('IGK_APP_DIR', realpath("{$bDir}");
if (!IGKApp::LoadCacheLibFiles())
{
	igk_exit();
}
//
//addition controller requirement
//
{$ads}
?>
EOF
,true);
		$param["Requirements"][$f]=1;
}
		}


		$f = $this->getDeclaredDir()."/.setup.phtml";
		if (file_exists($f)){
			include($f);
		}
	}

	public function setViewArgs($name, $args){
		$n = IGK_VIEW_ARGS."/{$name}";
		$t = $this->getParam($n, array());


		if ($args == null){
			$this->setParam($n,null);
		}else{
			if (is_array($t)){
				$args = array_merge($args, $t);
			}
			$this->setParam($n,$args);
		}
	}
	public final function getViewArgs($name, $reset=1){
		$n = IGK_VIEW_ARGS."/{$name}";
		$t = $this->getParam($n);
		if ($reset && ($t!=null)){
			$this->setParam($n,null);
		}
		return $t;
	}
	///<summary>Register controller view $params var</summary>
	///<param name="args">Mixed, single value or array . if single value it will be converted into an array of single array element</param>
	///<note>passing null will reset the system vars</note>
	public function regSystemVars($args=null){
		if ($args === null){
			//clear args
			$this->setEnvParam(IGK_VIEW_ARGS,null);
			igk_set_env(igk_ctrl_env_view_arg_key($this), null);
		}
		else {
			$g = $this->getEnvParam(IGK_VIEW_ARGS);
			if (is_array($args)){
				if (is_array($g)){
					$args = array_merge($g,  $args);
				}
			}
			$this->setEnvParam(IGK_VIEW_ARGS,$args);
		}
	}
	///<summary>get system variables in this controller. call extract method get var</summary>
	public function getSystemVars(){

		$ck = igk_ctrl_env_view_arg_key($this);
		$t = igk_get_env($ck);
		$c = $this->getEnvParam(IGK_VIEW_ARGS);
		if ($t!==null){
			//update target node
			// $t["t"] = $this->TargetNode;
			// $t["params"] = array("1"=>3);
			// igk_die("kd");
			return $t;
		}
		$t = array();




		// if (isset($c["doc"])){
			// igk_die("force the source document");
		// }
		//igk_resetr();
		//target node
		$t["t"] = $this->TargetNode;
		$t["ctrl"]=$this;

		 if (isset($c["doc"])){
				$t["doc"]=$c["doc"];
		 }
		 else{
			 $doc = $this->getEnvParam(IGK_CURRENT_DOC_PARAM_KEY);
			 if (!$doc){
				$doc = $this->App->Doc;
			 }
			$t["doc"]=$doc;
		 }
		if ($viewctx=$this->getParam(IGK_CTRL_VIEW_CONTEXT_PARAM_KEY)){
			$t["viewcontext"]=$viewctx;
		}


		// igk_wln($_REQUEST);
		// return $t;
		if (igk_count($_REQUEST)> 0)
			$t= array_merge($t, array("request"=>$_REQUEST));
		$tab  = $this->App->getControllerManager()->getControllers();
		if (is_array($tab))
		{
			$t["igk_controllers"] = $tab;
		}
		if ($this->getParam("func_get_args") !=null)
		{//passing arguments
			$t["func_get_args"] = $this->getParam("func_get_args");
		}

		if ($c!==null){
			$params = array("params"=>is_array($c)?$c: array($c));
			$t = array_merge($t, $params);
		}else{
			//igk_debug_wln(igk_html_debug_m("/!\\ there is no sytem parameter to send to -> ".$this->Name.  " ".igk_env_count('d') ));
		}
		//set the environment variable to pass
		igk_set_env($ck, $t);
		return $t;
	}
	///<summary>get or set if this items can't add child</summary>
	public function getCanAddChild(){
		return true;
	}

	public function getPageView(){

		$g = $this->getFlag(self::PAGE_VIEW_FLAG) ?? (function(){
			$g =new IGKPageView() ;
			$g->register("default");
			return $g;
			})();

		return $g;


	}
	//is system controller
	public function getIsSystemController(){ return false; }

	private static $sm_sysController;

	public static function RegSysController($className)
	{
		if (self::$sm_sysController == null)
			self::$sm_sysController = array();
		if (class_exists($className))
		{
			self::$sm_sysController[$className] = $className;
		}
	}
	public static function IsSysController($className)
	{
		return (igk_getv(self::$sm_sysController, $className)!=null);
	}
	//get the current parent controller
	public function getWebParentCtrl(){

		return $this->m_fs->getFlag(self::WEBPARENT_FLAG); //$this->m_webParentCtrl;
	}
	//set the current parent controller
	//---------------------------------
	public function setWebParentCtrl($value, $store=false)
	{
		$g = $this->m_fs->getFlag(self::WEBPARENT_FLAG);
		if ($g!=$value)
		{
			if ($g!=null)
				$g->unregChildController($this);

			$g = $value;
			$this->Configs->clParentCtrl = $value? $value->getName() : null;
			if ($store)
			$this->storeConfigSettings();

			$this->m_fs->updateFlag(self::WEBPARENT_FLAG, $g);
		}

	}
	//get childs of this controller
	public function getChilds(){
		return $this->getFlag(self::CHILDS_FLAG);
		}

	///<summary>register a controller with a view callback function</summary>
	public function regView($ctrl, $callback){//register controller view
		if ($ctrl === $this)
			return;
		if ($this->m_regviewChilds == null){
			$this->m_regviewChilds = array();
		}
		$this->m_regviewChilds[$ctrl->Name] =(object) array("ctrl"=>$ctrl,"func"=> $callback);

	}
	///<summary>remove controller registered view</summary>
	public function unregView($ctrl){//unregister the view controller
		if ($ctrl!=null)
			unset($this->m_regviewChilds[$ctrl->Name]);
	}

	///<summary>set environment parameter for this controller</summary>
	public function setEnvParam($key, $value, $default=null){//
		return igk_set_env(igk_ctrl_env_param_key($this)."/".$key, $value, $default);
	}
	///<summary>get environment parameter for this controller</summary>
	public function getEnvParam($key, $default=null){
		return igk_get_env(igk_ctrl_env_param_key($this)."/".$key, $default);
	}
	public function getFlagParams(){
		return $this->getFlag(self::PARAMS_FLAG);
	}
	public function updateFlagParams($g){
		$this->m_fs->updateFlag(self::PARAMS_FLAG, $g);
	}
		///<suymmary>reset the parameters</summary>
	protected function resetParam(){
		$this->m_fs->unsetFlag(self::PARAMS_FLAG);

	}
	public function getParamKeys(){
		return array_keys($this->getFlagParams());
	}
	public function unsetParam($key){
		//if (isset($this->m_params[$key]))
		$g= $this->getFlagParams();
		unset($g);
		$this->updateFlagParams($g);
	}
	///<suymmary>set the controller parameters</summary>
	public function setParam($key, $value){
		//igk_wln("set param ".$key);
		$p = $this->getFlagParams();

		if ($p== null){
			$p= array();
		}
		$p[$key] = $value;
		$this->updateFlagParams($p);
	}
	///<summary>get store parameter</summary>
	///<param name="register">register new value if non null</param>
	public function & getParam($key, $default=null, $register=false)	{ //register parameters of this controller. used in configuration to pass data
		$g= $this->getFlagParams();
		$c =  igk_getv($g, $key);
		if($c === null)
		{
			if (is_callable($default) ){
				$c = $default();
				//protected don't return a callable;
				if (is_callable($c))
					igk_die("/i\\ value not valid.  value return by a callable.", __METHOD__);

			}else{
				$c = $default;
			}
			if ($register && $c){
				$this->setParam($key, $c);
			}
		}
		return $c;
	}


	///<summary>get all controller's parameters</summary>
	public function getParams(){
		return $this->getFlagParams();
	}

	///<summaruy>dropControllerMessage </summary>
	public function dropController(){
		$this->_unregisterEvents();
		igk_html_rm($this->TargetNode);
		if ($this->hasChilds)
		{
			foreach($this->getChilds() as $k=>$v)
			{
				$v->setWebParentCtrl(null, true);
				$v->View();
			}
			//Clear childs
			$this->m_fs->unsetFlag(self::CHILDS_FLAG);

		}
	}
	public function getcanModify(){return true;}
	public function getcanDelete(){return true;}

	///<summary>get if this function is available in output query context</summary>
	public function IsFunctionExposed($function){
		if (method_exists(get_class($this) , $function))
			return true;
		return false;
	}
	///<summary>get controller's exposed function list</summary>
	///<return>exposed function list</return>
	public function getExposedfunctions(){
		return array();
	}
	///<summary>register childs controllers</summary>
	public function regChildController($controller)
	{
		if (!$this->CanAddChild)return;
		if ($controller == null)return;
		if ($controller->WebParentCtrl === $this)return;
		if ($controller == $this)return;

		$n = strtolower($controller->getName());
		$g = $this->getFlag(self::CHILDS_FLAG);
		if ($g && !isset($g[$n] ))
		{
			$g[$n] = $controller;
			$controller->setWebParentCtrl($this);
		}
	}
	public function unregChildController($controller)
	{
		if ($controller == null)return;
		if ($controller->WebParentCtrl === $this)return;
		if ($controller == $this)return;

		$n = strtolower($controller->getName());
		$g  = $this->getFlag(self::CHILDS_FLAG);
		if ($g && isset($g[$n]))
		{
			$p = $g[$n];
			$p->setWebParentCtrl(null, true);
			unset($g[$n]);
			$this->m_fs->updateFlag(self::CHILDS_FLAG, $g);
		}
		else{
			igk_debug_wln("unreg controller not removed");
		}

	}
	protected function _showChild($targetNode=null)
	{
		$t= $targetNode == null? $this->TargetNode : $targetNode;
		if ($this->hasChild)
		{
			foreach($this->getChilds() as $k=>$v)
			{
				if ($v->getIsVisible())
				{
					//bind the node to this controller
					igk_html_add($v->TargetNode, $t);
					$v->View();
				}
				else {
					igk_html_rm($v->TargetNode);
				}
			}
		}
	}
	///<summary>view complete.</summary>
	protected function _onViewComplete(){//called to raise the method when View complete on the current Controller. must be called on the view Method.
		if (($this->m_regviewChilds!=null) && is_array($this->m_regviewChilds))
		{
			//here v is is STDCLASS of "cltr","func" param
			foreach($this->m_regviewChilds as $k=>$v)
			{
				$m = $v->func;
				$v->ctrl->Invoke($m, $this);
			}
		}
		igk_invoke_session_event(IGKEvents::VIEWCOMPLETE, array($this, null));
	}

	public function gethasChilds(){
		$g  = $this->getFlag(self::CHILDS_FLAG);
		return $g && (is_array($g) && (count($g)>0)); }

	//used to identity the controller into the controller index
	public function getName(){return strtolower(get_class($this));}
	public function getConfigs(){//get the controller configs
		$c = igk_get_env_init(igk_ctrl_env_param_key($this)."/configs" , function(){
			return $this->initConfigSetting();
		});
		return $c;
	}
	//display name of the controller
	public function getDisplayName(){return get_class($this); }
	public function getIsVisible(){
		return $this->PageView->getIsVisible($this->CurrentPage);
	}
	public function getisAvailable(){return true;}
	public function initMenu(){ return null;}
	public function initConfigMenu(){return null;}
	public function getCurrentPageFolder(){ return $this->App->CurrentPageFolder;}
	public function getCurrentPage(){ return $this->App->CurrentPage;}

	public function getCanInitDb(){
		if (IGKApp::$DEBUG)
			return true;
		return igk_is_conf_connected();
	}
	protected function initDb(){//igk controller base init  db
		if (!$this->getCanInitDb())
		{
			igk_debug_wln("Can't init db ".$this->Name . " ConfigUserConnected: ".igk_parsebool(igk_is_conf_connected()));
			return;
		}
		$cl = get_class($this);
		igk_set_env("sys://db/constraint_key", $cl);
		// for child controller that can support multiple table name declaration
		if (!$this->UseDataSchema)
		{
			//igk_debug_wln("init from db functions");
			igk_debug_wln("init from db functions ".get_class($this));
			//init from funciton
			$this->initDbFromFunctions();
		}
		else{
			igk_debug_wln("init from db schemas ".get_class($this));
			// igk_log_write_i("initDb", "schema : ".get_class($this)  ." . " .igk_reflection_getdeclared_filename($this));
			$this->initDbFromSchemas();
			$this->initDbConstantFiles();
		}
		igk_set_env(get_class($this)."::".__FUNCTION__, 1);
	}

	///<summary> initialize db from internal functions</summary>
	protected function initDbFromFunctions(){
		$v_tab = $this->getDataTableInfo();
		$v_tablename= $this->getDataTableName();
		if (($v_tab == null)|| ($v_tablename==null))
			return;

		$db = igk_get_data_adapter($this, true);
		if ($db && $db->connect()){
			igk_notification_push_event(IGK_NOTIFICATION_INITTABLE, $this, array($v_tablename, $v_tab));

			$s = $db->createTable($v_tablename, $v_tab, null , null, $db->DbName);
			if ($s && $db->haveNoLinks($v_tablename, $this)){
				//$this->initDataEntry($db);
			}
			$db->close();
		}
	}
	public final function invokeInitDataEntry($db, $tbname=null){
		$this->initDataEntry($db, $tbname);
	}
	protected function dropDbFromSchemas(){
		$r = $this->loadDataAndNewEntriesFromSchemas();
		if (!$r){
			// if (igk_env_count("init_db")>1)
			igk_die(__FUNCTION__." >> not data init for : " .get_class($this) ." ".$this->getDeclaredFileName());
			return;
		}
		igk_ilog("init ... ".get_class($this) ,__FUNCTION__);
		// igk_wln($r);
		$tb = $r->Data; //$this->loadDataFromSchemas();
		$etb = $r->Entries; //$this->loadDataNewEntriesFromSchemas();
		// igk_wln($tb);
		$db = igk_get_data_adapter($this, true);
		if ($db){
			if ($db->connect()){
				// igk_wln("connect...=".$db->getDbName());
				// igk_db_dump_result($db->sendQuery('SELECT DATABASE()'));
				//$db->selectdb($this->App->Configs->db_name);
				$tables = array();
				foreach($tb as $k=>$v)
				{
					$tables[]= igk_db_get_table_name($k);

					// igk_wln("entry $k");
					// igk_wln(igk_getv($etb, $k));
					// $n = igk_db_get_table_name($k);
					// igk_wln("drop table : ".$n);
					// $r = $db->DropTable($n);
					// igk_wln($r);
				}
				$db->DropTable($tables);
				$db->close();
		}else{
			igk_wln("connexion failed ");
		}

		}else{
			igk_log_write_i(__FUNCTION__,"no adapter found");
		}
		//igk_exit();
		return $tb;
	}
	///<summary> initialize db from data schemas </summary>
	protected function initDbFromSchemas()
	{
		$r = $this->loadDataAndNewEntriesFromSchemas();
		if (!$r){
			return;
		}
		igk_ilog_assert(igk_is_debug(), "init ... ".get_class($this) ,__FUNCTION__);
		$tb = $r->Data;
		$etb = $r->Entries;




		$db = igk_get_data_adapter($this, true);
		if ($db){
			if ($db->connect()){
				foreach($tb as $k=>$v)
				{
					$n = igk_db_get_table_name($k);
					$data = igk_getv($etb, $k);

					igk_invoke_session_event('sys://event/sdb/inittable', array($this, array($n, $v )));

					// igk_wln("raise event:".$n);

					igk_notification_push_event(IGK_NOTIFICATION_INITTABLE, $this,  array($n, $data));
					$r = $db->createTable($n,
						igk_getv($v, 'ColumnInfo'),
						$data,
						igk_getv($v, 'Description'),
						$db->DbName
					);
				}
				//$this->initDataEntry($db, "sys://".__METHOD__);
				$db->close();
		}else{
			igk_ilog("/!\\ connexion failed ");
		}

		}else{
			igk_log_write_i(__FUNCTION__,"no adapter found");
		}
		return $tb;
	}
	protected function __init_entries($ctrl, $tablename, $etb, $db){
		if ($db->initSystableRequired($tablename))
		{
			//igk_wln("table require init of some data ".$tablename);
			//igk_show_prev($db->getStoredRequired());
			//create some table before insert data
			$e = $this;
			//push data to reserved
			$db->initSystablePushInitItem($tablename, function() use (
				$e, $ctrl, $tablename, $etb , $db){
				//igk_wln("cakkbackk  : " .$tablename);
				//igk_show_prev(igk_getv($db->getStoredRequired(),'Data'));
				$e->__init_entries($ctrl, $tablename, $etb, $db);
			});
		}
		else{

			if (($etb !=null) && array_key_exists($tablename, $etb))
			{
				//igk_wln("insert ....".$tablename);
				foreach($etb[$tablename] as $e=>$ee)
				{
					if (!$db->insert($tablename, (object)$ee))
					{
						igk_wln("insert failed ".$db->getError());
						//igk_wln($ee);
						return false;
					}
				}
			}
			else{
				$ctrl->initDataEntry($db, $tablename);
			}
		}
		return true;
	}
	protected function loadDataAndNewEntriesFromSchemas(){
		return igk_db_load_data_and_entries_schemas(igk_db_get_schema_filename($this));
	}
	///<summary>load data base from data schemas file</summary>
	protected  function loadDataFromSchemas(){
		return igk_db_load_data_schemas(igk_db_get_schema_filename($this));
	}
	///<summary>load data new entries from schemas file</summary>
	protected  function loadDataNewEntriesFromSchemas(){
		return igk_db_load_data_entries_schemas(igk_db_get_schema_filename($this));
	}
	///<summary> override to init data entries</summary>
	protected function initDataEntry($dbman, $tbname=null){//initialize data local data table entries
		//init default data entry
	}
	public function getCanEditDataBase(){//get for editionon table info
		return $this->UseDataSchema;
	}
	public function getCanEditDataTableInfo(){//indicate that
		return !$this->UseDataSchema;
	}

	public function getDataTableInfo(){//load data from db configs files
		if ($this->UseDataSchema)
		{
			$tb  = $this->loadDataFromSchemas();
			return $tb;
		}
		// if ($tb){
			// $n = $this->getDataTableName();
			// if (isset($tb[$n]))
			// {
				// return $tb[$n];
			// }
			// return null;
		// }
		if (file_exists($this->DBConfigFile ))
		{
			$e =  igk_createNode("__loadData");
			$e->Load(IGKIO::ReadAllText($this->DBConfigFile));
			$t = array();
			foreach($e->getElementsByTagName(IGK_COLUMN_TAGNAME) as $k)
			{
				$t[] = new IGKDbColumnInfo($k->Attributes->ToArray());
			}
			return $t;
		}
		return null;
	}

	public function getDataTableName(){
		if (file_exists($this->DBConfigFile ))
		{
			$e =  igk_createNode("__loadData");
			$e->Load(IGKIO::ReadAllText($this->DBConfigFile));
			$t = igk_getv($e->getElementsByTagName(IGK_DATA_DEF_TAGNAME)	,0);
			if ($t)
			{
				$s = $t["TableName"] ;
				if (!empty($s))
					return $s;
			}
		}
		return IGK_TABLE_PREFIX.$this->Name;
	}

	//-----------------------------------------------------------------------------------------
	//DB FUNCTION OBSOLETE
	//-----------------------------------------------------------------------------------------
	///<summary>select equal property</summary>
	///<param name="equal"></param>
	public function dbselect($equals){
		return $this->getDbEntries()->searchEqual($equals);
	}
	public function dbselectAndWhere($whereTab, $options){
		$v = $this->dbinvokeDbFunction(array($this, "__dbselect_andwhere"), $whereTab, $options);
		return $v;
	}

	public function dbupdate($entries=null){
		return  $this->dbinvokeDbFunction(array($this, "__dbupdate_entries"), $entries);
	}
	public function dbdelete($entries){
		return $this->dbinvokeDbFunction(array($this, "__dbdelete"), $entries);
	}
	public function dbselectLastId(){
		$v = $this->dbinvokeDbFunction(array($this, "__dbselectlastid"));
		return $v;
	}
	//insert to entries
	public function dbinsert($entry){
		$v = $this->dbinvokeDbFunction(array($this, "__dbinsert"), $entry);
		return $v;
	}


	public function dbinvokeDbFunction($param){
		$adapt = igk_get_data_adapter($this, true);
		if ($adapt == null)
			return null;
		$d = null;
		if ($adapt->connect()){
			try{
				$p  = array($adapt);
				if (func_num_args()>1)
					$p = array_merge($p, array_slice( func_get_args(), 1));

				$d = call_user_func_array($param, $p);

			}
			catch(Exception $ex)
			{
				$d = null;
				igk_debug_wln("error Append ".$ex);
			}
		}
		$adapt->close();
		return $d;
	}

	///retrieve all controller db entries
	public function getDbEntries(){
		return $this->dbinvokeDbFunction(array($this, "__dbselectAll"));
	}
	private function __dbselect_andwhere($adapt, $properties){
		return $adapt->selectAndWhere($this->getDataTableName(), $properties);
	}
	private function __dbselectAll($adapt){
		return $adapt->selectAll($this->getDataTableName());
	}
	private function __dbinsert($adapt,$entry){
		return $adapt->insert($this->getDataTableName(), $entry);
	}
	private function __dbselectlastid($adapt){
		return $adapt->getLastId();
	}
	private function __dbupdate_entries($adapt, $entries=null)
	{
		if ($entries==null)return;
		if (is_array($entries))
		{
			foreach($entries as $k=>$v)
			{
				$this->__dbupdate_entries($adapt, $v);
			}
			return;
		}
		return $adapt->update($this->DataTableName, $entries);
	}
	///delete entries in database
	///@adapt : adapter
	///@entries : array or object of entries to delete
	private function __dbdelete($adapt, $entries)
	{
		if ($entries==null)return;
		if (is_array($entries))
		{
			if (igk_count($entries)> 0)
			{
				foreach($entries as $k=>$v)
				{
					$this->__dbdelete($adapt, $v);
				}

			}
			return;
		}
		return $adapt->delete($this->DataTableName, $entries);
	}



	//-----------------------------------------------------------------------------------------------
	//
	//-----------------------------------------------------------------------------------------------

	public function getFlag($code, $default=null){		
		return $this->m_fs->getFlag($code, $default);
	}
	public function setFlag($code, $value){
		$this->m_fs->setFlag($code, $value);
	}


	//get the target node

	public function getTargetNode(){
		$b =  $this->getParam(IGK_CTRL_TG_NODE) ?? (function(){
			$g = $this->initTargetNode();
			//$this->setFlag(
			$this->setParam(IGK_CTRL_TG_NODE, $g);
			return $g;
		})();//, $node);
		//return $this->m_targetNode;

		return $b;
	}
	protected function getHandleShowChild(){
		return $this->getFlag(self::SHOWCHILD_FLAG, true);
	}
	protected function setHandleShowChild($value){
		if ($value)
			$this->m_fs->unsetFlag(self::SHOWCHILD_FLAG);
		else
			$this->m_fs->setFlag(self::SHOWCHILD_FLAG, 0);

	}
	//get the id of the target node
	public function getTargetNodeId() { return $this->TargetNode["id"]; }
	//protected set the method
	protected function setTargetNode($node) {
		$this->setParam(IGK_CTRL_TG_NODE, $node);
		// $this->m_targetNode = $node;
	}

	///<summary>get global document</summary>
	public final function getDoc(){return $this->getEnvParam(IGK_CURRENT_DOC_PARAM_KEY) ??  igk_app()->Doc;}
	///<summary>get the controller current document</summary>
	public function getCurrentDoc(){return igk_app()->Doc; }

	public function getViewfile($view){
		$ext = preg_match('/\.phtml$/i', $view)? '':'.phtml';
		$view = $view.$ext;
		return $this->getCtrlFile(IGK_VIEW_FOLDER."/".$view);
	}
	public function getCtrlFile($path)
	{
		if (realpath($path) == $path)
			return $path;
		return igk_io_dir(dirname($this->getDeclaredFileName()).DIRECTORY_SEPARATOR.$path);
	}
	///<summary>include view on contex</summary>
	protected function _include_view_file($view, $args=null){
		$v_file = file_exists($view) ? $view : $this->getViewfile($view);
		if (file_exists($v_file)===true)
		{	$d = null;
		//igk_wln($args);
			if ($args!==null){
				//reset regSystemVars
				//backup system reg view
				$d = $this->getSystemVars();
				$this->regSystemVars(null);
				//set new var
				$this->regSystemVars($args);

			}
			$this->_include_file_on_context($v_file);
			if ($d)
				$this->regSystemVars($d);
		}
	}
	protected function _include_constants(){
		//igk_wln("call....".$this->Name);
		if (($f = $this->getConstantFile()) && file_exists($f)) include_once($f);
		if (($f = $this->getDbConstantFile()) && file_exists($f)) include_once($f);
		unset($f);
	}
	//copy this fonction to allow file inclusion on the current context controller
	protected function _include_file_on_context($file){
	;
		$this->_include_constants();
		igk_reset_globalvars();
		//define view variable on context
		$fname = igk_io_basenamewithoutext($file);
		$furi = $this->getAppUri($fname);
		$dir = dirname($file);
		$this->m_view = $fname;
		$cview=$this->getCurrentView();
		//extract system vars
		extract($this->getSystemVars());
		$this->setEnvParam("fulluri", $furi);
		// CHECK FOR MEMORY LIMIT 128
		$params = isset($params)? $params : array();//null;
		$gx = strtolower( (isset($css_def)? " ".$css_def : null) );
		
		if ($fname != $cview){
			array_unshift($params, $cview);
		}
		$this->bindNodeClass($t, $fname, $gx);
		//reset class
		$doc->body["class"]="-custom-thumbnail";
		try{
			igk_set_env("sys://ctrl/view/controller", $this); //store the current controller before the view class
			$viewargs = get_defined_vars();
			include($file);
		}catch(Exception $ex){
			igk_show_exception($ex);
			igk_exit();
		}
	}
	protected function bindNodeClass($t, $fname, $css_def=null){
		igk_ctrl_init_css($this, $t, igk_css_str2class_name($fname) .($css_def?" ".$css_def : "") );
	}
	///<summary>call view layout without changing current view</summary>
	public function getView($view=null, $forcecreation=false, $args=null){
 // igk_ilog("check forb view ".$view);
		extract($this->getSystemVars());
		$v = igk_io_dir($view !=null? $view: igk_getr("v", $view));
		$f = realpath($v)==$v? $v : $this->getViewfile($v);
		//reset system var
		$this->regSystemVars(null);
		if (file_exists($f) || ($forcecreation && igk_io_save_file_as_utf8($f,IGK_STR_EMPTY)))
		{

			if (($args!==null) && !empty($args)){

				$this->regSystemVars($args);
			}
			$this->_initCssStyle();
			$this->_include_file_on_context($f);
			$this->regSystemVars(null);
		}
	}
	public function getViewContent($view, $target, $forcecreation=false, $args=null){
		//
		//!\sometime you have to restore the backuped target node. before get view content
		//backup node and current view
		//
		$key = "ctrl/backupnode";
		$g = $this->getParam($key);
		if($g){
			$this->TargetNode = $g;
		}
		$bck = $this->TargetNode;
		$this->setParam($key, $bck);
		$v_view = $this->CurrentView;

		$this->TargetNode = $target;
		$this->getView($view, $forcecreation, $args);
		//restore
		$this->TargetNode = $bck;
		$this->resetCurrentView($v_view);
		// igk_wln("the view ::: ".$this->m_currentView);
		// igk_wln(get_class($this));
		// $this->m_currentView = $v_view;
		// igk_ilog("reset ".$v_view. "/".$view);
		//free node
        $this->setParam($key, null);
	}
	///<summary> call init view file </summary>
	protected function _initPage(){
		$f = $this->getViewfile("_init");
		if (file_exists($f) && igk_io_basenamewithoutext($f)=="_init"){
			//initilialize page
			include($f);
		}
	}
	///<summary>override this method to show the controller view.</summary>
	public function View(){	// basic controller view
		$t = igk_getv($this->getSystemVars(),"t");

		if ($t)
		{
			$this->ShowChildFlag = true;					
			$this->_initView();
		}
		else {
			igk_debug_wln("/!\\ TargetNode is null ".get_class($this));
			igk_debug_wln($t);
			igk_debug_wln(igk_ob_get(array_keys($this->getSystemVars())));
		}

	}
	///<summary>init controller view</summary>
	protected function _initView(){
		$this->_initCssStyle();
		$this->_renderViewFile();
		if ($this->ShowChildFlag)
			$this->_showChild(null);				
		$this->_onViewComplete();
	}

	///<summary>render the target node in ajx context</summary>
	public function ViewAJX(){//render the target node on ajx view context
		$t = $this->getTargetNode();
		if ($t!=null){
			$t->RenderAJX();
		}
		igk_exit();
	}
	///<summary>get style dir</summary>
	public function getPrimaryCssFile(){
		return igk_io_dir($this->getStylesDir()."/". igk_getv($this->Configs, "PrimaryStyle",  "default.pcss"));
	}
	protected function _initCssStyle(){//used to initialize your custom style
		igk_ctrl_bind_css_file($this);
	}
	protected function _renderViewFile(){
		include(IGK_LIB_DIR."/".IGK_INC_FOLDER."/.extract_view_args.pinc");
		
		// extract($this->getSystemVars());
		$v = $this->getCurrentView() ?? igk_die("current view is null.");
		$c = strtolower(igk_getr("c",null));
		if ($c ==  strtolower($this->Name)){
			$v = igk_getr("v", $v);
		}		
		$f = $this->getViewfile($v);
		///creaate file on render view context
		if (!file_exists($f) && !method_exists($this, $v)){
			if (igk_is_conf_connected()  && IGKServerInfo::IsLocal())
			{
				//igk_io_save_file_as_utf8
				if (!igk_io_save_file_as_utf8($f, igk_get_defaultview_content($this), true))
				{
					igk_debug_wln("can't create the file ".$f . " AT ".__LINE__);
					igk_exit();
				}
			}		
			else {
				//redirect to resource not found
				$message = R::ngets("res.notfound_1",$f)->getValue();				
				throw new IGKResourceNotFoundException($message, $f);
				igk_exit();
			}
		}
		if (file_exists($f))
		{
			//include context
			$this->_include_file_on_context($f);
		}
		
	}
	/// ask for a view in ajx context
	public function view_ajx(){
		$v = igk_getr("v", "default");
		$this->CurrentView = $v;
		$this->TargetNode->RenderAJX();
	}
	///used to reload a view in ajx context
	public function reload_view_ajx()
	{
		if (igk_is_ajx_demand()==1)
		{
			$this->View();
			$c =  igk_createNode("script");
			$c->Content = "if(IGK) window.igk.ajx.post( '".$this->getUri("view_ajx")."',null,  new window.igk.ajx.responseNode('".$this->getTargetNodeId()."').response )";
			$m = new IGKHtmlSingleNodeViewer($c);
			$m->RenderAJX();
		}
	}

	///<summary> override to manage the view when page folder changed.</summary>
	protected function pageFolderChanged(){
		if (($this->getWebParentCtrl() ==  null) && !igk_own_view_ctrl($this) && $this->getIsVisible())
		{
			$this->View();
		}
	}
	///<summary> override this when page change on a spécific page</summary>
	protected function pageChanged(){
	}
	///<summary> override to init controller according to other created controller.</summary>
	protected function InitComplete(){//base Init complete method
		$this->_initPage();
		$f1 = $this->getDeclaredFileName();
		$f2 = __FILE__;
		if (($f1!== $f2)&&(dirname($f1)!== dirname($f2)))
		{
			//load private script
			igk_js_load_script($this->App->Doc, igk_io_dir(dirname($this->getDeclaredFileName())."/".IGK_SCRIPT_FOLDER));

			R::RegLangCtrl($this);

		}
		if ($this->Configs!=null)
		{
			$this->_conf_regToParent();
		}
		else {
			igk_debug_wln("error ". $this->Name);
		}
		$p = $this->PageView;
		if ($p == null){
			igk_die("ERROR: no pageview defined for ".$this." your class probably don't call the base construct");
		}
		$p->registerPages();
		//register page changed event
		$this->_registerEvents();


		// if ($f1!== $f2){
			//load custom language
			// $langdir = igk_io_dir($this->getDataDir()."/R/Lang");
			// if (is_dir($langdir)){
				//regisert if landir exist
				// R::getInstance()->PageLangChangedEvent->add($this, "planguageChanged");
				// $this->planguageChanged();
			// }
		// }
	}
	protected function _registerEvents(){
		// $this->App->addCurrentPageFolderEvent($this, "pageFolderChanged");
		// $this->App->addCurrentPageEvent($this, "pageChanged");
	}
	protected function _unregisterEvents(){
		// $this->App->removeCurrentPageFolderEvent($this, "pageFolderChanged");
		// $this->App->removeCurrentPageEvent($this, "pageChanged");
		// $this->App->removeCurrentPageFolderEvent($this, "pageFolderChanged");
		// $this->App->removeCurrentPageEvent($this, "pageChanged");
	}

	///override this method to show the controller view.
	public function getDeclaredFileName()
	{
		$h = new ReflectionClass ($this);
		return $h->getFileName();
	}
	public function getDeclaredDir(){
		return dirname($this->getDeclaredFileName());
	}
	///<summary>get the constant file </summary>
	public function getConstantFile(){
		return $this->getDeclaredDir()."/.constants.php.inc";
	}
	public function getDbConstantFile(){
		return $this->getDeclaredDir()."/.db.constants.php";
	}
	protected final function  getFile($f){
		return igk_io_dir($this->getDeclaredDir()."/".$f);
	}
	protected function initDbConstantFiles(){
		 $f = $this->getDbConstantFile();
		 $tb = $this->getDataTableInfo();
		 $s = "<?php\n";
		 //build constant file

		 if ($tb !=null){
			$tb = array_keys($tb);
			sort($tb);
			 foreach($tb as $k)
			 {
				$n = strtoupper($k);
				$n = preg_replace_callback("/^%prefix%/i", function(){
					return IGK_DB_PREFIX_TABLE_NAME;}, $n);
				$s .= "define(\"". $n."\", \"".$k."\");\n";
			 }
		 }
		 $s .= "?>";
		 IGKIO::WriteToFile($f, $s, true);
		 //igk_ilog("init db constant ".$f);
		 include_once($f);
	}
	//get the current article path
	public function getArticle($name)
	{
		return $this->getArticleInDir($name, $this->getArticlesDir());
	}
	public function getArticleInDir($name, $dir){
		return igk_io_get_article($name, $dir);
	}
	public function getAllArticles(){
		return IGKIO::GetFiles($this->getArticlesDir(), "/\.(template|html|phtml)$/i",false);
	}
	public function getAllArticlesByCurrentLang()
	{
		$dir = $this->getArticlesDir();
		$t = igk_io_getfiles($dir);
		$lang_search = null;
		$lang_search = R::GetCurrentLang();
		$out = array();
		if ($t && count($t)>0)
		{
			sort($t);
			foreach($t as $k)
			{
				$n =  basename($k);
				if ($lang_search && !IGKString::EndWith(strtolower($n), igk_get_article_ext($lang_search)))
					continue;
				if($this->m_search_article && !strstr(strtolower($n), strtolower($this->m_search_article)))
					continue;
				$out[] = $k;
			}
		}

		return $out;
	}


	public function getArticleFull($fullname)
	{
		return igk_io_dir($this->getArticlesDir()."/".$fullname);
	}
	public function getArticlesDir()
	{
		return igk_io_dir($this->getDeclaredDir()."/".IGK_ARTICLES_FOLDER);
	}
	public function getViewDir()
	{
		return igk_io_dir($this->getDeclaredDir()."/".IGK_VIEW_FOLDER);
	}
	///<summary>return the current inclusion directory</summary>
	public function getIncDir()
	{
		return $this->getDeclaredDir()."/".IGK_INC_FOLDER;
	}
	public function getDataDir()
	{
		return $this->getDeclaredDir()."/".IGK_DATA_FOLDER;
	}
	public function getScriptDir(){
		return $this->getDeclaredDir()."/".IGK_SCRIPT_FOLDER;
	}
	public function getStylesDir(){
		return $this->getDeclaredDir()."/".IGK_STYLE_FOLDER;
	}
	public function getApp(){ return igk_app();	}

	///<ummary>Invoke a declarative function in a controller context</summary>
	public function invokeInContext($m){

		//igk_include_view($this, $b, "detail.zone");
		//igk_wln("include in context");
		include($this->getIncDir().'/common.phinc');
		if (function_exists($m))
		{
			$g =func_get_args();
			$g = array_slice( $g,1);
			call_user_func_array($m, igk_getv($g,0));
		}
	}

	public function getmsbox(){//return the base message box frame
		return $this->App->getControllerManager()->msbox;
	}
	//return validator object
	public function getval(){
		return $this->App->Validator;
	}

	public function getBody(){
		return $this->App->Doc->Body;
	}
	public function getHeader(){
		return $this->App->Doc->Header;
	}
	//get function uri
	public function getUri($function=null)
	{
		$out = "c=".strtolower($this->getName());
		if ($function){
			$t = explode("&", $function);
			$t[0] = "&f=".str_replace ('_', '-', $t[0]);
			$out .= implode('&', $t);
		}
		return "?".$out;
	}
	///<summary>get base full request uri</summary>
	final function getBUri($function){
		return igk_io_baseUri().$this->getUri($function);
	}

	///<summary>getfull uri</summary>
	public function getAppUri($function =null)
	{
		if ($function)
			return igk_str_rm_last(igk_io_baseUri(),'/')."/".$function;
		return igk_io_baseUri();
	}
	///<summary>get article content</summary>
	///<param name="name" > name of the article</param>
	///<param name="evalExpression">demant for eval expression .default is true</param>
	///<param name="row">row used info to eval expression</param>
	public function getArticleContent($name, $evalExpression=true, $row =null){//data rows
		$f = $this->getArticle($name);
		if (file_exists($f))
		{
			$out = IGK_STR_EMPTY;
			$out = igk_io_read_allfile($f);
			if ($evalExpression)
			{
				$out = igk_html_eval_script($out, $this,$row);
			}
			return $out;
		}
		return null;
	}
	///<summary>get the article binding content</summary>
	public function getArticleBindingContent($name, $entries, $prebuild=true){
		 if (is_object($entries) && ($entries->RowCount > 0))
		 {
			$d =  igk_createNode("div");
			igk_html_binddata($this, $d, $name, $entries);
			return $d->Render();
		}
		return IGK_STR_EMPTY;
	}
	///<summary>get the article binding content with name. of the target controller</summary>
	public function getArticleBindingContentW($name, $targetCtrlName){//used for binding article width name
		return $this->getArticleBindingContent($name, igk_db_select_all(igk_getctrl($targetCtrlName)));
	}
	//get value uri
	public function getUriv($page)
	{
		$out = "?c=".strtolower($this->getName());
		if ($page)
			$out .="&v=".$page;
		return $out;
	}
	//get uri link
	public function getUril($uri)
	{
		$out = "?c=".strtolower($this->getName());
		if ($uri)
			$out .="&".$uri;
		return $out;
	}
	//init uri post
	public function initUriPost($form, $uri)
	{
		$uri = $this->getUri($uri);
		$form->addInput("c", "hidden", strtolower($this->getName()));

		//explode uri
		$tab = igk_getquery_args($uri);
		foreach($tab as $k=>$v){
			$form->addInput($k, "hidden", sv);
		}
	}
	//-----------------------------------------------------
	//represent a target node
	//-----------------------------------------------------
	protected function initTargetNode(){
		$tagName = igk_sys_getconfig("app_default_controller_tag_name", "div");
		$div =  igk_createNode($tagName);
		$div["id"] = igk_css_str2class_name(strtolower($this->Name));
		$div["igk-type"] = "controller";
		return $div;
	}

	//Get data ADAPTER NAME
	public function getDataAdapterName(){
		if ($this->Configs)
			return $this->Configs->clDataAdapterName;
		return IGK_MYSQL_DATAADAPTER;
	}



	protected function getConfigFile()
	{
		return igk_io_dir($this->getDataDir()."/".IGK_CTRL_CONF_FILE);
	}
	protected function getDBConfigFile()
	{
		return igk_io_dir($this->getDataDir()."/".IGK_CTRL_DBCONF_FILE);
	}
	public function storeConfigSettings(){//store configuration data
		$d =  igk_createNode("config");
		$c = $this->getConfigs();
		//store
		foreach($c as $k=>$v)
		{
			igk_conf_store_value($d, $k,$v);
		}
		$s = $d->Render();

		if( igk_io_save_file_as_utf8($this->ConfigFile, $s))
		{
			//reload config setting
			$this->setupCtrlConfigSettings();
			return true;
		}
		return false;
	}


	//<summary>load controller config setting properties</summary>
	protected function __loadCtrlConfig()
	{
			//default property value
			$t = igk_sys_getdefaultCtrlConf();
			//add additional properties
			if (method_exists(get_class($this), "GetAdditionalConfigInfo"))
			{
				$s = get_class($this);
				$c = call_user_func( array($s, "GetAdditionalConfigInfo"));
				if (is_array($c))
				{
					foreach($c as $k=>$v)
					{
						if (is_object($v))
						{
							$t[$k] = null;
						}
						else if( is_string($v) && isset($t[$v]))
						{
							$t[$v] = null;
						}
					}
				}
			}

			$f = $this->getConfigFile();
			if (file_exists($f) == false)
				return (object)$t;

			$div =  igk_createXmlNode("div");
			$s = igk_io_read_allfile($f);
			$div->Load($s);
			$d = igk_getv($div->getElementsByTagName("config"), 0);
			if ($d)
			{
				foreach($d->Childs as $k)
				{

					if ($k->Type == "HtmlText")
						continue;
					if ($k->ChildCount<=0){
						$t[$k->TagName] = $k->innerHTML;
					}else{
						$v_ob = igk_createObj();
						igk_conf_load($v_ob, $k);
						$t[$k->TagName] = $v_ob;
					}
				}
			}
			if ($this->getIsSystemController())
			{
				$t["clRegisterName"] = IGK_DOMAIN.".".$this->getName();
			}
			else{
				if (!isset($t["clRegisterName"])){
				$t["clRegisterName"] = igk_sys_getconfig("website_prefix","igk").".".$this->getName();
				}

			}
			return (object)$t;
	}

	///<summary>set up controller config</summary>
	protected function setupCtrlConfigSettings(){//load configuration setting

		if ($this->m_configs ==null)
			return;
		if ($this->TargetNode !=null)
		{
			$this->TargetNode["igk-type-id"] =  $this->Name;
			$this->TargetNode->setIndex($this->m_configs->clTargetNodeIndex);
		}
		$this->_conf_regToParent();
		if (isset($this->m_configs->clVisiblePages))
		{
			$this->PageView->register($this->m_configs->clVisiblePages);
		}

	}
	public function loadConfigSetting($conf)
	{
		if ($conf == null)
		{
			return;
		}
		$f = $this->getConfigFile();
		IGKIO::CreateDir(dirname($f));
		igk_io_save_file_as_utf8($f, $conf->Render());

		$this->initConfigSetting();
	}
	protected function initConfigSetting(){
		$g = $this->__loadCtrlConfig();
		$this->m_visibility = false;
		$this->setupCtrlConfigSettings();
		return $g;
	}

	///<summary>reload configuration setting</summary>
	public function reloadConfiguration()
	{
		if ($this->TargetNode==null)
			return;
		$this->setupCtrlConfigSettings();
	}

	function __toString()
	{
		return "IGKCONTROLLER::".get_class($this);
	}
	///<summary>.ctr IGKControllerBase</summary>
	function __construct()
	{
		if (IGKApp::$INITENV==1)
		{
			igk_wln("init env ".$this);
			igk_log_write_i("data", "ss".$this);
			return;
		}
		$this->m_fs = new IGKFv();

		$t = $this->initTargetNode();
		if ($t)
		{
			$this->setTargetNode($t);
			if ($this->getCanEditConfig())
			{
				new IGKControllerOptionsItem($this);
			}
		}
		//init config setting
		$this->initConfigSetting();
	}



	///<summary>load and init from configuration setting</summary>
	protected function _conf_regToParent()
	{
		$h=null;
		$p = $this->Configs->clParentCtrl;
		$p && ($h = igk_getctrl($p, false));
		if ($h)
		{
			if ($this->WebParentCtrl!=null)
			{
				$this->WebParentCtrl->unregChildController($this);
			}
			if ($h->CanAddChild)
			{
					$h->regChildController($this);
			}
			else {
				$this->Configs->clParentCtrl = null;
			}
		}
	}


}


abstract class IGKNonVisibleControllerBase extends IGKControllerBase
{
	public function getcanModify(){return false;}
	public function getcanDelete(){return false;}
	protected function initTargetNode(){return null;}
	public function getIsVisible(){return false;}
	public function View(){
		//do nothing
	}
	public function getCanAddChild(){return false;}
}

abstract class IGKCachableViewCtrl extends IGKControllerBase
{
	public function getisCachable(){
		return true;
	}
	public function View(){
		if ($this->isCachable)
		{
			if (!igk_getctrl("cache")->loadCache($this->Name))
			{
				parent::View();
				igk_getctrl("cache")->storeCache($this->Name, $this->TargetNode->Render());
			}
		}
		else{
			parent::View();
		}
	}
}
///<summary>Represent controller type</summary>
///<remark>
/// controller type is the base class of all personnalisable atomic controller. if you want to create a multiple
/// inheritance controller . use IGKCtrlNonAtomicTypeBase that extends IGKCtrlTypeBase
///</remark>
abstract class IGKCtrlTypeBase extends IGKControllerBase
{
	//return the system controller type category
	public static function GetCtrlCategory(){
		return "DEFAULT";
	}
	//must have a static method that return a info
	public static function GetAdditionalConfigInfo()
	{
		return null;
	}
	//set addition info
	public static function SetAdditionalConfigInfo(& $t)
	{
		return 1;
	}
	///<summary>get de default string content</summary>
	public static function GetAdditionalDefaultViewContent(){//default view
		return  "<?php\n \$this->TargetNode->ClearChilds();\n igk_add_article(\$this , \"default\", \$this->TargetNode); \n?>";
	}
	public function __construct(){
		parent::__construct();
	}
}
///<summary>used for multiple instance</summary>
abstract class IGKCtrlNonAtomicTypeBase extends IGKCtrlTypeBase
{

}
///represent a base class for a tool
abstract class IGKToolCtrlBase extends IGKControllerBase
{
	public function refreshToolView(){
		igk_getctrl("igktoolsctrl")->View();
	}
	//<summary>get if this controller is a system controller</summary>
	public function getIsSystemController(){
		return true;
	}
	public function getImageUri(){ return IGK_STR_EMPTY;
	}
	protected function InitComplete()
	{
		parent::InitComplete();
		igk_getctrl("IGKToolsCtrl")->RegisterTool($this);
	}

	public function getCanInitDb(){
		return false;
	}
	public function View(){
	}
	public function doAction(){
		//configure and do action
	}
	public function showTool($ownernode)
	{
		igk_html_add( $this->TargetNode, $ownernode);
		$t = $this->TargetNode;
		$t["class"]= "dispib alignc alignt";
		$t["style"]= "min-width: 96px; min-height:72px;";
		$t->ClearChilds();
		$d = $t->addDiv();
		$a = $d->add("a", array("class"=>"alignc dispib", "href"=>$this->getUri("doAction")));
		$a->add("img", array("style"=>"width: 48px; height:48px;display:inline-block;", "src"=>$this->getImageUri()));
		$a->addDiv()->Content = R::ngets("tool.".$this->Name);

	}
	public function hideTool($ownernode)
	{
		igk_wln("hidde ".$ownernode);
		igk_html_rm($this->TargetNode);
		$t = $this->TargetNode;
		$t->ClearChilds();

	}
}


//-----------------------------------------------------------------------------
//used as base configurable controller class
//-----------------------------------------------------------------------------
abstract class IGKConfigCtrlBase extends IGKControllerBase
implements IIGKConfigController
{


	public function  getConfigNode(){ return $this->getConfigCtrl()->getConfigNode(); }
	protected function getGlobalHelpArticle(){
		return "./help/help.".$this->Name;
	}
	public function getConfigCtrl(){return igk_getctrl(IGK_CONF_CTRL, true);}
	public function getConfigPage(){return "default"; }
	public function initConfigMenu(){//IGKConfigCtrlBase init config menu.
		$c = $this->ConfigPage;
		$error_msg = "No config menu found for : ".$c . " = ".$this->Name. " : ".get_class($this) . " ".$this->getDeclaredFileName();
		$conf = igk_get_configs_menu_settings(); 
		if (isset($conf->$c))
		{
			$cp = $conf->$c;
			if ($cp){
			return array(
				new IGKMenuItem(
					$cp->menuname,
					$cp->pagename,
					$this->getUri("showConfig"),
					$cp->menuindex,
					$cp->imagekey,
					null,	
					$cp->group
					));
			}
			else{
				igk_ilog($error_msg, __METHOD__);
			}
		}
		else{
			igk_ilog($error_msg, __METHOD__);
		}
		return null;
	}

	public function IsFunctionExposed($funcName){//for base config controller exposed functions
		return igk_is_conf_connected();
	}

	protected function InitComplete(){
			parent::InitComplete();
			$ctrl = $this->getConfigCtrl();
			$ctrl->registerConfig($this);
	}
	public function __construct(){
		parent::__construct();
	}
	///<summary>base show Configuration of the controller</summary>
	public function showConfig(){//BASE::showConfig
		$this->ConfigNode->Clear();
		$this->ConfigCtrl->setSelectedConfigCtrl($this, $this->Name."::showConfig");

		$this->View();
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
		}
		else{
			igk_html_add($this->TargetNode, $this->ConfigNode);
			igk_set_env("sys://config/selectedview", $this);
		}
	}

	protected function addTitle($node, $title){
		$d = $node->addDiv();
		$d["class"] ="igk-cnf-title";
		$d->Content = R::ngets($title);
	}
	public function getIsVisible(){
		$v = ( ($this->App->CurrentPageFolder == IGK_CONFIG_MODE)&& ($this->ConfigCtrl!=null) &&( $this->ConfigCtrl->SelectedConfigCtrl== $this) &&($this->ConfigCtrl->IsConnected));
		return $v;
	}


}


///<summary>base api</summary>
final class IGKApi extends IGKNonVisibleControllerBase{
	public function getName(){ return IGK_SYS_API_CTRL; }
	public function invokeUri(){
		IGKApp::$DEBUG = igk_getr("DEBUG",false);
	}
	protected function initDb(){//do nothing
	}
}


final class IGKAdditionCtrlInfo extends IGKObject
{
	private $m_Type;
	private $m_DefaultValue;
	private $m_Values; //used when type == select

	///<summary>.ctr</summary>
	///<param name="type">type of the parameter. select|text|textarea|bool|radio</summary>
	///<param name="def">array of value in case of "select" or default value</summary>
	///<param name="def1">default value in case of type "select" </summary>
	public function __construct($type, $def, $def1=null)
	{
		$this->m_Type = $type;
		if (strtolower($type) == "select")
		{
			$this->m_Values = $def;
			$this->m_DefaultValue = $def1;
		}
		else{
			$this->m_DefaultValue = $def;
			$this->m_Values=null;
		}
	}
	public function getclType(){return $this->m_Type; }
	public function getclDefaultValue(){return $this->m_DefaultValue; }
	public function getclValues(){return $this->m_Values; }

	public function __toString(){
		return "IGKAdditionalCtrlInfo";
	}
}
//save session parameters
//<remarq> this is uses to free $_SESSION array value</remarq>
final class IGKSession extends IGKObject
implements IIGKParamHostService
{
	//private $m_igk;
	private $m_sessionParams;
	// private $m_User;
	// private $m_cref;
	//Events
	//private $m_initializeSessionEvent;//call just before global invoke uri function of the controll manager
	//private $m_updateSessionEvent; //update setting changed. call just before rendering default document
	//private $m_UserChangedEvent; //global user changed event

	const BASE_SESS_PARAM = 0x001;
	const SESS_CREF_KEY = (self::BASE_SESS_PARAM + 0x001);//sys://session/cref";
	const SESS_USER_KEY = (self::BASE_SESS_PARAM + 0x002);//"sys://session/user";
	const SESS_PAGEFOLDER_KEY = (self::BASE_SESS_PARAM + 0x003);//"sys://session/user";
	const IGK_REDIRECTION_SESS_PARAM = (self::BASE_SESS_PARAM + 0x004);//"sys://session/user";
	const IGK_DOMAINBASEDIR_SESS_PARAM = (self::BASE_SESS_PARAM + 0x005);//"sys://session/user";
	const IGK_INSTANCES_SESS_PARAM = (self::BASE_SESS_PARAM + 0x006);// store class instances on session;
	const SESS_GLOBAL_THEME = (self::BASE_SESS_PARAM + 0x007);
	const SESS_SESSION_EVENTS = (self::BASE_SESS_PARAM + 0x008);
	
	
	const SYSDB_CTRL = IGK_KEY_SYSDB_CTRL;

	public function getPageFolder(){
		return $this->getParam(self::SESS_PAGEFOLDER_KEY);
	}
	public function setPageFolder($value){
		$this->setParam(self::SESS_PAGEFOLDER_KEY, $value);
	}
	public function getDomainBaseDir(){
		return $this->getParam(self::IGK_DOMAINBASEDIR_SESS_PARAM);
	}
	public function setDomainBaseDir($v){
		$this->setParam(self::IGK_DOMAINBASEDIR_SESS_PARAM, $v);
	}
	private function prepareRedirectTask(){
		$g = igk_get_env("sys://session/redirecttask");
		if ($g)
			return $g;
		$g = $this->{"REDIREC_TASK"} ?? array();
		igk_get_env("sys://session/redirecttask", $g);
		return $g;
	}
	
	public function getEvents(){
		return $this->getParam(self::SESS_SESSION_EVENTS);
	}
	public function setEvents($value){
		$this->setParam(self::SESS_SESSION_EVENTS, $value);
		igk_wln("set fevent");
		igk_wln($value);
		session_destroy();
		igk_exit();
	}
	//
	//redirect task store parent that will be used in redirection context - the life time of a redirection value is only one time. 
	//
	public function getRedirectTask(){
		$i = null;
		$name =null;
		if (func_num_args()>0)
			$name = func_get_arg(0);
		$g = $this->prepareRedirectTask(); 
		if ($g){
			$i= (object)$g;
			if($name)
				return igk_getv($i, $name);
		}
		return $i;
	}
	public function setRedirectTask($name, $value){
		$g = $this->{"REDIREC_TASK"} ?? array();
		if ($value===null){
			unset($g[$name]);
		}else
			$g[$name] = $value;
		$this->{"REDIREC_TASK"} = $g;
	}
	
	
	public function getApp(){return igk_app();}// $this->m_igk;}
	public function getUser(){	return $this->getParam(self::SESS_USER_KEY);}
	public function setUser($user, $context){
		$u = $this->getUser();
		if (($context !== null) && ($context === igk_getctrl(IGK_USER_CTRL))){
			if ( $u !== $user){
				$this->setParam(self::SESS_USER_KEY, $user);
				$this->_onUserChanged();
			}
		}
		else
			igk_die("Operation not allowed ".__FUNCTION__);
	}
	public function getCRef(){
		$key = self::SESS_CREF_KEY;
		$cref = $this->getParam($key) ??
		(function(){
			$cref = igk_create_cref();
			$this->setParam(self::SESS_CREF_KEY, $cref);//this->getCRef());
			return $cref;
		})();
		return $cref; //this->m_cref;//->getValue();
	}

	public function getUserChangedEvent(){return $this->m_UserChangedEvent; }

	// event getter an setter
	// public function addUpdateSessionEvent($obj, $method){		$this->m_updateSessionEvent->add($obj, $method);	}
	// public function removeUpdateSessionEvent($obj, $method)	{		$this->m_updateSessionEvent->remove($obj, $method);	}

	public function addInitializeSessionEvent($obj, $method){
	//$this->m_initializeSessionEvent->add($obj, $method);
	}
	public function removeInitializeSessionEvent($obj, $method)	{
		//$this->m_initializeSessionEvent->remove($obj, $method);
	}

	public function addUserChangedEvent($obj , $method){
		//$this->m_UserChangedEvent->add($obj, $method);
	}

	public function __construct($App)
	{
		//$this->m_igk = $App;
		$this->m_sessionParams = array();
		//$this->m_initializeSessionEvent = new IGKEvents($this, "initializeSessionEvent");
		//$this->m_updateSessionEvent = new IGKEvents($this, "UpdateSessionEvent");
		//$this->m_UserChangedEvent = new IGKEvents($this, "UserChangedEvent");
		$this->getCRef();

		$this->PageFolder = IGK_HOME_PAGEFOLDER; //init page folder
	}
	private function _onUserChanged()
	{
		igk_invoke_session_event(__CLASS__."::UserChanged", array($this, null));
	}
	//unset a session key
	public function Clear($key)
	{
		if (isset($this->m_sessionParams[$key]))
			unset($this->m_sessionParams[$key]);
	}
	public function __get($key){
		if (method_exists($this, "get".$key) )
		{
			return call_user_func(array($this, "get".$key), null);
		}
		else if(isset($this->m_sessionParams[$key])){

			return $this->m_sessionParams[$key];
		}
		return null;
	}
	//<summary>failed safe</summary>
	public function __set($key, $value)
	{
		// if ($key=="Events"){
			// igk_ilog($key." for ? ");
			// igk_ilog($value === null);	
		// }
		
		if (!$this->_setIn($key, $value))
		{//set session parameter
			if ($value==null)
				unset(	$this->m_sessionParams[$key] );
			else
			$this->m_sessionParams[$key] = $value;
		}
	}
	public function __toString(){ return get_class($this)."[::IGKAppSessionStorage]"; }

	/// raise the session UpdateEVent
	public function update(){//invoke update session. before render the document
		$s = IGKSession::IGK_REDIRECTION_SESS_PARAM;
		$this->__set($s, null);
		if ($this->m_updateSessionEvent!=null)
			$this->m_updateSessionEvent->Call($this,null);
	}
	public function initalize($app){//raise the initialize event. allowing some ctrl to init them self before invoking uri
		if ($app == $this->m_igk){
			$this->m_initializeSessionEvent->Call($this,null);
		}
	}
	public function resetParam(){
		$this->m_sessionParams = array();
	}
	///<summary>set session param</summary>
	public function setParam($key, $value)	{
		if (empty($key))
			return;

		if (isset($this->m_sessionParams[$key]))
		{
			if ($value == null)
				unset($this->m_sessionParams[$key]);
			else
				$this->m_sessionParams[$key] = $value;
		}
		else{
			if ($value !=null)
			{
				$this->m_sessionParams[$key] = $value;
			}
		}
	}
	public function getParam($key, $default=null){	//session param	. is special and store data
		if (isset($this->m_sessionParams[$key]))
		{
			return $this->m_sessionParams[$key];
		}
		if (igk_is_callable($default)){
			$o  = $default();
			if ($o){
				$this->m_sessionParams[$key] = $o;
			}
			return $o;
		}
		return $default;
	}
	public function getParamKeys(){
		return array_keys($this->m_sessionParams);
	}
}

///<summary>store the session authorization</summary>
final class IGKAuthorization
{
	private $m_auth;
	//internal constructor
	public function __construct($igk){
	}
	private function loadAutorisation(){
		$this->m_auth = array();
	}
	public function __toString(){return "IGKAuthorization"; }
	public function __get($key){
		if  (igk_app()->User)
		{
			if (isset($this->m_auth[$key]))
			{
				return $this->m_auth[$key];
			}
		}
		return false;
	}
	public function __set($key, $value){ igk_die("variable : [". $key ."] Not allowed");}
	public function __sleep(){//autorisation
		if (empty($this->m_auth)){
			return array();
		}
		return array("\0".__CLASS__."\0m_auth");
	}
	public function IsEmpty(){
		return igk_count($this->m_auth) == 0;
	}
}

///<summary> System Controllers Managers. store list of different controller table  </summary>
final class IGKControllerManagerObject extends IGKObject
{
	private static $sm_instance;
	private $m_tbcontrollers;//all present controller
	private $m_tbviewcontrollers; //all controller registrated to view mecanism
	private $m_registeredCtrl; //all named registrated controller
	private $m_classReg;
	private $m_register;
	private $m_initEvent;
	
	// public function __sleep(){
		// return array();
	// }


	public function & getRegisters(){
		if ($this->m_register==null)
			$this->m_register = igk_createObj();//array();//[""]
		return $this->m_register;
	}
	public function getControllerFromClass($classname){
		if ($this->m_classReg== null)
			$this->m_classReg = array();

		if (isset($this->m_classReg[$classname]))
			return $this->m_classReg[$classname];

		foreach($this->m_tbcontrollers as $k=>$v)
		{
			if (get_class($v) == $classname){
				$this->m_classReg[$classname] = $v;
				return $v;
			}
		}

		return null;
	}
	public function initCtrl($ctrl, $new=false){
		$n = strtolower($ctrl->Name);
		if (!isset($this->m_tbcontrollers[$n]))
		{
			$this->$n = $ctrl;
			IGKControllerBase::RegisterInitComplete($ctrl);
		}
		$this->_onInitComplete();
		if ($new)
		$this->storeControllerLibCache();
		
	}
	///<summary>register controller for specific fonctionnality</summary>
	public function register($name, $ctrl){//register controller
		if (empty($name) || ($ctrl == null))
			return false;
		if(isset($this->m_registeredCtrl[$name]))
		{
			return false;
		}
		$this->m_registeredCtrl[$name] = $ctrl;
	}
	///<summary>get registerd global controller for specific fonctionnality</summary>
	public function getRegCtrl($name)
	{
		if(($this->m_registeredCtrl != null) && isset($this->m_registeredCtrl[$name]))
			return $this->m_registeredCtrl[$name];
		return null;
	}
	private function __construct(){
		$this->m_tbcontrollers = array();
		$this->m_registeredCtrl = array();
		$this->m_tbviewcontrollers = array();
		$this->m_initEvent = 0;
	}
	///<summary>raise init complete event</summary>
	private function _onInitComplete(){
		IGKControllerBase::InvokeRegisterComplete();
		$this->_initviewMecanism();

		// $c = igk_get_env("sys://controller/loaded");
		// igk_notification_push_event("sys://controller/loaded",$this);

		if (!$this->m_initEvent){
			$this->m_initEvent = 1;
			igk_notification_reg_event("sys://event/defaultpagechanged", array($this, "defaultpagechanged"));
		}
	}
	public function defaultpagechanged(){
		//igk_wln("ds page changed");
		$this->_initviewMecanism();
		//exit;
	}
	private function _initviewMecanism(){
		$this->m_tbviewcontrollers = array();
		$c = igk_get_defaultwebpagectrl();
		$tab = array_keys($this->m_tbcontrollers);
		foreach($tab as $k){
			$v = $this->m_tbcontrollers[$k];
			if ($v){
				if (igk_is_class_incomplete($v)){
					unset($this->m_tbcontrollers[$k]);
					continue;
				}
				$this->registerToViewMecanism($v);
			}
		}
		if ($c)
		$this->registerToViewMecanism($c);
	}
	///<summary>register controller to view mecanism
	public function registerToViewMecanism($ctrl){
		if ($ctrl && $ctrl->RegisterToViewMecanism){
				$this->m_tbviewcontrollers[$ctrl->Name] = $ctrl;
		}
	}
	public function unregisterToViewMecanism($ctrl){
		$s =  $ctrl->Name;
		if (isset($this->m_tbviewcontrollers[$s])){
			unset($this->m_tbviewcontrollers[$s]);
		}

	}
	///<summary>true if controller is a system controller otherwise false</summary>
	///<param name="controller">controller name or controller instance </param>
	///<note>for the plateform SystemController are controller stored in the Global Lib directory or in e </param>
	public static function IsSystemController($controller)
	{
		$instance = self::getInstance();
		if (is_string($controller))
		{
			$controller = strtolower($controller);
			$v = $instance->$controller;
			if ($v->getDeclaredFileName() == __FILE__)
				return true;
		}
		$cl = "";
		if (is_object($controller) && igk_reflection_class_extends($cl = get_class($controller),  IGK_CTRLBASECLASS))
		{
			//igk_ilog("check for ".$cl);
			$v = strstr($controller->getDeclaredFileName(), dirname(__FILE__)) ;
			//igk_ilog($v);

			$r  =  ($v) || $controller->getIsSystemController() || IGKControllerBase::IsSysController(get_class($controller));
			//igk_ilog($r);
			return $r;
		}
		return false;
	}
	public static function IsIncludedController($controller)
	{
		$instance = self::getInstance();
		$dir = null;
		if (is_string($controller))
		{
			$controller = strtolower($controller);
			$v = $instance->$controller;
			$dir = dirname($v->getDeclaredFileName());

		}
		else if (is_object($controller) && igk_reflection_class_extends(get_class($controller),  IGK_CTRLBASECLASS)){
			$dir = dirname($controller->getDeclaredFileName());
		}
		//
		//get parent folder
		//
		$o = igk_io_basePath(igk_io_currentRelativePath(IGK_INC_FOLDER));
		$dir = igk_io_basePath($dir);

		while( ($dir != '.') && (strlen($dir) > 0))
		{
			if ($dir === $o){
				return true;
			}
			$dir = dirname($dir);

		}
		return false;
	}

	///<summary>get the current instance manager</summary>
	public static function getInstance(){
		//igk_wln(__CLASS__."::".__FUNCTION__);

		if (self::$sm_instance===null)
		{
			$b = 0;
			//igk_log_write_i(__CLASS__."::".__FUNCTION__, "create new instance ....");
			self::$sm_instance = igk_get_class_instance(__CLASS__, function() use (&$b){
				//igk_log_write_i(__CLASS__."::".__FUNCTION__, "complete - instance ");
				 //can't be used from php 5_4
				 $o = new IGKControllerManagerObject();//call_user_func_array($func, array());
				 $b = 1;
				 return $o;

			});
			if ($b==1){//first used
				$apps = igk_app();
				$apps->setControllerManager(self::$sm_instance);
				//igk_set_env("sys://instance/controllermanager", self::$sm_instance);
				// igk_utest_wln("init controllers");
				self::$sm_instance->InitControllers($apps);
			}
		}
		return self::$sm_instance;
	}

	///<summary>clear cache for base dir</summary>
	public static function ClearCache($bdir=null){//remove all cached files

		$t = null;
		if ($bdir == null)
			$bdir = igk_io_baseDir(IGK_CACHE_FOLDER);

		$t = igk_io_getFiles($bdir);//igk_io_baseDir(IGK_CACHE_FOLDER));
		if ($t){
			foreach($t as $k=>$v)
			{
				if (basename($v) == ".htaccess")
					continue;
				unlink($v);
			}
		}

	}
	public function ClearCtrlCache(){//clear ctrl cache
		$fc = igk_io_currentRelativePath(IGK_FILE_CTRL_CACHE);
		if (file_exists($fc))
		{
			unlink($fc);
		}
	}
	private function _registerCtrl($ctrl, $regname=null){
		$n = $ctrl->Name;
		$this->$n = $ctrl;//add to controlller list
		if (!self::IsSystemController($ctrl)){
			//igk_utest_wln("not system controller ".$n);
			$s = $regname ?? $ctrl->Configs->clRegisterName;
			if (!empty($s)){
				$rg = $this->getRegisters();
				// igk_wln($rg);
				// igk_wln(isset($this->Registers->$s) && ($this->Registers->$s !=null));
				//e_xit;
				if (isset($this->Registers->$s) && ($this->Registers->$s !=null)) igk_die("you already register a controller with the name {$s} - please check configuration");

				$this->m_register->$s = $ctrl;

				//igk_log_write_i(__FUNCTION__, "add : ".$ctrl->Configs->clRegisterName);
		
			}
		
		}

	}
	private function storeControllerLibCache(){
		// igk_wln("store config");
		$fc = igk_io_baseDir(IGK_FILE_CTRL_CACHE);
		// igk_wln("fc : ".$fc);
		if (empty($fc)) return;		
		@unlink($fc);		
		$m = " ";		
		foreach($this->m_register as $k=>$v){
			
			$m .= $k."|".igk_getv($v->Configs, "clRegisterName")."\n";
		}
		igk_io_w2file($fc, $m, true);
	}
	///<summary>init all controller</summary>
	private function InitControllers($apps=null){
		//return;
		if (igk_is_atomic())
			return;
		//Init Controllers
		$fc = igk_io_baseDir(IGK_FILE_CTRL_CACHE);
		if (empty($fc))
			return;
		if (!defined("IGK_NO_CACHE_LIB") && file_exists($fc)){			
			foreach(explode("\n", igk_io_read_allfile($fc)) as $k){
			
				$g = trim($k);
				if (empty($g))continue;
				list($n,$rn) =  explode("|", $g);
					
				$v_ctrl = new $n();
				$this->_registerCtrl($v_ctrl , empty($rn)? null: $rn);
				IGKControllerBase::RegisterInitComplete($v_ctrl);
			}
		}else{
		
		// igk_utest_wln("test : $fc");
		$l = false;
		//igk_log_write_i(__METHOD__, "init");
		$sfc = "GetCanCreateFrameworkInstance";
		$tempty = array();

			if ( !defined("IGK_FRAMEWORK_ATOMIC")  && file_exists($fc))
			{

				$txt = IGKIO::ReadAllText($fc);
				if (strlen(trim($txt)) > 0)
				{
					$s = explode("\n", $txt);
					foreach($s as $k=>$v){
						if (empty($v) || !class_exists($v)){
							continue;
						}


						$t = new $v();
						$this->_registerCtrl($t);
						IGKControllerBase::RegisterInitComplete($t);
					}
					$l = true;
				}
			}
			if (!$l){
				$m = "";
				foreach(get_declared_classes() as $k=>$v)
				{
					if (igk_reflection_class_extends($v, IGK_CTRLNONATOMICTYPEBASECLASS))
					{
						continue;
					}
					if (igk_reflection_class_extends($v, IGK_CTRLBASECLASS) && igk_ctrl_isactive($v))
					{
						$v_rc = new ReflectionClass($v);
						if ($v_rc->isAbstract() || (method_exists($v,$sfc) && !call_user_func_array(array($v,$sfc), $tempty)))
							continue;
						$t = new $v();
						$this->_registerCtrl($t);
						IGKControllerBase::RegisterInitComplete($t);
						$m .= $v."|".igk_getv($t->Configs, "clRegisterName")."\n";
					}
				}
				//store controller cache
				if (!defined("IGK_FRAMEWORK_ATOMIC"))
					igk_io_w2file($fc, $m, true);
			}
		}
		if ($apps){
			$apps->initControllerComplete();
		}
		//call init complete on all controller
		$this->_onInitComplete();
		igk_invoke_session_event("sys://init_controller_complete", $this, null);
	}

	//</summary>call View method for all controllers that don't have a parent web controller. and are registrated as viewable controller </summary>
	public function ViewControllers($forceview=0){
		$u = igk_io_baseRequestUri();
		if ($forceview || (!igk_sys_is_subdomain()) && (empty($u) || $u=="/") ){
			$ctrls = self::getInstance()->m_tbviewcontrollers;
			if ($ctrls){
				foreach($ctrls as $k){
					if (($k->getWebParentCtrl() !== null) ||(igk_own_view_ctrl($k))){
						//system will call the view or rendering engine
						continue;
					}
					//call view for :
					//igk_wln("callview for :  ".$k->Name . " ? ".$k->isVisible);
					$k->View();
				}
			}
		}
	}
	public function __toString(){
		return "Controllers [#".count($this->m_tbcontrollers)."]";
	}
	public function __get($key){
		$key = strtolower($key);
		$c = igk_getv($this->m_tbcontrollers, $key);
		if ($c)
		{			
			//check that controller is not imcomplete
			if (igk_is_class_incomplete($c)){
				unset($this->m_tbcontrollers[$key]);
				return null;
			}			
			return $c;
		}
		return null;
	}
	public function __set($key, $value)
	{
		$key = strtolower($key);
		if ($value===null)
		{
			if (isset($this->m_tbcontrollers[$key]))
				unset($this->m_tbcontrollers[$key]);
				return;
		}
		else
		{
			if (is_object($value) && igk_reflection_class_extends( get_class($value),IGK_CTRLBASECLASS))
			{
				$this->m_tbcontrollers[$key] = $value;
			}
		}
	}
	public function Count() {return count($this->m_tbcontrollers);}
	public function & getControllers(){return $this->m_tbcontrollers;}

	public function dropController($ctrl){

		//igk_wln(igk_count($this->m_registeredCtrl));
		//igk_exit();
		if (!$ctrl)
			return false;
		$k = strtolower($ctrl->Name);
		$d = dirname($ctrl->getDeclaredFileName());
		//call drop controller Message function of the controller
		$ctrl->dropController(); // method before delete file
		$r = false;
		if (is_dir($d))
		{
			$r= IGKIO::RmDir($d , true);
			//move to sandbox dir
		}
		unset($this->m_tbcontrollers[$k]);
		IGKControllerBase::UnRegisterInitComplete($ctrl);
		igk_notification_push_event(IGK_EVENT_DROP_CTRL, array($ctrl));
		return true;
	}
	//@remove controller by name
	public function dropControllerByName($name)
	{
		$k = strtolower($name);
		if (isset($this->m_tbcontrollers[$k]))
		{
			$ctrl = $this->m_tbcontrollers[$k];
			return $this->dropController($ctrl);
		}
		return false;
	}

	///<summary>reload controller table list</summary>
	public function reloadModules($tab, $redirect, $initCtrl=1){//reload controller
		igk_set_env("sys://reloadingCtrl", 1);
		$dir  = igk_io_baseDir("/".IGK_PROJECTS_FOLDER);

		$g = $this->m_tbcontrollers;
		// $cond = igk_get_env("reloading");
		// igk_wln_assert(	$cond ,"<div style='background-color: #444; color:white; overflow: auto; height: 300px'>");
		// igk_wln_assert(	$cond , "create g  : >>>> ".igk_count($g));
		// igk_wln_assert(	$cond , igk_ob_get(array_keys($g)));
		if($initCtrl){
			$this->m_tbcontrollers = array(); //reloading controlller
			$this->m_tbviewcontrollers = array();
		}


		igk_loadcontroller($dir);
		$classes = get_declared_classes();

		foreach($classes as $k=>$v)
		{

			if( isset($tab[$v]))
			{
				$n = $tab[$v];
				if (isset($this->m_tbcontrollers[$n])){
					igk_die($n ." must not exists in controller tab");
				}
				//igk_ilog_assert(igk_get_env("reloading"), "reloading : >>>> ".$v." ? ".isset($tab[$v]));
				continue;
			}
			if (igk_reflection_class_extends($v, IGK_CTRLNONATOMICTYPEBASECLASS))
			{
				continue;
			}
			if ( is_subclass_of($v, IGK_CTRLBASECLASS) && igk_ctrl_isactive($v))
			{


				$v_rc = new ReflectionClass($v);
				if ($v_rc->isAbstract())
					continue;
				$t = new $v();
				$n = strtolower($t->Name);
				if (!isset($this->m_tbcontrollers[$n]))
				{
					igk_ilog_assert(igk_is_debug(), "register create new  : >>>> ".$v." ? ".isset($tab[$v]));
					$this->$n = $t;
					IGKControllerBase::RegisterInitComplete($t);
				}
				else{
					unset($t);
				}
			}
		}

		// $s ="Registerled C: ". IGKControllerBase::RegisterInitComplete(null);
		// $s.=" folder exists ? ".is_dir(igk_io_baseDir()."/Mods/mm_o");
		// igk_wln_assert(	$cond , "</div>");
		// igk_die($s);

		//raise on init complete
		$this->_onInitComplete();
		igk_notification_push_event("sys://notify/ctrl/reload", $this);
		igk_set_env("sys://reloadingCtrl", null);
		if ($redirect){
			igk_navtocurrent();
		}

	}

	///return the user controller list.
	///there is 2 controller type . framework controller and user controllers
	public function getUserControllers($callbackfilter=null)
	{
		$tab = $this->getControllers();
		$out = array();
		if (count($tab) > 0)
		{
			$tab_k = array_keys($tab);
			igk_usort($tab_k, "igk_key_sort");
			foreach($tab_k as $k)
			{
				$v = $tab[$k];
				if (get_class($v) ==='__PHP_Incomplete_Class') //sometime incomplete class reach must be removed from controller list
				{
					unset($tab[$k]);
					continue;
				}
				
				if (IGKControllerManagerObject::IsSystemController($v) || IGKControllerManagerObject::IsIncludedController($v) || !$v->canModify)
					continue;
				if ($callbackfilter && !$callbackfilter($v))
					continue;
				$out[] = $v;

			}
		}
		return $out;
	}

	private function _sort_byConfigNodeIndex($a, $b)
	{
		if ($a->Configs->clTargetNodeIndex && $b->Configs->clTargetNodeIndex)
		{
			$i = $a->Configs->clTargetNodeIndex;
			$j = $b->Configs->clTargetNodeIndex;
			return ($i == $j)? 0: (($i<$j) ? -1 : 1);
		}
		return strcmp($a->Name, $b->Name);
	}
	private function renderController($s, $v, $fname, $fsize, $x, $y, $cl, $indexpos= 0)
	{
		$t = $s->DrawString($v->Name, $fname, $fsize, $x, $y , $cl);

		//$s->DrawRectangle($cl, $t);

		$s->DrawString($v->Configs->clTargetNodeIndex, $fname, $fsize, $indexpos, $y , $cl);

		if ($v->Childs){
			$y+= $t->height;
			$tab = $v->Childs;
			usort($tab, array($this, "_sort_byConfigNodeIndex"));
			$i = igk_count($tab);
			foreach($tab as $k=>$m)
			{
				$i--;
				$tt = $this->renderController($s, $m, $fname, $fsize, $x + 50, $y, $cl, $indexpos);

				$t->height += $tt->height;
				$t->width = max($tt->width + 50, $t->width);
				$y+= $tt->height;
			}
		}
		return $t;
	}
	private  function _cm_measure($s , $tab, $fname, $fsize, $x, $y ,$cl)
	{
		$rc = (object)array(
		"x"=>0,
		"y"=>0,
		"width"=>0,
		"height"=>0);

		if (is_array($tab))
		{

			foreach($tab as $k=>$v)
			{
				if ($v->WebParentCtrl == null)
				{
					$t = $this->_cm_measure($s, $v, $fname, $fsize, $x, $y ,$cl);

					$rc->height += $t->height;
					$rc->width  = max($rc->width, $t->x + $t->width);
				}
			}
		}
		else{
			return $this->renderController($s, $tab, $fname, $fsize, $x, $y, $cl);
		}
		return $rc;
	}
	public function cm_controllerschema()
	{
		//retreive all controller scheam
		if (!defined("IGK_GD_SUPPORT"))
		{
			igk_exit();
		}


		$y = 14;
		$x = 0;
		$fname = igk_io_currentRelativePath(igk_get_uvar("CONFIG_SCHEMA_FONT"));
		if (!file_exists($fname))
		{
			igk_exit();
		}
		$fsize = 14;
		$cl = IGKColor::FromFloat(1.0);

		$tb = $this->getUserControllers();

		$s = IGKGD::Create(32,32);

		$rect =  $this->_cm_measure($s, $tb, $fname, $fsize, $x, $y ,$cl);

		$s->Dispose();
		if (($rect->width<=0) || ($rect->height<=0))
			igk_exit();
		$x =40;
		$y =28;

		$s = IGKGD::Create($rect->width  +300+ (2*$x), $rect->height + ($y));

		//$s = IGKGD::Create(500,600);
		$s->Clear($cl);
		if (file_exists($fname))
		{
				foreach($tb as $k=>$v)
				{

					if ($v->WebParentCtrl == null)
					{
						$t = $this->renderController($s, $v, $fname, $fsize, $x, $y, IGKColor::Black() , $rect->width+150);
						$y += $t->height;
					}
				}
		}
		header("Content-type: image/png");
		$s->Render();
		$s->Dispose();
		unset($s);
		igk_exit();

	}
	public function InvokeNavUri($uri)
	{
		$args = igk_getquery_args($uri);
		$c =str_replace("-","_", igk_getv($args,"c"));
		$f =str_replace("-","_", igk_getv($args,"f"));
		$p = igk_getv($args,"p");
		$l = igk_getv($args,"l");
		if ($p){  igk_getctrl(IGK_MENU_CTRL)->setPage($p, igk_getv($args, "pageindex",0)); }
		if ($l){  R::ChangeLang(igk_getv($args, "l"));}

		$bck = $_REQUEST;
		$arg = igk_io_arg_from($f);

		$_REQUEST = array_merge($bck,  $args);

		if ($c && $f)
		{
			//check for requirement before call thme
			$ctrl  = $this->$c;
			if (($ctrl) && method_exists(get_class($ctrl), $f) && $ctrl->IsFunctionExposed($f))
			{
				if (is_array($arg))
					call_user_func_array(array($this->$c, $f), $arg);
				else{
					if ($arg)
						$ctrl->$f($arg);
					else
						$ctrl->$f();
				}
			}
		}
		$_REQUEST = $bck;

	}
	// private static function GetArgFrom($f)
	// {
		// $arg = null;
		// if (strstr($f, "/"))
		// {
			// $a = explode("/", $f);
			// $f = $a[0];
			// $b = array_slice($a, 1);
			// if (igk_count($b) == 1)
			// {
				// $arg = $b[0];
			// }
			// else
				// $arg = $b;
		// }
		// return $arg;
	// }
	public function InvokePattern($pattern){
		return $this->InvokeUri($pattern->value, 1 , $pattern);
	}
	///<summary>use to invoke system controller method</summary>
	///<return>the selected uri</return>
    public function InvokeUri($uri=null, $defaultBehaviour=true, $pattern=null)
	{
	
		// handle system uri
		// igk_ilog("invoke uri", __METHOD__);
		igk_sys_handle_uri();

		$c = null;
		$f = null;
		$args =null;
		$igk = igk_app();
		$igk->Session->URI_AJX_CONTEXT = 0;
		if ($uri == null)
		{
			//update query for system
			if ( ($p = igk_getr("p",null))!=null){
				//change the current page;
				if (igk_sys_is_page($p))
				{
					$igk->CurrentPage = $p;
				}
			}
			if (igk_getr("l",null)!=null){ R::ChangeLang(igk_getr("l"));}
			if (igk_getr("history",0)==1){ igk_debug_wln("notice:form history"); }
			//
			//call for controller function
			//
			$c = igk_getru("c",null);
			$f = igk_getru("f", "invokeUri");

		}
		else{			
			$args = igk_getquery_args($uri);
			$c =str_replace("-","_", igk_getv($args,"c"));
			$f =str_replace("-","_", igk_getv($args,"f"));
			$p = igk_getv($args,"p");
			$l = igk_getv($args,"l");
			if ($p){  igk_getctrl(IGK_MENU_CTRL)->setPage($p, igk_getv($args, "pageindex",0)); unset($args["p"]);}
			if ($l){  R::ChangeLang(igk_getv($args, "l")); unset($args["l"]);}
		}
		$arg = igk_io_arg_from($f);		

		if ($c && $f)
		{
			// igk_wln("f :".$f);
			// igk_wln("c :".$c);
			// igk_wln("uri :".$uri);
			//check for requirement before call the method
			$ctrl  = $this->$c ?? ($pattern? $pattern->ctrl : null) ?? igk_template_create_ctrl($c);
			if (!$ctrl){
				//igk_wln("/!\\ pattern controller not found no controller found ");
				//igk_wln("///V ".igk_template_create_ctrl($c));
				return null;
			}
			//igk_set_env("sys://ctrl/current__invoke_ctrl", null);


			if (!method_exists(get_class($ctrl), $f))
			{
				header("Status: 404");
				//igk_wln();
				igk_ilog("function :::: ".$f);
				igk_show_error_doc(null, 4046, null, "method not exists --- [".get_class($ctrl)."::".$f."] ".$uri);
				igk_exit();
				return false;
			}

			//setup the base current uri
			if ($f == IGK_EVALUATE_URI_FUNC ){
				igk_app()->setBaseCurrentCtrl($ctrl);
			}
			//method exists
			if (($f == IGK_EVALUATE_URI_FUNC ) || $ctrl->IsFunctionExposed($f)){

				$ctrl->App->Session->URI_AJX_CONTEXT = igk_is_ajx_demand() || IGKString::EndWith($f, IGK_AJX_METHOD_SUFFIX) || (igk_getr("ajx") == 1);
				$fd=null;
				if (($fd = $ctrl->getConstantFile()) && file_exists($fd)) include_once($fd);
				if (($fd = $ctrl->getDbConstantFile()) && file_exists($fd)) include_once($fd);
				unset($fd);
				igk_set_env(IGK_ENV_REQUEST_METHOD, strtolower(get_class($ctrl)."::".$f));
				igk_set_env(IGK_ENV_INVOKE_ARGS, $args);
				if (is_array($arg))
					call_user_func_array(array($ctrl, $f), $arg);
				else{
					if ($arg)
						$ctrl->$f($arg);
					else{
						$ctrl->$f();
					}
				}
				igk_set_env(IGK_ENV_INVOKE_ARGS, null);
				igk_set_env(IGK_ENV_REQUEST_METHOD, null);
				if($defaultBehaviour && $this->$c->App->Session->URI_AJX_CONTEXT)
				{
					igk_exit();
				}
			}
			else{
				$msg = "InvokeUri failed for [".$c."::".$f."] you don't have access to this method.";
				igk_notifyctrl()->addWarning($msg);
				if (!igk_sys_env_production())
				igk_ilog("no access to method ".get_class($ctrl)."::".$f. " . you must have authorisation");
			}
		}
		return $c;

	}
	/// used to invoke function and return response. main used in igk_api
	public function InvokeFunctionUri($uri=null)
	{
		$c = null;
		$f = null;
		if ($uri == null)
		{
			//
			//call for controller function
			//
			$c = igk_getru("c",null);
			$f = igk_getru("f", null);
		}
		else{
			$args = igk_getquery_args($uri);
			$c =str_replace("-","_", igk_getv($args,"c"));
			$f =str_replace("-","_", igk_getv($args,"f"));
		}
		if ($c && $f)
		{
			//check for requirement before call thme
			if ($this->$c &&  $this->$c->IsFunctionExposed($f))
			{
				$this->$c->App->Session->URI_AJX_CONTEXT = IGKString::EndWith($f, IGK_AJX_METHOD_SUFFIX) || (igk_getr("ajx") == 1);
				return $this->$c->$f();
			}
		}
		return null;
	}
	public static function InitStatic(){
		igk_reg_class_instance_key(__CLASS__, 0xc1);
	}
}



IGKControllerManagerObject::InitStatic();
//--------------------------------------------------------------------
//initialize
//--------------------------------------------------------------------
final class IGKSessionIdValue
extends IGKObject
implements IIGKHtmlGetValue
{
	var $i ;
	public function getValue($options=null){//session get value
	if ($this->i)
			$this->i++; else $this->i = 1;
		$s = "Session ID[" .$this->i." ]: " . session_id ();
		return $s;
	}
}


///basics controller
///<summary>Session controller. used to manage administraive session info.</summary>
final class IGKSessionController extends IGKControllerBase
{
	private $m_debugginchanged;
	public function getName(){return IGK_SESSION_CTRL;}
	///<summary>determine if this controller need to register to view mecanism</summary>
	public function getRegisterToViewMecanism(){return true; } //session register to view mecanism
	public function getConfigCtrl(){
		return igk_getconfigwebpagectrl();
	}
	protected function InitComplete(){
		parent::InitComplete();
		//disable session tool for print
		$app = igk_app();		
		$app->Doc->SysTheme->PrintMedia[".".IGK_SESSION_CTRL] = "display:none;";
		
		
		$conf = igk_getconfigwebpagectrl() ?? igk_die("no admin configuration controller found");
		$conf->addConfigSettingChangedEvent($this, "configPropertyChanged");
		$conf->addConfigUserChangedEvent($this, "ConfUserChanged");
		// igk_getctrl(IGK_CHANGE_MAN_CTRL)->addLoadConfigEvent($this, "changeLoaded");
		//IGKAppConfig::getInstance()->addConfigSavedEvent($this, "update_setting"


		//init user from cookie tokenid

		$n =igk_get_cookie_name( igk_sys_domain_name()."/uid");
		$rs = igk_getv($_COOKIE, $n);
		if (!empty($rs) ){
			$uid = igk_getv(explode(':', $rs), 0);
			$v = igk_user_info(IGK_UINFO_TOKENID, $uid);
			$d = substr($rs, strlen($uid)+1);
			if ($v && ($v->clValue == $d) ){
				$r = igk_get_user($uid);//$this->Db->select(IGK_TB_USERS, array("clLogin"=>IGK_USER_LOGIN))->getRowAtIndex(0);
				if ($r){
					igk_getctrl(IGK_USER_CTRL)->setUser($r);
					igk_user_store_tokenid($r);

				}
			}
		}
		
		// igk_reg_session_event(IGK_ENV_NEW_DOC_CREATED, array($this, "onSessionNewDocCreated"));
		
		// igk_notification_reg_event(IGK_FORCEVIEW_EVENT, array($this, "notify_forceview"));
		//register this control Handle it's View call
		IGKOwnViewCtrl::RegViewCtrl($this, 0);
		$this->View();
	}
	public function notify_forceview(){
		R::LoadLang();
		$this->View();
	}
	
	public function onHandleSystemEvent($msg){		
		switch($msg){
			case IGK_ENV_NEW_DOC_CREATED:
				$args = array_slice(func_get_args(), 1);
				$this->onSessionNewDocCreated($args[0],$args[1]);				
			break;
		}
	}
	
	
	private function onSessionNewDocCreated($o,$e){
	


		if ($e && !igk_const_defined('IGK_NO_SESSION_BUTTON') )
		{			
			$this->_viewTarget();
			//append a clone done
			$n = igk_html_node_CloneNode($this->TargetNode);
			$n->setCallBack("getIsVisible", array($this, "getIsVisible"));
			//add a cloned node to new created document if visible
			igk_html_add($n, $e->body);
		}
	}
	public function update_setting(){
		$this->View();
	}

	protected function initTargetNode(){
		return new IGKHtmlSessionBlockNode("div", $this);
	}


	public function ClearAllS(){
		igk_kill_all_sessions();
// igk_referer
		// igk_navto(igk_io_baseUri());
		$l = igk_sys_srv_referer();
		if (empty($l))
			$l = igk_io_baseUri();
		igk_navto($l);
	}

	private function _viewTarget(){ // init target node

			$this->TargetNode->ClearChilds();
		// igk_wln("view target");
		// igk_io_append_to_file("d://temp/out.html", igk_show_trace());
		// $this->TargetNode->addDiv()->Content = (igk_show_trace());
			$this->TargetNode->setIndex(10000);//push at the end of the body document
			$this->TargetNode["class"]="+igk-debug-info +igk-js-hide";

			$d = $this->TargetNode->add("div");
			$d->Content = R::ngets("title.DEBUGINFO");
			$d["class"]= "debug_option_title igk-title-4 igk-default";
			$ul = $this->TargetNode->add("ul");
			//register a color name

			$ul->addLi()->Content = "Referrer : " . igk_getv($_SERVER, "REMOTE_ADDR");
			$ul = $this->TargetNode->add("ul");
			$ul["class"]="btn-group";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>igk_io_baseUri().$this->getUri("forceview")))
			->Content = "ForceView";
			$a = $ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->addAClearSAndReload();


			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>$this->getUri("ClearAllS")))->setContent("ClearAllSession");

			if ($this->ConfigCtrl->IsConnected){
				$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a",array("href"=>igk_getconfigwebpagectrl()->getUri("reconnect")))->Content = "Re-connect";
			}
			$this->TargetNode->addBr();
			$ul = $this->TargetNode->add("ul");
			$ul["class"]="btn-group";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>$this->getConfigCtrl()->getUri('logout')))->Content = "Logout";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>new IGKHtmlRelativeUriValueAttribute("Configs")))->Content = "Configs";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->addAJXA($this->getConfigCtrl()->getUri('preview_result_ajx'))->Content = "PreviewResult";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>new IGKHtmlRelativeUriValueAttribute("index.php")))->Content = "Index";

			$this->TargetNode->addNodeCallback("memoryinfo", function(){
				return new IGKHtmlMemoryUsageInfoNodeItem();
			});
			$this->TargetNode->addScript()->Content  = "if (window.igk && window.igk.ctrl.sessionblock)window.igk.ctrl.sessionblock.init();";
	}

	public function View(){
		//view for primary document
		if ( $this->IsVisible )
		{	//register to global document view
			igk_html_add($this->TargetNode, $this->doc->body);
			$this->_viewTarget();
		}
		else{
			igk_html_rm($this->TargetNode);
		}
	}
	public function getIsVisible(){

		if(igk_get_env("sys://error"))
			return 0;

		return !igk_const_defined('IGK_NO_SESSION_BUTTON') && ( IGKServerInfo::IsLocal() ||
		(!IGKUserAgent::isMobileDevice()
		&& igk_is_conf_connected()
		&& igk_getv($this->App->Configs,"allow_debugging", false)));
	}
	public function ConfUserChanged(){
		$this->View();
	}
	//<summary>primary</summary>
	public function PageChanged(){
		$this->View();
	}
	public function ClearS($navigate = true){
//TODO CLEAR SESSION
		session_destroy();
		session_write_close();
		$_SESSION = array();
		if ($navigate)
		{
			$buri = 0;
			$s = igk_io_request_uri();
			if ($s && IGKString::EndWith($s, "/clr"))
			{
				$_SERVER["REQUEST_URI"] = igk_str_rm_last($s , "/clr");
				$buri=1;
			}

			$m = igk_getr("r");
			if ($m){
				$m = base64_decode($m);
				igk_navto($m);
				igk_exit();
			}
			$u = igk_sys_srv_referer();
			if (!empty($u)){
				igk_navto_referer();
			}
			igk_navtobaseuri();


			// ..igk_nav_session();
		}
		// igk_wln("not navigate ".$navigate);
		// exit;
	}
	public function RunCron(){
		// if (!igk_is_conf_connected()){
			// igk_navto_home(null);
			// igk_exit();
		// }
		$c = igk_getr("ctrl");
		if ($c){
			$c = igk_getctrl($c);
			IGKControllerBase::RunCrons($c);
			igk_exit();
		}

		// $u = igk_io_baseUri()."/test_cron_1";
		// $u2 = igk_io_baseUri()."/test_cron_2";
		$tab = array();//$u, $u2);
		$server = igk_getv($_SERVER, "HTTP_USER_AGENT");
		$sessid = igk_getv($_COOKIE, 'PHPSESSID', session_id());


		$strCookie = 'PHPSESSID=' .$sessid.'; path='.igk_get_cookie_path();

		//igk_wln($strCookie . igk_getctrl("baobabtv"));
		$f = igk_data_get_cron_file();
		if (file_exists($f))
			$tab = igk_json_parse(igk_io_read_allfile($f));
		else
			$tab[] = igk_io_baseUri().$this->getUri("RunCron&ctrl=baobabtv");

		// igk_wln($tab);
		//e_xit;
		$doc = igk_get_document(__METHOD__);
		session_write_close();

		IGKOb::Start();
		// igk_exit();
		foreach($tab as $k=>$v){
			if (!IGKValidator::IsUri($v) || ($v[0]=="?")){
				$v = igk_io_baseUri().$v;
			}
			//igk_wln("run cron ..... ".$v);
		//$u = "http://127.0.0.1";
			$r = curl_init();
			if ($r){
				// igk_wln($v);
				// igk_flush_data("multi init");
				curl_setopt($r, CURLOPT_URL, $v);
				curl_setopt($r, CURLOPT_SSL_VERIFYPEER, false);
				curl_setopt($r, CURLOPT_SSL_VERIFYHOST, false);
				curl_setopt($r,CURLOPT_USERAGENT, $server);
				curl_setopt($r, CURLOPT_COOKIE, $strCookie );
				//igk_wln("init ".$u);
				$data =curl_exec($r);
				//igk_wln("data : {$data}");
				curl_close($r);
			}
		}
		$d = IGKOb::Content();
		IGKOb::Clear();
		$doc->body->addBodyBox()->addDiv()->Content = $d;
		$doc->RenderAJX();
		$doc->Dispose();
		igk_exit();
	}

	public function invmodule(){ //invoke module
		$q = igk_getr("q");
		$g = array();
		parse_str(igk_getv(parse_url("?".base64_decode($q)),'query'), $g);
		$modn = $g["n"];
		$mod = igk_init_module(str_replace(".","/", $modn));//get_module($g["n"]);
		$access = $g["q"];
		$listener = igk_getctrl($g["ctrl"]);
		if($mod){
			$mod->Listener = $listener;
			$tab = igk_str_array_rm_empty( explode('/',$access));
			call_user_func_array(array($mod, $tab[0]), array_slice($tab, 1));
		}else{
			igk_wln("/!\\ module {$modn} not found : ".igk_io_request_uri());
			igk_wln($g);
		}
		igk_exit();
	}


	///<summary>call system force view on session controller</summary>
	public function forceview(){
		// $this->App->Doc->body->addBodyBox()->ClearChilds();
		// set environment to inform that we forced the view so . view to controller will not be called twice
		igk_set_env(IGK_KEY_FORCEVIEW, 1);
		$this->App->Doc->setup_document();
		//TODO TREAT VIEW CONTROLLER WHEN CHANGING DATA
		$this->App->ViewControllers();
		// IGKApp::$DEBUG = 1;
		//ask for every available controller to recalculate the view
		igk_notification_push_event(IGK_FORCEVIEW_EVENT, $this);
		igk_set_env(IGK_KEY_VIEW_FORCED, 1);
	}
	public function clearAllSession(){
		if (igk_is_conf_connected()){
				$tab = igk_sys_get_all_openedsessionid();
				$cid =session_id();
				$c = 0;
				foreach($tab as $k=>$v){
					if ($k==$cid)
						continue;

					unlink($v["file"]);
					$c++;
				}
				if( $c>0)
					igk_notifyctrl()->addMsg("Some session destroyed : ".$c);
		}
		igk_navtobaseuri();
	}

	// public function changeLoaded($ctrl){
		// $c = $ctrl->isChanged(IGKAppConfig::CHANGE_REG_KEY, $this->m_debugginchanged);
		// if ($c)
		// {
			// $this->View();
		// }
	// }
	public function configPropertyChanged(){
		$this->View();
	}
	public function changeviewmode(){
		if (!igk_is_conf_connected())
			{return;}
		igk_set_env(IGK_ENV_NO_AJX_TEST,1);
		$m = igk_getr("mode", 1);
		$this->App->setViewMode($m);
		igk_set_env(IGK_ENV_PAGEFOLDER_CHANGED_KEY, 1);
		$this->View();

		// igk_io_w2file("d:\\temp\\trace.html", igk_show_trace());
		//ajx demand - defaultbehaviour
		igk_app()->Session->setRedirectTask("modview", 1);
		igk_navto_referer();
		igk_exit();
	}
}

///<summary>Controller used to manage controllers</summary>
final class IGKCtrlManager extends IGKNonVisibleControllerBase
{
	public function getName(){return IGK_CTRL_MANAGER; }

	public function IsFunctionExposed($name){
		return true;
	}
	///<summary>add a controller</summary>
	public function addController($name=null, $webpagecontent = false, $webparent=null)
	{		
		$n = str_replace(" ","_", trim($name ?? igk_getr(IGK_FD_NAME,null)));
		$ctrl_typename = igk_getr("clCtrlType", null);
		$ctrl_ns = igk_getr("clCtrlNameSpace", "igk");
		$response = false;
		$code = 0;
		$notf = igk_notifyctrl(igk_getr("notification"));
		$type =null;
		if (empty($ctrl_typename)){
			$code |= 16;
			$notf->addWarningr("msg.typenotdefined",$n);
		}
		
		if (!igk_is_identifier($n))
		{
			$notf->addWarningr("msg.identifiernotvalid_1",$n);
			$code |= 1;
		}
		if (igk_ctrl_is_reservedname($n))
		{
			$notf->addWarningr("msg.addctrl.nameisreserverd_1", "[".$n."]");
			$code  |= 2;
		}
		if (class_exists($n))
		{
			$notf->addWarningr("msg.classalreadyexists");
			$code |= 4;
		}
		if ( ($info = igk_ctrl_info($ctrl_typename)) && !$info->CanAddNew)
		{
			$notf->addWarningr("msg.ctrl.notallowingchild_1",  $info->Created);
			$code |=8;
		}
		
		if ($code==0){
			$type = igk_getv(IGKCtrlTypeManager::GetControllerTypes(), $ctrl_typename );
			if ($type!=null){
				$meth = "CheckBeforeAddControllerInfo";
				if (method_exists($type,  $meth) && ! call_user_func_array(array($type,$meth), array($_REQUEST)))
				{
					$code |=0x100;
					$notf->addError(R::ngets("err.addctrl.meth.checkbeforeaddcontrollerinfo.failed_3", $type , $n, $code));
					igk_wln("ceck befor exists ".$code);
					return $response;
				}
			}		
		}
		
		if ($code !=0)
		{
			$code |=0x100;
			$notf->addErrorr("err.cannotaddnewctrl_3", $type , $n, $code);
			return $response;
		}
		//return false;



		if ($n && ($n !=".") && ($n!=".." ) && (igk_getctrl($n) == null) && ($type!=null))
		{
			$clcontent = self::GetDefaultClassContent($n, $type, $webparent);
			$p = "";
			if (($ctrl_ns!="igk") && preg_match(IGK_NAME_SPACE_REGEX, $ctrl_ns))
			{
				$m = explode(".", $ctrl_ns);
				foreach($m as $k=>$v){
					if (empty($v))
						continue;
					$p .= $v."/";
				}
			}
			//select output folder
			$odir = igk_getr("clOutFolder");
			if (!empty($odir)){
				$p = "/".$odir."/".$p;
			}

			$folder = IGK_APP_DIR."/".IGK_PROJECTS_FOLDER."/".$p.$n;
			$file_name = $folder."/class.".$n.".php";
			if (file_exists($file_name)){
				$code |=0x200; //controller already exists
				return false;
			}
			$grantaccess = "allow from all";
			$denyaccess="deny from all";

			// IGKIO::CreateDir($folder);
			// IGKIO::CreateDir($folder."/".IGK_VIEW_FOLDER); //view folder
			// IGKIO::CreateDir($folder."/".IGK_ARTICLES_FOLDER);//article folder
			// IGKIO::CreateDir($folder."/".IGK_DATA_FOLDER);//data folder
			// igk_io_save_file_as_utf8($folder."/".IGK_DATA_FOLDER."/.htaccess", $grantaccess);
			// IGKIO::CreateDir($folder."/".IGK_SCRIPT_FOLDER);//script folder
			// igk_io_save_file_as_utf8($folder."/".IGK_SCRIPT_FOLDER."/.htaccess", $grantaccess);

			// IGKIO::CreateDir($folder."/".IGK_STYLE_FOLDER);//styles folder
			// igk_io_save_file_as_utf8($folder."/".IGK_STYLE_FOLDER."/.htaccess", $grantaccess);
			// igk_io_save_file_as_utf8($folder."/".IGK_STYLE_FOLDER."/default.pcss", igk_get_default_style());


			//.init environment folder
			igk_init_controller(new IGKCtrlInitListener($folder,'system'));
			//.primary config section
			$t = igk_sys_getdefaultCtrlConf();
			$t["clDataAdapterName"] = igk_getr("clDataAdapterName", "CSV");
			$t["clDisplayName"] = igk_getr("clDisplayName",null);
			$t["clRegisterName"] = igk_getr("clRegisterName", igk_web_prefix().".".$n);
			$t["clParentCtrl"] = $webparent==null? $webparent : igk_getr("clParentCtrl");
			$t["clTargetNodeIndex"] = igk_getr("clTargetNodeIndex");
			$t["clVisiblePages"] =igk_getr("clVisiblePages");
			$t["clDescription"] =igk_getr("clDescription");
			$t["clDataSchema"] = igk_getr("clDataSchema");
			//.init additional info 
			$o = call_user_func_array( array($type,"SetAdditionalConfigInfo"), array(&$t) );

			if ($type == "IGKDefaultPageCtrl")
			{
				igk_io_save_file_as_utf8($folder."/".IGK_SCRIPT_FOLDER."/default.js", self::GetDefaultScript($n));
			}
			$file_name = $folder."/class.".$n.".php";
			igk_io_save_file_as_utf8($file_name, 	$clcontent );
			//write view
			igk_io_save_file_as_utf8($folder."/".IGK_VIEW_FOLDER."/".IGK_DEFAULT_VIEW_FILE, call_user_func(array($type,"GetAdditionalDefaultViewContent")));


			include($file_name);

			//store controller configs - data
			$conf =  igk_createNode("config");
			foreach($t as $k=>$v){
				$conf->add($k)->Content = $v;
			}
			//store configs
			$cl = new $n();
			$cl->loadConfigSetting($conf);

			//call static method InitEnvironment method if exists on child controller.
			//first call
			$fn = IGK_INITENV_FUNC;

			if (method_exists($cl, $fn))
			{
				$e = call_user_func_array(array($n, $fn), array($cl));
				if (!$e){
					igk_ilog("InitEnvironment failed for ".$cl, __METHOD__);
				}
			}
			// else{
				// igk_ilog("no init environment for ".$cl, __METHOD__);
			// }
			//init the loaded controller

			
			
			//initialize the new controller in environment
			IGKControllerManagerObject::getInstance()->initCtrl($cl, 1);			
			//dispose
			unset($cl);
			//get registrated controller
			$ctrl = igk_getctrl($n);
			$nodefaultarticle = igk_getr("nodefaultarticle", 0);
			//save default articles
			if ($ctrl && !$nodefaultarticle)
			{
				igk_io_save_file_as_utf8($ctrl->getArticle(IGK_DEFAULT), R::ngets("default.articlev_1", $n)->getValue());
			}
			igk_sys_cache_lib_files();			
			igk_invoke_session_event("sys://event/controlleradded", array( $this, $ctrl));
			$response = true;
		}
		else{
			igk_notifyctrl()->addErrorr("err.cannotaddnewctrl_2", $type , $n);
			//igk_ilog(R::ngets('err.cannotaddnewctrl_2')->getValue());
		}
		return $response;
	}
	//request remove controller by name
	public function removeCtrl($n=null){
		$n = ($n == null)?igk_getr("n"): $n;

		$r = false;
		if ($n)
		{
			$ctrl = igk_getctrl($n);
			if ($ctrl){
				$cl = get_class($ctrl);
				if ($cl)
				{
					IGKControllerManagerObject::ClearCache();
					$i = IGKControllerManagerObject::getInstance();
					$r = is_string($n)? $i->dropControllerByName($n) : $i->dropController($n);
					if ($r){
						//reload class setting
						$i->reloadModules(array($cl=>$n), false, 0);
					}
				}
			}
			return $r;
		}
		return false;
	}


	private static function GetDefaultScript($n)
	{
	$conf = "constant";
	$o = <<<OEF
{$conf('IGK_START_COMMENT')}
default script for {$n}
{$conf('IGK_END_COMMENT')}
OEF;
	return $o;
	}
	public static function GetDefaultClassContent($name, $extends, $webparent=null)
	{

		if (igk_ctrl_is_reservedname($name))
			return null;

		$param = array();
		$param["extend"] =  $extends; // $webpagecontent? IGK_CTRLWEBPAGEBASECLASS :  IGK_CTRLBASECLASS;
		$param["summary"] = "";
		$param["desc"] = "";
		$param["create"] = igk_date_now();
		$param["copyright"] = IGK_COPYRIGHT;
		$param["author"] = IGK_AUTHOR;


		$s = IGK_STR_EMPTY;
		$s .= !$webparent || (igk_getctrl($webparent) == null) ?null :<<<EOF
igk_getctrl("{$webparent}")->regChildController(\$this);
EOF;
		$out = <<<EOF
<?php
//*
//author:{$param["author"]}
//description:{$param["desc"]}
//created:{$param["create"]}
//copyright: {$param["copyright"]}
//*

//
//controller code class declaration
//file is a part of the controller tab list
//

///<summary>{$param["summary"]}</summary>
class $name extends {$param["extend"]} {
	public function getName(){return get_class(\$this);}
	protected function InitComplete(){
		parent::InitComplete();
		//please enter your controller declaration complete here

	}
	///<summary> init target node</summary>
	protected function initTargetNode(){
		\$node =  parent::initTargetNode();
		return \$node;
	}
	//----------------------------------------
	//Please Enter your code declaration here
	//----------------------------------------

	///<summary>override to handle your custum view mecanism</summary>
	//public function View(){
	//	parent::View();
	//}

}
?>
EOF;
return $out;
	}
}


//<summary>represent primary page controller Page Controller</summary>
final class IGKPageCtrl extends IGKNonVisibleControllerBase
{
	private $m_oldPage;
	private $m_newPage;
	private $m_state;
	private $m_currentUri;

	var $PageLoadEvent;
	//navigation state
	const REFRESHING = 5;
	const NAVIGATE = 1;
	const GOTOPREVIOUS = -1;

	public function __construct()
	{
		parent::__construct();
		$this->PageLoadEvent = new IGKEvents($this, "PageLoadEvent");
	}
	public function getName(){return IGK_SYS_PAGE_CTRL;}
	public function getState(){return $this->m_state;}

	public function checkState(){
		$v_rUri = igk_io_request_uri();
		if ($this->m_newPage != $v_rUri)
		{
			if ($v_rUri == $this->m_oldPage)
			{
				$this->m_oldPage = $this->m_newPage;
				$this->m_newPage = $v_rUri;
				$this->setState(self::GOTOPREVIOUS);
			}
			else{
				$this->m_oldPage = $this->m_newPage;
				$this->m_newPage = $v_rUri;
				$this->setState(self::NAVIGATE);
			}
		}
		else {
			if (igk_getv($_SERVER, "HTTP_CACHE_CONTROL") == "max-age=0"){
				$this->setState(self::REFRESHING);
			}
			else
				$this->setState(0);
		}
	}
	public function getisRefreshing(){
		return ($this->State == self::REFRESHING);
	}

	///add a new page to system
	public function add(){
		$n= getr("n",null);
		if ($n)
		{
			$dir = IGKIO::GetBaseDir($n);
			mkdir($dir);
			$text = <<<EOF
<?php
include_once(dirname(__FILE__)."/../index.php");
igk_wl( igk_app()->Doc->Render());
?>
EOF;
			igk_io_save_file_as_utf8($dir."/index.php", $text, false);
			igk_navtobase();
			igk_exit();
		}
	}
	protected function InitComplete(){//IGKPageCtrl init complete event
		parent::InitComplete();
		//igk_reg_session_event(IGK_ENV_APP_INIT, array($this, '_igk_initCalled'));
		//$this->App->InitEvent->add($this, "_igk_initCalled");
		//$this->App->Session->addUpdateSessionEvent($this, "_igk_session_update");
	}
	
	public function onHandleSessionEvent($msg, $m){
		switch($msg){
			case IGK_ENV_APP_INIT:			
				_igk_initCalled();
				break;
		}
	}
	protected function _igk_session_update()
	{
		$this->_igk_initCalled();
		$this->m_currentUri = igk_io_request_uri();
		if ($this->State == self::REFRESHING)
			$this->View();
	}
	private function setState($state)
	{
		if( $this->m_state != $state)
		{
			$this->m_state = $state;
			//ONSTATE CHANGED
		}
	}
	private function _igk_initCalled(){
		if (defined("IGK_FORCSS"))
		{
			return;
		}
		$this->OnPageLoad();
	}
	protected function OnPageLoad(){
		$this->PageLoadEvent->Call($this, null);
	}
}
//-------------------------------------------
//dialog frame box size
//-------------------------------------------
// final class IGKMsDialogFrameSizeValue extends IGKObject
 // implements IIGKHtmlGetValue {
	// private  $m_owner;

	// public function getOwner(){
		// return $this->m_owner;
	// }

	// public function __construct($owner){
		// $this->m_owner = $owner;
	// }

	// public function getValue($options=null){//dialog size get value

		// return  igk_get_string_format("ns_igk.winui.framebox.init(ns_igk.getParentByTagName(ns_igk.getlastscript(),'div'),{0},{1});",
		// igk_getsv($this->m_owner->Width?'"'.$this->m_owner->Width.'"':null,'null'),
		// igk_getsv($this->m_owner->Height?'"'.$this->m_owner->Height.'"':null,'null'));
	// }
// }



///<summary>represent the dialog frame</summary>
final class IGKMsDialogFrame extends IGKHtmlItem
{
		private $m_Box;
		private $m_BoxContent;//node of box content
		private $m_Title;
		private $m_closeUri;
		private $m_closeBtn;
		private $m_Width;
		private $m_Height;
		private $m_id;
		private $m_owner;
		private $m_script;
		private $m_form;
		private $m_closeMethodUri;
		private $m_callbackMethod;
		private $m_reloadcallbackMethod;
		private $m_closeCallBackEvent;
		private $m_framectrl;


		public function addCloseCallBackEvent($obj, $method)
		{
			if ($this->m_closeCallBackEvent!= null)
			{
				$this->m_closeCallBackEvent->add($obj, $method);
			}
		}
		public function removeCloseCallBackEvent($obj, $method)
		{
			if ($this->m_closeCallBackEvent!= null)
			{
				$this->m_closeCallBackEvent->remove($obj, $method);
			}
		}
		//get the id of this frame
		public function getId(){return $this->m_id;}
		//get the owner of this dialog
		public function getOwner(){return $this->m_owner; }
		public function getBox(){return $this->m_Box;} //get the box
		public function getBoxContent(){return $this->m_BoxContent;}//get
		public function setcloseUri($value){
			$this->m_closeBtn["href"] = $value;
		}
		public function getcloseUri(){
			return $this->m_closeBtn["href"]->getValue();
		}
		public function getcloseMethodUri(){ return $this->m_closeMethod ;}
		public function setcloseMethodUri($value){$this->m_closeMethod = $value;}
		public function setWidth($value){ $this->m_Width = $value;}
		public function setHeight($value){ $this->m_Height = $value;}
		public function setTitle($value){ $this->m_Title->Content = $value;}
		public function getTitle(){ return $this->m_Title->Content;}
		public function getForm(){return $this->m_form;}
		public function setForm($value){ $this->m_form = $value; }
		public function getcallbackMethod(){return $this->m_callbackMethod;}
		public function setcallbackMethod($value){$this->m_callbackMethod = $value;}

		public function getWidth(){return $this->m_Width; }
		public function getHeight(){return $this->m_Height;}
		public function getCloseBtn(){return $this->m_closeBtn; }
		//method to call when frame closed
		public function closeMethod()
		{

			if ($this->m_callbackMethod)
			{
				$c = $this->m_callbackMethod;
				$c($this);
			}
			if($this->m_closeCallBackEvent!= null)
			{
				$this->m_closeCallBackEvent->Call($this, null);
			}


		}
		//<summary>get script node</summary>
		public function getScript(){return $this->m_script; }

		public function __construct($framectrl , $id = null, $owner=null, $reloadcallback=null){
			parent::__construct("div");

			if (!igk_reflection_class_implement($framectrl , "IIGKFrameController"))
			{
				igk_die("required IIGKFrameController");
			}

			$this->m_framectrl = $framectrl;


			$this->m_closeCallBackEvent = new IGKEvents($this, "closeCallBackEvent");
			$this["class"] = "framebox fitw fith posab loc_t loc_l";
			$this["id"] = "framebox-".$id;
			$this["igk-control-type"] = "frame";
			$this->setIsVisible(true);
			$this->m_id = $id;
			$this->m_owner = $owner;
			$this->m_reloadcallbackMethod = $reloadcallback;
			$this->m_Box = $this->add("div", array("class"=>"framebox-dialog posab no-overflow resizable", "id"=>"framebox-dialog"));

			$this->m_Title =$this->m_Box->add("div", array("class"=>"framebox-title", "id"=>"framebox_".$id."_title"))
			->addDiv()
			->setClass("framebox-dialog-title title");


			$tab = $this->m_Box->add("div", array("class"=>"disptable fitw fith framebox_bgcl"));
			$c = $this->m_Box;


			$this->m_BoxContent =  $tab->add("div", array("class"=>"disptabr fith fitw"))->add("div",array("class"=>"framebox-dialog-content disptabc alignl pad4") );



			$v_cdiv = $this->m_Title->addDiv()->setClass("framebox_close");
			$this->m_closeBtn = $v_cdiv->addLinkBtn(IGK_STR_EMPTY , null, 48,24);
			// if ($this->m_closeBtn ==null){
				// igk_die("no close button created");
			// }
			$this->m_closeBtn["class"] = "-igk-btn-lnk framebox-btn-close";
			//$this->m_script = $this->m_Box->addScript();
			$this->m_Box["data"] = igk_create_func_callback(array($this, '__get_dialog_attrib'),null);
			// igk_wln("for : ".$id);
			// igk_wln( IGKHtmlUtils::GetAttributeValue($this["data"]));
			// session_destroy();
			//e_xit;
			//$this->m_script->setContent(new IGKMsDialogFrameSizeValue($this));
		}
		public function __get_dialog_attrib(){
			return "\"{w:'300px', h:'800px'}\"";
		}

		public function getIsVisible(){
			if (!parent::getIsVisible() && !$this->m_framectrl || !$this->m_framectrl->ContainFrame($this->m_id, $this))
			{
				//remove frame
				return false;
			}
			return true;
		}
		protected function __AcceptRender($o =null){
			if (!$this->m_framectrl || !$this->m_framectrl->ContainFrame($this->m_id, $this)){
				//remove frame
				return false;
			}
			$def = IGK_STR_EMPTY;
			if ($this->m_Width && $this->m_Height)
				$def =$def."width:".$this->m_Width."px; height:".$this->m_Height."px";
			$this->m_closeBtn->Uri = R::GetImgUri("btn_close");
			$this->m_closeBtn["datasrc"]=R::GetImgUri("btn_close");
			$this->m_Box["style"]=$def;
			return true;
		}


		public function ClearChilds(){//override clear childs
			$this->m_BoxContent->ClearChilds();
			return $this;
		}
}

//used in MsBox Controller to store activities
final class IGKHtmlMsBox extends IGKHtmlItem
{
		private $m_msboxController; //represent a frame box items
		public function __construct($msboxController){
			parent::__construct("div");
			$this->m_msboxController = $msboxController;
		}
		public function Render($xmloption=null)
		{
			$out = parent::Render($xmloption);
			if ($this->m_msboxController->getIsVisible())
			{
				$this->m_msboxController->getIsVisible(false);
				$this->m_msboxController->Clear();
				return $out;
			}
			else{
				$this->m_msboxController->Clear();
				return null;
			}
		}
}



//<summary>MESSAGEBOX CONTROLLER show message box </summary>
final class IGKMsBoxController extends IGKControllerBase
implements IIGKFrameController
{
	private $m_frame;
	private $m_node;
	private $m_title;
	private $m_boxbloc;
	private $m_errormsg;
	private $m_warningmsg;
	private $m_debugmsg;
	// private $m_isvisible;

	public function getName(){return IGK_MSBOX_CTRL; }
	public function getContent(){return $this->m_frame->BoxContent; }

	public function ContainFrame($id, $frame, $remove=true)
	{
		return "igk-msbox-dialogframe" == $id;
	}
	public function __construct(){
		parent::__construct();
		$id = "igk-msbox-dialogframe";
		$this->m_frame = new IGKMsDialogFrame($this, $id, $this);
		//$this->m_frame->setCloseUri("#/closeframe?id=igk-msbox-dialogframe");
		$this->m_frame->setCloseUri($this->getUri("close"));
		$this->m_frame->Title = R::ngets("title.MessageBox");
		$this->m_node = new IGKHtmlMsBox($this);
		$this->m_node->add($this->m_frame);
		$this->m_node["class"] = "igk-msbox-dialogframe posab fitw fith loc_t loc_l igk-zfront";
		$this->m_node->setId( $id);
		$this->m_node["igk-type"] = "igk-framectrl";
		$this->m_node->addScript()->setContent(<<<EOF
(function(q){igk.winui.framebox.reg_frame_close(function(name){ if (name=='framebox_{$id}') { q.parentNode.removeChild(q);return true;} return false;});})(window.igk.getParentScript());
EOF
);

		$this->m_errormsg =  igk_createNode("ul");
		$this->m_warningmsg =  igk_createNode("ul");
		$this->m_debugmsg =  igk_createNode("ul");
		// $this->m_isvisible =false;
	}
	protected function initTargetNode(){
		return null;
	}
	public function View(){
		//no views	: cause no target node but not is used for rendering message box
	}

	public function Clear()
	{
		$this->_freeError();
		$this->m_warningmsg->ClearChilds();
		$this->m_debugmsg->ClearChilds();
	}
	function _freeError()
	{
		igk_html_rm($this->m_errormsg);
		$this->m_errormsg->ClearChilds();
	}
	public function close(){//"msbox controller close node
		if ($this->m_node->ParentNode !=null)
		{
			igk_html_rm($this->m_node);
			$this->Content->ClearChilds();
			$this->_freeError();
			$this->m_isvisible = false;
			igk_navtocurrent();
			igk_exit();
		}
	}
	private function _register()
	{
		if ($this->m_node->ParentNode === null)
		{
				$this->App->Doc->Body->add($this->m_node);
		}
		if ($this->m_errormsg->ParentNode === null)
		{
			$this->Content->add($this->m_errormsg);
		}
		$this->m_title["class"] = "msbox_error_title";
		// $this->m_isvisible = true;
	}
	public function addErrorr($key)
	{
		$this->addError(R::ngets($key, array_slice(func_get_args(), 1)));
	}
	public function addError($msg){//IGKMsBoxController add Error
			if (is_string($msg))
			{
				$this->m_errormsg->addLi()->Content = $msg;
			}
			else{
				IGKHtmlUtils::AddItem($msg, $this->m_errormsg);
			}
			$this->_register();
			// $this->m_isvisible = true;
	}
	public function addErrori($msg_code)
	{
		$c = igk_error($msg_code);
		if ($c){
			$out =  igk_createNode("div")->AppendAttributes(array("class"=>"alignl"));
			$ul = $out->add("ul");
			$li = $ul->addLi();
			$li->addLabel()->Content = "Code : ";
			$li->addspan()->Content =  $c["Code"];
			$li = $ul->addLi();
			$li->addLabel()->Content = "Message : ";
			$li->addspan()->Content = R::ngets($c["Msg"]);
			$this->addError($out->Render(null));
		}
		$this->m_isvisible = true;
	}
	public function addInfo($msg){
		if (!$this->getIsVisible()){
			if (is_string($msg))
			{
				$this->m_errormsg->addLi()->Content = $msg;
			}
			else{
				IGKHtmlUtils::AddItem($msg, $this->m_errormsg);
			}
		}
		$this->_register();
		// $this->m_isvisible = true;
	}
	public function addDebug($msg){

			if (is_string($msg))
			{
				$this->m_errormsg->add("li", array("class"=>"msbox_debug"))->Content = $msg;
			}
			else{
				IGKHtmlUtils::AddItem($msg, $this->m_errormsg);
			}
		$this->_register();
		// $this->m_isvisible = true;
	}

	public function copyChilds($errori){
		if ($errori == null)return;
		foreach($errori->getChilds() as $k)
		{
			$this->msbox->addError($k);
		}
	}
}

///<summary>Used to save page view list in a list in order to check if the controller is visible or not</summary>
final class IGKPageView extends IGKObject
{
	private $m_v;
	private $m_pagelist;

	public function getValue($options=null){return $this->m_v; }
	public function getPageList(){return $this->m_pagelist; }

	//.ctr
	public function __construct(){
	}
	public function registerPages()
	{
		
		$ctrl = igk_getctrl(IGK_MENU_CTRL);
		if (!is_array($this->m_pagelist) || !$ctrl)
			return;
		foreach($this->m_pagelist as $k=>$v)
		{
			if (!empty($k))
				$ctrl->registerPage(strtolower(trim($k)));
		}
	}
	public function register($value){
		//-------------------------------
		//register pages with -
		//-------------------------------
		$this->m_v = $value;
		$t = explode(',', $value);
		if ($value == "*")
		{
			$this->m_pagelist = true;
		}
		else {
			$this->m_pagelist = array();
			foreach($t as $k=>$v)
			{
				$this->m_pagelist[strtoupper(trim($v))] = 1;
			}
		}
	}
	public function getIsVisible($page){
		if (is_bool($this->m_pagelist))
			return $this->m_pagelist;

		if ($this->m_v == "*")
			return true;
		if ( isset($this->m_pagelist[strtoupper($page)]))
			return true;
		if ( isset($this->m_pagelist["-".strtoupper($page)]))
			return false;
		return false;
	}
}

///<summary>respresent de fault View controller type </summary>
abstract class IGKViewCtrl extends IGKCtrlTypeBase
{
	//must have a static method that
	public static function GetAdditionalConfigInfo()
	{
		return null;
	}
	public static function SetAdditionalConfigInfo(& $t)
	{
		//so set additionnal property setting
		return 1;
	}
}

abstract class IGKPageCtrlBase extends IGKCtrlTypeBase{
	private $m_user;
	private $m_template; //template instance

	public function getUser(){
		return $this->m_user;
	}

	protected function setUser($user){
		$this->m_user = $user;
	}

	public function navtohome(){
		$this->resetCurrentView();
		$c = $this->getAppUri();
		igk_navto($c);
	}

	///<summary>check init and init user to this apps </summary>
	protected function checkUser($nav=true, $uri=null)
	{
		$r = true;
		$u = $this->App->Session->User;
		$ku = $this->User;
		// if (($ku== null) || ($ku !== $u))
		if ($ku==null){
			if ($u != null){
				$this->User = $this->initUserFromSysUser($u);
			}
			else
				$r = false;
		}
		if ($nav && !$r){
				$m = igk_io_baseRequestUri();
				$s = "";
				$u = ($uri==null?$this->getAppUri(""): $uri);

				if (!empty($m)){
					$s = "q=".base64_encode($m);//igk_io_baseRequestUri());
				$u .= ((strpos($u, "?") === false)?
					"?" : "&").$s;
			}
			igk_navto($u);
		}
		return $r;
	}


	///@@@ override login function
	public function login($u=null, $pwd=null, $nav=true){
		$c = igk_getctrl(IGK_USER_CTRL);
		$f = 0;
		if ($this->User == null)
		{
			if (is_object($u)){
				if (igk_is_array_key_present($u, array("clLogin", "clPwd")))
				{
					$c->setUser($u);
					$this->checkUser(false);
					$f= 1;
				}
			}else{
				if ($c->connect($u,$pwd)){
					$this->checkUser(false);
					$f= 1;
				}

			}
			if ($f == 0){
				igk_notifyctrl("notify/app/login")->addErrorr("e.loginfailed");
				$b = igk_getr("badUri");
				if ($b){
					igk_navto($b);
					igk_exit();
				}
			}
		}
		if ($f && $nav){
			$b = igk_getr("goodUri");
			igk_navto($b ?? $this->getAppUri(""));
			igk_exit();
		}
	}

	//<summary> call logout on this controller</summary>
	public function logout($nav=1){
		$this->User = null;
		igk_getctrl(IGK_USER_CTRL)->logout();
		if ($nav)
		igk_navto($this->getAppUri());
	}

	///<summary>init app's. override this method to initialize user app's environment</summary>
	///<remark>in general you must load app environment setting and store it in $user->EnvParam["app:://Name/setting"]</remark>
	protected function initUserFromSysUser($u){
		//init your user
		return $u;
	}
}

abstract class IGKDefaultPageCtrl extends IGKPageCtrlBase
implements IIGKUriActionRegistrableController,
 IIGKWebPageController
{

	private $m_func_handler; // private function uri handler
	// private $m_footer_content; //get the footer content node
	// private $m_menu_container; //get the menu container
	// private $m_header_content; //get the header content
	// private $m_header_node;// get the header node
	// private $m_body_node;   //get the body node
	// private $m_footer_node; //get the footer node
	// private $m_Title; 		//title of the page
	///get the name of the page that control this controller

	//for domain management
	public function getBasicUriPattern(){
		return  igk_getv($this->Configs, "clBasicUriPattern");
	}
	public function getRegUriAction(){
		$primary = $this->getBasicUriPattern();
		if (empty($primary))
			return null;
		return "".$primary.IGK_REG_ACTION_METH;
	}
	public function getRegInvokeUri(){
		return $this->getUri(IGK_EVALUATE_URI_FUNC);
	}

	///<summary>used to evaluatue query expression</summary>
	///<param name="xml">show error as xml if not handled</param>
	///<param name="nav">demand to render or not the current document</param>
	public final function evaluateUri($patterninfo=null, $xml=true, $nav=null){
		$this->setEnvParam("from", __FUNCTION__);
		$t = $this->TargetNode;
		igk_html_rm($t); //because of system evaluation
		$inf = $patterninfo ? $patterninfo : igk_sys_ac_getpatterninfo();
		$nav = $nav ?? !igk_get_env("sys://no_render");
		if (!$inf || !is_object($inf)){
			igk_ilog_assert(igk_is_debug(), "pattern info not found or info not an object", __METHOD__);
			return;
		}

		$v_tp = $inf->getParams();
		// igk_wln($v_tp);
		//e_xit;
		$c = igk_getv($v_tp, "function");
		$p = igk_getv($v_tp, "params");
		include(IGK_LIB_DIR."/Inc/igk_sitemap.pinc");


		$doc = $this->Doc;
		$doc->TempTheme->resetAll();
		if (empty($c)){
			//call the primary view
			$this->View();
		}
		else{
			//
			//PRIORITY TO FILE INCLUSION BEFORE METHOD CALL
			//
			$v_c = 0;
			if (preg_match("/(\.(".IGK_VIEW_FILE_EXT_REGEX."))?$/i" , $c)){
				$f = $this->getViewfile($c);
				if (file_exists($f)){
					$this->getView($c, false, $p);
					$v_c =1;
				}
			}
			if ($v_c == 0){
				//
				//CHECK IF METHOD EXISTS AND AVAILABLE
				//
				if ($this->IsFuncUriAvailable($c))
				{
					if ($p == null) //is_array($p) == false)
						$p = array();
					else if (is_array($p) == false)
						$p = array($p);
					call_user_func_array(array($this, $c), $p);
				}
				else {
					if ($xml){
						ob_clean();

						header("Status: 404");
						header("HTTP/1.0 404 Not Found");
						$r = new IGKXmlNode("result_evaluation_uri");
						$r->add("error")->Content = IGK_ERR_FUNCNOTAVAILABLE;
						$r->add("msg")->Content = "Function not available ";//.R::ngets(igk_get_error_key(IGK_ERR_FUNCNOTAVAILABLE))->getValue();
						$r->add("function")->Content = $c;
						if (IGKViewMode::IsWebMaster()){
							$c = $r->add("info");//addWebMasterNode();
							$c->add("icode")->Content = igk_getv($_REQUEST, "code");
							$c->add("ctrl")->Content = $this->Name;
						}
						$r->addObData($_SERVER);
						$r->RenderXML();
						igk_exit();
					}

				//if dir exist for some reason then
				igk_io_check_request_file($inf->uri);
				if (igk_is_ajx_demand()){
					igk_wl("<response><message>method not found [".$c."]</message></response>");
				}
				else{
					$m = "method not exists ".$c . " ".IGK_EVALUATE_URI_FUNC." ".$inf->uri;
					igk_notifyctrl()->addError($m);
					igk_navto($this->getAppUri());
				}
					if($nav)
						igk_exit();
					return true;
				}
			}
		}
		igk_render_node($t, $doc , $nav);
		if($nav)
			igk_exit();
		return true;
	}

	///<summary> get if a function is avaible for uri invocation</summary>
	public function IsFuncUriAvailable(& $m){
		$k = $m;
		if (!method_exists($this, $k)){
			$k = "uri_".$k;
			if (!method_exists($this, $k))
				$k = null;
		}

		if ($k !== null){
			$m = $k;
			return true;
		}
		return false;
	}
	//<summary>handle only on redirection case</summary>
	public function is_handle_uri($uri=null){

		if (igk_const('IGK_REDIRECTION')==1){
			//disable uri for redirection
			if (preg_match("#^/!@#", igk_io_request_uri()))
				return false;
		}

		if (!defined("IGK_REDIRECTION") && !igk_get_env("sys://io_invoke_uri")){
			return false;
		}

		$uri = $uri==null? "/".igk_io_baseRequestUri() : $uri;
		$k="^(/)?(/:function(/|/:params+)?)?";
		$pattern = igk_pattern_matcher_get_pattern($k);
		$p = igk_pattern_get_matches($pattern, $uri,igk_str_get_pattern_keys($k));
		$c = igk_getv($p, "function");
		return isset($this->m_func_handler[$c]);
	}
	///<summary>handle evaluation uri</summary>
	///<return>true if handle uri or false</summary>
	public function handle_redirection_uri($uri){
		igk_sys_handle_uri();
		$k="^(/)?(/:function(/|/:params+)?)?";
		$pattern = igk_pattern_matcher_get_pattern($k);
		$p = igk_pattern_get_matches($pattern, $uri, array("function"));
		$c = igk_getv($p, "function");



		if (!preg_match($pattern, $uri))
			return false;

		if (isset($this->m_func_handler[$c])){
			$e = $this->m_func_handler[$c];
			$e->value = $uri;
		}else{
			$e = new IGKSystemUriActionPatternInfo( array(
						"action"=>$k,
						"value"=>$this->getRegInvokeUri(),
						"pattern"=>$pattern,
						"uri"=>$uri,
						"ctrl"=>$this,
						"keys"=> igk_str_get_pattern_keys($k)));
		}
		$p = $e->getParams();
		$c = igk_getv($p, "function");
		$p = igk_getv($p, "params");
		$cp =$c;
		$this->evaluateUri($e);

		return true;
	}

	public static function CheckBeforeAddControllerInfo( $request){
		$g = igk_getv($request, "clDefaultPage");
		if (empty($g))
			return false;
		return 1;
	}
	public static function GetAdditionalConfigInfo(){
		return array("clDefaultPage"=>igk_createAdditionalConfigInfo(array("clRequire"=>1, "clDefaultValue"=>"default"))
		);
	}
	public static function SetAdditionalConfigInfo(& $t)
	{
		$t["clDefaultPage"] = igk_getr("clDefaultPage");
		return 1;
	}
	// protected function setheaderNode($value){$this->m_header_node = $value;}
	// protected function setbodyNode($value){  $this->m_body_node = $value;}
	// protected function setfooterNode($value){ $this->m_footer_node = $value;}
	//required for implements
	// public function getheaderNode(){return $this->m_header_node;}
	// public function getbodyNode(){ return $this->m_body_node;}
	// public function getfooterNode(){ return $this->m_footer_node;}

	//override this to manage error uri request
	public function manageErrorUriRequest($uri){}
	public function getRegisterToViewMecanism(){return true;}
	public function __construct(){
		parent::__construct();
		// $this->m_currentView = IGK_DEFAULT_VIEW;
		$this->m_func_handler = array();
	}
	protected function initTargetNode(){
		$t = parent::initTargetNode();
		$k = IGK_CSS_DEFAULT_STYLE_FUNC_KEY;


		$t->setCallback($k, "return 'igk-page';");

		// igk_wln($t->getFlag(IGK_CALLBACK_FLAG));
		// igk_exit();
		//igk_wln(" ok ".$t->$k());
		$t->setClass("+".$t->$k());
		return $t;
	}

	//load web theme structure
	public function loadWebTheme($file){
	}

	//get or set the page name:
	public function setPageName($value){ $this->m_pageview = $value;}
	// protected function setfooter_content($value){$this->m_footer_content =$value; }
	// protected function setmenu_content($value){ $this->m_menu_container = $value;}
	// protected function setheader_content($value){$this->m_header_content = $value;}


	protected function _initView(){
		// if ($this->App->CurrentPageFolder != IGK_CONFIG_MODE)
		// {
			// IGKHtmlUtils::AddItem($this->headerNode, $this->doc->bodyheader);
			// IGKHtmlUtils::AddItem($this->bodyNode, $this->doc->bodycontent,400);
			// IGKHtmlUtils::AddItem($this->footerNode, $this->doc->bodyfooter, -100);

		// }
		// else {
			// igk_html_rm($this->headerNode);
			// igk_html_rm($this->bodyNode);
			// igk_html_rm($this->footerNode);
			// return;
		// }

	}
	public function getExtraTitle(){
		if (igk_web_defaultpage()!=$this->CurrentPage)
			return " - ".R::ngets("title.".$this->CurrentPage.".webpage")->getValue();
		return IGK_STR_EMPTY;
	}
	protected function initDocument($doc){
		$f = $this->getDataDir()."/R/Img/favicon.ico";
		if (file_exists($f))
		{
			$p = igk_io_basePath($f);
			$doc->Favicon = new IGKHtmlRelativeUriValueAttribute($p);
		}
	}




	public function View(){	//default page controller view
		// extract($this->getSystemVars());
		$t = $this->TargetNode;
		$doc = $this->App->Doc;

		if (!$this->getIsVisible())
		{
			igk_html_rm($t);
			return;
		}
		else if ($this->getEnvParam("from") == null){
			igk_html_add($t, $doc->body->addBodyBox()->ClearChilds());
		}



		$this->doc->Title = $this->m_Title ? $this->m_Title: $this->App->Configs->website_title. $this->getExtraTitle();
		$this->initDocument($this->doc);
		$this->_initCssStyle();
		$this->_initView();
		$c = strtolower(igk_getr("c",null));
		$view = IGK_DEFAULT_VIEW;
		if ($c ==  strtolower($this->Name))
		{
			//change the current view
			$view = igk_getr("v", $view);//empty($view) ? IGK_DEFAULT : $this->m_currentView);
		}
		//Register parent menu FOR MENU
		igk_getctrl(IGK_MENU_CTRL)->setParentView($this->menu_content);
		$this->m_init = true;
		$this->_renderViewFile($view);
		if (!$this->HandleShowChild)
		{
			$this->_showChild(null);
		}
		$this->_onViewComplete();
	}

	///<summary>include current view</summary>
	protected function _renderViewFile($view=null){//override : default page ctrl
		extract($this->getSystemVars());
		$view = $view ?? $this->getCurrentView();
		$f = $this->getViewfile($view);
		if (file_exists($f)){
			$this->_include_file_on_context($f);
		}
		else{
			igk_debug_wln("Current view file does't exists : ".$f);
		}
	}


	protected function InitComplete(){
		parent::InitComplete();
		$this->App->Session->addUserChangedEvent($this, "View");
	}
	protected function OnMenuPageChanged(){//menu page changed
		$this->View();
	}


	public function getIsVisible(){
		//default page controller visible
		if (igk_sys_is_subdomain() && igk_sys_domain_control($this)){
			return true;
		}
		$cp = $this->CurrentPageFolder;
		$cnf = igk_app()->Configs;

		$v = ($cp != IGK_CONFIG_MODE)
		 && ($cnf->web_pagectrl == $this->Name);
		return $v;
	}

	public function pageFolderChanged()
	{
		if ($this->IsVisible)
		$this->View();
	}
	public function saveCtrl(){
		//backup dir
		igk_zip_create_file($this->getDeclaredDir()."/.".$this->Name.".bck.zip", $this->getDeclaredDir());
	}
	public function LoadTemplate(){
		$tempfile = igk_getr("tempfile");
		$this->saveCtrl();
		$this->View();
	}
	public function restoreCtrl(){
		$f = $this->getDeclaredDir()."/.".$this->Name.".bck.zip";
		if (file_exists($f))
		{
			igk_zip_unzip($f, $this->getDeclaredDir());
			$this->View();
			unlink($f);
		}
	}

	public final function resetDb(){
		$s = igk_is_conf_connected() || igk_sys_isuser_authorize(igk_user(), $this->Name.":".__FUNCTION__);

		if (!$s){
			if (igk_app_is_uri_demand($this, __FUNCTION__)){
				igk_navto($this->getAppUri());
			}
			return;
		}

		//igk_ilog_w("reset db for ".__CLASS__);
		igk_db_drop_ctrl_db($this,$this->loadDataFromSchemas(), __FUNCTION__);
		//$this->dropdb();

		$ad = igk_get_data_adapter($this);
		$ad->initForInitDb();
		$this->initDb();
		$ad->flushForInitDb();
		//$this->logout(0);
		if (igk_uri_is_match(igk_io_currentUri(),$this->getAppUri(__FUNCTION__))){

			igk_notification_push_event(IGK_NOTIFICATION_DB_CHANGED, $this, null);
			igk_navto($this->getAppUri());
			igk_exit();
		}
	}



}

final class IGKMenuHostControl extends IGKObject{
	private $m_active;
	private $m_diseable;
	public function getActive(){
		return $this->m_active;
	}
	public function setActive($v){$this->m_active = $value;}

	public function getDiseable(){
		return $this->m_diseable;
	}
	public function setDiseable($v){$this->m_diseable = $value;}

	public function __construct(){
	}
}
//-----------------------------------------------------------------------------------------
//
//-----------------------------------------------------------------------------------------

///<summary>represent a menu controller. It's used to manage global menu and system configuration menu.</summary>
final class IGKMenuCtrl extends IGKConfigCtrlBase
{
	// private $m_init;  //get if menu is initialized
	// private $m_Menus; //registrated menu
	private $m_Pages; //registrated pages
	// private $m_CMenus;//Config menu
	// private $m_CPages; // Configs Page
	private $m_menu_selected; //base selected menu	
	private $m_configTargetNode; //config target node
	private $m_menuTargetNode;//sytem target node
	private $m_customMenu;//user loaded menu

	private $m_CurrentPage;//current page
	private $m_configCurrentPage;// config current mage

	private $m_CurrentPageIndex;
	private $m_sortby;
	private $m_osortby;

	const MENU_CHANGE_KEY  = "CustomMenuChanged";

	private $m_menuChangedState;
	private $m_menuHostCtrl; //menu host constroller

	const SYSTEM_MENU_FLAG = 0xa01;
	const CONFIG_MENU_FLAG = 0xa02;
	const CONFIG_SELECTED_GROUP=0xa03;
	const CONFIG_SELECTED_MENU =0xa04;
	const CONFIG_SELECTED_PAGE =0xa05;
	
	const USER_MENU_FLAG = 0xa0a;
	
	public function getConfigSelectedGroup(){
		return $this->getFlag(self::CONFIG_SELECTED_GROUP);
	}
	public function getConfigSelectedMenu(){
		return $this->getFlag(self::CONFIG_SELECTED_MENU);
	}
	public function setConfigSelectedMenu($menu){
		$this->setFlag(self::CONFIG_SELECTED_MENU, $menu);
	}
	public function getConfigSelectedPage(){
		return $this->getFlag(self::CONFIG_SELECTED_PAGE);
	}
	public function setConfigSelectedPage($page){
		$this->setFlag(self::CONFIG_SELECTED_PAGE, $page);
	}
	
	//EVENTS
	private $m_CurrentPageChangedEvent;
	private $m_configCurrentPageChangedEvent;
	private $m_regmenu; //registrable menu

	public function getName(){
		return IGK_MENU_CTRL;
	}

	public function initCustomMenu($name, $ctrl, $target, $tab, $li="li" ,$selected=null){

		if ($this->m_regmenu ==null){
			$this->m_regmenu = array();
		}
		$e = igk_getv($this->m_regmenu, $name);
		if ($e == null)
		{
			$e = new  IGKMenuHostControl();
			$this->m_regmenu[$name] = $e;
		}
		$this->__initBuildMenu($e, $ctrl,  $target , $tab,$li, $selected);
		return $e;
	}
	private function __initBuildMenu($host, $ctrl, $target, $tab, $tname="li", $selected=null){

		// $q = igk_createObj();
		// $q->parent = null;
		// $q->next = null;
		$cp = array_merge($tab);
		$keys = array_keys($cp);
		$values = array_values($cp);
		$pile = array();



		$path="";
		$m = null;
		while( (igk_count($cp)>0) && ($q =(object) array("c"=>array_shift($cp), "key"=>array_shift($keys),"target"=>$target))
			||
				( (igk_count($pile) >= 0) && ($m = array_pop($pile)))
			)
		{
			// igk_wln($keys);
			// igk_wln($cp);
			// igk_wln($q);
			//e_xit;
			if ($m){

				$keys = array_keys($m->c);
				$cp = $m->c;
				$target = $m->target;
				$path = $m->key;
				$m =null;
				continue;
			}
			$li = $q->target->add($tname);
			$k = $q->key;
			$v = $q->c;


			if ($selected == $k) {//$host->Active == $k){
				$li->setClass("igk-active");
			}
			if ($host->Diseable == $k){
				$li->setClass("igk-diseable");
			}
			$uri="#";
			//get uri
			if (is_string($v))
				$uri = $v;
			else if (is_object($v))
				$uri = $v->getUri();


			$a = $li->addA($uri)->setClass("");
			$a->Content = R::ngets("Menu.".$k);

			if (is_array($v))
			{
				$ul = $li->add($target->TagName);
				//$this->__initBuildMenu($host, $ctrl, $ul, $v, $tname, $selected);
				array_push($pile, (object)array("c"=>$v, "key"=>!empty($path)? $path.".".$k: $k, "target"=>$ul));
			}
			else
				if (is_object($v) && method_exists($v, "getSubmenu"))
				{
					$t = $v->getSubmenu();
					if ($t && (igk_count($t)>0)){
						array_push($pile, (object)array("c"=>$v, "key"=>!empty($path)? $path.".".$k: $k, "target"=>$ul));
					}
				}

		}



		// foreach($tab as $k=>$v){
			// $li = $target->add($tname);
			// if ($host->Active == $k){
				// $li->setClass("igk-active");
			// }
			// if ($host->Diseable == $k){
				// $li->setClass("igk-diseable");
			// }
			// $uri="#";
			// //get uri
			// if (is_string($v))
				// $uri = $v;
			// else if (is_object($v))
				// $uri = $v->getUri();


			// $a = $li->addA($uri)->setClass("");
			// $a->Content = R::ngets("Menu.".$k);
			// if (is_array($v))
			// {
				// $ul = $li->add($target->TagName);
				// $this->__initBuildMenu($host, $ctrl, $ul, $v, $tname, $selected);
			// }
			// else
				// if (is_object($v))
				// {
					// $t = $v->getSubmenu();
					// if ($t && (igk_count($t)>0)){
							// $ul = $li->add($target->TagName);
							// $this->__initBuildMenu($host,$ctrl, $ul, $t , $tname, $selected);
					// }
				// }

		// }
	}

	//register menu page
	public function registerPage($pageName)
	{
		if (!isset($this->m_Pages[$pageName]))
		{
			$this->m_Pages[$pageName] = array();
		}
	}
	public function unregisterPage($pageName)
	{
		if (!isset($this->m_Pages[$pageName]))
		{
			unset($this->m_Pages[$pageName]);
		}
	}

	//GET PROPERTIES

	public function getConfigTargetNode(){ return $this->m_configTargetNode; }
	//MENU Current PAGE
	public function getCurrentPage(){return $this->m_CurrentPage;}
	public function getCurrentPageIndex(){return $this->m_CurrentPageIndex; }
	public function getConfigCurrentPage(){return $this->m_CurrentPage;}
	public function getGlobalMenu(){ if (is_array( $this->m_Menus)){$t = array(); $t = array_merge($t, $this->m_Menus); return $t;} return null;}
	public function getMenu($name){ if ($v = igk_getv($this->getGlobalMenu(),  strtoupper($name)))return $v; return null; }
	public function getRootMenu($name){ return $this->_getRootMenu($name);}
	public function getUserMenu(){return $this->m_customMenu; }
	///<summary>get config menu node</summary>
	public function getConfigMenu(){
		return $this->getFlag(self::CONFIG_MENU_FLAG);
	}

	//return the roots menus
	public function getRoots(){
		$t = array ();
		$h = $this->getGlobalMenu() ;
		if ($h && is_array($h)){
			foreach($h as $k)
			{
				if ($k->MenuParent == null)
					$t[] = $k;
			}
		}
		return $t;
	}
	public function addPageChangedEvent($obj, $method){
		$this->m_CurrentPageChangedEvent->add($obj, $method);

	}
	public function removePageChangedEvent($obj, $method){
		$this->m_CurrentPageChangedEvent->remove($obj, $method);

	}
	public function addConfigPageChangedEvent($obj, $method){
		$this->m_configCurrentPageChangedEvent->add($obj, $method);

	}
	public function removeConfigPageChangedEvent($obj, $method){
		$this->m_configCurrentPageChangedEvent->remove($obj, $method);
	}
	//get registrated page list
	public function getPageList(){
		if ($this->m_Pages)
			return array_keys($this->m_Pages);
		return array();
	}
	private function onPageChanged(){//raise the Page changed event
		$this->m_CurrentPageChangedEvent->Call($this,null);
	}
	protected function onConfigPageChanged(){//raise the config page event
		$this->m_configCurrentPageChangedEvent->Call($this,null);
	}
	public function __construct(){
		parent::__construct();
		$this->m_CurrentPage = IGK_DEFAULT_VIEW;
		$this->m_CurrentPageIndex = 0;
		$this->m_CurrentPageChangedEvent = new IGKEvents($this, "CurrentPageChangedEvent");
		$this->m_configCurrentPageChangedEvent =  new IGKEvents($this, "ConfigCurrentPageChangedEvent");
		$this->m_CurrentPageChangedEvent->add($this, "View");
	}


	//------------------------------------------------------------
	//set the global web page
	//------------------------------------------------------------
	public function setPage($page, $index)
	{
		if (!$this->ConfigCtrl->IsConfiguring)
		{
			$this->m_CurrentPage = $page;
			$this->m_CurrentPageIndex = $index;
			$this->onPageChanged();
		}
		else{
			if (($this->m_configCurrentPage != $page) || ($this->m_configCurrentPageIndex != $index))
			{
				$this->m_configCurrentPage = $page;
				$this->m_configCurrentPageIndex = $index;
				$this->onConfigPageChanged();
			}
		}
	}
	public function getConfigPage(){return "menu";}

	public function getDataTableName(){
		return 'tbigk_globalmenu';
	}
	public function getDataTableInfo(){//
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255, "clIsUnique"=>true, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clIndex", IGK_FD_TYPE=>"Int")),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clController", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255 )),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clMethod", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255 )),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clPage", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255 )),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clAvailable", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>1 ,"clDefault"=>1))
		);
	}

	protected function initDb(){//init menu configuration
	$f = igk_io_syspath(IGK_MENU_CONF_DATA);
	if (file_exists($f) == false){
	$content = <<<EOF
DEFAULT,0,,,default,1
EOF;
		igk_io_save_file_as_utf8($f, $content,true);
		$this->_ReLoadMenu();
		}
	}

	public function menu_sortby()
	{
		$r = igk_getr("n");
		$m = igk_getr("m");
		$index = 0;
		if ($m==null){
			if ($r == $this->m_sortby )
				$this->m_sortby = "r_".$r;
			else
				$this->m_sortby = $r;
		}else{
			$index = 1;
			if ($r == $this->m_sortby )
				$this->m_osortby = "r_".$r;
			else
				$this->m_osortby = $r;
		}
		$this->View();
		igk_wl(igk_getv($this->TargetNode->getElementsByTagName("table"), $index)->Render());
		igk_exit();
	}
	public function sortmenu($a,$b){

		if ($this->m_sortby)
		{
			$m = $this->m_sortby;
			if (IGKString::StartWith($this->m_sortby,"r_"))
			{
				switch(strtolower($m))
				{
					case "clindex":
						$i = igk_getv($a,"clIndex");
						$j = igk_getv($b,"clIndex");
						if ($i < $j)
							return -1;
						else if ($i > $j)
							return 1;
						break;
					case "clcontroller":
					default:
						return strcmp( igk_getv($b,$m), igk_getv($a,$m));

				}
				return strcmp( igk_getv($b, IGK_FD_NAME), igk_getv($a,IGK_FD_NAME));
			}
			else{
			switch(strtolower($m))
			{
				case "clindex":
					$i = igk_getv($a,"clIndex");
					$j = igk_getv($b,"clIndex");
					if ($i < $j)
						return -1;
					else if ($i > $j)
						return 1;
					break;
				case "clcontroller":
				default:
					return strcmp( igk_getv($a,$m), igk_getv($b,$m));

			}
			}
		}
		return strcmp( igk_getv($a, IGK_FD_NAME), igk_getv($b,IGK_FD_NAME));
	}
	public function changeDefaultPage($newPage =null){

		$newPage = igk_gettv($newPage, igk_getr("defaultmenupage"));
		if ($newPage)
		{
			$this->App->Configs->menu_defaultPage = $newPage;
			igk_save_config();
			igk_notifyctrl()->addMsg("configuration update");
		}
		$this->View();
		igk_navtocurrent();
	}
	public function View(){
		$t = $this->TargetNode;
		if (!$this->getIsVisible())
		{
			if (!$this->ConfigCtrl->IsConfiguring)
			{
				$this->selectGlobalMenu(strtolower($this->m_CurrentPage),$this->m_CurrentPageIndex);
			}
			igk_html_rm($t);
			$t->ClearChilds();
		}
		else{
			if (igk_sys_ischanged(self::MENU_CHANGE_KEY, $this->m_menuChangedState))
			{
				$this->_LoadMenu();
			}

			igk_html_add($t, $this->ConfigNode);
			$t->ClearChilds();
			//primary menu builder
			$this->MenuConfig($t);
			//other menu builder
			$v_mdiv = $t->addDiv();
			$v_mdiv["class"]="dispib alignt marg4";
			$this->_m_otherMenuView($v_mdiv);
		}
		$this->_onViewComplete();
	}
	public function MenuConfig($t)
	{

		$v_mdiv = $t->addDiv();
		$v_mdiv["class"]="dispib alignt marg4";
		$frm = $v_mdiv->addForm();
		$this->addTitle($frm, "title.MenuDefaultPage");
		$frm["action"] = $this->getUri("changeDefaultPage");
		$frm["method"] = "post";
		$frm->addLabel("defaultMenuPage");
		$frm->addInput("defaultmenupage", "text", igk_gettv($this->App->Configs->menu_defaultPage, IGK_DEFAULT_VIEW));
		$frm->addBr();
		$frm->addInput("btn_d", "submit", R::gets("btn.submit"));
		$c = $v_mdiv->addForm();
		$c["id"] = "config-menu_form";
		$c["action"]="#".$c["id"];
		$this->addTitle($c, "title.MenuManager");
		$c->addHSep();
		igk_add_article($this,"menu.description", $c->addDiv());
		$c->addHSep();
		$c->addBr();
		$c->addBr();

		$tab = $c->add("table", array("class"=>"fitw"));

		$ct = $this->DataTableInfo;
		$this->_m_loadTableHeader($tab);

		$d = $this->m_customMenu;

		usort($d, array($this,"sortmenu"));


		foreach($d as $k=>$v)
		{
			$tr = $tab->addTr();

			$input = $tr->addTd()->addInput("menu[]", "checkbox", $v[IGK_FD_NAME]);

			foreach($ct as $h=>$m)
			{
				$oi = $m->clName;


				switch(strtolower($oi))
				{
					case "clindex":
						$tr->addTd()->Content = igk_parse_num($v[$oi]);
						break;
				default:
					if (isset($v[$oi]))
					{
					if ($oi==IGK_FD_NAME){
						$tr->addTd()->add("a", array("href"=>$this->getUri("menu_editmenuframe&n=".$v[IGK_FD_NAME])))->Content =$v[$oi];
					}
					else
						$tr->addTd()->Content =$v[$oi];
					}
					else
					$tr->addTd()->Content = IGK_HTML_WHITESPACE;//$v[$oi];
				break;
				}
			}
			IGKHtmlUtils::AddImgLnk($tr->addTd(),$this->getUri("menu_editmenuframe&n=".$v[IGK_FD_NAME]), "edit_16x16");
			IGKHtmlUtils::AddImgLnk($tr->addTd(),igk_js_post_frame($this->getUri("menu_dropmenu_ajx&n=".$v[IGK_FD_NAME])), "drop_16x16");

		}
		$c->addBr();

		$div = $c->addDiv();
		$a = IGKHtmlUtils::AddImgLnk($div,$this->getUri("menu_drop_selected_menu_ajx"), "drop_16x16");
		$a["onclick"] = "javascript: var q =  \$igk(this).getParentByTagName('form'); q.action = this.href; q.submit();  return false;";
		IGKHtmlUtils::AddBtnLnk($c, "btn.add", igk_js_post_frame($this->getUri("menu_add_menu_frame_ajx")));
		IGKHtmlUtils::AddBtnLnk($c,"btn.rmAll", $this->getUri("menu_Clearallmenu"));
		igk_html_toggle_class($tab);
	}
	private function _m_loadTableHeader($table, $oMenu=null)
	{
		$tr = $table->addTr();
		IGKHtmlUtils::AddToggleAllCheckboxTh($tr);
		$ct = $this->DataTableInfo;
		foreach($ct as $k)
		{
			$tr->add("th")->add('a', array("href"=>$this->getUri("menu_sortby&n=".$k->clName. (($oMenu==null)?null:"&m=".$oMenu) ),
			"onclick"=>igk_js_ajx_post_luri('table')))->Content = R::gets($k->clName);
		}
		$tr->add("th",array("style"=>"width:8px; "))->Content = IGK_HTML_WHITESPACE;
		$tr->add("th", array("style"=>"width:8px; "))->Content = IGK_HTML_WHITESPACE;
	}
	private function _m_otherMenuView($target)
	{

		$this->addTitle($target, "title.OtherMenuManager");
		$target->addHSep();

		igk_add_article($this,"menu.othermenudescription", $target->addDiv());
		$target->addHSep();
		$frm = $target->addForm();



		$li = $frm->add("ul")->addLi();
		$li->addLabel("lb.Menus", "clMenus");
		igk_html_build_select($li,"clMenus", array());


		$table = $frm->addTable();

		$this->_m_loadTableHeader($table, "d");

		$btndiv = $frm->addDiv();

		igk_html_toggle_class($table);

	}
	public function menu_drop_selected_menu()
	{
		$this->menu_drop_selected_menu_ajx();

	}
	public function menu_drop_selected_menu_ajx()
	{
		if (!$this->ConfigCtrl->IsConnected)
			return;
		$m = igk_getr("menu");
		$c = false;
		foreach($m as $k=>$n)
		{
			$n = strtoupper($n);
			if (isset($this->m_customMenu[$n]))
			{
				unset($this->m_customMenu[$n]);
				$c = true;
			}
		}
		if ($c)
		{
			$this->__saveConfigMenu();
			$this->_ReLoadMenu();
			igk_notifyctrl()->addMsg("menu ".$n. " removed");
		}
		else {
			igk_notifyctrl()->addError("menu ".$n. " not removed");
		}
		igk_navtocurrent();
	}

	public function menu_Clearallmenu()
	{
		if (igk_qr_confirm()){
			$this->m_customMenu = array();
			$this->__saveConfigMenu();
			$this->_ReLoadMenu();
			$this->View();
			igk_navtocurrent();
		}
		else{
			$frame = igk_frame_add_confirm($this, "menu_Clearallmenu_confirm_frame", $this->getUri("menu_Clearallmenu"));
			$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETEMENU_QUESTION);
		}
	}
	public function menu_dropmenu()
	{
		$n = igk_getr("n",IGK_STR_EMPTY);
		$n = strtoupper($n);
		if (isset($this->m_customMenu[$n]))
		{
			unset($this->m_customMenu[$n]);
			$this->__saveConfigMenu();
			$this->_ReLoadMenu();
			igk_notifyctrl()->addMsg("menu ".$n. " removed");
		}
		else {
			igk_notifyctrl()->addError("menu ".$n. " not removed");
		}
		$this->View();
		igk_navtocurrent();
	}

	public function menu_dropmenu_ajx()
	{
		if (igk_qr_confirm()){
			$this->menu_dropmenu();
		}
		else{
			$frame = igk_frame_add_confirm($this, __FUNCTION__."_frame", $this->getUri("menu_dropmenu_ajx"));
			$frame->Form->addInput("n", "hidden", igk_getr("n"));
			$frame->Form->Div->Content = R::ngets("msg.deletemenu.question_1", igk_getr("n"));
			$frame->RenderAJX();
		}
	}

	public function menu_editmenuframe($name=null)
	{
		$name = ($name==null)?igk_getr("n"):$name;

		if (!isset($this->m_customMenu[$name]))
				return ;

		$v_menu = $this->m_customMenu[$name];
		$frm = igk_getctrl(IGK_FRAME_CTRL)->createFrame("theme_editMenu_frame", $this);
		IGKHtmlUtils::AddItem($frm,  $this->App->Doc->body);
		$frm->Title = R::ngets("title.EditMenu", $name);
		$d = $frm->Box;
		$frm->ClearChilds();
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("save_menu");
		$div = $frm->addDiv();
		$index   = igk_getsv( igk_getv($v_menu,"clIndex"), '0');

		$div->addLi()->addSLabelInput(IGK_FD_NAME,"text",igk_getv($v_menu,IGK_FD_NAME), null, true);
		$div->addLi()->addSLabelInput("clIndex", "text",$index, array("isnumeric"=>true), true);
		$div->addLi()->addSLabelInput("clPage","text",igk_getv($v_menu,"clPage"), null);

		$this->__getEditController($div, igk_getv($v_menu,"clController"));

		$div->addLi()->addSLabelInput("clMethod","text",igk_getv($v_menu,"clMethod"));
		$div->addLi()->addSLabelInput("clGroup","text", igk_getv($v_menu,"clGroup"));
		$li = $div->addLi();
		$li->addLabel()->Content = R::ngets("clAvailable");

		$chb = $li->addInput("clAvailable", "checkbox");

		if (igk_getv($v_menu,"clAvailable")){
			$chb["checked"] = true;
		}

		$div->addInput("confirm", "hidden", 1);
		//Clear info
		$div->addHSep();
		$frm->addBtn("btn_add", R::ngets("btn.save"));
	}
	public function save_menu()
	{
		if (!igk_qr_confirm())
		{
			return;
		}
		$this->menu_add_menu(false);
		$this->View();
		igk_frame_close("theme_editMenu_frame", false);
	}
	public function __getEditController($div, $selectedMenu, $key = "lb.Controller", $remove=IGK_STR_EMPTY)
	{
			$tab = igk_sys_getuserctrls();
			$li = $div->addLi();
			$li->addLabel()->Content = R::ngets($key);
			$sel = $li->add("select");
			$sel["id"]=$sel["name"] = "clController";
			$sel->add("option", array("value"=>"none"))->Content = IGK_HTML_SPACE;
		if (count($tab) > 0)
			{

			foreach($tab as $v)
			{	if (strtolower($remove) == strtolower($v->getName()))
				   continue;
				$opt = $sel->add("option", array("value"=>$v->getName()));
				if ($selectedMenu == $v->getName())
					$opt["selected"] = true;
				$opt->Content = $v->getName();
			}
			}
			return $sel;
	}
	public function menu_add_menu_frame_ajx()
	{

		$frame = igk_add_new_frame($this, "theme_menu_add_menu_frame");
		$frame->Title = R::ngets("title.Menu");
		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("menu_add_menu");
		$div = $frm->addDiv();
		$div->addLi()->addSLabelInput(IGK_FD_NAME, "text",null, null, true);
		$div->addLi()->addSLabelInput("clIndex", "text",null, array("isnumeric"=>true), true);
		$div->addLi()->addSLabelInput("clPage");

		$this->__getEditController($div, null);
		$div->addLi()->addSLabelInput("clMethod");
		$div->addLi()->addSLabelInput("clGroup");
		$li = $div->addLi();
		$li->addLabel()->Content = R::ngets("clAvailable");
		$chb = $li->addInput("clAvailable", "checkbox");
		$chb["checked"] = true;
		//Clear info
		$div->addHSep();
		$frm->addBtn("btn_add", R::ngets("btn.Add"));
		igk_wl($frame->Render());
	}
	public function getDefaultEntry()
	{
		return array(
			IGK_FD_NAME=>null,
			"clIndex"=>0,
			"clController"=>null,
			"clMethod"=>null,
			"clPage"=>null,
			"clGroup"=>null,
			"clAvailable"=>null
		);
	}
	public function reg_menu($t, $saveconfig= true)
	{
		if (is_array($t) == false)
			return;
		extract($t);
		$clIndex = igk_getsv($clIndex, 0);
		$this->val->ClearChilds();
		if (IGKValidator::IsStringNullOrEmpty($clName)) $this->val->add("Name is null or empty");
		if (isset($this->m_customMenu[IGK_FD_NAME])){ $this->val->add("Menu already registered");}
		if ($this->val->HasChilds){
			$this->msbox->copyChilds($this->val);
		}
		else{
			$clName = strtoupper($clName);

			$this->m_customMenu[$clName] = array(
				IGK_FD_NAME=>trim($clName),
				"clIndex"=>trim($clIndex),
				"clController"=>trim($clController)=="none"?null:trim($clController),
				"clMethod"=>trim($clMethod),
				"clPage"=>trim($clPage),
				"clGroup"=>trim($clGroup),
				"clAvailable"=>(isset($clAvailable)?1:0)
		);

		$this->storeDBConfigsSettingMenu($saveconfig);
	}
	}
	private function storeDBConfigsSettingMenu($saveconfig=true)
	{
		if ($saveconfig)
		{
			if ($this->__saveConfigMenu())
			{
			//reload menu
				$this->_ReLoadMenu();
				igk_notifyctrl()->addMsgr("msg.globalmenuupdated");
				igk_debug_wln("notice:save and reloaded");
			}
			else{
				igk_debug_wln("error:not saved menu");
			}
		}
	}

	//add menu
	public function menu_add_menu($navigate=true)
	{
		$this->reg_menu($_REQUEST);
		$this->View();
		if ($navigate)
		{
			igk_navtocurrent();
		}
	}
	//load config menu from file
	private function _LoadConfigMenu()
	{
		$this->m_customMenu = array();
		$f = igk_io_syspath(IGK_MENU_CONF_DATA);
		$txt = IGKIO::ReadAllText($f);
		$lines = explode(IGK_LF, $txt);
		foreach($lines as $l)
		{
			if (empty($l))
				continue;
			$e = explode( igk_csv_sep(), $l);
			$name = strtoupper(trim($e[0]));
			if (empty($name))continue;
			$this->m_customMenu [$name] =array(
				IGK_FD_NAME=>$name,
				"clIndex"=>trim(igk_getv($e,1)),
				"clController"=>trim(igk_getv($e,2)),
				"clMethod"=>trim(igk_getv($e,3)),
				"clPage"=>trim(igk_getv($e,4)),
				"clGroup"=>trim(igk_getv($e,5)),
				"clAvailable"=>trim(igk_getv($e,6)),
				);
		}
	}
	function __ClearConfigMenu($storeconfig=true)
	{
		$this->m_customMenu = array();
		$this->storeDBConfigsSettingMenu($storeconfig);
	}
	//save config file to file
	function __saveConfigMenu()
	{
		igk_debug_wln("warning: _saveConfigMenu [".igk_count($this->m_customMenu )."]");
		$out = IGK_STR_EMPTY;
		$i = false;
		$line = null;
		foreach($this->m_customMenu as $k=>$v)
		{
			if ($i )
				$out .= "\n";
			$line = IGK_STR_EMPTY;
			$v_sep = false;
			foreach($v as $c=>$m)
			{
				$m = trim($m);
				if ($v_sep){
					$line .= igk_csv_sep();
				}
				else{
					$v_sep = true;
				}
				if (!empty($m))
					$line .= $m;

			}
			$out .= $line;
			$i =true;
		}

	  $v =  igk_io_save_file_as_utf8(igk_io_currentRelativePath(IGK_MENU_CONF_DATA), $out, true);
	  if ($v)
	  igk_sys_regchange(self::MENU_CHANGE_KEY, $this->m_menuChangedState);
	  return $v;
	}
	private function _initMenu($ul, $menu,  &$pages =null){//init menu in menu item in IGKMenuCtrl
		IGKMenuUtils::InitMenu($ul, $menu, $pages);
	}

	//-------------------------------------------------------------------
	//select root menu
	//-------------------------------------------------------------------
	public function selectGlobalMenu($page, $index=0){	//manage web global menu
		$page = strtolower($page);
		if (isset($this->m_Pages[$page]))
		{
			if ($this->m_menu_selected !=null)
			{
				$this->m_menu_selected["class"] = "-igk-menu_selected";
			}
			$v_rootmenu  = null;
			$v_p = $this->m_Pages[$page];
			if (!is_array($v_p))
				$v_rootmenu = $this->_getRootMenu($v_p);
			else {
				if (isset($v_p[$this->m_CurrentPageIndex]))
					$v_rootmenu = $this->_getRootMenu($v_p[$this->m_CurrentPageIndex]);
			}

			if ($v_rootmenu){
				$this->m_menu_selected = $v_rootmenu->MenuItem;
				$this->m_menu_selected["class"] = "+igk-menu_selected";
			}
		}
		else{
			if (IGKServerInfo::IsLocal())
			{
				//igk_wln($this->m_Pages);
				igk_notifyctrl()->addError("[web_global_menu] not define [".$page."] - ". igk_io_request_uri());
				//igk_die("web_global_menu menu not define .".$page);
			}
		}
	}

	//select root menu
	public function selectConfigMenu($page, $fromcontext=null)
	{
		$page = strtolower($page);
		$v_page = $this->getConfigSelectedPage();
		if ($v_page != $page){
			
			$menu = $this->getConfigSelectedMenu();
			if ($menu)
				$menu["class"]="-igk-active";
			
			$menu = null;
			//get the selected menus
			
			
			$this->setConfigSelectedPage($page);
			$this->setConfigSelectedMenu($menu);
		
		}
	}

	//retreive the root menu of a menu item
	private function _getRootMenu($menu)
	{
		if (($menu == null) || is_array($menu))
			return null;
		if ($menu->MenuParent === null)
			return $menu;
		return $this->_getRootMenu($menu->MenuParent);
	}

	public function setParentView($node)
	{
		if ($node)
		{
	
			IGKHtmlUtils::AddItem($this->m_menuTargetNode,$node);
		}
	}
	
		///<summary>load configuration menu</summary>
	private function __loadConfigurationMenuSetting()
	{
		$tab = array();
		$f = IGK_LIB_DIR."/".IGK_DATA_FOLDER."/config.menu.xml";
		if (file_exists($f))
		{
			$d =  igk_createNode("div");
			$d->Load(igk_io_read_allfile($f));//ff($f));
			$e = igk_getv($d->getElementsByTagName("configmenu"), 0);
			$t = null;
			$c = $e ? $e->Childs:null;
			foreach($c as $k=>$v)
			{
				$s = array();
				$ch = $v->Childs;
				if ($ch ){
				foreach($ch as $c=>$m)
				{
					$s[$m->TagName] = $m->innerHTML;
				}
				$tab[$v->TagName] = (object)$s;
				}
			}
		}
		return (object)$tab;
	}
	
	private function _initSysConfigMenu(){//initialize administration configuration menu
	
		//init configuration menu setting
		igk_set_env("sys://configs/menu", $this->__loadConfigurationMenuSetting());
		
	
		$tab = array();
		$ctab = array();
		$v_ctab = array();
		$v_Menus = array();
		$v_CPages = array();
		//create menu from configs files
		$v_confctrl = igk_getconfigwebpagectrl();


		foreach(igk_app()->getControllerManager()->getControllers() as $k=>$v)
		{
			if ($v !== $v_confctrl){
				$cm = $v->initConfigMenu();
				if ($cm !== null){
					$v_ctab = array_merge($v_ctab, $cm);
				}
			}else{
				$ctab = $v->initConfigMenu();
			}
			
		}
		
		
		// igk_wln(igk_count($v_ctab));
		// igk_wln(($ctab));
		// igk_exit();
		
		
		//register element
		//IGKMenuItem::Sort($tab);
		$v_sortByIndex = array("IGKMenuItem", "SortMenuByIndex");
		$v_sortByName = array("IGKMenuItem", "SortMenuByName");
		$v_sortByDisplayText = array("IGKMenuItem", "SortMenuByDisplayText");

		// $tab = array_merge($v_cmenu, $tab);
		// // igk_usort($tab, $v_sortByName);

		// $v_list = array();
		// foreach($tab as $v)
		// {
			// $p = $this->_getParentName($v->Name);

		// if (isset($v_list[$p]))
			// {
				// $v_list[$p]->add($v);
			// }
			// else{
				// $v_list[$v->Name] = $v;
			// }
		// }
		// igk_usort($tab, $v_sortByIndex);
		// foreach($tab as $t=>$m)
		// {
			// if ($m->MenuParent ==null){
			// //for root menu only
				// $this->m_Menus[$m->Name] = $m;
				// $this->_initMenu($ul, $m, $this->m_Pages);
			// }
		// }
		// //init menu setting for drop down menu management
		// $sr = $ul->add("script")->Content = <<<EOF
// if (window.igk.winui.menu){	window.igk.winui.menu.init();}
// EOF;

		//init . config menu
		$v_configTargetNode = igk_createNode("div");
		$v_configTargetNode["class"] = "igk-config-menu-font";
		$v_configTargetNode->Index = -9999;
		$v_configTargetNode->clearChilds();


		
		//on config menu load configuration menu
		
		$div = $v_configTargetNode->addLi()->addDiv()->setClass("collapse");
		$this->_initConfigMenu($v_CPages, $ctab, $div->add("ul"), false);

		

		

		// $v_configTargetNode->add("li", array("class"=>"cnf-menu-sep"))->Content = IGK_HTML_SPACE;
		// $div = $v_configTargetNode->addLi()->addDiv();

		igk_usort($v_ctab, $v_sortByDisplayText);
		$this->_initConfigMenu($v_CPages, $v_ctab, $v_configTargetNode->addLi()->add("ul"), true);

		//igk_wln($v_ctab);
		
		
		// $v_configTargetNode->RenderAJX();
		// igk_exit();
		$sr = $v_configTargetNode->addBalafonJS();
		$sr->Content = <<<EOF
ns_igk.readyinvoke('igk.configmenu.init', ns_igk.getParentScript());
EOF;
		return $v_configTargetNode;

		
	}
	public function setConfigParentView($node)
	{
		if ($node)
		{
			
			if (!$this->getFlag(self::CONFIG_MENU_FLAG)){				
				$this->setFlag(self::CONFIG_MENU_FLAG, 1);
				$b = $this->_initSysConfigMenu();
				$this->m_configTargetNode = $b;
			}			
			IGKHtmlUtils::AddItem($this->m_configTargetNode, $node);
		}
	}
	protected function initTargetNode(){
		$ul =  igk_createNode("ul");
		$this->m_configTargetNode =  igk_createNode("ul");
		$this->m_menuTargetNode =  igk_createNode("ul");
		return $ul;
	}
	protected function InitComplete(){

		parent::InitComplete();
		//register for menu list changed
		$this->m_CurrentPage = igk_gettv($this->App->Configs->menu_defaultPage, IGK_DEFAULT_VIEW);
		igk_sys_regchange(self::MENU_CHANGE_KEY, $this->m_menuChangedState);
		//load menu

		$this->_LoadMenu();
		$this->setMenuview();
		if (igk_count($this->m_Pages)){
			$this->selectGlobalMenu($this->m_CurrentPage);
		}
	}
	//set the menu host ctrl
	public function setMenuhostCtrl($value)
	{
		if ($this->m_menuHostCtrl != $value)
		{

			if (is_object($this->m_menuHostCtrl))
			{
				$this->m_menuHostCtrl->unregView($this);
			}
			$this->m_menuHostCtrl = $value;
			if ($this->m_menuHostCtrl!=null)
				$this->m_menuHostCtrl->regView($this, "setMenuview");
		}
	}
	public function setMenuview()
	{
		if ($this->App->Configs->menuHostCtrl)
		{
			$menu_host =  igk_getctrl($this->App->Configs->menuHostCtrl);
			if ($menu_host !=null )
			{
				$this->setMenuhostCtrl($menu_host);
				$this->setParentView($menu_host->TargetNode);
			}
		}

	}
	private function _ReLoadMenu()
	{
		$this->_LoadMenu();
		$this->selectConfigMenu($this->m_menu_cselected? $this->m_menu_cselected->Name :"default");
		$this->View();
	}
	private function _LoadMenu()
	{
		//disable menu loading
		return; 
		
		
		//igk_wln("load menu");
		//load menu from data base
		$this->_LoadConfigMenu();

		//setup menu to match menu item
		$v_cmenu = array();
		foreach($this->m_customMenu as $k=>$v)
		{
			if (igk_getv($v,"clAvailable"))
			{
			$v_cmenu[] = new IGKMenuItem($v[IGK_FD_NAME],
			igk_getv($v,"clPage"),
			igk_getv($v,"clMethod"),
			igk_getv($v,"clIndex"),
			null,
			igk_getv($v,"clController"),
			igk_getv($v,"clGroup")
			);
			}
		}

		$ul = $this->m_menuTargetNode;
		$ul["id"] = "web_site_menu";
		$ul["class"] = "menu menufont menu_forecl menu_bgcl";
		$ul->Index = -9999;
		$ul->ClearChilds();






		$tab = array();
		$ctab = array();
		$v_ctab = array();
		$this->m_Menus = array();
		$this->m_Pages = array();
		//create menu from configs files
		$v_confctrl = igk_getconfigwebpagectrl();


		foreach(igk_app()->getControllerManager()->getControllers() as $k=>$v)
		{
			//
			//load config menu frame
			//

			$m = $v->initMenu();
			if ($v !== $v_confctrl)
			{
				$cm = $v->initConfigMenu();
				if ($cm !== null)
					$v_ctab = array_merge($v_ctab, $cm);
			}
			else{
				$ctab = $v->initConfigMenu();
			}

			if ($m !== null)
				$tab = array_merge($tab, $m);

		}
		//register element
		//IGKMenuItem::Sort($tab);
		$v_sortByIndex = array("IGKMenuItem", "SortMenuByIndex");
		$v_sortByName = array("IGKMenuItem", "SortMenuByName");
		$v_sortByDisplayText = array("IGKMenuItem", "SortMenuByDisplayText");

		$tab = array_merge($v_cmenu, $tab);
		igk_usort($tab, $v_sortByName);

		$v_list = array();
		foreach($tab as $v)
		{
			$p = $this->_getParentName($v->Name);

		if (isset($v_list[$p]))
			{
				$v_list[$p]->add($v);
			}
			else{
				$v_list[$v->Name] = $v;
			}
		}
		igk_usort($tab, $v_sortByIndex);
		foreach($tab as $t=>$m)
		{
			if ($m->MenuParent ==null){
			//for root menu only
				$this->m_Menus[$m->Name] = $m;
				$this->_initMenu($ul, $m, $this->m_Pages);
			}
		}
		//init menu setting for drop down menu management
		$sr = $ul->add("script")->Content = <<<EOF
if (window.igk.winui.menu){	window.igk.winui.menu.init();}
EOF;

		//init . config menu
		$v_configTargetNode = $this->m_configTargetNode;
		$v_configTargetNode["class"] = "igk-config-menu-font";
		$v_configTargetNode->Index = -9999;
		$v_configTargetNode->ClearChilds();


		//on config menu load configuration menu
		$g = array();
		$div = $v_configTargetNode->addLi()->addDiv();
		$this->_initConfigMenu($g, $ctab, $div->add("ul"), false);


		$v_configTargetNode->add("li", array("class"=>"cnf-menu-sep"))->Content = IGK_HTML_SPACE;
		$div = $v_configTargetNode->addLi()->addDiv();

		igk_usort($v_ctab, $v_sortByDisplayText);
		$this->_initConfigMenu($g, $v_ctab, $div->add("ul"), true);

		//igk_exit();
		$sr = $v_configTargetNode->addBalafonJS();
		$sr->Content = <<<EOF
ns_igk.readyinvoke('igk.configmenu.init', ns_igk.getParentScript());
EOF;

	}

	//private function _loadSystemConfigMenu($t){
		//on config menu load configuration menu
		// $g = array();
		// $div = $t->addLi()->addDiv();
		// $this->_initConfigMenu($g, $ctab, $div->add("ul"), false);


		// $t->add("li", array("class"=>"cnf-menu-sep"))->Content = IGK_HTML_SPACE;
		// $div = $t->addLi()->addDiv();

		// igk_usort($v_ctab, $v_sortByDisplayText);
		// $this->_initConfigMenu($g, $v_ctab, $div->add("ul"), true);
	//}
	private function _initConfigMenu(& $e , $v_ctab, $cul, $bygroup=false)
	{	
		if ($bygroup){
			$group  = array();
			foreach($v_ctab as $t=>$m)
			{
				$gp = $m->Group;
				if (!empty($gp)){
					if (!isset($group[$gp]))
					{
						$group[$gp] = array();
					}
					$group[$gp][] = (object)array("Menu"=>$m, "Node"=>IGK_STR_EMPTY);
				}else{
					igk_wln("no group ".$m);
				}
			}
			$div = $cul->addAccordeon();
			foreach($group as $k=>$v){

					$ul = igk_createNode("div");
					$t = igk_createNode();
					$t["class"]="igk-row thead";
					$t->addDiv()->setClass("ico ".strtolower($k));
					$t->addDiv()->Content = R::ngets("group.".$k);
					$pan = $div->addPanel( $t,$ul, false);
					$pan->setClass("fmenu-h");

					foreach($v as $t=>$m)
					{
						$this->_initMenu($ul , $m->Menu, $e);
						$e[$m->Menu->Name] = $m->Menu;
					}
			}
		}
		else{
			foreach($v_ctab as $t=>$m)
			{
				$this->_initMenu($cul , $m, $e);
				$e[$m->name] = $m;
		
			}			
		}
	}


	private function _getParentName($name){
		return IGKMenuUtils::GetParentName($name);
	}

}
///<summary>Controller used to shared content between all created document</summary>
final class IGKSharedContentHtmlItemCtrl extends IGKControllerBase
{
	private $m_entity;
	public function getEntity($n) {
		return igk_getv($this->m_entity, $n);
	}
	public function __construct(){
		parent::__construct();
		$this->m_entity = array();
	}
	public function getName(){ return IGK_SHARED_CONTENT_CTRL; }
	protected function InitComplete(){
		parent::InitComplete();
		$this->regEntity("notifybox", new IGKHtmlSharedNotifyDialog());
	}
	protected function initTargetNode(){
		$c = new IGKHtmlSharedContentNode($this);
		return $c;
	}
	public function getEntities(){
		return $this->m_entity;
	}
	public function regEntity($name, $node){

		$this->m_entity[$name] = $node;
	}
}

///<summary> Shared Content Node</summary>
final class IGKHtmlSharedContentNode extends IGKHtmlItem
{
	private $m_ctrl;
	public function __construct($ctrl){
		parent::__construct("igk-shared-content");
		$this->m_ctrl = $ctrl;
	}
	public function getIsRenderTagName(){return false;}

	protected function __getRenderingChildren($o=null){
		$t = array();
		foreach ($this->m_ctrl->getEntities() as $k=>$v)
		{
			if ($v->IsVisible){
				$t[] = $v;
			}
		}
		return $t;
	}
}
///<summary>shared notify content notify Dialog</summary>
final class IGKHtmlSharedNotifyDialog extends IGKHtmlItem
{
	private $m_Message;
	private $m_title;
	public function getTitle(){return $this->m_title; }
	public function getMessage(){return $this->m_Message; }

	public function __construct()
	{
		parent::__construct("div");
		$this->setIsVisible(false);
		$this["class"] = "igk-notify-box";
		$this->addDiv()->setClass("title")->Content = new IGKValueListener($this, 'Title');
		$this->addDiv()->setClass("msg")->Content = new IGKValueListener($this, 'Message');
		$this->addScript()->Content = <<<EOF
if (ns_igk)ns_igk.winui.notify.init();
EOF;
	}
	public function show($title, $message)
	{
		$this->m_title = $title;
		$this->m_Message = $message;
		$this->setIsVisible(true);
		return $this;
	}
	protected function __AcceptRender($o=null){
		return false;
	}
}
final class IGKOtherMenuCtrl extends IGKControllerBase
{
	private $m_allMenus;
	public function getMenus(){return $this->m_allMenus;}
	protected function InitComplete(){
		parent::InitComplete();
		$this->m_allMenus = IGKMenu::GetMenus();
	}
	public function getIsVisible(){return false;}
	public function getName(){return IGK_OTHER_MENU_CTRL; }
}

final class IGKHumanCtrl extends IGKNonVisibleControllerBase{
	public function getDataTableName(){return IGK_TB_HUMAN; }
	public function getName(){return IGK_HUMAN_CTRL; }
	public function initDataTentry($db){

	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>1, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clGender", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>1,
		"clNotNull"=>true, IGK_FD_DESC=>'m or f for male or female',
		"clInsertFunction"=>'LOWER',
		"clUpdateFunction"=>'LOWER'
		)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clFirstName", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>100)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clLastName", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>100, "clNotNull"=>true,
		"clInsertFunction"=>'UPPER',
		"clUpdateFunction"=>'UPPER'))
		);
	}
}

///<summary>used to manage data type</summary>
final class IGKDataTypesCtrl extends IGKNonVisibleControllerBase{
	public function getName(){
		return IGK_DATA_TYPE_CTRL;
	}
	public function __construct(){
		parent::__construct();
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableName(){
		return IGK_TB_DATATYPES;
	}
	public function getData($i){//by id
		$r = igk_db_table_select_row($this->DataTableName, $i, $this);
		return $r;
	}
	public function getInfo($n){//by name
		$r = igk_db_table_select_where($this->DataTableName, array(IGK_FD_NAME=>$n), $this)->getRowAtIndex(0);
		return $r;
	}
	public function getDataTableInfo(){
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>1, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255, "clIsUnique"=>true, "clNotNull"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_DESC, IGK_FD_TYPE=>"Text", IGK_FD_DESC=>"data description")),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clRegex", IGK_FD_TYPE=>"Text", "clDescription"=>"Regex used to validate data" )),
		);
	}
	protected function initDataEntry($db, $tbname=null){
		$n = $this->getDataTableName();
		$db->insert($n, array(IGK_FD_NAME=>"email", IGK_FD_DESC=>"email"));
		$db->insert($n, array(IGK_FD_NAME=>"fax", IGK_FD_DESC=>"fax data"));
		$db->insert($n, array(IGK_FD_NAME=>"uri", IGK_FD_DESC=>"uri"));
		$db->insert($n, array(IGK_FD_NAME=>"gsm", IGK_FD_DESC=>"gsm number"));
		$db->insert($n, array(IGK_FD_NAME=>"tel", IGK_FD_DESC=>"phone number"));
		$db->insert($n, array(IGK_FD_NAME=>"string", IGK_FD_DESC=>"string data"));
		$db->insert($n, array(IGK_FD_NAME=>"number", IGK_FD_DESC=>"integer"));
		$db->insert($n, array(IGK_FD_NAME=>"float", IGK_FD_DESC=>"float number"));
		$db->insert($n, array(IGK_FD_NAME=>"json", IGK_FD_DESC=>"json data"));

		$tab = igk_getctrl(IGK_MYSQL_DB_CTRL)->getAllTableNames();
		foreach($tab as $k=>$v){
			if ($v !== $n){
				$db->insert($n, array(IGK_FD_NAME=>$v,IGK_FD_DESC=>'datatable'));
			}
		}
	}
	protected function InitComplete(){
		parent::InitComplete();
		igk_notification_reg_event(IGK_NOTIFICATION_DB_CHANGED,array($this, 'dbChange'));
		igk_notification_reg_event(IGK_NOTIFICATION_DB_TABLECREATED, array($this, 'tbCreated'));
		igk_notification_reg_event(IGK_NOTIFICATION_DB_TABLEDROPPED, array($this, 'tbDropped'));
	}
	public function tbDropped($o,$e){
		$n = $this->getDataTableName();
		if ($n!== $e){
			$ad = igk_get_data_adapter($this);
			if ($ad->tableExists($n)){
				igk_db_delete($this, $n, array(IGK_FD_NAME=>$e));
			}
		}
		else {
			//igk_notification_unreg_event(IGK_NOTIFICATION_DB_TABLEDROPPED, $this, 'tbDropped');
		}
	}
	///<summary> callback for table created </summary>
	public function tbCreated($o,$e){

		$n = $this->getDataTableName();
		if ($n!== $e)		{
			$ad = igk_get_data_adapter($this);
			if ($ad->tableExists($n)){
				$r = 0;
				$r = igk_db_insert_if_not_exists($this, $n,
						array(IGK_FD_NAME=>$e,IGK_FD_DESC=>'datatable'),
						array(IGK_FD_NAME=>$e));
			}
		}
	}
	public function dbChange(){
		$dbu = new IGKDbUtility($this);
		if ($dbu->connect()){
			$n = $this->getDataTableName();
			$tab  = igk_getctrl(IGK_MYSQL_DB_CTRL)->getAllTableNames();
			foreach($tab as $k=>$v){
				if ($v !== $n){
					igk_db_insert_if_not_exists($this, $n,
						array(IGK_FD_NAME=>$v,IGK_FD_DESC=>'datatable'),
						array(IGK_FD_NAME=>$v)
					);
				}
			}
			$dbu->close();
		}
	}

}

///<summary>represent the menu object</summary>
final class IGKMenu extends IGKObject{
	var $Name;
	var $m_menus;

	public static $sm_menus;

	public function getMenuFile(){
		return igk_io_baseDir(IGK_DATA_FOLDER ."/menu".$this->Name."conf.csv");
	}
	public function __construct($name)
	{
		$this->Name = $name;
		$this->m_menus = array();
	}


	public static function GetMenus()
	{

		//get all menu from diffrent mage
		if (self::$sm_menus == null)
		{
			self::$sm_menus = array();
			//
			$d = igk_io_getFiles(igk_io_baseDir(IGK_DATA_FOLDER), IGK_MENUS_REGEX);
			if ($d){
				foreach($d as $k=>$v)
				{
					$n = igk_regex_get(IGK_MENUS_REGEX, "name", $v);
				}
			}
		}
		return self::$sm_menus;
	}

	public function loadMenu(){

	}
	public function storeMenu(){

	}
	public function addMenu($name)
	{
		$n = new IGKMenuItem($name, null,null);
		$this->m_menus[$name]  = $n;
		return $n;
	}
}

// class IGKMenuItem extends IGKObject{

	// var $Name;
	// var $PageIndex;
	// var $m_Parent;

	// private $m_Uri;
	// private $m_Index;
	// private $m_key;
	// private $m_menuItem;
	// private $m_CurrentPage;
	// private $m_Childs;
	// private $m_group;
	// private $m_Visible;
	// private $m_VisibleChangedEvent;
	// private $m_controller;
	// private $m_node;
	
	// public function __toString(){
		// return get_class($this). " [ ".$this->Name." ] ";
	// }
	// //get the group name
	// public function getGroup(){return $this->m_group;}
	// public function setGroup($group){$this->m_group = $group; return $this; }
	// public function & getMenuParent(){return $this->m_Parent;}
	// public function getKey(){			return $this->m_key;	}
	// public function HasChilds(){return (count($this->m_Childs)>0);}
	// public function setMenuItem($menu){
		// $this->m_menuItem = $menu;
		// $this->updateView();

	// }
	// //menu item
	// public function getMenuItem(){return $this->m_menuItem; }
	// //MENUITEM CURRENT PAGE
	// public function getCurrentPage(){return $this->m_CurrentPage; }
	// public function getIndex(){return $this->m_Index;}  //menu index
	// public function getIsVisible(){
	// if ($this->m_menuItem)
		// return $this->m_menuItem->getIsVisible();
	// return false;
	// }
	// //get the html current node
	// // <a></a><ul>...child...</ul>
	// public function getNode(){return $this->m_node; }
	// protected function setNode($value){ $this->m_node = $value; }

	// public function getChilds(){ return $this->m_Childs;	}

	// public function getIsMenuSelected(){
		// $c = $this->m_menuItem["class"];
		// if (!$c)
			// return false;
		// return $c->contain("igk-menu_selected");
	// }
	// public function getUri(){
		// $uri = IGK_STR_EMPTY;
		// if (!empty($this->m_Uri)){
			// $uri .= $this->m_Uri;

			// if (IGKValidator::IsUri($uri)){
				// return $uri;
			// }

		// }
		// $quri = "";
		// if (!empty($this->m_CurrentPage)){
				// $quri .= "p=".$this->m_CurrentPage;
		// }
		// $ctrl = $this->m_controller;
		// if ($ctrl!=null){
			// return $ctrl->getUri($uri.(!empty($quri)? "&".$quri : ""));
		// }
		// return  $uri.(!empty($quri)? "?".$quri : "");
	// }
	// public function setIsVisible($value){
		// if ($this->m_menuItem && ($this->m_controller == null))
			// $this->m_menuItem->setIsVisible($value);
		// }
	// public static function CreateMenu($attributes )
	// {
		// if (!is_array($attributes))
		// return null;
		// $n = igk_getv($attribute,"name");
		// $uri = igk_getv($attribute,"uri");
		// $i = igk_getv($attribute,"index");
		// $p = igk_getv($attribute,"page");
		// if (empty($n) || empty($uri) || empty($p))
			// return null;
		// $menu = new IGKMenuItem($n, $p, $uri, $i);
		// foreach($attributes as $k=>$v)
		// {
			// $menu->$k = $v;
		// }
		// return $menu;
	// }
	// public function __construct($name,$CurrentPage, $uri, $index=0, $key=null, $controller=null, $group=null, $defaulttag="li"){
	// $this->m_Parent = null;
	// $this->m_Childs = array();
	// $this->Name = strtoupper($name);
	// $this->m_Uri = $uri;
	// $this->m_Index = $index;
	// $this->m_CurrentPage = strtolower($CurrentPage);
	// $this->m_group = $group;
	// $this->m_controller = ($controller!=null)? igk_getctrl($controller, false):null;
	// $this->PageIndex = 0;
	// $this->m_node =  igk_createNode($defaulttag , array("class"=>strtolower(str_replace(".","_","menu_".$this->Name))));
	// $item = $this->node->addNode("a", array("href"=>new IGKValueListener($this, "Uri")));



	// if($key == null)
		// $this->m_key =  preg_match("/^menu./i", $name) ? $name : strtoupper("Menu.".$name);
	// else
		// $this->m_key = $key ;

	// $this->m_Visible = true;
	// $this->m_VisibleChangedEvent = new IGKEvents($this, "VisibleChanged");
	// //$this->m_VisibleChangedEvent->add($this, "_visibleChanged");

	// if ($this->m_controller !=null)
	// {
		// igk_getctrl(IGK_MENU_CTRL)->addPageChangedEvent($this, "updateview");
		// igk_app()->Session->addUserChangedEvent($this, "updateview");
	// }
	// $item->addspan()->Content = R::ngets($this->Key);
	// $this->setMenuItem($item);

	// }
	// public function updateUri($adduri)
	// {
		// $this->MenuItem["href"] = $this->Uri.$adduri;
	// }
	// public function updateview(){
		// if ($this->m_controller !=null){
			// $this->m_menuItem->getIsVisible($this->m_controller->isAvailable);
			// $this->m_menuItem->getParentNode()->setIsVisible($this->m_controller->isAvailable);
		// }
	// }

	// public function add($menu){
		// if ($menu == null)return;
		// $this->_removeParent($menu);
		// $this->m_Childs[] = $menu;
		// $menu->m_Parent = $this;
	// }
	// public function remove($menu){
		// for($i = 0;$i<count($this->Childs); $i++){
			// if ($this->Childs[$i] === $menu){
			// unset($this->m_Childs[$i]);
			// $this->m_Childs = array_values($this->Childs);
			// $menu->m_Parent = null;
			// break;
			// }
		// }
	// }
	// //<summary>Clear menu item</summary>
	// public function Clear(){//Clear menu item
		// $this->m_Childs = array();
	// }
	// private function _removeParent($menu){
		// if (($menu != null) && ($menu->MenuParent !=null)){
			// $menu->getMenuParent()->remove($menu);
		// }
	// }
	// //sort menu by index and by name
	// //---------------------------------
	// public static function SortMenuByIndex($a, $b){
		// if ($a->Index < $b->Index)
			// return -1;
		// else if ($a->Index == $b->Index)
			// return self::SortMenuByName($a, $b);
		// return 1;
	// }
	// public static function SortMenuByName($a, $b)
	// {
		// return strcmp($a->Name, $b->Name);
	// }
	// public static function SortMenuByDisplayText($a, $b)
	// {
		// return strcmp(R::ngets("menu.".$a->Name)->getValue(), R::ngets("menu.".$b->Name)->getValue());
	// }
	// public function sortChilds()
	// {
		// igk_usort($this->m_Childs, array("IGKMenuItem", "SortMenuByIndex"));
	// }
// }

///<summary>udpate menuitem class</summary>
class IGKMenuItem{
	private $_;//flags
	
	const NAME =0x1; //menu name
	const GP_NAME  = 0x2; //group name
	const URI  = 0x3; //group name
	const POSITION  = 0x4; //group name
	const TITLE  = 0x5; //group name
	const PAGE  = 0x6; //group name
	
	public function __construct($name, $title=null, $uri=null, $position=10, $imagekey=null, $t=null, $group=null){		
		$this->_ = array();
		$this->setFlag(self::NAME, $name);
		$this->setFlag(self::TITLE, $title ?? $name);
		$this->setFlag(self::PAGE, $title);
		$this->setFlag(self::POSITION, $position);
		$this->setFlag(self::URI, $uri);
		$this->setFlag(self::GP_NAME, $group);
		
	}
	public function __get($n){
		if (method_exists($this, "get".$n)){
			return call_user_func_array(array($this, "get".$n), array());
		}
		igk_die(__CLASS__."::: not defined ".$n);
	}
	public function __call($n, $args){
		igk_die(__CLASS__."::: NO EXTRA ".$n);
	}
	public function __set($n, $v){
		igk_die("can't set : ".$n);
	}
	public function setFlag($p, $v){
		if ($v==null){
			unset($this->_[$p]);
		}else
			$this->_[$p]=$v;
	}
	
	public function getCurrentPage(){
		return igk_getv($this->_, self::PAGE);
	}
	public function getName(){
		return igk_getv($this->_, self::NAME);
	}
	public function getIndex(){
		return igk_getv($this->_ , self::POSITION);
	}
	public function getGroup(){
		return igk_getv($this->_ , self::GP_NAME);
	}
	public function getUri(){
		return igk_getv($this->_ , self::URI);
	}
	public function getTitle(){
		return igk_getv($this->_ , self::TITLE);
	}
	public function getHasChilds(){
		return 0;
	}
	
	public static function SortMenuByIndex($a, $b){
		if ($a->Index < $b->Index)
			return -1;
		else if ($a->Index == $b->Index)
			return self::SortMenuByName($a, $b);
		return 1;
	}
	public static function SortMenuByName($a, $b)
	{
		return strcmp($a->Name, $b->Name);
	}
	public static function SortMenuByDisplayText($a, $b)
	{
		return strcmp(R::ngets("menu.".$a->Name)->getValue(), R::ngets("menu.".$b->Name)->getValue());
	}
	
	
	public function setGroup($gpName){
		$this->setFlag(self::GP_NAME, $gpName);
		return $this;
	}
	public function add(){
		igk_die(__METHOD__."");
	}
	public function updateUri($u){
		// igk_die(__METHOD__." =  ".$u);
	}
	
	public function __toString(){
		return __CLASS__."[".$this->getName()."]";
		
	}
}

class IGKMenuItemObject extends IGKObject{
	private $m_uri;
	private $m_subMenus;

	public function getUri(){return $this->m_uri; }
	public function getSubmenu(){return $this->m_subMenus; }
	public function __construct($uri, $submenu=null){
		$this->m_uri = $uri;
		$this->m_subMenus = $submenu;
	}
}


final class IGKHtmlTargetValue extends IGKObject implements IIGKHtmlGetValue
{
	private $m_target;
	public function setTarget($d){
		$this->m_target = $d;
	}
	public function __construct($d){
		$this->m_target = $d;
	}
	public function getValue($options=null){//get target value
		return IGKString::Format("#{1}", $this->m_target["id"]);
	}
}

///<summary>represent menu build utility class.</summary>
final class IGKMenuUtils
{

	public static function BuildDbMenu($target, $table, $tab){
		self::BuildMenu($target, $tab, $menu, $pages);
	}
	public static function BuildMenu($targetNode, $tab, &$menus, &$pages){//menu utils build menu
			$v_list = array();
			$v_rlist = array();

			//init root parent list. by registering
			foreach($tab as $v)
			{
				$n = strtolower($v->Name);
				$p = strtolower(self::GetParentName($v->Name));
				// igk_wln($n);
				if (isset($v_list[$p]))
				{
					$v_list[$p]->add($v);
				}
				else{
					$v_list[$n] = $v;

					if(isset($v_rlist[$n])){
						//copy to sub childs
						foreach($v_rlist[$n] as $tk=>$tv){
							$v->add($tv);
						}
						unset($v_rlist[$n] );
					}
					else {
						if (isset($v_rlist[$p]))
						{

							$tb = $v_rlist[$p];
							$tb[] = $v;
						}
						else
							$tb = array($v);
						$v_rlist[$p] =$tb;
					}
				}
			}
			//igk_wln(igk_count($v_rlist["menu"]));
			// igk_exit();
			igk_usort($tab, array("IGKMenuItem", "SortMenuByIndex"));
			foreach($tab as $t=>$m)
			{
				if ($m->MenuParent ==null){
					//for root menu only
					$menus[$m->Name] = self::InitMenu($targetNode, $m, $page);
				}
			}
	}

	//init menu list
	public static function InitMenu($target, $menu, & $pages){//menu utils init the menu base
	
		$add_uri = null;
		$node  = null;
		if (isset($page))
		{

				$page = strtolower($menu->CurrentPage);
				if (isset($pages [$page]))
				{
					if (!is_array($pages [$page]))
					{
						$cp = $pages [$page];
						$cp->PageIndex = 0;
						$pages[$page] = array($cp);
						$cp->MenuItem["href"] = $cp->MenuItem["href"];//."&pageindex=0";
					}
					$pages [$page][] = $menu;
					$menu->PageIndex = count($pages [$page])-1;
					$add_uri = "&pageindex=".$menu->PageIndex;

					if ($menu->MenuParent)
					{
						$add_uri = strtolower("&v=".substr($menu->Name, strlen($menu->MenuParent->Name)+1));
					}
				}
				else{
					$pages [$page] = $menu;
				}

		}
		if ($add_uri);
			$menu->updateUri($add_uri);
		if ($menu->HasChilds)
		{
			$menu->sortChilds();
			$menucl = "igk-submenu submenu_".self::GetMenuLevel($menu);
			$v_ul = $menu->Node->add("ul")->setClass($menucl);
			foreach($menu->getChilds() as $k)
			{
				$v = self::InitMenu($v_ul, $k, $pages);
			}
		}
		//add node to uls
		$target->add("li")->add('a')->setAttribute("href", $menu->getUri())->Content = R::ngets("menu.".$menu->Name);
		
		//$target->add($menu->Node);
	}
	public static function GetMenuLevel($menu){
		$q = $menu->MenuParent ;
		$i = 0;
		while($q !== null){
			$q = $q->MenuParent;
			$i++;
		}
		return $i;
	}
	///<summary>get parent name of  the menu</summary>
	public static function GetParentName($name){
		$t = explode(".", $name);
		$c = count($t);
		if ($c>1)
		{
			$out = IGK_STR_EMPTY;
			$v_sep = false;
			for	($i = 0;$i< $c-1 ; $i++)
			{
				if ($v_sep)
					$out .= ".";
				else
					$v_sep = true;
				$out .= $t[$i];
			}
			return $out;
		}
		return null;
	}

	
	public static function InitMenuArray($target, $menuTab){
		$pages = array();
		foreach($menuTab as $k=>$v){
			$c = new IGKMenuItem($k, null, igk_getv($v, "uri"));		
			
			self::InitMenu($target, $c, $pages);
		}
	}
}

//represent a data adapter factory
abstract class IGKDataAdapter extends IGKObject
{
	private static $sm_regAdapter =null;
	///<summary>get the db identifier</summary>
	public function getDbIdentifier(){return "db"; }

	///<summary> override to manage the open connexion counter</summary>
	public function OpenCount(){return 0;}
	public static function Load(){//load data adapter
		if (defined("IGK_INIT"))//on loading context by default don't load data adapter
			return;
		self::LoadAdapter();
	}
	//public abstract function initSystableRequired($tablename);
	//public abstract function initSystablePushInitItem($tablename, $callback);
	public abstract function connect($ctrl=null);//connect to server ... mixed data
	public abstract function close();//close your adapter
	public abstract function CreateEmptyResult();


	public function select($tablename, $entries){}
	public function delete($tablename, $entries){}
	public function deleteAll($tablename){igk_die("function ".__FUNCTION__." not implements");}
	public function update($tablename, $entrie) {}
	public function drop(){$this->deleteAll(); }//shortcut to delete all
	public function selectdb($dbname){}//select db used in some data base

	public function selectAll($tbname){ return null;}
	public function selectLastId(){ return null; }
	public function selectAndWhere($tablename, $conditions=null, $options=null){
		igk_die("function ".__FUNCTION__." not implements");}
	public function ClearTable($tablename){}
	public function initForInitDb(){}
	public function flushForInitDb(){}

	//return the igk instance
	public function getApp(){return igk_app(); }
	public function getIsAvailable(){ return true;}
	private static function LoadAdapter(){
		//must be cache
		$fc = igk_io_baseDir(IGK_ADAPTER_CACHE);
		$n = "/^IGK(?P<name>(.)+)DataAdapter$/i";
		if(file_exists($fc)){
			foreach(explode("\n", igk_io_read_allfile($fc)) as $k){
				if (empty(trim($k)))continue;
				
				$key = strtoupper($k);
				if (preg_match_all($n, $key, $tab)){
					$key = $tab["name"][0];
				}
				
				self::$sm_regAdapter[$key] = new $k();
								
			}
			
		}else{
			//search for adapter class
			//init data adapter class
		
			self::$sm_regAdapter = array();
			//if (igk_is_atomic())return;
			$m="";
			foreach( get_declared_classes() as $k=>$v)
			{

				if (preg_match($n,$v))
				{
					$t = array();
					preg_match_all($n,$v, $t);
					$s = $t["name"][0];

					if (!igk_reflection_class_isabstract($v) && igk_reflection_class_extends($v, "IGKDataAdapter"))
					{
						self::$sm_regAdapter[strtoupper($s)] = new $v();
						$m.= $v."\n";
					}
				}
			}
			igk_io_w2file($fc, $m);			
		}
	}
	public static function GetAdapters()
	{
		if (self::$sm_regAdapter==null)
		{
			$b = self::$sm_regAdapter;
			$h  = __CLASS__;
			$i = igk_get_class_instance(__CLASS__, function() use (&$b,$h){
				$h::LoadAdapter();
				$b = $h::$sm_regAdapter;
				return $b;
			});
			self::$sm_regAdapter = $i;
		}
		return self::$sm_regAdapter;
	}
	public static function CreateDataAdapter($ctrl, $throwexception, $params = null){

		$adapt = self::GetAdapters();
		$n = IGK_STR_EMPTY;
		$key = IGK_STR_EMPTY;
		if (is_string($ctrl))
		{
			$key = strtoupper($ctrl);
			$n = "IGK".$ctrl."DataAdapter";
		}
		else {
			$key = strtoupper($ctrl->getDataAdapterName());
			$n = "IGK".$key."DataAdapter";
		}

		if (isset($adapt[$key]))
		{
			return $adapt[$key];
		}
		if( IGKApp::$DEBUG)
		igk_debug_wln("CreateDataApter: not found .... ".$ctrl. ":".$n. " :::: ".$ctrl->getDataAdapterName());

	//	return null;
		if (class_exists($n) && !igk_reflection_class_isabstract($n))
		{
			$out = igk_create_adapter_from_classname($n);


			if ($out){
			//register adapter
			$adapt[$key] = $out;
			return $out;
			}
		}
		else{
			$c = igk_get_env("sys://dataadapter");
			if ($c && isset($c[$key])){
				$o = $c[$key];
				$out = new $o();
				$adapt[$key] = $out;
				return $out;
			}
		}
		if ($throwexception)//ultimate case not found
			igk_die($n . " not found : Controller : ".$ctrl . " Name = ".$ctrl->getDataAdapterName());
		return null;
	}
	///DATA ADAPTER OVERRIDABLE FUNCTIONS
	public function insert($table, $entries){
		igk_wln(__CLASS__. " - [warning] :::: must override insert");
		return false;
	}
	public function createTable($tablename, $columninfoArray, $entries=null){
	}
	protected function configure($params){
	}
	public function makeCurrent(){
		IGKSQLManager::$Config["db"]  = $this->getDbIdentifier();
	}
}
///<summary>represent basics data result</summary>
final class IGKDataQueryResult extends IGKQueryResult{
	private $m_columns;
	private $m_rows;
	private $m_rowcount;

	const CREATE_ROW ="obj://createrow";

	public function __construct(){
		$this->m_columns = array();
		$this->m_rows = array();
	}

	public function getRows(){return $this->m_rows; }
	public function getColumns(){return $this->m_columns; }

	public function getRowCount(){
		return igk_count($this->m_rows);
	}
	public function addColumns($tab){
		foreach($tab as $k){
			$d = igk_createObj();
			$d->index = igk_count($this->m_columns);
			$d->name = $k;
			$this->m_columns[] = $d;
		}
	}
	public function addRow($row){
		$d = self::CREATE_ROW;
		if (is_object($row) && isset($row->$d) && ($row->$d == 1)){
			$this->m_rows[] = $row;
			unset($row->$d);//  = 0;
			return true;
		}
		//create
		$drow = $this->createRow();
		//$d = igk_db_createObj($drow);
		$row = is_object($row) ? (array)$row : $row;
		foreach($drow as $k=>$v){
			if(isset($row[$k])){
				$drow->$k = $row[$k];
			}
		}
		$this->m_rows[] = $drow;
	}
	public function createRow(){
		$c = igk_createObj();
		foreach($this->m_columns as $k=>$v){
			$n = $v->name;
			$c->$n = null;
		}
		$d = self::CREATE_ROW;//"obj://createrow";
		$c->$d = 1;
		return $c;
	}

}

///<summary>used to serve csv query result</summary>
final class IGKCSVQueryResult extends IGKQueryResult
{
	private $m_columns;
	private $m_rows;
	private $m_rowcount;
	private function __construct()
	{

	}
	public function getRows(){return $this->m_rows; }
	public function getColumns(){return $this->m_columns; }
	public static function CreateEmptyResult($result=null, $seacharray=null)
	{
		$out = new IGKCSVQueryResult();
		$out->m_rowcount = 0;
		$out->m_rows = array();
		return $out;
	}
	public function AppendEntries($e, $tableinfo=null)
	{

		$this->m_rowcount += igk_count($e);

		if ($tableinfo!=null)
		{
			foreach($e as $k=>$v)
			{
				$t = array();
				foreach($v as $m=>$n)
				{
					$v_n = $tableinfo[$m];
					$t[$v_n->clName] = $n;

				}
				$this->m_rows[] = (object)$t;
			}
		}
		else{
			foreach($e as $k=>$v)
			{
				$this->m_rows[] = $v;
			}
		}
	}
}

final class IGKCSVDataAdapter extends IGKDataAdapter
{
	private $m_fhandle;
	private $m_ctrl;
	private $m_dbname;

	public function initSystableRequired($tablename){
		return false;
	}
	public function initSystablePushInitItem($tablename, $callback){
	}
	public function __construct($ctrl = null){
		//don't call parent adapter
		$this->m_ctrl = $ctrl;
	}

	public function CreateEmptyResult($result=null){
		return null;
	}
	public function connect($datafile="file"){
		$this->m_dbname = $datafile;
	}
	///convert tab to line entry
	public function toCSVLineEntry($tab, $key = null)
	{
		$out = IGK_STR_EMPTY;
		$v_sep = false;
		if (is_object($tab))
		{

			foreach($tab as $k=>$c)
			{
				if ($v_sep)
					$out .= igk_csv_sep();
				else
					$v_sep =true;
				$out .= $c;
			}

			return $out;
		}

		if (!is_array($tab))
		{
			return null;
		}
		if ($key!=null)
		{
			$v_sep = false;
			foreach($tab as $c)
			{
				if ($v_sep)
					$out .= igk_csv_sep();
				else
					$v_sep =true;
				$out .= $c->$key;
			}
		}
		else{
			foreach($tab as $c)
			{
				if ($v_sep)
					$out .= igk_csv_sep();
				else
					$v_sep =true;
				$out .= $c;
			}

		}
		return $out;
	}
	public static function GetValue($value)
	{
		if ((strpos($value,igk_csv_sep()) !== false) || preg_match("/ /i", $value))
			return "\"".$value."\"";
		return $value;
	}
	//store data entrie to kv
	public static function StoreData($filename, $entries)
	{
		$out = IGK_STR_EMPTY;
		$v_ln = false;
		foreach($entries as $k=>$v)
		{
			if ($v_ln){
				$out .= IGK_LF;
			}
			else
					$v_ln  = true;
			$v_sep = false;
			foreach($v as $d){
				if ($v_sep){
					$out .= igk_csv_sep();
				}
				else
					$v_sep = true;
				$out .= self::GetValue($d);

			}

		}
		igk_io_save_file_as_utf8($filename, $out, true);
	}
	static function __removeguillemet($data)
		{
			if (IGKString::StartWith($data,'"'))
			{
				$data = substr($data, 1);
			}
			if (IGKString::EndWith($data,'"'))
				$data = substr($data, 0, strlen($data)-1);
			return $data;
		}

	private static function _CSVReadLine($line)
	{
		$tab = array();
		$rtab = explode(igk_csv_sep(), $line);
		//igk_wln($rtab);
		$v = false;
		$r = IGK_STR_EMPTY;
		foreach($rtab as $k=>$i)
		{
			$s = trim($i);
			if ($v == false)
			{
				if (IGKString::StartWith($s, '"'))
				{
					$v = true;
					$r .= substr($s, 1);

					if (IGKString::EndWith($r, '"')){
						$v = false;
						$r = igk_str_rm_last($r, '"');
					}
				}
				else
					$r .= $i;
			}
			else{
				if (IGKString::EndWith($s, '"'))
				{

					$r .= igk_csv_sep().igk_str_rm_last($s, '"');
					$v = false;
				}
				else
					$r .= igk_csv_sep().$i;
			}
			if ($v==false)
			{
				$tab[] = trim($r);
				$r = IGK_STR_EMPTY;
			}
		}

		return $tab;
	}
	public static function LoadData($filename)
	{
		$txt = IGKIO::ReadAllText($filename);
		return self::LoadString($txt);
	}
	public static function LoadString($txt, $rmBom = true)
	{
		//
		//remove BOM
		//
		if (empty($txt))
			return array();

		if ($rmBom && (ord($txt[0]) === 239)&&
			(ord($txt[1]) === 187)&&
			(ord($txt[2]) === 191)
			)
		{
			$txt = substr($txt,3);
		}

		$lines = explode(IGK_LF, $txt);
		$entries = array();
		foreach($lines as $l)
		{
			if (empty($l)){
				continue;
			}
			$tab = self::_CSVReadLine($l);
			$entries[] = $tab;
		}
		return $entries;
	}

	public function selectAll($tbname){
		$this->selectAllFile($tbname);
	}
	public function selectAllFile($tbname)
	{

		$f = igk_io_basePath(IGK_DATA_FOLDER)."/".$tbname.".csv";
		if (file_exists($f))
		{
			$r = IGKCSVQueryResult::CreateEmptyResult();
			$r->AppendEntries(self::LoadData($f), $this->m_ctrl->getDataTableInfo());
			return $r;
		}
		return null;
	}
	public function close(){
		if ($this->m_fhandle)
		{
			fclose($this->m_f);
		}
	}
}


final class IGKXMLDataAdapter extends IGKDataAdapter
{
	public function CreateEmptyResult($result=null){
		return null;
	}
	public function initSystableRequired($tablename){
		return false;
	}
	public function initSystablePushInitItem($tablename, $callback){
	}
	///<summary> open db</summary>
	public function connect($ctrl=null){
	}
	///<summary> close db</summary>
	public function close(){}
	//load first level config node
	public static function LoadConfig($node)
	{
		if (($node ==null) || (!$node->HasChilds))
			return null;

		$t = array();

		foreach($node->Childs as $k)
		{
				$t[$k->TagName] = $k->innerHTML;
		}
		return $t;
	}
	///load data file name of text
	public static function LoadData($filename)
	{
		$fc = null;
		$fc = function ($node)use(& $fc)
			{
				if ($node->HasChilds)
					{
						if ($node->ChildCount == 1)
						{
							 if ($node->Childs[0]->NodeType == XmlNodeType::TEXT){
								return $node->innerHTML;
							 }
							 else{
								$t = array();
								$t[$node->TagName] = $fc($node);
								return (object)$t;
							 }
						}
						else{
							$t = array();
							foreach($node->Childs as $k)
							{

								if (isset($t[$k->TagName]))
								{
									$v = $t[$k->TagName];									
										$s = array();
										$s[] = $v;
										$s[] = $fc($k);
										$t[$k->TagName] = $s;
									
								}
								else
									$t[$k->TagName] = $fc($k);
							}
							return (object)$t;
						}
					}
					return null;
			};

			$f = $filename;
			if (is_string($f) == false)
				return null;
			$div =  igk_createNode("div");
			$s = IGK_STR_EMPTY;
			if (file_exists($f))
			{
				$s = igk_io_read_allfile($f);
			}
			else{
				$s = $f;
			}

			$div->Load($s);

			if ($div->HasChilds)
			{
				$d = $div->getChildAtIndex(0);
				if ($d)
				{
					$t = array();
					foreach($d->Childs as $k)
					{
						$t[$k->TagName] = __loadData($k);
					}
					return (object)$t;
				}
			}
			return null;

	}
	public static function storeData($filename, $data){//store xml data setting
		//store configuration data
		$d =  igk_createNode("config");
		//store
		foreach($data as $k=>$v)
		{
			$d->add($k)->Content = $v;
		}
		return igk_io_save_file_as_utf8(filename, $d->Render());
	}

	public function __construct(){//xml contructor
	}
}


//-------------------------------------------------------------------------------------------------------------------------------------------
//SYSTEM CONNTROLLER
//-------------------------------------------------------------------------------------------------------------------------------------------


///<summary>used to initialize data adapter list</summary>
final class IGKDataAdapterCtrl extends IGKControllerBase
{
	public function getIsVisible(){return false;}

	protected function InitComplete(){
		parent::InitComplete();
		IGKDataAdapter::Load();
	}
	public function getName(){return IGK_DATA_ADAPTER_CTRL; }


}

///<summary> USE TO CONFIGURE MYSQL DATABASE ACCESS</summary>
final class IGKMYSQLDbCtrl extends IGKConfigCtrlBase
{

	// private $m_searchtable;
	private $m_loadTables; //array table that will store [tablename, ctrl] dictionary
	private $m_tabinfo; //store array of [tablename, tableInfo] dictionary

	const SELECTED_DB = 0xa1;
	const VIEWMYADMIN_DB = 0xa2;
	const TABINFO_DB = 0xa3;
	const LOADTABLES_DB = 0xa4;
	const SEARCH_DB = 0xa4;

	public function getSelectedDb(){
		return $this->getFlag(self::SELECTED_DB) ?? igk_app()->db_name;
	}
	public function getSearhTable(){
		return $this->getFlag(self::SEARCH_DB);
	}
	public function getViewMyAdmin(){
		return $this->getFlag(self::VIEWMYADMIN_DB);
	}
	public function getTabInfo(){
		return $this->getFlag(self::TABINFO_DB);
	}
	public function getLoadTables(){
		return $this->getFlag(self::LOADTABLES_DB);
	}
	public function getName(){
		return IGK_MYSQL_DB_CTRL;
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getConfigPage(){return "database";}
	
	public function getCacheFile(){
		return igk_io_baseDir(IGK_CACHE_FOLDER."/mysql.db.cache");
	}
	public function getDbConstantFile(){
		return igk_sys_db_constant_cache();
	}

	public function __construct(){
		parent::__construct();
	}

	public function dropTablesRegex($ctrl, $exp){
			$db = igk_get_data_adapter($ctrl, true);
			if ($db->connect()){
				//$db->dropTables("/^tbmvet_(.)+/i");
				$r = $db->listTables();
				$n = $r->Columns[0]->name;
				$tab = array();
				//$exp = "/^tbmvet_(.)+/i";
				foreach($r->Rows as $k=>$v){
					if (preg_match($exp, $v->$n)){
						$tab[] = $v->$n;
					}
				}

				$db->dropTable($tab);
				$db->close();
			}
	}
	protected function InitComplete(){
		parent::InitComplete();
		$this->_loadDbFromCache();
		igk_notification_reg_event(IGK_NOTIFICATION_DB_CHANGED, array($this, "dbChanged"));
		//igk_notification_reg_event("sys://db/app_init", $this, null);
		igk_notification_reg_event(IGK_NOTIFICATION_INITTABLE, array($this, "registerTable"));
	}
	public function registerTable($o, $e){
		list($tname, $data)=$e;
		$this->_addTable($tname, $o);

	}
	public function dbChanged(){
		$this->resetDataTableDefinition();
	}

	//load data from cache
	private function _loadDbFromCache(){
		$f = $this->getCacheFile();
		
		if (file_exists($f)){
			//igk_log_write_i("cache", "load from cache DB FROM CACHE");
			$txt = IGKIO::ReadAllText($f);
			$s = explode("\n", $txt);
			$t = array();
			$sk = array();
			foreach($s as $k=>$v){
				if (empty($v))
					continue;
				$db = explode(":", $v);
				if (count($db)<1)
					continue;
				$n = $db[1];
				if (isset($sk[$n]))
					$ctrl = $sk[$n];
				else {
					$ctrl = igk_getctrl_from_className($db[1]); //getControllerFromClassName //igk_getctrl($db[1]);

					$sk[$n] = $ctrl;
				}
				if ($ctrl)
				{
					$t[$db[0]] = $ctrl;
				}else{
					igk_ilog("No ctrl found for ".$db[0], __FUNCTION__);
				}
				//igk_flush_data();
			}
			// igk_wln("init complete loading from cache");
			$this->m_loadTables = $t;
		}else{
			$this->_initTableInfo();
		}
	}
	private function _storeDbCache(){		
		$f = $this->getCacheFile();
		$o = "";
		if ($this->m_loadTables)
		{
			$kt=0;
			foreach($this->m_loadTables as $k=>$v){
				if ($kt){
					$o.="\n";
				}
				$o .= $k.":".get_class($v);
				$kt = 1;
			}
			igk_io_w2file($f, $o, true);
		}
	}

	private function _initTableInfo(){
		if(igk_get_env("sys://db_init")){
			//igk_wln("initialize the db can't get table from : ".$this->getCacheFile());
			return;
		}
		// igk_wln("init table info");
		// exit;
		// igk_die("init table");
		// $this->m_loadTables = null;
		igk_set_env("sys://db_init", 1); //mark it to diseable recursion if adding prefix data
		if (($this->m_loadTables === null) || !file_exists($this->getCacheFile()))
		{
			$this->m_loadTables  = array();
			$t = igk_sys_getall_ctrl();
			foreach($t as $k=>$v)
			{
				if (igk_is_class_incomplete($v))
					continue;
				if ($v === $this)
					continue;

				///get data from schemas
				if ($v->UseDataSchema){
					$r = $v->loadDataFromSchemas();
					if ($r !=null){
						foreach($r as $kk=>$vv)
						{
							$this->_addTable($kk, $v);
						}
					}
				}else{
					$r = $v->getDataTableInfo();
					if ($r!=null){

						$this->_addTable($v->getDataTableName(), $v);
					}
				}
			}
			
			
			$this->_storeDbCache();
		}
		igk_set_env("sys://db_init", null); //clear
		
	}
	private function _addTable($tb, $ctrl){
		if (empty($tb))
			return false;
		if (isset($this->m_loadTables[$tb]) && ($this->m_loadTables[$tb] !== $ctrl))
		{
			igk_die("Table '$tb' already loaded "
			." by : ".$this->m_loadTables[$tb]
			.", Requested =&gt; ".$ctrl
			.", ". (new ReflectionClass(get_class($this->m_loadTables[$tb])))->getFileName()
			);
			return false;
		}
		$this->m_loadTables[$tb] = $ctrl;
		return true;
	}

	///<summary>return the controller that manage the table name</summary>
	public function getDataTableCtrl($tablename){
		$this->_initTableInfo();
		if (isset($this->m_loadTables[$tablename]))
		{
			return $this->m_loadTables[$tablename];
		}
		return null;
	}

	public function getAllTableNames(){
		$this->_initTableInfo();
		if($this->m_loadTables)
			return array_keys($this->m_loadTables);
		return null;
	}
	public function resetDataTableDefinition(){
		// igk_ilog(__METHOD__);
		$this->m_tabinfo =null;
		$this->m_loadTables= null;
		$f = $this->getCacheFile();
		if (file_exists($f))
			@unlink($f);
		//count call of resetDataTableDefinition
		igk_env_count(__FUNCTION__);
	}
	private function regTableDefinition($ctrl, $tbname, $inf){
		$this->m_loadTables[$tbname] = $ctrl;

	}
	private function regInfo($tablename, $inf){
		if ($this->m_tabinfo ===null)
			$this->m_tabinfo = array();

		$this->m_tabinfo[$tablename]= $inf;
	}
	public function getDataTableDefinition($tablename, $global=true){
		if (!is_string($tablename)){
			igk_die("/!\\ tablename not a string");
		}
		$h = igk_getv($this->m_tabinfo, $tablename);
		if ($h)
			return $h;

		//$this->m_loadTables =null;
		$this->_initTableInfo();

		if (isset($this->m_loadTables[$tablename]))
		{
			//get the controller that own this table definition;
			$ctrl= $this->m_loadTables[$tablename];
			$b = $ctrl->getDataTableInfo();
			if ($b == null)
				igk_die("/!\\ Controller return null for table definition. [".$ctrl."] for [".$tablename."]");


			if (isset($b[$tablename]))			{
				$this->regInfo($tablename, $b[$tablename]);
				//have more than one table
				return $b[$tablename];
			}
			else if ($global){
				$c = array("ColumnInfo"=>$b);
				$this->regInfo($tablename,$c);
				return $c;
			}
		}else{
			igk_wln(array_keys($this->m_loadTables));
			//igk_log_write_i(__FUNCTION__, "[".$tablename."] getDataTableDefinition not defined. you must probably reset the db.cache files");
			igk_die("[".__FUNCTION__."] - [".$tablename."] . tips: you must probably reset the db.cache files");
		}
		return null;
	}

	public function getTablesFor($ctrl, $include_dependency=false){
		if (is_string($ctrl)){
			$h = igk_getctrl($ctrl);
			if ($h == null)
				return false;
			$ctrl = $h;
		}
		$this->_initTableInfo();
		$t = array();
		foreach($this->m_loadTables as $k=>$v){
			if ($v==$ctrl)
			{
				$t[$k] = $k;
			}
		}
		if ($include_dependency){
			$s = array_merge($t, array());

			// $cc = 100;
			while($s && (igk_count($s)>0)
			//&& ($cc>0)
			)
			{
				// $cc--;
				$d = array_pop($s);
				$tabinfo = $this->getDataTableDefinition($d, false);
				if (!$tabinfo)
					continue;

				$info = igk_array_object_refkey(igk_getv($tabinfo,"ColumnInfo"), IGK_FD_NAME);
				foreach($info as $m=>$n){
					if (!isset($n->clLinkType) || isset($s[$n->clLinkType]) || isset($t[$n->clLinkType]))
						continue;
					//push new data
					$s[$n->clLinkType] = $n->clLinkType;
					$t[$n->clLinkType] = $n->clLinkType;
				}
			}

		}
		return $t;
	}

	//init data base
	protected function initDb(){ //db controller no init db
		return null;
	}

	public function IsFuncitonAvailable($f){
		return true;
	}
	private function __inittable_callback($o, $e){
				$tbname = $e[0];
				$desc = $e[1];
				// igk_wln("register session event : ".$tbname);
				//igk_wln($desc);
				$this->regTableDefinition($o, $tbname, $desc);
	}
	///<summary>public function expose system init db . must be conf connected</summary>
	function pinitSDb($nav=true){
		// if (!igk_is_conf_connected()){
			// return ;
		// }
			//
			//init time limit.
		    //database creation can take a while. depend on server speed
			//
			set_time_limit(0);
			igk_set_env(__FUNCTION__, 1);

			igk_notification_reset("sys://db/initentries");
			//clear db cache
			IGKIO::RmDir(IGK_APP_DIR."/Caches/db");
			$this->resetDataTableDefinition();
			$ad = igk_get_data_adapter($this);

			if ($ad->connect()){
				// $ad->sendQuery('Drop Database `igkdev`');
				// disable query verification
				$ad->setForeignKeyCheck(0);
				//$ad->close();
			}else
				$ad = null;

			$fc = array($this, '__inittable_callback');			
			$keye = 'sys://event/sdb/inittable';
			
			igk_reg_session_event($keye, $fc);
			$this->initSDb(true, false);
			igk_unreg_session_event($keye, $fc);
			
			
			// igk_wln("finish");
			igk_invoke_session_event("sys://event/sdb/finish", array($this,null));
			// igk_wln("done");
			if ($ad){
				$ad->setForeignKeyCheck(1);
				$ad->close();
			}


			//init entries
			igk_set_env(__FUNCTION__, null);
			igk_notification_push_event("sys://db/initentries", array($this));
			$this->_storeDbCache();
			igk_getctrl(IGK_SESSION_CTRL)->forceview();

		// igk_exit();


		if ($nav && !igk_is_ajx_demand())
			igk_navtocurrent();
	}
	public function dropsysdb(){//exposed function to drop database
		if (igk_is_conf_connected()){
			$ad = igk_get_data_adapter($this);
			if ($ad && $ad->connect()){
				$ad->sendQuery("drop database if exists ".$this->App->Configs->db_name. " ");
				$ad->close();
			}
		}

	}
	public function init_table($o, $e){
		$tbn = igk_getv($e, 0);
		$data = igk_getv($e, 1);
		if ($this->m_loadTables==null)
			$this->m_loadTables = array();
		$this->_addTable($tbn, $o);
	}
	function initCtrlDb($ctrlid=null){
		$ctrl = igk_getctrl($ctrlid);
		if ($ctrl){
			igk_set_env("sys://db_init_table/ctrl", $ctrl);
			$ctrl->initdb();
			igk_set_env("sys://db_init_table/ctrl", null);
		}
	}
	//init system data base
	function initSDb($view=true, $nav=true){

		//init db for mysql data adapter
		$ad = igk_get_data_adapter($this, true);
		if ($ad )
		{
				//mark for non db selection


				igk_set_env("sys://Db/NODBSELECT", 1);

				$ad->initForInitDb();
				if (!$ad->connect()){
					igk_wln("/!\\ connection failed");
					igk_exit();
				}
				//TODO: delete database for debugging
				//$ad->sendQuery("drop database if exists ".$this->App->Configs->db_name. " ");


				$ad->beginTransaction();
				//remove dv env vars
				$init_env = function(){
				igk_set_env("sys://Db/NODBSELECT", null);
				igk_set_env("sys://db_init", 1);
				igk_set_env("sys://db_init/error", 0);
				igk_set_env("sys://db_init_table/ctrl", null);
				};

				$init_env();


				$callable =  array($this, "init_table");
				igk_notification_reg_event(IGK_NOTIFICATION_INITTABLE, $callable);
				$r = $ad->createdb($this->App->Configs->db_name);
				$ad->selectdb($this->App->Configs->db_name);
				ini_set("max_execution_time", 0);
				if (function_exists("InitDb"))
				{
					//global function
					InitDb();
				}
				else {
					//call init for all controllers
					$ad_n = $this->getDataAdapterName();
					$v_ctab = $this->App->getControllerManager()->getControllers();
					foreach($v_ctab as $k)
					{
						if (($k == $this) ||  ($k->getDataAdapterName() != $ad_n))
							continue;

						igk_ilog_assert(igk_is_debug(), "init DB for ".$k->Name, __FUNCTION__);
						igk_set_env("sys://db_init_table/ctrl", $k);
						$k->initDb();
					}
					// $ctrl = igk_getctrl("baobabtv");
					// $ctrl->initDb();

				}
				igk_notifyctrl()->addMsgr("msg.db.initialized");
				igk_notification_unreg_event(IGK_NOTIFICATION_INITTABLE, $callable);


			$ad->flushForInitDb();
			if (igk_get_env("sys://db_init/error") > 0){
				// igk_debug(1);
				// igk_wln($ad->insert("tbigk_humans", array("clGender"=>"m", "clFirstName"=>"BONDJE", "clLastName"=>"-")));
				$ad->rollback();
			}
			else{
				$ad->commit();
			}
			igk_notification_push_event("sys://db/init_complete", $this);
			//reset environment variable
			igk_set_env("sys://db_init", null);
			igk_set_env("sys://db_init/error", null);
			// igk_exit();
			$ad->close();
			if ($view)
			{
				$this->View();
			}
		}
		else{
			igk_notifyctrl()->addError(R::ngets("E.DbNotConnected"));
			igk_ilog("/!\\ Connect FAILED");
		}
		if ($nav)
		{
			igk_navtocurrent();
		}
	}


	private function _view_conf_general($zdiv){
		$pan =$zdiv->addPanelBox();
		igk_html_add_title($pan->addDiv(),"title.Config");
		$pan->addHSep();
		$frm = $pan->addForm();
		$frm->setStyle("max-width:300px;");
		$frm["method"]="POST";
		$frm["action"]=$this->getUri("updatedb");
		$frm->addSLabelInput("dbServer",  "text", $this->App->Configs->db_server); $frm->addBr();
		$frm->addSLabelInput("dbUser", "text", $this->App->Configs->db_user); $frm->addBr();
		$frm->addSLabelInput("dbPasswd","password", null);$frm->addBr();
		$frm->addSLabelInput("dbName", "text", $this->App->Configs->db_name);$frm->addBr();
		$frm->addActionBar()->addBtn("btn_update", R::ngets("btn.update"))->setClass("-clsubmit +igk-btn");
	}
	private function _view_conf_backup($zdiv){
		$this->_showDataBaseBackup($zdiv->addPanelBox());
	}
	private function _view_conf_tools($zdiv){
		$pan =$zdiv->addPanelBox();
		igk_html_title($pan->addDiv(),R::ngets("title.Operations"));
		$pan->addHSep();
		$frm = $pan->add("form", 1);
		$bar = $frm->addActionBar();
		$bar->addABtn($this->getUri("gotophpmyadmin"))->Content = R::ngets("btn.phpmyadmin");
		$bar->addABtn($this->getUri("pinitSDb"))->Content = R::ngets("btn.initDb");
		$bar->addABtn($this->getUri("backupDb"))->Content = R::ngets("btn.backupdatabase");
		$bar->addAJXA($this->getUri("db_reload_sys_tables_ajx"))->setClass("igk-btn")->Content = R::ngets("btn.reloadsystables");
	}
	private function _view_conf_datas($zdiv){
		$frm = null;
		$mysql = igk_get_data_adapter($this, true);
		$v_table = null;
		$pan = $zdiv->addPanelbox();
		$h = $pan->addRow();

		$div1 = $h->addCol("igk-col-3-3")->addDiv()->setClass("db_info");
		$conf_title = null;
		if ($mysql)
		{
			if ($mysql->connect()){

			try{
				//for databases
				$r = $mysql->sendQuery("SHOW DATABASES");
				if ($r && !$r->ResultTypeIsBoolean() && ($r->RowCount>0)){
					$this->__showDataBases($r, $div1, $conf_title);
					$div1 = $div1->addActionBar();
					$div1->addABtn($this->getUri("pinitSDb"))->Content = R::ngets("btn.initDb");
					$div1->addABtn( $this->getUri("backupDb"))->Content = R::ngets("btn.backupdatabase");


					// IGKHtmlUtils::AddBtnLnk($div1 , "btn.initDb", $this->getUri("pinitSDb"));
					// IGKHtmlUtils::AddBtnLnk($div1 , "btn.backupdatabase", $this->getUri("backupDb"));
				}
				else{
					$row = $div1->addDiv()->addRow();
					$row->addCol()->Content = R::ngets("msg.cantshowdatabase");
					$this->__db_viewTables($h, $mysql);
				}
				//show selected data tables
				if (!empty($this->m_selectedDb))
				{
					$div2 = $h->addCol("igk-col-3-2")->addDiv();//->setClass("db_info no-overflow");
					$this->__showSelectedDbTables($div2, $conf_title);
				}
				// else{
					// $div2->Content = R::ngets("msg.db.cantshowDataBaseTableNoSelectedDb");
				// }
			}
			catch(Exception $ex)
			{
				igk_wln("somoe error".$ex);
				igk_exit();
				$this->__db_viewTables($h->addCol("igk-col-3-2"), $mysql);
			}
			$mysql->close();
			}
		}



	}
	private function _view_conf_query($zdiv){
		///TODO: query selector tool
		$pan =$zdiv->addPanelBox();
		igk_html_add_title($pan->addDiv(),R::ngets("MySQL Query Tool"));
		$pan->addHSep();
		$h = $pan->addDiv()->addRow();
		$dv = $h->addCol()->addDiv();


		$frm = $dv->addDiv()->addForm();
		$frm["action"] = $this->getUri("__db_query_r_ajx");
		$frm["igk-ajx-form"] =1;
		$frm["igk-ajx-form-target"]= "#query-s-r";
		$frm->addTextArea()->setId("clQuery")->setClass("fitw")->setStyle("height:65px")->Content = igk_getr('clQuery') ?? "Select * From `table` ";
		$acb = $frm->addActionBar();
		$acb->addInput("btn.send", "submit", R::ngets("btn.send"))->setClass("-clsubmit +igk-btn igk-btn-default");
		$dv->addDiv()->setId("query-s-r")//query selector result
		->setClass("igk-cnf-q-s-r");
	}

	public function __db_query_r_ajx(){
		$q = igk_getr("clQuery");
		if (empty($q) || !igk_is_conf_connected())
			igk_exit();

		if (!preg_match("#^(SELECT|UPDATE|DELETE) (.)+#i", $q)){
			igk_notifyctrl("query-r")->addError("/!\\ not a valid query ");
			igk_exit();
		}
		$mysql = igk_get_data_adapter($this, true);
		if ($mysql->connect()){

			$g = $mysql->sendQuery($q);
			if ($g && ($g->RowCount>0)){
				$dv = igk_createNode("div");
					$pan = $dv->addPanelBox();
					$pan->addDiv()->Content = $q;

					$pan->addDbResult($g, 5);


				$dv->RenderAJX();
			}
			$mysql->close();
		}
	}

	public function View(){
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}

		$p = igk_getr("v", null);

		if (igk_is_ajx_demand())
		{
			
			// igk_wln("dectec");
			// if (igk_detect_closure($_SESSION["igk"], $closures)){
				
				// igk_wln($closures);
				// igk_exit;
			// }
			$t = igk_createNode("div");
			$f = "_view_conf_{$p}";
			call_user_func_array(array($this, $f), array($t));
			$t->RenderAJX();
			return;

		}
		$c = $this->TargetNode;
		igk_html_add($c, $this->ConfigNode);

		$c->ClearChilds();

		// $row = $c->addRow();
		// $div = $row->addDiv()->setClass("igk-col igk-col-");
		// igk_html_add_title($div,"title.DataBaseConfigs");
		// $div->addHSep();
		// igk_add_article($this, "dbdescription", $div, null, "div", true);
		// $div->addHSep();

		igk_html_title($c, R::ngets("title.MysqlDataBaseConfigurationManager"));

		$c->addNotifyHost();

		$h = $c->addRow();

		$div = $h->addDiv();

		//info box
		$pan = $div->addPanelBox();
		$pan->addDiv()->Content = "DataBase : MySQL";
		$pan->addDiv()->Content = "Available : " . igk_parsebool(defined("IGK_MSQL_DB_Adapter"));
		$pan->addDiv()->Content = "MySQL : " . igk_parsebool(IGK_MSQL_DB_AdapterFunc);
		$pan->addDiv()->Content = "MySQLi : " . igk_parsebool(IGK_MSQLi_DB_AdapterFunc);


		$tab = $div->addComponent($this, "AJXTabControl", __METHOD__,1);
		$tab->addTabPage("General", $this->getUri("view&v=general"), true);
		$tab->addTabPage("Datas", $this->getUri("view&v=datas"), false);
		$tab->addTabPage("Backup", $this->getUri("view&v=backup"), false);
		$tab->addTabPage("Tools", $this->getUri("view&v=tools"), false);
		$tab->addTabPage("query", $this->getUri("view&v=query"), false);


		$zdiv = $div->addDiv();


		//init form
		//$div = $h->addDiv(array("class"=>"db_info igk-col-lg-3-2"))->addDiv();

		// IGKHtmlUtils::AddBtnLnk($frm,  R::ngets("btn.phpmyadmin"), $this->getUri("gotophpmyadmin"), array("onclick"=>"javascript: return true;"));
		// IGKHtmlUtils::AddBtnLnk($frm, "btn.initDb", $this->getUri("pinitSDb"));
		// IGKHtmlUtils::AddBtnLnk($frm, "btn.backupdatabase", $this->getUri("backupDb"));

		// $frm->addAJXA($this->getUri("db_reload_sys_tables_ajx"))->setClass("igk-btn igk-btn-default igk-btn-lnk")->Content = R::ngets("btn.reloadsystables");




		//get tables


	}

	private function __db_viewTables($h,$mysql){
		//only for user
		$conf_title = array("class"=> "igk-cnf-title");
		$d  = $h->addDiv();
		$d->Content = R::ngets("msg.usernotallowtoview");// "l'utilisateur \"".$this->App->Configs->db_user."\" n'est pas autoriser à lister les bases de données du serveur \"".$this->App->Configs->db_server."\"";


		$d->addBr();
		$mysql->selectdb($this->App->Configs->db_name);
		try{
		$r = $this->_getTables($this->m_searchtable);
		$d->add("div", $conf_title)->Content= $this->App->Configs->db_name ." Tables";
		$d->addHSep();
		$d->add(new IGKHtmlSearchItem($this->getUri("searchtable"), $this->m_searchtable))->setClass("dispb");
		$d->addHSep();
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("tableview");
		$v_table = $frm->addTable();
		if ($r && ($r->Rows!=null))
		{
			$v_theader = false;
			foreach($r->Rows as $tab)
			{

				if ($tab)
				{
					if (!$v_theader)
					{
						//write table header
						$v_theader = true;
						$li = $v_table->addTr();
						IGKHtmlUtils::AddToggleAllCheckboxTh($li);//->Content = IGK_HTML_SPACE;
						$li->add("th", array("class"=>"fitw"))->Content = R::ngets(IGK_FD_NAME);
						$li->add("th")->Content = IGK_HTML_SPACE;
						$li->add("th")->Content = IGK_HTML_SPACE;
					}
					$tr = $v_table->addTr();
					foreach($tab as $k=>$v)
					{
						$s = $v;
						$tr->addTd()->addInput("tname[]", "checkbox", $s);
						$tr->addTd()->addLi()->addA(igk_js_post_frame($this->getUri("db_viewtableentries_ajx&n=".$s."&from=".$this->App->Configs->db_name)))->Content = $s;
						$this->__addEditTable($tr,$s, $this->App->Configs->db_name);
						//drop table
						$tr->addTd()->addLi()->addA(igk_js_post_frame($this->getUri("db_droptable_ajx&n=".$s."&from=".$this->App->Configs->db_name)))->add("img",
						array("width"=>"16px","height"=>"16px", "src"=>R::GetImgUri("drop_16x16"),"alt"=>R::ngets("info.droptable")));
					}
				}
			}
			$div = $frm->addActionBar();
			$div->addAJXA($this->getUri("db_dropSelectedTable_ajx"))->Content = R::ngets("btn.droptableselection");
			//IGKHtmlUtils::AddBtnLnk($div, "btn.droptableselection", igk_js_ajx_postform_frame( $this->getUri("db_dropSelectedTable_ajx")) );

			}


		igk_html_toggle_class($v_table, "tr");
		}
		catch(Exception $ex){
		}
	}

	private function __addEditTable($tr, $tablename, $selectedDb=null ){
		$tr->addTd()->addLi()->add("a", array("href"=>
		igk_js_post_frame($this->getUri("db_viewtableentries_ajx&n=".$tablename.($selectedDb?"&from=".$this->selectedDb:IGK_STR_EMPTY)))))->add("img",
		array("width"=>"16px","height"=>"16px", "src"=>R::GetImgUri("edit_16x16"),"alt"=>R::ngets("tip.editdatabase")));//->Content = $tablename;
	}
	public function demandToShowDataBase_ajx(){
		$c = igk_createNode("div");
		$c["class"]="igk-dbview";
		// $c->addDiv()->Content = "Is AJX Demand ? ".igk_is_ajx_demand();
		// $c->addDiv()->Content = "Is ENV Demand ? ".igk_get_env(IGK_ENV_NO_AJX_TEST);
		// $c->addDiv()->addObData(igk_ob_get(igk_get_allheaders()));
		// $c->addDiv()->addObData(igk_ob_get($_SERVER));
		$this->__showSelectedDbTables($c, "Database");
		$c->RenderAJX();
		igk_exit();
	}
	public function db_reload_sys_tables_ajx(){

		if (igk_qr_confirm()){
			$this->db_drop_sys_tables();
			$this->pinitSDb(true);
			$this->View();
			igk_ajx_replace_node($this->ConfigNode);
			igk_createNode("Toast")->setContent("Operation Complete")->RenderAJX();
			igk_exit();
		}
		else{
			$frm = igk_frame_add_confirm($this, __CLASS__."::".__FUNCTION__, $this->getUri(__FUNCTION__));
			$frm->Form->Div->Content = R::ngets("q.reloadsystables");
			$frm->RenderAJX();
		}

	}
	// public function demandToShowDataBase(){
		// $c = igk_createNode("div");
		// $this->__showSelectedDbTables($c, "Database");
		// $c->RenderAJX();
	// }
	/// $c target node
	private function __showSelectedDbTables($c, $conf_title=null, $selected=1)
	{
		$k = "request:".__FUNCTION__;
		$h = $this->getParam($k);
		$c->setId("tableview");
		if (!igk_is_ajx_demand()){
			if (!$h){
				$this->setParam($k, 1);
				$c->addDiv()->addAJXScriptContent($this->getUri("demandToShowDataBase_ajx"));
			}else{
				$this->getParam($k, null);
				igk_die(
				array(
				"code"=>404,
				"message"=>"/!\\ loaping on getting database is not allowed."
				));
			}
			return;
		}
		$this->setParam($k, null);
		$tab = $this->_getTablesFromSelectedDb($this->m_searchtable);
		if (count($tab)<=0)
		{
			return;
		}
		igk_html_add_title($c,"title.Tables");
		$c->addHSep();

		$s = new IGKHtmlSearchItem($this->getUri("searchtable"), $this->m_searchtable);

		$c->addDiv()->add($s);

		$div = $c->addDiv()->setId("igkdb_tablelist");


		$frm = $div->addForm();
		$frm["action"] = $this->getUri("db_dropSelectedTable");

		$frm->addDiv()->Content = $tab->RowCount;

		$table = $frm
		->addDiv()
		->setStyle("overflow:auto;")
		->addTable()
		//->setClass("-igk-table")
		;

		$tr = $table->addTr();


		IGKHtmlUtils::AddToggleAllCheckboxTh($tr);
		$tr->add("th" , array("class"=>"fitw"))->Content = R::ngets("lb.Name");
		$tr->add("th")->Content = IGK_HTML_SPACE;
		$tr->add("th")->Content = IGK_HTML_SPACE;


		igk_html_paginate($table,$frm, $tab->Rows, 10, function($table, $k,$v){

			$s = $v["Table"];
			$tr = $table->addTr();
			$tr->addTd()->addInput("tname[]","checkbox", $s);
			$tr->addTd()->add("a", array("href"=>
			igk_js_post_frame($this->getUri("db_viewtableentries_ajx&n=".$s."&from=".$this->m_selectedDb))))->Content = $s;
			$this->__addEditTable($tr,$s, $this->m_selectedDb);
			$tr->addTd()->addLi()->add("a", array("href"=>igk_js_post_frame($this->getUri("db_droptable_ajx&n=".$s))))->add("img",
			array("width"=>"16px","height"=>"16px", "src"=>R::GetImgUri("drop_16x16"),"alt"=>R::ngets("tip.dropdatabase")));//->Content = $s;
		},
		igk_io_currentUri().'/'.$this->getUri("viewtable&v="),
		$selected
		);

		// foreach($tab->Rows as $k=>$v)
		// {
			// $s = $v["Table"];
			// $tr = $table->addTr();
			// $tr->addTd()->addInput("tname[]","checkbox", $s);
			// $tr->addTd()->add("a", array("href"=>
			// igk_js_post_frame($this->getUri("db_viewtableentries_ajx&n=".$s."&from=".$this->m_selectedDb))))->Content = $s;

			// $this->__addEditTable($tr,$s, $this->m_selectedDb);

			// $tr->addTd()->addLi()->add("a", array("href"=>igk_js_post_frame($this->getUri("db_droptable_ajx&n=".$s))))->add("img",
			// array("width"=>"16px","height"=>"16px", "src"=>R::GetImgUri("drop_16x16"),"alt"=>R::ngets("tip.dropdatabase")));//->Content = $s;
		// }
		$div = $frm->addActionBar();
		$div->addAJXA( $this->getUri("db_dropSelectedTable_ajx"))->Content = R::ngets("btn.droptableselection");
		$div->addAJXA( $this->getUri("db_drop_alltable_ajx"))->Content = R::ngets("btn.dropall");
		// IGKHtmlUtils::AddBtnLnk($div, "btn.droptableselection", igk_js_ajx_postform_frame( $this->getUri("db_dropSelectedTable_ajx")) );
		// IGKHtmlUtils::AddBtnLnk($div, "btn.dropall", igk_js_ajx_postform_frame( $this->getUri("db_drop_alltable_ajx")) );
	}
	public function viewtable(){
		$selected = igk_getr("v") ?? 1;
		$n = igk_createNode("div");
		$this->__showSelectedDbTables($n, null, $selected);
		$n->RenderAJX();
		igk_exit();

	}
	private function __showDataBases( $r,$c, $conf_title=null)
	{

		$conf_title = $conf_title ?? array("class"=> "igk-cnf-title");
				igk_html_add_title($c,"title.DATABASES");
				$c->addHSep();
				if (!empty($this->m_selectedDb))
				{
					$c->addDiv()->Content= R::ngets("tip.db.selecteddb", $this->m_selectedDb) ;
				}
				else{
					$c->addDiv()->Content = R::ngets("msg.db.cantshowDataBaseTableNoSelectedDb");
				}


				$div = $c->addDiv();
				$frm = $div->add("form", 1);
				$frm["action"]=$this->getUri("dataview");

				$v_table = $frm->addDiv()->setClass("overflow-x-a")->addTable();
				$v_theader =false;
				if ($r->RowCount>0){
					if ($this->m_selectedDb==null)
							$this->m_selectedDb =  strtolower($this->App->Configs->db_name);


				foreach($r->Rows as $tab)
				{
					if (!$v_theader)
					{
							//write table header
							$v_theader = true;
							$li = $v_table->addTr();
							IGKHtmlUtils::AddToggleAllCheckboxTh($li);
							$li->add("th", array("class"=>"fitw"))->Content = R::ngets("clDataBaseName");
							$li->add("th")->Content = IGK_HTML_SPACE;
							$li->add("th")->Content = IGK_HTML_SPACE;
					}
						foreach($tab as $k=>$v)
						{
							$tr = $v_table->addTr();
							if (strtolower($v) == $this->m_selectedDb){
								$tr["class"] = "+igk-selectdb-row";
							}
							$tr->addTd()->addInput(IGK_STR_EMPTY,"checkbox");
							$tr->addTd()->addLi()->add("a", array("href"=>$this->getUri("selectdb&n=".$v)))->Content = $v;
							$tr->addTd()->addLi()->add("a", array("href"=>$this->getUri("editdb&n=".$v)))->add("img",
							array("width"=>"16px","height"=>"16px", "src"=>R::GetImgUri("edit_16x16"),"alt"=>R::ngets("tip.editdatabase")));
							$tr->addTd()->addLi()->add("a", array("href"=>$this->getUri("dropdb&n=".$v)))->add("img",
							array("width"=>"16px","height"=>"16px", "src"=>R::GetImgUri("drop_16x16"),"alt"=>R::ngets("tip.dropdatabase")));
						}
					}
				}

				$frm->addBr();
				igk_html_toggle_class($v_table, "tr");
				return $frm;
	}

	private function _showDataBaseBackup($frm)
	{
			$v_dir = igk_io_currentRelativePath(IGK_BACKUP_FOLDER);
			$bckdiv = $frm->addDiv();
			igk_html_add_title($bckdiv, "title.Backup");
			$frm->addHSep();
			$v_table = $frm->addTable();
			$v_table->setCallback("getIsVisible", "return \$this->HasChilds;");
			$v_hasfile =false;
			if (is_dir($v_dir))
			{
			$hdir = opendir($v_dir);
			$v_theader = false;//has table header
				while( ($f = readdir($hdir)))
				{
					if (($f==".") ||($f == ".."))
						continue;
						if (!$v_theader){
							$v_theader = true;
							$li = $v_table->addTr();
							IGKHtmlUtils::AddToggleAllCheckboxTh($li);
							$li->add("th")->Content = R::ngets(IGK_FD_NAME);
							$li->add("th")->Content = IGK_HTML_SPACE;
							$li->add("th")->Content = IGK_HTML_SPACE;
						}

					$li = $v_table->addTr();
					$li->addTd()->addInput(IGK_STR_EMPTY,"checkbox");
					$li->addTd()->add("a", array("href"=>$this->getUri("downloadbackupfile&file=".$f)))->Content = $f;
					IGKHtmlUtils::AddImgLnk($li->add("td", array( "class"=>"igk-table-img-action_16x16")), $this->getUri("db_dbRestore&file=".$f), "db_restore_16x16");
					IGKHtmlUtils::AddImgLnk($li->add("td", array( "class"=>"igk-table-img-action_16x16")),$this->getUri("dropBackup&file=".$f), "drop_16x16","16px","16px", "lb.dropbackup");
					$v_hasfile = true;
					//$li->addTd()->add("a", array("href"=>$this->getUri("dropBackup&file=".$f)))->add("img"=>Content = $f;
				}
				closedir($hdir);

				if ($v_hasfile){
					$bar = $frm->addActionBar();
					$bar->addABtn( $this->getUri("ClearBackup"))->Content = R::ngets("btn.clearAllBackup");
					//IGKHtmlUtils::AddBtnLnk($frm, "btn.ClearBackup", $this->getUri("ClearBackup"));
				}
				else{
					$frm->addDiv()->Content = R::ngets("Msg.NoBackgup");
				}
			}

			igk_html_toggle_class($v_table, "tr");
	}
	public function editdb(){
		$this->View();
	}
	public function searchtable(){
		$q = igk_getr("q");
		$this->m_searchtable = $q;
		$this->View();
	}

	private function _getTablesFromSelectedDb( $searchkey = null)
	{
		if (empty($this->m_selectedDb))
			return;

		$r = null;
		$mysql = igk_get_data_adapter($this, true);
		if ($mysql)
		{
			$mysql->connect($this->m_selectedDb);
			$r = $mysql->listTables();
			$mysql->close();
			if ($r &&  !$r->ResultTypeIsBoolean()){
				$tab = $r->CreateEmptyResult($r);

			$n = $r->Columns[0]->name;
			if ($searchkey !=null)
			{
				$q = strtolower($searchkey);
				foreach($r->Rows as $t)
				{
					if (strstr(strtolower($t->$n), $q))
					{
						$tab->addRow(array("Table"=>$t->$n));
					}
				 }
				return $tab;
			}
			else{
				foreach($r->Rows as $t)
				{
					$tab->addRow(array("Table"=>$t->$n));
				}
				return $tab;
			}
			}
		}
		return null;
	}

	private function _getTables($searchkey = null)	{
		$r = null;

		$mysql = igk_get_data_adapter($this, true);
		if ($mysql)
		{

			$mysql->connect($this->App->Configs->db_name);
			$r = $mysql->listTables();//("Show Tables;");
			if ($r)
			{
			$tab = $r->CreateEmptyResult($r);
			$mysql->close();

			$n = $r->Columns[0]->name;
			if ($searchkey !=null)
			{
				$q = strtolower($searchkey);
				foreach($r->Rows as $t)
				{
					if (strstr(strtolower($t->$n), $q))
					{
						$tab->addRow(array("Table"=>$t->$n));
					}
				 }
				return $tab;
			}
			else{

				foreach($r->Rows as $t)
				{
					$tab->addRow(array("Table"=>$t->$n));
				}
				return $tab;
			}
			}
		}
		return null;
	}
	///<summary>entry to backup mysql database</summary>
	public function backupDb(){

		$mysql = igk_get_data_adapter($this, true);
		if (!$mysql)
		{
			igk_notifyctrl()->addError("can't get ".IGK_MYSQL_DATAADAPTER ." data adapter");
			return;
		}
		$adapter = igk_get_data_adapter("CSV");
		if (!$adapter)
		{
			igk_notifyctrl()->addError("can't get csv adapter");
			return;
		}

		$v_date = igk_date_now("Ymd_his");
		$v_file = igk_io_baseDir(IGK_BACKUP_FOLDER."/backup_".$v_date.".csv");
		$out = IGK_STR_EMPTY;

		$db_table = $this->_getTables(null);
		$mysql->connect();
		$warn = "";
		if ($db_table){
			foreach($db_table->Rows as $t=>$v)
			{

				$v_tbname = $v["Table"];

				$r = $mysql->sendQuery("SELECT * FROM `".$v_tbname."`;");
				if ($r){
					$out .= $v_tbname .IGK_LF;
					$v_sep = false;
					$out .= $adapter->toCSVLineEntry($r->Columns, "name").IGK_LF;
					if ($r->Rows){

						foreach($r->Rows as $e)
						{
							$out .=$adapter->toCSVLineEntry($e).IGK_LF;
						}
					}
					else {
						$warn .= ("notice: no data row for [".$v_tbname."]\n");
					}
					$out .= "\0".IGK_LF;
				}
				else{
					igk_debug_wln("error: mysql adapter failed");
					igk_debug_wln($r);
					igk_notifyctrl()->addMsgr("Error.Config");
				}
			}
		}
		else{
			igk_debug_wln("error: no table");
			igk_notifyctrl()->addMsgr("Msg.NoTable");
		}

		if (!empty($warn)){
			igk_ilog($warn);
		}
		IGKIO::CreateDir(dirname($v_file));
		if (strlen($out) > 100000)
		{
			//zip file
			igk_zip_content($v_file.".zip", basename($v_file),  $out);
		}
		else{

			igk_io_save_file_as_utf8($v_file, $out, true,0666);
		}
		$this->View();
		igk_notifyctrl()->addMsgr("msg.dataBackup");
		igk_navtocurrent();
	}

	///<summary>restore data base table from definition</summary>
	private function __restoredb($table, $header, $definition, $sync=0)
	{
		igk_die("not implement");

		// $adapt =igk_get_data_adapter(IGK_MYSQL_DATAADAPTER);
		// if ($adapt!=null)
		// {
			// $dbname = $this->App->Configs->db_name;
			// $adapt->connect($dbname);
			// $e = $adapt->TableExists($table);
			// // igk_wln("Table Exists :".$e);
			// // exit;
			// $tentries = array();
			// if ($e){
				// //get column info
				// $e =  $adapt->sendQuery("SELECT * FROM `{$table}` LIMIT 0");

				// foreach($definition as $row){
					// $tab = array();
					// $i = 0;
					// foreach($e->Columns as $k=>$v)
					// {
						// if ($i < $e->ColumnCount)
						// {
							// $tab[igk_getv($v,"name")] = igk_getv($row, $i);
							// $i++;
						// }
						// else
							// break;
					// }

					// unset($tab["clId"]);//remove id to register the
					// $tentries[] = $tab;

					// igk_die("treatment");
					// $q = $adapt->GetInsertQuery($table, $tab);
				// //igk_wln("insert query : {$table} : ".$q);
					// if (!empty($q)
					// // && $adapt->sendQuery($q, false)==null)
					// )
					 // {
						// // igk_notifyctrl()->addError("Error Append in query ".$q);
					 // }

				// }
			// }else{
				// igk_push_env("sys://dbrestore/warning", "failed to restore [{$table}]. Table does not exist");
			// }
			// $adapt->close();
		// }
	}

	///<summary>drop all tables</summary>
	public function db_drop_alltable_ajx(){
		if (igk_qr_confirm()){
			$this->db_drop_sys_tables();
			igk_ajx_replace_ctrl_view($this);
			igk_exit();
		}
		$b = igk_createNode();
		$frm = $b->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$frm["igk-ajx-form"] = 1;
		$frm["igk-ajx-form-data"] = "{complete: function(){ ns_igk.winui.notify.close(); }}";
		$frm->addConfirm(1);
		igk_html_binddata($this, $frm->addDiv(),"confirm.dialog.template", (object)array("clMessage"=>R::ngets("msg.confirmalltablesuppression")));
		$frmdial = igk_ajx_notify_dialog(R::ngets("title.confirmalltablesuppression"), $b);
		$frmdial->RenderAJX();
	}

	public function db_dbRestore()
	{
		$v_f = igk_getr("file");
		$v_mode = igk_getr("mode", 1);
		if (igk_qr_confirm() && $this->App->ConfigMode)
		{
			$r = IGK_BACKUP_FOLDER."/".$v_f;
			$v_file = igk_io_baseDir($r);
			if (!file_exists($v_file))
				igk_notifyctrl()->addErrorr("msg.nodatatorestore");
			else{
			$str = igk_io_read_allfile($v_file);
			$h = explode("\0", $str);

			//$e = IGKCSVDataAdapter::LoadData($v_file);
			// igk_wln($h);
			$table = null;
			$definition = null;
			$header = null;
			$warn="";

			$syncdata = array();
			//transform to usable data
			foreach($h as $k=>$v){
				$lines = explode("\n", trim($v));
				$entries = array_slice($lines,2);

				$table = trim($lines[0]);
				$header = igk_array_tokeys(IGKCSVDataAdapter::LoadString(trim($lines[1]))[0]);
				$entriecs = array();
				// igk_wln($table);
				// igk_wln($header);

				$definition = IGKCSVDataAdapter::LoadString(implode("\n", $entries), true, $header);
				// igk_wln($definition);

				if (igk_count($definition)==0)
					continue;
				$th = igk_count($header);
				$ec= -1;
				foreach($definition as $m=>$n){
					$ec++;
					if (igk_count($n)!=$th){
						$warn.="column header doest not match the entries definition of : {$table} : {$ec} \n";
						continue;
					}
					$row = igk_createObj($header);
					$i=0;
					foreach($header as $ss=>$tt){
						$row->{$ss} = $n[$i];
						$i++;
					}
					$entriecs[]=  $row;
				}
				$syncdata[$table] = $entriecs;


			}
			// igk_wln($warn);
			// igk_wln($syncdata);

		$adapt =igk_get_data_adapter(IGK_MYSQL_DATAADAPTER);
		if (($adapt!=null) &&($adapt->connect()))
		{
			$adapt->beginTransaction();

			//backup relation
			// $dis = $adapt->getAllRelations();
			// $adapt->dropAllRelations();
			// igk_wln($dis);

			$adapt->sendQuery("SET foreign_key_checks = 0;");

			$_syncfc = function ($adapt, $t, $e, $m){

				$ge =  $adapt->sendQuery("SELECT * FROM `{$t}` LIMIT 0");
				//column from definition from database
				$tbinfo = igk_db_getdatatableinfokey($t);
				$o = igk_createObj();
				foreach($ge->Columns as $d){
					if (!isset($tbinfo[$d->name])){
						igk_set_error("sys", "data table columns not match", 0xDB0001);
						return 0;
					}
					$o->{$d->name} = null;
				}

				$r = 0;
				switch($m){
					case 1://restore
						$r= $adapt->delete($t);
						if ($r){
							if (is_array($e)){
								foreach($e as $k=>$v){
									$mm = igk_createObj_filter($v, $o);
									$r = $r && $adapt->insert($t, $mm);
								}
							}else
								$r = $r && $adapt->insert($t, $e);
						}
					break;
					case 2://update
					break;


				}
				return $r;
			};
			//mode 1: sync or 2:restore
			$r = 1;
			foreach($syncdata as $t=>$e){//[table,entry]
				$e_x =  $adapt->sendQuery("SELECT * FROM `{$t}` LIMIT 0");

				if (!$e_x){
					$warn.="table [{$t}] does not exists\n";
					continue;
				}
				$r = $r &&  $_syncfc($adapt, $t, $e, $v_mode);
				if (!$r)
					$break;
			}

			$adapt->sendQuery("SET foreign_key_checks = 1;");
			// igk_wln($warn);
			if ($r){
				// igk_wln("commit");
				$adapt->commit();
			}
			else {
				// igk_wln("rollback");
				$adapt->rollback();
			}

			$adapt->close();
		}

			// exit;

			// $m = 0; //table
				// foreach($e as $k=>$v)
				// {
						// switch($m){
							// case 0://read table
							// $table = $v[0];
							// $definition = array();
							// $header=null;
							// $c = igk_getv($v,[1]);
							// $m=1;
							// break;
							// case 1://read column info
							// $header = igk_array_tokeys($v);
							// $m = 2;
							// break;
							// case 2: //read entry
							// break;

						// }
					// // if (igk_count($v) == 1)
					// // {
						// // if ( ($table!=null) && ($definition!=null))
						// // {
							// // $this->__restoredb($table, $header, $definition);
						// // }
						// // $table = $v[0];
						// // $definition = array();
						// // $header = null;
					// // }
					// // else {
						// // if ($header ==null)
							// // $header = igk_array_tokeys($v);
						// // else
							// // $definition[] = $v;
					// // }
				// }

				// if ( ($table!=null) && ($definition!=null))
				// {
					// $this->__restoredb($table, $header, $definition);
				// }
			// }
			}
			// exit;
			$this->View();

			}
			else
			{
				$frame = igk_frame_add_confirm($this, "confirm_restoration", $this->getUri("db_dbRestore"));
				$frame->Form->Div->Content = R::ngets(IGK_MSG_RESTOREBACKUPFILE_QUESTION, $v_f);
				$frame->Form->addInput("file","hidden", $v_f);
			}
	}


	public function downloadbackupfile(){
		$v_file = igk_getr("file");
		$v_f = igk_io_currentRelativePath(IGK_BACKUP_FOLDER."/".$v_file);
		if (file_exists($v_f)){
			igk_download_file(basename($v_f), $v_f);
		}
		else{
			igk_notifyctrl()->addError("file not present");
		}
	}

	public function dropBackup(){

		$v_file = igk_getr("file");
		if (igk_qr_confirm()){
			$v_f = igk_io_currentRelativePath(IGK_BACKUP_FOLDER."/".$v_file);
			unlink($v_f);
			$this->View();
			igk_navtocurrent();
		}
		else{
				$frame = igk_frame_add_confirm($this, "confirm_Clear_backup_file", $this->getUri("dropBackup"));
				$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETEABACKUPFILE_QUESTION, $v_file);
				$frame->Form->addInput("file","hidden", $v_file);
		}
	}

	public function ClearBackup(){
		if (igk_qr_confirm()){
			$v_dir = igk_io_currentRelativePath(IGK_BACKUP_FOLDER);
			IGKIO::RmDir($v_dir);
			$this->View();
			igk_navtocurrent();
		}
		else{
			$frame = igk_frame_add_confirm($this, "confirm_Clear_backup_file",$this->getUri("ClearBackup"));
			$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETEALLDATABASEBACKUP_QUESTION);
		}
	}

	public function selectdb(){
		$this->m_selectedDb = igk_getr("n");
		$this->View();
		igk_navtocurrent("./#igkdb_tablelist");
	}

	public function gotophpmyadmin(){
	if ($this->m_myadminview )
	{
		$h = $this->App->Configs->db_server;

		switch(strtolower($h))
		{
			case "127.0.0.1":
			case "localhost":
				if ($_SERVER["SERVER_ADDR"] != "::1")
					$h = $_SERVER["SERVER_ADDR"];
				break;
		}
		igk_html_rm($this->m_myadminview);
		unset($this->m_myadminview);
		$this->m_myadminview = null;
		igk_navto("http://".$h."/phpmyadmin");
		igk_exit();
	}
		else{
			$this->m_myadminview = $this->ConfigNode->add("script");
			$uri = $this->getUri("gotophpmyadmin");
			$this->m_myadminview->Content = <<<EOFF
var w = window.open('$uri', 'phpmyadmin');
w.opener.focus();
EOFF;

		igk_navtocurrent();
		}
	}

	public function updatedb(){

		$server= igk_getr("dbServer");
		$user= igk_getr("dbUser");
		$pwd = igk_getr("dbPasswd");
		$dbname = igk_getr("dbName");

		$this->App->Configs->db_server = $server;
		$this->App->Configs->db_user = $user;
		$this->App->Configs->db_pwd = $pwd;
		$this->App->Configs->db_name = $dbname;

		igk_save_config();
		igk_resetr();
		igk_notifyctrl()->addSuccessr("msg.databaseinfoupdated");
		$db  = igk_get_data_adapter($this);


		//reset db setting
		$db->Reset();
		$this->View();
		igk_navtocurrent();
		igk_exit();
	}

	public function dropdb(){
		$n = igk_getr("n");
		if ($n != null)
		{
				$mysql = igk_get_data_adapter($this, true);
				$mysql->connect();
				$r = $mysql->sendQuery("Drop DataBase `".$n."`;");
				$mysql->close();
		}
		$this->View();
		igk_navtocurrent();
		igk_exit();
	}

	public function db_droptable($dbname=null, $table=null){//drop a data base table

		$n = igk_getr("n", $table);
		if (igk_qr_confirm()){
			$mysql = igk_get_data_adapter($this, true);
			if (!$mysql )
				return;
			$dbname = igk_getr("from", $dbname);

			$mysql->connect($dbname);
				//remove table schema
			$r = $mysql->dropTable($n);
			$mysql->close();
			$this->View();
			igk_navtocurrent("./#igkdb_tablelist");
			igk_exit();
		}
		else{
			$frame = igk_frame_add_confirm($this, "confirm_drop_table", $this->getUri("db_droptable"));
			$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETESINGLETABLE_QUESTION, $n);
			$frame->Form->addInput("n","hidden",$n);
			return $frame;
		}
	}

	public function db_droptable_ajx(){
		$frame = $this->db_droptable();
		if ($frame!=null){
			$frame->RenderAJX();
		}

	}

	public function db_viewtableentries_ajx($dbname=null, $table=null, $adapter=null)	{
		$frame = $this->db_viewtableentries($dbname,$table,false, $adapter);
		$frame->RenderAJX();
	}
	//view table entries
	public function db_viewtableentries($dbname=null, $table=null, $navigate=true, $adapter=null)	{
		$tb = $table?$table:igk_getr("n");
		$db =  $dbname==null? igk_getr("from"):$dbname;
		$mysql = $adapter ==null ? igk_get_data_adapter($this, true) : $adapter;
		if (!$mysql )
			return;
		$mysql->connect($db);
		$r = $mysql->selectAll($tb);
		$frame = igk_add_new_frame($this, "db_view_entries", "./#igkdb_tablelist");
		$frame->Title = R::ngets("title.db_viewtableentries_1", $tb);
		$frame->ClearChilds();
		$div = $frame->BoxContent->addDiv();
		$div["class"]="igk-db-tableentries";
		$title = $div->addDiv();
		$div->addHSep();
		$title->setClass("title");
		$content = $div->addDiv();
		$content["class"]="datas";
		$content["style"]="overflow:auto;";
		$title->Content = R::ngets("title.TableInfo", $db.".".$tb);

		$table = $content->addTable();
		$table["class"]="fitw";
		$table["style"]= "border:1px solid black";
		$tr = $table->addTr();
		$tr->add("th")->Content = IGK_HTML_SPACE;
		$pkey  = null;
		$pkname = null;
		// igk_wln(" r is ".$r);
				// $mysql->Close();

		foreach($r->Columns as $k)
		{
			$td = $tr->add("th");
			$td->Content = $k->name;
			if (($pkey == null) && $k->primary_key==1){
				$pkey = $k->name;
			}
		}
		$tr->add("th")->Content = IGK_HTML_SPACE;
		$tr->add("th")->Content = IGK_HTML_SPACE;
		foreach($r->Rows as $k)
		{
			$tr = $table->addTr();
			$tr->addTd()->Content = IGK_HTML_SPACE;
			foreach($k as $e=>$v)
			{
				$tr->addTd()->Content = ($e == IGK_FD_PASSWORD) ? IGK_HTML_SPACE : $v;
			}

			IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("db_edit_entry_ajx&n=".$k->$pkey."&s=".$pkey)), "edit_16x16");
			IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("db_drop_entry&n=".$k->$pkey."&s=".$pkey), "drop_16x16");
		}
		$div->addHSep();

		$this->setParam("db:dbname", $db);
		$this->setParam("db:table", $tb);
		$this->setParam("db:r", $r);
		$this->setParam("db:columns", $r->Columns);
		//options
		$cdiv = $div->addDiv();
		IGKHtmlUtils::AddImgLnk($cdiv, igk_js_post_frame($this->getUri("db_insert_db_entry_frame_ajx")), "add_16x16");
		IGKHtmlUtils::AddImgLnk($cdiv, $this->getUri("db_Clearall_db_entry"), "drop_16x16");

		IGKHtmlUtils::AddBtnLnk($div, R::ngets("btn.close"),
			$frame->CloseUri
		)->setAttribute("onclick","javascript: (function(q){ ns_igk.winui.framebox.close_currentframe(q); })(this); return false;");
		IGKHtmlUtils::ToggleTableClassColor($table, "tr");

		$this->View();
		$mysql->Close();
		if ($navigate){
			igk_navtocurrent();
			igk_exit();
		}
		return $frame;
	}

	public function db_update_entry()	{
		if(!$this->ConfigCtrl->IsConnected)
			return;

		$dbname = igk_getr("cldb", $this->getParam("db:dbname"));
		$table = igk_getr("cltable", $this->getParam("db:table"));
		$n = igk_getr("cln", $this->getParam("update:n"));
		$s = igk_getr("cls", $this->getParam("update:s"));
		$tclist = $this->getParam("update:cllist");
		$this->setParam("update:cllist",null);

		$adapter = igk_get_data_adapter($this, true);

		$ext = igk_getr('clexternal');

		if ($adapter )
		{
			$o = igk_get_robj();
			// if ($ext)
			// {
				unset($o->cln);
				unset($o->cldb);
				unset($o->cls);
				unset($o->cltable);
				unset($o->clexternal);
			//}
			// igk_wln(array($s=>$n));
			//igk_wln($o);
			// igk_exit();
			// igk_wln(isset($o->clPwd));
			if (isset($o->clPwd)&& empty($o->clPwd))
			{
				unset($o->clPwd);
			}
			foreach($tclist as $k=>$v){
				$ii = $o->$k -1;
				if ($ii>=0)
					$o->$k = get_class($v[$ii]);
			}
			// igk_wln($o);
			//e_xit;
			$adapter->connect($dbname);
			$adapter->update($table, $o, array($s=>$n),igk_db_getdatatableinfokey($table));
			$adapter->close();
		}
		//igk_frame_close("edit_entry_frame");
		if (!$ext)
		{
			$this->db_viewtableentries($dbname, $table);
		}
		else {
			$ctrl = igk_getctrl(igk_getr("ctrl"));
			if ($ctrl!=null){
				$ctrl->View();
			}
		}

	}

	public function db_dropSelectedTable_ajx($dbname=null){
		//grand access if connected
		if(!$this->ConfigCtrl->IsConnected)
			return;
		$db = $dbname? $dbname: $this->App->Configs->db_name;
		if (igk_qr_confirm())
		{
				if ($db == null)
				{
					igk_wln("no db name selected");
					return;
				}
				$h = null;

				$adapter = igk_get_data_adapter($this, true);
				if (!$adapter )
					return;
				$query = $this->getParam("db:dropSelectedTable");
				$h = igk_getv($query, "tname");

				if ($h && $adapter->connect($db)){
					if ($adapter->dropTable($h)){
						igk_notifyctrl()->addMsgr("msg.db.tabledelete_1", igk_count($h));
					}
					else{
						igk_notifyctrl()->addErrorr("e.db.deletetableerror_1", igk_debuggerview()->getMessage());
					}
					$adapter->close();
				}
				else{
					igk_notifyctrl()->addError("Aucune table selectionner");
				}
				$this->setParam("frame:tname", null);

				$this->setParam("db:dropSelectedTable",null);
				igk_notifyctrl()->addMsgr("msg.databaseupdated");
				$c = igk_debuggerview()->getMessage();
				if (!empty($c))
					igk_notifyctrl()->addError($c);
				$this->View();
				igk_navtocurrent();
		}
		else{
				$tname = igk_getv($_REQUEST, "tname");
				if ($tname && (count($tname)>0))
				{
				$frame = igk_frame_add_confirm($this, "confirm_Clear_backup_file", $this->getUri("db_dropSelectedTable_ajx"));
				$frame->Form->Div->Content = R::ngets("q.deleteallselecteddbtable");
				//$frame->Form->Div->addDiv()->addPrev($_REQUEST);
				$frame->Form->addInput("dbname", "hidden", $dbname);
				$this->setParam("db:dropSelectedTable", $_REQUEST);
				$frame->RenderAJX();
				}

		}
	}


	public function db_drop_entry(){
		$n = igk_getr("n");
		$s = igk_getr("s");
		$dbname = $this->getParam("db:dbname");
		$table = $this->getParam("db:table");

		$db = igk_get_data_adapter($this, true);
		if ($db && $db->connect())
		{
			$db->selectdb($dbname);
			//delete
			$db->delete($table, array($s=>$n));
			$db->close();
		}

		$this->db_viewtableentries($dbname, $table);

	}
	public function db_insert_db_entry(){
		$r = $this->getParam("db:r");
		$dbname = $this->getParam("db:dbname");
		$n = $this->getParam("db:table");

		$b = igk_get_robj();

		$db = igk_get_data_adapter($this, true);
		if ($db){
			$db->connect();
			$db->selectdb($dbname);
			//insert db entry
			//get data table info from keys
			$t = igk_db_getdatatableinfokey($n);

			$db->insert($n, (array)$b, $t);
			$db->close();
		}
		$this->db_viewtableentries($dbname, $n);
		igk_exit();
	}
	public function db_edit_entry_ajx(){//edit db entry
		$n = igk_getr("n");
		$s = igk_getr("s");
		$dbname = $this->getParam("db:dbname");
		$table = $this->getParam("db:table");

		$this->db_edit_entry_frame($this, $dbname, $table, $n, $s, true);

	}
	public function db_edit_entry_frame($ctrl, $dbname, $table, $n, $s, $render=true){

		$this->setParam("update:n",$n);
		$this->setParam("update:s",$s);
		// $frame = igk_add_new_frame($ctrl,"edit_entry_frame");
		// $frame->Title  = R::ngets("title.db_editentry");
		// $frame->BoxContent->Clear();
		$frm = igk_createNode("form");//$frame->BoxContent->addForm();
		$frm["action"] = $this->getUri("db_update_entry");
		$frm->addInput("cltable", "hidden", $table);
		$frm->addInput("cldb", "hidden", $dbname);
		$frm->addInput("cln", "hidden", $n);
		$frm->addInput("cls", "hidden", $s);
		if ($ctrl !== $this){
			$frm->addInput("clexternal", "hidden", 1);
			$frm->addInput("ctrl", "hidden", $ctrl->Name);
		}

		$mysql = igk_get_data_adapter($ctrl, true);
		if ($mysql )
		{
			$mysql->connect($dbname);
			//$q = "SELECT * FROM `".$table."` WHERE `".mysql_real_escape_string ($s)."`='". mysql_real_escape_string($n)."'";

			$e = $mysql->select($table, array($s=>$n));//sendQuery($q);
			if ($e->RowCount == 1)
			{
				$ul = $frm->add("ul");

				$l = $e->getRowAtIndex(0);
				foreach($e->Columns as $k)
				{
					$li = $ul->addLi();
					$v = $k->name;
					if (($table == "tbigk_users") && ($v=="clClassName")){
						$li->add("label")->Content = R::ngets("lb.{$v}");
						$sl = $li->add("select");
						$sl->setId($v);
						$sl->add("option")->setAttributes(array("value"=>"0"));
						//get class initialization
						$h = 1;
						$cllist = igk_sys_getuserctrls();
						$tcllist = array();
						foreach($cllist as $b=>$c){
							$o = $sl->add("option");
							$o['value']=$h;
							$o->Content = $c->Name;
							$h++;
							$tcllist[] = $c;

							if ($c->Name == $l->$v){
								$o["selected"]="true";
							}
						}
						$this->setParam("update:cllist", array($v=> $tcllist));


					}else
						igk_html_build_form_entry($v, $k->typeName, $li, $l->$v);
				}
				// $mysql->close();

			}
			$mysql->close();
		}
		$frm->addHSep();
		$frm->addInput("btn_update", "submit", R::ngets("btn.update"));
		if ($render){
			//$frame->RenderAJX();
			igk_ajx_notify_dialog( R::ngets("title.db_editentry"), $frm->Render(null));
		}
		return $frm;
	}
	public function db_insert_db_entry_frame_ajx(){
		$frame = igk_add_new_frame($this, __FUNCTION__);
		$frame->ClearChilds();
		$frame->Title = R::ngets("title.db.insertnewentry");
		$d = $frame->BoxContent;
		$frm = $d->addForm();
		$frm["action"]= $this->getUri("db_insert_db_entry");
		//$frm["igk-ajx-form"] = "1";
		$ul  = $frm->add("ul");
		$c = $this->getParam("db:columns");
		if ($c){
			foreach($c as $k)
			{
				$li = $ul->addLi();
				$pwd = $k->name == IGK_FD_PASSWORD;
				switch(strtolower($k->type))
				{

					case "blob":
						$li->addSLabelTextarea($k->name, "lb.".$k->name, array("class"=>"-cltextarea"));
						break;
					case "string":
					case "text":
					default:
						$li->addSLabelInput($k->name, $pwd ? "password" : "text", $pwd? "": $k->def);
						break;
				}
			}

		}
		$frm->addHSep();
		$frm->addBtn("btn_add", R::ngets("btn.add"));
		//IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.close"), $frame->CloseUri);
		$frame->RenderAJX();
	}

	public function db_Clearall_db_entry()
	{
		$r = $this->getParam("db:r");
		$dbname = $this->getParam("db:dbname");
		$tbname= $this->getParam("db:table");
		//$n = igk_getr("confirm");
		if (igk_qr_confirm())
		{
			$db = igk_get_data_adapter($this, true);
			if ($db){
			$db->connect();
			$db->selectdb($dbname);
			//delete all entries
			$db->deleteAll($tbname);
			$db->close();
			}
			$this->db_viewtableentries($dbname, $tbname);
		}
		else{
			$frame = igk_frame_add_confirm($this, "frame_Clearall",$this->getUri("db_Clearall_db_entry"));
			$frame->Form->Div->Content = R::ngets("Q.WILLYOUDROPTHECONTENTOFTHISTABLE", $tbname);
		}

	}

	///<summary>drop table associated to a controller</summary>
    public function db_drop_tables($ctrl, $dbname=null){
		$tables = $this->getTablesFor($ctrl);
		if (!is_array($tables))
			return;
		$ad = igk_get_data_adapter($ctrl, true);
		if ($ad && $ad->connect($dbname)){
			$ad->dropTable($tables);
			$ad->close();
		}
	}
	///<summary>backup table associated to a controller</summary>
	public function db_backup_tables($ctrl, $outtag, $dbname=null, $storetableinfo = true){
		$tables = $this->getTablesFor($ctrl);
		if (!is_array($tables))
			return;
		//	igk_wln($tables);

		$ad = igk_get_data_adapter($this, true);
		if ($ad && $ad->connect($dbname)){

				$e = $outtag->addNode(IGK_ENTRIES_TAGNAME);
				foreach($tables as $k=>$v){
					$tabinfo = $this->getDataTableDefinition($v, false);
					if (!$tabinfo)
						continue;

					if ($storetableinfo){
					$def = $outtag->addNode(IGK_DATA_DEF_TAGNAME);
					$def["TableName"] = $v;

					//store info
						//get controller that manage table
						//$tabinfo = igk_getv($this->m_loadTables, $v);
						//igk_wl($v." \n");
						//$s = igk_db_create_row($v);
						//$minfo = igk_db_getdatatableinfokey($v);
						//igk_wln($s);

						//$tabinfo = $this->getTableInfo($v);
						// igk_wln($tabinfo);



						foreach($tabinfo as $ck=>$c){
							switch($ck){
								case "Description":
								break;
								default:
								foreach($c as $mm=>$nn){
									$col = $def->add(IGK_COLUMN_TAGNAME);
									$col->setAttributes($nn);
								}
								break;
							}
						}
					}

					$table = $e->addNode($v);
					$r = $ad->selectAll($v);
					foreach($r->Rows as $m=>$n){
						$table->addNode(IGK_ROW_TAGNAME)->setAttributes($n);
					}

				}
			$ad->close();
		}
	}
	///<summary>drop all tables</summary>
	public function db_drop_sys_tables(){
		$tab = $this->getAllTableNames();
		$attrb = array();
		foreach($tab as $k => $v){
			$c = $this->m_loadTables[$v];
			$ad = igk_get_data_adapter($c, true);
			$cl=  get_class($ad);
			$inf=null;
			if (isset($attrb[$cl])){
				$inf =  $attrb[$cl];
			}
			else {
				$inf = (object)array('adapter'=>$ad, 'tables'=>array());

			}
			$inf->tables[] = $v;

			$attrb[$cl] = $inf;
		}
		foreach($attrb as $k=>$v){
			$ad = $v->adapter;
			if ($ad->connect()){
				$ad->initForInitDb();
				$ad->dropTable($v->tables);
				$ad->flushForInitDb();
				$ad->close();
			}
		}
	}
}

//-----------------------------------------------------------------------------
///represent a language language controller
//-----------------------------------------------------------------------------
final class IGKLangCtrl extends IGKConfigCtrlBase
{
	private $m_searchkey;
	private $m_changeState;
	private $m_search_new_key;
	const DEFAULT_LANG_FOLDER = IGK_DEFAULT_LANG_FOLDER;

	public function getName(){return IGK_LANG_CTRL;}
	public function getConfigPage(){return "langconfig"; }


	public function IsFunctionExposed($funcName){
		switch($funcName)
		{
			case "getlangkeys":
			case "mod_key":
				return true;
		}
		return parent::IsFunctionExposed($funcName);
	}
	//publid function to get current languages file
	public function getlangkeys(){

		$format = igk_getr("format", "xml");
		$v_node =  igk_createNode("languages");
		switch($format)
		{
			case "xml":
				header("Content-Type: application/xml");
				break;
		}
		$v_node["name"] = R::GetCurrentLang();
		$tab = R::GetLangInfo();
		$ktab = array_keys($tab);
		igk_usort($ktab, "igk_key_sort");
		$c = 0;
		//return;
		foreach($ktab as $k)
		{
			$v = $tab[$k];

			$tr = $v_node->add("item");
			$tr["name"] = igk_parsexmlvalue($k);
			$tr["value"] = igk_parsexmlvalue($v);
		}
		igk_wl($v_node->Render());
		igk_exit();

	}


	public function __construct(){
		parent::__construct();
	}
	protected function InitComplete()
	{
		parent::InitComplete();
		R::getInstance()->PageLangChangedEvent->add($this, "View");
		R::getInstance()->KeysAdded->add($this, "keyAdded");		

		// igk_reg_session_event(IGK_ENV_LANG_CHANGED, array($this, "onLangChanged"));
		// igk_reg_session_event(IGK_ENV_NEW_DOC_CREATED, array($this, "onnewDocCreated"));


		$this->App->Doc->lang = R::GetCurrentLang();
		$this->_registerLangExpression($this->App->Doc->body);
		//igk_notification_reg_event("sys://events/viewmodechanged", array($this,"initview"));
	}
	
	public function onHandleSystemEvent($msg){
		
	}
	
	public function initview($o,$e){
		if ($this->App->IsSupportViewMode(IGKViewMode::WEBMASTER)){
			$this->_registerLangExpression($this->App->Doc->body);
		}
	}
	public function keyAdded($obj, $key){
		$v = $this->getParam("lang:onview");
		if (!$v){
			if (!empty($key))
			{
				$this->View();
			}
			else
				igk_die("try to add empty key");
		}
	}
	public function onLangChanged($ctrl){
		$r = R::getInstance();
		$c =  $r->langChangedConf;
		if ($ctrl->isChanged("LangChanged", $c))
		{
			$this->reloadlang();
		}
	}
	public function add_key()	{
		//igk_wln("key added");
		$n = igk_getr(IGK_FD_NAME);
		$v = igk_getr("clvalue");
		if (!empty($n))
		{
			R::AddLang($n, $v);
			R::SaveLang();
		}
		igk_navtocurrent();
	}
	public function add_key_frame_ajx(){
		$frame = igk_add_new_frame($this, "add_key_frame");
		$frame->ClearChilds();
		$frame->Title = R::ngets("title.editLangkeyframe");
		$d = $frame->BoxContent;
		$frm = $d->addForm();
		$frm["action"]= $this->getUri("add_key");
		$ul  = $frm->add("ul");
		$ul->addLi()->addSLabelInput(IGK_FD_NAME);
		$ul->addLi()->addSLabelInput("clvalue");
		$frm->addHSep();
		$frm->addBtn("btn_add", R::ngets("btn.add"));

		$frame->RenderAJX();
	}
	public function reloadlang(){
		R::LoadLang();
		$this->View();
	}
	public function get_new_keys(){
		$this->m_search_new_key = !($this->m_search_new_key);
		$this->View();
		igk_navtocurrent();
	}
	private function loadLangOptions($c){
		IGKHtmlUtils::AddBtnLnk($c, R::ngets("btn.add"),"#", array("onclick"=>igk_js_post_frame($this->getUri("add_key_frame_ajx")). " return false; "));
		IGKHtmlUtils::AddBtnLnk($c, R::ngets("btn.searchnewkey"),$this->getUri("get_new_keys"));
		IGKHtmlUtils::AddBtnLnk($c, R::ngets("btn.reload"), $this->getUri("reloadlang"));
		IGKHtmlUtils::AddBtnLnk($c, R::ngets("btn.storeasexternal"), $this->getUri("lang_store_external"));
		//IGKHtmlUtils::AddBtnLnk($c, R::ngets("btn.restoredefault"), igk_js_post_frame($this->getUri("lang_load_default")));
		//IGKHtmlUtils::AddBtnLnk($c, R::ngets("btn.saveAsdefault"), $this->getUri("lang_save_as_default"));
	}
	public function lang_store_external(){
		R::SaveLangXml();
		$f= igk_io_baseDir("R/Lang/".R::GetCurrentLang().".xml");
		igk_download_file("lang.".R::GetCurrentLang().".xml", $f);
		igk_exit();
	}


	public function onnewDocCreated($o,$e){
		$this->_registerLangExpression($e->body);
	}
	private function _registerLangExpression($body){
		if ($body=== null)
			return;
		$uri = $this->getUri("");
		$k = strtolower($this->Name.":script");
		$body->addScriptContent($k,  "ns_igk.readyinvoke('igk.ctrl.regCtrl', '{$this->Name}', '{$uri}');");//if (window.igk)window.igk.ctrl.regCtrl('{$this->Name}', '{$uri}'); ");
	}
	public function View(){
		igk_google_addfont($this->App->Doc, "Roboto");
		$this->setParam("lang:onview",true);
		$this->App->Doc->lang = R::GetCurrentLang();
		$c = $this->TargetNode;
		$c["class"]="google-Roboto";
		$c->ClearChilds();
		if ( !$this->getIsVisible())
		{
			igk_html_rm($c);
			return;
		}
		igk_html_add($c, $this->ConfigNode);
		$c->Index = 100;
		$div = $c->addDiv();
		igk_html_add_title($div, "title.language.ctrlconfig");
		$div->addHSep();
		$div->addPanelBox()->addArticle($this, "language.description");
		$div = $c->addDiv();
		$div["style"]="margin:16px 0px 16px 0px;";
		$div->addHSep();

		$frm = $div->addForm();
		$languages = $frm->add("ul");
		$languages["class"] = $languages["id"] = "igk-language-list";

		foreach(igk_getctrl(IGK_CSVLANGUAGE_CTRL)->Languages as $k=>$v)
		{
			$languages->addLi()->add("a", array("href"=>"?l=".$v))->add("img", array(
			"src"=>R::GetImgUri("flag_$v")));
		}
		//add new lang button
		IGKHtmlUtils::AddImgLnk($frm, igk_js_post_frame($this->getUri("lang_add_new_frame_ajx")), "add_16x16");
		$div->addHSep();

		//search key button
		$search = new IGKHtmlSearchItem($this->getUri("lang_skey"), $this->m_searchkey);
		//$search->setClass("+fitw");
		$search->TargetId = "#".$this->TargetNode["id"];
		$search->loadingComplete();


		$c->add($search);
		$c->addHSep();
		$this->loadLangOptions($c);
		$c->addBr();
		igk_notifyctrl()->setNotifyHost($c->addDiv());
		$frm = $c->addForm();

		$frm["action"]= $this->getUri("update_language_ajx");
		$frm["method"]="POST";
		$frm["id"]="frm_langkeys_view";
		$frm["igk-ajx-form"] = 1;
		//$frm["igk-ajx-form-target"]= "::";

		$d  = $frm->addDiv();
		//igk_add_loading_frame($d->addDiv()->setClass("dispb fitw alignc"));
		$d->addCircleWaiter();
		$d->addScript()->Content =
		 "(function(q){  \$ns_igk.ready(function(){ns_igk.ajx.apost('".$this->getUri("lang_getKeys_ajx")."',null, igk.ajx.fn.replace_node(q) , true);});} )(ns_igk.getParentScriptForm());";
		$this->setParam("lang:gui_langview", $frm);
		$c->addHSep();
		$this->loadLangOptions($c);

		$this->setParam("lang:onview",null);
	}
	public function lang_add_new_frame_ajx()
	{
		$frame = igk_add_new_frame($this, "add_lang_frame");
		$frame->Title = R::ngets("title.AddNewLang");
		$frame->ClearChilds();
		$frm = $frame->BoxContent->addForm();
		$frm["action"]= $this->getUri("lang_add_lang");
		$ul = $frm->add("ul");
		$ul->addLi()->addSLabelInput("clKey");
		$ul->addLi()->addSLabelInput("clFile", "file");
		$frm->addHSep();
		$frm->addInput("btn_submit","submit" ,R::ngets("btn.add"));
		$frame->RenderAJX();
		return $frame;
	}
	public function lang_add_lang()
	{
		$f = igk_getv($_FILES, "clFile");
		$c = igk_getr("clKey");
		igk_getctrl(IGK_CSVLANGUAGE_CTRL)->addLang($c);

		if ($f["size"]> 0)
		{
			loadtempfile($f["tmp_name"], $f["name"], "flag_".c, "Flags");
		}
		$this->View();
		igk_navtocurrent();
	}
	public function lang_getKeys_ajx(){
		$frm = $this->getParam("lang:gui_langview");
		if ($frm == null)
			return;

		$frm->ClearChilds();
		$c = 0;
		if ($this->m_search_new_key)
		{
			$frm->addDiv()->Content = R::ngets("msg.findnewkey");
		}
		$table = $frm->addTable()->setClass("listlangentry");
		$tr = $table->addTr();
		$tr["class"]="tbh";
		IGKHtmlUtils::AddToggleAllCheckboxTh($tr);
		$tr->add("th")->Content = R::ngets("lb.".IGK_FD_NAME);
		$tr->add("th", array("class"=>"fitw"))->Content = R::ngets("lb.clValue");
		$tr->add("th")->Content = "&nbsp;";

		$i = 0;
		//get key and keys sort
		$tab = R::GetLangInfo();
		$ktab = array_keys($tab);
		igk_usort($ktab, "igk_key_sort");

		//foreach keys as keys tab
		$v_count = 0;
		$pages_filter = array();
		$pages_filter[] = array();
		$page_c = 0;
		foreach($ktab as $k)
		{
			$v = $tab[$k];
			if ($this->m_search_new_key)
			{
				if (empty($k) || (($this->m_searchkey) && !strstr(strtolower($k),strtolower($this->m_searchkey))) ||
				( $v != $k))
					continue;
			}
			else{
				if (empty($k) || (($this->m_searchkey) && !strstr($k,strtolower($this->m_searchkey))) )
					continue;
			}
			$pages_filter[$page_c][$k] = $v;


			$c++;
			$v_count++;
			if ($v_count >= 50)
			{
				$v_count = 0;
				$page_c++;
				$pages_filter[] = array();
			}
		}

		$cpage = igk_getr("pager", 0);

		$tab = $pages_filter[$cpage];

		if (igk_count($tab) == 0)
		{
			$tr = $table->addTr()->addTd()->setAttribute("colspan", 4)->Content = R::ngets("msg.noresult");
		}
		else{
		foreach($tab as $k=>$v)
		{
			$tr = $table->addTr();
			$tr->addTd()->addInput("check_values_".$c, "checkbox");
			$tr->addTd()->add("label",array("for"=>"e_values".$c, "class"=>"-cllabel"))->Content = $k;
			$td = $tr->addTd();
			$td->add("input", array("type"=>"text", "class"=>"cltext" , "value"=>$v,"name"=>"e_values[]", "id"=>"e_values".$c ));

			$tr->add("input", array("type"=>"hidden","value"=>$k,"name"=>"e_keys[]", "id"=>"e_keys[]" ));
			$tr->addTd()->addLi()->add("a", array("href"=>$this->getUri("rmkey&n=".base64_encode($k))))
			->add("img", array("width"=>"16px","height"=>"16px", "src"=>R::GetImgUri("drop_16x16"),"alt"=>R::ngets("info.droptable")));//->Content = $v;
		}
		}
		$p = igk_count($pages_filter);
		if ($p > 1){
		$page = $frm->addDiv()
		->setClass("alignt alignc")
		->addPagination();
		$page->CurrentPage = $cpage;
		$page->MaxPage = $p;
		$page->PrevUri = "javascript: ns_igk.ajx.post('".$this->getUri("lang_getKeys_ajx&pager=".($cpage-1))."', null, ns_igk.ajx.getResponseNodeFunction(this, 'form')); return false;";
		$page->NextUri = "javascript: ns_igk.ajx.post('".$this->getUri("lang_getKeys_ajx&pager=".($cpage+1))."', null, ns_igk.ajx.getResponseNodeFunction(this, 'form')); return false;";

			for($i = 0; $i < igk_count($pages_filter); $i++)
			{
				$p = $page->addPage($i+1, "javascript: ns_igk.ajx.post('".$this->getUri("lang_getKeys_ajx&pager=".$i)."', null, ns_igk.ajx.getResponseNodeFunction(this, 'form')); return false;");
				if ($i == $cpage)
				{
					$p["class"] = "igk-active";
				}
			}
			$page->flush();
		}


		$frm->addInput("btn_update","submit",  R::ngets("btn.update"));

		IGKHtmlUtils::ToggleTableClassColor($table, "tr",1);
		$confirm_msg = R::gets("q.confirm.deleteall");
		IGKHtmlUtils::AddBtnLnk($frm ,R::ngets("btn.rmAll"), $this->getUri("Clearall"), array(
			 "onclick"=>"javascript: (function(q){ var frm = ns_igk.getParentByTagName(q,'form'); if ( frm && window.confirm('".$confirm_msg."')) {frm.confirm.value = 1; frm.action = q.href ; frm.submit(); }})(this); return false;"
		) );

		$frm->addInput("btn_rmsel", "submit",R::ngets("btn.rmSelection"), array("onclick"=>"this.form.action ='".$this->getUri("removeselectedmenu")."'; "));
		$frm->addInput("max_values", "hidden",$c);
		$frm->addInput("confirm", "hidden",0);
		$frm->RenderAJX();
		igk_exit();
	}
	///remove selected items
	public function removeselectedmenu(){
		$m = igk_getr("max_values", 0);
		$keys = igk_getr("e_keys", null) ;
		$mc = 0;
		//get the reference of the tab control
		$tab = & R::getInstance()->langRes;

		$before = count($tab);
		for($i = 0; $i< $m; $i++)
		{
			$t = igk_getr("check_values_".$i);
			if ($t)
			{
				$n =$keys[$i];
				if (R::RemoveKey($n))
				{
					$mc++;
				}
			}
		}
		$after = count($tab);

		if (R::SaveLang())
		{
			igk_notifyctrl()->addMsg("delete selected value ".$mc .":".$before. " / ".$after ."/".count( R::getInstance()->langRes));
		}
		else{
			igk_notifyctrl()->addErrorr("E.LangNotSave");
		}
		igk_navtocurrent();

	}
	public function Clearall(){
		if (igk_qr_confirm()){
			R::ClearLang();
			$this->View();
		}
		else{
			$frame = igk_frame_add_confirm($this, "frame_Clearall",$this->getUri("Clearall"));
			$frame->Form->Div->Content = R::ngets("Q.AREUSHURETODELETEALL");
		}
	}

	public function update_language_ajx(){

		if (igk_getr("btn_rmsel")!=null) {
			$this->removeselectedmenu();
			return;
		}
		$td = igk_getr("e_keys", null);
		$tv = igk_getr("e_values", null);
		if(is_array($td))
		{
			foreach($td as $k=>$v)
			{
				R::AddLang($v, $tv[$k]);
			}
		}
		if (R::SaveLang()){
			igk_notifyctrl()->addMsgr("msg.languageupdated");
		}
		else{
			igk_notifyctrl()->addErrorr("E.LanguageNotupdated");
		}
		//$this->View();
		//igk_navtocurrent();
		igk_ajx_replace_ctrl_view($this);
	}

	public function lang_skey(){//lang searchkey
		$this->m_searchkey = igk_getr("q");
		$this->View();
	}

	public function lang_skey_ajx(){//lang searchkey ajx
		$this->lang_skey();
		igk_wl($this->TargetNode->innerHTML);
	}


	public function rmkey()	{
		$n = base64_decode( igk_getr("n"));
		R::RemoveKey($n);
		R::SaveLang();
		$this->View();
		igk_navtocurrent();
	}

	public function mod_key(){
		//	igk_wln($_REQUEST);
		if (igk_qr_confirm()){
			$n =igk_getr(IGK_FD_NAME);
			$v =igk_getr("clValue");
			R::AddLang(igk_getr(IGK_FD_NAME), igk_getr("clValue"));
			R::SaveLang();
			igk_frame_close(__FUNCTION__);
			//force all controller to reload
			$this->App->ViewControllers();
			//render current document

			// $ctrl = igk_getr("ctrl");
			// $rpctrl = 0;
			// if (!empty($ctrl)){
				// $c = igk_getctrl($ctrl);
				// if ($c){
					// //igk_ajx_replace_ctrl_view($c);
					// $rpctrl = 1;
				// }
			// }else{
				// igk_resetr();
				// $s = igk_uri_invokeCurrent("?igk-bodyonly=1");
				// //igk_wl($s);
			// }

			// if (!$rpctrl){
				// $doc = igk_get_last_rendered_document();
				// if($doc!=null){
					// //$doc->body->RenderAJX();
				// }
			// }

			//force to close in client side
			igk_createNode("script")->setContent("igk.winui.framebox.closeCurrentFrame(); igk.rmCurrentScript(); ")->RenderAJX();
			igk_createNode("script")->setContent("igk.winui.langkey.fn.update('{$n}', '{$v}');")->RenderAJX();
			igk_notification_push_event("sys://langkey/changed", $this);
			igk_exit();
		}
		else{
			$f = igk_add_new_frame($this, __FUNCTION__);
			$f->BoxContent->ClearChilds();
			$frm = $f->BoxContent->addDiv()->addForm();
			$frm["action"] = $this->getUri(__FUNCTION__);
			$frm["igk-ajx-form"]= 1;
			$f->Title = R::ngets("title.lang.changekeyvalue");
			$frm->addGroupControl()
			->addSLabelInput(IGK_FD_NAME, "text", igk_getr("key"))
			->input->setClass("igk-form-control")
			->setAttribute("readonly","true");
			$frm->addGroupControl()
			->addSLabelInput("clValue","text", igk_getr("key"))->input->setClass("igk-form-control");
			$frm->addHSep();
			$frm->addDiv()->addInput("btn.update" , "submit", R::ngets("btn.update"))->setClass("igk-btn igk-btn-default");
			$frm->addDiv()->addInput("confirm" , "hidden", 1);
			$frm->addHidden("ctrl", igk_getr("ctrl"));
			$f->RenderAJX();
			igk_exit();
		}
	}
}

///<summary>represent the load data manager<summary>
final class IGKCSVLanguageManagerCtrl extends IGKNonVisibleControllerBase
{
	const DATAFILE = "Data/languages.csv";
	private $m_languages;

	public function getLanguages(){
		return $this->m_languages;
	}
	public function getName(){return IGK_CSVLANGUAGE_CTRL;	}

	public function __construct()
	{
		parent::__construct();
		$this->m_languages = array();
		$this->_loadData();
	}
	///<summary>return the installed language expression</summary>
	public function getLangRegex()
	{
		$o = "(";
		$i = 0;
		foreach($this->m_languages as $k)
		{
			if ($i ==1)
				$o.="|";
			$o.= $k;
			$i=1;
		}
		$o.=")";
		return $o;
	}
	private function _loadData()
	{
		$r = IGKCSVDataAdapter::LoadData(igk_io_syspath(self::DATAFILE));
		if ($r)
		{
			$this->m_languages = array();
			foreach($r as $l)
			{
				$this->m_languages[$l[0]] = $l[0];
			}
		}
	}
	public function addLang($n)
	{
		if (!empty($n) && !isset($this->m_languages[$n]))
		{
			$this->m_languages[$n] = $n;
			$out = IGK_STR_EMPTY;
			foreach($this->m_languages as $k=>$v){
				$out .= $v."\n";
			}
			igk_io_save_file_as_utf8(igk_io_syspath(self::DATAFILE), $out,true);

		}
	}

	public function support($lang){
		return preg_match($this->getLangRegex(), $lang);
	}

	public function View(){
		//do nothing
	}
	public function getDataAdapterName()	{return "CSV";}
	protected function initDb(){//init support language db
	$content = <<<EOF
fr,
en,
nl
EOF;
		igk_io_save_file_as_utf8(igk_io_syspath(self::DATAFILE), $content,true);
		$this->_loadData();
	}
}


///<summary>
///used to configure layout controller list
///</summary>
final class IGKLayoutCtrl extends IGKNonVisibleControllerBase
{
	private $m_currentLayout;

	public function getCurrentLayout(){return $this->m_currentLayout;}
	public function setCurrentLayout($value){$this->m_currentLaout = $value;}
	public function getName(){return IGK_LAYOUT_CTRL; }
	public function getDataAdapterName(){ return IGK_CSV_DATAADAPTER;}
	public function loadLayout(){
		IGKIO::CreateDir(IGK_LAYOUT_FOLDER);
		$n = igk_getr(IGK_FD_NAME);
		$f = igk_currentRelativePath("Layouts/".$n.".xml");
		$t = igk_getv($_FILES,"clFile");
		if (igk_io_move_uploaded_file($t["tmp_name"], $f))
		{
			//register layout
		}

	}
	public function removeLayout(){
		$n = igk_getr("n");
		$f = igk_currentRelativePath("Layouts/".$n.".xml");
		if (file_exists($f))
		{
			unlink($f);
		}
	}
	public function IsFunctionExposed($funcname){
		return true;
	}
}

//-----------------------------------------------------------------------------------------
//PICTURES RESOURCES CONTROLLERS
//-----------------------------------------------------------------------------------------
final class IGKPICRESCtrl extends IGKConfigCtrlBase
{
	// private $m_fileres;// CSV DATA  - name
					 //           - uri
	// private $m_cpage;//current page
	// private $m_selectedir ;
	// private $m_searchentry;
	// private $m_fileexts;
	// private $m_changeState;
	//constante
	const DATAFILE = "Data/upload.csv";
	const TARGETDIR = "R/Img";
	const PICRES_KEY = "PicResChanged";
	const KEY_FILES = "sys://ctrl/allpics";
	const PICRES_FLAG = 1;

	public function getPicRes(){
		return igk_app()->Doc->{"@PictureRes"}; //$this->{};//getFlag(self::PICRES_FLAG);
	}
	protected function setPicRes($t){
		igk_app()->Doc->{"@PictureRes"};
	}
	// private $m_lastDate;
	protected function InitComplete()
	{
		parent::InitComplete();
		// igk_reg_session_event(IGK_ENV_SETTING_CHANGED, array($this, "onPicResChanged"));
		// igk_notification_reg_event(IGK_FORCEVIEW_EVENT, array($this, "notify"));
	}
	public function notify($c=null,$t=null){
		$this->_loadData();
	}
	private function onPicResChanged($ctrl){
		if ( $ctrl->isChanged(self::PICRES_KEY, $this->m_changeState))
		{
			$this->_loadData();
		}
	}
	public function onHandleSystemEvent($msg){
		switch($msg){
			case IGK_ENV_SETTING_CHANGED:
			$this->onPicResChanged(func_get_args(1));
			break;
			case IGK_FORCEVIEW_EVENT:
				$this->notify();
			break;
		}
	}

	///<summary>get all pictures resources entries</summary>
	public function getAllPics()
	{
		return igk_get_env_init("sys://ctrl/allpics", function(){
			$g = array();
			$this->_loadData($g);
			return $g;
		});
	}
	//store data
	private function _storeData()
	{
		$out = IGK_STR_EMPTY;
		$g = $this->getAllPics();
		foreach($g as $k=>$v)
		{
			$out .= $k.igk_csv_sep().$v.IGK_LF;
		}
		if (igk_io_save_file_as_utf8(igk_io_syspath(self::DATAFILE), $out, true))
		{
			//igk_getctrl(IGK_CHANGE_MAN_CTRL)->registerChange
			igk_sys_regchange(self::PICRES_KEY, $this->m_changeState);
			return true;
		}
		return false;
	}
	public function getName(){return IGK_PIC_RES_CTRL;	}
	public function __construct(){
		parent::__construct();
	}

	private function _getexts()
	{
		$tab = explode(";",strtolower(IGK_ALLOWED_EXTENSIONS));
		$this->m_fileexts = array();
		foreach($tab as $k)
		{
			$this->m_fileexts[strtolower($k)] = $k;
		}
	}
	private function _updateRes($g){
		igk_set_env(self::KEY_FILES, $g);
	}
	public function regPicture($name, $link){
		$g = $this->getAllPics();
		if ($link){
			$g[$name] = $link;
		}
		$this->_updateRes($g);
	}
	private function _support($ext)
	{
		$this->_getexts();
		return isset($this->m_fileexts[strtolower($ext)]);
	}
	function _loadData(& $tab=null)
	{
		//Clear file list
		$f = igk_io_syspath(self::DATAFILE);
		$txt = IGKIO::ReadAllText($f);
		$lines = explode(IGK_LF, $txt);
		$this->_initDefaultPictureRes($tab);
		$this->initPicturesRes(igk_io_currentRelativePath("R/Img"), $tab);
		$g = array();
		foreach($lines as $l)
		{
			if (empty($l))
				continue;
			$e = explode( igk_csv_sep(), $l);
			//replace with registered files
			$g [$e[0]] = igk_html_uri($e[1]);
		}
		return $g;
	}
	//# add resources
	public function add_res($name, $uri)
	{
		$g = $this->getAllPics();
		$g[$name] = $uri;
		if (!isset($g[$name]))
		{
			$g[$name] = $uri;

			return true;
		}
		return false;

	}
	public function initPicturesRes($dir, & $tab= null)
	{
		if (!is_dir($dir))
			return;
		//retrive all picture file from directory
		$r = IGKIO::GetPictureFile($dir);
		$g = $tab ?? $this->getAllPics();
		foreach($r as $k)
		{
			$n = igk_io_basenamewithoutext($k);
			if (!isset($g[$n]))
				$g[$n] = igk_html_uri(igk_io_basePath($k));
		}
		$this->_updateRes($g);
		$tab= $g;

	}
	/// init default resources
	private function _initDefaultPictureRes(& $tab=null)
	{	//init default controller
		$dir = dirname(__FILE__)."/Default/R/Img";
		$this->initPicturesRes($dir, $tab);
	}
	public function getConfigPage(){return "pictureresconfig";}

	public function getImgUri($name, $check=false)
	{
		$res = $this->getPicRes() ?? (function(){
			//init picture resource
			$t = array();
			$this->_initDefaultPictureRes($t);
			$this->setPicRes($t);
			//$this->setFlag(self::PICRES_FLAG,$t);
			return $t;
		})();

		$b = igk_getv($res, $name, IGK_STR_EMPTY);
		if ($check && empty($b))
		{
			return $b;
		}
		$k = igk_html_resolv_img_uri(igk_io_baseDir($b));
		return $k;
	}
	public function viewpic($name=null){
		$n = ($name==null)? igk_getr("name",$name):$name;
	// igk_wln("call name");
	// igk_show_prev($this->m_fileres[$n]);

	$f = igk_io_currentRelativePath(igk_getv($this->m_fileres, $n, IGK_STR_EMPTY));
			header("Content-type: image/png");
		if (file_exists($f))
		{
			igk_wl( IGKIO::ReadAllText($f));
		}
		else{
			igk_wl( IGKIO::ReadAllText(igk_io_currentRelativePath(igk_getv($this->m_fileres, "none"))));
		}
		igk_exit();
	}

	protected function initTargetNode(){
		return igk_createNode("div", array("class"=>strtolower($this->Name)));
	}
	public function View(){
		$div = $this->TargetNode;
		$div->ClearChilds();
		if ($this->getIsVisible())
		{
			IGKHtmlUtils::AddItem($div, $this->ConfigNode);
			switch($this->m_cpage)
			{
				case "showentries":
					$this->showentries();
					break;
				default:
					$this->_showdefault();
					break;
			}
		}
		else{
			igk_html_rm($div);
		}
	}
	private function _showdefault()
	{
		$div = $this->TargetNode;
		igk_html_add_title($div, "title.PictureResourcesManager");
		$div->addHSep();

		igk_add_article($this, "pictures.res", $div->addDiv());
		$div->addHSep();
		//show directory
		$tab = igk_io_dirList(igk_io_currentRelativePath(self::TARGETDIR));

		igk_html_add_title($div, "title.PictureResourcesManagerFolder");
		if ($tab && (count($tab)>0))
		{
			$ul = $div->add("ul");
			foreach($tab as $k)
			{
				$li = $ul->addLi();
				$li->add("label",array("class"=>"-cllabel cell_minsize dispib"))->add("a", array(
					"href"=>$this->getUri("setdir&d=".base64_encode(urldecode($k))),
					"class"=>"config-fileviewdir"))->Content = basename($k);
				if ((count(igk_io_dirList($k)) == 0) && (count(igk_io_getfiles($k)) == 0)){
					IGKHtmlUtils::AddImgLnk($li, $this->getUri("dropdir&d=".base64_encode(urldecode($k))), "drop_16x16");
				}
				// $li = $ul->addLi();
				// $li->Content = $k;
			}
		}
		$div->addHSep();
		$rd = $div->addRow();
		$cl = $rd->addCol();
		$cl->addSectionTitle(5)->Content = R::ngets("title.uploadpictures");
		$frm = $this->_addLoadPicForm($cl);


		IGKHtmlUtils::AddBtnLnk($frm, "btn.showallpics", $this->getUri("showentries"));
		IGKHtmlUtils::AddBtnLnk($frm, "btn.rmAll", $this->getUri("deleteall"), array(
		"onclick"=>igk_js_lnk_confirm(R::ngets(IGK_MSG_ALLPICS_QUESTION)->getValue())
		));
		$frm->addInput("confirm", "hidden", 0);
	}
	private function _addLoadPicForm($div)
	{
		$frm = $div->addForm();
		$frm["action"]=$this->getUri("loadfile");
		$frm["method"]="POST";
		$frm["enctype"]=IGK_HTML_ENCTYPE;


		$frm->addSLabelInput("dir","text", $this->m_selectedir);$frm->addBr();
		$frm->addSLabelInput("name","text", null, null,true);$frm->addBr();
		$frm->addSLabelInput("pics", "file",null, array("multiple"=>false, "accept"=>"image/*" ),true);$frm->addBr();

		$frm->add("input", array("type"=>"hidden" , "name"=>"MAXFILESIZE", "value"=>5000));
		$frm->addHSep();
		$frm->addBtn("upload",R::gets("btn.upload"));
		return $frm;
	}
	public function dropdir()
	{
		$dir = basename(base64_decode( igk_getr("d", null)));
		$dir = igk_io_baseDir(self::TARGETDIR ."/".$dir);
		if (is_dir($dir)){

		if (IGKIO::RmDir($dir))
			igk_notifyctrl()->addMsgr("msg.directorydrop");
		else
			igk_notifyctrl()->addErrorr("msg.directorynotdrop");
			//igk_io_currentRelativePath(self::TARGETDIR ."/".$dir));
			$this->View();
		}
		igk_navtocurrent();
	}
	public function setdir()
	{
		$this->m_selectedir = basename(base64_decode( igk_getr("d", null)));
		$this->View();

	}
	public function loadtempfile($tempfile, $name, $id,  $dir)
	{
			$f = $tempfile;
			$ext = IGKIO::GetFileExt($name);

			if (!$this->_support(".".$ext))
			{
				igk_notifyctrl()->addError(ERR_FILE_NOT_SUPPORTED);
				return;
			}
		if (IGKIO::CreateDir($dir))
		{//ensure that file exits
			//igk_wln("dir created");
			$dest = igk_io_dir($dir."/".$id.".". $ext);
			if (!move_uploaded_file($f, $dest))
			{
				igk_notifyctrl()->addError("Unable to move uploaded file to ".$dest);
			}
			else{
				$this->m_fileres[$id] = igk_io_basePath($dest);
				if (!$this->_storeData())
				{
					igk_notifyctrl()->addError("Can't store data  to file \"".$id."\"");
					unlink($dest);
					unset($this->m_fileres[$id]);
				}
				else {
					igk_notifyctrl()->addMsg( R::gets("MSG.FileUploaded"));
				}
			}
	}
	}
	public function loadfile()
	{
		$id  = igk_getr("name");
		$dir = igk_getr("dir");

		$target = IGK_STR_EMPTY;
		$dest=IGK_STR_EMPTY;
		if (($id==null) || isset($this->m_fileres[$id]))
		{
			igk_notifyctrl()->addError(R::ngets("ERR.FILEISNULLORALREADYREGISTERED"));
			igk_navtocurrent();
			return;
		}
		if ($dir)
			$target = igk_io_currentRelativePath(self::TARGETDIR."/".$dir);
		else
			$target = igk_io_currentRelativePath(self::TARGETDIR);


			$f = $_FILES["pics"]["tmp_name"];
			$name = $_FILES["pics"]["name"];
			$ext = IGKIO::GetFileExt($name);

			if (!$this->_support(".".$ext))
			{
				igk_notifyctrl()->addError(ERR_FILE_NOT_SUPPORTED);
				return;
			}
		if (IGKIO::CreateDir($target))
		{//ensure that file exits
			//igk_wln("dir created");
			$dest = igk_io_dir($target."/".$id.".". $ext);
			if (!move_uploaded_file($f, $dest))
			{
				igk_notifyctrl()->addError("Unable to move uploaded file to ".$dest);
			}
			else{
				$this->m_fileres[$id] = igk_io_basePath($dest);
				if (!$this->_storeData())
				{
					igk_notifyctrl()->addError("Can't store data  to file \"".$id."\"");
					unlink($dest);
					unset($this->m_fileres[$id]);
				}
				else {
					igk_notifyctrl()->addMsg( R::gets("MSG.FileUploaded"));
				}
			}
		}
		else {
				$this->msbox->addError("Unable to move uploaded file to ".$dest);

		}
		$this->View();
	}

	//delete picture
	public function delfile(){
		$id=igk_getr("name");
		if (($id==null) || !isset($this->m_fileres[$id]))
			return;
		$f = igk_io_currentRelativePath($this->m_fileres[$id]);
		if (file_exists($f))
		{
			if (unlink($f))
			{
				unset($this->m_fileres[$id]);
				$this->_storeData();
			}
			else
				$this->msbox->addError("unabled to delete file");
		}
		else{
				//protection
				unset($this->m_fileres[$id]);
				$this->_storeData();
		}
		$this->View();
	}
	public function searchentry(){

		$this->m_searchentry = strtolower(igk_getr("q"));
		$this->View();
	}
	public function show_loadfile_frame()
	{
		$frame = igk_add_new_frame($this, "load_pic_frame");
		$frame->Title = R::ngets("title.loadpictureres");
		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $this->_addLoadPicForm($d);

	}
	public function showentries()
	{
		if ($this->App->CurrentPageFolder == IGK_CONFIG_MODE)
		{
			$this->m_cpage = "showentries";
			$div = $this->TargetNode;
			$div->ClearChilds();
			igk_html_add_title($div, "title.images");
			$div->addHSep();
			$div->add(new IGKHtmlSearchItem($this->getUri("searchentry"), $this->m_searchentry));
			$div->addHSep();
			$frm = $div->addForm();
			$frm["method"]="POST";
			$frm["action"]= $this->getUri();


			$v_div= $frm->addDiv();
			IGKHtmlUtils::AddBtnLnk($v_div, "btn.Return", $this->getUri("gotodefaultview"));
			IGKHtmlUtils::AddBtnLnk($v_div, "btn.loadfile", $this->getUri("show_loadfile_frame"));
			IGKHtmlUtils::AddBtnLnk($v_div, R::ngets("btn.RemoveBrokenfiles"), $this->getUri("remove_broken_file"));
			$frm->addBr();
			$info = $frm->addDiv();

			$tab = $frm->addTable();
			$tr = $tab->addTr();
			IGKHtmlUtils::AddToggleAllCheckboxTh($tr);
			$tr->add("th")->Content = R::gets(IGK_FD_NAME);
			$tr->add("th")->Content = R::gets("clLink");
			$tr->add("th")->Content = R::gets("clSize");
			$tr->add("th")->Content = IGK_HTML_WHITESPACE;

			$v_ttab = array_keys($this->m_fileres);
			sort($v_ttab);
			$v_count = 0;
			foreach($v_ttab as $k)
			{
				$v = $this->m_fileres[$k];
				if (empty($v) || !empty($this->m_searchentry) && !strstr(strtolower($k), strtolower($this->m_searchentry))
						&& !strstr(strtolower($v), strtolower($this->m_searchentry)))
					continue;
				$tr = $tab->add("tr" , array("class"=>"fitw"));
				$tr->addTd()->addInput(IGK_STR_EMPTY,"checkbox");
				$tr->addTd()->Content = $k;
				$tr->addTd()->add("a", array("href"=>igk_js_post_frame($this->getUri("viewpic_ajx&name=".$k))))->Content = igk_io_dir($v);
				$file = igk_io_currentRelativePath($v);
				if (file_exists($file))
				{
					$size = @filesize( $file);
					if ($size === false)
					{
						$tr->addtd()->Content =  "?";
					}
					else
						$tr->addtd()->Content =  IGKIO::GetFileSize( $size);
				}
				else
					$tr->addTd()->Content = "broken";
				$tr->add("td", array("class"=>"igk-table-img-action_16x16"))->add("a", array("href"=>
				$this->getUri("delfile&name=".$k)))->add("img", array("src"=>R::GetImgUri("drop_16x16")));

				$v_count++;
			}
			$info->Content = $v_count;
			$div = $frm->add("div", null, 1000);
			IGKHtmlUtils::AddBtnLnk($div, "btn.Return", $this->getUri("gotodefaultview"));
			IGKHtmlUtils::AddBtnLnk($div, "btn.loadfile", $this->getUri("show_loadfile_frame"));
			IGKHtmlUtils::AddBtnLnk($div, R::ngets("btn.RemoveBrokenfiles"), $this->getUri("remove_broken_file"));
		}

	}

	public function viewpic_ajx()
	{
		$frame = igk_add_new_frame($this, "viewpic_frame");
		$frame->Title = R::ngets("title.picture_1", igk_getr("name"));
		$c = $frame->BoxContent;

		$c->ClearChilds();
		$c->addDiv(array("class"=>"alignc"))->add("img", array("src"=>$this->getUri("viewpic&name=".igk_getr("name"))));
		$c->addDiv()->Content = "image definition";
		$frame->RenderAJX();
	}
	public function remove_broken_file()
	{
		$v_ttab = array_keys($this->m_fileres);
		sort($v_ttab);
		$r  = false;
		$i = 0;
		foreach($v_ttab as $k)
		{
			$v = $this->m_fileres[$k];
			$file = igk_io_currentRelativePath($v);
			if (!file_exists($file))
			{
				unset($this->m_fileres[$k]);
				$r = true;
				$i++;
			}
		}
			if ($r){
				$this->_storeData();
				igk_notifyctrl()->addMsgr("msg.brokenfilesremoved_1", $i);


			}
			else{
				igk_notifyctrl()->addInfor("msg.nobrokenfilesremoved");
			}
			$this->View();
	}
	public function gotodefaultview()
	{
			$this->m_cpage = null;
			$this->View();
		}
	public function deleteall()
	{
		if (igk_qr_confirm()){
		$dir = igk_io_baseRelativePath(self::TARGETDIR);
		if (is_dir($dir) && !IGKIO::RmDir(igk_io_baseRelativePath(self::TARGETDIR)))
		{
			$this->msbox->addError("Impossible de supprimer le repertoire.");
		}
		else{
			foreach($this->m_fileres as $k=>$v)
			{
				$f = igk_io_currentRelativePath($v);
				if (file_exists($f))
					unlink($f);
			}
			$this->m_fileres= array();
			$this->_storeData();
			$this->View();
		}
		}
		else{
			$frame = igk_frame_add_confirm($this, "delete_all_pics_frame");
			$frame->Form["action"] = $this->getUri("deleteall");
			$frame->Form->Div->Content = R::ngets(IGK_MSG_ALLPICS_QUESTION);

		}
	}


}

//-----------------------------------------------------------------------------------------
//MODULE-CONTROLLER AND ARTICLE MANAGER
//-----------------------------------------------------------------------------------------
final class IGKControllerAndArticlesCtrl extends IGKConfigCtrlBase
{
	private $m_SelectedController;
	private $m_selectedLang;
	private $m_search_article;
	private $m_search_view;
	private $m_filter_article_lang;
	private $m_SelectedControllerChangedEvent;

	public function getSelectedController(){return $this->m_SelectedController; }

	public function getName(){ return IGK_CA_CTRL;}

	public function IsFunctionExposed($funcname){//c_ac:
		$rgx = "/(view_body_ajx|update_article)/i";
		if (igk_is_conf_connected() || preg_match($rgx, $funcname))
			return true;
		return parent::IsFunctionExposed($funcname);
	}

	public function setSelectedController($value){
		if ($this->m_SelectedController != $value)
		{
			$this->m_SelectedController = $value;
			$this->onSelectedControllerChanged();
		}
	}
	protected function onSelectedControllerChanged()
	{
		$this->m_SelectedControllerChangedEvent->Call($this, array());
	}

	//--------------------------------------------
	//get the article content
	//--------------------------------------------
	public function getCtrlArticle(){
		$c = igk_getr("ctrl");//get the controller
		$n = igk_getr("n"); //article name
		igk_getctrl($c)->getArticle($n);
		igk_exit();
	}

	///<summary>set the default page controller</summary>
	public function setdefaultpage(){
		$n =  igk_getr("clDefaultCtrl");
		if ($this->App->Configs->web_pagectrl != $n){
			$this->App->Configs->web_pagectrl = $n;
			igk_save_config();
			$this->View();
			$this->App->Session->setParam("forceview",1);
			igk_notification_push_event("sys://event/defaultpagechanged", $this);
			//by default kill all session but not the current
			igk_kill_all_sessions(session_id());
		}
	}
	public function setdefaultpage_ajx(){//ajx uri call
		$this->setdefaultpage();
	}

	private function _getviewid(){$this->getName()."_views";}


	//---------------------------------------------------------------------------------------
	// ARTICLES FUNCTIONS
	//---------------------------------------------------------------------------------------
	public function ca_viewArticles($div, $ctrl=null)
	{
		$ctrl = ($ctrl==null)? igk_getctrl($this->SelectedController, false) : $ctrl;
		if ($ctrl == null)
			return null;

		$div->add(new IGKHtmlSearchItem($this->getUri("search_article"), null, "m_search_article"));
		$dir = $ctrl->getArticlesDir();
		$t = igk_io_getfiles($dir);
		$lang_search = null;
		$frm = $div->addForm();

		if (!(($this->m_selectedLang == null) || ($this->m_selectedLang == ALL_LANG)))
			$lang_search = $this->m_selectedLang;
		if ($t && count($t)>0){
			sort($t);
				$ul = $frm->addTable();
				$ul["class"] =  "fitw";
				$ul->setId($this->_getarticleid());
				$tr = $ul->addTr();
				$tr->add("th", array("style"=>"width:16px"))->Content = IGK_HTML_SPACE;
				$tr->add("th")->Content = R::ngets(IGK_FD_NAME);
				$tr->add("th",array("style"=>"width:16px"))->Content =IGK_HTML_SPACE;
				$tr->add("th",array("style"=>"width:16px"))->Content =IGK_HTML_SPACE;
				$tr->add("th",array("style"=>"width:16px"))->Content =IGK_HTML_SPACE;
				$n = null;
				foreach($t as $k)
				{
					$n =  basename($k);
					// if (!IGKString::EndWith(strtolower($n), igk_get_article_ext()))
					// {continue;}
					if ($lang_search && !IGKString::EndWith(strtolower($n), igk_get_article_ext($lang_search)))
						continue;
					if($this->m_search_article && !strstr(strtolower($n), strtolower($this->m_search_article)))
						continue;
					$tr = $ul->addTr();
					$tr->addTd()->Content =IGK_HTML_SPACE;
					$tr->addTd()->add("a", array("href"=>$this->getUri("download_article&n=".$n)))->Content = $n;
					//IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("edit_article&n=".basename($k)), "edit_16x16");
					IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("ca_edit_article_ajx&navigate=1&ctrlid=".$ctrl->Name."&m=1&fc=1&fn=".base64_encode($k))), "edit_16x16");
					//IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("edit_articlewtiny&n=".basename($k))), "tiny_16x16");
					IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("ca_edit_articlewtiny_f_ajx&navigate=1&ctrlid=".$ctrl->Name."&m=1&fc=1&fn=".base64_encode($k))), "tiny_16x16");
					IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("ca_drop_article_ajx&ctrlid=".$ctrl->Name."&n=".base64_encode(basename($k)))), "drop_16x16");
				}
			}
		$frm["action"]= $this->getUri("ca_add_article_frame");
		$frm->addBtn("btn_addarticle", R::ngets("btn.AddArticle"));
		if ($ctrl!=null)
		{
			$frm->addInput("ctrlid", "hidden", $ctrl->Name);
		}
	}

	private function _getarticleid(){
		return $this->getName()."_articles";
	}

	public function search_view()
	{
		$this->m_search_view = igk_getr("m_search_view");
		$this->View();
	}
	//write article with tiny
	private  function __write_article_for_tiny($file, $v_content, $property=null)
	{
		if (empty($file))
			return false;

		$v_dummy =  igk_createNode("dummy");
		$v_dummy->Load($v_content);

		if ($v_dummy->HasChilds){


			if ($property)
			{
				if ($property->RemoveImgSize)
				{
					$tab  = $v_dummy->getElementsByTagName("image");
					igk_wln("remove image style");
					foreach($tab as $k)
					{
						$k["width"] = null;
						$k["height"] = null;
					}
				}
				$tab  = $v_dummy->getElementsByTagName("*");
				if ($property->RemoveStyles)
				{
					foreach($tab as $k)
					{
						$k["style"] = null;
					}
				}
			}

			$s = null;// (object)array("Indent"=>true, "ParentDepth"=>null);

			if ($v_dummy->ChildCount === 1)
			{
				$s = igk_xml_create_render_option();
				$s->Indent = true;
				$s->ParentDepth = $v_dummy->Childs[0];
				if (get_class($s->ParentDepth)==="IGKHtmlText"){
					igk_io_save_file_as_utf8($file, $s->ParentDepth->Render(null), true);
				}
				else
					igk_io_save_file_as_utf8($file, $s->ParentDepth->getinnerHTML($s), true);

			}
			else{
				$s = igk_xml_create_render_option();
				$s->Indent = true;
				$s->ParentDepth = $v_dummy;
				igk_io_save_file_as_utf8($file,  $s->ParentDepth->getinnerHTML($s), true);
			}
			return true;
		}
		else{
			igk_io_save_file_as_utf8($file, $v_content, true);
			return true;
		}
		return false;
	}
	private function __updateview($ctrl)
	{
		if ($ctrl && $ctrl->getIsVisible())
		{
			if (($this->CurrentPageFolder == IGK_CONFIG_PAGEFOLDER) && igk_reflection_class_extends(get_class($ctrl), "IGKConfigCtrlBase" ))
				$ctrl->showConfig();
			else
				$ctrl->View();
		}
	}
	public function update_articlewtiny(){

		$f = urldecode(base64_decode(igk_getr("clfile")));
		$v_c = igk_str_remove_empty_line( igk_html_unscape(igk_getr("clContent")));
		$id = igk_getr("clctrl");
		$v_frame = igk_getr("clframe");
		$property = (object)array(
			"RemoveImgSize" =>igk_getr("clRemoveImgSize"),
			"RemoveStyles" =>igk_getr("clRemoveStyles")
		);

		$ctrl = igk_getctrl($id, false);
		if ($this->__write_article_for_tiny($f, $v_c, $property))
		{
			$this->__updateview($ctrl);
			igk_notifyctrl()->addMsg(R::ngets("msg.filesaved" , basename($f)));
		}
		else {
			igk_notifyctrl()->addError(R::ngets("e.filenotsaved" , basename($f)));
		}
	}

	public function update_article(){

		$ajx = igk_is_ajx_demand() || igk_getr("ajx");

		$f = urldecode(base64_decode(igk_getr("clfile")));
		$v_c = igk_str_remove_empty_line(igk_html_unscape(igk_getr("clContent")));
		$v_frame = igk_getr("clframe");
		$v_dummy =  igk_createNode("div");
		$id = igk_getr("clctrl");
		$ctrl = igk_getctrl($id, false);
		$n = igk_getr("n");
		if ($n && !file_exists($f) && $ctrl){
			$f = $ctrl->getArticle($n);
		}


		if (!empty($f))
		{

			try{
			//try to know if well html file
			$v_dummy->Load($v_c);

				if (igk_io_save_file_as_utf8($f, $v_c, true,false))
				{
					$this->__updateview($ctrl);
					igk_notifyctrl()->addMsg(R::ngets("msg.filesaved_1" , basename($f)));
				}
				else
					igk_notifyctrl()->addError(R::ngets("err.filenotsaved_1" , basename($f)));
				if ($ctrl)
				igk_ctrl_viewparent($ctrl,null);
				if (igk_frame_is_available($v_frame))
					igk_frame_close($v_frame, false);
			}
			catch(Exception $ex){
				igk_notifyctrl()->addError(R::ngets("err.filenotsaved_1" , basename($f)));
				igk_notifyctrl()->addError($ex);
				igk_show_exception($ex);
				igk_exit();
			}
		}
		$rf = igk_getv(parse_url(igk_sys_srv_referer()), "path");
		//e_xit;
		if (!$ajx){
			igk_navtocurrent();
		}

		if (!empty($rf)){
			igk_navto($rf);
		}
		igk_ajx_toast(R::ngets("msg.articleupdated"));
		igk_exit();

	}

	public function ca_edit_ctrl_force_view_ajx(){
		$n =igk_getctrl(igk_getr("n"));
		if ($n){
			igk_ajx_replace_ctrl_view($n);
		}
	}
	///<summary> edition d'article simple par une demande ajax</summary>
	public function ca_edit_article_ajx($ctrlid=null, $name=null)
	{
		$ajx = 0;
		$f= "";
		$n ="";
		$f = base64_decode(igk_getr("fn"));
		$ctrlid = $ctrlid ?? igk_getr("ctrlid");
		$ctrl = igk_getctrl($ctrlid);

		$f = file_exists($f) ? $f : $ctrl->getArticle($f);
		//$n = $name? $name: igk_getr("n");
		// $f = realpath(base64_decode($n));

		// fn

		// igk_ilog($f);
		if (file_exists($f)){
		$str = igk_io_read_allfile($f);
		$t = igk_createNode("div");
		
		$t->addDiv()->Content = igk_io_baseDir($f);
		$frm = $t->addForm();
		$frm["action"]=$this->getUri("update_article".( ($ajx==1)?null: "#".$this->_getarticleid()));
		// igk_ilog($str);
		$ul = $frm->add("ul");
		$ul["class"]="fitw";
		$txt = $ul->addLi()->addTextArea("clContent", $str);
		$txt["class"] = "fitw tyni";

		$frm->addInput("clfile", "hidden", base64_encode(urlencode($f)));



		$frm->addInput("navigate", "hidden", igk_getr("navigate",0));
		$frm->addInput("ajx", "hidden", 1);
		$frm->addInput("cluri", "hidden", igk_getv($_SERVER, 'HTTP_REFERER'));

		$frm->addDiv()->addInput("btn.edit", "submit", R::ngets("btn.edit"));
		// $frm->addScript()->setContent("tinymce.remove('textarea');")->RenderAJX();
		igk_js_enable_tinymce($ul, "textarea#clContent");

		igk_ajx_notify_dialog(R::ngets("title.edit_1", basename($f)), $t);

		}else{
			igk_ajx_notify_dialog("Edit", R::ngets("File not found : ".$f));
		}



		//fc : force creation
		// $frame = $this->ca_edit_article_frame($ctrlid, igk_getr("n", igk_getr("fn")), 1, igk_getr("m", 0), igk_getr("fc") );
		// if ($frame){;
			// $frame->Form->addInput("navigate", "hidden", igk_getr("navigate",0));
			// $frame->Form->addInput("ajx", "hidden", 1);
			// // $refUri = IGKIO::GetRequestBaseUri();
			// $frame->Form->addInput("cluri", "hidden", igk_getv($_SERVER, 'HTTP_REFERER'));

			// $frame->Form["igk-ajx-form"] = 1;
			// $frame->Form["igk-ajx-form-target"] ="??";
			// $frame->RenderAJX();
		// }
		// else {
			// igk_notifybox_ajx("Can't created frame");
		// }
	}
	///<summary> create d'un FrameDialog pour l'édition d'article </summary>
	///<params>
	///$ctrlid: controller ou id du controller
	///$name: nom ou chemin d'accèss au fichier
	///$ajx:  s'il s'agit d'un context ajax ou nom
	///$mode: si mode = 1 alors le name un le chemin d'accès complet au fichier sinon il s'agit du nom dans le repertoire Articles du controlleur
	///$force: force creation if not exists
	///</params>
	public function ca_edit_article_frame($ctrlid=null, $name=null, $ajx=0, $mode=0, $force=false)
	{
		$ctrl = igk_getctrl($ctrlid?$ctrlid:igk_getr("ctrlid"), false);
		$n = $name? $name: igk_getr("n");
		$f = realpath(base64_decode($n));

		if (!file_exists($f))
		{
			if (($ctrl == null) || !isset($n))
				return null;
			if ($mode==0)
				$f= igk_io_dir($ctrl->getArticlesDir()."/".$n);
		}
		if ($force || file_exists($f))
		{

			$frame = igk_add_new_frame($this, "frame_edit_article", $ajx==1?null: "#".$this->_getarticleid());
			$frame->ClearChilds();
			$frame->Title = R::ngets("title.editarticle_1", basename($f));
			$str = IGKIO::ReadAllText($f);

			$d = $frame->BoxContent;
			$frm = $d->addForm();
			$frm["action"]=$this->getUri("update_article".( ($ajx==1)?null: "#".$this->_getarticleid()));
			$ul = $frm->add("ul");

			$txt = $ul->addLi()->addTextArea("clContent", $str);
			$txt["class"] = "frame_textarea";

			$frm->addInput("clfile", "hidden", base64_encode(urlencode($f)));
			$frm->addInput("clframe", "hidden", $frame["id"]);
			$frm->addInput("clctrl", "hidden", $ctrl?$ctrl->Name:null);
			$frm->addBtn("btn_update", R::ngets("btn.Update"))
			->setClass("igk-btn igk-btn-default");
			$frame->Form = $frm;
			return $frame;
		}
		return null;
	}


	public function ca_edit_articlewtiny_frame($ctrlid=null, $name=null, $ajx=0, $mode=0)
	{
		$ctrl = igk_getctrl($ctrlid?$ctrlid:igk_getr("ctrlid"), false);
		$n = $name?$name:igk_getr("n");

		if (($ctrl == null) || !isset($n))
			return null;
		if ($mode==0)
			$f= igk_io_dir($ctrl->getArticlesDir()."/".$n);
		else
			$f = base64_decode($n);
		if (file_exists($f))
		{
			$frame = igk_add_new_frame($this, "frame_edit_article", $ajx==1?null: "#".$this->_getarticleid());
			$frame->ClearChilds();
			$frame->Title = R::ngets("title.editarticlewtiny_1", basename($f));
			$str = IGKIO::ReadAllText($f);
			$d = $frame->BoxContent;
			$frm = $d->addForm();
			$frm["action"]=$this->getUri("update_articlewtiny".( ($ajx==1)?null: "#".$this->_getarticleid()));
			$ul = $frm->add("ul");
			$ul->addLi()->addSLabelInput("clRemoveStyles", "checkbox");
			$ul->addLi()->addSLabelInput("clRemoveImgSize", "checkbox");
			//$ul->addLi()->addTextArea("clContent",utf8_decode($str));
			$ul->addLi()->addTextArea("clContent", $str);

			igk_js_enable_tinymce($ul, "clContent");
			$frm->addInput("clfile", "hidden", base64_encode(urlencode($f)));
			$frm->addInput("clframe", "hidden", $frame["id"]);
			$frm->addInput("clctrl", "hidden", $ctrl->Name);
			$frm->addBtn("btn_update", R::ngets("btn.Update"));
			return $frame;
		}
		return null;
	}
	public function ca_edit_articlewtiny_f_ajx($ctrlid=null, $name=null)
	{
		$n = $name?$name: igk_getr("n", igk_getr("fn"));
		$frame = $this->ca_edit_articlewtiny_f_frame($ctrlid,$n, 1, igk_getr("m", 0), igk_getr("fc") );
		if ($frame){
			igk_ajx_notify_dialog(R::ngets("title.editarticlewtiny_1", basename(base64_decode($n))), $frame->Render(null));
		}
		else{
			igk_ilog(__METHOD__." with tiny failed to create frame");
			igk_ilog(igk_ob_get($_REQUEST));
			igk_ilog(base64_decode(igk_getr("fn")));
		}
	}
	public function ca_update_articlewtiny_f()
	{
		//full
		if (!$this->App->ConfigMode)
		{
			igk_navtocurrent();
			return;
		}
		$this->update_articlewtiny();
		//reload frame
		$_REQUEST["ctrlid"] = igk_getr("clctrl");
		$_REQUEST["n"] = basename(urldecode(base64_decode(igk_getr("clfile"))));
		igk_frame_close("frame_edit_article");
		igk_navtocurrent();
	}
	public function ca_edit_articlewtiny_f_frame($ctrlid=null, $name=null, $ajx=0, $mode=0,$force = false)
	{
		$ctrl = igk_getctrl($ctrlid?$ctrlid:igk_getr("ctrlid"), false);
		$n = $name?$name:igk_getr("n");

		if ( (($mode==0) && ($ctrl === null)) || !isset($n)){
			igk_ilog("not set");
			return null;
		}
		if ($mode==0)
			$f= igk_io_dir($ctrl->getArticlesDir()."/".$n);
		else
			$f = base64_decode($n);
		if ($force || file_exists($f))
		{

			// $frame = igk_add_new_frame($this, "frame_edit_article");
			// $frame->ClearChilds();
			// $frame->Title = R::ngets("title.editarticlewtiny_1", basename($f));
			$str = IGKIO::ReadAllText($f);
			// $d = $frame->BoxContent;
			$frm = igk_createNode('form');
			$frm["action"]=$this->getUri("ca_update_articlewtiny_f");
			$ul = $frm->add("ul");
			$ul->addLi()->addSLabelInput("clRemoveStyles", "checkbox");
			$ul->addLi()->addSLabelInput("clRemoveImgSize",  "checkbox");
			//$ul->addLi()->addTextArea("clContent",utf8_decode($str));
			$ul->addLi()->addTextArea("clContent",$str);

			//NNN
			igk_js_enable_tinymce($ul, "clContent");

			$frm->addInput("clfile", "hidden", base64_encode(urlencode($f)));
			$frm->addInput("clframe", "hidden", 'frame_edit_article');
			if ($ctrl)
			$frm->addInput("clctrl", "hidden", $ctrl->Name);
			$frm->addBtn("btn_update", R::ngets("btn.Update"));
			return $frm;
		}
		return null;
	}
	public function edit_article()
	{
		$this->ca_edit_article_frame($this->SelectedController, igk_getr("n"));
	}
	public function edit_articlewtiny(){
		$this->ca_edit_articlewtiny_frame($this->SelectedController, igk_getr("n"));
	}

	///<summary>remove an article.	</summary>
	public function drop_article(){
		$n = igk_getr("n");
		$ctrl = $this->SelectedController;
		if (($ctrl == null) || !isset($n))
			return null;
		$f= igk_io_dir(igk_getctrl($ctrl)->getArticlesDir()."/".$n);
		$_FRAMENAME = "frame_drop_article_confirmation";
		if (file_exists($f))
		{
			if (igk_qr_confirm()){
				unlink($f);
			}
			else{
				$frame = igk_frame_add_confirm($this, $_FRAMENAME, $this->getUri("drop_article"));
				$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETEFILE_QUESTION, $n);
				$frame->Form->addInput("n", "hidden",$n);
			}
			$this->View();
		}
	}
	public function ca_drop_article_ajx(){
		$n = base64_decode(igk_getr("n"));
		$ctrl = ($c = igk_getr("ctrlid",null))? igk_getctrl($c) :  $this->SelectedController;
		$f = realpath($n);
		$_FRAMENAME = "frame_".__FUNCTION__;
		if (!file_exists($f))
		{
			if (($ctrl == null) || !isset($n))
			{
				igk_notifyctrl()->addErrorr("err.nocontroller.selected");
				igk_notifyctrl()->TargetNode->RenderAJX();
				igk_notifybox_ajx("controller not selected");
				return null;
			}
			$f= igk_io_dir(igk_getctrl($ctrl)->getArticlesDir()."/".$n);

		}
		if (file_exists($f)){
			if (igk_qr_confirm())
			{
				unlink($f);
				if ($ctrl)
					igk_getctrl($ctrl)->View();
				if (igk_getr("navigate")==1)
				{//navigate and render document
					//$this->App->Doc->body->RenderAJX();
					//$s  = igk_post_uri();
					//igk_wln("navigate ...".igk_is_ajx_demand());
					if (igk_is_ajx_demand()){
						igk_ajx_replace_ctrl_view($ctrl, 0);
					}
					// igk_wln($_SERVER);
				}
				else {
					igk_wl(igk_getctrl($ctrl)->TargetNode->innerHTML);
				}
			}
			else{
				$frame = igk_frame_add_confirm($this, $_FRAMENAME, $this->getUri("ca_drop_article_ajx"));
				$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETEFILE_QUESTION, basename($n));
				$frame->Form["igk-confirmframe-response-target"] = strtolower($ctrl);
				$frame->Form->addInput("n", "hidden",base64_encode($n));
				$frame->Form->addInput("navigate", "hidden",igk_getr("navigate"));
				$frame->Form->addInput("ctrlid", "hidden",$ctrl? $ctrl->Name:null);
				$frame->RenderAJX();
			}
		}
		else{
			igk_notifyctrl()->addInfor("msg.ca_drop_article_ajx_no_article_to_remove");
			igk_notifyctrl()->TargetNode->RenderAJX();
		}
	}
	///<summary>get an article and download it </summary>
	public function download_article(){
		$n = igk_getr("n");
		$ctrl = $this->SelectedController;
		if (($ctrl == null) || !isset($n))
			return null;
		$f= igk_io_dir(igk_getctrl($ctrl)->getArticlesDir()."/".$n);
		if (file_exists($f))
		{
			igk_download_file(basename($f), $f);
			igk_navtocurrent();
			igk_exit();

		}
	}

	///<summary>filter article by language</summary>
	public function filter_article_by_lang(){
		$this->m_filter_article_lang = igk_getr("n");
		$this->View();
	}

	///<summary>search article . reload the view</summary>
	public function search_article(){
		$this->m_search_article = igk_getr("m_search_article");
		$this->View();
	}

	private function _buildViewArticle($div, $ctrl=null)
	{
		$v_divarticle = $div->addDiv();
		$v_divarticle["id"] = "view_articles";
		igk_html_add_title($v_divarticle, "title.Articles");
		$frm = $v_divarticle->addForm();
		$frm["action"]= $this->getUri("ca_add_article_frame");
		$frm->addLabel()->Content = R::ngets("lb.Language");
		$tab =array_merge(array(ALL_LANG), igk_getctrl(IGK_CSVLANGUAGE_CTRL)->Languages);
		$select = igk_html_build_select($frm, "clLang", $tab, array("allowEmpty"=>false, "keysupport"=>false),$this->m_selectedLang);
		//ctrl uri for selection chanaged
		$ctrln = ($ctrl == null) ? IGK_STR_EMPTY : "&ctrl=".$ctrl->Name;

		$select["onchange"]="javascript:  (function(p){var q = p.form.parentNode; window.igk.ajx.post('".$this->getUri("ca_ctrl_article_select_lang_ajx{$ctrln}&n=").
		"'+p.value, null, function(xhr){ if (this.isReady()){ this.setResponseTo(q); }});})(this);";
		$select->setClass("igk-form-control");
		$this->ca_viewArticles($v_divarticle->addDiv(array("id"=>"igk-div-articles")), $ctrl);

	}


	//-----------------------------------------------
	// VIEWS FUNCTIONS
	//-----------------------------------------------

	public function ca_viewViewFiles($div, $ctrl=null){
		$ctrl = ($ctrl!=null)? $ctrl : igk_getctrl($this->SelectedController, false);
		if ($ctrl == null)
			return null;
		$div->add(new IGKHtmlSearchItem($this->getUri("search_view#frm_ctrl_view"), null, "m_search_view"));
		$frm = $div->addForm();
		$frm["id"]=$frm["name"] = "frm_ctrl_view";
		$frm["action"]= $this->getUri("ca_add_view_frame");
		$t = array();
		if (method_exists($ctrl, "ListViewFile")){
			$t = $ctrl->ListViewFile();
		}else{
			$dir = $ctrl->getViewDir();
			$t = igk_io_getfiles($dir, "/\.phtml$/", false);
		}
		if ($t && count($t)>0){
			sort($t);
		$table = $frm->addTable();
		$table["class"] = "fitw";
		$table->setId($this->_getviewid());
		$tr = $table->addTr();
		$tr->add("th", array("style"=>"width:16px"))->Content = IGK_HTML_SPACE;
		$tr->add("th")->Content = R::ngets(IGK_FD_NAME);
		$tr->add("th",array("style"=>"width:16px"))->Content =IGK_HTML_SPACE;
		$tr->add("th",array("style"=>"width:16px"))->Content =IGK_HTML_SPACE;
		foreach($t as $k)
		{
			if ($this->m_search_view && !strstr(strtolower($k), $this->m_search_view))
				continue;
			$tr = $table->addTr();

			$tr->addTd()->Content = IGK_HTML_SPACE;
			$tr->addTd()->add("a", array("href"=>$this->getUri("ca_download_view&n=".basename($k))))->Content = basename($k);

			IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("ca_edit_view&n=".basename($k))), "edit_16x16");
			if (igk_is_ajx_demand())
			{
				IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("ca_drop_view&n=".basename($k))), "drop_16x16");
			}
			else {
				IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("ca_drop_view&n=".basename($k)), "drop_16x16");
			}
		}
		}

		$frm->addBtn("btn_addView", R::ngets("btn.AddView"));
		//$frm->addInput("ajx", "hidden", 1);
	}


	public function ca_update_view(){
		$f = urldecode(base64_decode(igk_getr("clfile")));
		$v_c = igk_str_remove_empty_line(igk_getr("clContent"));
		$v_frame = igk_getr("clframe");
		$ctrl = igk_getctrl($this->SelectedController, false);
		$v_old = IGKIO::ReadAllText($f);


		//save the content from text area
		igk_io_saveContentFromTextArea($f, $v_c, true);
		$error = array();
		$code = 0;
		@exec("php -l \"".$f."\"", $error, $code);

		igk_show_prev($error);

		igk_notifyctrl()->addMsg(R::ngets("MSG.ViewFileSaved" , basename($f)));
		$ctrl->View();
		igk_frame_close($v_frame);

	}
	public function ca_edit_view($oldcontent=null, $errormesage=null, $error=null){
		//edit frame
		$ctrl = igk_getctrl($this->SelectedController, false);
		$n = igk_getr("n");
		if (($ctrl == null) || !isset($n))
			return null;
		$f= igk_io_dir($ctrl->getViewDir()."/".$n);
		if (file_exists($f))
		{
			//view edit frame
			$frame = igk_add_new_frame($this, "frame_edit_view", "#".$this->_getviewid());
			$frame->ClearChilds();
			$frame->Title = R::ngets("title.editview_1", basename($f));
			$str=null;
			if (!$oldcontent)
				$str =utf8_decode( IGKIO::ReadAllText($f));
			$d = $frame->BoxContent;
			$frm = $d->addForm();
			$frm["action"]=$this->getUri("ca_update_view#".$this->_getviewid());
			if ($error)
			{
				$frm->add("div", array("class"=>"notification_bad"))->Content = "Somme Error Append When try to save the file: <br/ >"
				. $errormesage.
				"<br/>".$oldcontent;
			}
			$k = ($oldcontent==null)? $str: $oldcontent;
			// igk_wl($k);
			// igk_exit();
			$ul = $frm->add("ul");
			$area = $ul->addLi()->addTextArea("clContent", $k);
			$area["style"] = "width: 400px; min-height: 300px;";
			$frm->addInput("clfile", "hidden", base64_encode(urlencode($f)));
			$frm->addInput("clframe", "hidden", $frame["id"]);
			$frm->addInput("n", "hidden", $n);
			$frm->addHSep();
			$frm->addBtn("btn_update", R::ngets("btn.Update"));
			$frm->Width = "400px";
			$frm->Height = "300px";

			if (igk_is_ajx_demand())
				$frame->RenderAJX();
			else{
				igk_navtocurrent();

			}
			return $frame;
		}
	}
	public function ca_drop_view(){
		$n = igk_getr("n");
		$ctrl = $this->SelectedController;
		if (($ctrl == null) || !isset($n))
			return null;
		$f= igk_io_dir(igk_getctrl($ctrl)->getViewDir()."/".$n);
		$_FRAMENAME = "frame_ca_drop_view_confirmation";
		if (file_exists($f))
		{
			if (igk_qr_confirm()){
				unlink($f);
			}
			else{
				$frame = igk_frame_add_confirm($this, $_FRAMENAME,$this->getUri("ca_drop_view"));
				$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETEFILE_QUESTION,$n);
				$frame->Form->Div->addInput("n", "hidden",$n);
			}
			$this->View();
		}
	}
	//download view file
	public function ca_download_view(){
		$n = igk_getr("n");
		$ctrl = $this->SelectedController;
		if (($ctrl == null) || !isset($n))
			return null;
		$f= igk_io_dir(igk_getctrl($ctrl)->getViewDir()."/".$n);
		if (file_exists($f))
		{
			igk_download_file(basename($f), $f);
			igk_exit();
		}
	}




	//-----------------------------------------------
	// CONTROLLLERS  FUNCTIONS
	//-----------------------------------------------


	public function update_ctrl($oldcontent=null){


		$f = urldecode(base64_decode(igk_getr("clfile")));
		$v_c =utf8_encode( igk_html_unscape(igk_getr("clContent"),IGK_STR_EMPTY));
		$v_frame = igk_getr("clframe");
		$ctrl = igk_getctrl($this->SelectedController, false);

		if (igk_php_check_and_savescript($f, $v_c, $error, $code) == false)
		{
			$this->ca_edit_view($v_c, count($error)."update_ctrl::failed: code : ".$code." ".  implode("<br />",$error), true);
		}
		else{
			session_destroy();
			igk_getconfigwebpagectrl()->reconnect();
			igk_notifyctrl()->addMsg(R::ngets("MSG.ViewFileSaved" , basename($f)));
			igk_exit();
		}
	}
	public function ca_edit_ctrl_ajx($oldcontent =null){
	//controller frame
		$name = igk_getr("n",null);
		$ctrl = $name == null ? igk_getctrl($this->SelectedController, false) : igk_getctrl($name, false);
		if ($ctrl == null)
			return null;
		$f= igk_io_dir($ctrl->getDeclaredFileName());
		if (file_exists($f))
		{
			$frame = igk_add_new_frame($this, "frame_edit_ctrl",".");
			$frame->ClearChilds();
			$frame->Title = R::ngets("title.editctrl", basename($f));
			$str=null;
			if (!$oldcontent)
				$str = IGKIO::ReadAllText($f);
			$d = $frame->BoxContent;
			$frm = $d->addForm();
			$frm["action"]=$this->getUri("update_ctrl" .($name == null ?IGK_STR_EMPTY:"&n=".$name));
			if ($oldcontent){
				$frm->add("div", array("class"=>"notification_bad"))->Content = "Error /!\\ : <br/ >" . $errormesage;
			}
			$ul = $frm->add("ul");
			$v_txtarea = $ul->addLi()
			->addDiv()->setClass("fitw overflow-x-a")
			->addTextArea("clContent", ($oldcontent==null)? $str: $oldcontent)->setClass("igk-php-code")
			->setAttribute("spellcheck","false");

			//$v_txtarea["class"] = "igk-phpcodearea";
			//$frm->addScript()->Content = "window.igk.editor.phpcodearea.init('clContent',{});";
			$frm->addInput("clfile", "hidden", base64_encode(urlencode($f)));
			$frm->addInput("clframe", "hidden", $frame["id"]);
			$frm->addHSep();
			$frm->addBtn("btn_update", R::ngets("btn.Update"));
			$frame->RenderAJX();
		}
	}

	public function ca_edit_ctrl_properties_ajx($render=true)
	{
			//edit controller frame
			$name = igk_getr("n",null);
			$ctrl = $name == null ? igk_getctrl($this->SelectedController, false) : igk_getctrl($name, false);
			if ($ctrl == null)
				return null;
			$f= igk_io_dir($ctrl->getDeclaredFileName());
			// $frame = igk_add_new_frame($this, "frame_edit_ctrl_properties",".");
			// $frame->Width="580";
			// $frame->Height="320";
			// $frame->ClearChilds();
			$title = R::ngets("title.editctrl.properties_1", $ctrl->Name);

			$frm = igk_createNode('form');
			$frm["action"]=$this->getUri("ca_update_ctrl_properties". ($name == null ?IGK_STR_EMPTY:"&n=".$name));
			$frm["class"]="fitw";
			//$frm->addInput("frame_name", "hidden", $frame->Id);

			$ul = $frm->
			addDiv()
			->setClass("igk-v-h")
			->setStyle("max-height:200px; overflow-y:auto;")
			->add("ul");

			$d = igk_sys_getdefaultCtrlConf();

			$v_itab = null;
			$v_classname = get_class($ctrl);
			if (method_exists($v_classname,"GetNonConfigurableConfigInfo"))
			{
				$v_itab = igk_array_tokeys(call_user_func_array(array($v_classname,"GetNonConfigurableConfigInfo"),array()));


			}

			foreach($d as $k=>$v)
			{
				if (isset($v_itab[$k]))
					continue;

				$vv = igk_getv($ctrl->Configs, $k);

				switch(strtolower($k))
				{
					case "clparentctrl":
						$t = igk_getctrl(IGK_MENU_CTRL)->__getEditController($ul, $vv, "lb.parentcontroller", $this->SelectedController);
						$t["id"] = $t["name"]= $k;
					break;
					case "cldataadaptername":
						$li = $ul->addLi();
						$this->_ca_add_adapter($li, $k, $vv);
						break;
					case "cldataschema":
						$li = $ul->addLi();
						$li->add("label", array("for"=>$k))->Content = R::ngets("lb.".$k);
						$sl = $li->addSelect($k);
						$sl->addOption("false")->Content = R::ngets("enum.false");
						$sl->addOption("true")->Content = R::ngets("enum.true");
						$sl->select(igk_parsebool($vv));
						break;
					default:
						$li = $ul->addLi();
						$li->add("label", array("for"=>$k))->Content = R::ngets("lb.".$k);
						$li->addInput($k,"text", $vv);
					break;
				}
			}

			$this->_buildAdditionalInfo($ctrl, $ul);
			$frm->addHSep();
			$frm->addBtn("btn_update", R::ngets("btn.Update"))->setClass("igk-btn");
		if ($render)
			igk_ajx_notify_dialog($title, $frm->Render(null));
		return $frm;
	}
	public function ca_edit_ctrl_views_ajx($render=true){//edit controller views file
		$fid = "ca_edit_ctrl_views_ajx_frame";
		// $frame = igk_add_new_frame($this, $fid);
		$p = $frame->ForCtrl;
		$ctrl = igk_getctrl(igk_getr("n", $p? $p->Name: null), false);

		$title = R::ngets("title.editcontrollerviews_1", $ctrl->Name);
		// $c = $frame->BoxContent;
		// $c->ClearChilds();

		//builds controller view
		$c = igk_createNode("div");
		$this->_buildViewView($c->addDiv(), $ctrl);

		if ($render)
			igk_ajx_notify_dialog($title, $c->Render(null));//$frame->RenderAJX();
		return $frame;
	}


	public function unreg_view_frame()
	{
		$frame_name = "ca_edit_ctrl_atricles_ajx_frame";
		$frame = igk_get_frame($frame_name);
		if ($frame!=null)
		{
			$frame->ForCtrl->removeViewCompleteEvent($this, "view_frame_complete" );
			igk_frame_close($frame_name);
		}
	}
	public function ca_edit_ctrl_atricles_ajx($rendering=true){//edit ctrl articles
		$frame_name = "ca_edit_ctrl_atricles_ajx_frame";
		$frame = igk_add_new_frame($this, $frame_name);
		$p  = $frame->ForCtrl;
		$n = igk_getr("n", $p? $p->Name : null);
		$ctrl = igk_getctrl($n);
		if ($ctrl == null)
		{
			$frame->ForCtrl =null;
			$frame->IsRegister =null;
			igk_frame_close($frame_name);
			return;
		}
		$frame->Title = R::ngets("title.editctrlaticles_1", $ctrl->Name);
		$frame->CloseUri = $this->getUri("unreg_view_frame");
		$c = $frame->BoxContent;
		$c->ClearChilds();
		$d = $c->addDiv();
		//add div  article management
		$this->_buildViewArticle($d, $ctrl);
		//bin frame to controller view
		$t = $frame->IsRegister;
		if (!$t)
		{
			$t = true;
			$frame->IsRegister = $t;
			$ctrl->addViewCompleteEvent($this, "view_frame_complete" );
		}
		if ($rendering)
			$frame->RenderAJX();
		$frame->ForCtrl = $ctrl;
	}
	public function view_frame_complete()
	{
		//reload script
		$tb = $_REQUEST;
		igk_resetr();
		$this->ca_edit_ctrl_atricles_ajx(false);
		$_REQUEST = $tb;

	}
	public function lst_adapter_ajx(){
		$n = igk_createNode("div");
		$t = igk_getr("t");
		//$n->Content = "You Click ".$t;
		$cs = get_class( igk_get_data_adapter($t));
		if (method_exists($cs, "GetSchemaOptions")){

			call_user_func_array(array($cs, "GetSchemaOptions"), array($n));
		}
		$n->RenderAJX();
		igk_exit();
	}
	///<summary>build adapter selection list</summary>
	private function _ca_add_adapter($node, $k, $default=null, $nonevalue=false)
	{
		$t = IGKDataAdapter::GetAdapters();
		$node->add("label", array("for"=>$k))->Content = R::ngets("lb.".$k);
		$sl = $node->add("select");
		$uri = $this->getUri("lst_adapter_ajx");
		$sl["onchange"] = "javascript: ns_igk.ajx.get('{$uri}&t='+this.value,null, ns_igk.ajx.fn.replace_content( \$igk(this.parentNode).select('.igk-db-ad').getItemAt(0).o)); return false;";
		$sl["id"] = $sl["name"] = $k;
		
	
		foreach($t as $m=>$c)
		{
			$opt = $sl->add("option");
			$opt["value"] = $m;
			if ($m == $default)
				$opt["selected"]="true";

			$opt->Content = $m;
		}
		$node->addDiv()->setClass("igk-db-ad")->Content = "";
	}
	public function ca_update_ctrl_properties()
	{
		$name = igk_getr("n",null);
		$ctrl = $name == null ? igk_getctrl($this->SelectedController, false) : igk_getctrl($name, false);
		if ($ctrl == null){

			return null;
		}
		$c = igk_get_robj();

		$oldparent = $ctrl->Configs->clParentCtrl;
		foreach($c as $k=>$v)
		{
			$s = igk_getr($k);
			switch($k)
			{
				case "clParentCtrl":				{
					if ($s == "none")
					{
						$ctrl->Configs->$k =null;
					}
					else {

						if (igk_can_set_ctrlparent($ctrl, $s))
						{

							$ctrl->Configs->$k = $s;
						}
						else{
							igk_debug_wln("can't changed parent");
						}
					}
				}
				break;
				default :
					$ctrl->Configs->$k = $s;
				break;
			}
		}

		if (method_exists($ctrl, "SetCustomConfigInfo")){

			$t = $ctrl->Configs;
			$ctrl->SetCustomConfigInfo($t);
		}


		$ctrl->storeConfigSettings();
		igk_notifyctrl()->addMsg(R::ngets("msg.ctrlsettingupdated_1" , $ctrl->Name));

		if ($ctrl->Configs->clParentCtrl != $oldparent)
		{
			igk_sys_viewctrl($oldparent);
		}
		igk_ctrl_viewparent($ctrl);
		if (igk_is_confpagefolder())
		{
			igk_frame_close(igk_getr("frame_name"));
		}
		else
			$this->ca_edit_ctrl_properties_ajx(false);
		$this->View();

	}



	//select controller ajx
	public function select_controller_ajx(){
		$this->SelectedController = igk_getr("n");
		// $this->View();
		// igk_wl( $this->TargetNode->innerHTML);
		$n = igk_createNode("div");
		$this->_viewCtrlEditResult($n);
		$n->RenderAJX();
	}

	public function ca_ctrl_article_select_lang_ajx(){
		//change the selected language
		$ctrl = igk_getctrl(igk_getr("ctrl"), false);
		$this->m_selectedLang  = igk_getr("n");
		$div =  igk_createNode("div");
		$this->_buildViewArticle($div,$ctrl);
		igk_wl($div->innerHTML);
	}

	private function setup_defaultpage($ctrltab =null)
	{
		//$ctrltab = igk_getv($ctrltab == null ? igk_get_all_uri_page_ctrl() : $ctrltab, "@base");
		// $ctrltab = $ctrltab == null ? igk_get_all_default_pagectrl() : $ctrltab;
		$ctrl = igk_get_defaultwebpagectrl(); // igk_getctrl($this->App->Configs->web_pagectrl, false);	
	
		
		if (($ctrl ==null) && (count($ctrltab = igk_getv($ctrltab == null ? igk_get_all_uri_page_ctrl() : $ctrltab, "@base"))>0) )
		{
			//set the default page
			$n = $ctrltab[0]->getName();
			if ($this->App->Configs->web_pagectrl != $n)
			{
				$this->App->Configs->web_pagectrl = $ctrltab[0]->getName();
				igk_save_config();
			}
		}
	}

	function __viewDefaultPageCtrl($t)
	{
			$frm = $t->AddForm();
			$frm["action"] = $this->getUri("setdefaultpage");

			igk_html_add_title($frm, "title.defaultpagectrl");

			$ul = $frm->add('ul');
			$li = $ul->addLi();
			//$li->add("label", array("for"=>"clDefaultCtrl"))->Content = R::ngets("lb.defaultpagectrl");

			$sl = $li->add("select")->setClass("igk-form-control");
			$sl["id"]=$sl["name"] = "clDefaultCtrl";
			$sl["onchange"]="javascript:window.igk.ajx.post('".$this->getUri('setdefaultpage_ajx&')."'+this.id+'='+this.value, null, null);";
			//get all default page controller.
			$ctrltab = igk_get_all_uri_page_ctrl();///
			//$ctrltab = igk_get_all_default_pagectrl();
			// igk_wln(array_keys($ctrltab));
			//e_xit;
			if (count($ctrltab) == 0)
			{
				$this->App->Configs->web_pagectrl = null;
				$ul->addLi()->addspan()->Content = R::ngets("Warning.NoDefaultController");
			}
			else
			{
				$this->setup_defaultpage($ctrltab);
				$v_kn = strtolower($this->App->Configs->web_pagectrl);
				foreach($ctrltab["@base"] as $k)
				{
					$opt = $sl->add("option");
					$n = strtolower($k->Name);
					$opt["value"] = $k->Name;
					if ($n == $v_kn)
					{
						$opt["selected"] ="true";
					}
					$opt->Content = $k->getDisplayName();
				}
				$tt = $sl->addDiv();
				$tt["class"]="t";
				foreach($ctrltab["@templates"] as $k)
				{

					$opt = $sl->add("option");
					$n = strtolower($k);
					$opt["value"] = $k;
					if ($n == $v_kn)
					{
						$opt["selected"] ="true";
					}
					$opt->Content = $k;
				}
			}
			$frm->addDiv()->add("noscript")->addInput("btn_add", "submit");
	}
	function __viewMenuHostCtrl($t)
	{
			$frm = $t->AddForm();
			$frm["action"] = $this->getUri("ca_setmenuhost");

			$tab = igk_sys_getuserctrls();
			if (igk_count($tab) == 0)
			{
				$frm->add("div")->Content = R::ngets("msg.nocontroller.for.menu");
			}
			else{
			igk_html_add_title($frm, "lb.MenuHostCtrl");
			// $frm->add("label", array("for"=>"clCtrlMenuHost"))->setClass("igk-title")->Content = R::ngets("lb.MenuHostCtrl");
			$sl = $frm->addUl()->addLi()->add("select")->setClass("igk-form-control");
			$sl->setId("clCtrlMenuHost");
			$sl["onchange"]="javascript:window.igk.ajx.post('".$this->getUri('ca_setmenuhost_ajx&')."'+this.id+'='+this.value, null, null);";

			$sl->add("option",array("value"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;

			$v_menuhost = $this->App->Configs->menuHostCtrl;
			foreach($tab as $v)
			{
				//select the first controller
				$opt = $sl->add("option", array("value"=>$v->getName()));
				if ($v->getName() == $v_menuhost)
				{
					$opt["selected"]="true";
				}
				$opt->Content = $v->getDisplayName();

			}
			$frm->addDiv()->add("noscript")->addInput("btn_add", "submit");
			}
	}
	//ca for controller and article
	public function ca_setmenuhost()
	{
		$v_n = igk_getr("clCtrlMenuHost");
		$this->App->Configs->menuHostCtrl = $v_n;
		igk_save_config();
		$this->View();
			//refresh the controller

		$ctrl = igk_getctrl($v_n);
		igk_getctrl(IGK_MENU_CTRL)->setMenuhostCtrl($ctrl);
		igk_sys_viewctrl($v_n);

	}
	public function ca_setmenuhost_ajx()
	{
		$this->ca_setmenuhost();
	}

	private function _view_ctrl_EditCtrl($col)
	{
			$frm = $col->addColViewBox()->addForm();
			$frm["action"] = $this->getUri("ca_drop_controller");
			igk_html_add_title($frm, "title.controllers");
			// $frm->addLabel()->Content = R::ngets("lb.Controllers");
			$select = $frm->addUl()->addLi()->add("select");
			 $select["onchange"]="javascript: (function(i){
var p = \$igk('.cnf-edit-view-result').getItemAt(0);
var q = window.igk.getParentById(i, '{$this->TargetNode["id"]}');
window.igk.ajx.post('{$this->getUri('select_controller_ajx&n=')}'+i.value, null, function(xhr){  if (this.isReady()){
this.setResponseTo(p.o);
var r = \$igk(\$igk(i).o.form).select('.c-opts').getItemAt(0);
r.setHtml(p.select('.c-opts').getItemAt(0).getHtml()).init();
}})})(this);
";
			$select["class"]="igk-btn";
			$select["name"]=$select["id"]= "controler";

			$tab =  igk_sys_getuserctrls();
			if (count($tab) > 0)
			{

			foreach($tab as $v)
			{
				//select the first controller
				if ($this->SelectedController === null)
					$this->SelectedController = $v->getName();
				$opt = $select->add("option", array("value"=>$v->getName()));
				if ($v->getName() == $this->SelectedController)
					$opt["selected"] = "true";
				$opt->Content = $v->getDisplayName();

			}
				$ctrl = igk_getctrl($this->SelectedController);
				$dv = $frm->addDiv();
				//IGKHtmlUtils::AddImgLnk($dv, igk_js_post_frame($this->getUri("ca_add_ctrl_frame_ajx")), "add_16x16");
				$this->_view_ctrl_options($ctrl, $dv);
			}

	}
	private function _view_ctrl_options($ctrl, $dv)
	{

		$dv["class"] = "+c-opts";
		IGKHtmlUtils::AddImgLnk($dv, igk_js_post_frame($this->getUri("ca_add_ctrl_frame_ajx")), "add_16x16");
		IGKHtmlUtils::AddImgLnk($dv, igk_js_post_frame($this->getUri("ca_edit_ctrl_ajx")), "edit_16x16");
		IGKHtmlUtils::AddImgLnk($dv, igk_js_post_frame($this->getUri("ca_edit_ctrl_properties_ajx")), "setting_16x16");

		if ($ctrl->CanEditDataTableInfo){
			IGKHtmlUtils::AddImgLnk($dv, igk_js_post_frame($this->getUri("ca_edit_db_ajx")), "ico_db_16x16");
		}
		// $c = igk_getctrl("api");
		// $c->datadb("resetctrldb", "");
		// igk_wln("".$c);
		//e_xit;

		if (igk_count(igk_db_get_ctrl_tables($ctrl))>0){
			IGKHtmlUtils::AddImgLnk($dv, igk_js_post_frame($this->getUri("ca_reset_db_ajx")), "db_reset_16x16");
		}

		IGKHtmlUtils::AddImgLnk($dv, igk_js_post_frame($this->getUri("ca_ctrl_drop")), "drop_16x16");
	}
	///<summary>use to reset data base for the current controller</summary>
	public function ca_reset_db_ajx(){
		if (igk_qr_confirm()){
			$ctrl = igk_getctrl($this->SelectedController, false);
			$c = igk_getctrl("api");
			IGKOb::Start();
			if ($c->datadb("resetctrldb", $ctrl)){
				igk_notifyctrl()->addMsgr("msg.database_reset");
			}else{
				igk_notifyctrl()->addErrorr("err.database_reset");
			}
			IGKOb::Clear();
			igk_navtocurrent();
		}

		$frame = igk_frame_add_confirm($this, __METHOD__, $this->getUri(__FUNCTION__));
		$frame->Title="Confirm ?";
		$dc = $frame->Form->Div;
		$dc->addDiv()->Content ="/!\\ all tables and data willbe reset. Continue?";
		$frame->RenderAJX();
	}
	public function ca_selectedCtrlChanged()
	{
		$t = $this->getParam("ctrl:ca_tabInfo");
		if ($t !=null)
			$t->ClearChilds();
		//reset table info
		$this->setParam("ctrl:ca_tabInfo",null);
	}
	public function ca_update_dbdata()
	{
		$obj = igk_get_robj();

		$e =  igk_createNode(IGK_DATA_DEF_TAGNAME);
		$e["TableName"] = igk_getr("clTableName");
		unset($obj->clTableName);
		$v_kexist = array();
		for ($i = 0; $i < igk_count($obj->clName); $i++)
		{
			if (empty($obj->clName[$i]) || isset($v_kexist[$obj->clName[$i]]))
				continue;

			$v_kexist[$obj->clName[$i]] = 1;
			$cl = $e->add(IGK_COLUMN_TAGNAME);
			foreach($obj as $k=>$v)
			{
				$cl[$k] = $v[$i];
			}
		}
		$f = igk_getctrl($this->SelectedController)->getDBConfigFile();
		igk_io_save_file_as_utf8($f, $e->Render((object)array("Indent"=>true)));
		igk_frame_close("add_edit_db_frame");

		//reset table info
		$this->setParam("ctrl:ca_tabInfo",null);
		$this->View();
	}
	public function ca_edit_db_close_frame(){
		$table = igk_getr("db_tbr");
		$key = "ctrl:ca_tabInfo".($table?"/".$table:"");
		$this->setParam($key,null);
	}
	///<summary>request edit data table structures with ajx </summary>
	public function ca_edit_db_ajx($ctrl=null,$table=null)
	{
		//edit db frame
		$ctrl = $ctrl==null? igk_getctrl($this->SelectedController) : $ctrl;
		if ($ctrl==null)
			return;
		$t = $this->ca_getTableInfo($ctrl, $table);
		if ($t==null)
			return;
		$table = $table==null?$ctrl->DataTableName:$table;
		$frame = igk_add_new_frame($this, "add_edit_db_frame", $table? $this->getUri("ca_edit_db_close_frame&db_tbr=".$table) : null);
		$frame->Title = R::ngets("title.editdbArticle", $ctrl  );
		$d = $frame->BoxContent;
		$d->ClearChilds();

		$frm = $d->addForm();
		$frm["action"] = $this->getUri("ca_update_dbdata");
		$div = $frm->addDiv();
		$div["style"]="max-width:824px; max-height:400px; min-height: 200px;  overflow:auto;";

		$ul = $div->add("ul");
		$ul->Index = -10;
		$ul->addLi()->addSLabelInput("clTableName", "text", $table);


		$div->addHSep();
		$div->addDiv()
		->setClass("fitw overflow-x-a")
		->add($t);

		$frm->addHSep();
		$div = $frm->addDiv();
		$a = IGKHtmlUtils::AddImgLnk($div,"#", "add_16x16");
		$a["onclick"] =  igk_js_ajx_post_auri($this->getUri("ca_addfield_ajx"),"window.igk.ctrl.ca_update");
		$a = IGKHtmlUtils::AddImgLnk($div,"#", "drop_16x16");
		$a["onclick"] =  igk_js_ajx_post_auri($this->getUri("ca_ClearTableList_ajx"),"window.igk.ctrl.ca_updatetable");


		$frm->addInput("btn.update", "submit",  R::ngets("btn.update"));
		$f = $ctrl->getDBConfigFile();
		if (file_exists($f)){
			$frm->addInput("btn.update", "button",  R::ngets("btn.dropdb"))
			->setAttribute("onclick", igk_js_ajx_post_auri("ca_db_drop_db_file_ajx"));
		}
		igk_wl($frame->Render());

	}
	public function ca_db_drop_db_file_ajx(){
		$f = igk_getctrl($this->SelectedController)->getDBConfigFile();
		if (file_exists($f)){
			unlink($f);
			$this->View();
			igk_frame_close("add_edit_db_frame");
		}
		igk_exit();
	}
	public function ca_getTableInfo($ctrl=null,$table=null){
		$key = "ctrl:ca_tabInfo".($table?"/".$table:"");
		$t = $this->getParam($key);
		$tb = null;
		if ($t !=null)
			return $t;
		else
			$tb =  igk_createNode("table");

		$ctrl = $ctrl==null? igk_getctrl($this->SelectedController) : $ctrl;

		$tr = $tb->addTr();
		$t = IGKdbColumnInfo::GetColumnInfo();
		$tr->add("th")->Content = IGK_HTML_SPACE;
		foreach($t as $v=>$k)
		{
			$tr->add("th")->Content = R::ngets("lb.".$v);
		}
		$tr->add("th")->Content = IGK_HTML_SPACE;

		if ($table==null){

			if (file_exists($ctrl->getDBConfigFile()))
			{
				$tab = $ctrl->getDataTableInfo();
				foreach($tab as $k)
				{
					$tb->add( $this->ca_getFieldInfo($k));
				}

			}
			else{
				$info = IGKdbColumnInfo::NewEntryInfo();
				$info->clIsPrimary = true;
				$tb->add( $this->ca_getFieldInfo($info));
			}
		}
		else {
			$inf = igk_db_get_table_info($table);
			if (isset($inf["ColumnInfo"]))
				$inf = $inf["ColumnInfo"];
			foreach($inf as $k)
			{
				$tb->add($this->ca_getFieldInfo($k));
			}
		}
		$this->setParam($key, $tb);
		return $tb;
	}
	public function ca_getFieldInfo($info)
	{
		$tr =  igk_createNode("tr");
		$tr["__id"] = igk_new_id();
		$tr->addTd()->Content = IGK_HTML_SPACE;
		foreach($info as $v=>$k)
		{
			$td = $tr->addTd();
			switch(strtolower($v))
			{
				case "clisunique":
				case "clautoincrement":
				case "clisprimary":
				case "clisindex":
				case "clnotnull":
				case "clisuniquecolumnmember":
				case "clisnotinqueryinsert":
					//$td["class"]="alignc";
					$c = $td->add("div", array("class"=>"dispb fitw", "style"=>"text-align:center;"))->addInput("__cl".$v."[]","checkbox", null, array("onchange"=>"javascript:(function(q){window.igk.ctrl.ca_update_checkchange(q, '".$v."[]');})(this);"));
					if ($k)
						$c["checked"]="true";
					$td->addInput($v."[]", "hidden", $k);
					break;
				case "cltype":
					//igk_html_build_select($target, $name, $tab, $attributes=null, $selectedvalue = null, $attr=null)
					igk_html_build_select($td, $v."[]",  IGKdbColumnDataType::GetDbTypes() ,
					null,
					$k);
					break;
				default:
				$i = $td->addInput($v."[]","text", $k);
				$i["class"]="-cltext";
				$i["style"]="max-width:125px;";
				break;
			}
		}
		IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("ca_dropfield&n=".$tr["__id"]), "drop_16x16");

		return $tr;
	}
	public function ca_addfield_ajx()
	{
		$c = $this->ca_getFieldInfo(IGKdbColumnInfo::NewEntryInfo());
		if ($table = $this->getParam("ctrl:ca_tabInfo"))
		{
			igk_html_add($c, $table);
		}
		igk_wln($c->Render());
	}
	public function ca_dropfield()
	{
		$n = igk_getr("n");
		$table = $this->getParam("ctrl:ca_tabInfo");
		$tr = $table->getElementByAttribute("__id", $n);
		if ($tr)
		{
			igk_html_rm($tr);
		}
	}
	public function ca_ClearTableList_ajx()
	{
		$this->setParam("ctrl:ca_tabInfo", null);
		$f = igk_getctrl($this->SelectedController)->getDBConfigFile();
		if (file_exists($f))
			@unlink($f);
		igk_wl($this->ca_getTableInfo()->Render());
	}


	// CTRL ARTICLE AND CONFIGURATION VIEW ARTICLE
	// function demo1_ajx()
	// {
// igk_wl(<<<EOF
// <script type="text/javascript" language="javascript"> ns_igk.ajx.fn.getfortarget('?c=c_ca&f=ViewAJX', ns_igk.ctrl.getCtrlById('c_ca'));</script>
// EOF
// );
	// }
	public function View(){
		//VIEW: CTRLANDARTICLE
		$t = $this->TargetNode;
		if ($this->getIsVisible())
		{


			IGKHtmlUtils::AddItem($t, $this->ConfigNode);
			$t->ClearChilds();

			igk_html_add_title($t, "title.ControllerManager");

			// $t->addDiv()->addInput("info", "button", "info")->setAttribute("onclick", "javascript: alert(ns_igk.ctrl.getCtrlById('".IGK_CA_CTRL."')) ;  ns_igk.ajx.fn.getfortarget('?c=".IGK_CA_CTRL."&f=ViewAJX', ns_igk.ctrl.getCtrlById('".IGK_CA_CTRL."')); ");

			// $t->addDiv()->addInput("info", "button", "info2")->setAttribute("onclick", "javascript: ns_igk.ajx.get('{$this->getUri('demo1_ajx')}', null, null)" ); //ns_igk.ajx.replace_content

			$t->addHSep();
			igk_add_article($this, "controller_and_article", $t->addDiv());
			$t->addHSep();

			$dv = $t->addDiv()->setClass("gc-v");

			$v_tabc = $dv->addComponent($this, "AJXTabControl", __METHOD__,1);
			$v_tabc->ClearChilds();
			$g=	$this->getParam(__CLASS__."://tabselected", 1);

			$h = array("controler", "tools", "templates", "modules");
			foreach($h as $k=>$v){
				$r = $k+1;
				$v_tabc->addTabPage(R::ngets("tab.".$v), $this->getUri("ca_tabv_ajx&g={$r}"), 0);
			}

			$v_tabc->setTabViewListener(null);
			$v_tabc->select(0);

			// igk_exit();

		}
		else{
			$this->TargetNode->ClearChilds();
			igk_html_rm($this->TargetNode);
		}

	}
	public function TabViewPage($n, $list, $content){
		$g=	$this->getParam(__CLASS__."://tabselected",1);
		$i=1;
		$content->ClearChilds();
		foreach($list->getElementsByTagName("li") as $k){
				if ($i==$g){
					$k->setClass("+igk-active");
					$content->addAJXScriptContent($k->getParam("uri"), $k->getParam("method"));
				}
				else
					$k->setClass("-igk-active");
				$i++;
		}
	}
	public function _buildViewView($div,$ctrl=null)
	{
		igk_html_add_title($div, "title.Views");
		$this->ca_viewViewFiles($div, $ctrl);
	}
	private function _viewCtrlEditResult($v_dv){
		// igk_ilog("dddd");
			$dv = $v_dv->addCol("igk-col-4-2")->addColViewBox();
			$dv["class"] = "controller_info";
		    $this->_view_ctrl_info(igk_getctrl($this->SelectedController), $dv);

			$frm = $dv->addForm();
			$frm->addBr();

			$frm->addBtn("btn_remove", R::ngets("btn.removeCtrl") , "submit", array(
			"onclick"=>
			"javascript: return window.igk.ctrl.confirm_frame(this,'".
			R::ngets(IGK_MSG_DELETEFILE_QUESTION,$this->SelectedController)->getValue().
			"', '".$this->getUri("drop_controller") .
			"');"));

			$frm->addInput("confirm", "hidden", 0);
			IGKHtmlUtils::AddBtnLnk($frm, "btn.addcontroller",  igk_js_post_frame($this->getUri("ca_add_ctrl_frame_ajx")) );
			IGKHtmlUtils::AddBtnLnk($frm, "btn.showcontrollerview", igk_js_post_frame( igk_getconfigwebpagectrl()->getUri("cc_view_controllerschema_ajx")));


			;
			$this->_buildViewArticle($v_dv->addCol("igk-col-4-2")->addColViewBox());
			$this->_buildViewView($v_dv->addCol("igk-col-4-2")->addColViewBox());

	}
	private function _view_default_tab($t){
		//add default form ctrl
			$t->addNotifyHost();
			$tv = $t->addRow();

			$this->__viewDefaultPageCtrl($tv->addCol("igk-col-4-2 igk-col-sm-3-3")->addDiv()->setClass("igk-col-view-box"));
			$this->__viewMenuHostCtrl($tv->addCol("igk-col-4-2 igk-col-sm-3-3")->addDiv()->setClass("igk-col-view-box"));
			//$t->addHSep();
			$row = $t->addRow();
			$this->_view_ctrl_EditCtrl($row->addCol("igk-col-3-3"));

			$v_dv = $row->addCol("igk-col-3-3")->addDiv()->setClass("cnf-edit-view-result igk-row");

			$this->_viewCtrlEditResult($v_dv);

			$this->TargetNode->addScript()->Content = <<<EOF
window.igk.system.createNS("igk.fn.config", {select_ctrl: function(i, targetid, uri){var q = window.igk.getParentById(i, targetid ); window.igk.ajx.post(uri, null, function(xhr){  if (this.isReady()){ this.setResponseTo(q); var p = q.getElementsByTagName('select')[0]; p.focus(); }})}});
EOF;
	}
	public function ca_tabv_ajx(){
		$g = igk_getr("g");
		$n =  $this->getParam(__CLASS__."://tabview_node/");
		if (!$n)
			$n = igk_createNode();
		$n->clearChilds();
		switch($g){
			case 1: //global view
			// $n->addDiv()->setClass("igk-xsl-node")->Content = "testing";
				$this->_view_default_tab($n);
				break;
			case 2: //tool view
				$frm  = $n->addForm();
				$frm->addDiv()->Content = "/!\\ Not Implement !";
				// $frm->addInput("btn.install", "submit", "install controler");
				break;
			case 3 : //get templates
				//$frm = $n->addForm();
				//template form
				$c = igk_template_mananer_ctrl();//igk_getctrl("Lib.igk.SysMods.TemplateManager.IGKApplicationManager_php", true);
				//igk_ $frm->addTemplate($this, "templatelist");
				if ($c){
					$c->showConfig($n);
				}else{
					$n->addDiv()->setClass("igk-danger")->Content = R::ngets("warn.notemplatemanagerfound");//"/!\\ No template manager found";
				}

				break;
			default:
				$frm  = $n->addForm();
				$frm->addDiv()->Content = R::ngets("warn.notimplement");// "/!Not Implement Yet !!!!";
				break;
		}
		$n->RenderAJX();
		$this->setParam(__CLASS__."://tabselected", $g);
		$this->setParam(__CLASS__."://tabview_node/", $n);
		igk_exit();
	}

	public function ca_remove_child()
	{
		$ctrl = igk_getctrl(igk_getr("clParentCtrl"));
		$p = igk_getctrl(igk_getr("clChild"));

		if (!$ctrl || !$p)
			return;
		$p->setWebParentCtrl(null, true);
		$ctrl->unregChildController($p);
		$this->View();
	}
	public function ca_remove_parent()
	{
		$ctrl = igk_getctrl(igk_getr("clCtrl"));
		$p = igk_getctrl(igk_getr("clParent"));

		if (!$ctrl || !$p)
			return;

		$p->unregChildController($ctrl);
		$ctrl->setWebParentCtrl(null, true);

		$this->View();
	}

	private function _view_ctrl_info($ctrl, $target)
	{//show controller info
		if ($ctrl==null)
			return;

		$p = $target->addDiv();
		$p["class"]="igk-cnf-ctrl-info";
		$p->addDiv(array("class"=>"igk-cnf-selected-ctrl"))->Content = $this->SelectedController;

		$p->addDiv()->Content = R::ngets("Q.ISWEBPAGECTRL_1", igk_parsebools(igk_reflection_class_extends(get_class($ctrl), "IGKDefaultPageCtrl" ))->getValue());
		$p->addDiv()->Content = R::ngets("lb.CtrlType")->getValue() . " : ". igk_sys_ctrl_type($ctrl);
		$p->addDiv()->Content = R::ngets("lb.Location_1", $ctrl->getDeclaredDir());

		$p->addBr();
		if (method_exists($ctrl, "getAppUri")){
			$dv = $p->addDiv();
			$appuri = $ctrl->getAppUri();
			if ($appuri)
				$dv->addABtn($appuri)->Content = "Visit";
		}



		$table = $p->addDiv()->setClass("fitw")
		->setStyle("overflow-x:auto")
		->addTable();

		$v_parent = igk_getctrl($ctrl->Configs->clParentCtrl);
		if ($v_parent!= null)
		{
			$t = $table->addTr();
			$t->add("th")->Content = R::ngets("title.Parent");
			$t->add("th")->Content = IGK_HTML_SPACE;
			$tr = $table->addTr();
			$tr->addTd()->addLi()->add("a", array("href"=>"#", "onclick"=>"javascript:window.igk.fn.config.select_ctrl(this, '".$this->TargetNode["id"]."', '".$this->getUri('select_controller_ajx&n='.$ctrl->Configs->clParentCtrl)."'); "))->Content = $ctrl->Configs->clParentCtrl;
			IGKHtmlUtils::AddImgLnk($tr->add("td",array("style"=>"min-with:16px; min-height:16px;")),$this->getUri("ca_remove_parent&clCtrl=".$ctrl->getName()."&clParent=".$ctrl->Configs->clParentCtrl), "drop_16x16");
		}
		else {
			$tr = $table->addTr();
			$tr->add("td" ,array("colspan"=>2))->Content =  R::ngets("msg.noparent");
		}

		$p->addBr();

		$table = $p->addDiv()->setClass("fitw")
		->setStyle("overflow-x:auto")
		->addTable();


		$table["class"] = "fitw";
		$tr = $table->addTr();
		$tr->add("th")->Content = R::ngets("title.Childs");
		$tr->add("th")->Content = R::ngets("title.index");
		$tr->add("th", array("style"=>"width:16px"))->addSpace();

		if (igk_count($ctrl->Childs) > 0)
		{

			$tab = $ctrl->Childs;

			usort($tab, "igk_sort_byNodeIndex");

			foreach($tab as $k)
			{
				$tr = $table->addTr();
				$tr->addTd()->add("a", array("href"=>IGK_JS_VOID,"onclick"=>"javascript:window.igk.fn.config.select_ctrl(this, '".$this->TargetNode["id"]."', '".$this->getUri('select_controller_ajx&n='.$k->Name)."'); return false; "))->Content = $k->Name;
				$tr->addTd()->Content = $k->TargetNode->Index;
				IGKHtmlUtils::AddImgLnk($tr->add("td",array("style"=>"min-with:16px; min-height:16px;")),$this->getUri("ca_remove_child&clParentCtrl=".$ctrl->Name."&clChild=".$k->Name), "drop_16x16");
			}
		}
		else {
			$tr = $table->addTr();
			$tr->add("td",array("colspan"=>3))->Content = R::ngets("msg.nochilds");
		}
		$p->addHSep();
		//additional info entertaiment
		$table = $p->addDiv()->setClass("fitw")
		->setStyle("overflow-x:auto")
		->addTable();
		$tr = $table->addTr();
		$tr->add("th")->Content = R::ngets("lb.properties");
		$tr->add("th")->Content = R::ngets("lb.values");


			foreach($ctrl->Configs as $k=>$v)
			{
				if ($k == "clParentCtrl")
					continue;
				$tr = $table->addTr();
				$tr->addTd()->addLabel()->Content =R::ngets( "lb.".$k);
				$tr->addTd()->addLabel()->Content = $v;
			}
		//add controller info options
		$div =  $p->addDiv();
		$this->_view_ctrl_options($ctrl, $div);
	}
	//drop controller:
	public function ca_ctrl_drop(){
		$this->ca_drop_controller_ajx($this->SelectedController);
	}
	//drop controller: configs
	public function ca_drop_controller_ajx($ctrl=null, $reconnect=1)
	{
		$a = $ctrl? $ctrl: (($ctrl = igk_getr("clController")) ? $ctrl :  igk_getr("n"));

		if ($a)
		{
			$ctrl = igk_getctrl($a,false);
			if ($ctrl == null)
				return;

			$is_ajx = igk_is_ajx_demand();
			if (igk_qr_confirm())
			{

				// $doc = igk_get_last_rendered_document();
				// if ($doc===null){
					// igk_ilog("last rendergin document is null");
					// $doc = igk_app()->Doc;
				// }
				// else{
					// igk_ilog("render body ".$doc->getParam("VieqPAram"));
				// }
				// if (defined('IGK_CONFIG_PAGE'))
					// igk_getconfigwebpagectrl()->View();
				// $doc->body->RenderAJX();
				// igk_exit();
				if ($ctrl->canDelete)
				{
					$uri = igk_getconfigwebpagectrl()->getReconnectionUri();
					if (igk_getctrl(IGK_CTRL_MANAGER)->removeCtrl($a))
					{

						$this->SelectedController = null;
						$this->View();

						//Clear an reconnect
						$ctrl = igk_getconfigwebpagectrl();

						if ($is_ajx)
						{
							$doc = igk_get_last_rendered_document();
							if ($doc===null)
								$doc = igk_app()->Doc;
							if (defined('IGK_CONFIG_PAGE'))
							igk_getconfigwebpagectrl()->View();

							$doc->body->RenderAJX();
							igk_exit();
						}
						else if ($reconnect){

							$ctrl->ClearSessionAndReconnect(false);
						}
					}
					else{
						igk_ilog("drop the controlleur failed : ".$a,__FUNCTION__);
					}
				}
				else{
					$this->msbox->addErrorr("err.dropctrlfailed");//""impossible de supprimer le controller. cela peut entrainer des incohérences");
				}
			}
			else{
				// $frame = igk_frame_add_confirm($this, "drop_controller_frame", $this->getUri("ca_drop_controller_ajx"));
				// $frame->Form->Div->Content = R::ngets(IGK_MSG_DELETECTRL_QUESTION, $a);
				// $frame->Form->addInput("clController", "hidden", $a);
				// $frame->Form->addInput("forceview", "hidden", igk_getr("forceview",null));//force view to force current view
				// if (igk_is_ajx_demand())
				// {
					// $frame->Form->addInput("ajx", "hidden", "1");
					// $frame->RenderAJX();
				// 
				$d = igk_createNode("div");
				$d->addDiv()->Content =  R::ngets(IGK_MSG_DELETECTRL_QUESTION, $a);
				$frm = $d->addForm();				
				$frm["action"] = $this->getUri("ca_drop_controller_ajx");
				
				$frm->addInput("clController", "hidden", $a);
				$frm->addInput("forceview", "hidden", igk_getr("forceview",null));
				if (igk_is_ajx_demand()){
					$frm->addInput("ajx","hidden", 1);
				}
				$b = $frm->addDiv();
				$b->addInput("yes", "submit", R::ngets("btn.yes"));
				$b->addInput("no", "button", R::ngets("btn.no"));
				$frm->addConfirm();
				$frm->addToken();
				
				igk_ajx_notify_dialog(R::ngets("title.dropController"), $d);
			}
		}
	}

	
	public function ca_add_article_frame()
	{
		$ctrl = (($c = igk_getctrl( igk_getr("ctrlid", null), false))!=null)? $c: $this->SelectedController;
		if ($ctrl == null)
		{
			igk_notifyctrl()->addMsg("no controller selected");
			return null;
		}
		$frame = igk_add_new_frame($this, "add_article_frame", "#article");
		$frame->Title = R::ngets("title.addArticle", $this->m_selectedLang );
		$this->m_selectedLang = igk_getr("clLang", $this->m_selectedLang );
		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri("ca_add_article");
		$frm->addSLabelInput(IGK_FD_NAME);
		$frm->addBr();

		$lg = $this->m_selectedLang?$this->m_selectedLang:"fr";
		$frm->addLabel()->Content = R::ngets("lb.currentlang",$lg );
		$frm->addInput("clLang", "hidden", $lg);
		$frm->addInput("clCtrl", "hidden", $ctrl->Name);
		$frm->addBr();
		$txt = $frm->addTextArea("clContent", null);
		igk_js_enable_tinymce($frm, 'exact','clContent');
		$frm->addHSep();
		$frm->addBtn("btn_save", R::ngets("btn.save"));
		return $frame;
	}
	public function ca_add_article_frame_ajx()
	{
		$frame = $this->ca_add_article_frame();
		if ($frame){
			$frame->RenderAJX();
		}
	}
	public function add_view(){
		$n = igk_getr(IGK_FD_NAME);
		$ctrl = $this->SelectedController;
		$content = igk_getr("clContent");
		$this->val->ClearChilds();

		if (IGKValidator::IsStringNullOrEmpty($n)){ $this->val->addLi()->Content = "Name not defined";}

		if (!$this->val->HasChilds)
		{

			$a = igk_getctrl($ctrl)->getViewDir();
			if (IGKIO::CreateDir($a)){
				$file =$a."/".$n.".phtml";
				igk_io_save_file_as_utf8($file, igk_html_unscape($content), true);
			}
		}
		else{
			$this->msbox->copyChilds($this->val);
		}
		$this->View();
		igk_navtocurrent();
	}
	///<summary>build a add view frame</summary>
	public function ca_add_view_frame(){
		$frame = igk_add_new_frame($this, "add_view_frame");
		$frame->Title = R::ngets("title.addView");
		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri("add_view");
		$frm->addSLabelInput(IGK_FD_NAME);
		$frm->addBr();
		$frm->addTextArea("clContent")->setClass("php-code");
		$frm->addHSep();
		$frm->addBtn("btn_save", R::ngets("btn.save"));
		return $frame;
	}

	public function ca_view_body_ajx()
	{
		$uri = base64_decode(igk_getr("uri"));
		igk_loadr($uri);
		//load connection uri
		if ($this->App->getControllerManager()->InvokeUri($uri, false))
		{
			$this->App->getControllerManager()->ViewControllers();
			$this->App->Doc->body->RenderAJX();
		}
	}

	public function _buildAdditionalInfo($ctrl, $p)
	{
		$d = null;
		$tab = null;
		if (is_object($ctrl))
		{
			$n = igk_sys_ctrl_type($ctrl);
			$d = igk_getv(IGKCtrlTypeManager::GetControllerTypes(), $n);

			if (method_exists($ctrl, "GetCustomConfigInfo")){
				$tab =  $ctrl->GetCustomConfigInfo();
			}
		}
		else if (is_string($ctrl))
		{
			$d = igk_getv(IGKCtrlTypeManager::GetControllerTypes(), $ctrl);
		}
		if ($d!==null)	{
			//igk_ilog("s d:::: ".$d);
			$h = call_user_func( array($d, "GetAdditionalConfigInfo"), array());
			//igk_wln($h);
			$tab = array_merge($h, $tab ?? array());

		}

		if (is_array($tab))
		{
			foreach($tab as $k=>$v)
			{
				if (is_object($v))
				{
					$li = $p->addLi();
					$lb  = $li->addLabel($k, R::ngets("lb.".$k));//, $k);
					if (igk_getv($v, "clRequire")){
						$lb->setClass("clrequired");
						//igk_exit();
					}
					$defaultv = igk_getv(igk_getv($ctrl, "Configs"),$k,  igk_getv($v, "clDefaultValue"));
					switch(strtolower($v->clType))
					{
						case "select":
							igk_html_build_select($li, $k, $v->clValues, null, $defaultv, null);
							break;
						case "file":
							break;
						case "bool":
							$chk = $li->addInput($k, "checkbox", "1");
							if ($defaultv == 1)
								$chk->activate('checked');
							//["checked"] = new IGKHtmlNoValueAttribute();
							break;
						default :
							$li->addInput($k, "text",   $defaultv );
							break;
					}

				}
				else{
					$p->addLi()->addSLabelInput($v, "text",  igk_getv( igk_getv($ctrl, "Configs"), $v) );
				}
			}
		}
	}

	///<summary>get controller type addition info</summary>
	public function ca_get_ctrl_type_info_ajx()
	{
		$p = $this->getParam("ca:view_frame");
		$n = igk_getr("n");
		if ($p != null)
		{
			$p->ClearChilds();
			$this->_buildAdditionalInfo($n, $p);
			$p->RenderAJX();
		}
		else{
			igk_notifybox_ajx("no [ca:view_frame] setup");
		}
	}
	public function ca_add_ctrl(){
		//static do nothing . no javascript call this
		$this->ca_add_ctrl_frame_ajx();
	}
	public function ca_add_ctrl_frame(){
		$frame = igk_add_new_frame($this, __FUNCTION__."::Frame");
		if (igk_qr_confirm())
		{
			igk_frame_close($frame->Id);
			igk_html_rm($frame);
			$this->ca_addCtrl();
			unset($frame);
			$this->view();
			igk_js_ajx_view_ctrl($this);
		}
		//create new frame
		$frame = igk_add_new_frame($this, __FUNCTION__."::Frame");

		$frame->Title = R::ngets("title.AddController");

		$frame->BoxContent->ClearChilds();
		$frm = $frame->BoxContent->addForm();
		$frm["action"]= $this->getUri("ca_add_ctrl");
		$nid = $this->TargetNode["id"];

		$js_change_func =
<<<EOF
if (ns_igk.ctrl.ca_ctrl_change)
ns_igk.ctrl.ca_ctrl_change('{$this->getUri("ca_get_ctrl_type_info_ajx&n=")}', this);
EOF;

		$frm["onsubmit"]= "javascript: window.igk.ajx.postform(this,'".$this->getUri("ca_add_ctrl_frame_ajx")."', ns_igk.ajx.fn.replace_or_append_to_body, false ); this.reset(); return false;";
		$frm->addDiv()->addNotifyHost('controller');
		$frm->addInput('notification','hidden', 'controller');

		// $b->RenderAJX();
		// igk_wln("done ");
		//igk_exit();

		$ul = $frm->add("ul")->setStyle("overflow-y:auto; max-height:300px");
		$ul->addLi()->addSLabelInput(IGK_FD_NAME,"text", null,null, true);
		$ul->addLi()->addSLabelInput("clDisplayName");
		$h = $ul->addLi()->addSLabelInput("clRegisterName");
		$h->input["tooltip"] = R::ngets("tooltip.controller.registername");
		$li = $ul->addLi();
		$li->add("label", array("for"=>"clCtrlType"))->Content = R::ngets("lb.ctrlType");

		$ul->addLi()->addSLabelInput("clOutFolder");

		//controller type
		$t = array_keys(IGKCtrlTypeManager::GetControllerTypes());
		sort($t);
		$sel = igk_html_build_select($li, "clCtrlType", $t, null, "DefaultPage");

		$sel["onchange"]="javascript:{$js_change_func};";
		$p = $this->getParam("ca:view_frame");
		if ($p == null)
		{
			$p = $ul->addLi()->addDiv();
			$p->setId("view_frame");
			$p["class"] = "igk-ctrl-additionnal-properties";
			$this->setParam("ca:view_frame", $p);	//node to render view frame
		}
		$p->ClearChilds();
		igk_html_add($p, $ul);


		//:clDataAdapterName
		$this->_ca_add_adapter($ul->addLi(), "clDataAdapterName", IGK_MYSQL_DATAADAPTER);
		
		//:cldataSchema
		$li = $ul->addLi();
		$li->addLabel("clDataSchema");
		
		$sl = $li->addSelect('clDataSchema');
		$sl->addOption("false")->Content = R::ngets("enum.false");
		$sl->addOption("true")->Content = R::ngets("enum.true");
		$sl->select(igk_parsebool(false));

		//:clParentCtrl	
		$this->_frm_tablevisiblectrl($ul->addLi(), "clParentCtrl");
		
		$ul->addLi()->addSLabelInput("clTargetNodeIndex");
		$ul->addLi()->addSLabelInput("clVisiblePages");
		$ul->addLi()->addSLabelInput("clDescription");


		$frm->addHSep();
		$frm->addInput("confirm", "hidden", "1");
		$frm->addBtn("btn_add", R::ngets("btn.Add"));
		
		if (!igk_is_ajx_demand()){
			$u = igk_io_baseUri()."/Lib/igk/scripts/igk.js";
			$frm->addScript()->setAttribute('src', $u);
		}
$frm->addBalafonJS()->Content = <<<EOF
ns_igk.ready(
function(){
var r = \$igk(\$ns_igk.getParentScriptForm());
if (!r)return;
 (function(q){ if (!q)return;
 var p = q.select("#liPageName").getItemAt(0);
 var c = q.select("#clWebPage").getItemAt(0);
 if (c && p)
	c.reg_event("change",function(){ if (this.checked) p.css('display:block;'); else p.css('display:none'); });})(r);
	var q = (r).select("#clCtrlType").getItemAt(0);
	if (ns_igk.ctrl.ca_ctrl_change)
		ns_igk.ctrl.ca_ctrl_change('{$this->getUri("ca_get_ctrl_type_info_ajx&n=")}', q.o);
});
EOF;

//{$js_change_func}((r).select("#clCtrlType").getItemAt(0));

		return $frame;
	}
	///<summary>view add controller frame</summmary>
	public function ca_add_ctrl_frame_ajx($renderframe=true){

		$frame = $this->ca_add_ctrl_frame();
		if ($renderframe)
		{
			$frame->RenderAJX();
		}
	}
	private function _frm_tablevisiblectrl($li, $name, $value =null, $showspace=true)
	{

		$tab =  igk_sys_getuserctrls();
		if (count($tab) > 0)
		{
			$li->addLabel()->Content = R::ngets("lb.parentctrl");
			$sel = $li->add("select");
			$sel["id"]=$sel["name"] = $name;
			if ($showspace)
				$sel->add("option", array("value"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;
			foreach($tab as $v)
			{
				$opt = $sel->add("option", array("value"=>$v->getName()));
				$opt->Content = $v->DisplayName;
				if ($value && !$value == $v->getName())
				{
					$this->value = $v->getName();
				}
			}
		}
	}

	public function ca_addCtrl(){//add a controller
		if (igk_qr_confirm() && $this->ConfigCtrl->IsConnected)
		{
			$ctrl = igk_getctrl(IGK_CTRL_MANAGER);
			$g =0 ;
			$msg = "msg.ctrl.notadded";
			$v_not = igk_notifyctrl(igk_getr("notification", 'controller'));
			if ($ctrl->addController(null, igk_getr("clWebPage",false), igk_getr("clParentCtrl",null)))
			{
				$g=1;
				$v_not->addMsgr("msg.controlleradded");
				$msg = "msg.ctrl.added";
			}
			else {
				$v_not->addErrorr("err.controllernotadded");
				$g=4;
			}			
			igk_ajx_toast($msg, 
				igk_css_type($g)
			);			
			igk_resetr();
			$this->setParam("ca:view_frame",null);
			$this->View();
			igk_exit();
		}
	}

	public function ca_add_article(){//add article frame
		$ctrl = igk_getr("clCtrl");
		$name = igk_getr(IGK_FD_NAME);
		$content = igk_getr("clContent");
		$lang = igk_getr("clLang", igk_sys_getconfig("default_lang","fr"));
		$e =  igk_createNode("error");
		if (IGKValidator::IsStringNullOrEmpty($name)){ $e->addLi()->Content = "name not defined";}
		//if (IGKValidator::IsStringNullOrEmpty($content)){ $e->addLi()->Content = "Content not defined";}
		if (IGKValidator::IsStringNullOrEmpty($lang)){ $e->addLi()->Content = "Language not define";}

		if (!$e->HasChilds)
		{
			$obj_ctrl = igk_getctrl($ctrl);

			if ($obj_ctrl == null)
			{
				igk_show_prev($_REQUEST);
				die("not controller found");
			}

			
			$a = $obj_ctrl->getArticlesDir();
			IGKIO::CreateDir($a);
			//matched template file our
			$file = igk_io_get_article_file($name, $a, $lang);
			if ($this->__write_article_for_tiny($file, igk_html_unscape($content)))
			{
				igk_resetr();
				igk_setr("controler", $ctrl );

			}
			else{
				igk_notifyctrl()->addErrorr("err.filenotsaved");
			}
			$obj_ctrl->View();
		}
		else{
			$this->msbox->copyChilds($e);
		}
		$this->View();
	}



	public function getConfigPage(){return "articleconfig";}

	protected function InitComplete(){
		parent::InitComplete();
		$this->setup_defaultpage();
	}
	public function __construct(){
		parent::__construct();
		$this->m_SelectedController = null;
		$this->m_SelectedControllerChangedEvent = new IGKEvents($this, "SelectedControllerChanged");
		$this->m_SelectedControllerChangedEvent->add($this, "ca_selectedCtrlChanged");
	}
}


//File Manager
final class IGKFileManagerCtrl extends IGKConfigCtrlBase
{
	private $m_directory;

	public function fm_updatefile()
	{
		$url = igk_getr("uri");
		$content = igk_getr("content");
		if (($url == null) || is_file($url))
		{
				return;
		}
		igk_io_save_file_as_utf8($url, $content , true);
	}
	public function createfile()
	{
		$url = igk_getr("uri");
		if (($url == null) || is_file($url))
		{
				return;
		}
		igk_io_save_file_as_utf8($url, IGK_STR_EMPTY, true);
	}
	public function getConfigPage(){return "filemanager";}

	public function __construct(){
		parent::__construct();
	}
	public function loadfiles_frame()
	{
		$frame = igk_add_new_frame($this, "upload_files_frame");
		$frame->BoxContent->ClearChilds();
		$frame->Title = R::ngets("title.loadFilesFrames");
		$frame->Width = "300";
		$d = $frame->BoxContent;
		$frm  = $d->addForm();
		$frm["action"] = $this->getUri("loadfiles");

		$frm->addFile("clFile", true);
		$frm->addInput("MAX_FILE_SIZE", "hidden", "15000000");
		$frm->addHSep();
		$frm->addBtn("btn_confirm", R::ngets("btn.upload"));
	}
	public function createdir_frame()
	{
		$frame = igk_add_new_frame($this, "createdir_frame");
		$frame->Title = R::ngets("title.createDirFrame");
		$frame->BoxContent->ClearChilds();
		$frame->Width = "300";
		$d = $frame->BoxContent;
		$frm  = $d->addForm();
		$frm["action"] = $this->getUri("createdir");

		$frm->addSLabelInput(IGK_FD_NAME);
		$frm->addHSep();
		$frm->addBtn("btn_confirm", R::ngets("btn.create"));
	}
	public function createdir()
	{
		$ndir = igk_getr(IGK_FD_NAME);
		if (empty($ndir))
			return;
		$path = igk_io_dir(igk_io_currentRelativePath($this->m_directory)."/".$ndir);
		if (!is_dir($path))
		{
			mkdir($path);
			$this->View();
		}
	}
	public function loadfiles()
	{
		$t = igk_getv($_FILES,"clFile");
		$path = igk_io_currentRelativePath($this->m_directory);
		igk_frame_close("upload_files_frame");
		$error = false;
		if (is_array($t["name"]))
		{
			for($i =0; $i< count($t["name"]) ; $i++)
			{
				if ($t["error"][$i] == 0)
				 {
				move_uploaded_file($t["tmp_name"][$i], igk_io_dir($path."/".$t["name"][$i]));
				}
				else{
					igk_notifyctrl()->addError("can't upload file [".$t["name"][$i]."] error : ".$t["error"][$i]." " .ini_get("upload_max_filesize")." file is authorized" );
					$error = true;
				}
			}
		}
		else{
			if ($t["error"]==0)
			{
				move_uploaded_file($t["tmp_name"], igk_io_dir($path."/".$t["name"]));
				$error = true;
			}
		}
		if (!$error)
		{
			igk_notifyctrl()->addMsgr("MSG.FileUploadSuccess");
		}
		$this->View();
		igk_navtocurrent();

	}
	public function View(){
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}
		$c = $this->TargetNode;

		IGKHtmlUtils::AddItem($c, $this->ConfigNode);
		$c->ClearChilds();

		$d = $c->addDiv();
		igk_html_add_title($d, "title.FileManager");
		$d->addHSep();
		igk_add_article($this, "filesystem.description", $d->addDiv());
		$d->addHSep();
		//action list
		IGKHtmlUtils::AddBtnLnk($d, R::ngets("btn.loadFiles") , $this->getUri("loadfiles_frame"));
		IGKHtmlUtils::AddBtnLnk($d, R::ngets("btn.createDir") , $this->getUri("createdir_frame"));
		$d->addHSep();
		//show path list
		$sep = explode(DIRECTORY_SEPARATOR , igk_io_dir($this->m_directory));
		if (($count = count($sep))>0)
		{
	//		$path = $d->addDiv();
			$bs = $d->addDiv()->setClass("igk-breadcrumbs");
			//$path->Content = $this->m_directory;
			$cpath =null;
			$nid = $this->TargetNode["id"];
			for($i = 0; $i<$count; $i++)
			{
				if ($i!= 0){
					// $path->add("span", array("class"=>strtolower($this->getName()."_dirseparator")))->Content  = "&gt;";
					// $cpath .= DIRECTORY_SEPARATOR;
				}
				// $cpath .=  $sep[$i];
				$bs->addLi()->addA("#")->setAttribute("onclick",
				"javascript:ns_igk.ajx.post('".
					$this->getUri("gotoparent_ajx&n=".($count-$i-1))."', null, ns_igk.ajx.fn.bindto(ns_igk.getParentById(this, '".
					$nid .
					"'))); return false; ")->Content  =$sep[$i];
				// $path->add("span",  array("class"=>strtolower($this->getName()."_dir")))->add("a",
				// array(
					// "href"=>$this->getUri("open_fulldir&d=".urlencode($cpath)),
					// "onclick"=>"javascript: (function(i){var q= window.igk.getParentById(i, '".
					// $nid ."'); if (q){ window.igk.ajx.post('".
					// $this->getUri("gotoparent_ajx")."', null, function(xhr){ if (this.isReady()){ q.innerHTML = xhr.response;}});}})(this); return false;",
					// )
				// )->Content  = $sep[$i];
			}

		}
		//
		$this->_showdir($this->m_directory);

	}
	public function open_fulldir()
	{
		$this->m_directory = igk_getr("d");
		$this->View();
	}
	public function open_fulldir_ajx()
	{
		$this->open_fulldir();
		igk_wl($this->TargetNode->innerHTML);
	}


	private function _showdir($dir)
	{
		$path = igk_io_currentRelativePath($dir?$dir: "");
		//protection
		if (!is_dir($path))
		{
			$s = realpath(igk_io_currentRelativePath(""));
			igk_debug(true);
			igk_wln("not a dir ".$path. " ? ".$dir ." :: ".igk_io_currentRelativePath(""));
			igk_debug(false);
			igk_notifyctrl()->addErrorr("e.notadirectory_1", $path);
			//$this->m_directory = null;
			if (!is_dir($s))
			{
				return;
			}
			$this->m_directory = igk_io_basePath($s);
			$path = $this->m_directory;
		}
		$tab = $this->TargetNode->addTable()->setClass("config-file_listview fitw");
		$tr = $tab->addTr();
		$tr->add("th")->Content = IGK_HTML_SPACE;
		$tr->add("th")->Content = R::ngets(IGK_FD_NAME);
		$tr->add("th")->Content = R::ngets("clSize");
		$tr->add("th")->Content = IGK_HTML_SPACE;//edit std
		$tr->add("th")->Content = IGK_HTML_SPACE;//edit tiny
		$tr->add("th")->Content = IGK_HTML_SPACE;//drop


		$hdir = opendir($path);
		$cangotoperent = false;
		if ($hdir)
		{
			$files = array();
			$dirs = array();
			while(($cdir = readdir($hdir)))
			{
				if (($cdir==".") || ($cdir== ".."))
				{
					if (($dir!=null) && ($dir != '/') && ($cdir =="..") && ($dir!="."))
					{
						$cangotoperent = true;
					}
					continue;
				}

				$cf = igk_io_dir($path."/".$cdir);
				if (is_dir($cf))
				{
					$dirs[$cdir] = $cf;
				}
				else if (is_file($cf))
				{
					$files[$cdir] = $cf;
				}
			}
			closedir($hdir);

			//sorlist
			igk_array_sortkey($files);
			igk_array_sortkey($dirs);

			if ($cangotoperent)
			{
				$tr = $tab->addTr();
				$tr->addTd()->Content = IGK_HTML_SPACE;
				$tr->add("td", array("colspan"=>"6"))->addLi()->add("a", array(
				"href"=>$this->getUri("gotoparent"),
				"onclick"=>"javascript: (function(i){var q= window.igk.getParentById(i, '".$this->TargetNode["id"].
				"'); if (q){ window.igk.ajx.post('".$this->getUri("gotoparent_ajx")."', null, function(xhr){ if (this.isReady()){ q.innerHTML = xhr.response; }});}})(this); return false;",
				"class"=>"config-fileviewdir"))->Content ="..";

			}

			foreach($dirs as $k=>$v)
			{

			$f = base64_encode(urldecode($k));
				$tr = $tab->addTr();

						$li = $tr->add("td",array("style"=>"width:16px;"))->addLi();
				$li->addInput(IGK_STR_EMPTY, "checkbox",null,null);

				$tr->addtd()->addLi()->add("a", array(
					"href"=>$this->getUri("opendir&d=".urldecode($k)),
					"class"=>"config-fileviewdir",
					"onclick"=>"javascript:(function(i){var q= window.igk.getParentById(i, '".$this->TargetNode["id"]."');if (q){ window.igk.ajx.post('".$this->getUri("opendir_ajx&d=".urldecode($k)).
					"', null, ns_igk.ajx.fn.bindto(q,i.href)); return false;}})(this); return false;"))->Content = $k;

				$tr->add("td",array("style"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;
				$tr->add("td",array("style"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;
				$tr->add("td",array("style"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;
				$tr->add("td",array("style"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;
				//IGKHtmlUtils::AddImgLnk($tr->add("td",array("style"=>"min-with:16px; min-height:16px;")),$this->getUri("change_authorisation&d=".$f),"ico_auth");

				if (IGKIO::IsDirEmpty($v)){

					IGKHtmlUtils::AddImgLnk($tr->add("td",array("style"=>"with:16px; height:16px;")),$this->getUri("drop_dir_or_file&d=".$f),"drop_16x16");
				}
				else
					$tr->addtd()->Content = IGK_HTML_SPACE;
				//$tr->add("td",array("style"=>IGK_STR_EMPTY))->Content = IGK_HTML_SPACE;
			}
			//select|filename|size|edit|changeauthorization|drop
			foreach($files as $k=>$v)
			{
				$f = base64_encode(urldecode($k));
				$tr = $tab->addTr();

				$li = $tr->add("td", array("style"=>"width:16px;"))->addLi();
				$li->addInput(IGK_STR_EMPTY, "checkbox",null, null);
				$li = $tr->addTd()->addLi();
				$li->add("a", array("href"=>$this->getUri("get_file&d=".$f),
				"class"=>"config-fileviewfile"))->Content = $k;
				$file = igk_io_currentRelativePath($this->m_directory ."/".$k);
				if (file_exists($file))
				{
					$size = @filesize($file);
					if ($size === false)
					{
						$tr->add("td", array("class"=>"alignr"))->Content = "?";
					}
					else
						$tr->add("td",array("class"=>"alignr"))->Content = IGKIO::GetFileSize( $size);
				}
				else
					$tr->addTd()->Content = "broken";

				IGKHtmlUtils::AddImgLnk($tr->add("td", array("style"=>"width:16px; min-height:16px")),$this->getUri("edit&d=".$f),"edit_16x16");
				IGKHtmlUtils::AddImgLnk($tr->add("td", array("style"=>"width:16px; min-height:16px")),$this->getUri("change_authorisation&d=".$f),"ico_auth_16x16");
				IGKHtmlUtils::AddImgLnk($tr->add("td", array("style"=>"width:16px; min-height:16px")),$this->getUri("fc_renameframe&d=".$f),"ico_rename_16_x16");
				IGKHtmlUtils::AddImgLnk($tr->add("td", array("style"=>"width:16px")),$this->getUri("drop_dir_or_file&d=".$f),"drop_16x16");
			}

			$this->TargetNode->addHSep();
			IGKHtmlUtils::AddBtnLnk($this->TargetNode, R::ngets("btn.rmAll"), $this->getUri("removeAll"));
			igk_html_toggle_class($tab);
		}
	}
	public function fc_renameframe()
	{
		$d = urldecode(base64_decode(igk_getr("d")));
		$frame = igk_frame_add_confirm($this, "rename_file_frame", $this->getUri("fc_rename"));
		$frame->Title = R::ngets("title.renamefile_1",$d);
		$div = $frame->Form->Div;
		$div->addInput("d", "hidden", igk_getr("d"));
		$div->addSLabelInput(IGK_FD_NAME, IGK_FD_NAME, "text", $d);


	}
	//rename file
	public function fc_rename()
	{
		$d = urldecode(base64_decode(igk_getr("d")));
		$e = igk_getr(IGK_FD_NAME);
		$file = igk_io_currentRelativePath($this->m_directory ."/".$d);
		$out = igk_io_currentRelativePath($this->m_directory ."/".$e);
		rename($file, $out);
		$this->View();
	}
	public function removeAll()
	{
		if (igk_qr_confirm())
		{
		  igk_notifyctrl()->addError("Dont be so .... No Implement ".  __LINE__);
		}
		else{
			$frame = igk_frame_add_confirm($this, "confirm_remove_all", $this->getUri("removeAll"));
			$frame->Form->Div->Content = R::ngets(IGK_MSG_DROPALL_QUESTION);
		}
	}
	
	private function addcheckbox($li, $name, $check, $key){
			$li->addInput($name, "checkbox", false, array("checked"=>$check));
			$li->add("label", array("for"=>$name))->Content = R::ngets($key);
	}
	public function change_authorisation()	{//change file authorisation

		if (!igk_is_conf_connected())
			return;
		$d = urldecode(base64_decode(igk_getr("d")));

		$file = igk_io_currentRelativePath($this->m_directory ."/".$d);
		if (!igk_qr_confirm())
		{
		

		$frame = igk_frame_add_confirm($this, "change_authorisation_frame", $this->getUri("change_authorisation"));
		$frame->Title = R::ngets("title.changeFileAuthorization", $d);
		$div = $frame->Form->Div;
		$div->addDiv()->Content = R::ngets("lb.user");
		$div->addHSep();
		$c = $div->add("ul");
		$perms = @fileperms($file);
		$this->addcheckbox($c->addLi(),"ur",false,"lb.Read");
		$this->addcheckbox($c->addLi(),"uw",false,"lb.Write");
		$this->addcheckbox($c->addLi(),"ux",false,"lb.Execute");

		$div->addDiv()->Content = R::ngets("lb.group");
		$div->addHSep();
		$c = $div->add("ul");

		$this->addcheckbox($c->addLi(),"gr",false,"lb.Read");
		$this->addcheckbox($c->addLi(),"gw",false,"lb.Write");
		$this->addcheckbox($c->addLi(),"gx",false,"lb.Execute");

		$div->addDiv()->Content = R::ngets("lb.other");
		$div->addHSep();
		$c = $div->add("ul");

		$this->addcheckbox($c->addLi(),"or",false,"lb.Read");
		$this->addcheckbox($c->addLi(),"ow",false,"lb.Write");
		$this->addcheckbox($c->addLi(),"ox",false,"lb.Execute");
		$div->addHSep();
		$this->addcheckbox($div->addDiv(),"clRecursif",true,"lb.Recursive");

		$frame->Form->addInput("d", "hidden", base64_encode(urlencode($d)));
		}
		else{
			$u = 0;
			$g=0;
			$o=0;
			$u |= igk_getr("ur")?4:0;
			$u |= igk_getr("uw")?2:0;
			$u |= igk_getr("ux")?1:0;

			$g |= igk_getr("gr")?4:0;
			$g |= igk_getr("gw")?2:0;
			$g |= igk_getr("gx")?1:0;

			$o |= igk_getr("or")?4:0;
			$o |= igk_getr("ow")?2:0;
			$o |= igk_getr("ox")?1:0;
			$v = '0'.$u.''.$g.''.$o;
			if (file_exists($file) ||is_dir($file))
			{
				if (is_dir($file) && igk_getr("clRecursif"))
				{
					$r = igk_file_chmod($file, octdec($v), true);
				}
				else
					$r = @chmod($file, octdec($v));
				if ($r){
					igk_notifyctrl()->addMsg("Permission changer ", substr(sprintf('%o', $file), -4));
				}
				else
					igk_notifyctrl()->addError("Impossible de changer les authorization de [".basename($file)."]");
			}

		}

	}
	public function drop_dir_or_file()
	{
		if (!igk_is_conf_connected())
		{return;}
		$d = urldecode(base64_decode(igk_getr("d")));
		$file = igk_io_currentRelativePath($this->m_directory ."/".$d);
		if (is_file($file))
		{
			if (igk_qr_confirm()){
				unlink($file);
				$this->View();
			}
			else{
				$frm = igk_frame_add_confirm($this, "confirm_file_delete", $this->getUri("drop_dir_or_file"));
				$frm->Form->Content = R::ngets(IGK_MSG_DELETEFILE_QUESTION, basename($file));
				$frm->Form->addInput("d","hidden",base64_encode(urlencode($d)));
			}
		}
		else if (is_dir($file))
		{
			if (igk_qr_confirm()){
				rmdir($file);
				$this->View();
			}
			else{
				$frm = igk_frame_add_confirm($this, "confirm_file_delete",$this->getUri("drop_dir_or_file"));
				$frm->Form->Content = R::ngets(IGK_MSG_DELETEDIR_QUESTION, basename($file));
				$frm->Form->addInput("d","hidden",base64_encode(urlencode($d)));
			}
		}
	}
	public function get_file($file = null)
	{
		if (!igk_is_conf_connected())
				return ;
		$d = urldecode(base64_decode(igk_getr("d")));

		$file = $file? $file: igk_io_currentRelativePath($this->m_directory ."/".$d);
		if (is_file($file))
		{
			$size = filesize($file);
			igk_download_content(basename($file), $size,  IGKIO::ReadAllText($file));
		}
	}
	public function edit()
	{
		if (!igk_is_conf_connected())
				return ;
		$d = urldecode(base64_decode(igk_getr("d")));
		$file = igk_io_currentRelativePath($this->m_directory ."/".$d);
		if (is_file($file))
		{
			$frame = igk_add_new_frame($this, "config-edit_file", "#filesystem",$this->App->Doc->body);
			$str = IGKIO::ReadAllText($file);
			$frame->Title = R::ngets("title.editFile_1", basename($file));
			$frame->ClearChilds();
			$d = $frame->BoxContent;
			$frame = $d->addForm();
			$frame["action"]=$this->getUri("updatefile#fileman");
			$ul = $frame->add("ul");
			$txt = $ul->addLi()->addTextArea("clContent", $str);
			$txt->setStyle("min-width:400px; min-height:260px");
			$frame->addInput("clfile", "hidden", base64_encode(urlencode(basename($file))));
			$frame->addHSep();
			$frame->addBtn("btn_update", R::ngets("btn.Update"));

		}
	}
	public function updatefile()
	{
		if (!igk_getconfigwebpagectrl()->IsConnected)
				return ;
		$d = urldecode(base64_decode(igk_getr("clfile")));
		$file = igk_io_currentRelativePath($this->m_directory ."/".$d);
		if (is_file($file))
		{
			igk_io_saveContentFromTextArea($file, igk_getr("clContent"), true);
			igk_frame_close("config_edit_file");
		}
		igk_navtocurrent();
	}
	public function opendir_ajx()
	{
		$d = (igk_getr("d"));
		if ($d)
		{
			if (($this->m_directory == null)||($this->m_directory=="/"))
				$this->m_directory = $d;
			else
				$this->m_directory .= "/".$d;
			$this->View();
		}

		igk_wl($this->TargetNode->innerHTML);
	}
	public function opendir()
	{
		$d = (igk_getr("d"));
		if ($d)
		{
			$ps = $this->m_directory ;
			if (($ps == null)||($ps =="/"))
				$ps  = $d;
			else
				$ps .= "/".$d;

			if (is_dir(igk_io_baseDir()."/".$ps))
				$this->m_directory  = $ps;
			$this->View();
			igk_navtocurrent();
		}
	}
	public function gotoparent()
	{
		$c = dirname($this->m_directory);

		if (!empty($c))
		{
				$this->m_directory = $c;
				$this->View();
		}
	}
	public function gotoparent_ajx()
	{
		$count = igk_getr("n", 1);
		$c = $this->m_directory;
		while($count>0){
			$c = dirname($c);
			$count--;
		}
		// igk_wln($this->m_directory);
		// igk_wln(dirname($this->m_directory));
		// igk_wln($c);
		// igk_exit();
		if (!empty($c))
		{
			if ($c===".")
				$this->m_directory = null;
			else
				$this->m_directory = $c;

		}
		$this->View();
		igk_wl($this->TargetNode->innerHTML);
	}
}



class IGKRefoutModel
{
	var $out;
	var $ctrl;
	var $clModel;
	var $clNextValue;
	var $clId;

	public function update($db){
		//create data and filter value
		$t = igk_db_createData($this, array("out"=>null,"ctrl"=>null));
		if ($this->clId)
		{
			$this->clNextValue ++;
			$db->update($this->ctrl->getDataTableName(), $t);
		}
		else {
			$o = $db->insert($this->ctrl->getDataTableName(), $t);
		}
	}
	public static function Init($tab){
		$c = new IGKRefoutModel();
		foreach($c as $k=>$v){
			$c->$k = igk_getv($tab, $k);
		}
		return $c;
	}
}


///<summary> used for referencing global value data</summary>
final class IGKReferenceModelCtrl extends IGKNonVisibleControllerBase{
	public function getName(){
		return IGK_CB_REF_CTRL;
	}
	public function getDataTableName(){
		return "tbigk_reference_models";
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){//
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>1, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clModel", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255, "clIsUnique"=>true, "clIsPrimary"=>true,"clNotNull"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clNextValue", IGK_FD_TYPE=>"Int", "clNotNull"=>true)),
		);
	}
	public function get_ref($ctrl, $model=null, $base=36, $ref=6){
		$obj = (object)array();
		$q = $this;
		$obj->update = function() use($q, $obj){
			$tb = $q->getDataTableName();
			$s = igk_db_create_row($tb, $obj);
			if($obj->newValue){
				igk_db_insert($q, $tb, $s);
			}else{
				igk_db_update($q, $tb, $s);
			}
		};
		$v_tmodel = $model==null? (method_exists($ctrl, "getRefModel")?  $ctrl->getRefModel():"MDL"): $model;
		$r = igk_db_table_select_where($this->getDataTableName(), array("clModel"=>$v_tmodel));
		$model = $r->RowCount == 0? 0 : $r->getRowAtIndex(0);
		$c = $model? $model->clNextValue : null;
		$c++;
		$out = $v_tmodel."".IGKNumber::ToBase($c, $base, $ref);
		igk_obj_append($obj, array(
			"out"=>$out,
			"newValue"=>$r->RowCount == 0,
			"ctrl"=>$ctrl,
			"clModel"=>$v_tmodel,
			"clNextValue"=>$c,
			"clId"=>$model? $model->clId : null));


		return $obj;
	}
	public function getnewproduct_ref($t, $productTypeTable, $prefix=null){
		$r = igk_db_table_select_where($productTypeTable, array("clId"=>$t->clProductType_Id));
		$row = $r->getRowAtIndex(0);
		if ($row == null){
			return null;
		}
		$n = igk_getv($row, IGK_FD_NAME);

		$v_tmodel = ($prefix? $prefix : $this->App->Configs->Prefix).$row->clPrefix;

		$r = igk_db_table_select_where($this->getDataTableName(), array("clModel"=>$v_tmodel));
		$model = $r->RowCount == 0? 0 : $r->getRowAtIndex(0);
		$c = $model? $model->clNextValue : null;
		$c++;
		$out = $v_tmodel."".IGKNumber::ToBase($c, 36, 6);
		return IGKRefoutModel::Init(array(
			"out"=>$out,
			"ctrl"=>$this,
			"clModel"=>$v_tmodel,
			"clNextValue"=>$c,
			"clId"=>$model? $model->clId : null));
	}
}


///<summary> used for referencing global user's value data</summary>
final class IGKUserReferenceModelCtrl extends IGKNonVisibleControllerBase{
	public function getName(){
		return IGK_UCB_REF_CTRL;
	}
	public function getDataTableName(){
		return "tbigk_users_reference_models";
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){//
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>1, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_USER_ID, IGK_FD_TYPE=>"Int", IGK_FD_TYPELEN=>11,
		"clLinkType"=>IGK_TB_USERS,
		"clNotNull"=>true,
		"clIsUniqueColumnMember"=>1
		)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clModel", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255, "clIsUniqueColumnMember"=>1, "clIsPrimary"=>true,"clNotNull"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clNextValue", IGK_FD_TYPE=>"Int", "clNotNull"=>true)),
		);
	}
	public function get_ref_nextnumber($uid, $model){

		$db = array(
			IGK_FD_USER_ID=>$uid,
			"clModel"=>$model
		);

		$r = igk_db_table_select_where(
		$this->DataTableName,
		$db, $this
		)->getRowAtIndex(0);
		if ($r){
			return max($r->clNextValue,1);
		}
		else {
			//insert new value
			$db["clNextValue"] = 2;
			igk_db_insert($this, $this->DataTableName, $db);
		}
		return 1;
	}
	public function update_ref_nextnumber($uid, $model){
		$tb = 	array(
			IGK_FD_USER_ID=>$uid,
			"clModel"=>$model);

		$r = igk_db_table_select_where($this->DataTableName, $tb
		)->getRowAtIndex(0);
		if ($r){
			$r->clNextValue++;
			igk_db_update($this, $this->DataTableName, $r);
		}
		else{
			$tb["clNextValue"] = 1;
			igk_db_insert($this, $this->DataTableName, $tb);
		}
		$this->setEnvParam("lastModel", $tb);
		return 1;
	}

	public function cancel_last_ref_number(){
		$m = $this->getEnvParam("lastModel");
		if ($m){
			$r = igk_db_table_select_where($this->DataTableName, $m
				)->getRowAtIndex(0);
			// igk_wln("canceling");
			// igk_wln($r);
			$r->clNextValue--;
			igk_db_update($this, $this->DataTableName, $r);
			$this->setEnvParam("lastModel", null);
		}
	}
	public function delete_key($key){
		return igk_db_delete($this, $this->DataTableName, array("clModel"=>$key));
	}
}

///<summary>used to store global configurations</summary>
final class IGKConfigurationCtrl extends IGKNonVisibleControllerBase{
	public function getName(){
		return IGK_BDCONFIGS_CTRL;
	}
	public function getDataTableName(){
		return IGK_TB_CONFIGS;
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){//
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>1, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>130, "clIsUnique"=>true, "clIsPrimary"=>true,"clNotNull"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clValue", IGK_FD_TYPE=>"Text")),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_DESC, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>150))
		);
	}
	public function getUseDataSchema(){

		return false;
	}
	public function getConfigv($n, $default=null, $comment=null, $init=0){	//.cnf ctrl
		$a = igk_get_data_adapter($this);

		if ($a->connect()){
			$tb = IGK_TB_CONFIGS;
			$v = $a->select($tb,  array(IGK_FD_NAME=>$n));
			$r = $v ? $v->getRowAtIndex(0) : null;
			if ($r){
				// igk_wln("load db data {$init} ?.");
				if ($init){
					$r->clValue = $default;
					$a->update($tb, $r , $r->clId);
					// igk_wln("update ....");
				}
				return $r->clValue;
			}
			$a->insert($tb, array(IGK_FD_NAME=>$n, "clValue"=>$default));
			$a->close();
		}
		return $default;
	}
	public function setConfigv($n, $value){
		$a = igk_get_data_adapter($this);
		if ($a->connect()){
			$tb = IGK_TB_CONFIGS;
			$v = $a->select($tb, array(IGK_FD_NAME=>$n));
			$r = $v ? $v->getRowAtIndex(0) : null;
			if ($r){
				$r->clValue = $value;
				$a->update($tb, $r, $r->clId);
			}else{
				$a->insert($tb, array(IGK_FD_NAME=>$n, "clValue"=>$default));
			}
			$a->close();
			return 1;
		}
		return 0;
	}
}


final class IGKSysDbController extends IGKNonVisibleControllerBase{
	private $m_userTypeInfo;
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getName(){
		return IGK_SYSDB_CTRL;
	}
	public function getDbConstantFile(){
		return igk_sys_db_constant_cache();
	}

	protected function initDb(){//.sys init data
		$this->initDbFromSchemas();
		$this->initDbConstantFiles();
	}
	public function resetDb(){
		//reset system data base
	}
	public function getUseDataSchema(){
		return true;
	}
	public function getInfoDataEntry($name, $cardinality=0, $type=1, $expression="(.)+"){
		if ($this->m_userTypeInfo == null)
			$this->m_userTypeInfo = array();
		return  isset($this->m_userTypeInfo[$name]) ? $this->m_userTypeInfo[$name] : array(IGK_FD_NAME=>$name,
	"clCardinality"=>$cardinality,
	"clType"=>$type,
	"clDataType"=>$expression
	);
	}
	private function RegValueTypeArray($name , $datatype=null, $cardinality=0, $nodb=0){
		$tab = array("clName"=>$name, "clDataType"=>$datatype, "clCardinality"=>$cardinality, "clType"=>$nodb);
		if ($this->m_userTypeInfo == null)
			$this->m_userTypeInfo = array();
		$this->m_userTypeInfo [$name] = $tab;
	}
	protected function InitComplete(){
		parent::InitComplete();
		//init value type array
		$this->RegValueTypeArray("USERTOKENID", null, 1, 1);
	}

}


///<summary>used to store balafon information</summary>
final class IGKInfosCtrl extends IGKNonVisibleControllerBase{

	public function getName(){
		return "c_info";
	}
	public function getDataTableName(){
		return "tbigk_infos";
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){//
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>1, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>60, "clIsUnique"=>true, "clIsPrimary"=>true,"clNotNull"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clValue", IGK_FD_TYPE=>"Text"))
		);
	}
	protected function initDataEntry($db, $tbname=null){
		$n = $this->getDataTableName();
		$db->insert($n, array(IGK_FD_NAME=>"Creator", "clValue"=>"C.A.D. BONDJE DOUE"));
		$db->insert($n, array(IGK_FD_NAME=>"COMPANY", "clValue"=>IGK_COMPANY));
		$db->insert($n, array(IGK_FD_NAME=>"RELEASE_DATE", "clValue"=>IGK_RELEASE_DATE));
		$db->insert($n, array(IGK_FD_NAME=>"Version", "clValue"=>IGK_VERSION));
		$db->insert($n, array(IGK_FD_NAME=>"CodeName", "clValue"=>IGK_CODE_NAME));
		$db->insert($n, array(IGK_FD_NAME=>"Domain", "clValue"=>IGK_DOMAIN));
		$db->insert($n, array(IGK_FD_NAME=>"LIBDIR", "clValue"=>IGK_LIB_DIR));
	}
}



///<summary>subdomain manager</summary>
class IGKSubDomainManager extends IGKObject{
	private $m_reglist; //array that will store subdomain manager list
	private static $sm_instance;
	private static $sm_isSubDomain;
	private static $sm_subDomainName;
	public static function IsControl($n , $ctrl){
		$t = self::getInstance()->m_reglist;
		return isset($t[$n]) && ($t[$n]===$ctrl);
	}
	public static function IsSubDomain(){
		return self::$sm_isSubDomain;
	}
	public static function GetSubDomainName(){
		return self::$sm_subDomainName;
	}
	public static function StoreBaseDomain($ctrl, $bDomain){
		igk_io_save_file_as_utf8_wbom(igk_io_baseDir()."/".IGK_DATA_FOLDER."/domain.conf", $bDomain, true);
	}
	public function Clear(){
		$this->m_reglist = array();
	}
	public static function GetSubDomain(){

		$srv = igk_getv($_SERVER, "SERVER_NAME");
		if (preg_match("/^(www\.)/i", $srv))
		{
			//remove www
			$srv = substr($srv,4);
		}
		if (!empty($srv)){
			//remove current domain
			$d = self::GetBaseDomain();
			if (preg_match("/(\.".$d."$)/i", $srv)){
				$srv = substr($srv,0, strlen($srv) -strlen($d)-1);
			}
			else
				$srv = "";
		}
		return $srv;
	}
	public static function GetBaseDomain(){
		$f = igk_io_baseDir()."/".IGK_DATA_FOLDER."/domain.conf";
		$d = "";
		if (file_exists($f)){
			$d = IGKIO::ReadAllText($f);
		}
		if (empty($d))
				$d = IGK_DOMAIN;
		return $d;
	}
	public static function AcceptDomain($domain, $servername){
		if (IGKValidator::IsIpAddress($domain)
			&&
			IGKValidator::IsIpAddress($servername)
			){
				return false;
				}

		$x1 = igk_io_path_ext($domain);
		$x2 = igk_io_path_ext($servername);

		if ($x1 == $x2)
		{//on the same extension
			// igk_wln("match path ext ".$x1);
			// igk_wln("match ".$x2);
			// return true;

			$x1 = igk_io_basenamewithoutext($domain);
			$x2 = igk_io_basenamewithoutext($servername);

			if (preg_match("/\.".$x1."$/i", $x2)){
				return true;
			}
		}
		return false;
	}
	///<summary>resole domain to match server name</summary>
	public static function Resolv($domain){
		$servername = igk_getv($_SERVER, "SERVER_NAME") ;
		$ex1 = igk_io_path_ext($domain);
		$ex2 = igk_io_path_ext($servername);

		if ($ex1 == $ex2)
			return $domain;
		$x1 = igk_io_basenamewithoutext($domain);
		$x2 = igk_io_basenamewithoutext($servername);

		if (preg_match("/\.".$x1."$/i", $x2))
			return $x1.".".$ex2;
		return $domain;
	}
	public static function Init()
	{
		self::$sm_isSubDomain = false;
		self::$sm_subDomainName = false;
		$srv = igk_sys_srv_domain_name();
		//get configuration domain
		$domain = self::GetBaseDomain();
		$rdomain = null;
		// igk_wln("init sub domain ...".$srv);
		// igk_log_write_i("initsubdomain", "domain= ". $domain. " : serveur : ".$srv." -- ruri ".igk_io_request_uri());
		//igk_exit();
		if (($srv!== "localhost" )&&
			!IGKValidator::IsIPAddress($srv)
			&& ($srv !== $domain)
			&& (preg_match("/(www)?\.".$domain."$/i", $srv)
				|| self::AcceptDomain($domain, $srv))
			)
		{

			//setting sub domain
			$rdomain = self::Resolv($domain);
			ini_set("session.cookie_domain", ".".$rdomain);
			//igk_wln("rdomain is ".$rdomain);// " ".$srv. " ? ".$domain. " :::: ".preg_match("/(www)?\.".$domain."$/i", $srv) . " - ".self::AcceptDomain($domain, $srv));
			// igk_wln("ip d: ". IGKValidator::IsIPAddress($srv));//"rdomain is ".$rdomain. " ".$srv. " ? ".$domain. " :::: ".preg_match("/(www)?\.".$domain."$/i", $srv) . " - ".self::AcceptDomain($domain, $srv));
			self::$sm_isSubDomain = true;
			self::$sm_subDomainName = self::GetSubDomain();

		}
		else{
			$rdomain = $srv;
			//important "." for authority domain
			if (IGKValidator::IsIPAddress($srv)){
				// echo 1;
				ini_set("session.cookie_domain", $srv);
			}
			else{
				//igk_wln("da e ".$srv);
				//if ($srv == "localhost")
				// ini_set("session.cookie_domain",// ($srv == "localhost") ? null :
				// ".".$srv);//".".$srv);
				//
				//chrome for localhost cookie name allow
				// ini_set("session.cookie_domain",null);//"localhost");
				// microsoft egde don't allow the setting of cookie domain to be localhost
				// chrome and firefox allow
				ini_set("session.cookie_domain", ($srv == "localhost") ? null : ".".$srv);//"localhost");


			}
		}
	}
	private function __construct(){
		$this->m_reglist = array();
		igk_notification_reg_event("sys://domain/changed", array($this,  "domainchanged"));
	}
	public function domainChanged(){
		//reset list
		$this->m_reglist = array();
	}
	public static function getInstance(){
		if (self::$sm_instance == null)
		{
			$key = igk_get_instance_key(__CLASS__);
			$k = igk_app()->Session->getParam($key);
			if(!$k){
				$k = new IGKSubDomainManager();
				igk_app()->Session->setParam($key,$k);
			}
			self::$sm_instance = $k;
		}
		return self::$sm_instance;
	}

	public function domainList(){
		return array_keys($this->m_reglist);
	}
	public function reg_domain($n, $ctrl){
		if (empty($n) || !igk_reflection_class_implement($ctrl, "IIGKUriActionRegistrableController") ){
			//igk_log_write_i("reg_domain", "registration failed. name is empty or ctrl doest not implement IIGKUriActionRegistrableController ");
			return false;
		}
		if (!isset($this->m_reglist[$n])){
			$this->m_reglist[$n] = $ctrl;
			return true;
		}
		//igk_log_write_i("reg_domain", "Domain Already Register:".$n);
		return false;
	}
	///<summary>get the domain controller or return false</summary>
	public function checkDomain($uri=null){
		if (igk_is_atomic()){
			
			return false;
		}
		//get subdomain name
		$subdomain= igk_io_subdomain_uri_name($uri);
		if(!empty($subdomain)){
			//$bdom = self::GetBaseDomain();
			$s = $subdomain;

			if (isset($this->m_reglist[$s]))
				return $this->m_reglist[$s];

			//create the subdomain controller for the first used
			$c = igk_getctrl(IGKSubDomainCtrl::class)->getDomainCtrl($s);

			if (($c!=null) ) {
				if(!$this->reg_domain($s, $c))
					igk_die("/!\\ Fatal can't register function");
				return $c;
			}
		
		}

		return false;	
	}

	
}


class IGKSubDomainCtrl extends IGKConfigCtrlBase{

	public function getConfigPage(){return "domain";}
	public function View(){
		if (!$this->IsVisible){
			igk_html_rm($this->TargetNode);
		}
		else {
			igk_html_add($this->TargetNode, $this->ConfigNode);
			igk_include_view($this, $this->TargetNode, "subdomain.config");
		}
	}
	protected function InitComplete(){
		parent::InitComplete();
		//in case framework is a part of a plugin do not initialize domain
		if (!defined('IGK_APP_PLUGIN'))
			$this->__init_domain();
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableName(){
		return IGK_TB_SUBDOMAIN;
	}
	public function getDataTableInfo(){
		return array(
			new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>1, "clIsPrimary"=>true)),
			new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>10,
				"clIsUnique"=>true, "clIsPrimary"=>true,"clNotNull"=>true,
				"clDescription"=>"Subdomain name. exemple. 'mail'  in the .domain.com will be mail.domain.dom")),
			new IGKdbColumnInfo(array(IGK_FD_NAME=>"clCtrl", IGK_FD_TYPE=>"VARCHAR",IGK_FD_TYPELEN=>33,
				"clNotNull"=>true,
				"clDescription"=>"Controller name")),
			);
	}

	///get the controller that contain domain from setting. for the first usage
	public function getDomainCtrl($n){
		$g = igk_db_select_wherec($this, array("clName"=>$n));
		if ($g &&  ($g->RowCount == 1)){
			$c = igk_template_create_ctrl($g->getRowAtIndex(0)->clCtrl);
			return $c;
		}
		return null;
	}
	private function __init_domain(){
		if (igk_is_cmd() || defined('IGK_FRAMEWORK_ATOMIC') ||
		!igk_db_table_exists($this))
			return;

		// if (!igk_db_table_exists($this)){//important to test for db system file
			// return;
		// }
		
		$r = igk_db_select_all($this);
		if (($r!=null) && $r->Success)
		{
			//reg data base domain

			foreach($r->Rows as $k=>$v){
				$n =  igk_getctrl($v->clCtrl);
				if ($n!=null){
					igk_reg_subdomain($v->clName, $n);
				}else{
					igk_ilog_assert(!igk_sys_env_production(),
					"failed to register domain ".$v->clName. " . Controller Not found");
				}
			}
		}

	}
	public function dom_drop_domain_ajx(){
		if (igk_qr_confirm()){
			if (igk_db_delete($this, $this->DataTableName, array("clId"=>igk_getr("i"))))
			{
				igk_notifyctrl()->addSuccessr("msg.item.deleted");
				igk_notification_push_event("sys://domain/changed", $this);
				$this->__init_domain();
			}
			else
				igk_notifyctrl()->addErrorr("e.item.notdeleted");
			$this->View();
			igk_navtocurrent();
		}
		else {
			$frame = igk_frame_add_confirm($this, __FUNCTION__, $this->getUri(__FUNCTION__));
			$frame->Form->Div->Content = R::ngets("confirm.delete");
			$frame->Form->addHidden("i", igk_getr("i"));
			$frame->RenderAJX();
		}
	}
	public function dom_edit_domain_ajx(){
		if (igk_qr_confirm()){
			$obj = igk_get_robj();

			if (igk_db_update(
				$this,
				$this->getDataTableName(),
				$obj
				)){
				igk_notifyctrl("domain/dbz")->addSuccessr("mgs.dataupdated");
				igk_notification_push_event("sys://domain/changed", $this);
				$this->__init_domain();

			}
			else {
				igk_notifyctrl("domain/dbz")->addErrorr("err.error_append_1", igk_debuggerview()->getMessage());
			}
			igk_ajx_replace_ctrl_view($this);
			igk_ajx_close_dialog();
		}
		else{

		$data = igk_db_table_select_where($this->getDataTableName(), array("clId"=>igk_getr('i')), $this)->getRowAtIndex(0);
		if ($data == null){
			return;
		}
		$dv = igk_createNode();
		$frm = $dv->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$frm["igk-ajx-form"] = 1;
		igk_include_view($this, $frm, "subdomain.edit.form",true, array("data"=>$data));
		//
		$frm->addConfirm(1);
		igk_ajx_notify_dialog(	R::gets("title.editDomain"),
			$dv,
			"default domain-conf-z"
			);
		}
		igk_flush_data();
	}
	public function dom_drop_db_s_domain_ajx(){
		if (igk_qr_confirm()){
			$items = $this->getParam("domain/deleteitems");

			if ($items){
				$ad = igk_get_data_adapter($this);
				$ok = true;
				if ($ad->connect()){
				foreach($items as $k=>$v){
					$ok = $ok & igk_db_delete($this, $this->DataTableName, array("clId"=>$v));
				}				$ad->close();
				}
				if ($ok){
					igk_notifyctrl()->addSuccessr("msg.items.deleted");
					igk_notification_push_event("sys://domain/changed", $this);
				}
				else
					igk_notifyctrl()->addErrorr("e.items.notdeleted");
				$this->View();
			}
			$this->setParam("domain/deleteitems", null);
			igk_navtocurrent();
		}
		else {
			$ti = igk_getr("item");
			if ($ti && (igk_count($ti )> 0))
			{
			$frame = igk_frame_add_confirm($this, __FUNCTION__, $this->getUri(__FUNCTION__));
			$frame->Form->Div->Content = R::ngets("confirm.deletes");
			$this->setParam("domain/deleteitems",$ti);
			$frame->Form->addHidden("i", igk_getr("i"));
			$frame->RenderAJX();
			}
		}
	}
	public function dom_add_db_domain_ajx(){

		if (igk_qr_confirm()){
			$obj = igk_get_robj();
			if (($r = igk_db_insert_if_not_exists(
				$this,
				$this->getDataTableName(),
				$obj
				))>0){
				igk_notifyctrl(__FUNCTION__)->addSuccessr("mgs.dataupdated");
				$this->__init_domain();
			}
			else {
				igk_notifyctrl(__FUNCTION__)->addErrorr("err.error_append_1", igk_debuggerview()->getMessage(). " code:".$r);
			}
			igk_ajx_replace_ctrl_view($this);
			igk_resetr();
		}

		$dv = igk_createNode();
		$frm = $dv->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$frm["igk-ajx-form"] = 1;

		igk_include_view($this, $frm, "subdomain.add.form", false, array("func"=>__FUNCTION__));
		$frm->addConfirm(1);

		igk_ajx_notify_dialog(
			R::gets("title.addDomain"),
			$dv,
			"default domain-conf-z"
			);
	}
	public function dom_add_db_edit_domain_ajx(){
		if (igk_qr_confirm()){
			$obj = igk_get_robj();
			if (!empty($obj->clName) && igk_is_domain_name($obj->clName)){
				$this->App->Configs->website_domain = $obj->clName;
				$this->App->Session->Domain = $obj->clName;
				IGKSubDomainManager::StoreBaseDomain($this, $obj->clName);

			}


			//$this->View();
			//$this->TargetNode->RenderAJX();
			igk_ajx_replace_ctrl_view($this);
			igk_ajx_notify_close_dialog();
			igk_flush_data();
			// igk_post_uri(igk_io_currentUri());
			igk_exit();
		}
		$dv = igk_createNode();
		$frm = $dv->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$frm["igk-ajx-form"] = 1;
		igk_include_view($this, $frm, "subdomain.editbasedomain.form");
		$frm->addConfirm(1);
		igk_ajx_notify_dialog(R::gets("title.addEditDomain"),
			$dv,
			"default domain-conf-z"
			);
	}
}



///--------------------------------------------------------------------------------------------------------
///IGKJSPostFrameCmd
///--------------------------------------------------------------------------------------------------------
class IGKJSPostFrameCmd extends IGKObject
implements  IIGKHtmlGetValue
{
	private $m_obj;
	private $m_t;
	private $m_global;
	public function __construct($obj, $t, $global=false){
		if(($obj == null) || !igk_reflection_class_implement($obj, 'IIGKHtmlGetValue'))
			igk_die("PostFrameCommand");
		$this->m_obj= $obj;
		$this->m_t = $t;
		$this->m_global = $global;
	}
	public function getValue($options=null){
		$s = $this->m_obj->getValue($options);
		if (preg_match("/^javascript:/",$s))
		{
			return $s;
		}
		return igk_js_post_frame($s, $this->m_t,$this->m_global);
	}
}


///--------------------------------------------------------------------------------------------------------
///XML and HTML IGK Items
///--------------------------------------------------------------------------------------------------------

final class IGKHtmlNotificationItemNode extends IGKHtmlItem
{
	private $m_owner;
	private $m_script;
	private $m_autohided;

	public function getAutoHided(){
		return $this->m_autohided;
	}
	public function setAutohide($v){
		$this->m_autohided =$v;
	}
	public function __construct($owner){
		parent::__construct("div");
		$this->m_autohided = true;
		$this->m_script =  igk_createNode("script");
		$this->m_script->Content = "\$ns_igk.winui.notifyctrl.init(\$ns_igk.getParentScript());";
		$this->m_owner = $owner;
		$this["class"]="igk-notify-ctrl";
		$this["igk-control-type"] = "notifyctrl";
	}

	protected function __AcceptRender($o=null){
		if (!$this->IsVisible || !$this->HasChilds)
			return false;
		if ($this->m_autohided)
		{
			igk_html_add($this->m_script, $this);
		}
		return true;
	}
	public function RenderComplete($o=null){
		$this->ClearChilds();
		if ($this->m_owner->TargetNode === $this){
			$this->m_owner->setNotifyHost(null);
		}
	}
	function addMsg($msg, $type='default'){
		$this->add("div", array("class"=>"igk-notify igk-notify-{$type}"))->Content = $msg;
	}
	function addMsgr($key){
		$this->addMsg(R::ngets($key,array_slice(func_get_args(), 1)));
	}
	function addSuccess($msg){
		$this->add("div", array("class"=>"igk-notify igk-notify-success"))->Content = $msg;
	}
	function addSuccessr($key){
		$this->addSuccess(R::ngets($key,array_slice(func_get_args(), 1)));
	}
	function addError($msg){
		$this->add("div", array("class"=>"igk-notify igk-notify-danger"))->Content = $msg;
	}
	function addErrorr($key){
		$this->addError(R::ngets($key,array_slice(func_get_args(), 1)));
	}
	function addWarning($msg){
		$this->add("div", array("class"=>"igk-notify igk-notify-warning"))->Content = $msg;
	}
	function addWarningr($key){
		$this->addWarning(R::ngets($key,array_slice(func_get_args(), 1)));
	}
	function addInfo($msg){
		$this->add("div", array("class"=>"igk-notify igk-notify-info"))->Content = $msg;
	}
	function addInfor($key){
		$this->addInfo(R::ngets($key,array_slice(func_get_args(), 1)));
	}
}



///<summary>Notification controller. used to inform user of some modification</summary>
///<note>according to the notification type message targetnode expose class
///igk-notify_w for warning
///igk-notify-success for good message
///igk-notify_i for information
///igk-notify-danger for bad message
///</note>
final class IGKNotificationCtrl extends IGKControllerBase
implements IIGKNotifyMessage, ArrayAccess
{
	private $m_notifyevents;
	private $m_notifyhost; //defaut primary host
	private $m_notificationChilds; //array of notification object
	private $m_marks;

	//ARRAY ACCESS For WRITING PURPOSE
	public function offsetSet($i, $v){
		$this->addMsg($v);
	}
	public function offsetGet($i){
	}
	public function offsetUnset($i){
	}
	public function offsetExists($i){
		return false;
	}
	//END. ARRAY ACCESS

	public function getMsError(){return $this->m_hasmsg; }
	public function setMsError($v){ $this->m_hasmsg = $v; }
	public function getName(){return IGK_NOTIFICATION_CTRL;}
	public function getHasMsg(){
		return $this->TargetNode->HasChilds;
	}

	public function mark($tagid){
		if ($this->m_marks == null)
			$this->m_marks = array();
		$this->m_marks[$tagid ] = 1;
	}
	///<summary>get auto hided</summary>
	public function getAutoHided(){
		return $this->TargetNode->getAutoHided();
	}
	///<summary>get notification item</summary>
	public function getNotification($name, $reg=false){
		if ($this->m_notificationChilds == null)
			$this->m_notificationChilds = array();

		if (empty($name))
			return null;

		if (isset($this->m_notificationChilds[$name]))
			return $this->m_notificationChilds[$name];
		if ($reg)
		{
			$i = new IGKHtmlNotificationItemNode($this);
			$this->m_notificationChilds[$name]  = $i;
			return $i;
		}
		return null;
	}
	///<summary>free notification item</summary>
	public function unsetNotication($name){
		if (isset($this->m_notificationChilds[$name]))
		{
			unset($this->m_notificationChilds[$name]);
		}
	}

	public function setNotifyHost($notifyhost, $name=null, $options=null)
	{
		if ($name==null)
			$this->m_notifyhost = $notifyhost;	//set global notify host
		if ($notifyhost)
		{
			$n = $this->getNotification($name);
			if (($n == null) && ($name == null)){
				$s = new IGKHtmlSingleNodeViewer( $this->TargetNode);
				igk_html_add($s, $notifyhost);
			}
			else{
				if ($n !=null){
					$s = new IGKHtmlSingleNodeViewer( $n);
					igk_html_add($s, $notifyhost);
				}
			}
			$tab = array($this, "NotificationIsVisible",  $notifyhost, $name);
			$notifyhost->setCallback("getIsVisible", $tab);
		}
	}
	public function NotificationIsVisible($n, $name){

		if (empty($name))
		{
			$g = igk_notifyctrl()->TargetNode->ChildCount>0;
			//igk_wln($n === igk_notifyctrl()->TargetNode);
			if ($g ){
				$s = new IGKHtmlSingleNodeViewer( $this->TargetNode);
				igk_html_add($s, $n);
			}
			return $g;
		}
		// if (igk_get_env("sys://html/cnode") == $n)
			// return false;

		// igk_set_env("sys://html/cnode", $n);

		// $i = igk_get_env("notenv", 1);
		// igk_wln("not fil is visible ".$n . " " .$name . " ".$n->getHasChilds());
		// igk_wln("chain . ".igk_html_render_all($n));
		//igk_wln($n->Render());
		// if($i == 2){
			//igk_die("d");
		// }
		// $i++;
		// igk_set_env("notenv", $i);
		return ($n!=null) && $n->getHasChilds();
	}
	public function getNotifyHost(){
		if ($this->m_notifyhost == null)
			$this->m_notifyhost = $this->app->Doc->body;
		return $this->m_notifyhost;
	}

	protected function InitComplete(){//notify host init complete
		parent::InitComplete();
	}
	protected function initTargetNode(){
		$v =  new IGKHtmlNotificationItemNode($this);
		return $v;
	}

	public function addError($msg){
		$this->TargetNode->add("div", array("class"=>"igk-notify igk-notify-danger"))->Content = $msg;
	}
	function addSuccess($msg){
		$this->TargetNode->addSuccess($msg);
	}
	function addSuccessr($key){
		$this->TargetNode->addSuccessr($key);
	}
	public function addErrorr($key)
	{
		$this->addError(R::ngets($key, array_slice(func_get_args(), 1)));
	}
	public function addWarningr($msg){
		$this->addWarning(R::ngets($msg, array_slice(func_get_args(), 1)));
	}
	public function addWarning($msg){
		$this->setParam("ajx:renderincontext", null);
		$this->TargetNode->add("div", array("class"=>"igk-notify igk-notif-warning alert-warning"))->Content = $msg;
		$this->m_hasmsg = true;
	}
	public function addInfor($msgKeys){//add info with message key
		$this->addInfo(R::ngets($msgKeys, array_slice(func_get_args(), 1)));
	}
	public function addInfo($msg){
		$this->TargetNode->add("div", array("class"=>"igk-notify igk-notify-info"))->Content = $msg;
		$this->m_hasmsg = true;
	}
	public function addErrori($msgcode)
	{
		$c = igk_error($msgcode);
		if ($c){
			$li =  igk_createNode("div",array("class"=>"alignl"));
			$li->addLabel()->Content = "Message : ";
			$li->addspan()->Content = R::ngets($c["Msg"]);
			$this->addError($li->Render(null));
		}
	}

	public function setAutohide($v){
		$this->TargetNode->setAutohide($v);
	}

	public function addMsgr($msg)
	{
		$this->addMsg(R::ngets($msg, array_slice(func_get_args(), 1)));
	}
	public function addMsg($msg)
	{
		$this->TargetNode->add("div", array("class"=>"igk-notify igk-notify-success"))->Content = $msg;
	}
	public function notify_ajx(){
		$view = igk_getr("rv");
		$render =false;
		//$this->setParam("ajx:renderincontext", null);
		if (igk_is_ajx_demand())
		{
		if ($this->HasMsg)
		{
			//igk_wln("$view : view" .$this->getParam("ajx:renderincontext"));
			if ($this->getParam("ajx:renderincontext") !== true)
			{
			$this->setParam("ajx:renderincontext", true);
			$d = igk_createNode("div")->addScript();
			$uri = $this->getUri("notify_ajx&rv=1");

			$d->Content =<<<EOF
(function(){ ns_igk.ajx.post('${uri}',null, ns_igk.ajx.fn.prepend_to_body); })();
EOF;
			$d->RenderAJX();
			}
			else if ($view) {
				$render = true;
			}
		}
		}
		else{
			$render = $this->HasMsg;
		}
		if ($render)
		{
			$this->TargetNode->RenderAJX();
			$this->m_hasmsg = false;
			$this->setParam("ajx:context", null);
			$this->setParam("ajx:renderincontext", null);
		}
	}
	public function pageFolderChanged($sender=null, $args=null)
	{
		if ($this->HasMsg){
			$this->TargetNode->ClearChilds();
			$this->View();
		}
	}
	///<summary>Render notification controller</summary>
	public function View(){
		if (!$this->HasMsg)
		{
			igk_html_rm($this->TargetNode);
		}
		else{
			$this->TargetNode->setIndex(-10000);
			$host = $this->NotifyHost;
			if ($host!==null){
				igk_html_add($this->TargetNode, $host);
			}
		}
	}

	public function __construct(){
		parent::__construct();
		$this->m_notifyevents = array();
	}
	public function getNotificationEvent($name){
		return igk_getv($this->m_notifyevents, $name);
	}
	public function registerNotification($name, $callable  //$obj, $method
	){
		if (isset($this->m_notifyevents[$name])){
			$e = $this->m_notifyevents[$name];
		}
		else {
			$e = new IGKEvents($this, "NotificationEvents::".$name);
			 $this->m_notifyevents[$name] = $e;
		}
		//$e->add($obj, $method);
		return $e->add($callable);
	}
	public function resetNotification($name){
		unset($this->m_notifyevents[$name]);
	}
	///<summary>unregister notification</summary>
	///<remark>if obj is null will clear the notification event list</remark>
	public function unregisterNotification($name, $obj=null, $method=null){
		if(($obj== null) && ($method==null))
		{
			unset($this->m_notifyevents[$name]);
			return 1;
		}
		else {
			$e = igk_getv($this->m_notifyevents, $name);
			if ($e){
				if ($name == IGK_GLOBAL_EVENT && is_object($obj)){
					return $e->removeObject($obj);
				}
				return $e->remove($obj, $method);
			}
		}
		return 0;
	}
}




final class IGKConfigData
{
	private $m_configCtrl;
	private $m_configEntries;
	private $m_confile;

	public function __toString(){
	return "IGKConfigurationData [Count: ".count($this->m_configEntries)."]";
	}
	public function SortByKeys()
	{
		$keys = array_keys($this->m_configEntries);
		sort($keys);
		$t = array();
		foreach($keys as $k)
		{
			$t[$k] = $this->m_configEntries[$k];
		}
		$this->m_configEntries = $t;

	}

	/// full path to
	/// conffile : configuration file
	/// configctrl : hosted controller
	/// entries: default entry
	public function __construct($conffile , $configCtrl, $entries){
		$this->m_confile = $conffile;
		$this->m_configCtrl = $configCtrl;
		$this->m_configEntries = $entries;

	}
	public function __get($key){
		if (isset($this->m_configEntries[$key]))
			return $this->m_configEntries[$key];
		return null;
	}
	public function __set($key, $value){

		if (isset($this->m_configEntries[$key]))

		{
			if ($value == null)
			{
				unset($this->m_configEntries[$key]);
			}
			else{
				$this->m_configEntries[$key] = $value;
			}
		}
		else if (is_string($value) && !empty($value))
		{
			$this->m_configEntries[$key] = $value;
		}
	}
	//
	public function saveData(){
		if (defined("IGK_FRAMEWORK_ATOMIC"))
			return;

		$file = $this->m_confile;
		$out = IGK_STR_EMPTY;
		$v_ln = false;
		foreach($this->m_configEntries as $k=>$v)
		{
			if ($v_ln)
			{
				$out .= IGK_LF;
			}
			else {
					$v_ln  = true;
			}
			$out .= IGKCSVDataAdapter::GetValue($k).igk_csv_sep().IGKCSVDataAdapter::GetValue($v);
		}
		return igk_io_save_file_as_utf8_wbom($file, $out, true);
	}

		public function getEntriesKeys()
		{
			return array_keys($this->m_configEntries);
		}
		public function getEntries(){
			return $this->m_configEntries;
		}

		public function setConfig($name, $value)
		{
			if ($name)
				$this->m_configEntries[$name] = $value;
		}
		public function getConfig($name, $default=null)
		{
			return igk_getv($this->m_configEntries, $name, $default);
		}
}


final class IGKAppConfig extends IGKObject
{
	private $m_configEntries;
	private $m_datas;
	private $m_oldState;
	private static $sm_instance;
	private $m_configSavedEvent;

	const CHANGE_REG_KEY = "IGKConfigDataChanged";


	//get config entries
	public function getConfigEntries(){ return $this->m_configEntries;	}

	public function getData(){
		return $this->m_datas;
	}
	private function __construct()
	{
		//LoadConfiguration setting
		$this->_loadSystemConfig();
		$this->m_configSavedEvent = new IGKEvents($this, "ConfigSavedEvent");

	}
	public function addConfigSavedEvent($obj, $arg){
		if ($this->m_configSavedEvent)
		{
			$this->m_configSavedEvent->add($obj, $arg);
		}
	}
	public function removeConfigSavedEvent($obj, $arg){
		if ($this->m_configSavedEvent)
		{
			$this->m_configSavedEvent->remove($obj, $arg);
		}
	}
	public function onConfigSaved(){
		if ($this->m_configSavedEvent)
		{
			$this->m_configSavedEvent->Call($this, null );
		}
	}

	public function checkConfigDataChanged($ctrl)
	{
		$v = $ctrl->isChanged(IGKAppConfig::CHANGE_REG_KEY, $this->m_oldState);
		if ($v){
			$this->_loadSystemConfig();
			return true;
		}
		return false;
	}
	public static function getInstance(){// return get igk IGKAppConfig instance
		if (self::$sm_instance == null)
		{
			self::$sm_instance = //igk_get_class_instance(__CLASS__, function(){
				//return
				new IGKAppConfig();
			//});

		}
		return self::$sm_instance;
	}
	//load configuration files configs.csv
	private function _loadSystemConfig()
	{
		$file =IGK_CONF_DATA;
		$this->m_configEntries = array();
		$fullpath =igk_io_syspath($file);

		$f = IGKCSVDataAdapter::LoadData($fullpath);
		if ($f !== null)
		{
			foreach($f as $k=>$v)
			{
				$this->m_configEntries[$v[0]] = trim(igk_getv($v, 1));
			}
		}
		$this->m_datas = new IGKConfigData($fullpath, $this, $this->m_configEntries);

	}

	public function saveConfig(){//save the app configuration file
		if ($this->m_datas==null)
			return;
		$this->m_datas->SortByKeys();
		if ($this->m_datas->saveData())
		{
			$this->_updateCache();
			igk_sys_regchange(self::CHANGE_REG_KEY, $this->m_oldState);
			$this->onConfigSaved();
		}
	}
	private function _updateCache(){

		$f = igk_io_baseDir(IGK_CACHE_DATAFILE);
		if ($this->Data->cache_loaded_file)
		{
			igk_io_save_file_as_utf8($f,IGK_STR_EMPTY, true);
			//force cache of the files
			IGKApp::CacheLibFiles(true);
			igk_notifyctrl()->addMsgr("msg.cachefilestored");
		}
		else {
			if (file_exists($f))
			{
			    $c = unlink($f);
				$t = unlink(igk_io_baseDir(IGK_FILE_LIB_CACHE));
				igk_notifyctrl()->addMsg(R::ngets("msg.cachefileunlink_1", basename($f)));
			}
		}
	}
}



///<summary>used to manage config manager</summary>
final class IGKConfigCtrl extends IGKControllerBase
implements IIGKConfigController
{
	private $m_configuration;
	private $m_ConfigUser;
	// private $m_configEntries;
	private $m_ConfigNode;
	private $m_configMenuNode;	
	private $m_connectBtn;
	private $m_selectedconfigCtrl;
	// private $m_datas; //used to store datas
	private $m_menuName;
	//private $m_headerNode;	//header node
	//private $m_connexionFrame; //connexion frame
	private $m_configFrame;//frame for config
	private $m_oldState;//previous state
	private $m_confctrls; //store config ctrl
	private $m_currentView; //config current view


	const CONNEXION_FRAME=0xc1;

	//---------------------------------------------------------------------------
	//events
	//---------------------------------------------------------------------------
	private $m_ConfigUserChangedEvent; //user changed
	private $m_configSettingChangedEvent;  // setting changed

	public function getName(){return IGK_CONF_CTRL; }
	public function getConfigEntries(){
		return $this->getParam("configentries");//$this->m_configEntries;
	}


	public function  getConfigNode(){return $this->m_ConfigNode; }

	public function getConfigMenuNode(){return $this->m_configMenuNode;}
	public function getSelectedConfigCtrl(){return $this->m_selectedconfigCtrl;}
	public function getSelectedMenuName() { return $this->m_menuName; }
	public function getData(){ return igk_app()->Configs; // $this->m_datas;
	}
	//get a administrative user
	public function getConfigUser(){ return $this->m_ConfigUser;}
	public function getRegisterToViewMecanism(){return true;}
	//cause of private must be call explicitly
	private function setConfigUser($v){
		if ($v !== $this->m_ConfigUser){
			$this->m_ConfigUser = $v;
			$this->onConfigUserChanged();
		}
	}
	public function getDbConstantFile(){
		return igk_sys_db_constant_cache();
	}
	public function initDb(){
		//do nothing
	}
	//get a administrative user is connected
	public function getIsConnected(){
		return defined('IGK_CONF_CONNECT') || ($this->ConfigUser != null );
	}
	//get is connected and in config page
	public function getIsConfiguring()
	{
		return ($this->getIsConnected())&&($this->App->CurrentPageFolder == IGK_CONFIG_MODE);
	}
	public function getCanConfigure()
	{
		return ($this->getIsConnected());
	}
	public function showConfig(){//config controller showConfig
		$this->View();		
	}
	public function getConfigPage(){return "configs";}

	public function getReconnectionUri()
	{
		$uri = igk_io_baseUri();
		if ($this->ConfigUser){
		$q = array(
			"u"=>$this->ConfigUser->clLogin,
			"pwd"=>$this->ConfigUser->clPwd,
			"selectedCtrl"=>$this->SelectedConfigCtrl? $this->SelectedConfigCtrl->Name:null,
			"selectPage"=>$this->SelectedMenuName,
			"baseUri"=>igk_getv(explode('?', igk_io_baseRequestUri()), 0)
			);
		$uri = $this->getUri("startconfig&q=".base64_encode(
		'?'.http_build_query($q)));
		}
		return $uri;
	}

	public function ClearSessionAndReconnect($navigate=true){
		if ($this->IsConnected){
			$uri = $this->getReconnectionUri();
			igk_getctrl(IGK_SESSION_CTRL)->ClearS(false);
			igk_navto($uri);
			igk_exit();
		}
		igk_navtocurrent();
		igk_exit();
	}
	public function back(){
		$rf = $this->getParam("referer");
		if ($rf){
			$this->setParam("referer", null);
			igk_navto($rf);
		}else
			igk_navto_home(null);
		igk_exit();
	}
	///<summary></summary>
	public function configure_settings(){
		if (!igk_is_conf_connected()){
			igk_navto($this->getAppUri());
			igk_exit();
		}
		igk_header_no_cache();
		igk_set_env("sys://designMode/off", 1);
		$doc = igk_get_document($this,0);
		// igk_wln("?".($doc === igk_app()->Doc));
		// igk_wln("Name ? ".($doc->Name));
		//e_xit;

		$doc->Favicon = new IGKHtmlRelativeUriValueAttribute("Lib/igk/Default/R/Img/cfavicon.ico");
		$doc->Theme->addTemporaryFile($this->getStylesDir()."/conf.setting.pcss");
		$doc->Theme->addFont("global", igk_io_basePath( IGK_LIB_DIR."/Default/R/Fonts/global.ttf"));




		$doc->Title = "Configs!settings - [".igk_sys_getconfig("website_title")."]";
		$doc->body->setClass("+conf-setting");
		//$doc->body->clearChilds();
		//$doc->body->setStyle("padding-bottom:1.2em");
		$doc->head->addCssStyle("base",0)->setAttribute("type","text/css")->Content = <<<EOF
@bg_color:transparent;
body.igk-body{
	background-color:@bg_color;
}
EOF;


		$bbox = $doc->body->addBodyBox()->clearChilds();
		$bbox->setClass("overflow-y-a fith");
		$hd = $bbox->addDiv()->setClass("header");
		// $ref = $this->getParam("referer") ?? igk_sys_referer() ?? igk_io_baseURi();
		 // $this->setParam("referer", $ref) ;

$ref = $this->getParam("referer", function(){
	return igk_sys_srv_referer() ?? igk_io_baseURi();
}, 1);
		$hd->addA($this->getUri("back"))->addFontSymbol("global",0xF001);//->Content= "Back";
		$hd->addSectionTitle(4)->Content = R::ngets("title.balafonconfsettings");
		$h = $bbox->addDiv();

		$f = $h->addForm();
		$f["style"]="padding:4px;";
		$f["action"] = $this->getUri("configure_search_ajx");
		// $f ["igk-ajx-form"]=1;
		// $f ["igk-ajx-form-target"]="#vr";
		$f["onsubmit"]="return false;";

		$r = $f->addDiv();
		$r->addLabel("Find")->setClass("dispib floatl");//R::ngets("lb.Find")
		$r->addInput("clsearch", "text")->setClass("dispi floatl")->setAttribute("onkeyup", "javascript: ns_igk.ajx.fn.postData(this.form.action, this, '#vr'); return ;");
		$r->addClearTab();
		$r->addInput("btn.search", "submit")->setClass("dispn");

		$h = $bbox->addDiv()->setId("vr")->setClass("overflow-y-a loc_l loc_b loc_r");

		$this->configure_settings_load_data($h );

		// $p .="? >";

		// igk_io_save_file_as_utf8_wbom(IGK_LIB_DIR."/.setting.global.pinc", $p);

		$bbox->addDiv()->addIGKCopyright();

		$doc->RenderAJX();
		igk_exit();
	}
	public function configure_store_ajx(){
		if (!igk_is_conf_connected()){
			return;
		}
		$n = igk_getr("clName");
		igk_app()->Configs->$n = igk_getr("clValue");
		igk_app()->Configs->saveData();

	}
	public function configure_search_ajx(){
		//igk_wln($_REQUEST);
		$s = igk_getr("clsearch");
		$n = igk_html_node_noTagNode();
		if (!empty($s)){
			$s = "/(".$s.")/i";
		}else{
			$s = "/(.)+/i";
		}
		$this->configure_settings_load_data($n, $s);
		$n->RenderAJX();
	}
	private function configure_settings_load_data($h, $rg='/(.)*/'){

		$tab = $h->addTable()->setClass("fitw")->setStyle("font-size:0.86em");

		$t = igk_app()->getConfigs()->getEntries();
		$t = igk_get_env(IGK_ENV_GLOBAL_SETTING);
	//	$bbox->addDiv()->Content = $t;
		// igk_wln($t);
		//e_xit;
			$r = $tab->add("thead")->setClass("igk-fixed-header")->addTr();
			$r->addTH()->Content = R::ngets("lb.name");
			$r->addTH()->Content = R::ngets("lb.type");
			$r->addTH()->Content = R::ngets("lb.status");
			$r->addTH()->Content = R::ngets("lb.value");
			$r->addTH()->Content = R::ngets("lb.desc");
		$ti = array("admin_pwd"=>1);
		$p = "";
		//$p .="<?php".IGK_LF;
		$gf = igk_app()->Configs;
		if ($t){
			$m = array_keys($t);
			sort($m);
			$st = $tab->add("tbody");
			foreach($m as $vk=>$k){
				$s = $t[$k];
				if (isset($ti[$k]) || !preg_match($rg, $k))continue;
				$cnf = igk_getv($gf, $k);
				$r = $st->addTr();
				$r->addTd()->Content = $k;
				$r->addTd()->Content = 'string';
				$r->addTd()->Content = $s->clData == $cnf;
				$td = $r->addTd();
				$td->Content = $cnf;
				$td->setClass("e");

				$r->addTd()->Content = $s->clDesc;


				//$p .= "igk_reg_global_setting('$k', '$s');".IGK_LF;
			}
		}

			$uri = $this->getUri("configure_store_ajx");
				// $td->setAttribute("ondblclick", <<<EOF
// (function(q){
// var s = q.innerHTML;
// var i = q.parentNode.childNodes[0].innerHTML;
// \$igk(q).setHtml(
// '<form action=\'{$uri}\' onsubmit=\'ns_igk.ajx.fn.post(this.uri, "clName="+this["clName"]+'&clValue='+this["clValue"]+');\'><input id=\'clName\' type=\'hidden\' value=\''+i+'\' />'
// +'<input id=\'clValue\' value=\''+s+'\' /><form>'); })(this);return false;
// EOF
// );

		$tab->addScript()->Content =<<<EOF
			var q = \$igk(igk.getParentScriptByTagName('table'));

igk.ready(function(){
	var e_=null;
	var u_='{$uri}';

	function _start(){
		if (e_==null){

		}
	}

	q.select('.e').each(function(){
		// console.debug('reg event');
		this.reg_event("dblclick", function(){
			 //console.debug("on dbl click");
			 if (e_!=null){
				 if (e_.t==this)
					 return;
				 //restore to default
				 \$igk(e_.t).setHtml(e_.c);
				 e_ = null;
			 }
			 var s = this.innerHTML;
			 var i = this.parentNode.childNodes[0].innerHTML;
			 e_ = {
				 c:s,
				 t:this
			 };
			 var n = ns_igk.createNode('form');
			 n.o["action"] = u_;
			 n.add('input').setAttributes({
				 'id':'clName',
				 'type':'hidden',
				 'value':i
			 });
			 var v_s = n.add('input').setAttributes({
				 'id':'clValue',
				 'class':'cltext igk-form-control',
				 'value':s
			 }).reg_event("keypress", function(evt){
				// console.debug(evt.keyCode);
				switch (evt.keyCode){
					case 13:
					 evt.preventDefault();
					 var mq=this.value;
					 igk.ajx.post(u_, "clName="+this.form["clName"].value+"&clValue="+this.value, function(xhr){
						 if (this.isReady()){
							 if (!e_)return;
							 \$igk(e_.t).setHtml(mq);

							 if (e_.c!=mq){
								 e_.t.parentNode.childNodes[2].innerHTML='<b>user define</b>';
							 }
							 e_ = null;
						 }
					 });
					 break;
					 case 27:
							//restore
							\$igk(e_.t).setHtml(e_.c);
							e_ = null;
						break;
				 }
			 });

			 \$igk(this).setHtml('').add(n);
			 v_s.o.focus();

		});
		return 1;
	});

});
EOF;
	}

	//cc: config controller function
	public function cc_view_controllerschema_ajx()
	{
		$frame = igk_add_new_frame($this, "configctrlschema_frame");
		$d = $frame->BoxContent;
		$frame->Title = R::ngets("title.viewcontrollerschema");
		$d->ClearChilds();
		$d->addDiv()->Content = "Schema structurel";
		$d->add("image" , array("src"=>$this->getUri("cc_controllerschema")));
		$frame->RenderAJX();
	}
	public function cc_controllerschema(){//get the controller hierarchi format
		$this->App->getControllerManager()->cm_controllerschema();
	}
	//
	//a fin de maintenir la connexion lors de la suppression d'un controller
	//restart la configuration
	public function reloadConfig($uri){
		$tab = igk_getquery_args($uri);
	}

	private function check_connect($user)
	{
		$adm = strtolower($this->App->Configs->admin_login);
		$adm_pwd = strtolower($this->App->Configs->admin_pwd);
		return (($adm == $user->clLogin) && ($adm_pwd == $user->clPwd));

	}
	public function startconfig(){

		$q = base64_decode(igk_getr("q"));
		$ajx = igk_getr("ajx");
		$tab = igk_getquery_args($q);
		$u =(object)array("clLogin"=>$tab["u"], "clPwd"=>$tab["pwd"]);
		 $v = $this->check_connect($u);
		 if ($v)
		 {
				$this->setConfigUser(igk_sys_create_user($u));
				$ctrl = igk_getctrl(igk_getv($tab, "selectedCtrl", IGK_CONF_CTRL ));
				$p = igk_getv($tab, "selectPage",IGK_DEFAULT_VIEW);
				if ($ctrl)
				{
					//show controller config
					$ctrl->showConfig();
				}
				else{
					//show this config
					$this->ShowConfig();
				}
				//allow navigation.
				if (igk_getr("navigate", 1))
				{
					if (!$ajx)
					{
						$uri = igk_io_baseUri(igk_getv(explode('?', igk_getv($tab, "baseUri", igk_io_baseUri()) ), 0));
						//igk_wln($uri);
						// igk_wln($tab);
						igk_navto($uri);
						igk_exit();
					}
					else{
						//render selected target node from ajx context
						if($ctrl){
							$ctrl->TargetNode->RenderAJX();
						}
					}
				}
		}
		else{
			igk_notifyctrl()->addErrorr("err.failedtoconnect");
		}
		igk_navtocurrent();
	}
	/// set selected menu config
	/// $ctrl = selected config controller
	/// $menuname = menu name
	/// $context = from context. info
	public function setSelectedConfigCtrl($ctrl, $fromContext=null){

		if ($this->m_selectedconfigCtrl !== $ctrl)
		{
			$this->m_selectedconfigCtrl = $ctrl;
			if ($ctrl && $ctrl->ConfigPage)
			{
				$this->_loadSystemConfig();
				$this->_selectMenu($ctrl->ConfigPage, "IGKConfigCtrl");

			}
		}
	}
	protected function _selectMenu($page, $context=null)
	{
		igk_getctrl(IGK_MENU_CTRL)->selectConfigMenu($page, "IGKConfigCtrl");
		$this->m_menuName = $page;
	}
	private function initConnexionNode()
	{
	$frm =  igk_createNode("form")->AppendAttributes( array("class"=>"connexion_frame"));
	$frm->ClearChilds();
	//vertical line
	$frm["method"]="POST";
	$frm["action"]=$this->getUri("connectToConfig");
	$a =  igk_createNode("a")->AppendAttributes( array("href"=>new IGKHtmlRelativeUriValueAttribute()));
	$a->Content =  "Go to index ";
	$a["style"]="color:white;";
	$igk_framename = IGK_FRAMEWORK;
	$igk_version = IGK_VERSION;
	$c = null;
	//igk_wln("agent is android ".igk_agent_isAndroid());
if (igk_agent_isAndroid())
{
	//connexion android frame.
	//------------------------
	igk_css_regclass(".igk-android-login-form", "[bgcl:igk-android-login-form-bg]");
	igk_css_regcolor("igk-android-login-form-bg", "#eee");

	$frm["class"] = null;
	$frm["class"]="fit alignc alingm ";
	$frm["style"] ="position:relative; padding-bottom:48px;font-size:1.3em;";
	// $frm->Box["style"] = "top:0px; bottom:0px; position:relative; overflow-y:auto; height:100%; background-color:#DFDFDF;vertical-align:middle;";
	$frm->Box["style"] = "top:0px; bottom:0px; position:relative; overflow-y:auto; height:100%; background-color:#37C4FF;vertical-align:middle;";

	$dv = $frm->addDiv();
	//text-shadow: 1px 1px 0px black, -1px -1px 2px #ddd;
	$dv->addDiv()->setClass("dispib")
	->setAttribute("style","text-align:center; color:#efefef; font-size:3.4em;vertical-align:middle; margin-bottom:32px;padding-top:32px;")
	->Content= IGK_PLATEFORM_NAME."<span class=\"igk-smaller alignt\" style=\"font-size:0.4em\">&copy;</span> Configuration";


	$kdiv = $frm->addDiv()->setClass("no-overflow");
	$kdiv["style"] = "height:auto; vertical-align:bottom; display:inline-block;  vertical-align:middle; ";
	$div = $kdiv->addDiv();



	$row = $kdiv->addContainer()->addDiv()->setClass("dispib")->setStyle("max-width:250px")->addRow();
	$row->addCol("igk-col-3-3")->addDiv()->setClass("alignl")->addNotifyHost("connexion:frame");
	$cdiv = $row->addCol("igk-col-3-3")->addDiv();
	$cdiv->addLabel()->setClass("igk-hbox")->Content = R::ngets("lb.clLogin");
	$cdiv->addInput("clAdmLogin", "text")
	->setAttribute("placeholder", R::ngets("tip.login"))
	->setClass("-cltext dispb igk-sm-fitw igk-form-control")->setStyle("border:none; border-bottom: 2px solid black; ");

	$cdiv = $row->addCol("igk-col-3-3")->addDiv();
	$cdiv->addLabel()->setClass("igk-hbox")->Content = R::ngets("lb.clPwd");
	$cdiv->addInput("clAdmPwd", "password")
->setAttribute("placeholder", R::ngets("tip.pwd"))
->setAttribute("autocomplete", "current-password")
->setClass("-clpassword dispb igk-sm-fitw igk-form-control")->setStyle("border:none; border-bottom: 2px solid black;");



	$cdiv = $row->addCol("igk-col-3-3")->addDiv()->setClass('alignc');
	$cdiv->addDiv()->addInput("btn_connect","submit", R::ngets("btn.connect"))->setClass("-clsubmit fitw igk-btn igk-btn-connect");

	$cdiv = $frm->addContainer()->setClass("igk-smaller");
	$cdiv->addA(igk_io_baseUri())->Content = "goto index";


	$frm->addDiv()->setClass("dispb posfix fitw no-overflow loc_l loc_b")
	->setAttribute("style", "font-size:0.8em; position:fixed; height:48px;")
	->addDiv()->Content = "{$igk_framename} - ( ".IGK_PLATEFORM_NAME." ) - {$igk_version}<br />Configuration";
}
else{
//$notification = igk_notification_response("connexion:frame");

//e_xit;
$frm->addNotifyHost();
$lang = function($n){
	return R::ngets($n)->getValue();
};
$out = <<<EOF
<script type="text/javascript">igk.winui.fn.close_all_frames();</script>
<div id="connectionTag" class="igk-cnf-connexion-div">
<div id="LayerDocument_52559464" style=" width:300px; height:400px; position:relative; color:white;  display:inline-block;" >

<div id="id_layer" style="width:300px; height:400px; z-index:0; position:absolute;">
<div id="id_board"  style="width:301px; height:401px; position:absolute; padding-top: 48px; background-repeat:no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAS0AAAGRCAYAAAAw6+XgAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAU5SURBVHhe7dSxCcAwAANB7b+bZ0ogtQfIwwmuUv/bzgPQ8O12APyRaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkmJmltr04BXpXuO4PkAAAAABJRU5ErkJggg==');left:0px; top:0px;">
	<div id="notify-z"></div>
	<ul>
	<li><label class="cllabel" for="clAdmLogin" >{$lang('lb.login')}</label><input type="text" name="clAdmLogin" id="clAdmLogin" class="cltext" autocomplete="off" /><br /></li>
	<li><label class="cllabel" for="clAdmPwd" >{$lang('lb.password')}</label><input type="password"  name="clAdmPwd" id="clAdmPwd" class="clpassword" autocomplete="current-password" /><br /></li>
	</ul>
	<li><input type="submit" class="clsubmit" name="connect" value="connexion" /></li>

</div>
<div id="id_content" style="width:301px; height:131px; position:absolute;background-repeat:no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAS0AAACDCAYAAADYgk3EAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAIqSURBVHhe7cnBCcAwAAOxDNv9Z2jw2wM4oAO97tw+gEekNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABalNgAWpTYAFqU2ABZJ0kud8wN9z4XWBD/VeQAAAABJRU5ErkJggg==');left:0px; top:270px;">
${igk_framename} - ${igk_version}<br />
Configuration Manager
</div>
<div id="id_foot" style="width:301px; height:31px; position:absolute;background-repeat:no-repeat; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAS0AAAAfCAYAAACyJpv8AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAACRSURBVHhe7dTBCYBAEATBzT+QS88IFMWHLwO4hhooWNh/zxzXAtjfuebd7xNgN6IFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQIpoASmiBaSIFpAiWkCKaAEpogWkiBaQIlpAimgBKaIFpIgWkCJaQMoXrecAKDAza23mBqing/ZAmi1SAAAAAElFTkSuQmCC');left:0px; top:0px;">

</div>
</div>
</div>
	<div id="igk_cpv"></div>
</div>
EOF;



	$g = $frm->addSingleNodeViewer('NoTagNode')->targetNode;
	$g->load($out);

	$i = $g->getElementById("id_board");
	$c = $g->getElementById("igk_cpv");
	$notz = $g->getElementById("notify-z");
	if ($notz){
		igk_notifyctrl()->setNotifyHost($notz, "connexion:frame");
	}
	if (is_object($i))
	{
		$i->add($a);
	}
	else {
		igk_die("/!\ not an object \$i. getElementById failed to retrieve id_board.");
	}

}

		if ($c)
			$c->Content = IGK_COPYRIGHT;


		return $frm;
	}
	protected function initTargetNode(){
		if(!$this->IsVisible)
			return null;
		$this->setParam(IGK_KEY_CSS_NOCLEAR, 1);
		$node =  igk_createNode("div")->setAttribute("class","igk-cnf-page fit igk-parentscroll igk-powered-viewer overflow-y-a");
		$this->m_configFrame =  igk_createNode("div")->AppendAttributes(array("class"=>"igk-cnf-frame"));
		$div = $this->m_configFrame->addDiv(array("class"=>"fitw disptable"));
    	$this->m_configMenuNode = $div->addDebuggingNode("div", array("id"=>"igk-cnf-menu", "class"=>"igk-cnf-menu"));
		$this->m_ConfigNode = $div->addDiv()->setId("igk-cnf-content")->setClass("igk-cnf-content");
		return $node;
	}

	private function __NoIE6supportView()
	{
		igk_wln("no ie 6 supported");
		igk_exit();
	}
	public function getConfigFrame(){
		return $this->m_configFrame;
	}
	public function getIsVisible(){
		//for config controller only visible on page in config mode
		return ($this->CurrentPageFolder == IGK_CONFIG_PAGEFOLDER) && igk_const_defined("IGK_CONFIG_PAGE" , 1);
	}
	public function getIsAvailable(){
		return ($this->CurrentPageFolder == IGK_CONFIG_PAGEFOLDER);
	}
	public function init_param_callback($name, $callback){
		$bar = $this->getParam($name);
		if ($bar ==null)
		{
			$bar = $callback($this);
			$this->setParam($name, $bar);
		}
		return $bar;
	}
	public function pageFolderChanged(){	
		if (!$this->getIsVisible()){
			$this->App->Doc->body["class"] = "-igk-cnf-body";
			igk_html_rm($this->TargetNode);
		}

	}
	public function View(){ //CONFIG VIEW
		//igk_ilog("view config");
		$tab_event = array($this, "_cnfPageFolderChanged");
		igk_notification_unreg_event(IGK_CONF_PAGEFOLDER_CHANGED_EVENT, $tab_event);
		if (!$this->getIsVisible() || igk_get_env(IGK_KEY_VIEW_FORCED)){
			return;
		}
		
		//init target node if not initialized
		if ($this->getTargetNode() ==null){
			$this->TargetNode = $this->initTargetNode();
		}
		
		$menuctrl = igk_getctrl(IGK_MENU_CTRL);
		
		

		$app = igk_app();
		$bbox = $app->Doc->body->addBodyBox();	
		$bbox->ClearChilds();	
		
		switch($app->CurrentPageFolder)
		{
			case IGK_CONFIG_MODE:
				$app->Doc->body["class"] = "-igk-client-page +igk-cnf-body";
				igk_html_add($this->TargetNode, $bbox);
				//reload the current view				
				break;
			default:
				$app->Doc->body["class"] = "+igk-client-page -igk-cnf-body";
				return;
		}
		// igk_wln("check is available");
		// igk_flush_data();
		// igk_wln("failed .....2 ? ".$this->IsAvailable);
		// session_destroy();
		// igk_exit();
		//if you have access to configuration page
		if ($this->IsAvailable ){
			if (igk_agent_isIE() && igk_agent_ieVersion() < 7)
			{
				 $this->__NoIE6supportView();
				 return;
			}
			$menuctrl->setConfigParentView($this->m_configMenuNode);
			$t = $this->getTargetNode();

			if (!$this->IsConnected)
			{
									// igk_wln("failed .....5 ");
		// igk_exit();
				igk_io_protect_request(igk_io_baseUri()."/Configs");
				$t->ClearChilds();
				$this->App->Doc->Theme->addTemporaryFile($this->getStylesDir()."/config.pcss");
				$cnode = $this->initConnexionNode();
				$t->addNotifyHost();
				igk_html_add($cnode, $t);
				$this->setFlag(self::CONNEXION_FRAME, $cnode);
			}
			else{
				// if ($this->getIsVisible())
				// {
						// igk_wln("failed .....3 ");
						// igk_flush_data();

		$cnode = $this->getFlag(self::CONNEXION_FRAME);
					if ($cnode)
					igk_html_rm($cnode, true);
					$this->setEnvParam(IGK_KEY_CSS_NOCLEAR,1);
					// igk_wln("d");
					// $this->TargetNode["class"]->Clear();
					$this->_include_view_file("configuration.page");
					$this->setEnvParam(IGK_KEY_CSS_NOCLEAR,0);
					$v_cview = $this->m_currentView;
					$v_cctrl = $this->SelectedConfigCtrl;
					// igk_wln("ok :::: ");
					// //	igk_wln("failed .....6 =  ".$this->m_currentView);
		// // igk_exit();
					if ($v_cctrl === null)
					{
						// igk_wln ("dd ::: view config mage .... BASE");
						// get the current view
						$this->setpage($v_cview );
					}
					else{
						//
						// echo ("view config mage ....");
						if (igk_get_env("sys://config/selectedview")!== $v_cctrl)
							$v_cctrl->showConfig();
					}
				// }
			}
		}
	


		$this->_onViewComplete();
		igk_notification_reg_event(IGK_CONF_PAGEFOLDER_CHANGED_EVENT, $tab_event);
	}
	public function _cnfPageFolderChanged($o,$e){
		$app = $this->App;
		$bbox = $app->Doc->body->addBodyBox();
		$bbox->ClearChilds();
		$this->TargetNode->clearChilds();
		$app->Doc->body["class"] = "+igk-client-page -igk-cnf-body";
		//igk_ilog("page folder changed" . igk_env_count("ddd"));
		igk_notification_unreg_event(IGK_CONF_PAGEFOLDER_CHANGED_EVENT, array($this, "_cnfPageFolderChanged"));
		// igk_ilog($e);
		if ($e["currentPage"]=="home"){
			//must reload current document
			$defctrl = igk_get_defaultwebpagectrl();
			if ($defctrl!=null){
				$defctrl->View();
			}else{
				igk_set_env(IGK_ENV_PAGEFOLDER_CHANGED_KEY, null);
			}
		}
	}


	public function __construct(){//construct IGKConfigCtrl
		parent::__construct();
		$this->m_confctrls  = array();
		$this->m_ConfigUserChangedEvent = new IGKEvents($this, "ConfigUserChangedEvent");//raise when config user changed
		$this->m_configSettingChangedEvent = new IGKEvents($this, "ConfigSettingChangedEvent");//raise when configuration setting changed		
	}
	//load configuration files configs.csv
	private function _loadSystemConfig()
	{
		$file =IGK_CONF_DATA;
		$e = array();
		$fullpath =igk_io_syspath($file);
		$f = IGKCSVDataAdapter::LoadData($fullpath);
		$e = $this->m_configEntries;
		if ($f !== null)
		{
			foreach($f as $k=>$v)
			{
				$e[$v[0]] = trim(igk_getv($v, 1));
			}
		}
		//new IGKConfigData($fullpath, $this, $e);


	}
	public function registerConfig($ctrl)
	{///register config controlleur
		$this->m_confctrls[$ctrl->Name] = $ctrl;
	}

	protected function InitComplete()
	{
		
		parent::InitComplete();
		IGKOwnViewCtrl::RegViewCtrl($this);
		$this->m_configuration = false;
	}
	
	public function onHandleSessionEvent($msg){
		switch($msg){
			case IGK_ENV_SETTING_CHANGED:
			$this->checkConfigDataChanged();
			break;
		}
		
	}
	
	protected function __initPageConfig(){
		$this->setParam("conf://initPageConfig", 1);
		$bbox = $this->App->Doc->body->addBodyBox();
		$bbox->ClearChilds();

		switch($this->App->CurrentPageFolder)
		{
			case IGK_CONFIG_MODE:
				$this->App->Doc->body["class"] = "-igk-client-page +igk-cnf-body";
				igk_html_add($this->TargetNode, $bbox);
				//reload the current view
				$this->View();
				break;
			default:
				$this->App->Doc->body["class"] = "+igk-client-page -igk-cnf-body";
				break;
		}
		$this->setParam("conf://initPageConfig", null);
	}

	public function checkConfigDataChanged($ctrl)
	{
		if (IGKAppConfig::getInstance()->checkConfigDataChanged($ctrl))
		{
			$this->onConfigSettingChanged();
		}
	}
	protected function onConfigUserChanged()
	{
		if ($this->m_ConfigUserChangedEvent !=null)
		{
			$this->m_ConfigUserChangedEvent->Call($this, null);
		}
		igk_notification_push_event(IGK_CONF_USER_CHANGE_EVENT, $this);
	}
	protected function onConfigSettingChanged()
	{
		if ($this->m_configSettingChangedEvent !=null)
			$this->m_configSettingChangedEvent->Call($this, null);
	}
	public function addConfigUserChangedEvent($obj, $method)
	{
		return $this->m_ConfigUserChangedEvent->add($obj, $method);
	}
	public function removeConfigUserChangedEvent($obj, $method=null)
	{
		$this->m_ConfigUserChangedEvent->remove($obj, $method);
	}
	public function addConfigSettingChangedEvent($obj, $method)
	{
		return $this->m_configSettingChangedEvent->add($obj, $method);
	}
	public function removeConfigSettingChangedEventt($obj, $method=null)
	{
		$this->m_configSettingChangedEvent->remove($obj, $method);
	}

	public function initConfigMenu(){//init system config menu
		return array(
			new IGKMenuItem(IGK_HOME_PAGEFOLDER, IGK_DEFAULT_VIEW, $this->getUri("setpage"),-900),
			new IGKMenuItem("PhpInfo", "phpinfo", $this->getUri("show_phpinfo"),-800),
			new IGKMenuItem("ServerInfo", "serverinfo", $this->getUri("show_serverinfo"),-750),
			new IGKMenuItem("ConfigurationMenuSetting", "configurationMenuSetting", $this->getUri("show_configuration_menu_setting"),-700),
			new IGKMenuItem("GoToIndex", null, $this->getUri("gotoindex"),10800),
			new IGKMenuItem("ClearSession",null, $this->getUri("Clearsession"),10810),
			new IGKMenuItem("Forceview",null, $this->getUri("forceview"),10810),
			new IGKMenuItem("Reconnect",null, $this->getUri("reconnect"),10850),
			new IGKMenuItem("LogOut", null, $this->getUri("logout"),10900)
		);
	}

	public function forceview(){
		igk_getctrl(IGK_SESSION_CTRL)->forceview();
	}

	public function gotoindex()
	{
		igk_navtobase(IGK_STR_EMPTY);
		igk_exit();
	}
	public function Clearsession()
	{
		$this->SelectedConfigCtrl = null;
		igk_getctrl(IGK_SESSION_CTRL)->ClearS();
	}
	public function reconnect($navigate=true){
		$this->ClearSessionAndReconnect($navigate);
	}
	public function show_phpinfo(){
		$this->SelectedConfigCtrl = null;
		$this->setpage("phpinfo", 1);
	}
	public function show_serverinfo(){
		$this->SelectedConfigCtrl = null;
		$this->setpage("serverinfo", 1);

	}
	function get_serverinfo(){
		$this->ConfigNode->clearChilds();
		$dv  = $this->ConfigNode->addDiv();
		$dv->addSectionTitle()->Content = "\$_SERVER";
		$tb = $dv->addTable();
		foreach($_SERVER as $k=>$v){
			$r = $tb->addTr();
			$r->addTd()->Content = $k;

			$r->addTd()->Content = $v;
		}
		$dv  = $this->ConfigNode->addDiv();
		// $dv->addSectionTitle()->Content = "\$_ENV";
		// $dv->addObData($_ENV);
		// $tb = $dv->addTable();
		// foreach($_ENV as $k=>$v){
			// $r = $tb->addTr();
			// $r->addTd()->Content = $k;
			// $r->addTd()->Content = $v;
		// }
	}
	public function getphpinfo(){
		$this->ConfigNode->ClearChilds();
		IGKOb::Start();
		phpinfo();
		$b = IGKOb::Content();

		igk_exit();
	}

	public function show_configuration_menu_setting()
	{
		$this->SelectedConfigCtrl = null;
		$this->setpage("configurationmenusetting",1);
	}
	private function _view_ConfigMenuSetting($node)
	{

		igk_html_add_title($node->addDiv(), "title.ConfigurationMenuSetting");
		$node->addHSep();
		$f = $this->getDataDir()."/config.menu.xml";
		$txt = IGKIO::ReadAllText($f);
		$dummy =  igk_createNode("dummy");
		$dummy->Load($txt);
		$b = igk_getv($dummy->getElementsByTagName("configmenu"),0);

		$v_subdiv = $node->addDiv();

		foreach($b->Childs as $k=>$v)
		{
			$v_d = $v_subdiv->addDiv();
			//title
			$t = $v_d->addDiv(array("class"=>"table table-stripped config-menu-title"));
			$t->Content = $v->TagName;
		}
	}

	public function setpage($p=null, $stored=0)
	{
		if (!$stored && $this->getParam("cnf://no_reload")){
			$this->setParam("conf://no_reload",null);
			return ;
		}
		if ($stored){
			$this->setParam("conf://no_reload",1);
		}
		if (!empty($p)){
			if ($this->m_currentView != $p){
				$this->setParam("cnf://no_recallview", 1);
			}
			$this->m_currentView = $p;
		}else{
			$this->m_currentView = IGK_DEFAULT_VIEW;
		}
		$p = $p ?? igk_getr("p", $p) ?? $this->m_currentView ;
		$app = igk_app();
		$cnf_n = $this->ConfigNode;
		$cnf_n->ClearChilds();
		$v_supported = true;
		// session_write_close();
		

		igk_notify_sethost($cnf_n->addDiv());
		switch($p)
		{
			case "configurationmenusetting":
				$this->SelectedConfigCtrl = null;
				$this->_selectMenu("ConfigurationMenuSetting", "IGKConfigCtrl::setpage");
				$div = $cnf_n->addDiv();
				$this->_view_ConfigMenuSetting($div);
				break;
			case "phpinfo":
				$this->_selectMenu("phpinfo", "IGKConfigCtrl::setpage");
				$iframe = $cnf_n->add("iframe", array("class"=>"fitw fith no-border"));
				$iframe["src"] = $this->getUri("getphpinfo");
				$iframe["style"]="min-height:800px; ";
			break;
			case "serverinfo":
				$this->_selectMenu("serverinfo", "IGKConfigCtrl::setpage");
				$this->get_serverinfo();
				break;
			case IGK_DEFAULT_VIEW:
				$this->SelectedConfigCtrl = null;
				$this->_selectMenu("home", "IGKConfigCtrl::setpage");
				$div = $cnf_n->addDiv();
				igk_html_add_title($div, "title.frameworkInfo");
				$div->addHSep();
				//
				//platform information
				//
				$ul = $div->add("ul");
				$ul->addLi()->Content = "FrameworkCodeName : ". IGK_PLATEFORM_NAME;
				$ul->addLi()->Content = "FrameworkVersion : ". IGK_VERSION;
				$ul->addLi()->Content = "FrameworkRelease : ".IGK_RELEASE_DATE;
				$ul->addLi()->Content = "Author : ". IGK_AUTHOR;
				$li = $ul->add("li", array("class"=>"alignt" ));
				$li->add("span", array("class"=>"alignt -lblabel" ))->Content = "Author Contact : ";
				$li->add("a", array("class"=>"alignt deco_u", "style"=>"text-decoration:underline" , "href"=>"mailto:".IGK_AUTHOR_CONTACT))->Content = "@igkdev.com";
				$ul->addLi()->Content = "PhpVersion : ". PHP_VERSION;
				if (function_exists("apache_get_version"))
				$ul->addLi()->Content = "Apache Version : ". apache_get_version();
				$ul->addLi()->Content = "ServerName : ".igk_getv($_SERVER,"SERVER_NAME");
				$ul->addLi()->Content = "OS : ".PHP_OS;//igk_getv($_SERVER,"SERVER_NAME");
				$ul->addLi()->Content = "OS Details: ".php_uname();//igk_getv($_SERVER,"SERVER_NAME");
				$ul->addLi()->Content = "UserAgent : ".igk_getv($_SERVER,"HTTP_USER_AGENT");
				$ul->addLi()->Content = "Server IP: ".IGKServerInfo::ServerAddress();
				$ul->addLi()->Content = "IsLocal : ". igk_parsebool(IGKServerInfo::IsLocal());
				$ul->addLi()->Content = "RemoteIP : ". IGKServerInfo::RemoteIp();

				// if (!igk_sys_mod_rewrite_available())
					// $ul->addLi()->setClass("igk-warning")->Content = "/!\ Apache mod_rewrite required.";
				
				//platform installer
				$frm = $div->addForm();
				$frm["action"] = $this->getUri("conf_install_platform");
				$frm["class"]="dispn";
				$i = $frm->addInput("clFile", "file");
				$i["accept"] = ".zip";
				$i["onchange"] = "javascript: ns_igk.os.install(this.form, {wait:'please wait... installing', complete:'install complete !!!'}); return false;";
				$i["class"] = "igk-btn igk-btn-default alignl dispib";


				$frm = $div->addForm();
				$frm->addLineWaiter();
				$v = IGK_VERSION;
				$u = igk_io_fullBaseRequestUri()."/".$this->getUri("checkForUpdate&v=".$v);

				$frm->addScript()->Content = <<<EOF
igk.os.checkupdate('{$u}');
EOF;

				// IGKHtmlItem
				//$frm->addUri();

				$div = $cnf_n->addDiv();

				igk_html_add_title($div, "title.AdministrativeConfig");
				$div->addHSep();
				$frm = $cnf_n->addForm()->setClass("fitw");
				$frm["action"] = $this->getUri("update_domain_setting");
				igk_notify_sethost($frm->addDiv(),"update_domain_setting");
				$frm->addSLabelInput("company_name","text",$app->Configs->company_name);$frm->addBr();
				$frm->addSLabelInput("website_domain", "text", $app->Configs->website_domain,null, true);$frm->addBr();
				$frm->addSLabelInput("website_title",  "text", $app->Configs->website_title);$frm->addBr();
				$frm->addSLabelInput("website_prefix",  "text", $app->Configs->website_prefix);$frm->addBr();
				$frm->addSLabelInput("website_adminmail",  "email", $app->Configs->website_adminmail);$frm->addBr();

				$dv = $frm->addDiv();
				$dv->addABtn(igk_io_baseUri()."/Configs!Settings")->Content = "ConfigSettings";
				$dv->addBtn("btn_domainName", R::ngets("btn.update"));

				$cnf_n->addHSep();
				$frm = $cnf_n->addForm();
				$frm->setId("adminpwd-form");
				$frm["action"] = $this->getUri("update_adminpwd");
				igk_notify_sethost($frm->addDiv(),"update_adminpwd");

				$frm->addSLabelInput("passadmin",  "password");$frm->addBr();
				$frm->addBtn("btn_domainName", R::ngets("btn.update"));

				//update current lang
				$frm = $cnf_n->addForm();
				$frm["action"] = $this->getUri("update_defaultlang");
				$frm->addHSep();
				if (!$app->Configs->default_lang)
				{
					$app->Configs->default_lang = R::GetCurrentLang();
				}

				$v_csvc = igk_getctrl(IGK_CSVLANGUAGE_CTRL);
				igk_assert_die($v_csvc==null, "The controller 'IGK_CSVLANGUAGE_CTRL' is null");

				$tab =array_merge($v_csvc->Languages);

				$dv = $frm->addDiv();
				$dv->addLabel("cldefaultLang")->Content = R::ngets("lb.cldefaultlang");
				$select = igk_html_build_select($dv, "cldefaultLang", $tab, array("allowEmpty"=>false, "keysupport"=>false),$app->Configs->default_lang);
				$select["class"] = "igk-form-control cltext";

				//$frm->addSLabelInput("cldefaulLang",  "text",  $app->Configs->default_lang);
				$frm->addBr();
				$frm->addBtn("btn.updateCurrentLang", R::ngets("btn.update"));

				//default tag
				$frm = $cnf_n->addForm();
				$frm["action"] = $this->getUri("update_default_tagname");
				$frm->addHSep();
				$frm->addSLabelInput("cldefault_node_tagname", "text",  $app->Configs->app_default_controller_tag_name);
				$frm->addBr();
				$frm->addBtn("btn.updateGlobalSetting", R::ngets("btn.update"));

				$cnf_n->AddHSep();
				$frm = $cnf_n->addForm();
				$frm["action"] = $this->getUri("conf_update_setting");
				$div = $frm->addDiv();
				$ul = $div->add("ul");
				$ul["class"]="igk-row other-conf-setting";
				$tab = array(
				 "cldebugmode"=> "allow_debugging",
				 "clallowlog"=>"allow_log",
				 "clCacheLoadedFile"=> "cache_loaded_file",
				 "clarticleconfig"=> "allow_article_config",
				 "clinformAccessConnection"=> "informAccessConnection",
				 "clautochepage"=> "allow_auto_cache_page");

				foreach($tab as $s=>$t){
					$this->_checkedItemConfig($ul->addLi()->setClass("igk-col fitw igk-col-lg-3-1")->addDiv(), $s, $t);
				}
				$li = $ul->addLi()->setClass("igk-col fitw igk-col-lg-3-1")->addDiv();
				$li->addLabel()->Content = R::ngets("lb.clcache_file_time");
				$li->addInput("clcache_file_time", "text",  igk_getdv($app->Configs->cache_file_time, 3600))
				->setAttribute("style","width:80px");

				$frm->addBtn("btn_updatedebugmode", R::ngets("btn.update"));
				$frm->add('a')
				->setClass("clsubmit igk-btn igk-btn-default")
				->setAttribute("href", $this->getUri("clearcache"))
				->setAttribute("onclick", "javascript: ns_igk.ajx.get(this.href+'&ajx=1', null,{src:this,complete:function(xhr){ ns_igk.ajx.fn.prepend_to(xhr,this.src.parentNode); }});  return false;")
				->Content = R::ngets("btn.clearcache");
				//TODO: CACHE TOOL
				$v_cache_t = $cnf_n->addDiv();
				$this->__init_cache_tools($v_cache_t);



				$frm = $cnf_n->addForm();
				$frm["action"] = $this->getUri("resetconfig");
				$frm["class"]="dispib";
				$frm->addBtn("btn_resetconfig", R::ngets("btn.resetconfig"));

				$frm = $cnf_n->addForm();
				$frm["action"] = $this->getUri("conf_runCtrlConfig");
				$frm["class"]="dispib";
				$frm->addBtn("btn_runctrlconfig", R::ngets("btn.runctrlSetupConfig"));
				break;
			default :
				$v_supported = false;
				break;
		}
	}
	private function __init_cache_tools($t){
		$t->addDiv()->addSectionTitle(4)->Content = R::ngets("title.cacheTools");
		$frm = $t->addForm();
		$frm["action"] = $this->getUri("updatecacheConfig_ajx");
		$u = $this->getUri("activehtmlCache-ajx");
		$div = $frm->addDiv();
		$div->addLabel("a_html_cache")->setClass("dispib")->Content = "Html Cache";
		$div->addToggleStateButton("a_html_cache","on", igk_sys_is_html_caching())->setClass("dispib")
		// ->setAttribute("value", igk_sys_is_html_caching())
		// ->setAttribute("checked", igk_sys_is_html_caching())
		->setAttribute("onchange", "ns_igk.ajx.get('{$u}&cache='+ns_igk.geti(event.target.checked),null,ns_igk.ajx.fn.no); return false;");
	}
	public function activehtmlCache_ajx(){
		$s = igk_getr("cache");
		if ($s){
			igk_sys_enable_html_caching();
		}
		else{
			igk_sys_disable_html_caching();
		}
	}

	public function checkForUpdate(){
		$r = igk_createNode("response");
		$v =  igk_getr("v", '0.0.0.0');
		$buri =  IGK_WEB_SITE;
		$uri = $buri."/api/v2/sysversion";
		$sys=0;
		$r->addXmlNode("status")->Content = 0;
		$r->addXmlNode("request")->Content = "{$sys}";
		$r->addXmlNode("uri")->Content = $uri;//"{$sys}";
		$r->RenderAJX();
		igk_exit();

		if (!empty($sys) && preg_match("/^([0-9]+)\.([0-9]+)(\.([0-9]+)\.([0-9]+))?$/", $sys)){
			$p = igk_cmp_version($v, $sys);
			if ($p == 0){
				$m = $r->add("Message");
				$m->addDiv()->Content = R::ngets("msg.youareuptodate");
				$r->add("Status")->Content = 0;
			}
			else if ($p == -1){
				$r->add("Status")->Content = 1;
				$d = $r->add("Message")->addDiv();
				$d->setStyle("padding-top:10px; padding-bottom:10px");
				$u = //str_replace("&", "&amp;",
				igk_io_fullBaseRequestUri()."/"
				//igk_io_baseUri()."/"
				.$this->getUri('conf_install_update');

				$d->addDiv()->Content = R::ngets("msg.uptodaterequired");
				$d->addDiv()->Content = R::ngets("app.new.version_1", $sys);
				//$d->addDiv()->Content = "Current : ".$v . ' '.$p;
				$d->addInput("btn.update", "submit" , R::ngets("btn.update"))->setAttribute("onclick",
					"javascript: ns_igk.os.update('$u'); return false;");
				$dv = $d->addDiv();
				$dv->setId("dialog");
				$dv->setClass("igk-dialog-temp wait");
				$dv->addDiv()->setClass("title")->Content = R::ngets("title.pleasewait");
				$m = $dv->addDiv()->setClass("msg")->addDiv();
				$m->addDiv()->Content = R::ngets("msg.updatingpleasewait");
				$m->addDiv()->addLineWaiter();

				$dv = $d->addDiv();
				$dv->setId("dialog");
				$dv->setClass("igk-dialog-temp os-complete");
				$dv->addDiv()->setClass("title")->Content = R::ngets("title.OS");
				$m = $dv->addDiv()->setClass("msg")->addDiv();
				$m->addDiv()->Content = R::ngets("msg.loadingcomplete");


			}	else{
				$m = $r->add("Message");
				$m->addDiv()->Content = R::ngets("msg.yourversionishighter");
				$r->addNode("Status")->Content = "0";
			}
		}
		else{
			$r->add("Message")->Content = "";//Can't connect to server";
			$r->add("Status")->Content = -1890;
		}
		$r["xmlns:igk"]=IGK_SCHEMA_NS;
		$r->RenderXML();
		igk_exit();
	}
	public function conf_install_update($ruri=null){
		if (!igk_is_conf_connected()){
			return false;
		}
		$u = IGK_WEB_SITE."/balafon/download/0";
		//$u = "http://local.com/balafon/download";
		$f = igk_get_web_content($u);//ff($u);
		$rep = igk_createNode("response");
		// igk_log_write_i("intalling", "data::::: ".strlen($f)." ==== ".$f);
		if (!empty($f)){
		//header("Content-Type: text/plain");

		//create a resource handle
		//$fn = tmpfile();
		$dir = igk_io_dir( dirname(__FILE__)."/tmp");
		igk_io_createdir($dir);
		$fn = tempnam($dir, "cnf");
		$k =  $fn.".zip";
		rename($fn, $k);
		$fn = $k;
		$rep->loadArray(array(
			"uri"=>$u,
			"datalength"=>strlen($f),
			"tmp_name"=>$fn
		));
		igk_io_save_file_as_utf8_wbom($fn, $f, true);
		$c = false;
				if (file_exists($fn)){
					$c = $this->conf_install_platform($fn, null
					//$dir
					);
					if (file_exists($fn))
						unlink($fn);
					$rep->loadArray(array("status"=>$c));
				}
				else{
					$rep->loadArray(array("status"=>$c));
				}
		}
		if ($c){
			igk_getctrl(IGK_SESSION_CTRL)->forceview();
			$rep->addNode("ruri")->Content = $ruri? $ruri : igk_io_fullBaseRequestUri()."/";//rootBaseRequestUri();//igk_getv($_SERVER, "HTTP_REFERER");
		}
		$rep->RenderAJX();
		igk_exit();
	}

	private function conf_install_checklib($content){
		return true;
	}
	public function conf_install_platform($file=null, $outdir=null){
		$odir = $outdir==null? igk_io_baseDir() :  $outdir;
		$f =$file==null? igk_getv(igk_getv($_FILES, "clFile"), "tmp_name") : $file;
		$r = false;
		//igk_flush_start();
		if (!empty($f))
		{
			$i = IGKIO::CreateDir($odir);
			//check if file definitinition
			$c = igk_zip_unzip_file_content($f, "__lib.def");
			if (!empty($c))
			{
				if ($this->conf_install_checklib($c))
				{

					//backgup the current lib
					//igk_flush_start();

					$bDomain = IGKSubDomainManager::GetBaseDomain();

					IGKIO::CreateDir(igk_io_baseDir()."/Data/Backup");
					//igk_flush_write("create a backup");
					igk_zip_folder(
						igk_io_baseDir()."/Data/Backup/Lib.zip",
						igk_io_baseDir()."/Lib",
						"Lib"
					);

				// igk_log_write_i("unzip", "unzip to ....".$odir. " :::: ".$f);
					igk_zip_unzip($f, $odir);
					$cf = igk_io_baseDir("__lib.def");
					if (file_exists($cf))
						unlink($cf);
					//complete install process
					//igk_flush_write_data("complete install process");
					IGKControllerManagerObject::ClearCache();
					//store domain
					IGKSubDomainManager::StoreBaseDomain($this, $bDomain);

					//igk_flush_data();
					$r = true;
				}
			}
			else{
				igk_debug_wln("lib file definition not found !!!!");
			}
			// unlink($f);
		}
		else{
			igk_log_write_i("config_install", "/!\ not installed");
		}
		if (($file==null)&& ($outdir==null)){
		igk_getconfigwebpagectrl()->reconnect();
		igk_exit();
		}
		return $r;
	}

	public function clearcache(){

		IGKControllerManagerObject::ClearCache();
		igk_notifyctrl()->addMsg("clear cache complete");
		if (igk_is_ajx_demand())
		{
			//render no tag node
			$t = igk_createNode("NoTagNode");
			$t->addNotifyHost();
			$t->RenderAJX();
			igk_exit();
		}
	}
	public function update_default_tagname()
	{
		 $s = igk_getr("cldefault_node_tagname", "div");
		 if (!empty($s))
			$this->App->Configs->app_default_controller_tag_name = $s;

		igk_save_config();
		igk_resetr();
		$this->View();
		igk_notifyctrl()->setNotifyHost(null);
		igk_notifyctrl()->addMsgr("msg.ConfigOptionsUpdated");
		igk_navtocurrent();
	}
	function _checkedItemConfig($target, $name, $param)
	{
			$target->add("label", array("for"=>$name))->Content = R::ngets("lb.".$param);
			$chb = $target->addInput($name, "checkbox", null);
			$chb["value"]="1";
			if ($this->App->Configs->$param)
				$chb["checked"] = "true";
	}

	public function resetconfig(){
		if(igk_qr_confirm())
		{
			@unlink(igk_io_currentRelativePath("Data/configure"));
			igk_getctrl(IGK_MYSQL_DB_CTRL)->initSDb(false);
			$this->reconnect();
		}
		else{
			$frame = igk_frame_add_confirm($this, "frame_reset_config", $this->getUri("resetconfig"));
			$frame->Form->Div->Content = R::ngets("msg.confirmResetConfig");
		}
	}

	public function conf_runCtrlConfig(){
		$tctrl = igk_sys_getall_ctrl();
		if ($tctrl){
			$param = array();
			foreach($tctrl as $k=>$v)
			{
				$v->SetupCtrl($param);
			}
		}
		//after running config
		$this->App->Doc->Theme->save();
		igk_notifyctrl()->addMsgr("msg.runCtrlConfigComplete");
	}

	//update debug mode
	public function conf_update_setting()
	{
		$this->App->Configs->allow_debugging = igk_getr("cldebugmode", false);
		$this->App->Configs->cache_loaded_file = igk_getr("clCacheLoadedFile", false);
		$this->App->Configs->allow_article_config = igk_getr("clarticleconfig", false);
		$this->App->Configs->allow_auto_cache_page = igk_getr("clautochepage", false);
		$this->App->Configs->cache_file_time = igk_getr("clcache_file_time", false);
		$this->App->Configs->informAccessConnection = igk_getr("clinformAccessConnection", false);
		igk_save_config();
		igk_notifyctrl()->setNotifyHost(null);

		$this->View();
		igk_notifyctrl()->addMsgr("msg.configOptionsUpdated");
		igk_resetr();
		//igk_navtocurrent();
	}

	public function update_defaultlang()
	{
		$this->App->Configs->default_lang = igk_getr("cldefaultLang","Fr");
		igk_save_config();
		igk_notifyctrl()->addMsgr("msg.update_defaultlang");
		$this->View();
		igk_navtocurrent('?l='.$this->App->Configs->default_lang );
	}
	public function update_adminpwd()
	{
		$d = igk_getr("passadmin");
		if ($d && (strlen($d)> IGK_MAX_CONFIG_PWD_LENGHT)){
			$this->App->Configs->admin_pwd = md5($d);
			igk_save_config();
			igk_resetr();
			igk_notifyctrl(__FUNCTION__)->addSuccessr("msg.pwdupdated");

		}
		else
			igk_notifyctrl(__FUNCTION__)->addErrorr("e.adminpwdnotupdated");
		$this->View();
		igk_navtocurrent("./#adminpwd-form");
	}
	public function update_domain_setting(){
		$d = igk_getr("website_domain", IGK_DOMAIN);
		$title = igk_getr("website_title");
		$prefix = igk_getr("website_prefix");

		if ($d && strlen($d) && igk_is_domain_name($d) )
		{
			$this->App->Configs->website_domain = $d;
			IGKSubDomainManager::StoreBaseDomain($this, $d);
		}
		$this->App->Configs->website_title = $title;
		$this->App->Configs->website_prefix = $prefix;
		$this->App->Configs->website_adminmail = igk_getr("website_adminmail", null);
		$this->App->Configs->company_name = igk_getr("company_name");
		//store domain to config file

		igk_io_save_file_as_utf8_wbom(igk_io_baseDir()."/".IGK_DATA_FOLDER."/domain.conf", $d, true);

		igk_save_config();
		igk_notifyctrl(__FUNCTION__)->addSuccessr("msg.settingupdate");
		$this->View();
		igk_navtocurrent();
	}

	public function preview_result_ajx(){//preview current page result
		$d = igk_createNode();
		$uri =igk_getv($_SERVER, "HTTP_REFERER");
		$s = igk_post_uri($uri);
		if ($s){
			//load body

			$t = IGKHtmlReader::Load($s);
			$head = igk_getv($t->getElementsByTagName("head"),0);
			$body = igk_getv($t->getElementsByTagName("body"),0);
			$tl = igk_getv($head->getElementsByTagName("title"),0);
			$d->addDiv()->setClass("fcl-blue igk-title-5")->Content = $tl?
			$tl->innerHTML : "NoTitle";
			$dv = $d->addDiv();
			if ($body){
			$dv->Content = igk_html_render_text_node($body);
			}
			else {
				$dv->Content = "body is null";
			}
		}
		igk_ajx_notify_dialog("Page Result Preview", $d);
	}

	public function logout($redirect=true, $detroysession=true){
		if ($this->IsConnected)
		{

			$this->setConfigUser(null);
			$this->setSelectedConfigCtrl(null);
		}
		if ($detroysession )
			session_destroy();
		$this->View();
		if ($redirect)
		{
			igk_navtocurrent();
			igk_exit();
		}
	}

	public function connectToConfig($u=null,$pwd=null, $redirect=true){	//connect to server for administration
		if ($this->IsConnected )
		{
			//$this->View();
			return;
		}
			
		$not = igk_notifyctrl()->getNotification("connexion:frame", true);
		$u = ($u==null)? strtolower(igk_getr("clAdmLogin",$u)) : $u;
		$pwd = ($pwd==null)? strtolower(md5(igk_getr("clAdmPwd",$pwd))) :md5($pwd);

		if (empty($u) || empty($pwd))
		{
			$not->addErrorr("err.login.failed");
			$this->View();
		}
		else
		{
			$adm = strtolower($this->App->Configs->admin_login);
			$adm_pwd = strtolower($this->App->Configs->admin_pwd);


			if ( ($adm == $u) &&
				 ($adm_pwd ==$pwd))
			{
				$us = (object)array("clLogin"=>$u, "clPwd"=>$pwd, "csrf"=>"igk-".(IGK_STR_EMPTY.rand()+time()));
				$this->setConfigUser(igk_sys_create_user($us));	
				$this->View();
				$this->_send_notification_mail();				
			}
			else {
				$not->addErrorr("err.login.failed");
				$this->View();
			}
		}
		if ($redirect){
			igk_nav_session();
			igk_exit();
		}
	}
	public function test_send_mail(){
		$this->_send_notification_mail();
		//exit;
	}
	//<summary> send mail notification</summary>
	private function _send_notification_mail()
	{
		$ctrl = $this;
		if ($this->App->Configs->informAccessConnection){
			$app = igk_app();
			$to = $app->Configs->website_adminmail;
			if ($to){
				$message =  igk_createNode("div");

				$message->addArticle($ctrl, "mail.notify.template", (object)array("clDate"=>igk_mysql_datetime_now(),
				"clDomain"=>$app->Configs->website_domain));


				// $message->Content = "You connected to ".$app->Configs->website_domain." platform at ". igk_mysql_datetime_now();
				// $message["class"]="fitw fith container";
				$d = igk_get_document('sys://mail/notification');//new IGKHtmlDoc($this->App, true);

				if ($d === igk_app()->Doc){
					igk_die("notification is equal to global document ");
				}
				//e_xit;

				$opt = igk_xml_create_render_option();
				$opt->Context = "mail";
				$opt->NoStoreRendering = 1;
				$d->body->ClearChilds()->add($message);
				if(!igk_mail_sendmail($to, "no-reply@".$this->App->Configs->website_domain, R::ngets("title.mail.adminnotifyconnexion_1",$app->Configs->website_domain)->getValue(), $d->Render($opt), null)){
					igk_ilog("message notification failed",__FUNCTION__);
				}

			}
			else{
				igk_ilog(__FUNCTION__, "/!\\ Can't send mail notification");
			}
		}
	}


	public function IsFunctionExposed($f){

		$v = false;
		if (method_exists(get_Class($this), $f)){
				///check if this method is public
				$b = new ReflectionMethod(get_class($this), $f);
				$v =  $b->isPublic();
		}
		if ($v && igk_is_conf_connected()){
				return $v;
		}
		else{
			return  $v || (strtolower($f) == "connecttoconfig");
		}
		return false;
	}

}

///<summary>used internally for debugging node</summary>
final class IGKHtmlDebuggingNodeItem extends IGKHtmlItem{
	public function __construct($tag, $prop= null){
			parent::__construct($tag);
			if ($prop)
			$this->setAttributes($prop);
	}
}
///<summary>mail controller</summary>
class IGKMailCtrl extends IGKConfigCtrlBase
{
	private $m_mailSendEvent;


	public function getName(){
		return IGK_MAIL_CTRL;
	}
	public function __construct(){
		parent::__construct();
		$this->m_mailSendEvent = new IGKEvents($this, "MailSend");
	}
	public function addMailSendEvent($obj, $func){
		if( $this->m_mailSendEvent!=null)
		$this->m_mailSendEvent->add($obj, $func);
	}
	public function removeMailSendEvent($obj, $func)
	{
		if( $this->m_mailSendEvent!=null)
		$this->m_mailSendEvent->remove($obj, $func);
	}
	public function onMailSended($args)
	{
		if( $this->m_mailSendEvent!=null)
			$this->m_mailSendEvent->Call($this, $args);
	}

	public function send_contactmail($fromName, $message=null)
	{
		$obj = igk_get_robj();

		$enode =  igk_createNode("div");
		$mail = new IGKMail();

		$this->initMailSetting();
		$this->init_mail_config($mail);



			$mail->addTo($this->App->Configs->mail_contact);
			$div =  igk_createNode("div");
			$div["style"] = "border:1px solid black; min-height:32px;";
			$ul = $div->add("ul");
			$ul->addLi()->Content = "Message From: ".$fromName;
			$ul->addLi()->Content = "Email: ".$obj->clYourmail;

			$msg = $div->addDiv();
			$msg->Content = $obj->clMessage;

			$mail->HtmlMsg = utf8_decode($div->Render());
			$mail->Title = utf8_decode($obj->clSubject);
			$mail->ReplyTo = $obj->clYourmail;
			$mail->From =  "website@".$this->App->Configs->website_domain;
			if ($mail->sendMail())
			{
				igk_resetr();
				$div =  igk_createNode("div");
				$div->Content = R::ngets("msg.email.correctlysend");
				$div->addScript()->Content = "igk.animation.autohide(igk.getParentScript(), 3000);";
				$e = new IGKHtmlSingleNodeViewer($div);
				$this->onMailSended(array(
					"clEmail"=>$obj->clYourmail,
					"clFirstName"=>$obj->clFirstName,
					"clLastName"=>$obj->clLastName
				));
				return  array(true, $e);
			}
			else{
				$enode->addLi()->Content = R::ngets("msg.mail.sendmailfailed");
				return  array(false, $enode);
			}

	}

	public function IsFunctionExposed($func = null){//mail
		$tab =igk_array_createkeyarray(array("sendmailto",
			"register"
		),1);

		if (isset($tab[$func]))
			return true;

		return parent::IsFunctionExposed($func);
	}
	public function sendmailto()
	{
		$to = igk_getr("n");
		$s = igk_getr("s");

		$m =  igk_createNode("script");
		$m->Content =<<<EOF
window.open("mailto:$to?subject=$s","sendmail");
EOF;
		$this->App->Doc->body->add(new IGKHtmlSingleNodeViewer($m));
		igk_navtocurrent();

	}
	public function initMailSetting()
	{

		 ini_set("smpt_port", $this->App->Configs->mail_port);
		 ini_set("SMTP", $this->App->Configs->mail_server);
		 ini_set("sendmail_from", $this->App->Configs->mail_admin);
	}
	private function init_mail_config($mail)
	{
		$mail->UseAuth = $this->App->Configs->mail_useauth;
		$mail->User = $this->App->Configs->mail_user;//"igkdevbe"; //"bondje.doue@gmail.com";
		$mail->Pwd = $this->App->Configs->mail_password;//"bonajehost1983"; //"bonaje123";
		$mail->Port = $this->App->Configs->mail_port; //587;//  465; //587;
		$mail->SmtpHost = $this->App->Configs->mail_server;
		$mail->SocketType = $this->App->Configs->mail_authtype;//"ssl";
	}
	//send mail to element
	public function sendmail($from, $to,$subject, $message, $reply=null, $attachement=null, $type="text/html"){
	     // Pour envoyer un mail HTML, l'en-tête Content-type doit être défini
		$header = null;
		$this->initMailSetting();

		if ($reply){
			ini_set("mail_from", $reply);
		}
		$mail = new IGKMail();
		$this->init_mail_config($mail);

		$mail->HtmlMsg = $message;
		$mail->Title = $subject;
		$mail->From = $from;
		$mail->HtmlCharset = "utf-8";
		$mail->TextCharset = "utf-8";
		$mail->addTo($to);
		if (is_array($attachement))
		{
			foreach($attachement as $k=>$v)
			{
				if (igk_reflection_class_extends($v, "IGKMailAttachement"))
				{
					$mail->attach($v);
				}
				else
					$mail->attachContent($v->Content, $v->ContentType, $v->CID);
			}
		}
		return $mail->sendMail();
	}

	public function getConfigPage(){return "mailserver";	}
	
	public function View(){
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}
		$c = $this->TargetNode;
		igk_html_add($c, $this->ConfigNode);

		$c->ClearChilds();
		igk_html_add_title($c, "title.ConfigMailServer");
		$c->addHSep();
		igk_add_article($this, "mailserver", $c->addDiv());

		$c->addHSep();


		$div = $c->addDiv();
		$div->addNotifyHost("mailconfig");
		$frm = $div->addForm();
		$frm["method"]="POST";
		$frm["action"]=$this->getUri("mail_update");

		$frm->addSLabelInput("server",  "text", $this->App->Configs->mail_server); $frm->addBr();
		$frm->addSLabelInput("baseFrom", "text", $this->App->Configs->mail_admin);$frm->addBr();
		$frm->addSLabelInput("port", "text", $this->App->Configs->mail_port);$frm->addBr();
		$frm->addSLabelInput("clContactTo", "text", $this->App->Configs->mail_contact);$frm->addBr();

		$o = $frm->addSLabelInput("useauth","checkbox", $this->App->Configs->mail_useauth);
		$o->input["value"]="1";
		$frm->addBr();
		$frm->addLabel("cl.mailAuthType", "clAuthType");
		igk_html_build_select($frm,
		"clAuthType",
		array("ssl"=>"ssl","tsl"=>"tsl"),
		null,
		$this->App->Configs->mail_authtype
		); $frm->addBr();


		$frm->addSLabelInput("clMailUser", "text", $this->App->Configs->mail_user);$frm->addBr();
		$frm->addSLabelInput("clMailPwd", "password", $this->App->Configs->mail_password);$frm->addBr();
		$frm->addBtn("btn_update", R::ngets("btn.update"));



		$frm = $div->addForm();
		igk_notify_sethost($frm->addDiv(), "mail:notifyResponse");
		$frm["method"]="POST";
		$frm["action"]=$this->getUri("mail_testmail");
		$frm->addSLabelInput("clTestMail","text", $this->App->Configs->mail_testmail);$frm->addBr();
		$frm->addBtn("btn_testmail", R::ngets("btn.TestMail"));
	}


	public function mail_testmail()
	{
		$to  = igk_getr("clTestMail");
		$this->App->Configs->mail_testmail = $to;
		igk_save_config();
			$mailctrl = igk_getctrl(IGK_MAIL_CTRL);
			$c = $this->App->Configs->mail_contact;
			if ( ($mailctrl!= null) && !empty($c))
			{
			//from
			//to
			//IGKApp::$DEBUG = true;
				if (
				$mailctrl->sendmail(
					$c,//from
					$to,//to
				"Mail test: ".$this->App->Configs->website_domain,
				"This mail is a test mail From <b> " .$this->App->Configs->website_domain."<b>"))
				{
					igk_notifyctrl("mail:notifyResponse")->addSuccessr("msg.mailsend");
				}
				else{
					igk_notifyctrl("mail:notifyResponse")->addError(
					R::gets("msg.mailnotsend"). " ".$mailctrl->ErrorMsg . " ".igk_debuggerview()->getMessage());
				}
			}
			else
				$this->msbox->addError("error ... ".$this->App->Configs->mail_contact);

		$this->View();
	}

	public function mail_update(){

		$server= igk_getr("server");
		$mail= igk_getr("baseFrom");
		$port = igk_getr("port");
		$useauth = igk_getr("useauth");
		$this->App->Configs->mail_server = $server;
		$this->App->Configs->mail_port = $port;

		$this->App->Configs->mail_admin = $mail;
		$this->App->Configs->mail_useauth = $useauth;
		$this->App->Configs->mail_contact  = igk_getr("clContactTo");
		$this->App->Configs->mail_authtype = igk_getr("clAuthType");
		$this->App->Configs->mail_user=igk_getr("clMailUser");
		$this->App->Configs->mail_password = igk_getr("clMailPwd");


		igk_save_config();
		igk_notifyctrl("mailconfig")->addMsgr("msg.mailupdatedd");
		//$this->View();
		igk_navtocurrent();
		igk_exit();
	}


	////<summary>register  a mail contact</summary>
	public function register(){
		$n = "sys://mailregisterform";
		$c = igk_getr("clEmail");
		$n = igk_notifyctrl()->getNotification($n, true);
			if (empty($c) ){
				$n->addErrorr("msg.emailnotvalid");
			}
			else{
				$n->addMsgr("msg.mailregistered");
				igk_resetr();
				igk_db_insert_if_not_exists($this,"tbigk_mailinglist", array("clEmail"=>$c));
			}
		igk_sys_force_view();
		igk_navtocurrent();
	}
	public function lock_mail(){
		$c = igk_getr("clEmail");
		igk_db_update($this, "tbigk_mailinglist", array("clActive"=>2), array("clEmail"=>$c));
		igk_sys_force_view();
		igk_navtocurrent();
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
}


///<summary>
///represent a Palette controller Model
///</summary>
final class IGKPaletteCtrl extends IGKNonVisibleControllerBase
{
	private $m_palettes;

	//get the name of the controller
	public function getName(){return IGK_PALETTE_CTRL;}

	//get list of palettes
	public function getPalettes(){ return $this->m_palettes; }

	//get the palette directory
	public function getPaletteDir(){
		return igk_io_baseDir("R/Palettes");
	}
	public function loadFile($fname)
	{
		if (!file_exists($fname))return;

		$v_name = igk_io_basenamewithoutext($fname);

		$v_t = null;
		if (isset($this->m_palettes[$v_name]))
		{
			$v_t = $this->m_palettes[$v_name];
		}
		else
			$v_t = array();

		$e =  igk_createNode("pal");
		try{
		$e->Load(IGKIO::ReadAllText($fname));

		$e = igk_getv($e->getElementsByTagName("palette"), 0);
		if ($e){
		foreach($e->Childs as $k)
		{
			if (strtolower($k->TagName)=="item")
			{
				$v = $k["color"];
				$n = $k["name"];
				$v_t[$n] = $v;
			}
		}

		$this->m_palettes[$v_name] = $v_t;
		}
		}
		catch (Exception $ex) {
		}
	}
	protected function InitComplete()
	{
		parent::InitComplete();
		$this->loadPalette();
		//$this->App->Session->addUpdateSessionEvent($this, "updatePaletteSession");
	}
	// public function updatePaletteSession(){
		// refresh cal the view if necessary
		// if (igk_is_debuging()){
			// igk_getctrl(IGK_PALETTE_CTRL)->loadPalette();
		// }
	// }
	public function loadPalette()
	{
		$dir = $this->getPaletteDir();
		if(is_dir($dir))
		{
			$v_tfiles = IGKIO::GetFiles($dir, "/\.gkpal$/i", false);
			foreach($v_tfiles as $f)
			{
				$this->loadFile($f);
			}
		}
	}
	//remove palette
	public function RemovePalette($id){
		$s = $this->getPaletteDir()."/".$id.".gkpal";
		if (file_exists($s))
		{
			unlink($s);
			$this->m_palettes = array();
			$this->loadPalette();
		}
	}
	public function __construct()
	{
		parent::__construct();
		$this->m_palettes = array();
	}

}


//--------------------------------------------------------------------------------------------
///- THEME CONTROLLER
//--------------------------------------------------------------------------------------------
///<summary>represent a controller that will manage the theme on administration page</summary>
final class IGKThemeCtrl extends IGKConfigCtrlBase
{
	private $m_search;
	private $m_searchkey;
	private $m_searchColor;
	private $m_searchRes;
	private $m_rendering;
	private $m_selectedMenu; //the selected menu
	private $m_lastThemeChanged; //last language key changed
	private $m_cssFileTable; //imported css file table

	public static function GetRegClass(){
		return IGKHtmlClassValueAttribute::GetRegClass();
	}
	public static function UnRegClass($key){
		return IGKHtmlClassValueAttribute::UnRegClass($key);
	}
	public function __construct(){
		parent::__construct();
		$this->m_search = null;
		$this->m_rendering =false;
		$this->m_cssFileTable = array();
	}
	public function getName(){return IGK_THEME_CTRL;}
	///<summary>load theme by name</summary>
	public function loadTheme(){
		//THEME CTRL // LOAD THEME
		//igk_debug_wln("notice:loadtheme");
		$f = igk_io_baseDir("R/Themes/".$this->App->Doc->Theme->Name.".phtml");
		if (file_exists($f))
		{
			$this->App->Doc->Theme->LoadThemeFromFile($f);
			return 1;
		}
		return 0;
	}

	public function ResetTheme(){
		$this->App->Doc->Theme->def->Attributes->Clear();
		$this->saveTheme();
		igk_exit();
	}
	public function removeTheme(){
		$f = igk_io_syspath("R/Themes/".$this->App->Doc->Theme->Name.".phtml");
		if (file_exists($f))
		{
			@unlink(igk_io_currentRelativePath($f));
			igk_notityctrl()->addMsgr("msg.theme.updated");
			$this->View();
		}

	}
	protected function InitComplete(){
		parent::InitComplete();
		//
		$this->_initTheme();
	}
	protected function onHandleSystemEvent($msg){
		if (!$this->IsVisible()){
			return;
		}
		
		switch($msg){
			case IGKApp::$REG_CSS_CLASS_EVT:
				$this->Reloadview();
			break;
			
		}
	}
	private function ReloadView($o,$e)
	{
		if ($this->m_rendering)
			return;
		$this->View();
	}
	private function _initTheme()
	{
		//remove all themes
		//$this->app->Doc->ClearStyle();
		//init system theme
		// $this->App->Doc->initSysTheme();
		// load system theme
		$this->loadTheme();
		//load additional css theme
		$this->themeLoadCssFiles();
	}
	public function onThemeChangedProc($ctrl)
	{
		$n = $this->App->Doc->Theme->RegChangedKey;
		if ($ctrl->isChanged($n, $this->m_lastThemeChanged))
		{
			//merge theme with the current
			$this->loadTheme();
			if ($this->getIsVisible())
				$this->View();

		}
	}

	function _adddel_action($frm)
	{
			$frm->addInput("btn_delaction","button", R::ngets("btn.rmSelection"), array("onclick"=>"javascript:this.form.btn_action.value = 1; this.form.submit()"));
	}
	public function delete_selection()
	{
		$tab = igk_getr("keytab");
		igk_debug_wln("notice:IGKThemeCtrl::delete_selection");

		$x = igk_getr("ccount", 0);
		for($i = 0; $i<$x; $i++)
		{
			$t = igk_getr("css_i_".$i);
			if ($t)
			{
				$this->App->Doc->Theme->def->Attributes[$tab[$i]] = null;
			}
		}

		igk_getctrl(IGK_THEME_CTRL)->saveTheme();
		$this->search($this->m_searchkey);
		$this->View();
	}

	//save the current theme
	public function saveTheme(){
		return $this->App->Doc->Theme->save();
	}
	//save the current theme as default theme
	public function th_save_as_default(){
		 $n = igk_getr(IGK_FD_NAME,"default");
		 $f = igk_io_syspath(IGK_DEFAULT_THEME_FOLDER."/".$n.".themes");
		if ( !IGKIO::CreateDir(dirname($f))|| !$this->App->Doc->Theme->save($f))
		{
			igk_notifyctrl()->addErrorr("e.cantsavefile");
			return false;
		}
		else{
			igk_notifyctrl()->addMsgr("msg.filesaved_1", basename($f));
		}
		return true;
	}
	public function th_save_as_default_frame(){
		$frame_name = "save_as_default_frame";
		if (igk_qr_confirm())
		{
			 $n = igk_getr(IGK_FD_NAME,"default");
			 $f = igk_io_syspath(IGK_DEFAULT_THEME_FOLDER."/".$n.".themes");

			if ( !IGKIO::CreateDir(dirname($f))|| !$this->App->Doc->Theme->save($f))
			{
				igk_notifyctrl()->addError(R::gets("ERR.CANTSAVEFILE"));
			}
			else{
				igk_notifyctrl()->addMsg(R::ngets("MSG.FileSaved", basename($f)));
			}
			igk_frame_close($frame_name);
			igk_navtocurrent();
		}
		else{
			$frame = igk_add_new_frame($this, $frame_name);
			$d = $frame->BoxContent;
			$d->ClearChilds();

			$frame->Title = R::ngets("title.SAVEDefaultTheme");
			$frm = $d->addForm();
			$frm["action"] = $this->getUri("th_save_as_default_frame");
			$frm->addSLabelInput(IGK_FD_NAME, "text", "default", true);
			$frm->addHSep();
			$frm->addInput("confirm", "hidden", 1);
			$frm->addBtn("btn_save", R::ngets("btn.Save"),"submit");
		}
	}
	public function select_menu(){
		$this->m_selectedMenu = igk_getr("n",IGK_DEFAULT_VIEW);
		$this->View();
	}
	public function View(){

		$t = $this->getTargetNode();

		if (!$this->getIsVisible())
		{
			igk_html_rm($t);
			return;
		}
		//rendering to ignored theme management update
		$this->m_rendering = true;
		//load not registrated registrated class
		foreach(IGKThemeCtrl::GetRegClass() as $k)
		{
			if(!isset($this->App->Doc->Theme[$k]))
				$this->App->Doc->Theme[$k]=IGK_STR_EMPTY;
		}
		IGKHtmlUtils::AddItem($t, $this->ConfigNode);
		$node = $t;
		$node->ClearChilds();
		igk_html_add_title($node, R::ngets("title.themeManager"));
		$node->addSeparator();


		$this->m_selectedMenu = $this->m_selectedMenu?$this->m_selectedMenu: "themes";
		$div = $node->addDiv();
		igk_add_article($this,"themes.description", $div);
		$node->addHSep();
		//view menu
		$menut = array("themes", "cssFiles", "palette","color", "font", "system_theme");
		$t = array();
		foreach($menut as $k)
		{
			$t[$k] = $this->getUri("select_menu&n=".$k);
		}


		$node->add(igk_html_node_ConfigSubMenu($t, $this->m_selectedMenu));
		//IGKHtmlUtils::CreateConfigSubMenu($node, $t, $this->m_selectedMenu);
		unset($t);
		$node->addHSep();




		$frm = $this->TargetNode->addForm();
		$frm["action"] = $this->getUri("update_name");
		$frm["id"]="class_editor";
		$frm->addBr();
		$frm->addSLabelInput("theme_name", "text",$this->App->Doc->Theme->Name);
		IGKHtmlUtils::AddBtnLnk($this->TargetNode,R::ngets("btn.save"), $this->getUri("th_save_as_default_frame"));
		$node->addHSep();
		switch(strtolower($this->m_selectedMenu))
		{
			case "palette":
				$this->_th_showPalette();
				break;
			case "cssfiles":
				$this->themeShowCssFiles();
				break;
			case "font":
				$this->_showFont();
				break;
			case "color":
				$this->_showColor();
				$this->m_rendering = false;
				return;
			break;
			case "system_theme":
				$this->_showSystemTheme();
			break;
			default:
				$this->_showThemes();
				break;
		}

		$this->TargetNode->addHSep();

		$this->m_rendering = false;
	}
	//-----------------------------------------------------------------------------------------------------
	// THEMES FUNCTION . SHOW CURRENT THEME
	//-----------------------------------------------------------------------------------------------------
	private function _showThemes()
	{
		$div = $this->TargetNode;
		$div = $div->addDiv();
		igk_add_loading_frame($div);
		$div->addScript()->Content = "(function(q){ igk.ajx.apost('".$this->getUri("themeViewPrimaryConfig_ajx")."',null, function(xhr){if (this.isReady()){ this.setResponseTo(q); }}, false);})(igk.getParentScript());";

	}

	public function themeViewPrimaryConfig_ajx()
	{
		$c =  igk_createNode("div");
		$div = $c;
		igk_html_add_title($div, R::ngets("title.CSSClass"));
		$div->addHSep();


		igk_setr("q", igk_getr("q", $this->m_searchkey));
		$div->add(new IGKHtmlSearchItem($this->getUri("search")));
		$div->addBr();
		$frm = $div->addForm();
		$frm["action"] = $this->getUri("theme_updatekeys");
		//view all themes
		$tab = null;
		$ttab = null;
		$v_index= 0;
		if ($this->m_search === null)
		{
			$tab =  $this->App->Doc->Theme->def->Attributes->ToArray();
			$ttab =$this->App->Doc->Theme->def->Attributes->ToArray();
		}
		else{
			$tab =  $this->m_search;
			$ttab = $this->m_search;
		}
		if (count($ttab)>0)
		{
		$ctab = array_keys($ttab);
		igk_usort($ctab, "igk_key_sort");
		$this->_adddel_action($frm);
		$frm->addSpace();
		$this->_themeFormControl($frm);

		$tcount = $frm->addDiv();
		$ul  = $frm->addTable();
		$tr = $ul->addTr();

		IGKHtmlUtils::AddToggleAllCheckboxTh($tr);

		$tr->add("th")->Content = R::ngets(IGK_FD_NAME);
		$tr->add("th", array("class"=>"fitw") )->Content =  R::ngets("clValue");
		$tr->add("th",array("class"=>"box_16x16"))->Content = IGK_HTML_SPACE;
		$tr->add("th",array("class"=>"box_16x16"))->Content = IGK_HTML_SPACE;

		foreach($ctab as $k)
		{
			$kk = $this->App->Doc->Theme->def[".".$k];
			if (!empty($kk) || empty($k))
				continue;

			$v = $tab[$k];
			$li = $ul->addTr();
			$chbox = $li->addTd()->add("input", array("type"=>"checkbox"));//Content = IGK_HTML_SPACE;
			$chbox["name"] = "css_i_".$v_index;

			$li->add("td" ,array("class"=>"no-wrap"))->add("span", array("for"=>"key_".$v_index, "class"=>"-cllabel dispb no-wrap"))->Content = $k;
			$txt = $li->addTd()->addInput("key_".$v_index, "text", $v);

			$v_id = htmlentities($k);
			$li->add("td" ,array("class"=>"box_16x16"))->add("a", array("href"=>$this->getUri("theme_editkey&id=".base64_encode($v_id))))->add("img", array("src"=>R::GetImgUri("edit_16x16")));
			$li->add("td" ,array("class"=>"box_16x16"))->add("a", array("href"=>$this->getUri("theme_rmkey&id=".base64_encode($v_id))))->add("img", array("src"=>R::GetImgUri("drop_16x16")));
			$v_index++;

		$li->addInput("keytab[]","hidden", $v_id);
		}

		igk_html_toggle_class($ul, "tr");
		$tcount->Content  =  $v_index;
		}
		$frm->addInput("ccount","hidden",$v_index);
		$frm->addInput("btn_action","hidden","0");
		$frm->addBtn("btn_update", R::ngets("btn.Update"));
		$frm->addSpace();
		$this->_adddel_action($frm);
		$this->_themeFormControl($frm);
		igk_wln($c->innerHTML);
		return;
	}
	public function restore_theme(){
		$n  = base64_decode(igk_getr(IGK_FD_NAME));
		if(!empty($n)){
			$this->App->Doc->Theme->Name = $n;
			$this->loadTheme();
			$this->View();
		}
		igk_navtocurrent();
	}


	///<summary>show theme files</summary>
	private function _showSystemTheme(){
		$node = $this->TargetNode;
		igk_html_add_title($node, R::ngets("title.SystemThemeManager"));
		$node->addHSep();
		$frm = $node->addForm();
		$frm["action"] = $this->getUri("restore_theme");

		$dir = igk_io_currentRelativePath(IGK_DEFAULT_THEME_FOLDER);
		$tab = igk_io_getfiles($dir, "/\.phtml$/i");// igk_io_dirFileList($dir);
		if ($tab && (count($tab)>0))
		{
			$frm->add("label", array("for"=>IGK_FD_NAME))->Content = R::ngets(IGK_FD_NAME);
			$sl = $frm->add("select");
			$sl->setId(IGK_FD_NAME);
			$sl->setClass("igk-form-control");
			foreach($tab as $k)
			{
				$opt = $sl->add("option");
				$s = igk_io_remove_ext(basename($k));
				$opt["value"]=base64_encode ($s);
				$opt->Content =$s;
			}
		}
		else{
			$frm->addDiv()->Content = "no theme found: ". $dir;
		}
		$frm->addHSep();
		$frm->addBtn("btn_validate", R::ngets("btn.restore"));
	}

	//--------------------------------------------------
	//PALETTE FUNCTIONS
	//--------------------------------------------------
	public function palette_UpdateCurrentPaletteName_ajx()
	{
		$r = igk_getr("clCurrentPaletteName");
		$this->App->Configs->CurrentPaletteName = $r;
		igk_save_config();
	}
	private function _th_showPalette(){
		$node = $this->TargetNode;
		igk_html_add_title($node, R::ngets("title.paletteManager"));
		$node->addSeparator();

		igk_add_article($this,"themes.palette.description", $node);
		$frm = $node->addForm();

		$div = $frm->add("div", array("style"=>"height: auto; line-height: 16px; max-width : 300px;"));

		$optiondiv = $div->addDiv();
		$w = 16;
		$h = 16;
		$p = IGK_STR_EMPTY;
		$cl = "#000";
		$li = $optiondiv->addLi();
		$li->addLabel("currentPaletteName");
		$sel = $li->add("select");
		$sel["id"]=$sel["name"] = "clCurrentPaletteName";
		$sel["onchange"]= "javascript:window.igk.ajx.post('".$this->getUri('palette_UpdateCurrentPaletteName_ajx&')."'+this.id+'='+this.value, null, null);";

		$currentPal = igk_getv($this->App->Configs, "CurrentPaletteName", null);
		$v_check = true;
		$sel->add("option",array("value"=>IGK_STR_EMPTY));
		foreach(igk_getctrl(IGK_PALETTE_CTRL)->Palettes as $k=>$v)
		{

			$cdiv = $div->addDiv();
			$v_t = $cdiv->addDiv();
			$v_t->Content = $k;
			IGKHtmlUtils::AddImgLnk($v_t, igk_js_post_frame($this->getUri("theme_dropPalette_ajx&id=".$k)), "drop_16x16");

			$v_option = $sel->add("option",array("value"=>$k));

			if ($k == $currentPal){
				$v_option["selected"]="true";
				$v_check = false;
			}
			$v_option->Content = $k;

			foreach($v as $m=>$n)
			{
				$p = $n;
				$f = $cdiv->add("a", array("style"=>"display: inline-block; width:".$w."px;
				height:".$h."px; margin: 1px; background-color:".$p.";"));
				$f->Content = IGK_HTML_SPACE;
				$f["href"]="#";//	$this->getUri("setColor&cl=".$p);
			}
		}
		if (!$v_check)
		{
			$this->App->Configs->CurrentPaletteName = null;
		}
		IGKHtmlUtils::AddBtnLnk($frm,R::ngets("btn.AddPalette"), igk_js_post_frame($this->getUri("theme_addPalette_ajx")));
	}

	public function theme_dropPalette_ajx()
	{
		$id = igk_getr("id");
		$frame = igk_frame_add_confirm($this,"theme_droppalette_confirm_frame", $this->getUri("theme_dropPalette"));
		$frame->Form->Div->Content = R::ngets("msg.confirmsuppression");
		$frame->Form->Div->addInput("clId", "hidden", $id);
		$frame->RenderAJX();
	}
	public function theme_dropPalette()
	{
		if (igk_qr_confirm())
		{
			$id = igk_getr("clId");
			igk_getctrl(IGK_PALETTE_CTRL)->RemovePalette($id);
			$this->View();
			$this->TargetNode->RenderAJX();
			igk_exit();
		}
	}
	public function theme_addPalette_ajx(){
		$frame = igk_getctrl(IGK_FRAME_CTRL)->createFrame("theme_addPalette", $this,  "#palette_form");
		IGKHtmlUtils::AddItem($frame,  $this->App->Doc->body);
		$frame->Title = R::ngets("title.AddPalette");

		$d = $frame->BoxContent;
		$frame->ClearChilds();
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("theme_addPalette");
		$frm->addLi()->addSLabelInput(IGK_FD_NAME,"lb.Name");
		$li = $frm->addLi();
		$li->add("label", array("for"=>"clFile"))->Content = R::ngets("lb.palette");
		$li->addInput("clFile","file","file");
		$frm->addHSep();
		$frm->addBtn("btn_add", R::ngets("btn.Add"));

		$frame->RenderAJX();
	}

	public function theme_addPalette()
	{
		$v_c = igk_getv($_FILES, "clFile");

		if ($v_c)
		{
			$v_fname = igk_getctrl(IGK_PALETTE_CTRL)->getPaletteDir()."/".igk_getr(IGK_FD_NAME).".gkpal";
			igk_io_move_uploaded_file($v_c["tmp_name"], $v_fname);
			igk_notifyctrl()->addMsgr("msg.paletteAdded");
			igk_getctrl(IGK_PALETTE_CTRL)->loadFile($v_fname);
			$this->View();
		}
	}


	//--------------------------------------------------
	//STYLES FUNCTIONS
	//--------------------------------------------------
	///<summary>used in configuration mode to edit controller style in configuration mode. when article is added</summary>
	public function theme_editStyle_ajx($render=true){
		$n = igk_getr("n"); //name of the controller
		$ctrl = igk_getctrl($n);
		$frame = igk_add_new_frame($this, "edit_frame_ajx");


		$n = strtolower($ctrl->Name );
		$frame->Title = R::ngets("title.editclassentry");
		$frame->Width = "700px";
		$frame->Height = "400px";
		$frame->ClearChilds();
		$d = $frame->BoxContent;
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("theme_editStyle_validateajx");
		$frm->setId("editstyle-ajx-form");
		$frm["class"] = "editstyle-ajx-form";

		$frm->addLi()->add("label", array("for"=>"clValue"))->Content = $n;


		$area = $frm->addLi()->add("textarea");
		$area["class"]="cltextarea +theme_stylearea";
		$area->setId("clValue");
		$area->Content = $this->App->Doc->Theme[$n];
		$frm->addInput(IGK_FD_NAME, "hidden", $n);
		$frm->addInput("clUpdated", "hidden", $n);
		$frm->addInput("clCibling", "hidden", igk_getr("cibling")); //to allow cibling on the document
		$frm->addHSep();
		$frm->addBtn("btn_update", R::ngets("btn.update"));
		if ($render)
		$frame->RenderAJX();
	}
	public function theme_editStyle_validateajx(){
		$t = igk_get_robj();
		$this->App->Doc->Theme[$t->clName] = $t->clValue;
		igk_getctrl(IGK_THEME_CTRL)->saveTheme();
		igk_notifyctrl()->addMsgr("msg.themestyle.updated");
		igk_resetr();
		$_REQUEST["n"] = $t->clName;
		$this->theme_editStyle_ajx(false);
		igk_navto(igk_io_baseUri()."/#".$t->clName);

	}
	public function theme_editkey(){
		$n = base64_decode(igk_getr("id"));
		$frm = igk_getctrl(IGK_FRAME_CTRL)->createFrame("theme_addkey", $this, "#class_editor");
		IGKHtmlUtils::AddItem($frm,  $this->App->Doc->body);

		$frm->Title = R::ngets("title.editclassentry");
		$d = $frm->Box;
		$frm->ClearChilds();
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("theme_addKey");
		$frm->addLi()->addLabel()->Content = $n;
		$frm->addLi()->Content = IGK_HTML_SPACE;
		$frm->addLi()->addSLabelInput("clValue","text", $this->App->Doc->Theme[$n] );
		$frm->addInput(IGK_FD_NAME, "hidden", $n);
		$frm->addInput("clUpdated", "hidden", $n);
		$frm->addHSep();
		$frm->addBtn("btn_update", R::ngets("btn.update"));
	}
	public function theme_addKey($navigate=true){
		$n = trim( igk_getr(IGK_FD_NAME));
		$v = igk_getr("clValue");
		if ($n){
			$this->App->Doc->Theme[$n] = $v;
		}
		igk_getctrl(IGK_THEME_CTRL)->saveTheme();
		$this->search($this->m_searchkey);
		$this->View();
		$t = igk_getr("clUpdated" , false);
		if ($t)
		{
			igk_frame_close("theme_addkey");
		}
		if ($navigate)
			igk_navtocurrent();
	}
	public function theme_updatekeys(){

		if (igk_getr("btn_action") == 1){ $this->delete_selection(); return;}

		 $keytab= igk_getr("keytab");
		 $hv = igk_getr("ccount");
		 $n = igk_getr("theme_name");


		for($i = 0 ; $i< $hv; $i++)
		{
			$this->App->Doc->Theme[$keytab[$i]] = igk_getr("key_".$i);
		}
		igk_getctrl(IGK_THEME_CTRL)->saveTheme();
		$this->search($this->m_searchkey);
		$this->View();

		try{
			igk_notifyctrl()->addMsgr("msg.themeupdated");
			igk_navtocurrent();
		}catch(Exception $ex)
		{
			igk_show_exception($ex);
			igk_exit();
		}
	}


	//--------------------------------------------------
	//FONT FUNCTIONS
	//--------------------------------------------------
	private function _showFont(){
		$d = $this->TargetNode;
		igk_html_add_title($d, R::ngets("title.FontManager"));
		$d->addSeparator();

		igk_add_article($this,"themes.fontmanager.description", $d);
		$d->add(new IGKHtmlSearchItem($this->getUri("searchfont"), $this->m_searchfont,"qft"));
		$d->addHSep();

		$frm = $this->__getfontform();
		$d->add($frm);
	}
	public function getFontDir(){
		return igk_io_syspath(IGK_RES_FONTS);
	}
	public function add_font(){
		$f = igk_getv($_FILES, "clfile");
		$n = igk_getr(IGK_FD_NAME);
		if (($f["error"] == 0) && igk_qr_confirm() ){
			if (IGKIO::CreateDir($this->FontDir))
			{
				$destination = igk_io_dir($this->FontDir."/".$f["name"]);

				if (!file_exists($destination))
				{
					if (!igk_io_move_uploaded_file($f["tmp_name"],$destination))
					{
						igk_notifyctrl()->addError("move upload file failed");
					}
					else{
							$d = igk_html_uri(igk_io_basePath($destination));
							igk_notifyctrl()->addMsg("Font added : ".$d);
							$this->App->Doc->Theme->addFont($n, $d);
					}
				}
				else{
					igk_notifyctrl()->addError("failed file already exists");
					$d = igk_io_basePath($destination);
					$this->App->Doc->Theme->addFont($n, $d);
				}
			}
			else{
				igk_notifyctrl()->addError("can't create a directory");
			}
		}
		else{
				igk_notifyctrl()->addError("can't add font ". $f["error"] );
		}
		$this->View();
		igk_navtocurrent();
	}

	public function theme_buildFontTable($table, $presentation=null)
	{
		//header
		$tr = $table->addTr();
		IGKHtmlUtils::AddToggleAllCheckboxTh($tr);//->add("th")->Content = IGK_HTML_SPACE;

		$tr->add("th")
		->setClass("fitw")
		->Content = R::ngets(IGK_FD_NAME);
		$tr->add("th")->Content = R::ngets("clPath");
		//$tr->add("th")->Content = IGK_HTML_SPACE;
		$tr->add("th", array("style"=>"width:24px;"))->Content = IGK_HTML_SPACE;
		$tr->add("th", array("style"=>"width:24px;"))->Content = IGK_HTML_SPACE;

		//had content
		$dir = igk_io_currentRelativePath(IGK_RES_FONTS);
		$ft = $this->App->Doc->Theme->getFont();
		//
		$ajx = igk_is_ajx_demand()?"&ajx=1":"";
		foreach($ft->Attributes as $k=>$v)
		{
			$tr = $table->addTr();

			$tr->add("td",array("style"=>"width:16px; "))
			->addInput("fontnames[]", "checkbox", $k)
			->setStyle("width:auto;");//Content = IGK_HTML_SPACE;
			$tr->addTd()->Content = $k;
			$f = "";
			if (is_string($v))
				$f = $v;
			else
				$f = igk_getv($v, 'File');
			if ($f && file_exists(igk_io_currentRelativePath($f)))
			{
				$tr->addTd()->add("a",array("href"=>$this->getUri("getfontfile&n=".base64_encode($v))))->Content = $v;
				IGKHtmlUtils::AddImgLnk($tr->add("td", array("style"=>"width:16px;")),igk_js_post_frame($this->getUri("edit_font_ajx&n=".base64_encode($k))), "edit_16x16");
			}
			else if (is_object($v)){
				$tr->addTd()->Content = "[Font Package]";
				$tr->addTd()->addSpace();
			}
			else{
				$td = $tr->addTd();
				$td->addObData($v);
			}

			IGKHtmlUtils::AddImgLnk($tr->add("td", array("style"=>"width:16px;")),igk_js_post_frame($this->getUri("drop_font_ajx&n=".base64_encode($k))), "drop_16x16");
			if ($presentation)
			{
			$presentation->add("li",
				array(
				"igk-font-tool-tip"=>$k,
				"igk-font-drop-font"=>$this->getUri("drop_font{$ajx}&n=".base64_encode($k)),
				"igk-font-drop-font-uri"=>R::GetImgUri("drop_16x16")))
				->setClass("dispib")
				->addDiv(array("style"=>"height:48px; font-family: '".$k."';"))->Content = "igK";
			}
		}

	}
	private function __getfontform(){
		$frm =  igk_createNode("form");
		//bind actions

		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.addNewFont"), igk_js_post_frame($this->getUri("ft_add_font_frame_ajx")));
		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.installFontFrame"), igk_js_post_frame($this->getUri("ft_install_font_frame_ajx")));

		igk_notifyctrl()->setNotifyHost($frm->addDiv());

		$table  = $frm->add("table", array("class"=>"fitw"));
		$ul = $frm->add("ul", array("id"=>"font_list", "class"=>"font_list"));

		$this->theme_buildFontTable($table, $ul);

		//bind actions
		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.addNewFont"), igk_js_post_frame($this->getUri("ft_add_font_frame_ajx")));
		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.installFontFrame"), igk_js_post_frame($this->getUri("ft_install_font_frame_ajx")));

		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.rmAll"),igk_js_post_frame($this->getUri("Clear_all_font_ajx")));//, array("onclick"=>"if(confirm('".R::gets("MSG.CONFIRMALLFONTSUPRESSIONQUESTION")."')){ igk_confirm_lnk(this);} return false;"));
		$frm->addInput("confirm", "hidden", 0);

		return $frm;
	}
	//font function
	public function ft_add_font_frame_ajx(){
		$frame = igk_add_new_frame($this, "add_font_frame", "?#font_list");
		$frame->Title = R::ngets("title.addfont");
		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri("add_font");
		$ul = $frm->add("ul");
		$ul->addLi()->addSLabelInput(IGK_FD_NAME);
		$ul->addLi()->addSLabelInput("clfile",  "file");
		$frm->addInput("confirm", "hidden", 1);
		$frm->addHSep();
		$frm->addInput("btn_confirm", "submit", R::ngets("btn.addfont"));
		$frame->RenderAJX();
	}
	public function ft_install_font_frame_ajx(){
		$frame = igk_add_new_frame($this, "ft_install_font_frame");
		$frame->setTitle(R::ngets("title.install_fontframe_dialog"));
		//$frame->BoxContent->ClearChilds();
		$ctrl = igk_get_regctrl("sys");
		if ($ctrl){
			//$frame->BoxContent->addNotifyBox("success")->Content =" system controller found";
			$ctrl->viewInstallFontForm($frame->BoxContent->addDiv(), $this);
		}
		else{
			$frame->BoxContent->addNotifyBox("danger")->Content = "/!\ No system controller found";
		}
		$frame->RenderAJX();
	}

	public function drop_font(){
		$v = base64_decode(igk_getr("n"));
		$this->App->Doc->Theme->removeFont($v);
		$this->View();
	}
	public function drop_font_ajx(){
		if (igk_qr_confirm())
		{
			$this->drop_font();
			$this->View();
			igk_navtocurrent();
		}
		else{
			$n = igk_getr("n");
			$frame = igk_frame_add_confirm($this, "drop_font_frame", $this->getUri("drop_font_ajx"));
			$frame->Form->Div->Content = R::ngets("q.delete_font_1", base64_decode($n));
			$frame->Form->addInput("n","hidden", $n);
			$frame->RenderAJX();
		}
	}
	public function edit_font_ajx(){
		if (igk_qr_confirm())
		{
			$c = $this;
			igk_io_save_posted_file("clfile",$this->FontDir , function($n,$d) use($c){
				$c->App->Doc->Theme->addFont($n, $d);
			});
			igk_frame_close("edit_font_frame");
			$this->View();
			igk_navtocurrent("#font_list");
			igk_exit();
		}
		else{
		$n = base64_decode( igk_getr("n"));
		$frame = igk_add_new_frame($this, "edit_font_frame", "?#font_list");
		$frame->Title = R::ngets("title.editfont");
		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$ul = $frm->add("ul");
		$t = $ul->addLi()->addSLabelInput(IGK_FD_NAME);
		$t->input["readonly"]=1;
		$t->input["value"]=$n;

		$ul->addLi()->addSLabelInput("clfile",  "file");
		$frm->addInput("confirm", "hidden", 1);
		$frm->addHSep();
		$frm->addInput("btn_confirm", "submit", R::ngets("btn.confirm"));
		$frame->RenderAJX();
		}
	}
	public function Clear_all_font_ajx(){
		if (igk_qr_confirm())
		{
			$this->App->Doc->Theme->ClearFont();
			$this->View();
			igk_navtocurrent();
		}
		else{
			$frame = igk_frame_add_confirm($this, "Clearallfont_confirm_frame", $this->getUri("Clear_all_font_ajx"));
			$frame->Form->Div->Content = R::ngets(IGK_MSG_DELETEALLFONT_QUESTION);
			$frame->RenderAJX();
		}
	}
	public function getfontfile(){
		$v = base64_decode(igk_getr("n"));
		igk_getctrl(IGK_FILE_MAN_CTRL)->getfile(igk_io_currentRelativePath($v));
	}


	private function __add_cl_cnf_btn($frm, $ctrl){
			$frm->addHSep();
			IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.add"), $ctrl->getUri("addnewcolorframe#colorman"));
			IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.importcolorfile"), $ctrl->getUri("th_importcolorfileframe#colorman"));
			IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.downloadcolor"), $ctrl->getUri("th_downloadcolorfile#colorman"));
			IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.Clearthemecolor"), $ctrl->getUri("th_Clearthemecolor#colorman"));
	}
	//--------------------------------------------------
	//COLOR FUNCTION
	//--------------------------------------------------
	public function th_Clearthemecolor()
	{
		$this->App->Doc->Theme->cl->Attributes->Clear();
		igk_notifyctrl()->addMsgr("msg.colorupdated");
		$this->View();
	}
	public function th_downloadcolorfile()
	{
		$v_div =  igk_createNode("Colors");
		foreach($this->App->Doc->Theme->cl->Attributes as $k=>$v)
		{
			$v_div->add("color", array("name"=>$k, "value"=>$v));
		}
		$s = "<?xml version=\"1.0\" ?>\r\n".$v_div->Render((object)array("Indent"=>true));
		igk_download_content("colortheme.xml", strlen($s),  $s);
	}
	public function th_importcolorfile()
	{

		igk_wln("th_importcolorfile");
		$v_f = igk_getv($_FILES, "clColorFile");
		$text = IGKIO::ReadAllText($v_f["tmp_name"]);
		$v_t =  igk_createNode("div");
		$v_t->Load($text);
		$v_clt = igk_getv($v_t->getElementsByTagName("Colors"), 0);
		if ($v_clt !== null)
		{
			igk_wln("load color");
			foreach($v_clt->Childs as $k=>$v)
			{
				if ($v->TagName=="color")
				{
					$this->App->Doc->Theme->addColor($v["name"], $v["value"]);

				}
			}
			$this->View();
		}
		igk_notifyctrl()->addMsgr("Msg.ColorUpdated");
		igk_frame_close("theme_importcolorfile");

	}
	public function th_importcolorfileframe()
	{
		$frm = igk_add_new_frame($this, "theme_importcolorfile", "#colorman",$this->App->Doc->body);


		$frm->Title = R::ngets("title.importcolorfile");
		$frm->ClearChilds();
		$d = $frm->Box;
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("th_importcolorfile#colorman");
		$ul = $frm->add("ul");
		$ul->addLi()->addSLabelInput("clColorFile", "file",null);
		$frm->addHSep();
		$frm->addBtn("btn_import",R::ngets("btn.import") );
	}

	private function _showColor(){

		$d = $this->TargetNode;
		$t = igk_html_add_title($d, R::ngets("title.ColorManager") );
		$t->setId("colorman");
		$d->addHSep();
		igk_add_article($this,"themes.colormanager.description", $d);
		$d->addHSep();
		$d->add(new IGKHtmlSearchItem($this->getUri("searchcolor"), $this->m_searchColor,"qcl"));

		$frm = $d->addForm();
		$frm["action"]=$this->getUri("changecl");




		igk_notify_sethost($frm->addDiv());

		//post posed script
		$frm->addLineWaiter();
		$u = $this->getUri("colorList_ajx");
		$frm->addScript()->Content  = <<<EOF
(function(){
	var q  = \$igk(igk.getParentScript());

	igk.ready(function(){
		igk.ajx.post('$u', null, function(xhr){
			if (this.isReady()){
				q.setHtml(xhr.responseText);
				igk.ajx.fn.initnode(q.o);
			}
		});
	});
})();
EOF;
			// $d->addHSep();
		$this->__add_cl_cnf_btn($frm, $this);

	}
	public function colorList_ajx($frm=null, $render=1){
		//get colors
		$colors = igk_getv($this->App->Doc->Theme->getElementsByTagName("Colors"),0);
		if ($frm == null)
			$frm = igk_createNode();
		$tab = $frm->addTable()->setClass("fitw");
		if (igk_sys_getconfig("BootStrap.Enabled"))
			$tab["class"] = "table table-striped";
		$ctab = $colors->Attributes->ToArray();

		$stab = array_keys($ctab);
		igk_usort($stab, "igk_key_sort");
		$tr = $tab->addTr();
		IGKHtmlUtils::AddToggleAllCheckboxTh($tr);

		$tr->add("th", array("class"=>"fitw-2"))->Content = R::ngets(IGK_FD_NAME);
		$tr->add("th", array("class"=>"fitw-2"))->Content = R::ngets("clValue");
		$tr->add("th")->Content = IGK_HTML_SPACE;
		$tr->add("th")->Content = IGK_HTML_SPACE;

		foreach($stab as $k)
		{
			if (($this->m_searchColor) && !strstr($k, $this->m_searchColor) )
				continue;
				$v = IGKHtmlUtils::GetValue($ctab[$k]);

				$tr = $tab->addTr();
				$tr->addTd()->add("input", array("type"=>"checkbox"));
				$tr->addTd()->Content = $k;
				$tr->addTd()->Content = $v;
				$tr->addTd()->add($this->_newColorBox(igk_css_treatcolor($colors, $v, true),array(
				"href"=>igk_js_post_frame($this->getUri("editColor&n=".$k."&cl=".urlencode($v))))));
				IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("dropcolor&n=".$k), "drop_16x16");

		}
		$frm->addBr();
		$this->__add_cl_cnf_btn($frm, $this);
		igk_html_toggle_class($tab);
		if (igk_app()->Session->URI_AJX_CONTEXT){
			$frm->RenderAJX();
		}
		return $frm;
	}
	public function editColor(){
		$n = urldecode(igk_getr("n"));
		$cl = igk_getr("cl");
		$frm = $this->addnewcolorframe( $n, $cl);
		$frm->RenderAJX();
		igk_exit();
	}
	public function addnewcolorframe($name=null, $color=null){
		$frame = igk_add_new_frame($this, "theme_addcolor", "#colorman",$this->App->Doc->body);
		$edit = $name !=null;
		if (!$edit)
			$frame->Title = R::ngets("title.addColorTheme");
		else
			$frame->Title = R::ngets("title.editColorTheme");
		$frame->ClearChilds();
		$d = $frame->BoxContent;
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("addColorThemeKey#colorman");
		$ul = $frm->add("ul");
		$ul->addLi()->addSLabelInput(IGK_FD_NAME,  "text", $name);
		$ul->addLi()->addSLabelInput("clColor",  "text", $color);
		if ($edit)
			$ul->addLi()->addInput("clEdit", "hidden", true);
		$frm->addBtn("btn_add", $edit? R::ngets("btn.Edit") :R::ngets("btn.Add"));
		return $frame;
	}
	public function addColorThemeKey(){
		$cl = igk_getr(IGK_FD_NAME);
		$cv = igk_getr("clColor");
		if (!empty($cl))
		{
			$this->App->Doc->Theme->addColor($cl, $cv);
			igk_notifyctrl()->addMsg("Color modifier ".$cl." = ".$cv);
			if (igk_getr("clEdit"))
			{
				$this->View();
				igk_frame_close("theme_addcolor");
			}
		}
		$this->View();
	}
	public function dropcolor(){
		$cl = igk_getr("n");
		$this->App->Doc->Theme->removeColor($cl);
		$this->View();

	}
	private function _newColorBox($cl, $attribs =null, $width=16, $height=16){
		$box =  igk_createNode("a")->AppendAttributes(array("class"=>"color_view nodecoration dispib", "style"=>
"width:".$width."px; height:".$height."px; background-color:".$cl.";"));
		$box->AppendAttributes($attribs);
		$box->Content = " ";
		return $box;
	}
	public function searchcolor(){
		$this->m_searchColor = igk_getr("qcl");
		$this->View();
	}


	//--------------------------------------------------
	//RES FUNCTION
	//--------------------------------------------------
	private function _showRes(){
		$d = $this->TargetNode;

		igk_html_add_title($d, R::ngets("title.resManager"));
		$d->addSeparator();
		$d->add(new IGKHtmlSearchItem($this->getUri("searchres"),$this->m_searchRes,"qres"));
		$frm = $d->addForm();
	}
	public function searchres(){
	$this->m_searchRes = igk_getr("qres");
		$this->View();
	}
	private function _themeFormControl($frm)
	{
		IGKHtmlUtils::AddBtnLnk($frm, "btn.Add" , igk_js_post_frame($this->getUri("theme_addKeyFrame_ajx")));
		IGKHtmlUtils::AddBtnLnk($frm, "btn.deleteallempty" , igk_js_post_frame($this->getUri("theme_deleteall_emptyclass_ajx")));
	}
	public function theme_deleteall_emptyclass_ajx(){
		if (igk_qr_confirm())
		{

			$tab = $this->App->Doc->Theme->def->Attributes->ToArray();
			$out = array();
			foreach($tab as $k=>$v)
			{
				if (empty($v)){
					$this->App->Doc->Theme[$k] = null;
					IGKThemeCtrl::UnRegClass($k);

					continue;
				}
				$out[$k] = $v;
			}

			$this->App->Doc->Theme->def->Attributes->Clear();
			$this->App->Doc->Theme->setAttributes($out);
			igk_getctrl(IGK_THEME_CTRL)->saveTheme();
			$this->View();
			//igk_navtocurrent();
		}
		else{
			$frame = igk_frame_add_confirm($this,__FUNCTION__, $this->getUri(__FUNCTION__));
			$frame->RenderAJX();
		}
	}
	public function theme_addKeyFrame_ajx(){

		$frame= igk_add_new_frame($this, "theme_addkey", "#class_editor"); //igk_getctrl(IGK_FRAME_CTRL)->createFrame("theme_addkey", $this, "#class_editor");

		$frame->Title = R::ngets("title.AddClass");
		$d = $frame->BoxContent;
		$frame->ClearChilds();
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("theme_addKey");
		$frm->addLi()->addSLabelInput(IGK_FD_NAME);
		$frm->addLi()->addSLabelInput("clValue");
		$frm->addHSep();
		$frm->addBtn("btn_add", R::ngets("btn.Add"));

		$frame->RenderAJX();
	}

	public function search($searchkey=null){
		$q = igk_getr("q",$searchkey);


		if (empty($q))
		{
			$this->m_search = null;
			$this->m_searchkey = null;
			$this->View();
			return;
		}
		$tab = $this->App->Doc->Theme->def->Attributes->ToArray();
		$out = array();
		foreach($tab as $k=>$v)
		{
			if (strstr($k, $q))
			{
				$out[$k]=$v;
			}
		}
		$this->m_search = $out;
		$this->m_searchkey = $q;
		$this->View();
	}
	public function update_name(){
		$n = igk_getr("theme_name", "default");
		$this->App->Doc->Theme->Name = $n;
		$this->View();
	}
	//--------------------------------------------------
	//CSS CLASS KEYS FUNCTION
	//--------------------------------------------------
	public function theme_rmkey($key=null){
		$key = ($key == null)? base64_decode(igk_getr("id")) : $key;
		if (!empty($key))
		{
			$this->App->Doc->Theme[$key] = null;
			IGKThemeCtrl::UnRegClass($key) ;
			igk_getctrl(IGK_THEME_CTRL)->saveTheme();
			$this->search($this->m_searchkey);
			$this->View();
		}
	}
	//search all available keys that match the "t" pattern
	public function theme_findkey_ajx(){
		$t = igk_getr("t");
		if ($t == null){
			return;
		}
		$tab = $this->App->Doc->Theme->def->Attributes->ToArray();
		$out = array();
		$rep =  igk_createNode("response");
		$keys = array_keys($tab);
		sort($keys);

		foreach($keys as $k)
		{
			$v = $tab[$k];
			if (strstr($k, $t))
			{
				$rep->add("item", array("name"=>$k))->Content = $v;
			}
		}
		$rep->RenderAJX();
	}
	protected function initTargetNode(){
		$t =  igk_createNode("div")->AppendAttributes( array("class"=>strtolower($this->getName())));
		return $t;
	}

	public function getConfigPage(){return "themectrlconfig";}
	

	private function getCssDataFile()
	{
		return igk_io_currentRelativePath(IGK_DATA_FOLDER."/StylesData.xml");
	}
	public function themeCurrentMedia()
	{
		if(IGKUserAgent::IsIE())return "ie";
		if(IGKUserAgent::IsMod())return "mod";
		if(IGKUserAgent::IsChrome()) return "chr";
		if(IGKUserAgent::IsSafari()) return "saf";
		if(IGKUserAgent::IsAndroid())return "android";
		if(IGKUserAgent::IsIOS())return "ios";
		return "ie";
	}
	public function themeIsSupportMedia($target)
	{
		if ($target=="*")return true;
		if (strstr($target, $this->themeCurrentMedia()))
			return true;
		return false;
	}
	private function themeLoadCssFiles()
	{
		$this->m_cssFileTable = array();
		$t =  IGKHtmlItem::LoadNode(IGKIO::ReadAllText($this->getCssDataFile()));

		if (($t!=null) && ($t->HasChilds))
		{

			foreach($t->Childs as $k=>$v)
			{
				$k = igk_html_uri($v["file"] );
				if ($this->themeAddCss($k, $v["target"], $v["block"]))
				{
					if (!igk_is_debuging())
					{
						$this->app->Doc->addStyle($k);
					}
				}
			}
		}
	}
	private function themeAddCss($file, $device="ie" , $block=false)
	{
		if (!isset($this->m_cssFileTable[$file]))
		{
			$v_cssObj = new StdClass;
			$v_cssObj->Uri = $file;
			$v_cssObj->Target = $device;
			$v_cssObj->Block = $block;
			$this->m_cssFileTable[$file] = $v_cssObj;
			return true;
		}
		return false;
	}
	///add css file to system
	public function themeAddCssFile($file, $device="ie")//supported device all, ie, mod, android, ios
	{
		if ($this->themeAddCss(igk_html_uri($file), $device))
		{
			$this->themeSaveCssData();
		}
	}
	function themeSaveCssData()
	{
		$o =  igk_createNode("cssData");
		foreach($this->m_cssFileTable as $k=>$v)
		{
			$css = $o->add("css");
			$css["file"] = $v->Uri;
			$css["target"] = $v->Target;
			$css["block"] = $v->Block;
		}
		igk_io_save_file_as_utf8($this->getCssDataFile(), $o->Render());
	}
	public function themeGetCss()
	{
		$t = IGK_STR_EMPTY;
		foreach($this->m_cssFileTable as $k=>$v)
		{
			if ( !$v->Block && $this->themeIsSupportMedia($v->Target))
			{
				$t .=IGK_START_COMMENT." ". $k. IGK_END_COMMENT."\n";
				$t .= IGKIO::ReadAllText(igk_io_currentRelativePath($k))."\n";
			}
		}
		return $t;
	}
	public function themeShowCssFiles()
	{
		$t =  igk_createNode("table");
		$t["class"]="fitw";

		$b =  array("style"=>"width:16px;");
		$tr = $t->addTr();
		$tr->add("th", $b)->addSpace();
		$tr->add("th");
		$tr->add("th");
		$tr->add("th", $b)->addSpace();
		$tr->add("th", $b)->addSpace();
		$tr->add("th", $b)->addSpace();
		foreach($this->m_cssFileTable as $k=>$v)
		{
			$tr = $t->addTr();
			$tr->add("td", $b)->addSpace();
			$tr->addTd()->add("a", array("href"=>$this->getUri("themeDownloadCssFile&n=".base64_encode($k))))->Content = $v->Uri;
			$tr->addTd()->Content = $v->Target;

			IGKHtmlUtils::AddImgLnk($tr->addTd(),igk_js_post_frame($this->getUri("themeEditFile_ajx&n=".base64_encode($k))), "edit_16x16", "16px", "16px","dropCSS File" );
			IGKHtmlUtils::AddImgLnk($tr->addTd(),$this->getUri("themeBlockCssFile&n=".base64_encode($k)),$v->Block? "block": "unblock", "16px", "16px","dropCSS File" );
			IGKHtmlUtils::AddImgLnk($tr->addTd(),$this->getUri("themeDropFile&n=".base64_encode($k)), "drop_16x16", "16px", "16px","dropCSS File" );

		}
		$this->TargetNode->add($t);
		//actions button div
		$t =  igk_createNode("div");
		//9
		IGKHtmlUtils::AddBtnLnk($t, "btn.addCssFile", igk_js_post_frame($this->getUri("themeAddNewCssFile_ajx")));
		$this->TargetNode->add($t);
	}
	public function themeAddNewCssFile_ajx()
	{
		//$t =  igk_createNode("div");
		//$t->Content  = "Add New Css File Not Implement";


		$frame = igk_add_new_frame($this, "frame_themeAddNewCssFile");
		$frame->ClearChilds();
		$frame->Title = R::ngets("title.addCssFile");
		$d = $frame->BoxContent;
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("themeAddCssFileFunc");
		$ul = $frm->add("ul");
		$ul->addLi()->addInput(IGK_FD_NAME, "text", "newfile");
		$sl = $ul->addLi()->add("select");
		$sl["id"]=$sl["name"]="clFor";
		$sl->add("option")->Content = "ie";
		$sl->add("option")->Content = "mod";

		$frm->addHSep();
		$frm->addBtn("btn_update", R::ngets("btn.add"));
		if (igk_is_ajx_demand())
		{
			$frame->RenderAJX();
		}

		//$t->RenderAJX();
	}
	public function themeAddCssFileFunc()
	{
		$n = igk_getr(IGK_FD_NAME, null);

		if ($n && preg_match("/([a-zA-Z_][a-zA-Z0-9_]+)/i", $n) )
		{
			$f = igk_io_currentRelativePath("Styles/".$n.".css");
			igk_io_save_file_as_utf8($f, IGK_START_COMMENT." ".$n." ".IGK_END_COMMENT, true);
			igk_frame_close("frame_themeAddNewCssFile");
			$this->themeAddCssFile(igk_html_uri(igk_io_basePath($f)),  igk_getr("clFor","ie"));
			$this->View();
		}
	}
	public function themeBlockCssFile()
	{
		$n = base64_decode(igk_getr("n"));
		if (!isset($this->m_cssFileTable[$n]))
		{
			return;
		}
		$this->m_cssFileTable[$n]->Block = !$this->m_cssFileTable[$n]->Block;
		$this->themeSaveCssData();
		$this->View();
	}
	public function themeEditFile_ajx()
	{
		$n = base64_decode(igk_getr("n"));
		if (!isset($this->m_cssFileTable[$n]))
		{
			igk_wl("ERROR: no file to edit");
			return;
		}
		$p = $this->m_cssFileTable[$n];
		$f = igk_io_currentRelativePath($p->Uri);

		if(file_exists($f))
		{
		$frame = igk_add_new_frame($this, "frame_themeEditFile");
		$frame->ClearChilds();
		$frame->Title = R::ngets("title.editCssFile", basename($n));
		$str = IGKIO::ReadAllText($f);
		$d = $frame->BoxContent;
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("themeUpdateCssFile");
		$ul = $frm->add("ul");
		$txt = $ul->addLi()->addTextArea("clContent", $str);
		$txt["class"] = "frame_textarea";
		$frm->addInput("clfile", "hidden", base64_encode($n));
		$frm->addInput("clframe", "hidden", $frame["id"]);
		$frm->addBtn("btn_update", R::ngets("btn.Update"));

		if (igk_is_ajx_demand())
		{
			$frame->RenderAJX();
		}
		}
		else{
			igk_wl("ERROR: FILE NOT EXISTS");
		}
	}
	public function themeUpdateCssFile()
	{
		$n = base64_decode(igk_getr("clfile"));
		if (!isset($this->m_cssFileTable[$n]))
		{
			return;
		}
		igk_io_saveContentFromTextArea(igk_io_currentRelativePath($n), igk_getr("clContent"), true);
		igk_frame_close("frame_themeEditFile");
	}
	public function themeDropFile()
	{
		$n = base64_decode(igk_getr("n"));
		if (isset($this->m_cssFileTable[$n]))
		{
			@unlink(igk_io_currentRelativePath($n));
			unset($this->m_cssFileTable[$n]);
			$this->themeSaveCssData();
			$this->View();
		}
	}


}


///<summary>represent a frame controller</summary>
final class IGKFrameDialogCtrl extends IGKControllerBase
implements IIGKFrameController
{
	private $m_frames;
	public function getName(){return IGK_FRAME_CTRL;}


	public function __construct(){
		parent::__construct();
		$this->m_frames = array();
	}
	public function View(){
	//notion to view
	}
	public function closeAllFrame(){
		$c = array_keys($this->m_frames);
		$i =0;
		foreach($c as $k=>$v){
			igk_frame_close($v);
			$i++;
		}
		igk_navtocurrent();
	}
	public function ContainFrame($id, $frame, $remove=true)
	{
		if (isset($this->m_frames[$id]))
		{
			if ($frame !== $this->m_frames[$id])
			{
				igk_wln("contains but not same handle $id");
				if ($remove){
					igk_wln("unset frame");
					unset($this->m_frames[$id]);
					return true;
				}
				return false;
			}
			return true;
		}
		else{
			//free frame
		}
		return false;
	}

	public function createFrame($id, $owner, $closeuri=null, $reloadcallback = null){
		if (($id == null ) ||!is_string($id))
			return null;

		if ( isset($this->m_frames[$id]))
		{
			$v_dial =  $this->m_frames[$id];
			$b = $v_dial->getOwner();;
			if ($b === $owner)
				return $v_dial;
		}
		$v_dial = new IGKMsDialogFrame($this, $id, $owner, $reloadcallback);
		$v_dial->ClearChilds();
		$cluri = null;
		if ($closeuri){
			$cluri = "&closeuri=".urlencode($closeuri);
		}
		else{
			$cluri="&navigate=1";
		}

		$v_dial->setCloseUri($this->getUri("closeFrame&id=".$id.$cluri));
		$v_dial["id"] = $id;
		$this->m_frames[$id]= $v_dial;
		return $v_dial;
	}
	public function getFrame($id)
	{
		if ( isset($this->m_frames[$id]))
		{
			return $this->m_frames[$id];
		}
		return null;
	}

	public function close_frame_ajx()
	{
		$href = base64_decode(igk_getr("href"));
		$tag = igk_getquery_args($href);
		$this->closeFrame(igk_getv($tag, "id"));
		igk_wl( $this->App->Doc->body->Render());
		igk_exit();

	}
	public function closeFrame_ajx()
	{
		$id = igk_getr("id");
		igk_frame_close($id);
	}
	// public function closeFrame_ajx()
	// {
		// $this->closeFrame();
	// }
	///<summary > close frame by id
	public function closeFrame($id=null, $navigate = null){
		$v_id = ($id!=null)? $id :igk_getr("id",0);
		$closeuri = null;
		$navigate = $navigate ===null? igk_getr("navigate", false): $navigate;

		if (isset($this->m_frames[$v_id]))
		{
			$frame = $this->m_frames[$v_id];
			$args = igk_getquery_args($frame->closeUri);
			if (($closeuri = urldecode(igk_getr("closeuri")))==null)
				$closeuri = urldecode(igk_getv($args, "closeuri"));
			igk_html_rm($frame);
			if (method_exists(get_class($frame->Owner), "frameClosed"))
			{
				$frame->Owner->frameClosed();
			}
			//call the closed method
			$frame->closeMethod();
			$frame->Dispose();
			//unset frame id
			unset($this->m_frames[$v_id]);
			//unset frame
			unset($frame);
		}
		else {
			igk_debug_wln("Frame not found [".$v_id."]");
			return;
		}

		if (!igk_is_ajx_demand() ){

			if ($closeuri)
			{
				//igk_navtocurrent($closeuri);
				igk_navtocurrent($closeuri);
				//igk_wln("close uri ".$closeuri);
				igk_exit();
			}
			else if ($navigate)
			{
				igk_navtocurrent();
				igk_exit();
			}
		}
	}
	public function IsFrameAvailable($id)
	{
		return isset($this->m_frames[$id]);
	}
}


//page  controlleurs
final class IGKPageManagerCtrl extends IGKConfigCtrlBase
{
	private $m_oldpage;

	public function __construct()
	{
		parent::__construct();
		$this->m_oldpage = null;
	}
	public function getIsVisible(){
		return true;
	}
	protected function initTargetNode()
	{
		$t =  igk_createNode("div");
		$t["class"]="igk-web-pageinfo";
		return $t;
	}
	protected function InitComplete(){
		parent::InitComplete();
		//::register page change event
		$this->App->addCurrentPageEvent($this, "View");
	}
	public function View(){
		//view Configs
		if ($this->getIsVisible())
		{

			switch ($this->CurrentPageFolder)
			{
				case IGK_CONFIG_PAGEFOLDER:
					$this->App->Doc->body["class"] = "-".$this->m_oldpage;
					$this->_viewConfig();
					break;
				default:
					$this->_showPage();
					break;
			}
		}
		else {
			igk_html_rm($this->TargetNode);
		}

	}
	private function _showPage()
	{
		$page = igk_getctrl(IGK_MENU_CTRL)->CurrentPage;
		$t = $this->TargetNode;
		$t->ClearChilds();
		$dir = $this->getPageFolderFullPath ();

		$file = igk_io_dir($dir."/".$page.".".R::GetCurrentLang().".phtml");
		if ($this->App->CurrentPageFolder == IGK_CONFIG_MODE)
		{
			return;
		}
		//add page node always at the top
		igk_html_add($this->TargetNode, $this->App->Doc->body,-500);
		$this->App->Doc->body["class"] = "-".$this->m_oldpage;
		$this->m_oldpage = $page;
		$this->App->Doc->body["class"] = "+".$this->m_oldpage;
		// if(file_exists($file))
		// {
			// //...
			// igk_debug_wln("BindPageInfo");
			// //$v_str = igk_html_bind_content($this, igk_io_read_allfile($file));
			// //$t->Load($v_str);
		// }
	}
	private function _viewConfig(){
		if ( $this->ConfigCtrl->SelectedConfigCtrl !== $this)
			return;
		$this->ConfigNode->ClearChilds();
		$div =  igk_createNode("div");
		igk_html_add($div, $this->ConfigNode);


		$node = $div;
		$this->addTitle($node, "title.PageManagerEditor");
		$node->addHSep();
		igk_add_article($this,"page.description", $node->addDiv());
		$node->addHSep();

		$node->addDiv()->addLabel()->Content = "CurrentLang : ". R::GetCurrentLang();
		$frm = $node->addForm();

		//get page list
		$p = igk_getctrl(IGK_MENU_CTRL)->getPageList();

		$tab = $frm->addTable();
		$tab["class"] ="igk-table igk-table-hover" ;
		$tr = $tab->addTr();
		$tr->add("th", array("style"=>"min-width:200px"))->Content = R::ngets(IGK_FD_NAME);
		$tr->add("th")->Content = IGK_HTML_SPACE;
		$tr->add("th")->Content = IGK_HTML_SPACE;
		foreach($p as $k)
		{
			$tr = $tab->addTr();
			$tr->addTd()->add("a" ,array("href"=>$this->getUri("getfile&n=".$k)))->Content = $k;
			IGKHtmlUtils::AddImgLnk($tr->addTd(),$this->getUri("editPageFrame&name=".$k), "edit_16x16", "16px", "16px","editpage" );
			IGKHtmlUtils::AddImgLnk($tr->addTd(),$this->getUri("editPageFrameWTiny&name=".$k), "tiny_16x16", "16px", "16px","editpage" );
		}
	}
	public function editPageFrame($wtiny=false)
	{
		$n = igk_getr("name");
		$frm = igk_getctrl(IGK_FRAME_CTRL)->createFrame("page_editframe", $this);
		IGKHtmlUtils::AddItem($frm,  $this->App->Doc->body);
		$frm->Title = R::ngets("title.editpage_1", $n);
		$d = $frm->Box;
		$frm->ClearChilds();
		$frm = $d->addForm();
		$frm["action"]=$this->getUri("savePage");
		$frm->addLi()->addLabel()->Content =IGK_STR_EMPTY ;
		$frm->addInput("name", "hidden", $n);
		$file = $this->getPageFile($n);
		$area = $frm->addLi()->addTextArea("clContent", file_exists($file)? IGKIO::ReadAllText($file):null );
		if ($wtiny)
			igk_js_enable_tinymce($frm, "clContent");

		$frm->addBtn("btn_save", R::ngets("btn.Update"));
	}
	public function editPageFrameWTiny()
	{
		$this->editPageFrame(true);
	}
	public function getPageFile($n)
	{
		$dir = $this->getPageFolderFullPath ();
		$file =  igk_io_dir($dir."/".$n.".".R::GetCurrentLang().".phtml");
		return $file;
	}
	public function get_file(){
		$n = igk_getr("n");
		$file = $this->getPageFile($n);
		if (file_exists($file))
		{
			igk_download_file(basename($file), $file);
		}
		else{
			igk_notifyctrl()->addError("impossible d'obtenir le fichier ".basename($file));
		}
	}
	private function getPageFolderFullPath(){
		return igk_io_basePath(IGK_PAGE_FOLDER);
	}
	public function savePage(){
		//save content with tiny in utf8 without bom
		$n = igk_getr("name");
		$content = igk_getr("clContent");
		$dir = $this->getPageFolderFullPath();

		IGKIO::CreateRDir($dir);
		$file = igk_io_dir($dir."/".$n.".".R::GetCurrentLang().".phtml");
		$out = igk_html_unscape( $content);
		igk_io_save_file_as_utf8($file, $out, true);
		igk_frame_close("page_editframe");
	}

	public function getConfigPage(){return "pageconfig";}
	
}


///---------------------------------------------------------------------------------------------------
///USER CONTROLS
///---------------------------------------------------------------------------------------------------

///<summary>used to store and manage global  user's group </summary>
final class IGKUserGroupController extends IGKNonVisibleControllerBase
{
	public function getDataTableName(){return IGK_TB_USERGROUPS; }
	public function getDataTableInfo(){	//user group
	return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_ID, IGK_FD_TYPE=>"Int","clAutoIncrement"=>true,IGK_FD_TYPELEN=>10, "clIsUnique"=>true, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_USER_ID, IGK_FD_TYPE=>"Int", IGK_FD_TYPELEN=>10,
		//"clIsIndex"=>true,
		"clIsUniqueColumnMember"=>true ,
		"clColumnMemberIndex"=>1,
		"clLinkType"=>IGK_TB_USERS)),
		new IGKdbColumnInfo(array(
		IGK_FD_NAME=>IGK_FD_GROUP_ID, IGK_FD_TYPE=>"Int", IGK_FD_TYPELEN=>10,
		//"clIsIndex"=>true,
		"clIsUniqueColumnMember"=>true ,
		"clColumnMemberIndex"=>1,
		"clLinkType"=>IGK_TB_GROUPS ))
		);
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	protected function initDataEntry($db, $tbname=null){
		$n = $this->DataTableName;
		$db->insert($n, array(IGK_FD_USER_ID=>1, IGK_FD_GROUP_ID=>2));
	}

}

///<summary>used to store and manage global group </summary>
final class IGKGroupController extends IGKConfigCtrlBase
{
	private $selectedGroup;
	public function getConfigPage(){return "groupconfig";}
	
	public function getConfigCategory(){
		return "management";
	}

	//manage only one table
	public function getDataTableName(){return IGK_TB_GROUPS; }
	///<summary>get group table definition</summary>
	public function getDataTableInfo(){//groups
	return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_ID, IGK_FD_TYPE=>"Int","clAutoIncrement"=>true,IGK_FD_TYPELEN=>10, "clIsUnique"=>true, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255, "clIsUnique"=>true , "clNotNull"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_DESC, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>150))
		);
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	protected function initDataEntry($db, $tbname=null)
	{
		$n = $this->DataTableName;
		$db->insert($n, array(IGK_FD_NAME=>"users"));
		$db->insert($n, array(IGK_FD_NAME=>"administrator"));
	}
	public function View(){
		$this->TargetNode->ClearChilds();
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}
		$this->_showConfig();
	}
	public function group_default_view(){
		$this->CurrentView = null;
		$this->View();
	}
	private function _showConfig()
	{
		igk_html_add($this->TargetNode, $this->ConfigNode);
		$node = $this->TargetNode;
		igk_html_add_title($node->addDiv(), "title.Groups");
		$node->addHSep();
		$node->addPanelBox()->addArticle($this,"group.description");
		$node->addHSep();
		switch($this->CurrentView)
		{
			case "viewusers":
				//VIEW:UserGroups
				$d = $node->addDiv();

				$id = igk_getr("clId");
				$group = $this->selectedGroup==null ?  igk_db_table_select_row(IGK_TB_GROUPS, $id) : $this->selectedGroup;

				if($group == null)
				{
					$this->CurrentView = null;
					$this->View();
					igk_exit();
				}

				$d->addDiv()->addSectionTitle(5)->Content = R::ngets("title.group_1", $group->clName);

				$d = $node->addDiv();
				IGKHtmlUtils::AddImgLnk($d, $this->getUri("group_default_view"), "back_48x48", "48px", "48px");
				igk_notify_sethost($d->addDiv());
				$options = $d->addDiv();
				$users = igk_db_table_select_where(IGK_TB_USERS, null);

				$tb = $d->addDiv()->addTable();
				$tb["class"] = "igk-table-hover";
				$r = igk_db_table_select_where(IGK_TB_USERGROUPS,array(IGK_FD_GROUP_ID=>$group->clId));
				$tb->setHeader(IGK_STR_EMPTY,
				R::ngets(IGK_FD_NAME), IGK_STR_EMPTY);
				if ($r && $r->HasRow){
					$max = 10;
					foreach($r->Rows as $k=>$v){
					$r = $tb->addRow();
					$u = igk_db_table_select_row(IGK_TB_USERS, array("clId"=>$v->clUser_Id));
							if ($u){
						$r->addTd()->addInput("clUsers[]", "checkbox", $u->clId);
						$td = $r->addTd();
						$td->addspan()->Content = $u->clLogin;
						$td->addspan()->setClass("fts-i")->Content = "(". igk_user_fullname($u) .")";
						IGKHtmlUtils::AddImgLnk($r->addTd(), $this->getUri("group_remove_user&clId=".$v->clId), "drop_16x16");
						}

						$max--;
						if($max<=0)
							break;
					}
					if ($max==0){
						//paginate
					}
				}
				else{
					$d->addDiv()->Content = "No Rows";
				}
				$frm = $options->addForm();
				$frm["action"] = $this->getUri("group_add_userto_group");
				$p = $frm->addSelect(IGK_FD_USER_ID);
				if ($users){
				foreach($users->Rows as $k=>$v){
					if ($v->clLastName == "IGKSystem"){
						continue;
					}
					$p->add("option")->setAttribute("value", $v->clId)->Content = igk_user_fullname($v) . " (<i>".$v->clLogin."</i>)";
				}
				}
				$frm->addInput(IGK_FD_GROUP_ID, "hidden", $this->selectedGroup? $this->selectedGroup->clId:null);
				// $bar = $frm->addActionBar();
				// IGKHtmlUtils::AddImgLnk($bar->addSpan()->setClass("igk-btn"), "javascript: \$igk(this).getParentByTagName('form').submit(); return false;",  "add_16x16");
				IGKHtmlUtils::AddImgLnk($frm->addspan(), "javascript: \$igk(this).getParentByTagName('form').submit(); return false;",  "add_16x16");
				$this->selectedGroup = $group;
			break;
			default:
				//VIEW:Groups

				$frm = $node->addForm();
				$table = $frm->addDiv()->setClass("overflow-x-a")->addTable();
				$table["class"]="igk-table";
				$tr = $table->addTr();
				$tr->add("th", array("style"=>"width:16px;"))->addSpace();
				$tr->add("th", array("class"=>"fitw"))->Content = R::ngets("lb.clName");
				$tr->add("th", array("class"=>"fitw"))->Content = R::ngets("Users");
				$tr->add("th", array("style"=>"width:16px;"))->Content = IGK_HTML_SPACE;
				$tr->add("th", array("style"=>"width:16px;"))->Content = IGK_HTML_SPACE;
				// $tr->add("th", array("style"=>"width:16px;"))->Content = IGK_HTML_SPACE;
				$e = $this->getDbEntries();
				if ($e && ($e->RowCount>0))
				foreach($e->Rows as $k=>$v)
				{
					$tr = $table->addTr();
					$tr->addTd()->addInput("r", "checkbox", $v->clId);// = IGK_HTML_SPACE;
					$tr->addTd()->Content = $v->clName;
					$tr->addTd()->Content = "0";
					//IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("group_view_auth&clId=".$v->clId),"auth");
					IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("group_view_user&clId=".$v->clId),"user_16x16");
					$td = $tr->addTd();
					IGKHtmlUtils::AddImgLnk($td, igk_js_post_frame($this->getUri("group_dropgroup_ajx&clId=".$v->clId)),"drop_16x16")->setAlt("drop group");
					// $td->addToolTip()->Content = "drop group";
				}
				$frm->addHSep();
				$v_ackdiv = $frm->addDiv();
				//IGKHtmlUtils::AddImgLnk($v_ackdiv, igk_js_post_frame($this->getUri("group_add_group_ajx")), "add_16x16");

				$bar = $frm->addActionBar();
				$bar->setStyle("background-color:#ddd;");
				IGKHtmlUtils::AddImgLnk($bar->addSpan()->setClass("igk-btn"),  igk_js_post_frame($this->getUri("group_add_group_ajx")),  "add_16x16");
			break;
		}

	}
	///<summary>return an array of authorisation that this user support</summary>
	public function getUserAuths($u){
		$ad = igk_get_data_adapter($this);
		if (!$ad->connect())
			return null;
		$t = array();
		$c = igk_db_table_select_where(IGK_TB_AUTHORISATIONS, null, $this);
		if ($c && $c->Success)
		{

			foreach($c->Rows as $k=>$v){
				if ($u->IsAuthorize($v->clName)){
					$t[$v->clId] = $v->clName;
				}
			}
		}
		$ad->close();
		return $t;
	}
	public function addAuthToGroup($groupname, $n){
		//if conf
		// if (!igk_is_conf_connected())
			// return false;
		$ad = igk_get_data_adapter($this);
		if (!$ad->connect())
		{
			return false;
		}

		$gid = igk_db_table_select_where(IGK_TB_GROUPS,
			array(IGK_FD_NAME=>$groupname),$this)->getRowAtIndex(0);
		if (!$gid)
			return false;

		$auth = igk_db_table_select_where(IGK_TB_AUTHORISATIONS,
			array(IGK_FD_NAME=>$n),$this)->getRowAtIndex(0);
		if (!$auth)
			return false;

		$b = array(
				"clGroup_Id"=>$gid->clId,
				"clAuth_Id"=>$auth->clId
				);
		$h = igk_db_table_select_where(IGK_TB_GROUPAUTHS, $b, $this);
		$s  = 0;

		if (!$h || ($h->RowCount == 0)){
		$obj = igk_db_create_row(IGK_TB_GROUPAUTHS);
		$obj->clGroup_Id =$gid->clId;
		$obj->clAuth_Id = $auth->clId;
		$obj->clGrant = 1;


		// igk_wln("table info");
		// igk_wln();


		$s = igk_db_insert_if_not_exists($this, IGK_TB_GROUPAUTHS, $obj);
		}
		$ad->close();
		return $s;


	}
	///<summary>return an array of groups that this user is member of</summary>
	public function getUserGroups($u){
		$ad = igk_get_data_adapter($this);
		if (!$ad->connect())
			return;
		$gid = igk_db_table_select_where(IGK_TB_USERGROUPS,
			array(IGK_FD_USER_ID=>$u->clId),$this);
		$t = array();
		if ($gid && $gid->Success)
		{
			foreach($gid->Rows as $k=>$v){
				$g = $ad->select(IGK_TB_GROUPS, array(IGK_FD_ID=>$v->clGroup_Id))->getRowAtIndex(0);
				$t[$v->clGroup_Id]= $g->clName;
			}
		}
		$ad->close();
		return $t;
	}
	public function addUserToGroup($groupname, $u){
		if (empty($groupname) || !$u)return false;
		$ad = igk_get_data_adapter($this);
		if (!$ad->connect())
		{
			return false;
		}

		$gid = igk_db_table_select_where(IGK_TB_GROUPS,
			array(IGK_FD_NAME=>$groupname),$this)->getRowAtIndex(0);

		if ($gid == null){
			//insert group
			$gid = igk_db_create_row(IGK_TB_GROUPS);
			$gid->clName = $groupname;
			if (igk_db_insert($this,IGK_TB_GROUPS, $gid)){
				$gid->clId = $ad->getlastId();
			}
			else{
				$ad->close();
				return false;
			}
		}
		$b = array(
				IGK_FD_USER_ID=>$u->clId,
				IGK_FD_GROUP_ID=>$gid->clId
				);
		$h = igk_db_table_select_where(IGK_TB_USERGROUPS, $b, $this);
		$s  = 0;

		if (!$h || ($h->RowCount == 0)){
			$s = igk_db_insert_if_not_exists(
					$this,
					IGK_TB_USERGROUPS,
					$b
			);
		}
		$ad->close();
		return $s;
	}
	public function group_add_userto_group(){
		$obj = igk_get_robj();
		if (igk_db_insert_if_not_exists($this, IGK_TB_USERGROUPS, array(IGK_FD_USER_ID=>$obj->clUser_Id, IGK_FD_GROUP_ID=>$obj->clGroup_Id))){
			igk_notifyctrl()->addMsgr("msg.group.association.success");
		}
		else{
			igk_notifyctrl()->addErrorr("e.group.association.failed");
		}
		$this->View();
	}
	public function group_remove_user(){
		igk_db_delete($this, IGK_TB_USERGROUPS, igk_getr("clId"));
		$this->View();
	}


	private function _removeGroup($id){
		igk_db_delete($this, $this->getDataTableName(), array("clId"=>$id));
		return true;
	}
	public function group_dropgroup_ajx(){
		$id = igk_getr("clId");
		if (igk_qr_confirm())
		{
			if ($this->_removeGroup($id))
			{
				igk_notifyctrl()->addMsgr("msg.group.removed");
			}
			$this->View();
			$this->TargetNode->RenderAJX();

		}
		else{
			$frame = igk_frame_add_confirm($this, "confirm_frame", $this->getUri("group_dropgroup_ajx&clId=".$id));
			$frame->Form->Div->Content = R::ngets("msg.confirmsuppression");
			$frame->Form->Div->addInput("clId", "hidden", $id);
			$frame->RenderAJX();
		}
	}
	public function group_add($n=null)
	{
		if ($n==null){
			$v = igk_get_robj();
			if($v){

				$e = igk_db_table_select_where(IGK_TB_GROUPS, array(IGK_FD_NAME=>$v->clName), $this);
				if ($e ){
					$s = $e->Success;
					if (!$s){
						//register basics group name
						igk_db_insert($this, IGK_TB_GROUPS, $v);
					}
				}

			//igk_db_insert($this, $this->getDataTableName(), $v);
			$this->View();
			}
		}
		else {
			$e = igk_db_table_select_where(IGK_TB_GROUPS, array(IGK_FD_NAME=>$n), $this);
			if ($e ){
				$s = $e->Success;
				if (!$s){
					//register basics group name
					igk_db_insert($this, IGK_TB_GROUPS, array(IGK_FD_NAME=>$n));
				}
			}
		}
	}
	public function group_add_group_ajx()
	{
		$frame = igk_add_new_frame($this, "group_add_new_frame");
		$frame->title = R::ngets("title.AddNewGroup");
		$div = $frame->BoxContent ;
		$frm = $div->addForm();
		$frm["action"] = $this->getUri("group_add");
		$ul = $frm->add("ul");
		$ul->addLi()->addSLabelInput(IGK_FD_NAME, IGK_STR_EMPTY);
		$frm->addHSep();
		$frm->addInput("btn.add", "submit", R::ngets("btn.Add"));
		$frame->RenderAJX();
	}
	public function group_view_user(){
		$this->CurrentView = "viewusers";
		$this->selectedGroup = igk_db_table_select_row(IGK_TB_GROUPS, igk_getr("clId"));
		$this->View();
	}
	public function group_view_auth(){
		$this->CurrentView = "viewauth";
		$this->View();
	}
}
///<summary>used to store and manage global group's authorisation</summary>
final class IGKGroupAuthorisations extends IGKConfigCtrlBase{
	public function getConfigCategory(){
		return "management";
	}
	public function getDataTableInfo(){//get data table name for :: IGKGroupAutorisations
		return array(
			new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_ID, IGK_FD_TYPE=>"Int","clAutoIncrement"=>true,IGK_FD_TYPELEN=>10, "clIsUnique"=>true, "clIsPrimary"=>true)),
			new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_GROUP_ID, IGK_FD_TYPE=>"Int", "clNotNull"=>true,"clIsUnique"=>0,
			"clIsUniqueColumnMember"=>1,
			"clColumnMemberIndex"=>1,
			IGK_FD_TYPELEN=>10 , "clLinkType"=>IGK_TB_GROUPS )),
			new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_AUTH_ID, IGK_FD_TYPE=>"Int","clNotNull"=>true, "clIsUnique"=>0,
			"clIsUniqueColumnMember"=>1,
			"clColumnMemberIndex"=>1,
			IGK_FD_TYPELEN=>10 , "clLinkType"=>IGK_TB_AUTHORISATIONS )),
			new IGKdbColumnInfo(array(IGK_FD_NAME=>"clGrant", IGK_FD_TYPE=>"Int","clNotNull"=>true, IGK_FD_TYPELEN=>10, "clDescription"=>"Grant access depending on the authorization usage")),
		);
	}
	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableName(){return IGK_TB_GROUPAUTHS; }
	public function getConfigPage(){return "groupauth";}
	
	public function IsUserAuthorized($s, $actionName, $authTable= IGK_TB_AUTHORISATIONS, $userGroupTable=IGK_TB_GROUPAUTHS){
		if (($s == null) || empty($actionName))
			return false;
		if ($s->clLevel == -1)
			return true;//administrator have all access

		return igk_db_is_user_authorized($s, $actionName, $authTable, $userGroupTable);
    }

	public function auth_check_auth(){
		$id = igk_getr("clUser");
		$auth = igk_getr("clAuth");
		$row = igk_db_table_select_row(IGK_TB_USERS, $id);

		$v_r = igk_sys_isuser_authorize($row, $auth);


		$b = igk_notifyctrl()->getNotification("notify:checkauth", true);
		$d = igk_createNode();
		$t = 'danger';
		if ($v_r){
			$t = 'success';
		}

		$d->addObData($v_r);
		$d->addDiv()->Content = "Autorisation : ".$v_r;

		$b->addMsg($d, $t);

		// header("Content-Type: text/plain");
		// igk_wln($_REQUEST);
		// $b->RenderAJX();
		// igk_exit();
		$this->View();
		igk_navto($this->getUri('view').'#'.__FUNCTION__);
	}
	public function View(){

		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}
		$t = $this->ConfigNode;
		$t->ClearChilds();
		igk_html_add_title($t, "title.manageauth");

		$t->addHSep();
		igk_add_article($this, "auth.managerdesc" , $t->addDiv());
		$t->addHSep();
		$row = $t->addRow();//Div()->setClass("igk-row");


		$frm = $row->addCol()->addForm();
		$frm["action"] = $this->getUri("auth_check_auth");
		$frm["class"]="dispb";

		igk_notify_sethost($frm->addDiv(), "notify:checkauth");

		$ul=  $frm->add("ul");
		$li = $ul->addLi();
		$li->addLabel()->Content = R::ngets("lb.users");
		$select = $li->addSelect("clUser");
		$r = igk_db_table_select_where(IGK_TB_USERS, null, $this);
		$select->add("option");
		if ($r)
		foreach($r->Rows as $k=>$v){
			if ($v->clLastName == "IGKSystem")continue;
			$opt = $select->add("option");
			$opt["value"] = $v->clId;
			$fn = trim(igk_user_fullname($v));
			$opt->Content = (empty($fn) ? "NoName://[".$v->clLogin."]": $fn);
		}
		$ul->addLi()->addSLabelInput("clAuth");

		$frm->addInput("btn.input", "submit", R::ngets("btn.CheckAuth"));



		$frm = $row->addCol("igk-col")->addForm();
		igk_notify_sethost($frm->addDiv());


		$this->_auth_options($frm);

		$table = $frm->addTable();
		$table["class"] = "igk-table igk-table-hover";

		$r = igk_db_table_select_where(IGK_TB_AUTHORISATIONS, null, $this);

		$tr = $table->addTr();
		$tr->add("th")->addSpace();
		$tr->add("th")->setClass("fitw")->Content = R::ngets("lb.clName");
		$tr->add("th")->addSpace();
		$tr->add("th")->addSpace();
		if($r){
		foreach($r->Rows as $k=>$v){
			$tr = $table->addTr();
			$tr->addTd()->addInput("clAuths[]", "checkbox");
			$tr->addTd()->Content = $v->clName;
			IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("auth_edit_frame_ajx&clId=".$v->clId)), "edit_16x16");
			IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("auth_delete_authorisation_ajx&clId=".$v->clId)), "drop_16x16");

		}
		}
		$this->_auth_options($frm);
	}
	private function _isAuth($q , $t)
	{
		foreach($q->Rows as $k=>$v){
			if ($v->clGroup_Id == $t)
				return $t;
		}
		return false;
	}
	public function auth_edit_frame_ajx(){
		$id = igk_getr("clId");
		$row = igk_db_table_select_row(IGK_TB_AUTHORISATIONS, $id);
		if ($row==null)
		{
			igk_navtocurrent();
		}
		if (igk_qr_confirm()){

			igk_frame_close(__FUNCTION__);
			$tbname = $this->getDataTableName();

			$gp = igk_getr("clGroups");
			igk_db_delete($this, $tbname, array(IGK_FD_AUTH_ID=>$id));
			if ($gp){
				foreach($gp  as $k=>$v){
					igk_db_insert($this, $tbname, array(IGK_FD_AUTH_ID=>$id, IGK_FD_GROUP_ID=>$v, "clGrant"=>1));
				}
				igk_db_reload_index($this, 	$tbname);
			}
			$this->View();
		    igk_navtocurrent();
		}
		else{
		$frame = igk_add_new_frame($this, __FUNCTION__);
		$frame->Title = R::ngets("title.edit_authorisation_1", $row->clName);
		$frame->BoxContent->ClearChilds();
		$d = $frame->BoxContent->addDiv();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$d = $frm->addDiv();
		$d["class"] = "igk-form-group";
		//view group that have this authorisation

		$table = $d->addTable();
		$table["class"] = "igk-table igk-table-hover";
		$r = igk_db_table_select_where(IGK_TB_GROUPS //$this->getDataTableName(), array(IGK_FD_AUTH_ID=>$id)
		,null);
		if ($r){
			$g = igk_db_table_select_where($this->getDataTableName(), array(IGK_FD_AUTH_ID=>$id));
			$groupindex = array();
			foreach($g->Rows as $k=>$v){
				$groupindex[$v->clGroup_Id] = $v;
			}
			//igk_show_prev($groupindex);
			$tr = $table->addTr();
			$tr->add("th")->addSpace();
			$tr->add("th")->Content = R::ngets("lb.Group");
			$tr->add("th")->addSpace();
			foreach($r->Rows as $k=>$v){
				$tr = $table->addTr();
				$tr->addTd()->addInput("clGroups[]", "checkbox", $v->clId)->setAttribute("checked",isset($groupindex[$v->clId]));
				$tr->addTd()->Content = $v->clName ;
				IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri("auth_remove_group_ajx&clId=".$id."&clGroupId=".$v->clId)), "drop_16x16" );
			}
		}
		$div = $frm->addDiv();
		//IGKHtmlUtils::AddImgLnk($div, igk_js_post_frame($this->getUri("auth_add_group_ajx&clId=".$id)), "add_16x16");
		$frm->addHSep();
		$frm->addInput("clId", "hidden", $id);
		$frm->addInput("confirm", "hidden", 1);
		$frm->addInput("btn.confim", "submit", R::ngets("btn.confirm"));
		$frame->RenderAJX();
		}
	}
	public function auth_add_group_ajx(){
		$id = igk_getr("clId");
		$row = igk_db_table_select_row(IGK_TB_AUTHORISATIONS, $id);
		if ($row == null)
		{
			igk_navtocurrent();
			igk_exit();
		}
		if (igk_qr_confirm())
		{
			igk_frame_close(__FUNCTION__);
			$gp = igk_getr("clGroups");
			igk_db_delete($this, $this->getDataTableName(), array(IGK_FD_AUTH_ID=>$id));
			if ($gp)
			{
				foreach($gp  as $k=>$v){
					igk_db_insert($this, $this->getDataTableName(), array(IGK_FD_AUTH_ID=>$id, IGK_FD_GROUP_ID=>$v));
				}
				igk_db_reload_index($this, $this->getDataTableName());
			}
			$this->View();
			igk_navtocurrent();
		}
		else{
		$frame = igk_add_new_frame($this, __FUNCTION__);
		$frame->Title = R::ngets("title.add_group_1", $row->clName);
		$frame->BoxContent->ClearChilds();
		$d = $frame->BoxContent->addDiv();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$d = $frm->addDiv();
		$d["class"] = "igk-form-group";

		$table = $d->addTable();
		$table ["class"] = "igk-table-striped";
		$table->setHeader(IGK_STR_EMPTY,
		R::ngets("lb.clGgroupName"),
		IGK_STR_EMPTY);

		$r = igk_db_table_select_where(IGK_TB_GROUPS);
		foreach($r->Rows as $k=>$v)
		{
			$tr = $table->addRow();
			$tr->addTd()->addInput("clGroups[]", "checkbox", $v->clId);
			$tr->addTd()->Content = $v->clName;
		}

		$frm->addHSep();
		$frm->addInput("confirm", "hidden", "1");
		$frm->addInput("clId", "hidden", $id);
		$frm->addInput("btn.confirm", "submit");
		$frame->RenderAJX();
		}
	}
	public function auth_remove_group_ajx(){
	if (igk_qr_confirm())
	{
		igk_frame_close(__FUNCTION__);
		$h = igk_db_delete($this, $this->getDataTableName(), array(
			"clId"=>igk_getr("clId"),
			IGK_FD_GROUP_ID=>igk_getr(IGK_FD_GROUP_ID)));

		if ($h)
			igk_notifyctrl()->addMsgr("msg.group.removed");
		else{
			igk_notifyctrl()->addErrorr("msg.group.not_removed");
		}
		$this->View();
		igk_navtocurrent();
	}
	else{
			$frame = igk_frame_add_confirm($this, __FUNCTION__, $this->getUri(__FUNCTION__));
			$frame->Form->addInput("clId", "hidden", $id);
			$frame->Form->Div->Content = R::ngets("q.confirm_remove_group_auth");
			$frame->RenderAJX();
		}
	}
	public function auth_add_authorisation_ajx(){
	if (igk_qr_confirm())
	{
		$o = igk_get_robj();
		if (igk_db_insert($this, IGK_TB_AUTHORISATIONS, $o))
			igk_notifyctrl()->addMsgr("msg.authorisation.added");
		else{
			igk_notifyctrl()->addErrorr("msg.authorisation.notadded");
		}
		$this->View();
		igk_navtocurrent();
	}
	else{
		$frame = igk_add_new_frame($this, __FUNCTION__);
		$frame->Title = R::ngets("title.edit_authorisation_1");
		$d = $frame->BoxContent->addDiv();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri(__FUNCTION__);
		$d = $frm->addDiv();
		$d["class"] = "igk-form-group";
		$d->addSLabelInput(IGK_FD_NAME);

		$frm->addHSep();
		$frm->addInput("confirm", "hidden", "1");
		$frm->addInput("btn.confirm", "submit");
		$frame->RenderAJX();
		}
	}
	private function _auth_options($frm){
		IGKHtmlUtils::AddImgLnk($frm->addspan(), igk_js_post_frame($this->getUri("auth_add_authorisation_ajx")), "add_16x16");
	}
	public function auth_delete_authorisation_ajx(){
		$id = igk_getr("clId");
		$row = igk_db_table_select_row(IGK_TB_AUTHORISATIONS, $id);
		if (igk_qr_confirm() && $row)
		{
			igk_db_delete($this, IGK_TB_AUTHORISATIONS, array("clId"=>$id));
			$this->View();
			igk_navtocurrent();
		}
		else{
			$frame = igk_frame_add_confirm($this, __FUNCTION__, $this->getUri(__FUNCTION__));
			$frame->Form->addInput("clId", "hidden", $id);
			$frame->Form->Div->Content = R::ngets("q.confirm_auth_suppression");
			$frame->RenderAJX();
		}
	}
}

///<summary>used to store and manage global authorisation</summary>
final class IGKAuthorisationsCtrl extends IGKControllerBase{
	public function getDataTableName(){return IGK_TB_AUTHORISATIONS ;}

	public function getIsVisible(){return false;}

	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){//autorisiation
		return array(
			new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_ID, IGK_FD_TYPE=>"Int","clAutoIncrement"=>true,IGK_FD_TYPELEN=>10, "clIsUnique"=>true, "clIsPrimary"=>true)),
			new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VarChar", IGK_FD_TYPELEN=>255, "clIsUnique"=>true, "clNotNull"=>true))
		);
	}
	protected function initDataEntry($db, $tbname=null){
		$n = $this->DataTableName;
		$db->insert($n, array(IGK_FD_NAME=>"mod_articles"));
		$db->insert($n, array(IGK_FD_NAME=>"mod_view"));
		$db->insert($n, array(IGK_FD_NAME=>"mod_post"));
	}

}



///---------------------------------------------------------------------------------------------------
///DEBUGING
///---------------------------------------------------------------------------------------------------
final class IGKDebuggerNode extends IGKHtmlItem
{
	public function __construct(){
		parent::__construct("div");
		$this["class"]	= "igk-debugger";
	}
	public function getMessage($o=null){
		if ($this->HasChilds){
			$o = parent::Render($o);
			$this->ClearChilds();
			return $o;
		}
		return null;
	}

}
///<summary>Represent the debugger used to pass message</summary>
final class IGKDebugCtrl extends IGKControllerBase
{
	private $m_topdiv;
	private $m_optionsdiv;
	private $m_debuggerviewnode;

	public function getDebuggerView()
	{
		return $this->m_debuggerviewnode;
	}
	public function View()
	{
		if ($this->getIsVisible())
		{
			//append to
			$body = igk_sys_debugzone_ctrl();
			if ($body!=null){
				igk_html_add($this->getTargetNode(), $body->getTargetNode());
			}
		}
		else
			igk_html_rm($this->getTargetNode());
	}
	public function getIsVisible(){
		return IGKServerInfo::IsLocal();
	}
	public function addMessage($div)
	{
		$this->m_topdiv->add($div);
	}
	protected function initTargetNode()
	{
		$node = parent::initTargetNode();
		$cl = strtolower($this->getName());
		$node["class"]=$cl." loc_t loc_l zback posr";
		$node->add("h2")->Content = R::ngets("title.debugger");
		$this->m_topdiv = $node->add("div",array("class"=>$cl."_content"));
		$this->m_optionsdiv = $node->add("div", array("class"=>$cl."_options posr loc_b loc_l"));
		IGKHtmlUtils::AddBtnLnk($this->m_optionsdiv, "btn.ClearDebug",$this->getUri("ClearDebug"));
		$this->m_debuggerviewnode = new IGKDebuggerNode();
		return $node;
	}
	public function ClearDebug()
	{
		$this->m_topdiv->ClearChilds();
	}

}
///<summary>Represenet IGKErrorManager </summary>
final class IGKErrorCtrl extends IGKControllerBase{

	var $target;

	private $m_errorUri;

	public function getName(){
		return IGK_ERROR_CTRL;
	}

	public function __construct(){
		parent::__construct();
		$this->m_visible = false;
	}
	public function addError($uri){//error controller add error
		if ($this->m_errorUri == null)
			$this->m_errorUri = array();
		$this->m_errorUri[] = $uri;
		$this->View();
	}
	public function getIsVisible(){
		return igk_count($this->m_errorUri);
	}
	public function View(){//error controller not visibile
	}
}

//-----------------------------------------------------------------------------------
//represent a method controller
//-----------------------------------------------------------------------------------
class IGKMetaController extends IGKConfigCtrlBase
{
	var $Description;
	var $EndocingType;
	var $Keyword;
	var $Copyright;
	var $title;

	public function __construct()
	{
		parent::__construct();
		$this->Description = new IGKMetaValue();
		$this->Author = new IGKMetaValue();
		$this->EndocingType = new IGKMetaValue();
		$this->Keyword = new IGKMetaValue();
		$this->Copyright = new IGKMetaValue();
		$this->title = new IGKMetaValue();

		$this->EndocingType->Value = IGK_ENCODINGTYPE; //default encoding type value
		$this->Copyright->Value =IGK_COPYRIGHT; //default copyright value
		$this->title->Value = IGK_STR_EMPTY;

	}
	public function getConfigPage(){return "metactrl";}
	

	public function View ()
	{

		$c = $this->TargetNode;
		if (!$this->getIsVisible())
		{
			igk_html_rm($c);
			return;
		}
		$c->ClearChilds();
		IGKHtmlUtils::AddItem($c, $this->ConfigNode);
		igk_html_add_title($c, "title.MetaController");
		$c->addHSep();
		igk_add_article($this, "metaconfig", $c->addDiv());
		$c->addHSep();

		$frm = $c->addForm();
		$frm["action"] = $this->getUri("meta_update");

		$ul = $frm->add("ul");
		$ul->addLi()->addSLabelInput("clDesc", "text", $this->App->Configs->meta_description);
		$ul->addLi()->addSLabelInput("clCopyright","text", $this->App->Configs->meta_copyright);
		$ul->addLi()->addSLabelInput("clKeysWords",  "text" , $this->App->Configs->meta_keysword);
		$ul->addLi()->addSLabelInput("clEncType", "text" , $this->App->Configs->meta_enctype);
		$ul->addLi()->addSLabelInput("clDefaultTitle",  "text" , $this->App->Configs->meta_title);

		$frm->addBtn("btn_save", R::ngets("btn.save"));
	}
	function __reset_value()
	{//get value from configs
		$this->Description->Value = 	$this->App->Configs->meta_description;
		$this->EndocingType->Value = $this->App->Configs->meta_enctype;
		$this->Keyword->Value = $this->App->Configs->meta_keysword;
		$this->Copyright->Value = $this->App->Configs->meta_copyright ;
		$this->title->Value = $this->App->Configs->meta_title ;


	}
	public function meta_update()
	{
		$this->App->Configs->meta_description = igk_getr("clDesc");
		$this->App->Configs->meta_copyright = igk_getr("clCopyright");
		$this->App->Configs->meta_keysword = igk_getr("clKeysWords");
		$this->App->Configs->meta_enctype= igk_getr("clEncType");
		$this->App->Configs->meta_title = igk_getr("clDefaultTitle");
		igk_save_config();
		$this->__reset_value();
		$this->View();
		igk_notifyctrl()->addMsgr("Msg.metaUpdated");
		igk_navtocurrent();
	}
	protected function InitComplete()
	{
		parent::InitComplete();
		//init default property
		$this->__reset_value();
		$this->App->Doc->Metas->Author = IGK_AUTHOR;
		$this->App->Doc->Metas->Copyright = $this->Copyright;
		$this->App->Doc->Metas->Description = $this->Description ;
		$this->App->Doc->Metas->Keywords = $this->Keyword;
		$this->App->Doc->Metas->ContentType =  $this->EndocingType;
	}
}
//meta value
class IGKMetaValue extends IGKObject implements IIGKHtmlGetValue
{
	private $m_v;
	public function getValue($options=null){//meta get value
		return $this->m_v;
	}
	public function setValue($value){ $this->m_v = $value;}

	public function __toString(){
		return "IGKMetaValue[". $this->getValue()."]";
	}
}

///<summary> Represent a references controller</summary>
final class IGKReferenceCtrl extends IGKConfigCtrlBase
{
	private $m_selectedMenu;
	private $m_selectedClass;
	private $m_selectedInterface;
	private $m_searchkey;
	private $m_htmlExpresion;

	public function getName(){
		return IGK_REFERENCE_CTRL;
	}

	public function getConfigPage(){return "referencectrl";	}
	
	public function loadContent_ajx($s=0){
		$d = igk_createNode("div");
		$div = $d->addDiv(array("id"=>"div_ref_output"))->setClass("igk-row no-padding no-margin");
		$pmenu = IGK_STR_EMPTY;
		switch(strtolower($this->m_selectedMenu))
		{
			case "funcdoc":
				//igk_wln("n is ".igk_getr("n") );
				$p = $this->getParam("sys://menu/params");

				call_user_func_array(array($this, 'ref_getfuncdef'), array($div, igk_getv($p, "n")));
				break;
			case "const":
				$pmenu = "const";
				$this->getGlobalConst($div);
				break;
			case "vars":
				$pmenu = "vars";
				$this->getGlobalVars($div);
				break;
			case "class":
				$pmenu = "class";
				$this->getDeclaredClass($div);
				break;
			case "interface":
				$pmenu = "interface";
				$this->getDeclaredInterface($div);
				break;
			case "interfaceinfo":
				$pmenu = "interface";
				$this->getInterfaceDefinition($div);
				break;
			case "classinfo":
				$pmenu = "class";
				$this->getClassInfo($div);
				break;
			case "functions":
			default:
				$pmenu = "functions";
				$this->getGlobalFunctions($div);
			break;
		}
		$t = $this->getParam("sys://menu/config");
		if (!$s)
		$d->RenderAJX();
	}
	
	public function View(){
		extract($this->getSystemVars());
		$c = $this->TargetNode;
		if (!$this->getIsVisible())
		{
			igk_html_rm($c);
			return;
		}
		IGKHtmlUtils::AddItem($c, $this->ConfigNode);
		$c->ClearChilds();
		$c->addSectionTitle(4)->Content = R::ngets("title.ConfigReferences");
		$c->addHSep();
		$menut = array("vars", "const", "functions", "class","interface");
		$t = array();
		foreach($menut as $k)
		{
			$t[$k] = $this->getUri("select_menu&n=".$k);
		}
		$this->setParam("sys://menu/config", $t);
		$this->setParam("sys://menu/params", $_REQUEST);
		$c->add(igk_html_node_ConfigSubMenu($t, $this->m_selectedMenu));
		$c->addHSep();
		$p= $c->addDiv();



		$p->addAJXUriLoader($this->getUri("loadContent_ajx"));
		$this->setParam("sys://searchresult",$p);
		unset($t);
	}
	public function getInterfaceDefinition($div)
	{
		$name =igk_getr("n");
$div->add("h2")->Content = "Interface : ".$name;
$div->add("p")->Content = "Properties";
$t = get_class_vars($name);
if (count($t)== 0)
{
	$div->addDiv()->Content =  "no vars defined";
}
else{
$div->add("pre")->Content = count($t);
foreach($t as $k=>$v)
{
	$div->add("span", array("style"=>'display:block; float:left; width:200px; overflow:hidden'))->Content = "var ".$v."();";

}
}

$div->addBr()->setClass("clearb");
$div->add("h3")->Content = "Methods";

$t = get_class_methods($name);
if (count($t) == 0)
{
	$div->addLabel()->Content =  "no methods";
}
else {
foreach($t as $k)
{
	$div->add("span", array("style"=>'display:block; float:left; width:200px; overflow:hidden'))->Content = "function ".$k."();";
}
}
	}

	public function showinterfaceinfo(){
	$name = igk_getr("n");
if (!interface_exists($name))
{
	igk_debug_wln("warning:". $name." not a valid interface");
	return;
}
$this->m_selectedMenu = "interfaceinfo";
$this->View();


	}

	public function showclassinfo(){
		$n = igk_getr("n");
		$this->m_selectedMenu = "classinfo";
		$this->View();
	}

	private function _init_v_title($n, $s){
		$d = igk_html_add_title($n, $s);
		$d->setClass("sub-t");
	}
	private function _init_search($node){
		$node->add(new IGKHtmlSearchItem($this->getUri("searchgfunc"),$this->m_searchkey, "q", 1, "#cr-c"));
		$div = $node->addDiv();
		$div->setId("cr-c");
		$this->setParam("sys://searchresult", $div);
		return $div;
	}
	private function getClassInfo($node, $name=null){
		$n = ($name == null)? igk_getr("n") : $name;
		if (!class_exists($n)){
			$node->addDiv()->Content = "class does't exits";
			return;
		}

		$node->add("h2")->Content = "Class : ".$n ;
		$d = new ReflectionClass($n);
		$fname = $d->getFileName();

		$info = $node->addDiv();
		$ul = $info->add("ul");
		$ul->addLi()->Content = "FileName  : ". ((empty($fname))? "unknow" : $fname);
		$ul->addLi()->Content = "Parent : " . get_parent_class($n);
		$imps = class_implements($n);
		if (count($imps) > 0){
			$timp = $info->addDiv();
			$timp->add("h2")->Content = "implements : ";
			$tul = $timp->add("ul");
			foreach($imps as $k=>$v){
			  $tul->addLi()->add("a", array("href"=>$this->getUri("showinterfaceinfo")))->Content = $k;
			}
		}

		$node->addHSep();
		$info = $node->addDiv();
		$info->add("h2")->Content = "Description";

		if (file_exists($fname))
		{
			$this->loadClassDescription($n, $node);
		}


		$node->addHSep();
		$info = $node->addDiv();
		$info->add("h2")->Content = "Properties";
		$this->App->Doc->Theme[".w200px"] = "width:200px; ";
		$t = get_class_vars($n);
		if (count($t)>0){

			foreach($t as $k=>$v){
				$info->add("span", array("class"=>"floatl dispb w200px "))->Content = $k;
			}
		}
		else{
			$info->addDiv()->Content = "No Properties";
		}
		//get mehods
		$t = get_class_methods($n);

		$node->add("div", array("class"=>"clearb"));

		$node->addHSep();
		$info = $node->addDiv();
		$info->add("h2")->Content = "Methods";
		if (count($t)> 0){
			sort($t);
			foreach($t as $k=>$v){
			$info->add("span", array("class"=>"floatl dipsb w200px"))->Content = $v;
			}
		}
		else{
		$info->addDiv()->Content = "No Public methods";
		}

	}
	private function getDeclaredClass($node){
		$this->_init_v_title($node, "title.globalclass");
		$div = $this->_init_search($node);
		$tab = get_declared_classes();
		sort($tab);
		foreach($tab as $v)
		{
			if ($this->m_searchkey && !strstr(strtolower($v),strtolower($this->m_searchkey)))
				continue;
			$div->add("li" , array("class"=>"dispib floatl no-overflow", "style"=>"width:230px"))->add("a",
			array("href"=>$this->getUri("showclassinfo&n=".$v))
			)->Content = $v;
		}
	}

	private function getDeclaredInterface($node){
		$this->_init_v_title($node, "title.globalinterface");
		$div = $this->_init_search($node);
		$tab = get_declared_interfaces();
		sort($tab);
		foreach($tab as $v)
		{

				if ($this->m_searchkey && !strstr(strtolower($v),strtolower($this->m_searchkey)))
					continue;
				$div->add("li" , array("class"=>"dispib floatl no-overflow", "style"=>"width:230px"))->add("a", array("href"=>$this->getUri("showinterfaceinfo&n=".$v)))->Content = $v;


		}
	}
	private function getGlobalVars($node){
		$this->_init_v_title($node,"title.globalvars");
		$div = $this->_init_search($node);


		extract($this->getSystemVars());
		$tab = get_defined_vars() ;

		foreach($tab as $k=>$v)
		{

				if ($this->m_searchkey && !strstr(strtolower($k),strtolower($this->m_searchkey)))
					continue;
				$div->add("li" , array("class"=>"dispib floatl no-overflow", "style"=>"width:230px"))->Content = $k;


		}
	}
	private function getGlobalConst($node){
		$this->_init_v_title($node, "title.globalconst");
		$div = $this->_init_search($node);


		$tab = get_defined_constants();
		foreach($tab as $k=>$v)
		{
				if ($this->m_searchkey && !strstr(strtolower($k),strtolower($this->m_searchkey)))
					continue;
				$div->add("li" , array("class"=>"dispib floatl no-overflow", "style"=>"width:430px"))->Content = $k ."=".$v ;
		}
	}
	private function getGlobalFunctions($node){
		$this->_init_v_title($node, "title.globalfunctions");
		$div = $this->_init_search($node);

		$div = $div->addDiv(array("class"=>"cl_functionslist"));
		foreach(get_defined_functions() as $k)
		{
			sort($k, SORT_STRING);
			foreach($k as $v){

				if ($this->m_searchkey && !strstr(strtolower($v),strtolower($this->m_searchkey)))
					continue;
				$s = new ReflectionFunction($v);

				$href = IGK_STR_EMPTY;
				if ($s->getFileName())
				{
					$href=$this->getUri("ref_funcdef&n=".$v);
				}
				else{
					$href = "http://php.net/manual/".R::GetCurrentLang()."/function.".str_replace("_","-",$v).".php";
				}
				$div->add("li" , array("class"=>"dispib floatl no-overflow", "style"=>"width:230px"))->add("a",
				array("class"=>IGK_STR_EMPTY, "href"=>$href))->Content = $v;
			}

		}
	}
	///<summary>get function definition</summary>
	public function ref_funcdef(){//get function definition
		$this->m_selectedMenu = "funcdoc";
		$this->View();
	}
	///<summary>get present reference function definition</summary>
	public function ref_getfuncdef($div, $n=null){
		$n = $n==null? igk_getr("n") : $n ;
		$div->add("h1")->Content = "Function :". $n;
		$t = $div->addDiv();
		$t->addA($this->getUri("select_menu&n=functions&b=1"))->Content = "Back";
		$t = $div->addDiv();
		if (function_exists($n)){
			$s = new ReflectionFunction($n);
			$ul = $t->add("ul");
			$ul->addLi()->Content  = "FileName : ".igk_io_basePath($s->getFileName());
			$ul->addLi()->Content  = "StartLine : ".$s->getStartLine();
			$ul->addLi()->Content  = "EndLine : ".$s->getEndLine();
		}
	}
	public function getUnsetParam($key, $default=null){
		$n = $this->getParam($key, $default);
		if ($n){
			$this->unsetParam($key);
		}
		return $n;
	}
	public function searchgfunc(){
		$this->m_searchkey = igk_getr("q");
		$this->View();

		if (igk_is_ajx_demand()){
			$this->loadContent_ajx(1);
			$m = $this->getUnsetParam("sys://searchresult");
			if ($m) $m->RenderAJX();
			igk_exit();
		}else{
			igk_navtocurrent();
		}
	}
	public function select_menu(){
		$i = igk_getr("n");
		$b = igk_getr("b");
		if ($this->m_selectedMenu != $i){
			$this->m_selectedMenu = $i;
		}
		if (!$b){
			$this->m_searchkey = null;
		}
		//$this->m_searchkey = "igk_svg";
		// igk_wln($b. " ".$this->m_searchkey );
		//e_xit;
		$this->View();
		igk_navtocurrent();
	}


	public function loadClassDescription($n, $target, $dir = null)
	{
		$s = igk_io_dir($this->getDataDir()."/References");
$k = 	"";
		if (($dir == null) && IGKIO::CreateDir($s))
		{
			$k =  $s."/class.$n";
		}
		else {
			$k = $dir."/class.$n";
		}

		igk_add_article($this,$k,$target->addDiv());
	}


	private function getComponentDisplayName($n){
		//init component name
		$tab = igk_get_env( IGK_ENV_COMPONENT_DISPLAY_NAMES_KEY);
		if ($n!==null)
			return igk_getv($tab, $n, $n);
		return null;
	}


	///<summary> get component description</summary>
	public function getComponentDesription($n, $target){
			$target->addDiv()->setClass("igk-title-4")->Content = $this->getComponentDisplayName($n);
			$cl = "IGKHtml".$n."Item";
			$fname = strtolower($n);
			$v = class_exists($cl);
			$lang = R::getCurrentLang();

			$fc_addcallback=function($s, $v){
				$s["name"]=$v->getName();
				$s["desc"]="";
				$optional = $v->isOptional();
				$s["require"]=!$optional;
				if ($optional){
					$s["def-v"]= $v->getDefaultValue();
				}
			};


			if (!$v){
				//for non class component
				$fc = IGK_FUNC_NODE_PREFIX.$n;
				if (function_exists($fc))
				{
					$v_out = array("type"=>"function", "name"=>$fc);
					$d = $target->addDiv();
					$quote = $d->addPanel()->addQuote();
					$quote->addDiv()->Content = $fc;
					$rf = new ReflectionFunction($fc);//reflexion
					$v_fcdeclare_filename= ($rf)->getFileName();
					$dir = igk_sys_get_referencedir($v_fcdeclare_filename);

					$quote->addWebMasterNode()->addDiv()->Content =$v_fcdeclare_filename;
					//function only global description file
					$target->addDiv()->addArticle($this, "ref.function.only");

					$mdesc =  IGK_FUNC_NODE_DESC_PREFIX.$n;
					$target->addDiv()->setClass("igk-title-5")->Content = R::ngets("title.References");
					if (function_exists($mdesc)){
						$mdesc($target);
					}
					else{
						$descfn = "";
						if ($dir){
							$descfn = igk_io_dir($dir."/Components/functions/{$fname}");
						}else
							$descfn = igk_io_dir(dirname(__FILE__)."/Data/References/Components/functions/{$fname}");
						// igk_wln($dir);
						// igk_wln($v_fcdeclare_filename);
						// igk_wln("file ::: ".strstr($dir, $v_fcdeclare_filename));
						// igk_wln("file ::: ".strstr($v_fcdeclare_filename, $dir));
						// igk_wln($descfn);
						// exit;


						$target->addDiv()
						->setClass("igk-balafon-ref")
						->addArticle($this, $descfn); //igk_io_dir(dirname(__FILE__)."/Data/References/Components/functions/{$fname}"));
					}



					//$target->addDir()->Content = "Source DIR ".$dir;
					//$dir = "";
					if (!$dir && strstr( $v_fcdeclare_filename,dirname(__FILE__))){//child of BALAFON LIB
						$dir = $this->getDataDir()."/References/Components";
					}
					// else{
						// return $v_out;
					// }
					//exit;

					//args descriptions
					$dir = $dir."/FuncArgs";
					if (!IGKIO::CreateDir($dir)){

						return null;
					}
					$f = igk_io_dir( $dir."/".$fname.".xml");
					// igk_wln($f);
					//@unlink($f);
					$pc = $rf->getNumberOfParameters();
					$rg = $rf->getNumberOfRequiredParameters();
					$pt = $rf->getParameters();
					if (IGKServerInfo::IsLocal() &&  !file_exists($f) && ($pc>0))
					{//save function args to file
						$g = igk_createXMLNode($n);
						$g["parent"]="";
							foreach($pt as $k=>$v){
								// igk_wln("name : ".$v->getName());
								$s = $g->add("attr");
								$fc_addcallback($s,$v);
							}
							igk_io_w2file($f, "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n".$g->Render());
						unset($g);
					}
					if (file_exists($f))
					{
						//load properties
						$target->addWebMasterNode()->addDiv()->Content = $f;
						$tab = $target->addDiv()->setClass("overflow-x-a")->addTable();
						$tab["class"] = "paramlist igk-table-hover igk-table-striped";
						$row = $tab->addTr();
						$row->add("th")->Content = R::ngets("lb.parameters");
						$row->add("th")->setClass("fitw alignl")->Content = R::ngets("lb.desc");
						//load exposed properties
						$d = IGKHtmlReader::LoadXMLFile($f);
						$def_attr =
							$d->getElementsByTagName("attr");
						$li = array();
						foreach($def_attr  as $k=>$v)
						{
							$c = (object)array("desc"=>"","def-v"=>0,"require"=>0);
							igk_conf_load($c, $v);
							// igk_wln($c);
							// igk_exit();
							$tr = $tab->addTr();
							$td = $tr->addTd();
							$td->Content = $c->name;
							if (igk_getv($c,'require')){
								$td->setClass("require");
							}
							$li[$c->name] = array($v, $tr);
							$g = $c->{"def-v"};
							$td =  $tr->addTd();
							$td->Content = igk_getv($c, $lang,$c->desc);//$v["desc"];
							if (!empty($g)){
								$td->add("ul")->add("li")->Content = R::ngets("t.defaultv_1", $g);
							}
						}

						if (igk_count($def_attr) != $pc){
							//update the data
							foreach($pt as $k=>$v){
								if (isset($li[$v->getName()]))
									unset($li[$v->getName()]);
								else{
									$n = $d->add("attr");
									$fc_addcallback($n, $v);
								}
							}
							foreach($li as $k=>$v){
								igk_html_rm($v[0]);
								igk_html_rm($v[1]);
								//igk_ilog("remove [ {$k} ] ".$v);
							}
							//igk_wln("changed");
							IGKIO::WriteToFileAsUTF8WBOM($f, "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n".$d->Render());
						}
						unset($li);
						// $d->RenderXML();
						//e_xit;
					}

// igk_die("kd");
					return $v_out;
				}

				//describe componnent
				//$target->addDiv()->addArticle($this, igk_io_dir(dirname(__FILE__)."/Data/References/Components/functions/$n"));
				//$this->ref_getfuncdef($target->addWebMasterNode(), $fc);
				return null;
			}
			$_out =  array("type"=>"class", "name"=>$cl);
			$target->addDiv()->Content = $cl ;
			$g = igk_reflection_getdeclared_filename($cl);

			$dir = $this->getDataDir()."/References/Components";
			if ($g != __FILE__)
			{
				$dir = igk_io_dir(dirname($g)."/Data/References/Components");
			}
			if (!IGKIO::CreateDir($dir)){
				return $_out;
			}

			$d = $target->addDiv();
			$d->addDiv()->setClass("igk-title-5")->Content = R::ngets("title.classDescription");
			$d->addDiv()->addWebMasterNode()->setContent("filename : ".$g);
			$this->loadClassDescription(
				$cl,
				$d->addDiv(),
				($g == __FILE__)? 	null: igk_io_dir(dirname($g)."/Data/References/")
			);

			$d = $target->addDiv();
			$d->addDiv()->setClass("igk-title-5")->Content = R::ngets("title.ReferenceDescription");
			igk_add_article($this, $dir."/".$fname, $target->addDiv());

			$f = null;
			$dir = $dir."/Values";
			if (!IGKIO::CreateDir($dir)){
				return $_out;
			}
			$f = $dir."/".$fname.".xml";

			if (IGKServerInfo::IsLocal() &&  !file_exists($f))
			{//save new file
				igk_io_w2file($f, "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<$n parent=\"\" />");
			}
			if (file_exists($f))
			{
				//load properties
				$tab = $target->addTable();
				$row = $tab->addTr();
				$row->add("th")->Content = R::ngets("lb.properties");
				$row->add("th")->setClass("fitw")->Content = R::ngets("lb.desc");
				//load exposed properties
				$d = IGKHtmlReader::LoadFile($f);
				foreach($d->getElementsByTagName("attr") as $k=>$v)
				{
					$tr = $tab->addTr();
					$tr->addTd()->Content = $v["name"];
					$tr->addTd()->Content = igk_getv($v, $lang,$v["desc"]);//$v["desc"];
				}
			}
			return $_out;

	}
	public function getHtmlComponentInfo($n, $g)
	{
			$f = null;
			$dir = $this->getDataDir()."/References/Components/Values";
			if ($g == __FILE__){	//declared on the balafon d;
				$f = $dir."/".$n.".xml";
			}
			else {
				$f = igk_io_dir(dirname($g)."/Data/References/".strtolower($n.".xml"));
			}

			if (IGKServerInfo::IsLocal() &&  !file_exists($f))
			{
				IGKIO::WriteToFileAsUTF8WBOM($f, "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n<$n parent=\"\" />");
			}
			if (file_exists($f)){
				//load exposed properties
				$d = IGKHtmlReader::LoadFile($f);
				$tab = array();
				foreach($d->getElementsByTagName("attr") as $k=>$v)
				{
					$tab[$v["name"]] = $v;
				}
				return $tab;
			}
	}

	public function getHtmlExpresionTab($node){
		$v = get_class($node);
		if (preg_match(IGK_HTML_NODE_REGEX, $v))
		{
			$n = igk_preg_match(IGK_HTML_NODE_REGEX, $v, 'name');
			if ($this->m_htmlExpresion == null)
			{
				$this->m_htmlExpresion = array();
			}

				if (isset($this->m_htmlExpresion[$n]))
					return $this->m_htmlExpresion[$n];

				$c = $this->getHtmlComponentInfo($n,igk_reflection_getdeclared_filename($node));
				$this->m_htmlExpresion[$n] = $c;
				return $c;
		}
		return null;

	}
	///<summary>get html elements </summary>
	public function getHtmlElements(){
		if (! IGKViewMode::IsWebMaster() )
		{
			//check if data is cached
			$d = igk_get_cached("sys://htmlitems");
			if ($d!=null)
				return $d;
		}


		$b = array();
		foreach(get_declared_classes() as $t=>$v)
		{
			if (igk_sys_class_is_html_element($v))
			{
				//$b[] =(object) array('class'=>$v, 'name'=>igk_preg_match(IGK_HTML_NODE_REGEX, $v, 'name'));
				$n = igk_preg_match(IGK_HTML_NODE_REGEX, $v, 'name');
				igk_array_push_keyvalue($b, strtolower($n), (object) array('class'=>$v, 'name'=>$n), false);
			}
		}
		$c = get_defined_functions();

		$utab = igk_getv(get_defined_functions(), "user");
		$v_regex = "/^".IGK_FUNC_NODE_PREFIX."(?P<name>(.)+)/i";

		$names = igk_get_env(IGK_ENV_COMPONENT_DISPLAY_NAMES_KEY);
		$new = 0;
		foreach($utab as $k=>$v){

			if (preg_match( $v_regex, $v)){
				//igk_wln("match ".$v);

				$n = igk_preg_match($v_regex, $v, 'name');
				if (isset($b[$n])){
					$b[$n]->function = $v;
				}else{
					//igk_wln($v);
					if (!isset($names[$n])){
						$names[$n]=$n;
						$new = 1;
					}

					igk_array_push_keyvalue($b, $n, (object) array('function'=>$v, 'name'=>igk_getv($names,$n)), false);

				}

			}
		}
		if ($new){
			$this->_storeNamesTab();
		}
		// igk_exit();
		$keys = array_keys($b);
		igk_array_sortbykey($b);
		igk_set_cached("sys://htmlitems",$b);
		return $b;
	}
	private function _storeNamesTab(){
		$names = igk_get_env(IGK_ENV_COMPONENT_DISPLAY_NAMES_KEY);
		$date = igk_date_now();
		$o = "<?php\n";
		$o.="/*";
		$o.="* DESC: Generated Display Name of Component functions \n";
		$o.="* file : \n";
		$o.="* date : {$date} \n";
		$o.="*/\n";

		igk_array_sortkey($names);
		foreach($names as $k=>$v){
			$o.="\$htab[\"{$k}\"]=\"{$v}\";\n";
		}
		$o.="?>";
		igk_io_save_file_as_utf8_wbom(IGK_COMPONENT_NAMESFILE, $o, true);
	}
	///<summary>get html components</summary>
	public function getHtmlComponents(){
		$b = array();
		foreach(get_declared_classes() as $t=>$v){
			if (igk_sys_class_is_component($v))
			{
				$b[] =(object) array('class'=>$v,
				'name'=>igk_preg_match(IGK_HTML_NODE_REGEX, $v, 'name'));
			}
		}
		usort($b, function($a,$b){
			return strcmp(strtolower($a->name), strtolower($b->name));
		});
		return $b;
	}
}
//view configs tools
final class IGKToolsCtrl extends IGKConfigCtrlBase
{
	private $m_tools;
	public function __construct()
	{
		parent::__construct();
		$this->m_tools = array();
	}
	public function getConfigPage(){return "toolctrl";}
	
	public function RegisterTool($ctrl)
	{
		$this->m_tools[$ctrl->Name] = $ctrl;
		$this->regChildController($ctrl);
	}
	public function view_tools_ajx(){
		$this->View();
		igk_wl($this->TargetNode->getinnerHTML());
	}
	public function View(){
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}
		$t = $this->TargetNode;
		$t->ClearChilds();
		igk_html_add($t, $this->ConfigNode);
		igk_html_add_title($t,"title.ToolManager");
		$t->addHSep();
		igk_notifyctrl()->setNotifyHost($t->addDiv());

		$s = $t->addSearch()->setClass("fitw");

		$s->Uri = $this->getUri("view_tools_ajx");
		$s->TargetId = "#igktoolsctrl";
		$s->loadingComplete();

		$t->addHSep();

		$d = $t->addDiv();
		$th = $this->App->Doc->getSysTheme();
		$th[".igk-tool-option div"] = "padding: 4px; background-color:white";
		$d["class"] = "igk-tool-option table ";

		$q = strtolower(igk_getr("q"));
		foreach($this->m_tools as $k=>$v)
		{
			if ($q && !strstr(strtolower($v->Name), $q)  && !strstr(strtolower(R::ngets("tool.".$this->Name)->getValue()), $q) )
				continue;

			$v->showTool($d->addDiv()->setAttribute("class", "dispib floatl marg4"));
		}
	}
}


//-----------------------------------------------------------------------------------------
/// MAIL FUNCTION
//-----------------------------------------------------------------------------------------
//represent a mail attachement
class IGKMailAttachement extends IGKObject
{
	var $Type;
	var $ContentType;
	var $Link;
	var $CID;
	var $Visible;
	var $Name;

	private  $m_content;

	public function __construct()
	{
		$this->ContentType = "text/plain";
		$this->Visible = false;

	}
	public function setContent($content)
	{
		$this->m_content = $content;
		return $this;
	}
	public function getContent(){ return $this->m_Data; }
	///get data used
	public function getData(){
		if ($this->Type == "Content")
			return chunk_split(base64_encode( $this->m_Data),76,IGK_CLF);
		$data = "";
		if (file_exists($this->Link))
			$data = igk_io_read_allfile($this->Link);
		return chunk_split(base64_encode($data),76,IGK_CLF);
	}
}

final class IGKMailAttachementContainer extends IGKObject
implements IIGKMailAttachmentContainer
{
	private $m_files;
	private $m_ids;
	public function getList(){
		return $this->m_files;
	}
	public function __construct(){
		$this->m_files = array();
	}
	public function attachFile($file, $contentType="text/plain", $cid=null){
		if (!file_exists($file))
			return null;
		$attach = new IGKMailAttachement();
		$attach->Link = $file;
		$attach->ContentType = $contentType;

		$attach->Type  = "File";
		$attach->CID = $cid?$cid: $this->generate_cid();
		$this->m_files[] = $attach;
		return $attach;
	}
	public function attachContent($content, $contentType="text/plain", $cid=null){
		$attach = new IGKMailAttachement();
		$attach->Content = $content;
		$attach->ContentType = $contentType;
		$attach->Type  = "Content";
		$attach->CID = $cid?$cid: $this->generate_cid();
		$this->m_files[] = $attach;
		return $attach;
	}
	private function generate_cid(){
		$this->m_ids++;
		return "idcall_".$this->m_ids;//base64_encode("cid:".$this->Type.":".igk_new_id());
	}
}

//represent a mail object
class IGKMail extends IGKObject
implements IIGKMailAttachmentContainer
{
	private $m_to;
	private $m_tocc;
	private $m_toBcc;
	private $m_files;
	private $m_textmsg;
	private $m_htmlmsg;
	private $m_title;
	private $m_from;
	private $m_replyto;

	private $m_smtp_port;
	private $m_useAuth;
	private $m_user;
	private $m_pwd;
	private $m_socketType="tls"; //tls or ssl
	private $m_socketTimeout = 15;
	private $m_smtphost ;

	private $ErrorMSG;


	private  $html_charset =  "iso-8859-1";
	private  $text_charset = "iso-8859-1";

	const PART_ALTERNATIVE = "multipart/alternative";
	const PART_MIXED = "multipart/mixed";

	const CONTENT_PLAIN_TEXT = "text/plain";
	const CONTENT_HTML_TEXT = "text/html";
	const CONTENT_IMG_PNG = "image/png";

	public function getFrom(){return $this->m_from;}
	public function setFrom($value){ $this->m_from = $value; }
	public function getTitle(){return $this->m_title;}
	public function setTitle($value){ $this->m_title = $value; }


	public function getSocketType(){return $this->m_socketType;}
	public function setSocketType($v){ switch(strtolower($v)){ case "tls": case "ssl":$this->m_socketType = strtolower($v); break; }}

	public function getSocketTimeout(){return $this->m_socketTimeout;}
	public function setSocketTimeout($value){ $this->m_socketTimeout = $value; }

	public function getReplyTo(){return $this->m_replyto;}
	public function setReplyTo($value){ $this->m_replyto = $value; }

	public function getUser(){return $this->m_user;}
	public function setUser($value){ $this->m_user = $value; }

	public function getPwd(){return $this->m_pwd;}
	public function setPwd($value){ $this->m_pwd = $value; }

	public function getSmtpHost(){return $this->m_smtphost;}
	public function setSmtpHost($value){ $this->m_smtphost = $value; }

	public function getPort(){return $this->m_smtp_port;}
	public function setPort($value){ $this->m_smtp_port = $value; }

	public function setHtmlCharset($v){ $this->html_charset = $v;  }
	public function setTextCharset($v){ $this->text_charset = $v;  }

	public function getHtmlCharset(){ return $this->html_charset;  }
	public function getTextCharset(){ return $this->text_charset;  }


	public function __construct()
	{
		$this->m_files = array();
		$this->m_to = array();
		$this->m_tocc = array();
		$this->m_toBcc = array();

		$app = igk_app();
		if ($app){
			//init this mail object with app setting
			$this->m_useAuth = $app->Configs->mail_useauth;
			$this->m_smtphost = $app->Configs->mail_server;
			$this->m_user = $app->Configs->mail_user;
			$this->m_pwd= $app->Configs->mail_password;
			$this->m_smtp_port= $app->Configs->mail_port;
			$this->m_socketType=$app->Configs->mail_authtype;
		}
	}
	public function setTextMsg($content)	{		$this->m_textmsg = $content;	}
	public function setHtmlMsg($content)	{		$this->m_htmlmsg = $content;	}
	public function getHtmlMsg() { return $this->m_htmlmsg ;}
	public function getTextMsg(){return $this->m_textmsg; }
	public function getUseAuth(){return $this->m_useAuth; }

	public function setUseAuth($value){ $this->m_useAuth = $value; }


	public function attachFile($file, $contentType="text/plain", $cid=null){
		$attach = new IGKMailAttachement();
		$attach->Link = $file;
		$attach->Content = file_exists($file) ? IGKIO::ReadAllText($file) : null;

		$attach->ContentType = $contentType;
		$attach->Type  = "Uri";
		$attach->CID = $cid;
		$this->m_files[] = $attach;
		return $attach;
	}
	public function attachContent($content, $contentType="text/plain", $cid=null){
		$attach = new IGKMailAttachement();
		$attach->Content = $content;
		$attach->ContentType = $contentType;
		$attach->Type  = "Content";
		$attach->CID = $cid;
		$this->m_files[] = $attach;
		return $attach;
	}
	public function attach($attachement)
	{
		if ($attachement)
			$this->m_files[] = $attachement;
	}
	public function addTo($to)
	{
		if (is_string($to))
		{
			$h = explode(",",$to);
			if (igk_count($h)>1)
			{
				foreach($h as $k)
				{
					$this->m_to[] = $k;
				}
			}
			else
				$this->m_to[] = $to;
		}
		else {
			if (is_array($to)){
				foreach($to as $k=>$v){
					switch(strtolower($k))
					{
						case "cc":
							$this->addToCC($v);
							break;
						case "cci":
							$this->addToGCC($v);
							break;
						default:
							$this->addTo($v);
						break;
					}
				}
			}
			else
				$this->m_to[] = $to;
		}
	}
	public function ClearTo()
	 {
		$this->m_to = array();
	 }
	public function addToCC($to)
	{
		if (is_string($to))
		{
			$h = explode(",",$to);
			if (igk_count($h)>1)
			{
				foreach($h as $k)
				{
					$this->m_tocc[] = $k;
				}
			}
			else
				$this->m_tocc[] = $to;
		}
		else
			$this->m_tocc[] = $to;
	}
	public function addToGCC($to)
	{
		if (is_string($to))
		{
			$h = explode(",",$to);
			if (igk_count($h)>1)
			{
				foreach($h as $k)
				{
					$this->m_toBcc[] = $k;
				}
			}
			else
				$this->m_toBcc[] = $to;
		}
		else
			$this->m_toBcc[] = $to;
	}
	public function getToString(){
		return self::GetMailList($this->m_to);
	}
	static function GetMailList($tab)
	{
		$o = IGK_STR_EMPTY;
		foreach($tab as $k=>$v)
		{
			if ($k>0)
				$o.=",";
			$o .= self::MailEntry($v);
		}
		return $o;
	}
	static function MailEntry($c)
	{
		$out = IGK_STR_EMPTY;
		if (is_numeric($c) || (is_string($c) &&  !empty($c)))
		{
			$out.=$c;
		}
		else if (is_object($c) && (method_exists(get_class($c),IGK_FC_GETVALUE)) )
		{
			$out .= $c->getValue();
		}
		return $out;
	}
	private function _getHeader($boundary)
	{
		$header = IGK_STR_EMPTY;
		if ($this->m_from)
		$header .= "From: ".$this->m_from.IGK_CLF;
		if ($this->m_replyto)
		$header .= "Reply-To: ".$this->m_replyto.IGK_CLF;
		$CC  = self::GetMailList($this->m_tocc);
		if (!empty($CC))
		{
			$header .= "Cc: <".$CC.">\r\n";
		}
		$CC  = self::GetMailList($this->m_toBcc);
		if (!empty($CC))
		{
			$header .= "Bcc: ".$CC.IGK_CLF;
		}
		$header .= "MIME-Version: 1.0\r\n";
		//cause problem with thunderbird
		//$header .= "Content-Type: multipart/mixed; boundary=$boundary\n";
		//correct problem with thunderbird
		$header .= "Content-Type: multipart/related; boundary=$boundary\r\n";

		return $header;
	}
	public function sendMail()
	{
		$boundary = igk_new_id();
		$to = $this->getToString();

		$title = $this->getTitle();
		$header = $this->_getHeader($boundary);
		$t = trim($to);
		if (empty($t))
			return false;
		$lf=IGK_CLF;
		$message = $lf;
		$message .= "This is a multi-part message in MIME Format.".$lf;
		$message .= "--$boundary".$lf;

		$j1 = $this->TextMsg;
		$j2 = $this->HtmlMsg;
		$LINE = $lf.$lf;
		if (!((empty($j1) && empty($j2))))
		{
		$message .= "Content-Type: multipart/alternative; boundary=sub_$boundary".$lf;

		if (!empty($j1))
		{

			$message .= $LINE."--sub_$boundary".$lf;
			$message .="Content-Type: text/plain; charset=\"".$this->text_charset."\"".$LINE;
			$message .= $j1;
		}

		if(!empty($j2))
		{
			$message .= $LINE."--sub_$boundary".$lf;
			$message .= "Content-Type:text/html; charset=\"".$this->html_charset."\"".$LINE;
			$message .= $j2;//,77,"\x0");
		}
		$message .= $LINE."--sub_$boundary--".$lf;
		}


		foreach($this->m_files as $k=>$v)
		{
			// attach files
			$data = $v->getData();
			//$message .= "Content-Type: image/gif; name=\"attachment.txt\"\n";//with name
			$message .= $LINE."--$boundary".$lf;
			$message .= "Content-Type: ".$v->ContentType;
			if ($v->Name){
				$message .= "; name=\"".$v->Name."\"";
			}
			// else
				// $message .= "; name=\"test\"";

			$message .= $lf;//with name
			$message .= "Content-Transfer-Encoding: base64".$lf;
			if (!$v->Visible)
			{
				$message .= "Content-Disposition: attachment".$lf; //suppress view
			}
			if ($v->CID){
				$message .= "Content-ID: <".$v->CID.">".$lf; //les crochet sont important pour ajouter une image
				//$message .= "Content-ID: ".$v->CID."".$lf; //les crochet sont important pour ajouter une image
			}
			$message .= $lf.$lf.$data;

		}
		$message .= $lf."--$boundary--".$lf;
		$message .= "end of the multi-part";

		// igk_wl($message);

		//return false;
		if ($this->UseAuth)
		{
			if (extension_loaded("openssl"))
			{
				//igk_wln("send with TLS");
				$v = $this->__sendMailTLS($header, $message);
				return $v;
			}
			else{
				igk_ilog("no openssl extension loaded", __METHOD__);
			}
			return false;
		}
		else{
			if (@mail($to, $title, $message,$header) == true)
			{
				return true;
			}
		}
		return false;
	}
	//Function to Processes Server Response Codes
	private function server_parse($socket, $expected_response)
	{
		if (igk_getv(socket_get_status($socket), "eof"))
		{
			return false;
		}
		$server_response = '';
		igk_debug_wln("Expected ".$expected_response);
		$i = 1;
		while (substr($server_response, 3, 1) != ' ')
		{
			igk_debug_wln("reponse :::: ".$server_response);
			if (!($server_response = fgets($socket, 256)))
			{
				$this->ErrorMsg = __FUNCTION__.' : Error while fetching server response codes.'.
			  "-$socket-".
			  "{$expected_response} ".
			  '['.$server_response.']';
			   igk_debug_wln($this->ErrorMsg);
			   igk_debuggerview()->add("div")->Content = $this->ErrorMsg;
			   return false;
			}
		}
		igk_debug_wln('OK : "'.$server_response.'"');
		if (!(substr($server_response, 0, 3) == $expected_response))
		{
			$this->ErrorMsg =__FUNCTION__.' Unable to send e-mail."'.$server_response.'"';
		  igk_debug_wln($this->ErrorMsg);
		  return false;
		}
		return true;
	}
	private function _closeSocket($socket)
	{
		fwrite($socket, 'QUIT'.IGK_CLF);
		fclose($socket);
	}
	///<summary>send mail with TLS by using socket</summary>
	private function __sendMailTLS($headers, $message)
	{
		//igk_debug(1);
		$errno = IGK_STR_EMPTY;
		$errstr=IGK_STR_EMPTY;
		$host = $this->m_smtphost;
		$user = $this->m_user;
		$pass = $this->m_pwd;
		$port = $this->m_smtp_port;
		$timeout = $this->m_socketTimeout;
	//igk_debug(true);
	  $socket = @fsockopen($host , $port, $errno, $errstr, $timeout);
	  if(!$socket)
	  {
		$emsg = "ERROR: ".$host." ".$port." - $errstr ($errno)";
		igk_debug_wln($emsg);
		$this->ErrorMSG = $emsg;
		igk_debuggerview()->add("div")->Content = $emsg;
		return false;
	  }
	  else
	  {
		igk_debug_wln("SUCCESS: ".$host." ".$port." - ok");

		//fusion de tous les receveurs . le header permet la distinction entre copie et copie caché
	$recipients = $this->m_to;

	if (igk_count($this->m_tocc)>0)
		$recipients = array_merge($recipients, $this->m_tocc);

	if (igk_count($this->m_toBcc)>0)
		$recipients = array_merge($recipients, $this->m_toBcc);

	//igk_wln($recipients);
	$subject = $this->Title;



		if (!$this->server_parse($socket, '220')) { $this->_closeSocket($socket); return false;}

		fwrite($socket, 'EHLO '.$host.IGK_CLF);
		if (!$this->server_parse($socket, '250')) { $this->_closeSocket($socket); return false;}

		if ($this->SocketType =="tls")
		{

			fwrite($socket, 'STARTTLS'.IGK_CLF);
			if (!$this->server_parse($socket, '220')) { $this->_closeSocket($socket); return false;}

			if(false == @stream_socket_enable_crypto($socket, true, STREAM_CRYPTO_METHOD_TLS_CLIENT))
			{
				$this->_closeSocket($socket);
				igk_debug_wln("unable to start tls encryption");
				return false;
			}


				fwrite($socket, 'HELO '.$host.IGK_CLF);
				if (!$this->server_parse($socket, '250')) return false;

		}
			igk_debug_wln("AUTH LOGIN");
			fwrite($socket, 'AUTH LOGIN'.IGK_CLF);
			if (!$this->server_parse($socket, '334')) { $this->_closeSocket($socket); return false;}


			igk_debug_wln("AUTH USER " .$user);
			fwrite($socket, base64_encode($user).IGK_CLF);
			if (!$this->server_parse($socket, '334')) { $this->_closeSocket($socket); return false;}

			igk_debug_wln("AUTH pass " .igk_app()->Configs->mail_password);
			fwrite($socket, base64_encode($pass).IGK_CLF);
			if (!$this->server_parse($socket, '235')) { $this->_closeSocket($socket); return false;}

			igk_debug_wln("AUTH USER " .$this->FROM);
			fwrite($socket, 'MAIL FROM: <'.$this->From.'>'.IGK_CLF);
			if (!$this->server_parse($socket, '250')) { $this->_closeSocket($socket); return false;}

			foreach ($recipients as $email)
			{
				//igk_wln($email);
				fwrite($socket, 'RCPT TO: <'.$email.'>'.IGK_CLF);
				if (!$this->server_parse($socket, '250')) { $this->_closeSocket($socket); return false;}
			}
			fwrite($socket, 'DATA'.IGK_CLF);
			if (!$this->server_parse($socket, '354')) { $this->_closeSocket($socket); return false;}

			fwrite($socket, 'Subject: '
			.$subject.IGK_CLF.'To: <'.implode('>, <', $this->m_to).'>'
			.IGK_CLF.$headers."\r\n\r\n".$message.IGK_CLF);
			//end
			fwrite($socket, '.'.IGK_CLF);
			igk_debug_wln("SEND....Subject");
			if (!$this->server_parse($socket, '250')) { $this->_closeSocket($socket); return false;}
			igk_debug_wln("GOOD");
			$this->_closeSocket($socket);
			return true;

	  }
	}



}

///<summary>return script data</summary>
final class IGKScriptController extends IGKControllerBase{
	public function getName(){
		return IGK_SCRIPT_CTRL;
	}
	public function getScript(){//get the script content
		$tab  = $this->App->Doc->ScriptManager->getMergedContent();
		header('Content-type: Application/javascript;  charset=\"utf-8\";');
		//igk_ilog("zip out script");
		igk_wl(igk_zip_output($tab->data));
		igk_exit();
	}
	public function getIsVisible(){return false;}
}

class IGKCountryCtrl extends IGKControllerBase
{
	public function getIsVisible(){return false;}
	public function __construct(){
		parent::__construct();
		$this->_loadData();
	}
	public function getCountries(){
		return igk_get_env_init(igk_ctrl_env_param_key($this)."/countries", function(){
			$t = $this->_loadData();
			return $t;
		});
	}
	public function getDataTableName(){return "tbcountries"; }
	public function getDataAdapterName(){return "CSV"; }
	private function _loadData(){
		$r = IGKCSVDataAdapter::LoadData(igk_io_syspath("Data/tbcountries.csv"));
		if ($r){
			$t = array();
			foreach($r as $l)
			{
				$t[$l[0]] = $l[0];
			}
			return $t;
		}
	}

}
// - user variables

final  class IGKUserVarsCtrl extends IGKConfigCtrlBase
{
	private $m_vars;
	private $m_searchkey;
	public function getName(){return IGK_USERVARS_CTRL; }
	public function getdataFileName(){return igk_io_baseDir(IGK_DATA_FOLDER.DIRECTORY_SEPARATOR."usersvar.csv");}
	public function getConfigPage(){return "uservarctrl";}
	public function getVars()
	{
		return $this->m_vars;
	}
	///<summary>register user variable</summary>
	public function regVars($name, $value,$comment)
	{
		if (empty($name))
			return;
		$this->m_vars[$name] =
						array(
							"value"=> $value,
							"comment"=> $comment
						);
	}
	public function __construct(){
		parent::__construct();

		$this->__loadVars();
	}
	private function __loadVars()
	{
		$this->m_vars = array();
		$e = IGKCSVDataAdapter::LoadData($this->dataFileName);
		if ($e)
		{
			foreach($e as $k=>$v)
			{
					$this->m_vars[$v[0]] =
						array(
							"value"=> igk_getv($v, 1),
							"comment"=> igk_getv($v, 2)
						);
			}
		}

	}
	public function vc_addvars()
	{
		$obj = igk_get_robj();
		$this->m_vars[$obj->clName] = array("value"=>$obj->clValue, "comment"=>$obj->clComment);
		$this->__storeVars();
	}
	public function vc_dropvars()
	{
		$obj = igk_getr("n");
		if (isset($this->m_vars[$obj]))
		{
		unset($this->m_vars[$obj]);
		$this->__storeVars();
		$this->View();
		}
		igk_navtocurrent();
	}
	public function vc_Clearvars($store=true)
	{
		$this->m_vars = array();
		if ($store)
			$this->__storeVars();
	}
	public function __storeVars()
	{
		if (defined("IGK_FRAMEWORK_ATOMIC"))
			return;

		$f = igk_io_baseDir(IGK_DATA_FOLDER.DIRECTORY_SEPARATOR."usersvar.csv");
		$out = IGK_STR_EMPTY;
		foreach($this->m_vars as $k=>$v)
		{
			$v_cv = igk_getv($v, "value");
			$v_cc = igk_getv($v, "comment");
			if (!empty($out))
			{
				$out .= "\n";
			}
			$out .= $k.",".igk_csv_getvalue($v_cv).",".igk_csv_getvalue($v_cc);
		}
		if (igk_io_save_file_as_utf8($f, $out)){
			igk_notifyctrl()->addMsgr("msg.uservarsctrl.varsaved");
		}
		else{
			igk_wln($out);
			igk_exit();
		}
		$this->View();
	}
	public function search_var()
	{
		$this->m_searchkey = igk_getr("q");
		$this->View();
	}
	public function View(){
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}
		$t = $this->ConfigNode;
		$t->ClearChilds();
		igk_html_add_title($t, "title.uservariables");

		$t->addHSep();
		igk_add_article($this, "uservariableinfo" , $t->addDiv());
		$t->addHSep();

		$t->add(new IGKHtmlSearchItem($this->getUri("search_var"), $this->m_searchkey));



		$frm = $t->addForm();
		$frm["action"] = $this->getUri("vc_saveAllVars");
		igk_notify_sethost($frm->addDiv());
		$table = $frm->addTable();
		$tr = $table->addTr();
		IGKHtmlUtils::AddToggleAllCheckboxTh($tr);
			$tr->add("th")->Content =R::ngets(IGK_FD_NAME);
			$tr->add("th")->Content =R::ngets("clValue");
			$tr->add("th")->Content =R::ngets("clComment");
			$tr->add("th")->Content = IGK_HTML_SPACE;

		if (is_array($this->m_vars))
		{
			foreach($this->m_vars as $k=>$v)
			{
				$obj = (object)$v;
				if ($this->m_searchkey && !strstr(strtolower($k), strtolower($this->m_searchkey)))
					continue;
				$tr = $table->addTr();
				$td = $tr->addTd();
				$td->addInput("clName[]", "checkbox",$k);
				$td->addInput("clHName[]", "hidden", $k);
				$tr->addTd()->Content = $k;

				$tr->addTd()->addInput("clValue[]", "text", $obj->value);
				$tr->addTd()->addInput("clComment[]", "text", $obj->comment);
				IGKHtmlUtils::AddImgLnk($tr->addTd(), $this->getUri("vc_dropvars&n=".$k), "drop_16x16");

			}
		}
		$frm->addHSep();
		$frm->addInput("btn_save", "submit", R::ngets("btn.save"));
		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.addvars"), igk_js_post_frame($this->getUri("vc_addvarframe_ajx")));
		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.rmSelection"), "#", array("onclick"=>igk_js_a_postform($this->getUri("vc_rm_selection"))));
		igk_html_toggle_class($table);
	}
	public function vc_rm_selection()
	{

		$n = igk_getr(IGK_FD_NAME);
		if (is_array($n))
		{
		foreach($n as $k=>$v)
		{
			unset($this->m_vars[$v]);
		}
		$this->__storeVars();
		}
		$this->View();
		igk_navtocurrent();

	}
	public function vc_addvarframe_ajx()
	{
		$frame = igk_add_new_frame($this, __FUNCTION__);
		$frame->Title = R::ngets("title.addsystemvariable");

		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri("vc_addvars");
		$ul = $frm->add("ul");

		$ul->addLi()->addSLabelInput(IGK_FD_NAME);
		$ul->addLi()->addSLabelInput("clValue");
		$ul->addLi()->addSLabelInput("clComment");
		$frm->addHSep();
		$frm->addInput("btn_savevar", "submit", R::ngets("btn.save"));
		igk_wl($frame->Render());
	}
	public function vc_saveAllVars()
	{
		$tn = igk_getr(IGK_FD_NAME);
		$tv =igk_getr("clValue");
		$tc = igk_getr("clComment");

		if(igk_getr("btn_save"))
		{
			$tn = igk_getr("clHName");
		}

		for($i = 0; $i< igk_count($tn);$i++)
		{
			$n = $tn[$i];
			$v = igk_getv($tv, $i);
			$c = igk_getv($tc, $i);

			$this->regVars($n, $v, $c);
		}
		$this->__storeVars();
		igk_navtocurrent();
	}


	protected function InitComplete(){
		parent::InitComplete();
		//register user variable
		$file = igk_io_baseDir(IGK_PROJECTS_FOLDER."/register_uvar.phtml");
		if (file_exists($file )){
			include($file);
		}
	}
}

//---------------------------------------------------------------------------
// - template ...
//---------------------------------------------------------------------------
final class IGKTemplateCtrl extends IGKConfigCtrlBase
{

	public function getConfigPage(){return "template";}
	
	public function gettemplateFolder()
	{
		return igk_io_baseDir(IGK_TEMPLATES_FOLDER);
	}
	public function View(){
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}


		$t = $this->ConfigNode;
		$t->ClearChilds();
		igk_html_add_title($t, "title.template");

		$t->addHSep();
		igk_add_article($this, "template" , $t->addDiv());
		$t->addHSep();
		$frm = $t->addForm();
		$frm["action"]=$this->getUri("loadTemplate");
		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.loadTemplate"), igk_js_post_frame($this->getUri("loadTemplateFrame_ajx")));


		$t->addBr();


		$frm = $t->addForm();
		$frm["action"]=$this->getUri("saveTemplate");
		IGKHtmlUtils::AddBtnLnk($frm, R::ngets("btn.saveTemplate"), igk_js_post_frame($this->getUri("saveTemplateFrame_ajx")));
		$t->addHSep();
		$frm = $t->addForm();
		igk_html_add_title($frm, "title.templates");
		$frm->addDiv()->addScript()->Content = "(function(q){window.igk.ajx.post('".$this->getUri("tm_gettemplates_ajx")."',null,function(xhr){if (this.isReady()){ this.setResponseTo(q); }}); })(window.igk.getParentScript());";

	}
	public function getTemplateImg(){
		$n = igk_getr("n");
		$v_file = $this->templateFolder."/".$n.".template";

		header("Content-type: image/png");
		$f = false;
		if (is_file($v_file))
		{

			$hzip = zip_open($v_file);
			if (is_resource($hzip))
			{
				while( ($e = zip_read($hzip)))
				{
				$n = zip_entry_name($e);
				if ($n == "__image.png")
				{
					igk_wl(zip_entry_read($e,zip_entry_filesize($e)));
					$f =true;
					break;
				}
				}
				zip_close($hzip);
			}
		}
		if (!$f){
			igk_wl(IGKIO::ReadAllText(igk_io_baseDir("R/notemplatepic.png")));
		}
		igk_exit();
	}
	//<summary>get templates</summary>
	public function tm_gettemplates_ajx($uri=null)
	{
		//::: get template list
		$ul =  igk_createNode("ul");
		$ul["class"] = "igk_templates_list";
		$v_tfiles = IGKIO::GetFiles($this->templateFolder, "/\.template$/i", false);
		if ($v_tfiles)
		{
		foreach($v_tfiles as $f)
		{
			$li = $ul->addLi();
			$li["class"] = "dispib floatl";

			$div = $li->addDiv();

			$n = igk_io_basenamewithoutext($f);
			$div->addDiv(array("class"=>"title"))->Content =  $n;
			$cdiv = $div->addDiv();
			$cdiv->setClass("floatl");
			$cdiv->add("img", array("src"=>igk_io_baseUri().$this->getUri("getTemplateImg&n=".$n), "width"=>"100%"));
			$cdiv = $div->addDiv();

			IGKHtmlUtils::AddBtnLnk($cdiv, "btn.installTemplate", $this->getUri("tm_installTemplate&n=".$n));
			IGKHtmlUtils::AddBtnLnk($cdiv, "btn.uninstallTemplate", $this->getUri("tm_uninstallTemplate&n=".$n));
		}}
		else
			$ul->addLi()->Content = R::ngets("tip.notemplates");
		igk_wl($ul->Render());
	}
	public function tm_installTemplate()
	{
		$n = igk_getr("n");
		if ($n){
			$this->__installTemplate($this->templateFolder. "/". $n.".template");
			$this->View();
		}
	}
	public function tm_uninstallTemplate()
	{
		$n = igk_getr("n");
		if ($n){
			$v_f = $this->templateFolder. "/". $n.".template";
			if (file_exists($v_f))
			{
				//remove all item installe in the template

				@unlink($v_f);
			}
			$this->View();
		}
	}
	public function loadTemplateFrame_ajx($tempfile=null){
		$frame = igk_add_new_frame($this,"new_template_frame");
		$frame->Title = R::ngets("title.loadtemplate");

		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri("loadTemplate");
		$frm->addInput("clTemplateFile", "file");
		$frm->addHSep();
		$frm->addInput("btn_savetemplate", "submit", R::ngets("btn.loadtemplate"));
		igk_wl($frame->Render());
	}
	private function __installTemplate($file)
	{
		if( !file_exists($file))
			return;
		$hzip = zip_open($file);
		$outdir =  igk_io_baseDir();

		if (is_resource($hzip))
		{

			while( ($e = zip_read($hzip)))
			{
				$n = zip_entry_name($e);
				if ($n == "__template.def")
				{
					//load environment
					$this->__loadEnvironment(zip_entry_read($e,zip_entry_filesize($e)));
				}
				else{
					//extract zip
					if (igk_zip_entry_isdir($e))
					{
						igk_zip_create_dir($outdir, $n);
					}
					else{
						if (!(strpos($n, "/")===FALSE))
							igk_zip_extract($outdir, $hzip , $e);
					}
				}
			}
			zip_close($hzip);
			igk_notifyctrl()->addMsgr("msg.templateloaded");
			igk_getconfigwebpagectrl()->reconnect();
			igk_exit();

		}
		else{
			igk_notifyctrl()->addErrorr("e.templatefilenotvalid");
		}
	}
	public function loadTemplate($tempfile=null){
		$f = igk_getv($_FILES, "clTemplateFile");
		if ($f && isset($f["tmp_name"]) && ($f["error"]===0))
		{
			$this->__installTemplate($f["tmp_name"]);

			$this->ConfigCtrl->reconnect();
			igk_exit();
		}
		else
			igk_notifyctrl()->addError("Msg.TemplateLoadTemplateError");
	}
	private function __loadEnvironment($env)
	{
		//load environemnt
		$e =  igk_createNode("env");
		$e->Load($env);
		$n = IGK_STR_EMPTY;
		$v = IGK_STR_EMPTY;


		$t = igk_getv($e->getElementsByTagName("Template"), 0);
		$this->App->Configs->templateLoad = true;
		$this->App->Configs->templateName = $t["name"];
		$this->App->Configs->templateVersion = $t["version"];


		$t = igk_getv($e->getElementsByTagName("TemplateInfo"), 0);
		foreach($t->Childs as $k=>$v)
		{
			switch(strtolower($v->TagName))
			{
				case "defaultctrl":
					$this->App->Configs->web_pagectrl = trim($v->innerHTML);
				break;
			}
		}

		igk_save_config();

		//load colors
		$cls = igk_getv($e->getElementsByTagName("Colors"), 0);
		foreach($cls->Childs as $k)
		{
			$this->App->Doc->Theme->cl[$n] = $v;
		}
		$cls = igk_getv($e->getElementsByTagName("Styles"), 0);
		foreach($cls->Childs as $k)
		{
			$this->App->Doc->Theme[$n] = $v;
		}
		//save theme
		igk_getctrl(IGK_THEME_CTRL)->saveTheme();

		//load menu
		$cls = igk_getv($e->getElementsByTagName("Menus"), 0);
		$ctrl = igk_getctrl(IGK_MENU_CTRL);
		$ctrl->__ClearConfigMenu(false);
		foreach($cls->Childs as $k)
		{
			$t = $ctrl->getDefaultEntry();

			foreach($k->Attributes as $s=>$r )
			{
				$t[$s] = $r;
			}

			$ctrl->reg_menu($t,false);
		}
		$ctrl->__saveConfigMenu();

		$cls = igk_getv($e->getElementsByTagName("UserVariables"), 0);
		$ctrl  = igk_getctrl(IGK_USERVARS_CTRL);
		$ctrl->vc_Clearvars(false);
		foreach($cls->Childs as $k)
		{
			$ctrl->regVars($k["name"], $k["value"], $k["description"]);
		}
		$ctrl->__storeVars();
	}
	public function getCurrentTemplateDefinition($name= null, $desc=null, $cat = null, $image=null)
	{
		$e =  igk_createNode("Template");
		$e["name"] = $name;
		$e["version"] = IGK_VERSION;
		$e["description"] = $desc;
		$e["category"] = $cat;
		$e["created"] = igk_date_now();

		//template info
		$v_ti = $e->add("TemplateInfo");
		$v_ti->add("DefaultCtrl")->Content = igk_getv($this->App->Configs, "web_pagectrl");
		$v_ti->add("Image")->Content = $image;
		$menu = $e->add("Menus");

		//save menu

		foreach(igk_getctrl(IGK_MENU_CTRL)->UserMenu as $k)
		{
			$m = $menu->add("menu");
			foreach($k as $s=>$sv)
			{
				$m[$s] = trim($sv);
			}
		}

		$ctrls = $e->add("Controllers");
		//
		foreach($this->App->getControllerManager()->getUserControllers() as $k)
		{
				$ctrls->add("Ctrl", array(
					IGK_FD_NAME=>$k->Name,
				));
		}
		$ctrls = $e->add("UserVariables");
		foreach(igk_getctrl(IGK_USERVARS_CTRL)->getVars() as $k=>$v)
		{
			$obj = (object)$v;
				$ctrls->add("var", array(
					"name"=>$k,
					"value"=>$obj->value,
					"comment"=>$obj->comment
				));
		}
		$theme = $e->add("Themes");
		$clt = $theme->add("Colors");
		foreach($this->App->Doc->Theme->cl->Attributes as $k=>$v)
		{

			if (empty($v))continue;
			$clt->add("Color", array(
				"name"=>$k,
				"value"=>$v
			));
		}
		$clt = $theme->add("Styles");
		foreach($this->App->Doc->Theme->def->Attributes as $k=>$v)
		{
			if (empty($v))continue;
			$clt->add("css", array(
				"name"=>$k,
				"value"=>$v
			));
		}
		$option = (object)array("Indent"=>true);
		return igk_ansi2utf8(utf8_encode($e->Render($option)));
	}
	public function saveTemplate()
	{
		$tname = igk_getr("clTemplateName");
		$inc = igk_getr("clTemplateAllowInc");
		$desc = igk_getr("clTemplateDesc");
		$img = igk_getv($_FILES, "clTemplateImage");

		$e =  igk_createNode("error");
		$val = "IGKValidator";
		IGKValidator::Init();
		if (IGKValidator::IsStringNullOrEmpty($tname)){ IGKValidator::Error()->addLi()->Content = "string is null or empty"; }
		if (($img==null) || !igk_io_fileIsPicture($img["type"])){ IGKValidator::Error()->addLi()->Content = "image not specified"; }

		if (!IGKIO::CreateDir($this->templateFolder))
		{
			igk_notifyctrl()->addError(R::ngets("Msg.TemplateFolderCantBeCreated"));
			igk_frame_close("new_template_frame");
			return;
		}
		if (IGKValidator::Error()->HasChilds)
		{
			igk_notifyctrl()->addWarning(R::ngets("Msg.ErrorWhenTemplate"));
			return;
		}

		$file = igk_io_dir($this->gettemplateFolder()."/".$tname.".template");



		$zip = new ZipArchive();

		if ($zip->open($file, ZIPARCHIVE::CREATE))
		{

			$zip->addFromString("__template.def", $this->getCurrentTemplateDefinition($tname, $desc, igk_getr("clTemplateCat")));
			$zip->addFromString("__image.png", IGKIO::ReadAllText($img["tmp_name"]));
			//save Mods folder

			$dir = igk_io_baseDir(IGK_MODS_FOLDER);//."/".$tname.".template");
			igk_zip_dir($dir, $zip, "Mods");
			igk_zip_dir(igk_io_baseDir(IGK_RES_FOLDER), $zip, "R", "/\.(gkds)$/i");

			if ($inc)
			{
				igk_zip_dir(igk_io_baseDir(IGK_INC_FOLDER), $zip, "Inc");
			}

			$zip->close();
			igk_frame_close("new_template_frame");
			igk_notifyctrl()->addMsgr("Msg.TemplateSaved");
		}
		else{
			igk_notifyctrl()->addError(R::ngets("Msg.TemplateNotSaved"));
		}
		$this->View();

	}
	public function saveTemplateFrame_ajx()
	{
		$frame = igk_add_new_frame($this,"new_template_frame");
		$frame->Title = R::ngets("title.newtemplate");

		$d = $frame->BoxContent;
		$d->ClearChilds();
		$frm = $d->addForm();
		$frm["action"] = $this->getUri("saveTemplate");

		$frm->addDiv(array("class"=>"hide"))->Content= IGK_HTML_SPACE;
		$ul = $frm->add("ul");
		//($id, $text, $type="text",$value=null, $attributes=null, $require=false){
		$ul->addLi()->addSLabelInput("clTemplateName", "text", null, null, true);
		$ul->addLi()->addSLabelInput("clTemplateAllowInc", "checkbox");
		$ul->addLi()->addSLabelInput("clTemplateCat", "text", null, null, true);
		$ul->addLi()->addSLabelInput("clTemplateDesc");
		$ul->addLi()->addSLabelInput("clTemplateImage", "file", null,null, true);
		$frm->addHSep();
		$frm->addInput("btn_savetemplate", "submit", R::ngets("btn.save"));

		$frame->RenderAJX();
	}



}

//class used to register global user in system
class IGKUsersCtrl extends IGKConfigCtrlBase
{
	public function getName(){return IGK_USER_CTRL; }

	public function setUser($u){
		if (is_object($u)){
			$e = igk_db_get_select_entry($u, $this->getDataTableInfo());
			$k = igk_db_table_select_where($this->getDataTableName(),$e,  $this);
			if ($k->RowCount == 1){
				$this->App->Session->setUser($u, $this);
				return 1;
			}
		}
		return 0;
	}


	protected function initDb(){//init global balafon users
		if (!igk_is_conf_connected())
			return;

		$v = array($this, "__user_info");
				// igk_wln("check ....");
		// igk_debug(1);
		igk_notification_reg_event("sys://db/init_complete", $v);
		parent::initDb();
		igk_notification_unreg_event("sys://db/init_complete", $v);
		// igk_debug(0);
		// $ad = igk_get_data_adapter($this);
		// igk_wln("have no licks ". $ad->haveNoLinks($this->DataTableName));
		//e_xit;
		//exit;
	}
	public function getDataTableName(){return IGK_TB_USERS ;}
	public function getDataAdapterName()
	{
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){//user ctrl

		return array(
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>true, "clIsPrimary"=>true)),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clLogin", IGK_FD_TYPE=>"VarChar", IGK_FD_TYPELEN=>"60", "clIsUnique"=>true)),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clPwd", IGK_FD_TYPE=>"VarChar",
			IGK_FD_TYPELEN=>"60",
			"clNotNull"=>true,
			"clInsertFunction"=>"MD5", "clUpdateFunction"=>"MD5",
			"clInputType"=>"password")), //md5 passwd
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clFirstName", IGK_FD_TYPE=>"VarChar", IGK_FD_TYPELEN=>"60")),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clLastName", IGK_FD_TYPE=>"VarChar", IGK_FD_TYPELEN=>"60")),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clLevel", IGK_FD_TYPE=>"Int", IGK_FD_TYPELEN=>"11","clNotNull"=>true,"clDefault"=>0)),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clStatus", IGK_FD_TYPE=>"Int", "clDefault"=>"-1","clNotNull"=>true, "clDescription"=>"state of the account, -1 = not activated, 1=activated, 0or2=blocked" )),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clDate", IGK_FD_TYPE=>"Datetime", "clNotNull"=>true, "clDescription"=>"registration date", "clInsertFunction"=>"Now()" )),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clParent_Id", IGK_FD_TYPE=>"Int","clLinkType"=>IGK_TB_USERS,	IGK_FD_TYPELEN=>"11", "clDescription"=>"Parent of this account")),
			new IGKDbColumnInfo(array(IGK_FD_NAME=>"clClassName", IGK_FD_TYPE=>"VarChar",IGK_FD_TYPELEN=>255, "clDescription"=>"if clParent_Id then object refer to class name that initialize the sub user"))
			);
	}


	//init -
	protected function initDataEntry($db, $tbname=null){
	//	igk_wln("init user entries");
		$n = $this->DataTableName;
		$d = $this->App->Configs->website_domain;
		//$db->insert($n, array("clLogin"=>"bondje.doue@gmail.com","clPwd"=>md5("test123"), "clFirstName"=>"Charles", "clLastName"=>"BONDJE DOUE", "clLevel"=>-1, "clStatus"=>-1));

		//retrait de l'appel de la fonction md5 car la définition de la structure de table
		//defini la méthode d'insertion à une fonction de cryptage
		$now = date(IGK_MYSQL_DATETIME_FORMAT);

		$db->insert($n, array("clLogin"=>"admin@".$d, "clPwd"=>"test123", "clFirstName"=>"admin", "clLastName"=>"Administrator", "clLevel"=>-1, "clStatus"=>1, "clDate"=>$now));
		$db->insert($n, array("clLogin"=>"test@".$d,  "clPwd"=>"test123", "clFirstName"=>"test", "clLastName"=>"test", "clLevel"=>1, "clStatus"=>0, "clDate"=>$now));
		$db->insert($n, array("clLogin"=>"info@".$d,  "clPwd"=>"info123", "clFirstName"=>"info", "clLastName"=>"info", "clLevel"=>1, "clStatus"=>0, "clDate"=>$now));
		$db->insert($n, array("clLogin"=>"bondje.doue@igkdev.com","clPwd"=>"admin123", "clFirstName"=>"Charles", "clLastName"=>"BONDJE DOUE", "clLevel"=>0, "clStatus"=>1, "clDate"=>$now));
		$db->insert($n, array("clLogin"=>"igk.system@igkdev.com","clPwd"=>base64_encode(date("Ymd")."fsystem".rand(10,80)), "clFirstName"=>"", "clLastName"=>"IGKSystem", "clLevel"=>0, "clStatus"=>0, "clDate"=>$now));

	}
	public function __user_info(){
		igk_init_user_info();
	}
	public function getConfigPage(){return "users";}
	
	public function us_lockuser()
	{
		$email = igk_getr("email");
		$e = $this->getDbEntries();
		$t = $e->searchEqual(array("clLogin"=>$email));
		if ($t && is_object($t))
		{
			$t->clStatus = 2;
			igk_db_update($this, $this->getDataTableName(), $t);
			igk_navtocurrent("userlocked");
		}
		else{
			igk_navtocurrent();
		}
	}
	public function us_activate(){
		$rp = igk_getquery_args(base64_decode(igk_getr("q")));
		$email = igk_getv($rp, "u");
		$gooduri = igk_getv($rp, "redirect");
		$date = igk_getv($rp, "d");
		$e = $this->getDbEntries();
		$t = $e->searchEqual(array("clLogin"=>$email));
		if ($t && is_object($t))
		{
			$o = 0;
			if ($t->clStatus!=1){
				$t->clStatus = 1;
				unset($t->clPwd); //to avoid updating user

				$o = igk_db_update($this, $this->getDataTableName(), $t);
			}
			if ($o && $gooduri){
				igk_navto($gooduri);
				igk_exit();
			}
			$f = igk_io_baseDir()."/pages/signup_confirmation.php";
			if (file_exists($f)){
				$f = igk_html_uri(igk_io_baseUri()."/".igk_io_basePath($f));
				igk_notification_push_event("user/activate_login", $this);
				igk_navto($f);
			}
		}
		igk_navtocurrent();
	}
	public function us_resetpwd(){
		$npwd = igk_getr("clNewPwd");
		$e = $this->getDbEntries();
		$t = $e->searchEqual(array("clPwd"=>igk_getr("clLogin")));
		if ($t && is_object($t))
		{
			$t->clStatus = 1;
			$this->update($t);
			igk_navtocurrent("pwdchanged");
		}
		else{
			igk_navtocurrent();
		}

	}
	public function setGlobalUser($u){
		$this->App->Session->setUser($u, $this);
	}
	///<summary>connect to user</summary>
	///<param name="log">display login</param>
	///<param name="pwd">clear pwd</param>
	public function connect($log=null, $pwd=null){//connection for users
		$u = $this->App->Session->User;

		if ($u != null)
			return false;
		$rm_me  = null;
		if ($log == null){
			$log = igk_getr("clLogin");
			$pwd = igk_getr("clPwd");
			$rm_me = igk_getr("remember_me");

		}
		$e = $this->getDbEntries();

		if ($e){
			if (!preg_match("/@(.)+$/i", $log)){
				$log = $log."@".$this->App->Configs->website_domain;
			}
			$tab = array("clLogin"=>$log, "clPwd"=>md5($pwd));

			$t = $e->searchEqual($tab);

			if ($t && is_object($t))
			{
				if ($t->clStatus == 1)
				{//active user
					$t = igk_sys_create_user($t);
					//$this->m_User = $t;
					$this->setGlobalUser($t);
					$u = $this->App->Session->User;
					if ($rm_me ){
						igk_user_store_tokenid($t);
					}
					return true;
				}
				else{
					$this->app->Session->ErrorString = "[connectfailed] : status of the requested user is not activated";

					return false;
				}
			}
		//	igk_die("Ec");
		}else{
			igk_notifyctrl("login")->addWarningr("warn.connection.db.failed");
		}
		return false;
	}
	public function logout(){
		$n =igk_get_cookie_name( igk_sys_domain_name()."/uid");
		// igk_wln($n);
		 //igk_wln($_COOKIE);
		 //unset the cookie
		setcookie($n, "",time()-(3600), igk_get_cookie_path() /*,'/igkdev/'*/);
		unset($_COOKIE[$n]);
		$u = $this->App->Session->User;
		if ($u!=null){
			if (isset($u->clTokenStored))
				igk_user_set_info("TOKENID", null);
			$this->App->Session->setUser(null, $this);

		}

		// igk_wln($n);
		//igk_wln($_SERVER);
		// igk_wln($_COOKIE);
		//igk_exit();
		return true;
	}


	public function getSubUsers($u=null){
		if($u == null)
			$u = $this->app->Session->User;
		if ($u==null)
			return null;
			$s = new IGKDbUtility($this);
		if ($s->connect()){
			$r = $s->select(IGK_TB_USERS, array("clParent_Id"=>$u->clId));
			if ($r->RowCount==0)
				return array();
			return $r->Rows;
		}
		return null;
	}
	public function getRootUser($u=null){
		if($u == null)
			$u =$this->app->Session->User;
		if ($u==null)
			return null;
		$s = new IGKDbUtility($this);
		if ($s->connect()){
		while($u->clParent_Id){
			$r = $s->selectFirstRow(IGK_TB_USERS, array("clId"=>$u->clParent_Id));
			if (!$r){
				$u=null;
				break;
			}
			$u = $r;
		}
		$s->close();
		}
		return $u;
	}
	///<summary>add user frame</summary>
	public function uc_auf(){
		$inconf = 	igk_is_conf_connected();
		$not = igk_notifyctrl("sys://uc/auf");
		if (igk_qr_confirm())
		{
			$o = igk_get_robj();


			if (!$inconf  && (!isset($o->clAcceptCondition) || !$o->clAcceptCondition)){
				$not->addErrorr("e.youmustaccepttermandcondition");
				return;
			}

			if (IGKValidator::IsStringNullOrEmpty($o->clLogin))
			{
				$not->addErrorr("e.loginIsNullOrEmpty");
				return;
			}
			if (!igk_user_pwd_required($o->clPwd, $o->clRePwd)){
				$not->addErrorr("e.passwordnotmatchrequirement");
				return;
			}
			// if (!IGKValidator::IsValidPwd($o->clPwd))
			// {
				// $not->addErrorr("e.passwordnotvalid");
				// return;
			// }
			// if (isset($o->clRePwd) && ($o->clPwd != $o->clRePwd))
			// {
				// $not->addErrorr("e.passwordnotmatch");
				// return;
			// }
			unset($o->clRePwd);
			unset($o->clAcceptCondition);
			if ($o->clPwd)
				$o->clPwd = md5($o->clPwd);

			$tb = $this->getDataTableName();

			//igk_db_delete($this, $tb, array("clLogin"=>$o->clLogin));

			if (igk_db_table_select_where($tb, array("clLogin"=>$o->clLogin))->RowCount>0){
				igk_notifyctrl()->addErrorr("e.accountalready_register");
				igk_notifyctrl()->mark("clLogin");

				return;
			}

			$i = igk_db_insert($this, $tb, $o) || 1;

			if ($i){

				$not->addMsgr("msg.useradded");

				//initalize user
				$ctrl = igk_get_regctrl("docs");
				if ($ctrl && !igk_getr("conf")){
					igk_ilog("send mail");
					$info = "u=".$o->clLogin."&d=".date("y-m-d");
					$o->ConfirmationLink = $this->getUri("us_activate&q=".base64_encode($info));

					$d = new IGKHtmlMailDoc();

					$d->Message->Load($ctrl->getArticleContent("confirmmail", true, $o));

					$f = $d->sendMail($o->clLogin ,
						$this->App->Configs->mail_contact,
						R::ngets("title.mailconfirmation")->getValue()
						);
					if (!$f){
						igk_notifyctrl()->addErrorr("e.confirmail.failed");
					}
				}
			}
			else{
				igk_notifyctrl()->addErrorr("e.registrationnotpossible");
			}
			$nonav = !igk_getr("noNavigation");
			igk_resetr();
			$this->View();
			if ($nonav)
			igk_navtocurrent();
			return;
		}
		else{
			// $frame = igk_add_new_frame($this, __FUNCTION__);
			// $frame->Title = R::ngets("title.addusers");
			$frm = igk_createNode("form");//$frame->BoxContent->addForm();
			$frm["action"] = $this->getUri(__FUNCTION__);
			$ul = $frm->add("ul");

			igk_html_buildform($ul, array("clFirstName"=>array("require"=>1),
			"clLastName"=>array("require"=>1),
			"clLogin"=>array("require"=>1),
			"clPwd"=>array("require"=>1, "type"=>"password", "attribs"=>array("autocomplete"=> "current-password")),
			"clRePwd"=>array("require"=>1, "type"=>"password", "attribs"=>array("autocomplete"=> "current-password")),
			"clLevel"=>array("require"=>1,"attribs"=>array("value"=>"0"))
			));


			// $ul->addLi()->addSLabelInput("clFirstName");
			// $ul->addLi()->addSLabelInput("clLastName");
			// $ul->addLi()->addSLabelInput("clLogin","email");
			// $ul->addLi()->addSLabelInput("clPwd","password");
			// $ul->addLi()->addSLabelInput("clLevel","text")->input->setAttribute("igk-data-role","number");
			$frm->addInput("confirm", "hidden", 1);
			$frm->addInput("conf", "hidden", 1);
			$frm->addHSep();
			$frm->addInput("btn.add", "submit");
			//$frame->RenderAJX();
			//igk_notifybox_ajx("Please Add Users");
			igk_ajx_notify_dialog(R::ngets("title.addusers"), $frm->Render(null));

		}
		igk_exit();
	}
	private function uc_options($frm){
		IGKHtmlUtils::AddImgLnk($frm->addspan(), igk_js_post_frame($this->getUri("uc_auf")), "add_16x16");
	}
	public function View(){
		if (!$this->getIsVisible())
		{
			igk_html_rm($this->TargetNode);
			return;
		}
		$t = $this->ConfigNode;
		$t->setStyle("padding-left:20px; padding-right:20px");
		$t->ClearChilds();
		igk_html_add_title($t, "title.users");

		$t->addHSep();
		$t->addPanelBox()->addDiv()->addArticle($this, "users");
		$t->addHSep();
		$frm = $t->addForm();

		$frm->addNotifyHost("sys://uc/auf");

		//igk_notify_sethost($frm->addDiv());
		//: view users
		$v_acbar = $frm->addActionBar();


		$this->uc_options($frm);
		$table = $frm->addDiv()->setClass("igk-table-host")->addTable();
		$this->uc_options($frm);
		$table["class"] = "igk-table igk-table-hover igk-users-list";
		$r = igk_db_table_select_where($this->getDataTableName() , null, $this);

		//options


		if ($r){
			$tr = $table->addTr();
			$tr->add("th")->addSpace();
			$tr->add("th")->Content = R::ngets("lb.clFirstName");
			$tr->add("th")->Content = R::ngets("lb.clLastName");
			$tr->add("th")->setClass("fitw")->Content = R::ngets("lb.clLogin");
			$tr->add("th")->Content = R::ngets("lb.clLevel");
			$tr->add("th")->Content = R::ngets("lb.clStatus");
			$tr->add("th")->Content = R::ngets("lb.clDate");
			$tr->add("th")->Content = R::ngets("lb.clClassName");

			$tr->add("th")->addSpace();
			$tr->add("th")->addSpace();
			$tr->add("th")->addSpace();

			$selected = igk_getr("v", 1);
			$perpage=5;
			$max = $perpage;
			$count=  $r->RowCount;
			$epagination = $max<$count;
			$it = new IGKIterator($r->Rows);
			$it->setRewindStart($perpage* ($selected - 1));
			foreach($it as $k=>$v){
				$tr = $table->addTr();
				$tr->addTd()->addInput("r", "checkbox", $v->clId);
				$tr->addTd()->Content = $v->clFirstName;
				$tr->addTd()->Content = $v->clLastName;
				$tr->addTd()->Content = $v->clLogin;
				$tr->addTd()->Content = $v->clLevel;
				$tr->addTd()->Content = $v->clStatus;
				$tr->addTd()->Content = $v->clDate;
				$tr->addTd()->Content = $v->clClassName;

				IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri('u_edit&id='.$v->clId)), "edit_16x16");
				IGKHtmlUtils::AddImgLnk($tr->addTd(), igk_js_post_frame($this->getUri('u_block&id='.$v->clId), '^.igk-cnf-content'), "drop_16x16");

				$tr->addTd()->addDiv()->setClass("igk-svg-btn")->setStyle("width:16px; height:16px")->Content = igk_svg_use("group");
				$max--;
				if ($max==0)
					break;
			}

			if ($epagination){
					//igk_wln("add pagination {$count}, {$perpage}, {$selected}");
				$frm->addDiv()->addAJXPaginationView(igk_io_currentUri().'/'.$this->getUri("view&v="), $count, $perpage, $selected);
			}
		}
		// igk_wln("kjd ".igk_io_baseUri().$this->getUri("view&v="));
		// igk_die("kjd ".igk_io_currentUri().$this->getUri("view&v="));
		if (igk_app()->Session->URI_AJX_CONTEXT){
			$t ->RenderAJX();
			igk_exit();
		}
	}
	private function getuser($id){
		$r = igk_db_table_select_where($this->getDataTableName() ,
			array(IGK_FD_ID=>$id),
			$this);
		if ($r && ($r->RowCount==1))
		{
			return $r->getRowAtIndex(0);
		}
		return null;
	}
	public function u_block(){
		if (!igk_sys_authorize('sys://auth/blockuser'))
		{
			igk_exit();
		}

		$u = $this->getuser(igk_getr("id"));
		if ($u){
			if ($u->clStatus == 1){
				$u->clStatus = 2;
			}
			else
				$u->clStatus = 1;


			igk_db_update($this, $this->getDataTableName(),$u);
			igk_notifyctrl("sys://uc/auf")->addSuccessr("msg.user.inforupdated");
			$this->View();
		}
		igk_wl($this->ConfigNode->getinnerHTML());
		igk_exit();

	}
	public function u_edit(){
		if (!igk_sys_authorize('sys://auth/edituser'))
		{
			igk_exit();
		}
		$id = igk_getr("id");
		igk_getctrl(IGK_MYSQL_DB_CTRL)->db_edit_entry_frame($this,
			$this->App->Configs->db_name,
			$this->getDataTableName(),
			$id,IGK_FD_ID,
			true);
		igk_exit();
	}
	public function IsFunctionExposed($func){//expose all
		return true;
	}
	public function signup(){//call to regiter to plateform
		$doc = igk_get_document("system/signup");
		$doc->Title = R::ngets("title.welcome_1", $this->App->Configs->website_title);
		$mbox = $doc->body->addBodyBox()->setClass("igk-register");
		$mbox->ClearChilds();
		$mbox->addIGKHeaderBar()->Title = R::ngets("title.registration");
		$d = $mbox->addDiv()->addContainer()->addRow();
		$regfrm = $d->addCol()->setClass("igk-col-4-4")->addRegistrationForm();
		$regfrm->Action = $this->getUri("uc_auf");
		$regfrm->GoodUri = "";
		$regfrm->BadUri = "";
		$regfrm->initView();
		$d = $mbox->addDiv();
		$d->addDiv()->Content = $this->App->Configs->copyright;
		$doc->RenderAJX();
		igk_exit();
	}


	public function connectpage(){//call to signup on plateform
		$u = $this->App->Session->User;
		if ($u!=null)
		{
			igk_navto(igk_io_baseUri());
		}
		$doc = igk_get_document("system/connectionpage"); // new IGKHtmlDoc($this->App, true);
		$doc->Title = R::ngets("title.welcome_1", $this->App->Configs->website_title);
		$mbox = $doc->body->addBodyBox()->setClass("igk-connect");
		$mbox->ClearChilds();
		$mbox->addIGKHeaderBar()->Title = R::ngets("title.connect");
		$d = $mbox->addConnectForm();
		$d->GoodUri = $this->getAppUri("");
		$d->BadUri  = $this->getAppUri("");

		$doc->RenderAJX();
		igk_exit();
	}

	public function begin_pwd_reset(){
		$doc = new IGKHtmlDoc($this->App, true);
		$domain =$this->App->Configs->website_domain;
		$doc->Title = R::ngets("title.welcome_1", $domain);

		$mbox = $doc->body->addBodyBox()->setClass("igk-register");
		$mbox->addIGKHeaderBar()->Title = R::ngets("title.beginpwdreset");

		$p = $mbox->addDiv()->addContainer()->addDiv();
		$p["style"] = "max-width:380px; margin:auto;";
		$p->addDiv()
		->setClass("igk-title-5")
		->Content = R::ngets("title.findyouraccount_1", $domain);
		$frm = $p->addForm();
		$frm["action"] = $this->getUri("check_email");
		$div = $frm->addDiv();
		$div->addLabel("clEmail")->Content = "lb.youremail";
		$div->addInput("clEmail", "text")
		->setClass("igk-form-control")
		->setAttribute("placeholder", "tip.yourmail");

		$div->addDiv()
		->addInput("btn_search", "submit" , "btn.search")
		->setClass("igk-btn");

		$p->addDiv();
		$p->addDiv()->Content = $this->App->Configs->copyright;
		$doc->RenderAJX();
		igk_exit();
	}
	public function logout_lnk(){
		$this->logout();
		igk_navto(igk_io_baseUri());
	}

	private $m_db;
	public function getDb(){
		if ($this->m_db==null)
			$this->m_db = new IGKDbUtility($this);
		return $this->m_db;
	}

}
//-------------------------------------------------------------------------------
//used to register controls
//--------------------------------------------------------------------------------
final class IGKCtrlTypeManager
{
	static  $tabManager;
	//get all available controller byte
	public static function GetControllerTypes()
	{


		if ( self::$tabManager == null){
		$tab = array();
		$exp = "/^(IGK){0,1}(?P<name>[\w_-]+)Ctrl$/i";
		foreach(get_declared_classes() as $k=>$v)
		{
			if (igk_reflection_class_extends( $v,  "IGKCtrlTypeBase") && igk_reflection_class_isabstract($v) && preg_match($exp, $v) )
			{
				preg_match_all($exp, $v, $t);
				$tab[$t["name"][0]] =$v;
			}
		}
		self::$tabManager = $tab;
		return $tab;
		}
		return self::$tabManager;

	}

}
final class IGKHtmlUsageCondition extends IGKObject
implements IIGKHtmlGetValue
{
	public function getValue($o=null){
		$c = igk_createNode("span");
		$tc = igk_get_regctrl("sys://articles");
		$uri = "#";
		if ($tc!=null){
			$uri = $tc->getUri("usagecondition");
		}
		$c->Content = R::ngets("lb.span.accept.usagecondition_1");
		$c->addA($uri)->Content = R::ngets("lb.usagecondition");
		return $c->Render($o);
	}

}
//TEMP : Preload Images
final class IGKPics extends IGKNonVisibleControllerBase
{
	public function IsFunctionAvailable($f)
	{
		return $f == 'view_alls';
	}
	public function view_alls()
	{
		//for shortcut
		$doc = new IGKHtmlDoc($this->App, true);
		$t = $doc->addBodyBox()->addDiv();
		$pics = igk_getctrl(IGK_PIC_RES_CTRL)->getAllPics();
		$t->ClearChilds();
		$out ="igk.ready(function(){var v =null;";
		foreach($pics as $k=>$v)
		{
			$out .= "v = document.createElement('img'); v.src='".R::GetImgUri($k)."'; document.body.AppendChild(v);\n";
		}
		$t->addScript()->Content = $out. "});";

		$doc->RenderAJX();
	}
}

///<summary>controller used to cache page on server</summary>
final class IGKCacheCtrl extends IGKNonVisibleControllerBase
{
	public function getName(){return "cachectrl"; }
	public function __toString(){ return "cachectrl"; }

	public function getCacheFile($name)
	{
		return igk_io_baseDir(IGK_CACHE_FOLDER."/".$name);
	}
	public function __construct()
	{
		parent::__construct();
	}


	protected function InitComplete(){//cache controller
		parent::InitComplete();
		$meta =  igk_createNode("meta");
		$meta["http-equiv"] = "Cache-control";
		$meta["content"]="public";
		$this->App->Doc->Metas->addMeta("CacheControl", $meta); //"Cache-control" content="public">
	}
	public function storeCache($name, $out)
	{
			$f = $this->getCacheFile($name);
			ob_start();
			igk_wl($out);
			ob_end_clean();
			igk_io_save_file_as_utf8($f, utf8_decode($out));
			igk_wl($out);
	}

	public function loadCache($name, $ctrl=null){
		$t = igk_getdv($this->App->Configs->cache_file_time, 3600);
		$expire = time()-$t;
		$f = $this->getCacheFile($name);

		if (file_exists($f) && (filemtime($f) > $expire))
		{
			readfile($f);
			return true;
		}
		else{
			if (($ctrl!=null))
			{
				ob_start();
				$ctrl->View();
				$o = $ctrl->TargetNode->Render();
				igk_wl($o);
				ob_end_clean();
				igk_io_save_file_as_utf8($f, utf8_decode($o));
				igk_wl($o);
			}
		}
		return false;
	}
}

//----------------------------------------------------------------------------------------
//CLOSURE MANAGEMENT
//situation: serialization of closure is not allowed. balafon expose work arround.
//----------------------------------------------------------------------------------------

///<summary>system uri actions provider used with igk_redirection.php to provide web redirection according to given url</summary>
final class IGKSystemUriActionCtrl extends IGKConfigCtrlBase
{
	private $m_actions; //default action
	private $m_globals; //global actions
	//private $m_patterInfo;
	public function getName(){return IGK_SYSACTION_CTRL; }
	//public function getIsVisible(){return false;}
	public function getCanAddChild(){return false;}
	public function getConfigPage(){return "systemuri";}
	public function getDataTableInfo(){//uri action
		return array(
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clId", IGK_FD_TYPE=>"Int", "clAutoIncrement"=>true, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>IGK_FD_NAME, IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255, "clIsUnique"=>true, "clIsPrimary"=>true)),
		new IGKdbColumnInfo(array(IGK_FD_NAME=>"clUri", IGK_FD_TYPE=>"VARCHAR", IGK_FD_TYPELEN=>255))
		);
	}
	public function getDataTableName(){
		return IGK_TB_SYSTEMURI;
	}
		public function getDataAdapterName()
		{
			return IGK_MYSQL_DATAADAPTER;
		}
		public function gotoconfig(){
			igk_navtocurrent("Configs");
		}
		public function getmailto(){
			//echo "<meta http-equiv='refresh' content='0;URL=mailto:bondje.doue@igkdev.com'>";
			igk_navto("mailto:bondje.doue@gmail.com");
			igk_exit();
		}
		protected function InitComplete(){
			parent::InitComplete();
			$this->App->Session->addInitializeSessionEvent($this, "_initializeCtrl");
			$this->m_actions =array();
			$this->m_globals =array();

			//init global action
			$this->m_actions["^/config(.php)?$"] = parent::getUri("gotoconfig");
			$this->m_actions["^/Configs!Settings$"] = igk_getconfigwebpagectrl()->getUri("configure_settings");

			$t = igk_get_env("sys://configs/options");
			if ($t ){
				//store configs options
				foreach($t as $k=>$v){
					$this->m_actions["^/Configs!{$k}$"] = igk_getconfigwebpagectrl()->getUri("configure&v=".$v);
				}
			}



			$this->m_actions["/@!(.)+"] = $this->getUri("invoke_action");
			$this->m_actions["/clr$"] = "?c=".IGK_SESSION_CTRL."&f=ClearS";
			$this->m_actions["/run-cron$"] = "?c=".IGK_SESSION_CTRL."&f=RunCron";
			$this->m_actions["/reconnect$"] = igk_getconfigwebpagectrl()->getUri("reconnect");
			$this->m_actions["^/initsdb$"] = "?c=".IGK_MYSQL_DB_CTRL."&f=pinitSDb";
			$this->m_actions["^/getmailto$"] = parent::getUri("getmailto");
			$uctrl = igk_getctrl(IGK_USER_CTRL);
			$this->m_actions["^/connect$"] = $uctrl->getUri("connectpage");
			$this->m_actions["^/signup$"] = $uctrl->getUri("signup");
			$this->m_actions["^/users/begin_reset_pwd$"] = $uctrl->getUri("begin_pwd_reset");
			$this->m_actions["^/users/logout$"] = $uctrl->getUri("logout_lnk");

			$sys_c = igk_getctrl(IGK_SYS_CTRL);
			//api primary action
			$this->m_actions["^/sys_api/check_mod_rewrite$"]  = $sys_c->getUri("mod_rewrite");


			// //register page actions
			// $tab = igk_sys_pagelist();
			// foreach($tab as $k=>$v)
			// {
				// $this->m_actions["^/".$v."(/:lang)?$"] = parent::getUri("sys_ac_navigateto");
			// }


			//copy to global
			$this->m_globals = array_merge($this->m_actions, $this->m_globals);


			//DO: register from database
			$e = $this->getDbEntries();
			if ($e && ($e->RowCount>0))
			{
				foreach($e->Rows as $k=>$v)
				{
					if (is_object($v))
					{
						$this->sys_ac_register($v->clName, $v->clUri);
					}
					else {
						igk_wln("object not register from db");
						igk_wln($v);
					}
				}
			}

		}


		public function invokePageAction($type, $ctrl, $func, $args){

			switch($type){
				case "sys":
					$ctrl = igk_getctrl($ctrl);
						if ($ctrl){
							//get the params
						$e = igk_sys_ac_create_pattern($ctrl, "/".$func."/".$args);						
						$cp = $e->getParams();
						
						$f = igk_getv($cp, "function");
						$args = igk_getv($cp, "params");
						if ($ctrl->IsFunctionExposed($f)){
							try{
								call_user_func_array(array($ctrl, $f), is_array($args)? $args : array($args));
							}
							catch(Exception $ex){
								igk_show_exception($ex);
								igk_exit();
							}
						}
						igk_navto(igk_io_baseUri());
						igk_exit();
					}
					break;
				default:
				break;
			}
			igk_ilog("Not Handle: [{$func}]", __FILE__."::".__METHOD__);

		}

		public function invoke_action(){
			//igk_wln("invoke action");
			// igk_wln($_SERVER);
			$u = igk_getv($_SERVER,"REQUEST_URI");
			$c = preg_match_all("/^\/@!(?P<name>([^\/]+))(\/(?P<param>(.)+))?$/i", $u, $tab);
			if ($c){
			$n = strtolower(igk_getv($tab,"name")[0]);
			$p = explode("/", igk_getv($tab,"param")[0]);
			switch($n){
				case "actions":
				$ke= "sys://actions/scripts/".$p[0];
				$s = igk_get_env($ke);
				if ($s && igk_is_callable($s)){
					call_user_func_array($s,array_slice($p,1));
				}
				break;
				default:
					$ke= "sys://".$n."/scripts/".$p[0];
					$s = igk_get_env($ke);
					if ($s && igk_is_callable($s)){
						call_user_func_array($s,array_slice($p,1));
					}
				break;
			}
			}
			else{
				igk_ilog("expression not valid ".$u);
			}

			igk_exit();
		}
		public function _initializeCtrl(){
			//$this->m_patterInfo = null;
		}
		public function IsFunctionExposed($k){//expose all
			return true;
		}

		public function sys_ac_navigateto(){
			$p = igk_getr('p');
			
			if (isset($p))
			{
				igk_navto(igk_io_baseUri()."/".$p);
			}
			$k =igk_sys_ac_getpatterninfo();
			$tab = $k->getParams();
			$l = igk_getv($tab, "lang");
			$s= "?p=".igk_getv($tab, "page");
			if ($l){
				$s .= "&l=".$l;
			}
			$this->App->getControllerManager()->InvokeUri($s);
		}
		public function contains($key)
		{
			if (is_array($this->m_actions))
				return array_key_exists($key, $this->m_actions);
			return false;
		}
		public function matche($uri)
		{
			//get regex pattern
			if ($this->m_actions){

				foreach($this->m_actions as $k=>$v)
				{
					$pattern = igk_pattern_matcher_get_pattern($k);
					if (preg_match($pattern , $uri))
					{
						return new IGKSystemUriActionPatternInfo( array(
						"action"=>$k,
						"ctrl"=>null,
						"value"=>$v,
						"pattern"=>$pattern,
						"uri"=>$uri,
						"keys"=> igk_str_get_pattern_keys($k)));
					}
				}
			}
			return null;
		}

		///<summary> use to match global registrated uri</summary>
		public function matche_global($uri){

			if ($this->m_globals){

				foreach($this->m_globals as $k=>$v)
				{
					$pattern = igk_pattern_matcher_get_pattern($k);
					if (preg_match($pattern , $uri))
					{
						return new IGKSystemUriActionPatternInfo( array(
						"action"=>$k,
						"ctrl"=>null,
						"value"=>$v,
						"pattern"=>$pattern,
						"uri"=>$uri,
						"keys"=> igk_str_get_pattern_keys($k)));
					}
				}
			}
			return null;
		}

		public function getSystemUri($key=null)
		{
			if ($this->contains($key))
				return $this->m_actions[$key];
			return null;
		}
		public function invokeUri($key)
		{
			$this->App->getControllerManager()->InvokeUri($this->getSystemUri($key));
			//if necessary
			igk_render_doc();
			igk_exit();
		}
		public function getPatternInfo(){
			return igk_get_env(IGK_ENV_URI_PATTERN_KEY);//$this->m_patterInfo;
		}
		public function invokeUriPattern($pattern, $render=1){
			//set session page folder to HOME in global without raising page folder changed
			$app = igk_app();
			$app->Session->PageFolder = IGK_HOME_PAGEFOLDER;			
			// igk_wln("invoke uri pattern ....");
			// set the uri pattern
			igk_set_env(IGK_ENV_URI_PATTERN_KEY, $pattern);
			//$this->m_patterInfo = $pattern;
			$v_uri = igk_getv($this->m_actions, $pattern->action);

				
			//.if $v_uri is empty will invoke the default ctrl view			
			$app->getControllerManager()->InvokeUri($v_uri);
			//
			//#!\\if necessary reset and and render the global document
			//
			if ($render){
				igk_render_doc(); // render global document
				igk_exit();
			}
		}
		public function invokeCtrlUriPattern($ctrl, $pattern, $render=1){
		    if(igk_get_env("sys://call/".__METHOD__) == 1){
				igk_debug_wln("Invoke Ctrl Uri Pattern is not allowed");
				//return;
			}
			igk_set_env("sys://call/".__METHOD__ , 1);

			$this->setParam("targetctrl", $ctrl);
			igk_set_env(IGK_ENV_URI_PATTERN_KEY, $pattern);
			//$this->m_patterInfo=$pattern;
			// $ctrl->evaluateUri();
			$this->App->getControllerManager()->InvokePattern($pattern);
			//if reach here necessary
			//$this->m_patterInfo = null;
			$this->setParam("targetctrl", null);
			//if necessary
			if ($render){
				igk_render_doc();
				igk_exit();
			}
		}
		public function sys_ac_register($p, $uri)
		{
			if (isset($this->m_actions[$p])){
				igk_debug_wln("Action name ".$p." already register <br />".
				"old: ".$this->m_actions[$p]."<br />".
				"new: ".$uri."<br />"
				);
				return;
			}
			$this->m_actions[$p] = $uri;
		}
		public function sys_ac_unregister($uripattern){
			if (isset($this->m_actions[$uripattern])){
				unset($this->m_actions[$uripattern]);
			}
		}

		public function View(){

			if (!$this->getIsVisible())
			{
				igk_html_rm($this->TargetNode);
				return;
			}
		$c = $this->TargetNode;
		igk_html_add($c, $this->ConfigNode);

		$c->ClearChilds();
		igk_html_add_title($c, "title.SystemUriView");
		$c->addHSep();
		igk_add_article($this, "systemuri", $c->addDiv());
		$c->addHSep();

		$div = $c->addDiv();
		// $frm = $div->addForm();
		// $frm["method"]="POST";
		// $frm["action"]=$this->getUri("-");

		// $d = $frm->addDiv();
		// $d["class"]="form-group";
			$ul  = $div->add("ul");
				foreach($this->m_actions as $k=>$v)
				{
					$li = $ul->addLi()->setClass("clearb");
					$li->add("span", array("class"=>"igk-col-4-2 no-overflow igk-text-ellipis"))->Content = $k;
					$li->add("span", array("class"=>"igk-col-4-2"))->Content = $v;
				}

		}
		///<summary>get action list</summary>
		public function getActions(){
			return $this->m_actions;
		}
		///<summary>invoke this method with curl service to dispathc message to controller</summary>
		public function dispatchMessage(){
			
			//test : access
			// igk_wln($_SERVER);
			// igk_wln("test service");
			
			// igk_wln(igk_get_allheaders());
			
			if (!igk_is_srv_request()){
				// igk_wln($_SERVER);
				if (!igk_sys_env_production()){
					igk_ajx_toast("Can't dispatch message : not a local server request");
				}
				//;;;;;
				// session_destroy();
				igk_exit();
			}			
			
			
			
			//igk_wln(igk_is_local_request());
			
			$ctrl = igk_getctrl(igk_getr("ctrl"));
			$uri = igk_getr("uri");
			$param = igk_getr("param");
			$src = igk_getr("source");
			
			// igk_wln($_REQUEST);
			session_write_close();
			if ($ctrl !== $this){
				// igk_wln("invoke pattern");
				$e = igk_sys_ac_create_pattern($ctrl, $uri);//"/".$func."/".$args);						
				$cp = $e->getParams();
				$bck = $_REQUEST;
				$_REQUEST = $param;
				// igk_wln($cp);
				
				$fc = igk_getv($cp, "function");
				$p = igk_getv($cp, "params");
				
				if ($p && !is_array($p)){
					$p = array($p);
					$cp["params"] = $p;
				}
				
				igk_set_env("sys://no_render", 1);
				igk_set_env("sys://ajx_demand", 1);
				igk_set_env("sys://action/dispatchmessage", array("ctrl"=>1, "uri"=>$uri));
				
				if (method_exists($ctrl ,  $fc)){
					call_user_func_array(array($ctrl, $fc), is_array($p)?$p:array($p));
				}else{	
					$g = 0;
					if (method_exists($ctrl, "OnMessage"))
					{
						call_user_func_array(array($ctrl, "OnMessage"), 
						array($src, 
							is_array($cp)?$cp:array($cp)
						)
						);
						$g = 1;
					}
					// $g = $ctrl->evaluateUri($e, 3, 0);					
					if (!$g){					
						igk_ajx_toast("Can't dispatch message : {$uri}");					
					}
				}		
				igk_set_env("sys://action/dispatchmessage",0);
			}
			igk_exit();
		}
}




///<summary>represent information pattern</summary>
final class IGKSystemUriActionPatternInfo
extends IGKObject
{
		var $action;
		var $value;
		var $pattern;
		var $uri;		//uri that match the request
		var $keys;
		var $requestparams;
		var $ctrl;     // ctrl that target action to invoke
		var $context;  // invoke uri context subapp|subdomain|domain

		public function __construct($tab){
			foreach($tab as $k=>$v){
				$this->$k = $v;
			}
		}
		public function getParams(){
			//get parameters
			$t = igk_pattern_get_matches($this->pattern, $this->uri, $this->keys);
			return $t;
		}
		public function matche($uri=null){
			$uri = $uri ?? $this->uri;
			if (preg_match($this->pattern, $uri )){
				$this->uri = $uri;
				return true;
			}
			return false;
		}
}
//-------------------------------------------------------------------------------
//<summary>REPRESENT THE EDITOR OF CSS PAGE</summary>
//-------------------------------------------------------------------------------


final class IGKCtrlInfo extends IGKObject
{
	private $m_addNew;
	private $m_typeCreated;
	private $m_name;
	private $m_type;
	private $m_childs;
	private $m_SupportMultiple;

	public function __construct($name, $type)
	{
		$this->m_childs = array();
		$this->m_name = $name;
		$this->m_type = $type;
		$this->m_addNew = true;
		$this->_initInfo();
	}
	public function getName(){return $this->m_name;}
	public function getType(){return $this->m_type;}

	public function getCanAddNew()
	{
		return $this->m_addNew;
	}
	public function getCreated(){
		return $this->m_typeCreated;
	}
	private function _initInfo()
	{
		//load childs
		foreach(get_declared_classes() as $k=>$v)
		{
			if ( igk_reflection_class_extends($v, $this->Type) && !igk_reflection_class_isabstract($v))
			{
				$this->m_childs[] = $v;
			}
		}
		if (method_exists($this->Type, "SupportMultiple"))
		{
			$this->m_SupportMultiple =  call_user_func_array(array($this->Type,"SupportMultiple"),array());
			$this->m_addNew = $this->m_SupportMultiple || (count($this->m_childs) <1);

		}
	}

}

final class IGKCustomControllerManager extends IGKNonVisibleControllerBase //used to get custom controller argument info
{
	public function getName(){return IGK_CUSTOM_CTRL_MAN_CTRL;}

	public function getInfo($name){
		//get list of type
		$m = IGKCtrlTypeManager::GetControllerTypes();
		array_keys(IGKCtrlTypeManager::GetControllerTypes());
		if (isset($m[$name]))
		{

			$type = $m[$name];
			$i = new IGKCtrlInfo($name, $type);
			return $i;
		}
		return null;
	}
}

final class IGKComponentManagerCtrl extends IGKNonVisibleControllerBase {
	public function getName(){return IGK_COMPONENT_MANAGER_CTRL;}

	private $m_objs;
	private $m_ids; //store ids and component
	private $m_uris; //stored generated uris
	private $m_srcs;//store object id source file to prevent __PHP_Incomplete_Class on invoke

	public function __construct(){
		parent::__construct();
		$this->m_objs = array();
		$this->m_ids = array();
		$this->m_uris = array();
		$this->m_srcs = array();
	}
	protected function InitComplete(){
		parent::InitComplete();

		igk_notification_reg_event(IGK_NODE_DISPOSED_EVENT, array($this, "nodeDisposed"));
	}

	public function getComponentById($id){
		return igk_getv($this->m_ids, $id);
	}
	public function Exists($obj){
		return igk_array_value_exist($this->m_objs, $obj);
	}
	//var $m_i;
	public function Register($obj, $componentInterface=true){		
		if (($obj == null) || $this->Exists($obj)  || ($componentInterface && !igk_reflection_class_implement($obj, "IIGKHtmlComponent") ))
			return false;
		$this->m_objs[] = $obj;
		$s = igk_new_id();
		$this->m_ids[$s] = $obj;
		$this->m_srcs[$s] = igk_reflection_getdeclared_filename($obj);

		$obj->setParam(IGK_COMPONENT_ID_PARAM, $s);
		return true;
	}
	public function nodeDisposed($node){
		$this->Unregister($node);
	}
	public function getComponentId($host){
		return $host->getParam(IGK_COMPONENT_ID_PARAM);
	}
	public function Unregister($obj){
		if (($obj == null)||(igk_count($this->m_objs)==0))
		{
			return;
		}
		$r = $this->getId($obj);
		if (empty($r))
			return;
		$t = array();
		$rf = 0; //

		//unregister all components
		foreach($this->m_objs as $k=>$v)
		{
			if ($obj === $v){
				$rf=1;
				continue;
			}
			$t[] = $v;
		}
		if ($rf==1){

				$clname = get_class($obj);
				if ($clname != 'IGKHtmlMemoryUsageInfoNodeItem'){
					$gr = igk_get_env("info:dispose", 1);
					//igk_log_write_i("UnregComponentReg", "unregister ".get_class($obj) . " == ".$r.":id ".$gr);
					$gr++;
					 igk_set_env("info:dispose",$gr);
				// igk_die("unregister : ".get_class($obj));

				}
				$this->m_objs = $t;
				unset($this->m_ids[$r]);
				unset($this->m_uris[$r]);
				$obj->unsetParam(__CLASS__.":id");
		}
		else{
			//igk_ilog("component not found .....".get_class($obj));
		}
		// if (get_class($obj)=="IGKHtmlAJXTabControlItem"){
			// igk_ilog("Remove XTab finish ".igk_count($this->m_objs) . " ".$obj["id"]);
		// }
	}
	///<summary>invoke</summary>
	public function inv(){
		// igk_wln(__FUNCTION__);
		$f = base64_decode(igk_getr("q"));
		if (empty($f))
			return;
		$tab = igk_getquery_args($f);
		// $bckR = $_REQUEST;
		// $_REQUEST = $tab;
		$k = $tab["id"];
		$obj = igk_getv($this->m_ids,$k);

		if ($obj)
		{
			if (get_class($obj) == "__PHP_Incomplete_Class"){
				igk_wln("try to used an incomplete class ");
				igk_exit();
			}

			$m =  igk_sys_meth_info(igk_getv(explode("&", $tab["f"]), 0));
			$g = $m->Name;

			if (method_exists(get_class($obj), $g))
			{
				if (igk_count($m->Args)==0)
				{
					$obj->$g();
				}
				else{
					call_user_func_array(array($obj, $g), $m->Args);
				}
			}
			else{
				call_user_func_array(array($obj, $g), $m->Args);
			}
			igk_exit();
		}
		else{
			//igk_log_write_i(__CLASS__."::".__FUNCTION__, " object not found in list");
			//igk_wln(array_keys($this->m_ids));
			//
			// foreach(array_keys($this->m_ids) as $k){
				// igk_wln($k . " ". get_class($this->m_ids[$k]));
			// }
			igk_header_no_cache();
			header("Status: 404 Error Component");
			igk_notification_push_event(IGK_COMP_NOT_FOUND_EVENT, $this, $k);

			if(igk_is_ajx_demand()){
				igk_wln("<div style=\"color:#FFDF72\" >/!\\ Component {{$k}} not found  </div>");
				// igk_wln(array_keys($this->m_ids));
			}else{
				$doc = igk_get_document($this, true);
				$doc->Title ="Component Error - ".igk_web_get_config('website_title');
				$dv = $doc->body->addBodyBox()->addDiv();
				$dv->addDiv()->setContent("<div>component object not found.[ $k ]</div><i>/!\\ session destroyed or compenent cleared</i>");
				$doc->RenderAJX();
				$doc->Dispose();
			}
			igk_exit();
		}
	}
	public function getUri($f=null, $obj=null)
	{
		if ($obj==null)
			return parent::getUri($f);
		$id = $this->getId($obj);
		$u = parent::getUri("inv&q=".base64_encode("f=".$f."&id=".$id));
		$this->m_uris[$id] = get_class($obj);
		return $u;
	}
	public function getId($obj)
	{
		if ($obj == null)
			return null;
		$r  = $obj->getParam(__CLASS__.":id");
		if ($r)
			return $r;
		foreach($this->m_ids as $k=>$v)
		{
			if ($v===$obj)
				return $k;
		}
		return null;
	}
	///<summary> get components registrated </summary>
	public function getComponents(){
		return $this->m_objs;
	}
	///<summary> Dispose all component</summary>
	public function DisposeAll(){
		foreach($this->m_objs as $k=>$v){
			$v->Dispose();
		}
		$this->m_objs = array();
		$this->m_ids = array();
	}
}

///<summary>represent a controllertype manager attribute</summary>
///<summary>used to set ctrl to attribute</summary>
class IGKControllerTypeAttribute extends IGKAttribute{
	public function __construct(){
	}
}
///<summary>represent a own view controller objet.</summary>
final class IGKOwnViewCtrl extends IGKObject
{
	private $m_ctrls;//
	static $sm_instance;
	private function __construct(){

	}
	public static function Contains($ctrl){
		$i = self::getInstance();

		if ($ctrl && isset($i->m_ctrls[$ctrl->Name]))
		{
			return true;
		}
		return false;
	}
	public static function RegViewCtrl($ctrl, $handleevent=1){
		$i = self::getInstance();
		if ($i->m_ctrls == null){
			$i->m_ctrls = array();
		}

		if (!isset($i->m_ctrls[$ctrl->Name])){
			$i->m_ctrls[$ctrl->Name] = $ctrl;
			if ($handleevent){
				igk_notification_reg_event(IGK_FORCEVIEW_EVENT, array($ctrl, "View"));
			}
		}
	}
	public static function getInstance(){
		if (self::$sm_instance == null)
		{
			self::$sm_instance =// igk_get_class_instance(__CLASS__, function(){
				//return
				new IGKOwnViewCtrl();
			//});
		}
		return self::$sm_instance;
	}
	public static function GetList(){
		$i = self::getInstance();
		return $i->m_ctrls;
	}
}


///<summary>Android Style manager controlleur</summary>
final class IGKAndroidStyleManager extends IGKControllerBase
{
	private $m_fromsession;
	protected function InitComplete(){
		parent::InitComplete();
		//$this->App->addNewDocumentCreatedEvent($this, "onNewDocCreated");
		IGKOwnViewCtrl::RegViewCtrl($this);
		$this->bindDocumentSetting($this->App->Doc);

		igk_notification_reg_event(IGK_EVENT_DOC_BEFORE_RENDER, "igk_android_ondoc_render");

	}
	protected function onNewDocCreated($igk, $doc){

		igk_exit();
		$this->bindDocumentSetting($doc);
	}
	public function bindDocumentSetting($document)
	{
		//
		//bind new document for setting definition obsolete because of the igk_android_ondoc_render
		//
	}

	public function getIsVisible(){
		return igk_agent_isAndroid();
	}
	public function View(){
		//$this->bindDocumentSetting($this->App->Doc);
	}
}
//<summary>system management class</summary>
final class IGKSysCtrl extends IGKNonVisibleControllerBase
{
	private $m_fontList;

	public function changeTheme($name){

		//TODO: CHANGE THEME ERROR
		$s = igk_sys_srv_referer();
		if (empty($s)){
			igk_navto(igk_io_baseUri());
		}

		igk_app()->Configs->globaltheme = $name;
		igk_save_config();
		igk_app()->bindCtrlStyle();

		$doc = igk_get_last_rendered_document();
		// init tempories file. or tempories css setting is reset before document rendered after????
		igk_css_render_balafon_style();
		igk_exit();
	}
	public function changeLang_ajx($lang=null){
		R::ChangeLang($lang);
		$u = igk_sys_srv_referer();
		if ($u){
			igk_io_invoke_uri($u, 0);
		}
		$doc = igk_get_last_rendered_document();
		$doc->body->RenderAJX();
		igk_exit();
	}
	public function getFontDir(){ //get font directory
		return igk_io_syspath(IGK_RES_FONTS);
	}
	public function __construct(){
		parent::__construct();
		$m_fontList = null;
	}
	protected function InitComplete(){
		parent::InitComplete();
		//register system control
		$this->App->getControllerManager()->register("sys", $this);
		igk_getconfigwebpagectrl()->addConfigUserChangedEvent($this,"init_sys_config");
	}
	public function init_sys_config(){
		if (igk_getconfigwebpagectrl()->getIsConnected())
		{
			$this->m_fontList = $this->_getFontList();
		}
		else
			$this->m_fontList = null;
	}
	public function getFontList(){//get font list
		return $this->m_fontList;
	}
	public function _getFontList(){
		//return;

		$count= 0;
		$uri = igk_io_baseUri()."/".igk_html_uri(igk_io_basePath(igk_sys_cgi_folder()."/fontlist.cgi"));
		// $source = igk_post_uri($uri);
		$source = igk_curl_post_uri($uri);
		$node = IGKHtmlReader::Load($source, null);
		if ($node){
			$tab =array();
			foreach($node->getElementsByTagName("item") as $k)
			{
				$tab[$k["name"]] = $k->getinnerHTML();
			}
			return (object)array("fonts"=>$tab, "count"=>count($tab));
		}
		else{
			igk_notifyctrl("sys://Config")->addWarning("<div style=\"color:#feaacc;\">Error : ".$source . " uri: ".$uri. " can't load cgi </div>") ;
		}
		return null;
	}
	public function viewFontList(){
		$r = $this->_getFontList();
		igk_wl($r);
	}

	public function installfont($name=null){
		$n = ($name==null)? base64_decode(igk_getr("n")) : $name;
		if ($this->m_fontList && isset($this->m_fontList->fonts[$n]))
		{
			$file = $this->m_fontList->fonts[$n];
			$target  = igk_io_currentRelativePath("R/Fonts/".basename($file));
			copy($file, $target);
			$this->App->Doc->Theme->addFont($n, igk_io_dir(igk_io_basePath($target)));
			igk_notifyctrl()->addMsgr("msg.fontinstalled");
			return true;
		}
		return false;
	}
	public function installfont_ajx(){
		if (igk_parsebool($this->installfont()))
		{
			$node = $this->getParam("sys:viewnode");
			$item = $this->getParam("sys:binding");
			$frm = $item["form"];
			$ctrl = $item["ctrl"];
			if ($ctrl){
				$ctrl->View();
				igk_js_ajx_view_ctrl($ctrl);
			}
			$this->_buildForm($frm);
			$frm->RenderAJX();
		}

	}
	public function viewInstallFontForm($node, $ctrl=null)
	{
		$frm = $node->addForm();
		$this->setParam("sys:binding", array("form"=>$frm,"ctrl"=>$ctrl));

		$this->_buildForm($frm);
	}
	private function _buildForm($frm)
	{

		$this->m_fontList = $this->_getFontList();

		// igk_wln("view----");
		// igk_wln($this->m_fontList );
		igk_notifyctrl()->setNotifyHost($frm->addDiv());

		$frm->addDiv()->Content = "Font list ";
		$frm->ClearChilds();
		$frm["action"] = $this->getUri("installfont_ajx");
		$div = $frm->addDiv();
		$div["style"] = "min-height: 300px;max-height: 400px; min-width: 400px; overflow-x:none; overflow-y:auto;";
		$i = 0;
		if ($this->m_fontList !=null) {
			foreach($this->m_fontList->fonts as $k=>$v)
			{
				$f = igk_io_dir($this->getFontDir()."/".basename($v));
					$uri = $this->getUri("installfont_ajx");
				$cdiv = $div->addDiv(
				array(
				"style"=>"font-family: '".$k."';",
				"class"=>"igk-list-item",
				"igk-js-click"=>IGK_STR_EMPTY,
				"id"=>"font_".$i,
				"igk-font-name"=>base64_encode($k),
				"onclick"=>"javascript:window.igk.system.fonts.installFont(this, '{$uri}'); return false;"));

				if (file_exists($f))
					$cdiv["style"] .="color:#9A9A9A;";
				else
					$cdiv["style"] .="color:#3A3A3A;";
				$cdiv->setContent($k);
				$i++;
			}
		}
		else{
			$div->addNotifyBox("danger")->Content = "/!\ No fonts definition found";
		}
	}
	public function getName(){return IGK_SYS_CTRL; }

	public function mod_rewrite(){
		if (igk_getv($_SERVER, 'IGK_REWRITE_MOD') || ( igk_getv($_SERVER, "REDIRECT_URL") && (igk_getr('rwc')>0))){
			igk_wl(1);
			igk_exit();
		}
		igk_wl(0);
		igk_exit();
	}

}
final class IGKLog extends IGKObject{
	private static $sm_instance;
	const LOGFILE = "Data/Logs/.sys.log";

	private function __construct(){
	}
	public static function getInstance(){
		if (!isset($_SESSION)){
			igk_die("/|\ must start session");			
		}
		if (self::$sm_instance == null){
			self::$sm_instance = igk_get_class_instance(__CLASS__,function(){
				return new IGKLog();
			});
		}
		return self::$sm_instance;


	}
	public function getLogFile(){
		$app = igk_app();
		$s = igk_io_baseDir(IGKLog::LOGFILE);
		if ($app && isset($app->Configs))
			return igk_getv($app->Configs, "LogFile", $s);
		else
			return $s;
	}
	public function write($msg){
		$this->write_i("IGKLOG", $msg);
	}
	public function write_i($tag, $message, $eval=1)
	{
		$f = $this->getLogFile();
		if (empty($f))
		{
			return;
		}
		if (is_array($message) && $eval){

			IGKOb::Start();
			igk_dump_array($message);
			$c = IGKOb::Content();
			IGKOb::Clear();
			$message = "Array[".$c."]";
		}
		$r = null;

		if (!file_exists($f) && ! IGKIO::CreateDir(dirname($f)))
			return ;


		$r = @fopen($f, file_exists($f)?"a+":"w+");
			if (is_array($message)){
				IGKOb::Start();//ob_start();
				var_dump($message);
				$message = IGKOb::Content();
				IGKOb::Clear();

			}
		if ($r){
			fwrite($r, date("h:i:s").": - [".$tag."] - ".$message."\n");
			fclose($r);
		}
	}
	// public function write_i_data($tag, $message, $eval=1)
	// {
		// $f = $this->getLogFile();
		// if (empty($f))
		// {
			// return;
		// }
		// $r = null;
		// $r = fopen($f, file_exists($f)?"a+":"w+");

		// if (is_array($message) && $eval){

			// IGKOb::Start();
			// $c = IGKOb::Content();
			// igk_wl($message);
			// IGKOb::Clear();
			// $message = $c;
		// }

		// if (is_string($message)		)
			// fwrite($r, date("h:i:s").": - [".$tag."] - ".$message."\n");
		// else{
			// $s = igk_wln_ob_get($message);
			// fwrite($r, date("h:i:s").": - [".$tag."] - ".$s."\n");
		// }
		// fclose($r);
	// }
	public function ClearLog(){
		$f = $this->getLogFile();
		$r = fopen($f,"w+");
		fclose($r);
	}
}
///<summary>log controller</summary>
final class IGKLogController extends IGKNonVisibleControllerBase
{
	public function getName(){return IGK_LOG_CTRL; }
	public function getCanInitDb(){return false; }

	public function write($msg){
		IGKLog::getInstance()->write_i("IGKLog", $msg);
	}
	public function write_i($tag, $message)
	{
		IGKLog::getInstance()->write_i($tag, $message,0);
	}
	public function write_i_data($tag, $message)
	{
		IGKLog::getInstance()->write_i($tag, $message,1);
	}
	public function ClearLog(){
		IGKLog::getInstance()->ClearLog();
	}
}
///<summary>who used API in the world</summary>
final class IGKWhoUseCtrl extends IGKNonVisibleControllerBase
{

	public function getDataAdapterName(){
		return IGK_MYSQL_DATAADAPTER;
	}
	public function getDataTableInfo(){
		///REMARK: igk_default own this data
		return null;
		// }
	}
	protected function InitComplete(){
		parent::InitComplete();

		if (!IGKServerInfo::IsLocal())
		{
			$srv = igk_getv($_SERVER, "SERVER_NAME");

			if (!IGKValidator::IsIpAddress($srv)){
				$domain = igk_get_domain_name($srv);
				$uri = "http://www.".$domain;
			//update uri to system
			// if(strtolower(IGK_ROOT_SERVER) != strtolower($uri))
			// {
				$d = IGK_ROOT_SERVER."/".$this->getUri("register_site&uri=".base64_encode($uri)."&ip=".igk_getv($_SERVER, "SERVER_ADDR"));
				$rep = igk_post_uri($d);
			// }
			}
		}
		// $_REQUEST["uri"] = base64_encode("http://www.igkdevd3.com");
		// igk_ilog("resiter site");
		// $d = IGK_ROOT_SERVER."/".$this->getUri("register_site&uri=".$_REQUEST["uri"]."&ip=".igk_getv($_SERVER, "SERVER_ADDR"));
		// $rep = igk_post_uri($d);
		// igk_ilog($rep);
		// session_destroy();
		// igk_exit();
	}
	public function register_site_test(){
		if (!IGKServerInfo::IsLocal()){
			$n = igk_createXmlNode("response");
			$n->add("message")->Content = "Can't execute this at non local server";
			igk_wl($n->RenderXML());
			igk_exit();
		}
		$_REQUEST["uri"] = base64_encode("http://www.igkdev.com");
		//register local
		$d = IGK_ROOT_SERVER."/".$this->getUri("register_site&uri=".$_REQUEST["uri"]."&ip=".igk_getv($_SERVER, "SERVER_ADDR"));
		$rep = igk_post_uri($d);
		igk_exit();
	}
	public function register_site(){
		$uri = base64_decode(igk_getr("uri"));
		$rep = igk_createNode("reponse");
		$v_r = 1;
		if ($uri == null){
			$rep->add("error")->Content = "uri is null";
			igk_wl($rep->RenderXML());
			$v_r =0;
		}
		if (!igk_server_request_from_balafon()){
			igk_wl(igk_render_xml_error(IGK_ERROR_REQUEST_NOT_FROM_BALAFON_SERVER, "Request not send from a [".IGK_PLATEFORM_NAME."] server")->RenderXML());
			$v_r =0;
		}
		if ($v_r){
			$tab = array("clWebSite"=>$uri);
			$r = igk_db_table_select_row(IGK_TB_WHO_USES, $tab, $this);
			// igk_wln("r is ");
			// igk_wln($r);
			// igk_wln("done");
			// igk_wln(($r === null));
			// igk_exit();
			if($r === null)
			{
				//	igk_exit();
				//inform author or new registration
				$tab["clIP"] = igk_getr("ip");
				$tab["clDateTime"] = igk_mysql_datetime_now();
				$h = igk_db_insert($this, IGK_TB_WHO_USES,$tab);
				$msg = igk_createNode("div");

				$tn = $msg->addDiv()->setStyle("display:table-row");
				$tn->addDiv()->setStyle("display:table-cell")->Content = "WebSite";
				$tn->addDiv()->setStyle("display:table-cell; width:100%;")->Content = $uri;
				$tn = $msg->addDiv()->setStyle("display:table-row");
				$tn->addDiv()->setStyle("display:table-cell")->Content = "IPAddress";
				$tn->addDiv()->setStyle("display:table-cell; width:100%;")->Content =$tab["clIP"] ;

				$tn = $msg->addDiv()->setStyle("display:table-row");
				$tn->addDiv()->setStyle("display:table-cell")->Content = "Date";
				$tn->addDiv()->setStyle("display:table-cell;width:100%;")->Content =$tab["clDateTime"] ;

				//$msg->addObData($tab);
				$dv = $msg->addDiv();
				$dv->addDiv()->Content = "Response : OK";
				$dv->addObData($h);
				igk_mail_sendmail(IGK_AUTHOR_CONTACT, "no-reply-balafon@igkdev.com", "A Web Site registrated to balafon - [ ".$uri." ] ",
				$msg->Render());
				$rp->add("status")->Content = 1;
				$rp->add("message")->setContent("Site added : ".$uri);
				$rp->RenderAJX();
			}
			else{
				$rep->add("error")->setContent("-1")
				->RenderAJX();
			}
		}
		@session_destroy();
		igk_exit();
	}
	public function get_registrated_list_xml(){
		$v = igk_db_get_entries($this, IGK_TB_WHO_USES);
		igk_wln(igk_db_view_result_node($v));
		igk_exit();
	}
	public function clear_registrated_list(){
		if (igk_server_is_local()){
			igk_db_clear_table($this, IGK_TB_WHO_USES);
		}
		else{
			$r = igk_createNode("response");
			$r->add("error")->Content = IGK_ERROR_OP_NOT_ALLOWED;
			$r->add("message")->Content = "Operation not allowed";
			igk_wl($r->RenderXML());
		}
		igk_exit();
	}
}


///<summary>used to post uri value each time value require to render. </summary>
final class IGKPostUriValue extends IGKObject
implements IIGKHtmlGetValue
{
	private $m_uri;

	public function __construct($uri){
		$this->m_uri = $uri;
	}
	public function getValue($options=null){//ctrl get value
		return "";//igk_curl_post_uri($this->m_uri);
	}
}



final class IGKPluginConfigMenuItem extends IGKMenuItem
{
	public function __construct($ctrl, $uri){
		parent::__construct(
			"plugins",
			"plugins",
			 $uri,
			500,
			"plugins",
			null,
			"files"
		);
		// $this->Node = igk_createNode("li");
		// $this->Node->addspan()->
		// setClass("badge floatr dispi alignc alignm")
		// ->Content = new IGKPostUriValue(igk_io_baseUri()."/".$ctrl->getUri("nop_i"));
		// ;
		// $this->Node->addA($uri)
		// ->setContent ("Plugins");

	}
}
///<summary>publings controller manager</summary>
final class IGKPluginCtrl extends IGKConfigCtrlBase
{
	private $m_pluginBody;
	public function getConfigPage(){ return "plugins"; }
	public function initConfigMenu(){
		return  array(new IGKPluginConfigMenuItem($this, $this->getUri("showConfig")));
	}
	///<summary>get installed plugin on server</summary>
	public function nop_i(){//
		if(strtolower(IGK_ROOT_SERVER) == strtolower(igk_io_baseUri()))
		{
			$tab = igk_db_table_select_where("tbigk_plugins");
			if ($tab){
				igk_wl($tab->RowCount);
			}
		}
		else
			igk_wl(IGK_HTML_CHAR_ZERO);
		igk_exit();
	}
	public function IsFunctionExposed($name){//expose all
		return true;
	}
	public function getPluginsList($type="html")
	{
		igk_exit();
		$r = igk_createNode("response");
		$r["responseType"] = $type;

		if(strtolower(IGK_ROOT_SERVER) == strtolower(igk_io_baseUri()))
		{
			$tab = igk_db_table_select_where("tbigk_plugins");
			$r["count"] = $tab->RowCount;
			$r->addDataEntry()->LoadData($tab);
		}
		else{
			$re = igk_post_uri(IGK_ROOT_SERVER."/".$this->getUri("getPluginsList/".$type));
			if (empty($re)){
				$r["status"] = "error";
				$r->add("message")->Content	= R::ngets("msg.cangetpluginslistform.server");
			}
			else{
				$r->Load($re);
			}
		}
		switch($type)
		{
			case "xml":
				$r->RenderXML();
				break;
			case "xmlview":
				$d = new IGKHtmlXmlViewerItem();
				$d->Load($r->Render(null));
				$d->RenderXML();
				break;
			default:
				$r->RenderAJX();
				break;
		}
		igk_exit();
	}


	public function getPlugins($name){
		$p = igk_db_table_select_row("tbigk_plugins", array(IGK_FD_NAME=>$name));
		if ($p){
			$f = igk_io_currentRelativePath(IGK_PLUGINS_FOLDER."/".$p->clName.IGK_PLUGIN_ZP_FILE_EXTENSIONS);
			if (file_exists($f))
			{
				igk_wl(IGKIO::ReadAllText($f));
			}
		}
		igk_exit();

	}
	public function getInstalledPlugins($options=null){
		$r = igk_createNode("response");
		$tab = igk_io_getfiles(igk_io_currentRelativePath(IGK_PLUGINS_FOLDER) , "/\\.pbal/i") ;
		$r["version"] = "1.0";
		$r["number"]  = igk_count($tab);
		$r->addComment()->Content = "installed plugins list";
		foreach($tab as $k=>$v)
		{
			$b = igk_getv(IGKHtmlReader::LoadFile($v)->Childs, 0);
			if ($b !=null){
			$r->add("plugin")
			->setAttribute("file", igk_io_basePath($v))
			->setAttribute("name", igk_io_basenamewithoutext($v))
			->setAttribute("version", $b["version"])
			->setAttribute("author", $b["author"])
			->setAttribute("description", $b["description"]);
			;
			}
			else{
			$r->add("error")->Content = "/.!\\ not define";
			}
		}
		switch($options)
		{
			case "xml":
			$d = new IGKHtmlXmlViewerItem();
			$d->Load($r->Render(null));
			$d->RenderXML();
			break;
			default:
			$r->RenderXML();
			break;
		}
		//igk_wln("done");
		igk_exit();
	}
	///create a new pluginc
	public function createPlugins($name,   $files, $author = IGK_AUTHOR_CONTACT)
	{
		$f = igk_io_currentRelativePath(IGK_PLUGINS_FOLDER)."/$name".IGK_PLUGIN_ZP_FILE_EXTENSIONS;
		if (file_exists($f) || (count($files) == 0))
		{
			return false;
		}
		$df = igk_createNode("plugin");
		$df["version"] = "1.0";
		$df["author"] = $author;
		$df["name"] = $name;
		$df["file"] = igk_io_basePath(IGK_PLUGINS_FOLDER)."/".basename($f);
		$zip = new ZipArchive();
		$zip->open($f, ZIPARCHIVE::CREATE);
		$dfi = $df->add("files");
		foreach($files as $k=>$v){
			$zip->addFile($v);
			$dfi->add("file")->Content = $v;
		}
		$zip->addFromString($name.IGK_PLUGIN_FILE_EXTENSIONS, $df->Render(null));
		$zip->close();
		return true;
	}
	public function installPlugins($name)
	{
		$f = igk_io_baseDir(IGK_PLUGINS_FOLDER)."/$name".IGK_PLUGIN_ZP_FILE_EXTENSIONS;
		if (!file_exists($f))
		{
			return false;
		}
		$hzip = zip_open($f);
		$outdir =  igk_io_baseDir();
		$def =  $name.IGK_PLUGIN_FILE_EXTENSIONS;
		$defnode = null;
		if (is_resource($hzip))
		{

			while( ($e = zip_read($hzip)))
			{
				$n = zip_entry_name($e);
				if ($n == $def)
				{
					//load environment
					$defnode = IGKHtmlReader::Load(zip_entry_read($e,zip_entry_filesize($e)),null);

				}
				else{
					//extract zip
					if (igk_zip_entry_isdir($e))
					{
						igk_zip_create_dir($outdir, $n);
					}
					else{
						if (!(strpos($n, "/")===FALSE))
						{
							igk_zip_extract($outdir, $hzip , $e);
						}
						else{
							if(IGKIO::CreateDir($outdir))
							{
								igk_zip_extract($outdir, $hzip , $e);
							}
						}
					}
				}
			}
			zip_close($hzip);
			igk_notifyctrl()->addMsgr("msg.pluginsinstalled");
			igk_io_save_file_as_utf8_wbom(igk_io_currentRelativePath(IGK_PLUGINS_FOLDER)."/$name".IGK_PLUGIN_FILE_EXTENSIONS, $defnode->Render());
		}
		return true;
	}

	public function uninstallPlugins($name){
		$fs= igk_io_currentRelativePath(IGK_PLUGINS_FOLDER)."/$name".IGK_PLUGIN_FILE_EXTENSIONS;
		if (file_exists($fs) == false)
			return false;
		$defnode = IGKHtmlReader::LoadFile($fs);

		foreach($defnode->getElementsByTagName("file") as $k)
		{
			$f = igk_io_currentRelativePath(trim($k->innerHTML));

			if (file_exists($f))
			{
				unlink($f);
				$dir = dirname($f);
				while(IGKIO::RmDir($dir, false)){
					//dictory was empty remove hierarchi
					$dir = dirname($dir);
					if (igk_io_basePath($dir) == "")
						break;
				}
			}
		}
		unlink($fs);
		return true;
	}

	public function View(){
		$this->TargetNode->ClearChilds();

		$t = $this->TargetNode->addRow();

		igk_html_add_title($t->addDiv(),"title.PluginsManager");
		$t->addHSep();
		$d = $t->addDiv();
		$menu = $d->addHMenu();
		$menu->addItem("Installed", $this->getUri("plugins&t=installed"), R::ngets("menu.plugins.installed"));
		$menu->addItem("Plugins", $this->getUri("plugins&t=search"), R::ngets("menu.plugins.get"));
		$this->m_pluginBody = $d->addDiv();
		$this->plugins();
	}
	public function plugins($page="installed"){
		$m = __FUNCTION__."_".$page;
		$pages = array(
			"plugins_installed"=>"getInstalledPlugins"
		);
		$this->m_pluginBody->ClearChilds();
		$u = $this->getUri(igk_getv($pages, $m, "getInstalledPlugins"));
		$this->m_pluginBody->addDiv()->Content = "Uri:".$u;
		$this->m_pluginBody->addDiv()->addAJXUriLoader($u);
		// if (method_exists(__CLASS__, $m))
		// {
			// $tab =  array_slice(func_get_args(), 1);
			// call_user_func_array(array(__CLASS__,$m), $tab);
		// }
	//}
	// public function plugins_installed(){
		// $this->m_pluginBody->ClearChilds();
		// $this->m_pluginBody->addDiv()->addAJXUriLoader($this->getUri("getInstalledPlugins&t=xml"));

	// }
	// public function plugins_search(){
		// $this->m_pluginBody->ClearChilds();
		// $this->m_pluginBody->addDiv()->addAJXView()->setUri($this->getUri("getPluginsList&t=xml"));//->setScript("alert(this);");
	// }

}



}


///<summary>uses to sort value contains in tab by attribute keys</summary>
final class IGKSorter
{
	var $key;
	var $asc;
	public function __construct(){
		$this->asc = true;
	}
	public function Sort(& $tab, $key=null)
	{
		if (is_array($tab))
		{
			usort($tab, array($this, "SortValue"));
		}
		else {
			if (method_exists(get_class($tab), "SortValueBy"))
			{
				$tab->SortValueBy($this->key);
			}
		}
		if ($key){
			$b = array();
			foreach($tab as $k=>$v)
			{
				$b[igk_getv($v,$key)] = $v;
			}
			$tab = $b;
		}
	}
	public static function SortByDisplay($tab, $key, $asc=true){

		return self::__SortValue($tab, $key, $asc, "SortKeyValue");

	}
	public static function SortByValue($tab, $key, $asc=true){

		return self::__SortValue($tab, $key, $asc, "SortValue");

	}
	private static function __SortValue( & $tab, $key, $asc=true, $funcname){
			$t = new IGKSorter();
		$t->key = $key;
		$t->asc = $asc;

		if (is_array($tab))
		{
			usort($tab, array($t, $funcname));
		}
		else {
			if (method_exists(get_class($tab), "SortValueBy"))
			{
				$tab->SortValueBy($key, $asc , array($t, $funcname) );
			}
		}
		return $tab;
	}
	public function SortValue($a, $b){
		$tk = $this->key;
		if(is_string($tk))
			$tk = array($tk=>$this->asc);
		$i = 0;
		foreach($tk as $k=>$asc){
			$s1 = $s2 = null;
			if (is_object($a) && is_object($b))
			{
				$s1 = strtolower($a->$k);
				$s2 = strtolower($b->$k);
			}
			else{
				$s1 = strtolower(igk_getv($a,$k));
				$s2 = strtolower(igk_getv($b,$k));
			}

			// intcmp
			if (is_integer($s1) && is_integer($s2)){
				$i = strnatcmp($s1, $s2);
			}else
				$i = strcmp($s1, $s2);
			if (($i!=0) && (!$asc))
			{
				$i *= -1;
			}
			if ($i===0)continue;
		}
		return $i;
	}
	public function SortKeyValue($a, $b){
		$k = $this->key;
		$s1 = strtolower(R::gets($a->$k));
		$s2 = strtolower(R::gets($b->$k));
		$i = strcmp($s1, $s2);
		return $i;
	}
}

///<summary>cookie warning requirement</summary>
final class IGKCookieWarningController extends IGKControllerBase{

	public function getRegisterToViewMecanism(){return true;}
	public function getIsVisible(){

		if (igk_get_env(IGK_ENV_NO_COOKIE_KEY)==1){
		//	exit;
			return 0;
		}
		$d = igk_get_cookie("_igk_CONSENT");
		return 0; //$d == 'no';
	}
	public function View(){
		igk_html_add($this->TargetNode, $this->App->Body);
	}
	protected function initTargetNode(){
		//::TODO::Cookie warning
		$t = igk_createNode("div");
		$t->setClass("igk-cookie-warning");
		$t->addAJXUriLoader($this->getUri('warndoc'));
		return $t;
	}
	protected function InitComplete(){
		parent::InitComplete();
		//igk_reg_session_event(IGK_ENV_NEW_DOC_CREATED, array(__class__, "warnOnNewDocCreated"));
		//default set cookies
		igk_set_cookie("_igk_CONSENT","no", 0);

	}
	///<summary>represent a warning document</summary>
	public function warnDoc(){
		$n = igk_createNode("div");
		$n->Content = "This site require your acknowledge to use cookies";
		$n->RenderAJX();
		igk_exit();
	}
	///<summary>represent
	// public static function warnOnNewDocCreated($o,$e){
		// igk_wln("new doc created");
		
		// // $n = igk_html_node_CloneNode($this->TargetNode);
		// // $n->setCallBack("getIsVisible", array($this, "getIsVisible"));
		// // // add a cloned node to new created document if visible
		// // igk_html_add($n, $e->body);
	// }
	protected function onHandleSystemEvent($msg, $args){
		if ($msg == IGK_ENV_NEW_DOC_CREATED){
			$n = igk_html_node_CloneNode($this->TargetNode);
			$n->setCallBack("getIsVisible", array($this, "getIsVisible"));
			// add a cloned node to new created document if visible
			igk_html_add($n, $e->body);
		}
	}
}

//---------------------------------------------------------------
//HTML ITEMS
//---------------------------------------------------------------

//--------------------------------------------------------------------------------
//abstract definition
//--------------------------------------------------------------------------------
abstract class IGKHtmlWebMasterNodeBase extends IGKHtmlItem{
	public function getIsVisible(){
		 return igk_app()->IsSupportViewMode(IGKViewMode::WEBMASTER);
	}
	public function __construct($tagname){
		parent::__construct($tagname);
	}
}
abstract class IGKHtmlCtrlNodeItemBase extends IGKHtmlItem
{
	private $m_ctrl;

	public function setCtrl($v){
		$this->m_ctrl = $v;
		return $this;
	}
	public function getCtrl(){ return igk_getctrl($this->m_ctrl);}

	public function __construct($tag){
		parent::__construct($tag);
	}
}
///<summary>component node item base</summary>
abstract class IGKHtmlCtrlComponentNodeItemBase extends IGKHtmlCtrlNodeItemBase
	implements IIGKHtmlComponent
{
	private $m_controller;
	public function getComponentId(){
		return $this->getParam(get_class($this->m_controller).":id");
	}
	public function getComponentUri($uri){
		return $this->m_controller->getUri($uri, $this);
	}
	public function getController(){
		return $this->m_controller;
	}
	public function __construct($tag){
		$this->m_controller = igk_getctrl(IGK_COMPONENT_MANAGER_CTRL, true);
		parent::__construct($tag);
		$this->m_controller->Register($this);
	}
	public function free(){
		// igk_ilog("unregister ".$this->getTagName());
		//if ($this->ParentNode === null){
			$this->m_controller->Unregister($this);
		//}
	}
	public function Dispose(){
		//igk_ilog("destruct component node");
		$this->free();
	}
	// public function __destruct(){
		// parent::__destruct();
	// }
	protected function setParentNode($n, $context=null){
		if (($n===null) && ($context && (strtolower($context) == 'clearchilds'))){
			$this->free();
		}
		parent::setParentNode($n,$context);
	}
}


igk_reg_event("sys://event/onbeforeexit", "igk_session_block_exit_callback");


function igk_session_block_exit_callback(){
	$t = null; 	
	if (($c = igk_getctrl(IGK_SESSION_CTRL )) && ($t = $c->TargetNode))
		$t->onAppExit();
}


//templates functions

function igk_template_register($name){
	
}
function igk_template_unregister($name){
	
}

function igk_template_header($t=null){
	$c = igk_get_env( "sys://ctrl/view/controller");
	$t = $t ?? $c->TargetNode;
	
	
}
function igk_template_footer(){
	$c = igk_get_env( "sys://ctrl/view/controller");
	$t = $t ?? $c->TargetNode;
}
///<summary>activate the current template</summary>
function igk_template_activate($name){
	
}
///<summary>get the current active template</summary>
function igk_template_active(){
	
}
///<summary>get list of templates</summary>
function igk_template_list(){
	
}

final class IGKHtmlSessionBlockNode extends IGKHtmlCtrlNodeItemBase
{
	private $m_owner;
	public function __construct($tag, $ctrl){
		parent::__construct($tag);
		$this->m_owner = $ctrl;
		
		// igk_reg_event("sys://event/onbeforeexit", array($this, 'onAppExit')); 
	}
	public function onAppExit(){
		if (igk_is_ajx_demand() && $this->IsVisible && 	igk_app()->Session->getRedirectTask('modview')){
			$this->RenderAJX();
			igk_app()->Session->{"modeview"} = null;
		}
	}
	protected function __AcceptRender($o=null){
		if (igk_xml_is_options_mail($o) || igk_xml_is_caching_require($o))
			return false;
		$this->ClearChilds();
		$v = $this->__buildview();
		$t = $this;


		$t->addNodeCallback("mem_usage",function($t){
			return $t->addMemoryUsageInfoNode();
		});
		$t->addScript()->Content  = "ns_igk.readyinvoke('igk.ctrl.sessionblock.init');";
		//if (window.igk && window.igk.ctrl.sessionblock)window.igk.ctrl.sessionblock.init();//
		return $this->getIsVisible();
	}
	private function __buildview(){
			$t = $this;
			$t["class"]="debugzone igk-session-block";
			$t->setIndex(10000);

			$d = $t->add("div");
			$d->Content = R::ngets("title.DEBUGINFO");
			$d["class"]= "debug_option_title igk-title-4 igk-default";
			$ul = $t->add("ul");
			//register a color name


			$ul->addLi()->Content = "Referrer : " . igk_getv($_SERVER, "REMOTE_ADDR");

			$ul = $t->add("ul");
			if (!igk_get_env("sys://error")){

			$ul["class"]="btn-group";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>$t->m_owner->getUri("forceview")))
			->Content = "ForceView";
			$a = $ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->addAClearSAndReload()->clearClass()->setContent("ClearSession");
			}
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>$t->m_owner->getConfigCtrl()->getUri('logout')))->Content = "Logout";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>new IGKHtmlRelativeUriValueAttribute("Configs")))->Content = "Configs";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->addAJXA($t->m_owner->getConfigCtrl()->getUri('preview_result_ajx'))->Content = "PreviewResult";
			$ul->addLi()->setClass("btn btn-default igk-btn igk-btn-default")->add("a", array("href"=>new IGKHtmlRelativeUriValueAttribute()))->Content = "Index";


			//environmane setting
			$ul = $t->add("ul")->setId("cnf-inf");
			$ul->addLi()->Content = "CurrentPage : " . igk_app()->CurrentPage;
			$ul->addLi()->Content = "CurrentFolder : " . igk_app()->CurrentPageFolder;
			$ul->addLi()->Content = "ViewMode : " . IGKViewMode::GetSystemViewMode();
			$ul->addLi()->Content = "Environment : " . array("development", "production")[igk_sys_env_production()];//IGKViewMode::GetSystemViewMode();
			$ul->addLi()->Content = new IGKSessionIdValue();
			$bootstrap = igk_sys_getconfig("BootStrap.Enabled");
			$tab = igk_sys_debug_components();
			if($tab){
				foreach($tab as $k=>$v){
					$v($this, $this->m_owner);
				}
			}

			if (!igk_is_conf_connected() && ($this->CurrentPageFolder != IGK_CONFIG_PAGEFOLDER)){

				$logindiv = $t->add("div");
				$logindiv->setCallback("getIsVisible", igk_create_expression_callback("return igk_app()->CurrentPageFolder !== IGK_CONFIG_PAGEFOLDER;", null));
				$frm = $logindiv->addForm();
				$frm["action"] = //igk_io_baseUri("", false)."".
				igk_getconfigwebpagectrl()->getUri("connectToConfig");
				$v_logul = $frm->add("ul");
				$li = $v_logul ->addLi();
				$li->addLabel("clAdmLogin");
				$input = $li->addInput("clAdmLogin");
				$input["autocomplete"]="off";
				$input["placeholder"] = R::ngets("tip.login");
				$input->setClass("igk-form-control");

				$i = $v_logul->addLi()->addSLabelInput("clAdmPwd","password");
				$i->input["placeholder"] = R::ngets("tip.password")->getValue();
				$i->input["autocomplete"] = "current-password";
				$i->input->setClass("igk-form-control");

				$i = $v_logul->addLi()->addInput("btn.connect", "submit",R::ngets("btn.connect"));
				if ($bootstrap){
					$i->setClass("btn btn-default igk-btn igk-btn-default");
				}
			}
			else{
				$div = $t->addDiv()->setClass("igk-form-group");

				if (igk_is_conf_connected())
				{
					$sl = $div->addSelect("clViewMode")->setClass("igk-form-control");
					$uri = $t->m_owner->getUri("changeviewmode");
					$sl["onchange"] = "javascript: ns_igk.ajx.get('{$uri}&mode='+this.value,null, ns_igk.ajx.fn.replace_body); return false;";
					$mode = igk_app()->getViewMode();
					foreach(igk_get_class_constants("IGKViewMode") as $k=>$v)
					{
						$opt = $sl->add("option")->setContent($k)->
						setAttribute("value", $v);
						if ($v == $mode){
							$opt["selected"] = true;
						}
					}
				}
				$t->addDiv()->setClass("igk-cleartab");
			}
	}
}

///<summary>symbolic file manager</summary>
final class IGKSymbolManagerCtrl extends IGKNonVisibleControllerBase{
	const URI = "/Default/R/Symbols/symbols.dat";
	public function __construct(){
		parent::__construct();
	}
	protected function InitComplete(){
		parent::InitComplete();
		
		$callback = array($this, "newDocCreated");
		
		// igk_reg_session_event(IGK_ENV_NEW_DOC_CREATED, $callback);
		$this->__bindSymbol($this->App->Doc);
		// igk_unreg_session_event(IGK_ENV_NEW_DOC_CREATED, $callback;
		
	}
	public function onHandleSessionEvent($msg){
		
	}
	private function newDocCreated($o,$a){
		if ($a!=null){
			$this->__bindSymbol($a);
		}
	}
	public function getScriptValue($options=null){
	$k = dirname(__FILE__).self::URI;
	//"/Default/R/Symbols/symbols.gkds");
	if ($options && ($options->Context == IGK_WEB_CONTEXT ) && $options->Cache){ //web caching condition
		$uri = igk_html_uri("./".igk_io_basePath($k));
	}
	else
		$uri = igk_io_baseUri($k);
	return <<<EOF
ns_igk.readyinvoke('igk.gkds.symbolManager.load', '{$uri}','default');
EOF;
//if(window.igk && window.igk.gkds)window.igk.gkds.symbolManager.load('$uri', 'default');

	}
	private function __bindSymbol($doc){
		$doc->Body->appendScriptNode("script:".__CLASS__)->Content = new IGKValueListener($this, "getScriptValue");
	}
}


///<summary> represent a component listener class
abstract class IGKComponentListenerBase extends IGKObject
implements IIGKParamHostService//IGKStoreParameterObject
{

	private $m_params;

	public function getParam($key, $default=null){
		return igk_getv($this->m_params, $key, $default);
	}
	public function setParam($key, $value){
		$this->m_params[$key] = $value;
	}
	public function unsetParam($key){
		unset($this->m_params[$key]);
	}
	public function resetParam(){
		$this->m_params=array();
	}
	public function getParamKeys(){
		return array_keys($this->m_params);
	}

	public function __construct(){
		$this->m_params = array();
	}

	final function getUri($n){
		return igk_get_component_uri($this, $n);
	}
}

///<summary> use to initialize a controller environment</summary>
final class IGKCtrlInitListener implements IIGKControllerInitListener{
// IGKIO::CreateDir($folder);
// IGKIO::CreateDir($folder."/".IGK_VIEW_FOLDER); //view folder
// IGKIO::CreateDir($folder."/".IGK_ARTICLES_FOLDER);//article folder
// IGKIO::CreateDir($folder."/".IGK_DATA_FOLDER);//data folder
// igk_io_save_file_as_utf8($folder."/".IGK_DATA_FOLDER."/.htaccess", $grantaccess);
// IGKIO::CreateDir($folder."/".IGK_SCRIPT_FOLDER);//script folder
// igk_io_save_file_as_utf8($folder."/".IGK_SCRIPT_FOLDER."/.htaccess", $grantaccess);
// IGKIO::CreateDir($folder."/".IGK_STYLE_FOLDER);//styles folder
// igk_io_save_file_as_utf8($folder."/".IGK_STYLE_FOLDER."/.htaccess", $grantaccess);
// igk_io_save_file_as_utf8($folder."/".IGK_STYLE_FOLDER."/default.pcss", igk_get_default_style());

	private $m_folder; //out folder
	private $m_type; //init listener type
	public function __construct($folder, $type=null){
		$this->m_folder = $folder;
		$this->m_type = $type;

		if (!IGKIO::CreateDir($folder)){
			igk_die("can't created dir : ".$folder);
		}
	}
	public function addDir($dir){
		IGKIO::CreateDir($this->m_folder."/{$dir}");
	}
	public function addSource($name, $content){
		 igk_io_save_file_as_utf8($this->m_folder."/".$name, $content);
	}
}

///<summary>obj that used the controller folder management</summary>
final class  IGKCtrlZone extends IGKObject
			 implements IIGKCtrlDirManagement
{
	private $m_filename;
	public function __construct($fname){
		$this->m_filename = $fname;
	}
	public function getDataDir(){
		return igk_io_dir($this->getDeclaredDir().DIRECTORY_SEPARATOR.IGK_DATA_FOLDER);
	}
	public function getViewDir(){
		return igk_io_dir($this->getDeclaredDir().DIRECTORY_SEPARATOR.IGK_VIEW_FOLDER);
	}
	public function getStyleDir(){
		return igk_io_dir($this->getDeclaredDir().DIRECTORY_SEPARATOR.IGK_STYLE_FOLDER);
	}
	public function getDeclaredDir(){
		return dirname($this->m_filename);
	}
	public function getScriptDir(){
		return igk_io_dir($this->getDeclaredDir().DIRECTORY_SEPARATOR.IGK_SCRIPT_FOLDER);
	}
	public function getName(){
		return strtolower(__CLASS__."://".$this->m_filename);
	}
}


final class IGKArrayAccess implements ArrayAccess{
	private $_host;
	var $offsetGetListener;
	var $offsetSetListener;
	var $offsetExistsListener;
	var $offsetUnsetListener;
	public function __call($v,$args){
		$c = $this->$v;
		if ($c){
			return call_user_func_array($c, $args);
		}
		igk_die($v." not implement");
	}
	public function __construct($o){
		$this->_host   = $o;
	}
	public function offsetGet($i){
		$fc = $this->offsetGetListener;
		$o =null;
		$fc &&( $o = $fc($this->_host, $i));
		return $o;
	}
	public function offsetSet($i, $v){
		$this->offsetSetListener && $this->offsetSetListener($this->_host, $i, $v);
	}
	public function offsetExists($i){
		$o = false;
		$this->offsetExistsListener && ($o = $this->offsetExistsListener($this->_host, $i));
		return $o;
	}
	public function offsetUnset($i){
		$this->offsetUnsetListener && $this->offsetUnsetListener($this->_host, $i);
	}
}


spl_autoload_register(function($n){	
	if ($n=='IGKAppModule'){		
		include(IGK_LIB_DIR."/igk_app_module.php");
	}
});


//-------------------------------------------------------------------------------------
//INIT Lib
//-------------------------------------------------------------------------------------
//register system global controller
igk_sys_reg_controller(IGK_COMPONENT_MANAGER_CTRL, IGKComponentManagerCtrl::class);//global component manager
igk_sys_reg_controller(IGK_NOTIFICATION_CTRL, IGKNotificationCtrl::class);         //notification ctrl
igk_sys_reg_controller(IGK_CSVLANGUAGE_CTRL, IGKCSVLanguageManagerCtrl::class);    //language manager


//-------------------------------------------------------------------------------------
//register namespace
//-------------------------------------------------------------------------------------
igk_reg_ns("igk", "http://www.igkdev.com");
igk_reg_ns("gkds", "http://www.igkdev.com/gkds/");

//reg instance



//-------------------------------------------------------------------------------------
//extras inclusion files
//-------------------------------------------------------------------------------------

require_once(IGK_LIB_DIR."/igk_wsdl.php");
require_once(IGK_LIB_DIR.'/igk_html_func_items.php');
require_once(IGK_LIB_DIR.'/igk_html_items.php');
require_once(IGK_LIB_DIR.'/igk_html_utils.php');
// //required system files
require_once(IGK_LIB_DIR."/igk_app_ctrl.php");
// //api lib
include_once(IGK_LIB_DIR."/api/igk_api.php");
include_once(IGK_LIB_DIR."/.setting.global.pinc");

// igk_wln("init ...2");
// igk_exit();

//include SysMods
// if (!igk_get_env_lib_loaded()){
	//load system mod extension	
igk_reg_event('sys://event/cachelibreload', function($o,$e){
	$file = igk_loadcontroller(IGK_LIB_DIR."/SysMods");
	// include extensions
	if (!defined('IGK_NO_LIB_EXTENSION'))
		include(IGK_LIB_DIR."/igk_extensions.phtml");

	$e->files = array_merge($e->files, $file);
});

// }

// igk_wln("init ...43 ".IGK_LIB_DIR);
// igk_exit();

igk_sys_reg_uri("^/R/Scripts/balafon.js[%q%]", function(){
	$c = igk_app()->Doc->ScriptManager->getMergedContent();
	header("Content-Type: text/javascript");
	igk_header_cache_output(3600*24);
	$const="constant";
	$header = "//author: C.A.D BONDJE DOUE\n";
	$header .= "//libname:balafon.js\n";
	$header .= "//version:{$const('IGK_BALAFON_JS_VERSION')}\n";
	$header .= "//copyright: igkdev @ 2013 - ".date('Y')."\n";
	$header .= "//license: //igkdev.com/balafon/balafonjs/license\n";
	// igk_zip_output($header.$c->data);

	$s = $c->data;

	igk_zip_output($header.igk_js_minify($s));
	// igk_zip_output($header.$s);
	unset($s);
	unset($c);
	igk_exit();
});
?>